<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc3 {
	color: #008080;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc3">/***[ThuNderSoft]*************************************************************
                              KUANG2: IsFileInfect
                                   ver: 0.10
                                ˙˘ƒÕ WEIRD Õƒ˘˙
*****************************************************************************/</span><span class="sc0">

</span><span class="sc1">/* HISTORY */</span><span class="sc0">
</span><span class="sc2">// ver 0.10 (12-may-1999): born code
</span><span class="sc0">
</span><span class="sc9">#include &lt;windows.h&gt;
#include &lt;strmem.h&gt;
</span><span class="sc0">
</span><span class="sc2">// minimalna veliÅina fajla  ( &lt; veliÅine dodatog virusa)
</span><span class="sc9">#define     MIN_FILE_LEN    9000
</span><span class="sc2">// koliko od kraja fajla treba poÅeti skeniranje ( &gt; veliÅine dodatog virusa)
</span><span class="sc9">#define     FROM_END        12500
</span><span class="sc0">
</span><span class="sc1">/*
    IsFileInfect
    ------------
  ˛ proverava da li je neki fajl veÜ inficiran.
  ˛ mora posebno jer vrÑi samo Åitanje.
  ˛ vraÜa -1 za tehniÅke probleme, 0 za Åist fajl, 1 za inficiran
  ˛ indetiÅno u virusu i antivirusu
  ˛ brz i inteligentan. */</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">IsFileInfect</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">char</span><span class="sc10">*</span><span class="sc0"> </span><span class="sc11">virus_sign</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">HANDLE</span><span class="sc0"> </span><span class="sc11">hfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">hfilemap</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filemap</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">filestart</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">fattr</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">fsize</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">retvalue</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">koliko</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">retvalue</span><span class="sc10">=-</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">                        </span><span class="sc2">// oznaÅi tehniÅku greÑku (default)
</span><span class="sc0">
    </span><span class="sc11">fattr</span><span class="sc10">=</span><span class="sc11">GetFileAttributes</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">);</span><span class="sc0">     </span><span class="sc2">// uzmi atribute fajla
</span><span class="sc0">
    </span><span class="sc2">// otvaramo fajl
</span><span class="sc0">    </span><span class="sc11">hfile</span><span class="sc10">=</span><span class="sc11">CreateFile</span><span class="sc10">(</span><span class="sc11">fname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">GENERIC_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_SHARE_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">OPEN_EXISTING</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fattr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">==</span><span class="sc11">INVALID_HANDLE_VALUE</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end1</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// uzmi veliÅinu fajla
</span><span class="sc0">    </span><span class="sc11">fsize</span><span class="sc10">=</span><span class="sc11">GetFileSize</span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fsize</span><span class="sc10">==</span><span class="sc4">0xFFFFFFFF</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end2</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// greÑka
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fsize</span><span class="sc10">&lt;</span><span class="sc11">MIN_FILE_LEN</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">           </span><span class="sc2">// ako je veliÅina fajla manja
</span><span class="sc0">        </span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc2">// od veliÅine dodatog virusa
</span><span class="sc0">        </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end2</span><span class="sc10">;</span><span class="sc0">                      </span><span class="sc2">// znaÅi da je fajl Åist (0)
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc2">// kreiramo MMF
</span><span class="sc0">    </span><span class="sc11">hfilemap</span><span class="sc10">=</span><span class="sc11">CreateFileMapping</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PAGE_READONLY</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hfilemap</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end2</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// kreiramo MMF view na ceo fajl
</span><span class="sc0">    </span><span class="sc11">filemap</span><span class="sc10">=(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc0"> </span><span class="sc11">MapViewOfFile</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">hfilemap</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FILE_MAP_READ</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">filemap</span><span class="sc10">==</span><span class="sc5">NULL</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">goto</span><span class="sc0"> </span><span class="sc11">end3</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">filestart</span><span class="sc10">=</span><span class="sc11">filemap</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// odredi poÅetak skeniranja...
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">fsize</span><span class="sc10">&gt;</span><span class="sc11">FROM_END</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">               </span><span class="sc2">// ako je fajl veÜi od FROM_END
</span><span class="sc0">        </span><span class="sc11">filemap</span><span class="sc10">+=(</span><span class="sc11">fsize</span><span class="sc10">-</span><span class="sc11">FROM_END</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc2">// pomeri se tako da ima FROM_END do kraja
</span><span class="sc0">        </span><span class="sc11">koliko</span><span class="sc10">=</span><span class="sc11">FROM_END</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc2">// oznaÅi koliko ima za skeniranje
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">koliko</span><span class="sc10">=</span><span class="sc11">fsize</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc2">// oznaÅi da se ceo fajl skenira
</span><span class="sc0">
    </span><span class="sc2">// proveri da li je veÜ zaraÇen (Åak 50 znakova!)
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">memfind</span><span class="sc10">(</span><span class="sc11">filemap</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">koliko</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">virus_sign</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">50</span><span class="sc10">)!=-</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc2">// zaraÇen fajl
</span><span class="sc0">        </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc11">retvalue</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// Åist fajl
</span><span class="sc0">
    </span><span class="sc11">UnmapViewOfFile</span><span class="sc10">(</span><span class="sc11">filestart</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// zatvari MMF view
</span><span class="sc11">end3</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hfilemap</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc2">// zatvori MMF
</span><span class="sc11">end2</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc11">CloseHandle</span><span class="sc10">(</span><span class="sc11">hfile</span><span class="sc10">);</span><span class="sc0">         </span><span class="sc2">// zatvori fajl
</span><span class="sc11">end1</span><span class="sc10">:</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">retvalue</span><span class="sc10">;</span><span class="sc0">            </span><span class="sc2">// vrati rezultat
</span><span class="sc10">}</span><span class="sc0">

</span></div></body>
</html>
